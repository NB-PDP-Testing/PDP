{
  "project": "Coach-Parent AI Summaries - Phase 3 (Sensitive Topics)",
  "branchName": "ralph/coach-parent-summaries-p3",
  "description": "Special workflows for injury and behavior-related insights. Depends on Phase 1 and Phase 2.",
  "dependencies": {
    "phase1Branch": "ralph/coach-parent-summaries-phase1",
    "phase2Branch": "ralph/coach-parent-summaries-p2",
    "requiredFiles": [
      "packages/backend/convex/models/coachParentSummaries.ts",
      "packages/backend/convex/models/coachTrustLevels.ts",
      "packages/backend/convex/schema.ts (coachParentSummaries, coachTrustLevels tables)",
      "apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/parents-tab.tsx"
    ],
    "existingComponents": [
      "apps/web/src/components/coach/trust-level-icon.tsx",
      "apps/web/src/components/coach/trust-level-indicator.tsx",
      "apps/web/src/components/coach/trust-preference-settings.tsx",
      "apps/web/src/components/coach/trust-nudge-banner.tsx"
    ]
  },
  "criticalLearnings": {
    "biomeImports": "Biome auto-removes unused imports instantly. When creating new components, add import AND usage in the same Write operation. Using Write tool to create complete file avoids linter removing imports mid-edit.",
    "authUserId": "Better Auth userId is user.userId (string), not user._id. Always check !user?.userId before using.",
    "convexPatterns": "NEVER use .filter() - always use .withIndex(). All functions need args AND returns validators (never v.any()).",
    "typeConversion": "Query returns undefined but components expect null - use ?? null at component boundary.",
    "helperFunctions": "For internal mutations called from same file, use helper functions instead of ctx.runMutation(internal.models.X.Y) to avoid circular references.",
    "toastImport": "Toast from sonner: import { toast } from 'sonner'; toast.success('msg'); toast.error('msg');",
    "qualityOrder": "Run: npx -w packages/backend convex codegen → npx biome check --write --unsafe → npm run check-types"
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Add injuryApprovalChecklist table",
      "description": "As a developer, I need to track coach checklist responses for injury summaries.",
      "acceptanceCriteria": [
        "Add injuryApprovalChecklist table to schema.ts",
        "Fields: summaryId (v.id('coachParentSummaries')), coachId (v.string()), personallyObserved (v.boolean()), severityAccurate (v.boolean()), noMedicalAdvice (v.boolean())",
        "Add timestamps: completedAt (v.number())",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Audit trail for injury due diligence. Add after coachTrustLevels table in schema.ts. Use v.string() for coachId (Better Auth userId)."
    },
    {
      "id": "US-002",
      "title": "Add index to injuryApprovalChecklist",
      "description": "As a developer, I need efficient checklist lookups.",
      "acceptanceCriteria": [
        "Add index: by_summary for looking up checklist by summaryId",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Index naming convention: include all fields in name. NOTE: Index was added in US-001 implementation."
    },
    {
      "id": "US-003",
      "title": "Update classifyInsightSensitivity with examples",
      "description": "As the system, I need better classification accuracy.",
      "acceptanceCriteria": [
        "Edit classifyInsightSensitivity action in coachParentSummaries.ts",
        "Add few-shot examples to prompt: injury examples (limping, dizzy, collision), behavior examples (argument, not listening, attitude), normal examples (skill work, good performance)",
        "Return { category, confidence, reason }",
        "VALIDATE AI response structure before type casting - check category is valid enum value",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Don't trust AI JSON blindly - validate before casting. Examples improve classification accuracy."
    },
    {
      "id": "US-004",
      "title": "Store classification reason in summary",
      "description": "As a coach, I want to know why a summary was classified as sensitive.",
      "acceptanceCriteria": [
        "Ensure sensitivityReason field is populated when creating summary",
        "Store classification confidence score in sensitivityConfidence field",
        "Check if fields exist in schema, add if missing",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "May need to add fields to coachParentSummaries schema if not present."
    },
    {
      "id": "US-005",
      "title": "Implement approveInjurySummary mutation",
      "description": "As a coach, I need to complete a checklist to approve injury summaries.",
      "acceptanceCriteria": [
        "Add approveInjurySummary mutation to coachParentSummaries.ts",
        "Args: summaryId (v.id('coachParentSummaries')), checklist (v.object({ personallyObserved: v.boolean(), severityAccurate: v.boolean(), noMedicalAdvice: v.boolean() }))",
        "Validate all three booleans are true before approving",
        "Use authComponent.safeGetAuthUser(ctx) for auth, use user.userId for coachId",
        "Add proper returns validator",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Mutation pattern: validate auth, validate ownership, validate checklist, then approve. Include descriptive error messages."
    },
    {
      "id": "US-006",
      "title": "Store checklist responses in approveInjurySummary",
      "description": "As the system, I need to audit checklist completions.",
      "acceptanceCriteria": [
        "Insert injuryApprovalChecklist record with all fields after validation",
        "Update summary status to approved using ctx.db.patch()",
        "Set approvedAt (Date.now()) and approvedBy (user.userId)",
        "Call trust metrics update: ctx.runMutation(internal.models.coachTrustLevels.updateTrustMetrics, {...})",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Same pattern as approveSummary but with checklist record. Import internal from '../_generated/api'. NOTE: Implemented together with US-005."
    },
    {
      "id": "US-007",
      "title": "Block auto-approval for injury category",
      "description": "As the system, injury summaries must never auto-approve.",
      "acceptanceCriteria": [
        "In processVoiceNoteInsight action (or relevant processing function), check sensitivityCategory",
        "If injury: always set status to 'pending_review' regardless of trust level",
        "Add console.log: 'Auto-approval blocked: injury sensitivity requires manual review'",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Safety feature - injury content is too sensitive for automation. This connects to future Phase 5 auto-approval logic."
    },
    {
      "id": "US-008",
      "title": "Block auto-approval for behavior category",
      "description": "As the system, behavior summaries must never auto-approve.",
      "acceptanceCriteria": [
        "In same location as US-007, check for behavior category",
        "If behavior: always set status to 'pending_review' regardless of trust level",
        "Add console.log: 'Auto-approval blocked: behavior sensitivity requires manual review'",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Same pattern as injury but for behavior. Both are sensitive categories."
    },
    {
      "id": "US-009",
      "title": "Create SensitivityBadge component",
      "description": "As a coach, I want visual indication of sensitivity category.",
      "acceptanceCriteria": [
        "Create apps/web/src/components/coach/sensitivity-badge.tsx",
        "Add 'use client' directive at top",
        "Props: { category: 'normal' | 'injury' | 'behavior' }",
        "Injury: amber/yellow warning style with AlertTriangle icon",
        "Behavior: blue info style with Shield icon",
        "Normal: return null (no badge needed)",
        "Use Badge component from shadcn/ui, lucide-react icons",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Follow existing badge patterns in trust-level-indicator.tsx. Import Badge from '@/components/ui/badge'."
    },
    {
      "id": "US-010",
      "title": "Create InjuryApprovalCard component",
      "description": "As a coach, I need a special card for injury summaries.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/injury-approval-card.tsx",
        "Add 'use client' directive at top",
        "Props: { summary: SummaryType, onApprove: () => void, onSuppress: () => void }",
        "Show prominent warning banner: '⚠️ INJURY-RELATED INSIGHT'",
        "Use Card component from shadcn/ui with amber/warning border",
        "Display summary content and player info",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Reference existing SummaryApprovalCard for structure. Use amber colors for injury warning."
    },
    {
      "id": "US-011",
      "title": "Add checklist to InjuryApprovalCard",
      "description": "As a coach, I must complete checklist before approving injury.",
      "acceptanceCriteria": [
        "Add 3 Checkbox components from shadcn/ui: 'I personally observed this injury', 'The severity description is accurate', 'This contains no medical advice'",
        "Use useState for each checkbox: const [observed, setObserved] = useState(false)",
        "Disable Approve button until all 3 are checked: disabled={!observed || !accurate || !noAdvice}",
        "Suppress button remains always enabled",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Import Checkbox from '@/components/ui/checkbox'. Local state only - server validates on submit."
    },
    {
      "id": "US-012",
      "title": "Wire InjuryApprovalCard to mutation",
      "description": "As a coach, approving injury card should call the special mutation.",
      "acceptanceCriteria": [
        "Add useMutation for api.models.coachParentSummaries.approveInjurySummary",
        "On approve click, call mutation with summaryId and checklist values",
        "Import toast from 'sonner', show toast.success('Injury summary approved') or toast.error('Failed...')",
        "Call onApprove callback on success",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Use try-catch for error handling. Remember: add import AND usage together to avoid Biome removing it."
    },
    {
      "id": "US-013",
      "title": "Create BehaviorApprovalCard component",
      "description": "As a coach, I need a distinct card for behavior summaries.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/behavior-approval-card.tsx",
        "Add 'use client' directive at top",
        "Props: { summary: SummaryType, onApprove: () => void, onSuppress: () => void }",
        "Show info banner with Lock icon: 'Behavioral observations require manual review'",
        "Use Card component with blue info styling",
        "No checklist required - just standard approve/suppress buttons",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Simpler than injury card - no checklist, just visual distinction and manual review requirement."
    },
    {
      "id": "US-014",
      "title": "Wire BehaviorApprovalCard to standard approve",
      "description": "As a coach, behavior cards use standard approval flow.",
      "acceptanceCriteria": [
        "Use existing api.models.coachParentSummaries.approveSummary mutation",
        "Show constructive framing of summary content",
        "Import toast from 'sonner', show success/error messages",
        "Call onApprove/onSuppress callbacks appropriately",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Reuses existing mutation - behavior just needs manual review, not special checklist."
    },
    {
      "id": "US-015",
      "title": "Route to correct card in ParentsTab",
      "description": "As a coach, I see the appropriate card based on sensitivity.",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/parents-tab.tsx",
        "Import InjuryApprovalCard, BehaviorApprovalCard, and existing SummaryApprovalCard",
        "When rendering pending summaries, check summary.sensitivityCategory",
        "if (category === 'injury') render InjuryApprovalCard",
        "if (category === 'behavior') render BehaviorApprovalCard",
        "else render standard SummaryApprovalCard",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Conditional rendering based on sensitivityCategory field. May need to update SummaryApprovalCard to handle normal explicitly."
    },
    {
      "id": "US-016",
      "title": "Add SensitivityBadge to all approval cards",
      "description": "As a coach, all cards show their sensitivity category.",
      "acceptanceCriteria": [
        "Import SensitivityBadge into InjuryApprovalCard, BehaviorApprovalCard, and SummaryApprovalCard",
        "Render <SensitivityBadge category={summary.sensitivityCategory} /> in each card header",
        "Position badge near player name or title",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Consistent visual language across all card types. Normal returns null so no visual clutter."
    },
    {
      "id": "US-017",
      "title": "Process injury insights in pipeline",
      "description": "As the system, injury insights should now go through the pipeline.",
      "acceptanceCriteria": [
        "Find where insights are processed (likely in voiceNotes.ts or coachParentSummaries.ts)",
        "Remove any skip/filter logic that excludes injury category",
        "Ensure injury insights create summaries with sensitivityCategory: 'injury'",
        "Verify classifyInsightSensitivity is called for injury insights",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": "May have been skipped in Phase 1 to defer complexity. Now we enable it with proper handling."
    },
    {
      "id": "US-018",
      "title": "Process behavior insights in pipeline",
      "description": "As the system, behavior insights should now go through the pipeline.",
      "acceptanceCriteria": [
        "Same location as US-017",
        "Remove any skip/filter logic that excludes behavior category",
        "Ensure behavior insights create summaries with sensitivityCategory: 'behavior'",
        "Verify classifyInsightSensitivity is called for behavior insights",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": "Same pattern as injury. Both sensitive categories now fully supported."
    }
  ]
}

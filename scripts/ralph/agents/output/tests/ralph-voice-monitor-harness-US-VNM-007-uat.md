# UAT Test: US-VNM-007 - Build Pipeline Alerts Backend

> Auto-generated: 2026-02-16 22:58
> Status: ⏳ Pending Execution

## Story
Create voicePipelineAlerts.ts with automated health check cron and alert queries. READ FULL DETAILS in phases/PHASE_M4.json.

## Acceptance Criteria Checklist

- [ ] Create packages/backend/convex/models/voicePipelineAlerts.ts
- [ ] Implement checkPipelineHealth internalMutation (cron-called every 5 min)
- [ ] - Query real-time metrics from voicePipelineCounters
- [ ] - Query most recent hourly snapshot from voicePipelineMetricsSnapshots
- [ ] - Perform 6 health checks:
- [ ] 1. Failure Rate: failures / (completed + failures) > 0.10 → PIPELINE_HIGH_FAILURE_RATE (severity: high)
- [ ] 2. Latency Spike: current latency > 2x 7-day avg → PIPELINE_HIGH_LATENCY (severity: medium)
- [ ] 3. Queue Depth: active artifacts > 50 → PIPELINE_HIGH_QUEUE_DEPTH (severity: medium)
- [ ] 4. Disambiguation Backlog: needs_disambiguation > 100 → PIPELINE_DISAMBIGUATION_BACKLOG (severity: low)
- [ ] 5. Circuit Breaker: state='open' or 'half_open' → PIPELINE_CIRCUIT_BREAKER_OPEN (severity: critical)
- [ ] 6. Pipeline Inactivity: no artifacts received in 60+ min → PIPELINE_INACTIVITY (severity: low)
- [ ] - Deduplicate alerts: before inserting, check if same alertType exists with acknowledged=false. Only create if no recent unacknowledged alert.
- [ ] - Insert alerts into platformCostAlerts table (or new voicePipelineAlerts table)
- [ ] - Return { alertsCreated: count, checksPerformed: ['failure_rate', 'latency', ...] }
- [ ] Implement getActiveAlerts query (platform staff only)
- [ ] - Query platformCostAlerts with acknowledged=false AND alertType starts with 'PIPELINE_'
- [ ] - Order by severity (critical > high > medium > low), then createdAt desc
- [ ] - Return array of alerts
- [ ] Implement acknowledgeAlert mutation (platform staff only)
- [ ] - Update alert: acknowledged=true, acknowledgedAt=Date.now(), acknowledgedBy=user._id
- [ ] - Return { success: true }
- [ ] Implement getAlertHistory query (platform staff only)
- [ ] - Query platformCostAlerts with alertType starts with 'PIPELINE_'
- [ ] - Apply optional filters (severity, alertType, date range)
- [ ] - Order by createdAt desc
- [ ] - Use .paginate(paginationOpts)
- [ ] - Return paginated result
- [ ] Add cron job to crons.ts:
- [ ] - Name: 'check-pipeline-health'
- [ ] - Schedule: Every 5 minutes (crons.interval('check-pipeline-health', { minutes: 5 }, ...))
- [ ] - Action: Call internal.models.voicePipelineAlerts.checkPipelineHealth
- [ ] CRITICAL: Safe division - check denominator > 0 before calculating failure rate
- [ ] CRITICAL: Alert deduplication - don't spam duplicate alerts for same unacknowledged issue
- [ ] CRITICAL: Latency baseline - query last 168 hourly snapshots (7 days) for historical average
- [ ] CRITICAL: Platform staff auth on all query/mutation functions
- [ ] Run: npx -w packages/backend convex codegen && npm run check-types

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VNM-007"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

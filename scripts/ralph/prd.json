{
  "project": "Voice Gateways v2 - Phase 4: Claims Extraction",
  "branchName": "feat/voice-gateways-v2",
  "description": "Segment voice note transcripts into atomic claims (one per entity mention, 15 topic categories) using GPT-4 structured output. Hook into the v2 pipeline after transcription, running in parallel with v1 buildInsights. Add a platform-staff debug page to view extracted claims. Zero regression to v1 pipeline.",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE3_V2_MIGRATION.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE4_CLAIMS_EXTRACTION.md"
  ],
  "relatedIssue": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "previousPhases": [
    "Phase 1 - Quality Gates & Fuzzy Matching (COMPLETE: US-VN-001 to US-VN-006, 349 tests)",
    "Phase 2 - Coach Quick Review Microsite (COMPLETE: US-VN-007 to US-VN-012, full mobile microsite at /r/[code])",
    "Phase 2.5 - Review Microsite Polish (COMPLETE: US-VN-012a analytics, 012b swipe, 012c snooze, 012d PWA)",
    "Phase 3 - v2 Artifacts Foundation (COMPLETE: US-VN-013 tables + US-VN-014 feature flags & dual-path)"
  ],
  "currentPhase": "Phase 4 - Claims Extraction (2 stories, 3 days)",
  "completedStories": [
    "US-VN-001",
    "US-VN-002",
    "US-VN-003",
    "US-VN-004",
    "US-VN-005",
    "US-VN-006",
    "US-VN-007",
    "US-VN-008",
    "US-VN-009",
    "US-VN-010",
    "US-VN-011",
    "US-VN-012",
    "US-VN-012a",
    "US-VN-012b",
    "US-VN-012c",
    "US-VN-012d",
    "US-VN-013",
    "US-VN-014",
    "US-VN-015"
  ],
  "executionStrategy": {
    "parallelStreams": false,
    "sequential": {
      "name": "Claims Extraction Pipeline",
      "order": ["US-VN-015", "US-VN-016"],
      "notes": "Sequential: US-VN-015 creates schema + model + helper + extraction action. US-VN-016 hooks it into the pipeline and adds the debug viewer page. US-VN-015 must be fully complete (codegen + type check passing) before US-VN-016."
    }
  },
  "designPrinciples": [
    "Claims run ALONGSIDE v1 buildInsights, NOT replacing it — both are scheduled in parallel after transcription",
    "v1 insights still power the review microsite, auto-apply, and parent summaries — claims are the v2 data structure for Phase 5-6",
    "Separate action file (claimsExtraction.ts) — voiceNotes.ts is already 1300+ lines",
    "Shared coachContext helper (coachContext.ts) — avoids duplicating roster/teams gathering logic",
    "Denormalized org/coach on claims — avoids join back to artifact for queries",
    "Entity mentions preserved raw in entityMentions[] — resolved* fields capture best-effort match",
    "Non-v2 coaches completely unaffected (no artifact = no claims extraction)"
  ],
  "criticalReminders": [
    "NEVER use .filter() — always use .withIndex()",
    "Better Auth IDs as v.string() not v.id() — user._id not user.id",
    "Batch fetch + Map lookup (avoid N+1 queries in loops)",
    "Use internalMutation/internalQuery for server-to-server calls — NEVER call public mutations from internalActions",
    "NEVER use v.any() — always use typed validators",
    "Biome block statements: always use { } (not one-line if/return)",
    "Biome top-level regex: define regex as module-scope constants",
    "Biome auto-removes imports: add import AND its usage in same edit",
    "Biome useMaxParams: max 4 params — use options objects for 5+",
    "Biome cognitive complexity: max 15 — extract sub-components/helpers",
    "Use shadcn/ui components + Tailwind CSS + Lucide Icons",
    "Run quality checks in order: npm run check-types → npx ultracite fix → npx biome check <files>",
    "'use node' directive REQUIRED at top of action files that use OpenAI SDK",
    "PlayerIdentityIds ARE v.id('playerIdentities') — these are Convex doc IDs (not Better Auth)",
    "actions/claimsExtraction.ts is a NEW file — does NOT go inside voiceNotes.ts",
    "The getAIConfig pattern from voiceNotes.ts lines 29-70 should be reused (feature: 'voice_insights')",
    "The coachContext helper is an internalQuery (not a plain function) since it's called from an action via ctx.runQuery"
  ],
  "mandatoryPatterns": [
    "All Convex functions MUST have args and returns validators",
    "Use composite indexes for multi-field queries",
    "internalMutation/internalQuery for server-to-server calls",
    "Public queries only for client-facing operations",
    "Better Auth IDs as v.string() not v.id()",
    "Use Id<'tableName'> for Convex document references",
    "Wrap action handlers in try/catch with proper error status updates"
  ],
  "phase3IntegrationNotes": [
    "voiceNoteArtifacts model: packages/backend/convex/models/voiceNoteArtifacts.ts (5 functions: createArtifact, linkToVoiceNote, updateArtifactStatus, getArtifactByArtifactId, getArtifactsByVoiceNote)",
    "voiceNoteTranscripts model: packages/backend/convex/models/voiceNoteTranscripts.ts (2 functions: createTranscript, getTranscriptByArtifact)",
    "Feature flags: packages/backend/convex/lib/featureFlags.ts (shouldUseV2Pipeline, getFeatureFlag, setFeatureFlag)",
    "Dual-path processing: packages/backend/convex/actions/whatsapp.ts processAudioMessage/processTextMessage",
    "v2 transcript storage: packages/backend/convex/actions/voiceNotes.ts lines 228-257 (after transcription completes)",
    "v1 buildInsights: packages/backend/convex/actions/voiceNotes.ts lines 304-970 (the target to run in parallel with)",
    "Coach context gathering to port: packages/backend/convex/actions/voiceNotes.ts lines 340-471",
    "v1 GPT-4 prompt to port matching rules from: packages/backend/convex/actions/voiceNotes.ts lines 486-604",
    "Player matching: packages/backend/convex/lib/playerMatching.ts (shared fuzzy matching logic)",
    "String matching: packages/backend/convex/lib/stringMatching.ts (Levenshtein distance)",
    "AI model config: packages/backend/convex/models/aiModelConfig.ts (feature/scope/org cascade pattern)",
    "Platform admin page pattern: apps/web/src/app/platform/ai-config/page.tsx"
  ],
  "userStories": [
    {
      "id": "US-VN-015",
      "phase": 4,
      "title": "Claims Table & Extraction Action",
      "description": "Add the voiceNoteClaims table with 15 topic categories, create 6 model CRUD functions, extract shared coach context gathering into a reusable internalQuery, and implement the GPT-4 claims extraction internalAction with Zod structured output parsing.",
      "acceptanceCriteria": [
        "SCHEMA: Add voiceNoteClaims table to packages/backend/convex/schema.ts",
        "  Location: After voiceNoteTranscripts (line ~4220), before platformStaffInvitations (line ~4222)",
        "  Fields: claimId (string), artifactId (id voiceNoteArtifacts), sourceText (string), timestampStart (optional number), timestampEnd (optional number), topic (union of 15 literals: injury, skill_rating, skill_progress, behavior, performance, attendance, wellbeing, recovery, development_milestone, physical_development, parent_communication, tactical, team_culture, todo, session_plan), title (string), description (string), recommendedAction (optional string), timeReference (optional string), entityMentions (array of {mentionType: union of player_name/team_name/group_reference/coach_name, rawText: string, position: number}), resolvedPlayerIdentityId (optional id playerIdentities), resolvedPlayerName (optional string), resolvedTeamId (optional string), resolvedTeamName (optional string), resolvedAssigneeUserId (optional string), resolvedAssigneeName (optional string), severity (optional union low/medium/high/critical), sentiment (optional union positive/neutral/negative/concerned), skillName (optional string), skillRating (optional number), extractionConfidence (number), organizationId (string), coachUserId (string), status (union extracted/resolving/resolved/needs_disambiguation/merged/discarded/failed), createdAt (number), updatedAt (number)",
        "  Indexes (7): by_artifactId, by_artifactId_and_status, by_claimId, by_topic, by_org_and_coach, by_org_and_status, by_resolvedPlayerIdentityId",
        "  Run: npx -w packages/backend convex codegen",
        "",
        "MODEL: Create packages/backend/convex/models/voiceNoteClaims.ts with 6 functions:",
        "  1. storeClaims (internalMutation) — batch insert, returns array of IDs",
        "  2. getClaimsByArtifact (internalQuery) — by_artifactId index",
        "  3. getClaimsByArtifactAndStatus (internalQuery) — by_artifactId_and_status composite index",
        "  4. updateClaimStatus (internalMutation) — by_claimId lookup, patch status + updatedAt",
        "  5. getClaimByClaimId (internalQuery) — by_claimId index, first()",
        "  6. getClaimsByOrgAndCoach (PUBLIC query) — by_org_and_coach index, limit default 50 max 200",
        "  Define shared validators at module scope (topicValidator, statusValidator, etc.)",
        "",
        "HELPER: Create packages/backend/convex/lib/coachContext.ts",
        "  gatherCoachContext (internalQuery) — returns { players, teams, coaches, recordingCoachName, rosterJson, teamsJson, coachesJson }",
        "  Port logic from voiceNotes.ts buildInsights lines 340-471",
        "  Must be internalQuery (called from action via ctx.runQuery)",
        "",
        "ACTION: Create packages/backend/convex/actions/claimsExtraction.ts",
        "  'use node' directive at top",
        "  extractClaims (internalAction) — args: { artifactId: v.id('voiceNoteArtifacts') }, returns: v.null()",
        "  Zod schema: claimsExtractionSchema with summary + claims[] covering all 15 topics",
        "  GPT-4 prompt: all 15 categories with atomicity rules, player/team/coach matching instructions",
        "  Player matching: deterministic first (AI's playerId), fuzzy fallback via findSimilarPlayers (threshold >= 0.85)",
        "  Error handling: try/catch, set artifact status to 'failed' on error",
        "  AI model: reuse getAIConfig pattern (feature: 'voice_insights')",
        "",
        "MODIFY: packages/backend/convex/models/voiceNoteArtifacts.ts",
        "  Add getArtifactById (internalQuery) — takes { _id: v.id('voiceNoteArtifacts') }, returns artifact doc or null",
        "  Simpler than existing getArtifactByArtifactId (which takes string artifactId)",
        "",
        "VERIFICATION:",
        "  npx -w packages/backend convex codegen passes",
        "  npm run check-types passes (0 errors)"
      ],
      "priority": 15,
      "effort": "2 days",
      "dependencies": ["US-VN-014"],
      "passes": true
    },
    {
      "id": "US-VN-016",
      "phase": 4,
      "title": "Pipeline Integration & Claims Viewer",
      "description": "Hook claims extraction into the v2 pipeline after transcription (parallel with v1 buildInsights). Add platform-staff debug page to view extracted claims. Zero regression to v1 pipeline.",
      "acceptanceCriteria": [
        "PIPELINE HOOK: Modify packages/backend/convex/actions/voiceNotes.ts",
        "  Location: Inside 'if (artifacts.length > 0)' block (line ~233), AFTER transcript creation + artifact status set to 'transcribed' (line ~257), BEFORE quality check branching (line ~260)",
        "  Add: await ctx.scheduler.runAfter(0, internal.actions.claimsExtraction.extractClaims, { artifactId: artifact._id })",
        "  This runs in parallel with v1 buildInsights (scheduled at line 280-286, UNCHANGED)",
        "  Non-v2 coaches unaffected (no artifact = no scheduler call)",
        "",
        "QUERY: Add getRecentArtifacts (PUBLIC query) to packages/backend/convex/models/voiceNoteArtifacts.ts",
        "  args: { limit: v.optional(v.number()) }",
        "  Logic: query voiceNoteArtifacts, order desc, take min(limit || 50, 200)",
        "  Used by the claims viewer frontend",
        "",
        "OPTIONAL QUERY: Add getRecentClaims (PUBLIC query) to packages/backend/convex/models/voiceNoteClaims.ts",
        "  args: { limit: v.optional(v.number()) }",
        "  Logic: query voiceNoteClaims, order desc, take min(limit || 100, 500)",
        "  Used by the claims viewer if getClaimsByOrgAndCoach doesn't fit the platform debug use case",
        "",
        "CLAIMS VIEWER: Create apps/web/src/app/platform/v2-claims/page.tsx",
        "  Follow apps/web/src/app/platform/ai-config/page.tsx pattern",
        "  'use client' component, useCurrentUser() for auth",
        "  useQuery for artifacts and claims",
        "  Layout: header with back link, stats cards, artifact list with expandable claims",
        "  Each claim: topic badge (color-coded), sourceText, title, entity mentions, confidence, status",
        "  Uses shadcn/ui: Card, Badge, Table, Skeleton",
        "  No org theming (platform admin tool)",
        "",
        "VERIFICATION:",
        "  npm run check-types passes",
        "  npm run build succeeds",
        "  Manual: v2 coach voice note creates BOTH v1 insights AND v2 claims",
        "  Manual: non-v2 coach voice note creates ONLY v1 insights (no claims)",
        "  Manual: /platform/v2-claims page loads with claims displayed"
      ],
      "priority": 16,
      "effort": "1 day",
      "dependencies": ["US-VN-015"],
      "passes": false
    }
  ],
  "successCriteria": [
    "voiceNoteClaims table in schema with ALL 15 topic literals and 7 indexes",
    "Convex codegen passes cleanly",
    "voiceNoteClaims.ts has 6 functions (5 internal + 1 public)",
    "coachContext.ts has gatherCoachContext internalQuery",
    "claimsExtraction.ts has extractClaims internalAction with GPT-4 prompt",
    "Player matching uses existing lib/playerMatching.ts",
    "AI model configurable via aiModelConfig table",
    "Scheduler call in voiceNotes.ts after 'transcribed' status",
    "v1 buildInsights still runs in parallel (unchanged)",
    "Non-v2 coaches completely unaffected",
    "Claims viewer page at /platform/v2-claims",
    "npm run check-types passes (0 errors)",
    "npm run build succeeds"
  ]
}

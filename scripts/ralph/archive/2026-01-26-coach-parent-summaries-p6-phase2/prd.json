{
  "project": "P7 Phase 3 - Learning Loop with Automatic Triggering",
  "branchName": "ralph/coach-insights-auto-apply-p7-phase3",
  "description": "Complete Phase 7 with automatic triggering, category preferences, adaptive thresholds, and analytics. First implements missing automatic trigger from Phase 7.2, then adds learning loop features.",
  "readinessLevel": "100%",
  "prerequisitesCompleted": {
    "status": "✅ ALL COMPLETE",
    "completedWork": [
      "Phase 7.1: Preview mode COMPLETE (5 stories)",
      "  - US-001: insightPreviewModeStats schema fields COMPLETE",
      "  - US-002: wouldAutoApply calculation COMPLETE",
      "  - US-003: Confidence visualization COMPLETE",
      "  - US-004: Preview mode badge COMPLETE",
      "  - US-005: Preview tracking COMPLETE",
      "Phase 7.2: Supervised auto-apply COMPLETE (4 stories)",
      "  - US-006: autoAppliedInsights table COMPLETE",
      "  - US-007: autoApplyInsight mutation COMPLETE",
      "  - US-008: undoAutoAppliedInsight mutation COMPLETE",
      "  - US-009: Auto-Applied tab UI COMPLETE",
      "  - ⚠️ GAP: Automatic triggering NOT implemented (will be US-009.5)",
      "Phase 7 Infrastructure:",
      "  - voiceNoteInsights table with 40+ insights",
      "  - autoAppliedInsights audit trail table",
      "  - coachTrustLevels with insightAutoApplyPreferences field",
      "  - AI confidence scoring operational (0.0-1.0 scale)",
      "  - Trust level system at Level 2+"
    ]
  },
  "contextAndDependencies": {
    "completedPhases": [
      "P1-P4: Voice notes and parent summaries infrastructure",
      "P5: Trust system for parent summaries (preview → supervised → learning)",
      "P6: Monitoring, cost controls, graceful degradation",
      "P7 Phase 1: Preview mode for insight auto-apply",
      "P7 Phase 2: Supervised auto-apply (mutations + UI)"
    ],
    "requiredTables": [
      "voiceNoteInsights - With confidenceScore, status, category fields",
      "autoAppliedInsights - Audit trail with undoneAt, undoReason",
      "coachTrustLevels - With insightAutoApplyPreferences, insightConfidenceThreshold",
      "skillAssessments - Target for skill insights",
      "sportPassports - Required to find passportId for skill updates"
    ],
    "existingMutations": [
      "autoApplyInsight - Applies insight to player profile (US-007)",
      "undoAutoAppliedInsight - Undoes within 1-hour window (US-008)",
      "updateInsightStatus - Updates insight status (embedded array, Phase 7.1)"
    ],
    "existingQueries": [
      "getPendingInsights - Returns insights with wouldAutoApply (US-002)",
      "getAutoAppliedInsights - Returns auto-applied insights (US-009)",
      "getCoachTrustLevelWithInsightFields - Returns trust level with insight fields"
    ],
    "keyFiles": [
      "Schema: packages/backend/convex/schema.ts",
      "Backend insights: packages/backend/convex/models/voiceNoteInsights.ts",
      "Backend trust: packages/backend/convex/models/coachTrustLevels.ts",
      "AI action: packages/backend/convex/actions/voiceNotes.ts (buildInsights)",
      "Frontend insights tab: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx"
    ]
  },
  "philosophyAndGoals": {
    "corePhilosophy": "Complete the automation loop: automatic triggering + personalized learning + feedback collection. Make AI adapt to each coach's preferences and improve over time.",
    "criticalGapFromPhase72": "Phase 7.2 built auto-apply capability but NOT automatic triggering. US-009.5 fixes this first before adding learning features.",
    "successMetrics": {
      "automatic": "100% of eligible insights auto-apply without manual action",
      "personalized": "Each coach has individualized confidence threshold and category preferences",
      "adaptive": "Thresholds adjust based on undo patterns (high accuracy = lower threshold)",
      "feedback": "80%+ of undo reasons captured for AI improvement"
    },
    "safetyFirst": [
      "Injury/medical NEVER auto-apply (always manual)",
      "Category preferences default to OFF (opt-in per category)",
      "Adaptive thresholds bounded (0.6 minimum, 0.9 maximum)",
      "1-hour undo window maintained",
      "All changes have audit trail"
    ]
  },
  "userStories": [
    {
      "id": "US-009.5",
      "title": "Implement automatic triggering of auto-apply for eligible insights",
      "description": "As the system, I automatically apply high-confidence skill insights for Level 2+ coaches when insights are created (without manual intervention).",
      "phase": "7.3: Learning Loop (Critical Prerequisite)",
      "acceptanceCriteria": [
        "CRITICAL: This fixes the gap from Phase 7.2 where auto-apply required manual triggering",
        "",
        "OPTION A (RECOMMENDED): Integrate with AI action buildInsights",
        "Edit packages/backend/convex/actions/voiceNotes.ts",
        "In buildInsights action, after insights are created:",
        "  - For each newly created insight:",
        "    - Check if eligible for auto-apply:",
        "      * Get coach trust level from coachTrustLevels",
        "      * Calculate effectiveLevel = Math.min(currentLevel, preferredLevel ?? currentLevel)",
        "      * Check: effectiveLevel >= 2",
        "      * Check: confidence >= (insightConfidenceThreshold ?? 0.7)",
        "      * Check: category === 'skill' (Phase 7.3 only skills initially)",
        "      * Check: NOT injury or medical",
        "    - If eligible: await ctx.runMutation(internal.voiceNoteInsights.autoApplyInsight, { insightId })",
        "    - Log result: 'Auto-applied insight {id} for coach {coachId}' or 'Skipped: {reason}'",
        "",
        "OPTION B: Use scheduler in existing mutation",
        "Edit packages/backend/convex/models/voiceNoteInsights.ts",
        "In any mutation that creates insights:",
        "  - After insight inserted:",
        "    - Use ctx.scheduler.runAfter(0, internal.voiceNoteInsights.tryAutoApply, { insightId })",
        "  - Create new internal mutation: tryAutoApply",
        "    - Check eligibility (same logic as Option A)",
        "    - Call autoApplyInsight if eligible",
        "",
        "OPTION C: Scheduled cron (simplest but has delay)",
        "Create packages/backend/convex/crons.ts (if doesn't exist)",
        "Export const autoApplyEligibleInsights = internalMutation({",
        "  handler: async (ctx) => {",
        "    const pendingInsights = await ctx.db",
        "      .query('voiceNoteInsights')",
        "      .withIndex('by_status', (q) => q.eq('status', 'pending'))",
        "      .collect()",
        "    for (const insight of pendingInsights) {",
        "      // Check eligibility",
        "      if (eligible) {",
        "        await autoApplyInsight(ctx, { insightId: insight._id })",
        "      }",
        "    }",
        "  }",
        "})",
        "Add to cron schedule: every 5 minutes",
        "",
        "Safety checks (all options):",
        "  - Don't auto-apply if already applied (status !== 'pending')",
        "  - Don't auto-apply if insight older than 24 hours (stale)",
        "  - Catch and log errors (don't crash if auto-apply fails)",
        "",
        "Logging:",
        "  - console.log('Auto-apply check: insight {id}, eligible: {true/false}, reason: {reason}')",
        "  - console.log('Auto-applied: insight {id} for coach {coachId}')",
        "  - console.error('Auto-apply failed: insight {id}, error: {message}')",
        "",
        "Type check passes",
        "Integration test: Create voice note → Wait for AI → Verify insight auto-applied"
      ],
      "priority": 9.5,
      "passes": true,
      "notes": "CRITICAL PREREQUISITE. Without this, Phase 7.2 'auto-apply' requires manual 'Apply All' button. This implements TRUE automatic behavior. Option A (AI action) is most elegant but modifies actions/voiceNotes.ts. Option B (scheduler) is cleaner separation. Option C (cron) is simplest but has 5min delay. Recommend Option A for immediate triggering.",
      "completed": true
    },
    {
      "id": "US-010",
      "title": "✅ PREREQUISITE COMPLETE: Insight category preferences in coachTrustLevels",
      "description": "As a coach, I control which insight categories auto-apply (skills yes, goals no, etc.).",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "✅ SCHEMA ALREADY COMPLETE: insightAutoApplyPreferences field exists in coachTrustLevels (Phase 7 prerequisites)",
        "✅ Fields include: skills, attendance, goals, performance (all boolean)",
        "✅ injury and medical excluded (always manual review)",
        "",
        "Create mutation: setInsightAutoApplyPreferences",
        "File: packages/backend/convex/models/coachTrustLevels.ts",
        "Args: { preferences: v.object({ skills: v.boolean(), attendance: v.boolean(), goals: v.boolean(), performance: v.boolean() }) }",
        "Returns: v.null()",
        "",
        "Mutation logic:",
        "  - Get authenticated coach userId",
        "  - Query coachTrustLevels by coachId",
        "  - Update insightAutoApplyPreferences field with args.preferences",
        "  - If trust level doesn't exist, create it with default values",
        "",
        "Type check passes",
        "Test: Call mutation with different preferences, verify field updates in Convex"
      ],
      "priority": 10,
      "passes": true,
      "completed": true,
      "notes": "Schema already exists from Phase 7 prerequisites. Ralph only needs to create the mutation. Granular control per category. Coach may trust AI for skills (numeric ratings) but not goals (subjective). Default all to false (opt-in)."
    },
    {
      "id": "US-011",
      "title": "Add category preference controls to settings tab",
      "description": "As a coach, I see checkboxes to enable/disable auto-apply per insight category.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx",
        "OR create new file: settings-tab.tsx (if doesn't exist)",
        "",
        "Add Settings tab (if not already present)",
        "Add section: 'Auto-Apply Preferences'",
        "Description: 'Choose which types of insights can be automatically applied to player profiles'",
        "",
        "Query coachTrustLevel with insightAutoApplyPreferences",
        "Create checkbox group with 4 options:",
        "  - Checkbox: 'Skills' - Label: 'Auto-apply skill rating updates'",
        "    - Checked if preferences?.skills === true",
        "  - Checkbox: 'Attendance' - Label: 'Auto-apply attendance records'",
        "    - Checked if preferences?.attendance === true",
        "  - Checkbox: 'Goals' - Label: 'Auto-apply development goal updates'",
        "    - Checked if preferences?.goals === true",
        "  - Checkbox: 'Performance' - Label: 'Auto-apply performance notes'",
        "    - Checked if preferences?.performance === true",
        "",
        "Below checkboxes, show disabled text:",
        "  'Injury and medical insights always require manual review for safety'",
        "",
        "On checkbox change:",
        "  - Update local state",
        "  - Call setInsightAutoApplyPreferences mutation with updated preferences",
        "  - Show toast notification:",
        "    - If enabled: toast.success('Skill auto-apply enabled')",
        "    - If disabled: toast.success('Skill auto-apply disabled')",
        "",
        "Type check passes",
        "Visual verification: Checkboxes toggle, changes persist on page refresh"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Empowers coaches to choose automation level per category. Some coaches want full automation, others only numeric skills. Respects different coaching styles. Clear safety message about injury/medical."
    },
    {
      "id": "US-012",
      "title": "✅ COMPLETE: Implement adaptive confidence threshold based on undo patterns",
      "description": "As a coach, my confidence threshold auto-adjusts based on my undo behavior (high accuracy = lower threshold for more auto-apply).",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Create or edit: packages/backend/convex/crons.ts",
        "",
        "Export const adjustInsightThresholds = internalMutation({",
        "  handler: async (ctx) => {",
        "    // Get all coaches with auto-apply enabled",
        "    const coaches = await ctx.db.query('coachTrustLevels').collect()",
        "",
        "    for (const coach of coaches) {",
        "      // Skip if no preferences set",
        "      if (!coach.insightAutoApplyPreferences) continue",
        "",
        "      // Get recent auto-applied insights (last 30 days)",
        "      const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000)",
        "      const recentAudits = await ctx.db",
        "        .query('autoAppliedInsights')",
        "        .withIndex('by_coach_org', (q) => q.eq('coachId', coach.coachId).eq('organizationId', coach.organizationId))",
        "        .filter((q) => q.gte(q.field('appliedAt'), thirtyDaysAgo))",
        "        .collect()",
        "",
        "      // Need at least 10 auto-applied insights for meaningful data",
        "      if (recentAudits.length < 10) continue",
        "",
        "      // Calculate undo rate",
        "      const undoCount = recentAudits.filter(a => a.undoneAt !== undefined).length",
        "      const undoRate = undoCount / recentAudits.length",
        "",
        "      // Get current threshold",
        "      const currentThreshold = coach.insightConfidenceThreshold ?? 0.7",
        "",
        "      // Adjust threshold based on undo rate",
        "      let newThreshold = currentThreshold",
        "      if (undoRate < 0.03) {",
        "        // Less than 3% undo rate = high trust, lower threshold",
        "        newThreshold = Math.max(0.6, currentThreshold - 0.05)",
        "      } else if (undoRate > 0.1) {",
        "        // More than 10% undo rate = low trust, raise threshold",
        "        newThreshold = Math.min(0.9, currentThreshold + 0.05)",
        "      }",
        "",
        "      // Update if changed",
        "      if (newThreshold !== currentThreshold) {",
        "        await ctx.db.patch(coach._id, { insightConfidenceThreshold: newThreshold })",
        "        console.log(`Coach ${coach.coachId} threshold adjusted: ${currentThreshold} → ${newThreshold} (undo rate: ${Math.round(undoRate * 100)}%)`)",
        "      }",
        "    }",
        "  }",
        "})",
        "",
        "Add to cron schedule: daily at 2am UTC",
        "Schedule in convex.json or crons configuration",
        "",
        "Type check passes",
        "Test: Manually call mutation, verify thresholds adjust correctly"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Personalized learning per coach. If coach rarely undos (high accuracy), AI can be more aggressive (lower threshold = more insights auto-apply). If coach frequently undos (low accuracy), AI becomes conservative (higher threshold = fewer auto-apply). Uses 30-day rolling window for recent behavior. Requires minimum 10 insights for statistical significance.",
      "completed": true
    },
    {
      "id": "US-013",
      "title": "Track and display undo reasons for AI improvement feedback",
      "description": "As the platform, I collect undo reasons to identify AI improvement opportunities and track patterns.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Create query: getUndoReasonStats",
        "File: packages/backend/convex/models/voiceNoteInsights.ts",
        "Args: { organizationId: v.optional(v.string()), timeframeDays: v.optional(v.number()) }",
        "Returns: v.object({",
        "  total: v.number(),",
        "  byReason: v.array(v.object({",
        "    reason: v.string(),",
        "    count: v.number(),",
        "    percentage: v.number()",
        "  })),",
        "  topInsights: v.array(v.object({",
        "    insightId: v.id('voiceNoteInsights'),",
        "    title: v.string(),",
        "    reason: v.string(),",
        "    undoneAt: v.number()",
        "  }))",
        "})",
        "",
        "Query logic:",
        "  - Query autoAppliedInsights where undoneAt is not undefined",
        "  - Filter by organizationId if provided",
        "  - Filter by timeframe if provided (default 30 days)",
        "  - Group by undoReason, count occurrences",
        "  - Calculate percentage for each reason",
        "  - Get top 10 most recent undone insights for context",
        "",
        "Create admin page (optional): apps/web/src/app/admin/ai-insights/undo-analysis/page.tsx",
        "Show Card with title: 'Undo Reason Analysis'",
        "Display statistics:",
        "  - Total undone insights",
        "  - Breakdown by reason with percentages",
        "  - Simple bar chart or list",
        "Button: 'Export to CSV' (downloads undo data)",
        "",
        "Type check passes",
        "Visual verification: Stats display correctly, export works"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Feedback loop for AI improvement. If 'wrong player' is common → improve player matching. If 'wrong rating' is common → improve confidence scoring. If 'insight incorrect' is common → improve AI prompt. Data-driven improvements. Can be used by AI team to retrain models."
    }
  ],
  "testingStrategy": {
    "criticalTests": [
      "US-009.5: Create voice note → Verify insight auto-applies WITHOUT manual action",
      "US-010/011: Toggle category preferences → Verify only enabled categories auto-apply",
      "US-012: Create coach with high undo rate → Verify threshold increases",
      "US-013: Undo multiple insights → Verify stats aggregate correctly"
    ],
    "integrationTests": [
      "End-to-end: Voice note → AI processing → Auto-apply → Undo → Stats tracked",
      "Category filtering: Enable only skills → Verify goals don't auto-apply",
      "Adaptive learning: Low undo rate → Threshold decreases over time",
      "Safety: Injury insights never auto-apply regardless of preferences"
    ],
    "successCriteria": [
      "Auto-apply happens automatically (no manual triggering)",
      "Category preferences control which insights auto-apply",
      "Thresholds adapt based on undo patterns",
      "Undo reasons collected and analyzable",
      "All safety guardrails maintained",
      "No manual intervention required for eligible insights"
    ]
  },
  "knownLimitations": [
    "US-009.5 Option C (cron) has 5-minute delay (not immediate)",
    "Adaptive thresholds require 10+ insights for adjustment (cold start period)",
    "Undo analysis requires platform admin access (not coach-visible)",
    "Category preferences Phase 7.3 only supports skills initially (others in future)"
  ],
  "nextPhase": {
    "phase": "7.4: Advanced Features (Future)",
    "potentialStories": [
      "Multi-category auto-apply (attendance, goals, performance)",
      "Coach notification preferences for auto-applied insights",
      "Bulk undo capability",
      "AI confidence explanation (why this score?)",
      "Predictive analytics (which coaches will undo?)"
    ]
  }
}

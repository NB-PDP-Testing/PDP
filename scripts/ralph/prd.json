{
  "project": "P7 Phase 1 - Preview Mode for Insight Auto-Apply",
  "branchName": "ralph/coach-insights-auto-apply-p7-phase1",
  "description": "Show coaches which insights AI would auto-apply WITHOUT actually doing it. Mirrors P5 Phase 1 pattern. Build trust through transparency before automation.",
  "readinessLevel": "100%",
  "prerequisitesCompleted": {
    "status": "✅ ALL COMPLETE",
    "completedWork": [
      "US-001: insightPreviewModeStats schema fields COMPLETE",
      "US-006: autoAppliedInsights table COMPLETE",
      "US-010: insightAutoApplyPreferences schema COMPLETE",
      "voiceNoteInsights table created with 40 migrated insights",
      "AI confidence scoring implemented (0.0-1.0 scale)",
      "Migration verified successfully"
    ],
    "documentationReferences": [
      "scripts/ralph/P7_RALPH_CONTEXT.md - Complete P5/P6 learnings (PRIMARY REFERENCE)",
      "scripts/ralph/P7_PREREQUISITES_COMPLETED.md - What's been built",
      "scripts/ralph/P7_PHASE1_PREREQUISITES_NOTE.md - What Ralph needs to know",
      "scripts/ralph/P7_PHASE1_EXECUTION_PLAN.md - Step-by-step execution guide"
    ]
  },
  "contextAndDependencies": {
    "completedPhases": [
      "P5 Phases 1-4: Trust system for parent summaries (complete pattern to mirror)",
      "P6 Phases 1-4: Monitoring and cost controls",
      "P7 Prerequisites: Schema extensions, migration, AI confidence scoring"
    ],
    "requiredTables": [
      "✅ voiceNoteInsights (lines 1439-1560) - Dedicated table with confidenceScore",
      "✅ coachTrustLevels (lines 2089-2108) - Extended with insightPreviewModeStats"
    ],
    "keyFiles": [
      "Schema: packages/backend/convex/schema.ts",
      "Backend (TO CREATE): packages/backend/convex/models/voiceNoteInsights.ts",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/*-insight-card.tsx"
    ],
    "referenceImplementations": {
      "P5_Preview_Mode": "apps/web/src/app/orgs/[orgId]/coach/parent-summaries/components/summary-card.tsx",
      "P5_Trust_Calculation": "packages/backend/convex/models/coachParentSummaries.ts",
      "Pattern": "EXACTLY the same as P5 Phase 1, but for insights instead of summaries"
    }
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "✅ PREREQUISITE COMPLETE: Insight preview mode fields in coachTrustLevels",
      "description": "As a coach, the system tracks my insight preview mode progress to measure AI agreement.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "✅ ALREADY DONE: insightPreviewModeStats field exists in schema (lines 2089-2108)",
        "✅ ALREADY DONE: insightConfidenceThreshold field exists (default 0.7)",
        "✅ ALREADY DONE: insightAutoApplyPreferences field exists",
        "RALPH ACTION: Verify these fields exist in schema, mark story as complete immediately"
      ],
      "priority": 1,
      "passes": true,
      "completed": true,
      "notes": "COMPLETED IN PREREQUISITES. Ralph verifies and skips to US-002."
    },
    {
      "id": "US-002",
      "title": "Add wouldAutoApply calculation to getPendingInsights query",
      "description": "As a coach, I see which insights would auto-apply at my current trust level.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Create packages/backend/convex/models/voiceNoteInsights.ts",
        "Create getPendingInsights query:",
        "  Args: { organizationId: v.string(), coachId: v.string(), status: v.optional(v.string()) }",
        "  Returns: v.array(v.object({ ...insight fields, wouldAutoApply: v.boolean() }))",
        "Query voiceNoteInsights TABLE (NOT embedded array!):",
        "  .withIndex('by_coach_org_status', q => q.eq('coachId', ...).eq('organizationId', ...).eq('status', ...))",
        "Get coach trust level from coachTrustLevels table",
        "Calculate wouldAutoApply for each insight:",
        "  const effectiveLevel = Math.min(trustLevel?.currentLevel ?? 0, trustLevel?.preferredLevel ?? trustLevel?.currentLevel ?? 0)",
        "  const threshold = trustLevel?.insightConfidenceThreshold ?? 0.7",
        "  const wouldAutoApply = insight.category !== 'injury' && insight.category !== 'medical' && effectiveLevel >= 2 && insight.confidenceScore >= threshold",
        "Return insights with wouldAutoApply field added",
        "Type check passes: npm run check-types"
      ],
      "priority": 2,
      "passes": true,
      "completed": true,
      "notes": "✅ COMPLETED: getPendingInsights query created with wouldAutoApply calculation. Uses by_coach_org_status index, mirrors P5 US-002 exactly. Commit: 32c741c"
    },
    {
      "id": "US-003",
      "title": "Add confidence visualization to insight cards",
      "description": "As a coach, I see AI confidence scores on insight cards.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Find insight card components in apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/",
        "REFERENCE P5 IMPLEMENTATION: apps/web/src/app/orgs/[orgId]/coach/parent-summaries/components/summary-card.tsx",
        "Add confidence section to each insight card:",
        "Import Progress from '@/components/ui/progress'",
        "Import cn from '@/lib/utils'",
        "Add after insight description, before action buttons:",
        "  <div className='mt-4 space-y-2'>",
        "    <div className='flex items-center justify-between text-sm'>",
        "      <span className={cn('font-medium',",
        "        insight.confidenceScore < 0.6 ? 'text-red-600' :",
        "        insight.confidenceScore < 0.8 ? 'text-amber-600' : 'text-green-600')",
        "      }>",
        "        AI Confidence: {Math.round(insight.confidenceScore * 100)}%",
        "      </span>",
        "    </div>",
        "    <Progress value={insight.confidenceScore * 100} className='h-2' />",
        "  </div>",
        "Type check passes",
        "Visual verification in browser: http://localhost:3000/orgs/{orgId}/coach/voice-notes"
      ],
      "priority": 3,
      "passes": true,
      "completed": true,
      "notes": "✅ COMPLETED: Confidence visualization added with progress bars and color coding (red/amber/green). Uses embedded insights.confidence field. Commit: 47b6a22"
    },
    {
      "id": "US-004",
      "title": "Add preview mode prediction badge to insight cards",
      "description": "As a coach in preview mode, I see what AI would do with each insight.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Edit insight card components",
        "Add wouldAutoApply: boolean to props interface",
        "REFERENCE P5 US-004 PATTERN",
        "After confidence visualization, add prediction badge:",
        "  {insight.wouldAutoApply ? (",
        "    <Badge variant='secondary' className='bg-blue-100 text-blue-700'>",
        "      <Sparkles className='mr-1 h-3 w-3' />",
        "      AI would auto-apply this at Level 2+",
        "    </Badge>",
        "  ) : (",
        "    <p className='text-sm text-muted-foreground'>Requires manual review</p>",
        "  )}",
        "Import Badge from '@/components/ui/badge'",
        "Import Sparkles from 'lucide-react'",
        "Parent component (InsightsTab) must pass wouldAutoApply prop from getPendingInsights query",
        "Type check passes",
        "Visual verification: Badge appears for high-confidence skills, 'manual review' for injury/medical"
      ],
      "priority": 4,
      "passes": true,
      "completed": true,
      "notes": "✅ COMPLETED: Preview badge added with Sparkles icon for wouldAutoApply. Query added to get trust level with insight fields. Commit: 00f4b4a"
    },
    {
      "id": "US-005",
      "title": "Track insight preview mode statistics when coaches apply/dismiss",
      "description": "As a coach, the system learns my agreement rate with AI insight predictions.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "In packages/backend/convex/models/voiceNoteInsights.ts",
        "Create applyInsight mutation:",
        "  Args: { insightId: v.id('voiceNoteInsights') }",
        "  Returns: v.id('voiceNoteInsights')",
        "REFERENCE P5 US-005: packages/backend/convex/models/coachParentSummaries.ts applyParentSummary mutation",
        "Before applying insight, add preview mode tracking:",
        "  Get authenticated userId",
        "  Get insight from DB",
        "  Get coach trust level",
        "  if (trustLevel?.insightPreviewModeStats && !trustLevel.insightPreviewModeStats.completedAt) {",
        "    Calculate wouldAutoApply (same logic as US-002)",
        "    Update counters:",
        "      wouldAutoApplyInsights += (wouldAutoApply ? 1 : 0)",
        "      coachAppliedThose += (wouldAutoApply ? 1 : 0)",
        "      agreementRate = newApplied / newInsights",
        "      completedAt = (newInsights >= 20 ? Date.now() : undefined)",
        "  }",
        "Apply insight: patch status to 'applied', set appliedAt and appliedBy",
        "Create dismissInsight mutation with similar tracking:",
        "  Increment wouldAutoApplyInsights and coachDismissedThose",
        "  Do NOT increment coachAppliedThose",
        "Type check passes"
      ],
      "priority": 5,
      "passes": true,
      "completed": true,
      "notes": "✅ COMPLETED: applyInsight and dismissInsight mutations with preview tracking. 20-insight preview period with agreementRate calculation. Commit: 6666834"
    }
  ],
  "testingRequirements": {
    "previewMode": [
      "Login as coach: neil.B@blablablak.com / lien1979",
      "Navigate to Voice Notes → AI Insights tab",
      "Verify confidence scores visible (progress bar + percentage)",
      "Verify color coding: Red <60%, Amber 60-79%, Green 80%+",
      "Verify 'AI would auto-apply' badge on high-confidence skills",
      "Verify 'Requires manual review' on injury/medical and low-confidence",
      "Apply 5 insights that have 'would auto-apply' badge",
      "Dismiss 2 insights that have 'would auto-apply' badge",
      "Check Convex dashboard: coachTrustLevels.insightPreviewModeStats",
      "  - wouldAutoApplyInsights: 7",
      "  - coachAppliedThose: 5",
      "  - coachDismissedThose: 2",
      "  - agreementRate: ~0.71 (71%)",
      "Apply 13 more insights (total 20)",
      "Verify completedAt timestamp is set"
    ]
  },
  "successCriteria": {
    "backend": [
      "getPendingInsights query returns wouldAutoApply boolean",
      "applyInsight and dismissInsight mutations created",
      "Preview stats increment correctly",
      "After 20 insights, completedAt is set",
      "Type check passes",
      "Codegen runs successfully"
    ],
    "frontend": [
      "Confidence progress bar visible on all insight cards",
      "Color coding correct (red/amber/green)",
      "Preview badge shows for wouldAutoApply=true",
      "Manual review text for wouldAutoApply=false",
      "Visual verification in browser passes"
    ]
  },
  "reference": "Full Phase 7 PRD: scripts/ralph/prds/p7-coach-insight-auto-apply-phase7.prd.json",
  "nextPhase": "Phase 7.2: Supervised Auto-Apply (US-006 to US-009) - Actually auto-apply insights to player profiles with 1-hour undo window"
}

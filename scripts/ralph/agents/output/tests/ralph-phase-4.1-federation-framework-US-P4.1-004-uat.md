# UAT Test: US-P4.1-004 - Implement OAuth 2.0 authorization flow action

> Auto-generated: 2026-02-15 20:56
> Status: ‚è≥ Pending Execution

## Story
As a platform admin, I need to complete the OAuth 2.0 authorization flow with a federation API to obtain access tokens.

## Acceptance Criteria Checklist

- [ ] Create packages/backend/convex/actions/federationAuth.ts
- [ ] Implement startOAuthFlow action: generates authorization URL with state parameter
- [ ] Returns: { authorizationUrl, state } for frontend redirect
- [ ] Implement completeOAuthFlow action: accepts code and state parameters
- [ ] Validates state matches expected value (CSRF protection)
- [ ] Exchanges authorization code for access token via POST to token endpoint
- [ ] Stores access token, refresh token, expires_at in encrypted credentials
- [ ] Updates connector's credentialsStorageId with encrypted token data
- [ ] Implement refreshOAuthToken action: refreshes expired access token
- [ ] Checks if token is expired (expires_at < now), calls refresh endpoint if needed
- [ ] Updates credentials file with new access token and expiry
- [ ] Add error handling for invalid codes, expired tokens, network failures
- [ ] Run npx ultracite fix and npm run check-types

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-P4.1-004"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

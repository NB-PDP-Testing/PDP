{
  "project": "Phase 9 Week 4 Phase 1 - Team Hub Foundation (Tab Navigation)",
  "branchName": "ralph/p9-week4-team-hub",
  "description": "Week 4 Phase 1: Add tab navigation to existing Team Hub, enhance activity feed with pagination, optional schema change for voice notes.",
  "referencePRD": "scripts/ralph/P9_WEEK4_REVISED_PLAN.md",
  "previousWeeks": [
    "Week 1: Collaboration Foundations (8 stories) - COMPLETE ✅",
    "Week 2: Activity Feed & AI Copilot (14 stories) - COMPLETE ✅",
    "Week 3: Multi-View, Voting, Command Palette & Gestures (17 stories) - COMPLETE ✅"
  ],
  "currentPhase": "Week 4 Phase 1 - Foundation (3 stories, 4 hours)",
  "nextPhases": [
    "Phase 2: Core Widgets (Overview + Health) - 7h",
    "Phase 3: Tab Views (Players + Planning) - 6h",
    "Phase 4: Collaboration (Tasks + Insights) - 9h",
    "Phase 5: Already Complete (Quick Actions) - 0h"
  ],
  "totalPhase9Scope": "50 stories across 4 weeks (~125 hours)",
  "week4Effort": "~26 hours (11 stories + 1 schema) - 30% reduction via code reuse",
  "completedWork": {
    "week1": {
      "stories": 8,
      "features": [
        "Real-time presence indicators (teamMemberPresence table)",
        "Comments with priority (insightComments table)",
        "Reactions system (insightReactions table)",
        "Team activity feed foundation (teamActivityFeed table)"
      ]
    },
    "week2": {
      "stories": 14,
      "features": [
        "Activity feed with filtering",
        "@Mention autocomplete with smart ranking",
        "Priority notifications with preferences UI",
        "AI Copilot smart suggestions"
      ]
    },
    "week3": {
      "stories": 17,
      "features": [
        "Multi-view layouts (Board, Calendar, Player views)",
        "Team decisions voting (100% complete - VotingCard + VotingList)",
        "Command palette (Cmd+K)",
        "Global keyboard shortcuts",
        "Comment threading",
        "Mobile swipe gestures",
        "Touch target optimization"
      ]
    },
    "existingTeamHub": {
      "status": "PRODUCTION READY - 817 lines of code",
      "location": "/coach/team-hub",
      "components": [
        "activity-feed-view.tsx (235 lines) - 90% complete",
        "presence-indicators.tsx (120 lines) - 100% complete",
        "voting-card.tsx (393 lines) - 100% complete",
        "voting-list.tsx (69 lines) - 100% complete"
      ],
      "note": "Week 4 ENHANCES existing /team-hub, does NOT rebuild from scratch"
    }
  },
  "criticalPatterns": [
    "MANDATORY: Use Better Auth adapter pattern with _id field (not userId): ctx.runQuery(components.betterAuth.adapter.findOne, { model: \"user\", where: [{ field: \"_id\", value: userId, operator: \"eq\" }] })",
    "MANDATORY: Use withIndex(), NEVER use filter() except after withIndex",
    "MANDATORY: Always include args and returns validators on ALL queries/mutations",
    "MANDATORY: Batch fetch to avoid N+1 queries - use Map lookup pattern",
    "MANDATORY: Mobile-first design - all UI must work perfectly on mobile before desktop",
    "MANDATORY: Touch targets ≥44px for mobile accessibility",
    "MANDATORY: Visual verification with dev-browser for all UI changes",
    "MANDATORY: Skeleton loaders (not spinners) for loading states",
    "MANDATORY: Empty states with icon + title + description + CTA",
    "REUSE EXISTING CODE: /team-hub components are production-ready, enhance don't rebuild",
    "Performance: Paginate at 50 items, lazy load images, batch fetch with Map",
    "Real-time: useQuery hook (Convex subscriptions automatic)",
    "Toast notifications: import { toast } from 'sonner'",
    "Date formatting: formatDistanceToNow(timestamp, { addSuffix: true })"
  ],
  "schemaChangesRequired": [
    {
      "table": "voiceNotes",
      "change": "Add sessionPlanId field for session-linked notes",
      "fields": {
        "sessionPlanId": "v.optional(v.id(\"sessionPlans\"))"
      },
      "indexes": [".index(\"by_session\", [\"sessionPlanId\"])"],
      "story": "US-P9-SCHEMA",
      "status": "OPTIONAL - Can skip for Phase 1 MVP",
      "note": "Enables linking voice notes to session plans. Not blocking for other features."
    }
  ],
  "librariesToInstall": [
    "All required libraries already installed ✅",
    "framer-motion ✅ (Week 3)",
    "react-hotkeys-hook ✅ (Week 3)",
    "cmdk (command palette) ✅ (Week 3)"
  ],
  "codeReuseStrategy": {
    "reuse": [
      "ActivityFeedView (enhance with pagination)",
      "PresenceIndicators (use in Overview)",
      "VotingCard + VotingList (move to Decisions tab)",
      "QuickActionsMenu (already in header)",
      "PassportAvailabilityBadges (for health status)",
      "PlayerTeamBadges (for player cards)"
    ],
    "enhance": [
      "Team Hub page (add tab navigation)",
      "Activity feed (add pagination cursor)",
      "Mobile layout (add drawer for tabs)"
    ],
    "build": [
      "Overview Dashboard",
      "Health & Safety Widget",
      "Players Tab",
      "Planning Tab",
      "Coach Tasks",
      "Shared Insights"
    ]
  },
  "userStories": [
    {
      "id": "US-P9-063",
      "phase": 1,
      "title": "Add Tab Navigation to Team Hub",
      "description": "Transform existing /team-hub page into tabbed interface (Overview, Players, Planning, Activity, Decisions, Tasks, Insights).",
      "acceptanceCriteria": [
        "IMPORTANT: Enhance EXISTING /team-hub/page.tsx (do NOT create new route)",
        "Wrap existing content in <Tabs> component from shadcn/ui",
        "Create 7 tabs: Overview, Players, Planning, Activity, Decisions, Tasks, Insights",
        "URL persistence via useSearchParams (?tab=overview as default)",
        "Tab state persists on refresh",
        "REUSE: Move existing activity-feed-view.tsx to Activity tab (don't rebuild)",
        "REUSE: Move existing voting-card.tsx + voting-list.tsx to Decisions tab (don't rebuild)",
        "Create PLACEHOLDER components for new tabs: overview-tab.tsx, players-tab.tsx, planning-tab.tsx, tasks-tab.tsx, insights-tab.tsx",
        "Placeholders show: Tab title + 'Coming in Phase 2/3/4' message + icon",
        "Keep existing team selector dropdown in header (above tabs)",
        "Keep existing presence indicators (above tabs)",
        "Mobile: Tabs scroll horizontally (no overflow)",
        "Desktop: Tabs fixed width, full bar visible",
        "Responsive breakpoints: 768px (mobile/tablet), 1024px (desktop)",
        "Loading skeleton while team loading",
        "Type check passes: npm run check-types",
        "Visual verification with dev-browser (all 7 tabs clickable)"
      ],
      "priority": 1,
      "passes": false,
      "effort": "2h",
      "dependencies": [],
      "files": {
        "modify": ["apps/web/src/app/orgs/[orgId]/coach/team-hub/page.tsx"],
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/tab-navigation.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/overview-tab.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/players-tab.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/planning-tab.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/tasks-tab.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/insights-tab.tsx"
        ],
        "reuse": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/activity-feed-view.tsx (move to Activity tab)",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/voting-card.tsx (move to Decisions tab)",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/voting-list.tsx (move to Decisions tab)"
        ]
      }
    },
    {
      "id": "US-P9-SCHEMA",
      "phase": 1,
      "title": "Optional: Add sessionPlanId to voiceNotes",
      "description": "Add optional sessionPlanId field to voiceNotes table for linking notes to session plans.",
      "acceptanceCriteria": [
        "OPTIONAL: Can skip if not critical for Phase 1",
        "Modify packages/backend/convex/schema.ts",
        "Add field: sessionPlanId: v.optional(v.id(\"sessionPlans\")) to voiceNotes table",
        "Add index: .index(\"by_session\", [\"sessionPlanId\"])",
        "Run: npx -w packages/backend convex dev (applies schema)",
        "Run: npx -w packages/backend convex codegen",
        "Type check passes",
        "Verify in Convex dashboard: voiceNotes table has sessionPlanId field"
      ],
      "priority": 2,
      "passes": false,
      "effort": "0.5h",
      "dependencies": [],
      "files": {
        "modify": ["packages/backend/convex/schema.ts"]
      },
      "note": "OPTIONAL - Enables US-P9-061 (Voice Notes Integration) in Phase 4. Can skip for now."
    },
    {
      "id": "US-P9-056",
      "phase": 1,
      "title": "Enhance Activity Feed with Pagination",
      "description": "Add cursor-based pagination to existing ActivityFeedView component.",
      "acceptanceCriteria": [
        "ENHANCE existing activity-feed-view.tsx (do NOT rebuild from scratch)",
        "Backend: Enhance packages/backend/convex/models/teamCollaboration.ts",
        "Update getTeamActivityFeed query to support pagination:",
        "  - Add paginationOpts arg: { cursor: v.union(v.string(), v.null()), numItems: v.number() }",
        "  - Return object: { page: v.array(...), continueCursor: v.union(v.string(), v.null()), isDone: v.boolean() }",
        "  - Use Convex paginate() helper for cursor-based pagination",
        "  - Keep existing filters arg (types, dateRange - optional)",
        "Frontend: Add pagination state to activity-feed-view.tsx",
        "  - useState for cursor and accumulated items",
        "  - 'Load More' button at bottom (only show if !isDone)",
        "  - Click 'Load More' → fetch next page with continueCursor",
        "  - Append new items to existing list",
        "  - Loading spinner on button while fetching",
        "  - Disable button while loading",
        "Keep existing features: tab filtering, real-time updates, empty states",
        "Default: Load 50 items per page",
        "Type check passes",
        "Visual verification: Load More works, pagination smooth"
      ],
      "priority": 3,
      "passes": false,
      "effort": "1.5h",
      "dependencies": [],
      "files": {
        "modify": [
          "packages/backend/convex/models/teamCollaboration.ts",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/activity-feed-view.tsx"
        ]
      }
    }
  ],
  "phase1Checklist": [
    "✅ Read P9_WEEK4_REVISED_PLAN.md for complete context",
    "✅ Read P9_WEEK4_COMPARISON.md to understand code reuse strategy",
    "✅ Understand existing /team-hub has 817 lines of working code",
    "⚠️ DO NOT create new /teams/[teamId] route - enhance existing /team-hub",
    "⚠️ DO NOT rebuild activity feed - enhance with pagination only",
    "⚠️ DO NOT rebuild voting - move to Decisions tab as-is",
    "✅ Create tab navigation with 7 tabs",
    "✅ Create placeholder components for Phase 2-4 tabs",
    "✅ Add pagination to activity feed backend + frontend",
    "✅ Optional: Add voiceNotes.sessionPlanId field",
    "✅ Type check passes after all changes",
    "✅ Visual verification with dev-browser",
    "✅ Commit with message: 'feat: Phase 9 Week 4 Phase 1 - Team Hub tab navigation'",
    "✅ All existing features still work (activity feed, voting, presence)"
  ],
  "successCriteria": {
    "phase1Complete": [
      "Team Hub has 7 clickable tabs",
      "Activity tab shows existing activity feed with Load More button",
      "Decisions tab shows existing voting cards",
      "Other tabs show placeholders ('Coming soon')",
      "URL persists tab state (?tab=players)",
      "Mobile tabs scroll horizontally",
      "Desktop tabs full width",
      "All existing functionality preserved",
      "Type check passes",
      "0 new TypeScript errors introduced"
    ]
  }
}

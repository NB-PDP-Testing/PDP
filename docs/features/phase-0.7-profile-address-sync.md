# PlayerARC - Phase 0.7: User Profile Address Management & Data Sync

> Auto-generated documentation - Last updated: 2026-02-05 08:31

## Status

- **Branch**: `ralph/phase-0.7-profile-address-sync`
- **Progress**: 6 / 6 stories complete
- **Phase Status**: ✅ Complete

## Completed Features

### US-P0.7-001: Add address2 and county fields to guardianIdentities schema

As a developer, I need guardianIdentities to have the same address fields as the user table for consistency.

**Acceptance Criteria:**
- Add address2: v.optional(v.string()) to guardianIdentities in schema.ts
- Add county: v.optional(v.string()) to guardianIdentities in schema.ts
- Update guardianIdentityValidator in guardianIdentities.ts to include address2 and county
- Update updateGuardianIdentity mutation args to accept address2 and county
- Run npx -w packages/backend convex codegen successfully
- Typecheck passes: npm run check-types

### US-P0.7-002: Create updateProfileWithSync mutation

As a user, I need my profile changes to automatically sync to my guardian identity record.

**Acceptance Criteria:**
- Create updateProfileWithSync mutation in userProfiles.ts
- Mutation accepts: firstName, lastName, phone, address, address2, town, county, postcode, country
- Mutation updates the user table with all provided fields
- Mutation finds linked guardianIdentity by userId using withIndex
- If guardianIdentity found, sync name and address fields to it
- If no guardianIdentity linked, no error thrown
- Use normalizePhone and normalizePostcode from guardianMatcher.ts
- Returns { success: boolean }
- Typecheck passes

### US-P0.7-003: Update linkGuardianToUser to copy address on claim

As a user who claims an imported guardian, I want my profile pre-populated with the imported address.

**Acceptance Criteria:**
- Modify linkGuardianToUser mutation in guardianIdentities.ts
- After linking userId, check if user has no address
- If user.address is empty and guardian has address, copy all address fields
- Copy: address, address2, town, county, postcode, country
- If user already has address, do NOT overwrite
- Existing linking behavior unchanged
- Typecheck passes

### US-P0.7-004: Expand ProfileSettingsDialog with address fields

As a user, I need to be able to edit my full address in Profile Settings.

**Acceptance Criteria:**
- Import address data constants from @/lib/constants/address-data
- Add state variables for all address fields
- Initialize state from user data (user?.address, etc.)
- Add new 'Address' card section after 'Personal Information'
- Include: Street Address, Address Line 2, Town/City, Postcode, County, Country
- Town and Postcode on same row (50/50 grid)
- County and Country on same row (50/50 grid)
- County field dynamic: dropdown for IE (26 counties + Other), dropdown for US (states + Other), text input for others
- Country dropdown: Ireland, UK, US at top, then alphabetical
- Postcode auto-uppercase on input
- Update save handler to use updateProfileWithSync mutation
- Include all address fields in mutation call
- Typecheck passes

### US-P0.7-005: Update Guardian Settings to display address

As a parent, I want to see my address in Guardian Settings.

**Acceptance Criteria:**
- Update GuardianSettingsProps type to include address fields
- Add address display section in 'Your Profile' card
- Only show address section if any address field has data
- Format: Address line 1 + line 2, Town + postcode, County + country
- Display country as full name using getCountryName helper
- Address display is read-only (no edit in this dialog)
- Typecheck passes

### US-P0.7-006: End-to-end testing and verification

As a developer, I need to verify the complete address sync flow works correctly.

**Acceptance Criteria:**
- Test: Self-registered user edits address → saved to user table
- Test: User with linked guardian edits address → synced to guardianIdentities
- Test: User claims guardian with address, user has no address → address copied
- Test: User claims guardian with address, user HAS address → NOT overwritten
- Test: Guardian Settings displays address correctly
- Test: Manage Users page shows correct address (existing functionality)
- Test: Guardian matching still works (no regression)
- All linting passes: npx ultracite fix
- All type checks pass: npm run check-types


## Implementation Notes

### Key Patterns & Learnings


## Key Files


---
*Documentation auto-generated by Ralph Documenter Agent*

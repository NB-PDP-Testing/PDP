{
  "project": "Coach AI Insights - Phase 7 (Auto-Apply with Trust System)",
  "branchName": "ralph/coach-insights-auto-apply-p7",
  "description": "Progressive automation for auto-applying AI insights to player profiles. Mirrors P5 parent summary trust system but for player data updates. Preview mode → Supervised auto-apply → Learning loop.",
  "readinessLevel": "100%",
  "contextAndDependencies": {
    "completedPhases": [
      "P1-P4: Voice notes and parent summaries infrastructure complete",
      "P5 Phase 1: Trust slider, preview mode, confidence visualization for parent summaries",
      "P6: Monitoring, cost controls, graceful degradation for parent summaries"
    ],
    "requiredTables": [
      "voiceNoteInsights - Has category, confidenceScore, status fields",
      "coachTrustLevels - Platform-wide trust with currentLevel, preferredLevel, totalApprovals",
      "orgPlayerEnrollments - Player profiles that insights update"
    ],
    "existingQueries": [
      "getPendingInsights - Returns insights awaiting coach review/application",
      "getCoachTrustLevel - Returns coach's current trust level and progress"
    ],
    "keyFiles": [
      "Schema: packages/backend/convex/schema.ts",
      "Backend insights: packages/backend/convex/models/voiceNoteInsights.ts",
      "Backend trust: packages/backend/convex/models/coachTrustLevels.ts",
      "Frontend insights tab: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx",
      "Insight cards: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/*-insight-card.tsx"
    ],
    "parallelToP5": "This phase mirrors P5's parent summary automation but for player profile updates. Same trust levels, same preview pattern, same progressive automation."
  },
  "philosophyAndGoals": {
    "corePhilosophy": "Coaches must trust AI won't mess up player data. Show what AI would do BEFORE doing it. Progressive automation with safety nets.",
    "industryPatterns": [
      "Google Smart Reply: Preview suggestions before auto-send",
      "GitHub Copilot: Show what AI would suggest, track acceptance",
      "Stripe: Circuit breakers detect model degradation",
      "Zendesk: 60-70% confidence threshold for auto-actions"
    ],
    "successMetrics": {
      "previewMode": "40%+ agreement rate (coaches apply what AI predicted)",
      "supervised": "30%+ auto-apply rate, <5% undo rate",
      "learning": "Adaptive thresholds reduce manual review by 50%"
    },
    "safetyFirst": [
      "Never auto-apply injury or medical insights (always manual)",
      "1-hour undo window for all auto-applied insights",
      "Version control: Track previous values before auto-apply",
      "Coach notification: Never silent auto-apply",
      "Kill switch: Platform staff can disable globally"
    ]
  },
  "implementationOrder": [
    "PHASE 7.1: Preview Mode for Insights (Weeks 1-2) - Stories US-001 to US-005",
    "PHASE 7.2: Supervised Auto-Apply (Weeks 3-4) - Stories US-006 to US-009",
    "PHASE 7.3: Learning Loop & Adaptive Thresholds (Weeks 5-6) - Stories US-010 to US-013"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Add insight preview mode fields to coachTrustLevels schema",
      "description": "As a coach, the system tracks my insight preview mode progress to measure AI agreement.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/schema.ts",
        "Find coachTrustLevels table definition (around line 1795)",
        "Add insightPreviewModeStats field:",
        "  v.optional(v.object({",
        "    wouldAutoApplyInsights: v.number(),",
        "    coachAppliedThose: v.number(),",
        "    coachDismissedThose: v.number(),",
        "    agreementRate: v.number(),",
        "    startedAt: v.number(),",
        "    completedAt: v.optional(v.number())",
        "  }))",
        "Add insightConfidenceThreshold field: v.optional(v.number())",
        "Run: npx -w packages/backend convex codegen",
        "Type check passes: npm run check-types"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Mirrors P5 US-001 but for insights. 20-insight learning period. Default 70% threshold. Separate from parent summary preview stats to allow different trust levels."
    },
    {
      "id": "US-002",
      "title": "Add wouldAutoApply calculation to getPendingInsights",
      "description": "As a coach, I see which insights would auto-apply at my current trust level.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/models/voiceNoteInsights.ts",
        "Find getPendingInsights query",
        "Import coachTrustLevels query",
        "After fetching insights, get coach trust level:",
        "  const trustLevel = await ctx.db.query('coachTrustLevels').withIndex('by_coach', q => q.eq('coachId', userId)).first()",
        "Calculate for each insight:",
        "  const effectiveLevel = Math.min(trustLevel.currentLevel, trustLevel.preferredLevel ?? trustLevel.currentLevel)",
        "  const threshold = trustLevel.insightConfidenceThreshold ?? 0.7",
        "  const wouldAutoApply = insight.category !== 'injury' && insight.category !== 'medical' && effectiveLevel >= 2 && insight.confidenceScore >= threshold",
        "Add wouldAutoApply to each insight object returned",
        "Update returns validator to include wouldAutoApply: v.boolean()",
        "Type check passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Prediction ONLY - nothing auto-applies yet. Level 0/1 always false. Level 2 checks threshold. Level 3 always true (except injury/medical). Never auto-apply sensitive categories."
    },
    {
      "id": "US-003",
      "title": "Add confidence visualization to insight cards",
      "description": "As a coach, I see AI confidence scores on insight cards (currently hidden).",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Identify insight card components in apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/",
        "For each card type (skill, attendance, goal, etc.), add confidence section:",
        "Import Progress from '@/components/ui/progress'",
        "Import cn from '@/lib/utils'",
        "Add after insight description, before action buttons:",
        "  <div className='mt-4 space-y-2'>",
        "    <div className='flex items-center justify-between text-sm'>",
        "      <span className={cn('font-medium',",
        "        confidenceScore < 0.6 ? 'text-red-600' :",
        "        confidenceScore < 0.8 ? 'text-amber-600' : 'text-green-600')",
        "      }>",
        "        AI Confidence: {Math.round(insight.confidenceScore * 100)}%",
        "      </span>",
        "    </div>",
        "    <Progress value={insight.confidenceScore * 100} className='h-2' />",
        "  </div>",
        "Type check passes",
        "Visual verification in browser"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Confidence scores already exist on insights but are hidden. Making visible = transparency. Color coding: Red <60%, Amber 60-79%, Green 80%+. Matches P5 US-003 pattern."
    },
    {
      "id": "US-004",
      "title": "Add preview mode prediction badge to insight cards",
      "description": "As a coach in preview mode, I see what AI would do with each insight.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Edit insight card components",
        "Add wouldAutoApply to props interface",
        "After confidence visualization, add prediction badge:",
        "  {wouldAutoApply ? (",
        "    <Badge variant='secondary' className='bg-blue-100 text-blue-700'>",
        "      <Sparkles className='mr-1 h-3 w-3' />",
        "      AI would auto-apply this at Level 2+",
        "    </Badge>",
        "  ) : (",
        "    <p className='text-sm text-muted-foreground'>Requires manual review</p>",
        "  )}",
        "Import Badge from '@/components/ui/badge'",
        "Import Sparkles from 'lucide-react'",
        "Parent component (InsightsTab) must pass wouldAutoApply prop",
        "Type check passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Google Smart Reply pattern. Coaches see: 'High confidence skill insights would auto-apply. Injury insights always manual.' Builds mental model before automation."
    },
    {
      "id": "US-005",
      "title": "Track insight preview mode statistics when coaches apply/dismiss",
      "description": "As a coach, the system learns my agreement rate with AI insight predictions.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/models/voiceNoteInsights.ts",
        "Find applyInsight mutation (or equivalent action that applies insights)",
        "Before applying, add preview mode tracking:",
        "  const trustLevel = await ctx.db.query('coachTrustLevels').withIndex('by_coach', q => q.eq('coachId', userId)).first()",
        "  if (trustLevel?.insightPreviewModeStats && !trustLevel.insightPreviewModeStats.completedAt) {",
        "    const effectiveLevel = Math.min(trustLevel.currentLevel, trustLevel.preferredLevel ?? trustLevel.currentLevel)",
        "    const threshold = trustLevel.insightConfidenceThreshold ?? 0.7",
        "    const wouldAutoApply = insight.category !== 'injury' && insight.category !== 'medical' && effectiveLevel >= 2 && insight.confidenceScore >= threshold",
        "    const newInsights = trustLevel.insightPreviewModeStats.wouldAutoApplyInsights + (wouldAutoApply ? 1 : 0)",
        "    const newApplied = trustLevel.insightPreviewModeStats.coachAppliedThose + (wouldAutoApply ? 1 : 0)",
        "    const agreementRate = newInsights > 0 ? newApplied / newInsights : 0",
        "    await ctx.db.patch(trustLevel._id, {",
        "      insightPreviewModeStats: {",
        "        ...trustLevel.insightPreviewModeStats,",
        "        wouldAutoApplyInsights: newInsights,",
        "        coachAppliedThose: newApplied,",
        "        agreementRate,",
        "        completedAt: newInsights >= 20 ? Date.now() : undefined",
        "      }",
        "    })",
        "  }",
        "Similar logic in dismissInsight mutation (increment insights but NOT coachAppliedThose, increment coachDismissedThose)",
        "Type check passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "20-insight preview period. GitHub Copilot pattern. Agreement rate >70% suggests coach trusts AI. Data informs Phase 7.2 decision. Track both apply and dismiss to get full picture."
    },
    {
      "id": "US-006",
      "title": "Add autoAppliedInsights table to schema",
      "description": "As the system, I track all auto-applied insights for audit trail and undo capability.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/schema.ts",
        "Add new table autoAppliedInsights:",
        "  autoAppliedInsights: defineTable({",
        "    insightId: v.id('voiceNoteInsights'),",
        "    playerId: v.id('orgPlayerEnrollments'),",
        "    coachId: v.string(),",
        "    organizationId: v.string(),",
        "    category: v.string(),",
        "    confidenceScore: v.number(),",
        "    appliedAt: v.number(),",
        "    undoneAt: v.optional(v.number()),",
        "    undoReason: v.optional(v.string()),",
        "    changeType: v.string(),",
        "    fieldChanged: v.string(),",
        "    previousValue: v.optional(v.string()),",
        "    newValue: v.string(),",
        "    autoAppliedByAI: v.boolean(),",
        "  })",
        "  .index('by_coach_org', ['coachId', 'organizationId'])",
        "  .index('by_insight', ['insightId'])",
        "  .index('by_player', ['playerId'])",
        "  .index('by_applied_at', ['appliedAt'])",
        "Run: npx -w packages/backend convex codegen",
        "Type check passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Audit trail for compliance. Supports undo within 1-hour window. Tracks what changed (previousValue → newValue) for rollback. autoAppliedByAI distinguishes from manual applies."
    },
    {
      "id": "US-007",
      "title": "Implement auto-apply logic for skill insights",
      "description": "As a coach at Level 2+, skill insights auto-apply to player profiles when confidence is high.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/models/voiceNoteInsights.ts",
        "Create new mutation: autoApplyInsight",
        "Args: { insightId: v.id('voiceNoteInsights') }",
        "Fetch insight and validate:",
        "  - Coach trust level >= 2",
        "  - Confidence score >= threshold",
        "  - Category === 'skill' (start with safest category)",
        "  - Insight not already applied or auto-applied",
        "Get current player skill rating (previousValue)",
        "Apply new skill rating from insight (newValue)",
        "Update player profile with new skill rating",
        "Create autoAppliedInsights record with audit trail",
        "Mark insight as applied (status = 'applied', appliedAt = Date.now())",
        "Returns: v.object({ success: v.boolean(), appliedInsightId: v.id('autoAppliedInsights') })",
        "Type check passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Start with skills only (safest category). Numeric ratings, easily reverted. Never auto-apply injury/medical/behavioral. Requires audit trail for every change."
    },
    {
      "id": "US-008",
      "title": "Add 1-hour undo window for auto-applied insights",
      "description": "As a coach, I can undo auto-applied insights within 1 hour if AI made a mistake.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Create mutation: undoAutoAppliedInsight",
        "Args: { autoAppliedInsightId: v.id('autoAppliedInsights'), undoReason: v.string() }",
        "Fetch autoAppliedInsights record",
        "Validate:",
        "  - appliedAt within last hour: (Date.now() - appliedAt) < 3600000",
        "  - Not already undone: undoneAt === undefined",
        "  - Coach owns this insight: coachId matches authenticated user",
        "Revert player profile to previousValue",
        "Update autoAppliedInsights record:",
        "  - undoneAt: Date.now()",
        "  - undoReason: args.undoReason",
        "Update original insight status back to 'pending'",
        "Returns: v.object({ success: v.boolean(), message: v.string() })",
        "Type check passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Safety net. 1-hour window matches P5 parent summary revoke. After 1 hour, grayed out 'Cannot undo (expired)'. Captures why coach undid (feedback for learning)."
    },
    {
      "id": "US-009",
      "title": "Add auto-applied insights UI to insights tab",
      "description": "As a coach, I see which insights were auto-applied and can review/undo them.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx",
        "Add filter tabs: 'Pending Review' vs 'Auto-Applied'",
        "Auto-Applied tab shows insights where autoAppliedByAI === true",
        "Each auto-applied insight card shows:",
        "  - ✓ Auto-Applied badge (green)",
        "  - Time applied: 'Applied 23 minutes ago'",
        "  - What changed: 'Passing: 3 → 4'",
        "  - [Undo] button (enabled if within 1 hour)",
        "  - [View Profile] button to see change in context",
        "Undo button click opens dialog:",
        "  - 'Why are you undoing this?'",
        "  - Radio options: Wrong player / Wrong rating / Insight incorrect / Other",
        "  - Text area for 'Other' explanation",
        "  - Calls undoAutoAppliedInsight mutation with reason",
        "Toast notification on undo: 'Auto-apply undone. Skill rating reverted to 3.'",
        "Type check passes",
        "Visual verification in browser"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Transparency. Coach sees everything AI did. Undo is one click. Collecting why helps AI learn (Phase 7.3). After 1 hour, button disabled with tooltip 'Undo window expired'."
    },
    {
      "id": "US-010",
      "title": "Add insight category preferences to coachTrustLevels",
      "description": "As a coach, I control which insight categories auto-apply (skills yes, goals no, etc.).",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/schema.ts",
        "Add to coachTrustLevels table:",
        "  insightAutoApplyPreferences: v.optional(",
        "    v.object({",
        "      skills: v.boolean(),",
        "      attendance: v.boolean(),",
        "      goals: v.boolean(),",
        "      performance: v.boolean(),",
        "    })",
        "  )",
        "Default all to false (opt-in per category)",
        "Run: npx -w packages/backend convex codegen",
        "Create mutation: setInsightAutoApplyPreferences",
        "Args: { preferences: v.object({ skills, attendance, goals, performance }) }",
        "Updates coach's insightAutoApplyPreferences",
        "Type check passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Granular control. Coach may trust AI for skills (numeric) but not goals (subjective). Per-category trust. Injury/medical always excluded (never auto-apply)."
    },
    {
      "id": "US-011",
      "title": "Add category preference controls to settings tab",
      "description": "As a coach, I see checkboxes to enable/disable auto-apply per insight category.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/settings-tab.tsx",
        "Add section after trust level slider: 'Auto-Apply Preferences'",
        "Show checkboxes for each category:",
        "  ☑ Skills - Auto-apply skill rating updates",
        "  ☐ Attendance - Auto-apply attendance records",
        "  ☐ Goals - Auto-apply development goal updates",
        "  ☐ Performance - Auto-apply performance notes",
        "Grayed out text: 'Injury and medical insights always require manual review'",
        "On checkbox change, call setInsightAutoApplyPreferences mutation",
        "Toast feedback: 'Skill auto-apply enabled' or 'Goals auto-apply disabled'",
        "Type check passes",
        "Visual verification: Checkboxes toggle, changes save"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Empowers coaches. Some may want full auto-apply, others only skills. Respects different coaching styles. Injury/medical disclaimer prevents confusion."
    },
    {
      "id": "US-012",
      "title": "Implement adaptive confidence threshold based on undo patterns",
      "description": "As a coach, my confidence threshold auto-adjusts based on my undo behavior.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Create scheduled function: adjustInsightThresholds (runs daily)",
        "For each coach with auto-apply enabled:",
        "  - Fetch last 30 days of autoAppliedInsights",
        "  - Calculate undo rate: undos / total auto-applied",
        "  - If undo rate < 3% (high trust): Lower threshold by 0.05 (min 0.6)",
        "  - If undo rate > 10% (low trust): Raise threshold by 0.05 (max 0.9)",
        "  - Update coachTrustLevels.insightConfidenceThreshold",
        "Log adjustment: 'Coach X threshold adjusted from 0.70 to 0.65 (low undo rate)'",
        "Notify coach via email digest: 'Your auto-apply threshold was adjusted based on your accuracy'",
        "Type check passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Personalized per coach. If coach never undos, AI can be more aggressive. If coach frequently undos, AI becomes more conservative. Adaptive learning."
    },
    {
      "id": "US-013",
      "title": "Track and display undo reasons for AI improvement feedback",
      "description": "As the platform, I collect undo reasons to improve AI confidence scoring.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Create query: getUndoReasonStats",
        "Args: { timeframe: v.optional(v.string()) }",
        "Fetch autoAppliedInsights where undoneAt is not null",
        "Group by undoReason, count occurrences",
        "Returns: v.array(v.object({ reason: v.string(), count: v.number(), percentage: v.number() }))",
        "Create admin page: /admin/ai-insights/undo-analysis",
        "Show pie chart of undo reasons:",
        "  - Wrong player: 45%",
        "  - Wrong rating: 30%",
        "  - Insight incorrect: 20%",
        "  - Other: 5%",
        "Table showing specific examples with coach feedback",
        "Export to CSV for AI model training",
        "Type check passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Feedback loop to AI team. If 'wrong player' is common, improve player matching. If 'wrong rating' is common, improve confidence scoring. Data-driven AI improvements."
    }
  ],
  "testingRequirements": {
    "previewMode": [
      "Navigate to Voice Notes → AI Insights tab",
      "Verify confidence scores visible on insight cards",
      "Verify 'AI would auto-apply' badge on high-confidence skills",
      "Verify 'Requires manual review' on injury insights",
      "Apply 5 insights that have 'would auto-apply' badge",
      "Dismiss 2 insights that have 'would auto-apply' badge",
      "Check DB: insightPreviewModeStats updated (7 insights, 5 applied, 2 dismissed, 71% agreement)"
    ],
    "supervisedAutoApply": [
      "Set trust level to 2",
      "Enable skills auto-apply in settings",
      "Create voice note with skill insight (high confidence)",
      "Wait for AI processing",
      "Verify insight auto-applied without manual action",
      "Verify autoAppliedInsights record created",
      "Verify player profile updated with new skill rating",
      "Verify 'Auto-Applied' badge on insight card",
      "Verify [Undo] button enabled",
      "Click [Undo], select reason 'Wrong rating', confirm",
      "Verify player profile reverted to previous value",
      "Verify insight status back to 'pending'",
      "Wait 61 minutes, verify [Undo] button disabled"
    ],
    "learningLoop": [
      "Enable category preferences: Skills yes, Goals no",
      "Verify skill insights auto-apply, goal insights don't",
      "Undo 0 of 20 auto-applied skill insights (high trust)",
      "Wait 24 hours for threshold adjustment",
      "Verify insightConfidenceThreshold lowered from 0.70 to 0.65",
      "Create 10 more insights, verify more auto-apply due to lower threshold",
      "Undo 3 of 10 (30% undo rate = low trust)",
      "Wait 24 hours for threshold adjustment",
      "Verify insightConfidenceThreshold raised from 0.65 to 0.75"
    ]
  },
  "rolloutStrategy": {
    "week1": "Preview mode only - No auto-apply, collect agreement rates",
    "week2": "Monitor agreement rates - If >40%, proceed to Phase 7.2",
    "week3": "Enable supervised auto-apply for skills only, Level 2+ coaches",
    "week4": "Monitor undo rates - If <5%, expand to attendance category",
    "week5": "Enable learning loop - Adaptive thresholds based on coach behavior",
    "week6": "Enable goals/performance categories for coaches with <2% undo rate"
  },
  "successCriteria": {
    "phase7_1": {
      "agreementRate": ">40% (coaches apply what AI predicted)",
      "understanding": ">80% coaches understand confidence scores",
      "noRegressions": "No impact on existing insight workflow"
    },
    "phase7_2": {
      "autoApplyRate": ">30% of insights auto-applied",
      "undoRate": "<5% of auto-applied insights undone",
      "timeSaved": "5-10 minutes per coach per week"
    },
    "phase7_3": {
      "thresholdAdaptation": "Thresholds personalized for >50% of coaches",
      "categoryAdoption": ">60% coaches enable at least 2 categories",
      "feedbackLoop": "Undo reasons tracked and analyzed monthly"
    }
  }
}

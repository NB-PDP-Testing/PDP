{
  "project": "Coach-Parent AI Summaries - Phase 4 (Enhanced Parent Experience)",
  "branchName": "ralph/coach-parent-summaries-p4",
  "description": "Browser tab notifications, shareable images, and passport deep links. Builds on Phase 1-3 infrastructure.",
  "contextFromPreviousPhases": {
    "existingTables": [
      "coachParentSummaries - AI-generated summaries with sensitivityCategory (normal/injury/behavior), status (pending_review/approved/suppressed/auto_approved/delivered/viewed)",
      "parentSummaryViews - Tracks when parents view summaries (viewSource: dashboard/notification_click/direct_link)",
      "guardianIdentities - Parent records linked to users",
      "guardianPlayerLinks - Parent-to-child relationships (by_guardian, by_player indexes)",
      "coachTrustLevels - Coach automation preferences including parentSummariesEnabled, skipSensitiveInsights"
    ],
    "existingQueries": [
      "getParentUnreadCount(organizationId) - Badge count for parents in coachParentSummaries.ts",
      "getParentSummariesByChildAndSport(organizationId) - Grouped summaries for parent dashboard",
      "markSummaryViewed(summaryId, viewSource) - Records parent view in parentSummaryViews table"
    ],
    "existingComponents": [
      "parent-summary-card.tsx at /apps/web/src/app/orgs/[orgId]/parents/components/",
      "coach-feedback.tsx at /apps/web/src/app/orgs/[orgId]/parents/components/",
      "parent-sidebar.tsx at /apps/web/src/components/layout/ - Already fetches getParentUnreadCount"
    ],
    "keyPatterns": [
      "Use .withIndex() for all queries, never .filter()",
      "All mutations/queries need args and returns validators",
      "Auth check: authComponent.safeGetAuthUser(ctx) pattern",
      "Guardian lookup via guardianIdentities table with by_userId index"
    ]
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Add summaryShares table",
      "description": "As a developer, I need to track when parents share summaries.",
      "acceptanceCriteria": [
        "Add summaryShares table to schema.ts",
        "Fields: summaryId (id coachParentSummaries), guardianIdentityId (id guardianIdentities), sharedAt (number), shareDestination (string literal union)",
        "Add indexes: by_summary, by_guardian",
        "Typecheck passes: npx -w packages/backend convex codegen"
      ],
      "priority": 1,
      "passes": false,
      "notes": "shareDestination: 'download' | 'native_share' | 'copy_link'. Follow existing table patterns in schema.ts"
    },
    {
      "id": "US-002",
      "title": "Implement trackShareEvent mutation",
      "description": "As the system, I need to track share events for analytics.",
      "acceptanceCriteria": [
        "Add trackShareEvent mutation to coachParentSummaries.ts",
        "Args: summaryId (v.id('coachParentSummaries')), shareDestination (v.union of literals)",
        "Get authenticated user via authComponent.safeGetAuthUser(ctx)",
        "Look up guardianIdentity via by_userId index",
        "Verify guardian has access to this summary (summary's playerIdentityId must be linked to guardian via guardianPlayerLinks)",
        "Insert summaryShares record with sharedAt: Date.now()",
        "Returns: v.null()",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Follow existing mutation patterns like markSummaryViewed"
    },
    {
      "id": "US-003",
      "title": "Implement getPassportLinkForSummary query",
      "description": "As a parent, I want to navigate to relevant passport section.",
      "acceptanceCriteria": [
        "Add getPassportLinkForSummary query to coachParentSummaries.ts",
        "Args: summaryId (v.id('coachParentSummaries'))",
        "Fetch summary to get privateInsight.category and playerIdentityId",
        "Map category to passport section: skill_rating→'skills', skill_progress→'goals', injury→'medical', behavior→'overview', default→'overview'",
        "Build URL: /orgs/{orgId}/parents/children/{playerIdentityId}/passport?section={section}",
        "Returns: v.object({ section: v.string(), url: v.string() })",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "The privateInsight.category field contains the insight type. Use sensitivityCategory for injury/behavior routing."
    },
    {
      "id": "US-004",
      "title": "Create useTabNotification hook",
      "description": "As a parent, I want browser tab to show unread count.",
      "acceptanceCriteria": [
        "Create apps/web/src/hooks/use-tab-notification.ts",
        "Accept unreadCount: number parameter",
        "Use useEffect to update document.title",
        "Format: count > 0 ? `(${count}) Messages | PlayerARC` : 'PlayerARC'",
        "Store original title and restore on unmount",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Simple hook - no providers needed for basic functionality"
    },
    {
      "id": "US-005",
      "title": "Create TabNotificationProvider component",
      "description": "As a developer, I need to wrap app with tab notification logic.",
      "acceptanceCriteria": [
        "Create apps/web/src/components/providers/tab-notification-provider.tsx",
        "Use useQuery to fetch getParentUnreadCount for current org (from params)",
        "Check user's functional role - only activate for parent role",
        "Pass count to useTabNotification hook",
        "Render children unchanged",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Check session.activeFunctionalRole === 'parent' or similar. Existing parent-sidebar already queries getParentUnreadCount - follow same pattern."
    },
    {
      "id": "US-006",
      "title": "Add TabNotificationProvider to app layout",
      "description": "As a parent, tab notifications should work across the app.",
      "acceptanceCriteria": [
        "Import TabNotificationProvider in apps/web/src/app/orgs/[orgId]/layout.tsx",
        "Wrap children with TabNotificationProvider",
        "Pass orgId from params",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Provider should be inside ConvexClientProvider but outside page content"
    },
    {
      "id": "US-007",
      "title": "Create MessagePassportLink component",
      "description": "As a parent, I want to click through to passport from a message.",
      "acceptanceCriteria": [
        "Create apps/web/src/components/parent/message-passport-link.tsx",
        "Props: summaryId (Id<'coachParentSummaries'>), playerIdentityId (Id<'playerIdentities'>), className (optional)",
        "Show 'View in Passport →' link with ExternalLink or ArrowRight icon from lucide-react",
        "Use Button component with variant='link' or variant='ghost'",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Component just renders the link - navigation logic in next story"
    },
    {
      "id": "US-008",
      "title": "Wire MessagePassportLink navigation",
      "description": "As a parent, clicking passport link navigates correctly.",
      "acceptanceCriteria": [
        "In MessagePassportLink, use useMutation or useAction to call getPassportLinkForSummary",
        "On click, fetch the link data and use router.push() to navigate",
        "Show loading state during fetch (small spinner or disabled state)",
        "Handle error gracefully (toast or console.error)",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Use useRouter from next/navigation. Can make getPassportLinkForSummary a query and call it directly if simpler."
    },
    {
      "id": "US-009",
      "title": "Add MessagePassportLink to ParentSummaryCard",
      "description": "As a parent, summary cards show passport links.",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/parents/components/parent-summary-card.tsx",
        "Import MessagePassportLink component",
        "Render MessagePassportLink below the summary content",
        "Pass summaryId from summary._id and playerIdentityId from summary.playerIdentityId",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Position link in the card footer area or after the message content"
    },
    {
      "id": "US-010",
      "title": "Install satori and resvg dependencies",
      "description": "As a developer, I need image generation libraries.",
      "acceptanceCriteria": [
        "Run: npm install satori @resvg/resvg-js -w packages/backend",
        "Verify packages appear in packages/backend/package.json",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 10,
      "passes": false,
      "notes": "satori converts React components to SVG, resvg converts SVG to PNG. Both work in Node.js (Convex actions)."
    },
    {
      "id": "US-011",
      "title": "Create generateShareableImage action",
      "description": "As a parent, I want to generate shareable image cards.",
      "acceptanceCriteria": [
        "Add generateShareableImage action to packages/backend/convex/actions/coachParentSummaries.ts",
        "Args: summaryId (v.id('coachParentSummaries'))",
        "Fetch summary data, player name, coach name, org name",
        "Use satori to render React component to SVG (1200x630 dimensions)",
        "Convert SVG to PNG using resvg",
        "Returns PNG buffer or storage URL",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Actions have 'use node' directive. May need to load Inter font for satori. See satori docs for font loading."
    },
    {
      "id": "US-012",
      "title": "Design shareable image template",
      "description": "As a parent, shareable images should be well-branded.",
      "acceptanceCriteria": [
        "Create React component for satori rendering (inline in action or separate file)",
        "Design: gradient background (use org colors if available), PlayerARC logo/text",
        "Quote-styled message content with player name",
        "Attribution: 'From Coach [Name] at [Organization]'",
        "Date/timestamp in subtle text",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Satori supports a subset of CSS - flexbox works, grid doesn't. Keep layout simple."
    },
    {
      "id": "US-013",
      "title": "Store generated image in Convex storage",
      "description": "As the system, generated images should be stored.",
      "acceptanceCriteria": [
        "In generateShareableImage action, upload PNG buffer to Convex storage using ctx.storage.store()",
        "Generate a storage URL using ctx.storage.getUrl()",
        "Return the URL from the action",
        "Consider caching: store imageStorageId on summary record to avoid regenerating",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Convex storage returns a storageId which can be converted to URL. Consider adding imageStorageId field to coachParentSummaries schema."
    },
    {
      "id": "US-014",
      "title": "Create ShareModal component",
      "description": "As a parent, I want a modal to preview and share images.",
      "acceptanceCriteria": [
        "Create apps/web/src/components/parent/share-modal.tsx",
        "Props: summaryId (Id<'coachParentSummaries'>), isOpen (boolean), onClose (() => void)",
        "Use Dialog component from @/components/ui/dialog",
        "Show loading spinner while image generates",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Follow existing modal patterns in the codebase. Use DialogContent, DialogHeader, DialogTitle from shadcn."
    },
    {
      "id": "US-015",
      "title": "Add image preview to ShareModal",
      "description": "As a parent, I want to see the image before sharing.",
      "acceptanceCriteria": [
        "Call generateShareableImage action when modal opens (useAction)",
        "Store image URL in local state",
        "Display generated image in modal body using <img> tag",
        "Handle error state with user-friendly message",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Use useAction hook from convex/react. Show loading skeleton while generating."
    },
    {
      "id": "US-016",
      "title": "Add download button to ShareModal",
      "description": "As a parent, I want to download the image.",
      "acceptanceCriteria": [
        "Add 'Download Image' button with Download icon",
        "On click, trigger file download using <a download> or fetch+blob pattern",
        "Filename: 'playerarc-feedback-{date}.png'",
        "Call trackShareEvent mutation with destination: 'download'",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Use anchor element with download attribute and href pointing to image URL"
    },
    {
      "id": "US-017",
      "title": "Add native share to ShareModal",
      "description": "As a parent, I want to use native share if available.",
      "acceptanceCriteria": [
        "Check navigator.share availability (typeof navigator.share === 'function')",
        "If available, show 'Share' button with Share2 icon",
        "On click, use Web Share API: navigator.share({ files: [imageBlob] })",
        "Call trackShareEvent with destination: 'native_share'",
        "Fallback: hide button if share not available, or show copy link option",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": "Web Share API requires HTTPS. File sharing may require converting URL to Blob first."
    },
    {
      "id": "US-018",
      "title": "Add share button to ParentSummaryCard",
      "description": "As a parent, I want to share from summary cards.",
      "acceptanceCriteria": [
        "Edit parent-summary-card.tsx",
        "Add Share button/icon (Share2 from lucide-react) in card actions area",
        "Add local state: isShareModalOpen",
        "Open ShareModal on click",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": "Position share button alongside other card actions. Use Button with variant='ghost' and size='icon'."
    },
    {
      "id": "US-019",
      "title": "Add sport icon to CoachFeedback grouping",
      "description": "As a parent, sport sections should have visual icons.",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/parents/components/coach-feedback.tsx",
        "Import sport icons or create sportCodeToIcon mapping",
        "Render sport icon next to sport name in section headers",
        "Use appropriate icons: soccer→Football, basketball→Basketball, etc.",
        "Fallback to generic Activity icon for unknown sports",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": "Check existing sport icon patterns in codebase. May already have SportIcon component."
    },
    {
      "id": "US-020",
      "title": "Add unread badge to sport headers",
      "description": "As a parent, I want to see unread count per sport.",
      "acceptanceCriteria": [
        "In coach-feedback.tsx, calculate unread count per sport section",
        "Show Badge component next to sport header with unread count",
        "Only show badge if count > 0",
        "Style consistently with navigation badges (use Badge variant='secondary' or 'destructive' for attention)",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": "The query getParentSummariesByChildAndSport already groups by sport. Check if unreadCount is included in response or needs calculation."
    }
  ]
}

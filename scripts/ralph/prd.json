{
  "project": "Phase 9 Week 2 - Activity Feed, @Mentions, Notifications + AI Copilot UI",
  "branchName": "ralph/team-collaboration-hub-p9",
  "description": "Week 2 of Team Collaboration Hub: Real-time activity feed, @mention autocomplete, priority notifications, AI Copilot smart suggestions.",
  "referencePRD": "scripts/ralph/prds/Coaches Voice Insights/P9_WEEK2_ACTIVITY_FEED.md",
  "previousWeeks": [
    "Week 1: Collaboration Foundations (8 stories) - COMPLETE ‚úÖ"
  ],
  "nextWeeks": [
    "Week 3: Multi-View, Templates, Voting + Mobile Gestures (15 stories)",
    "Week 4: Personalization & Polish (7 stories)"
  ],
  "totalPhase9Scope": "48 stories across 4 weeks (~72 hours)",
  "week2Effort": "~28 hours (14 stories)",
  "criticalPatterns": [
    "MANDATORY: Use Better Auth adapter pattern: ctx.runQuery(components.betterAuth.adapter.findOne, { model: \"user\", where: [{ field: \"_id\", value: userId, operator: \"eq\" }] })",
    "MANDATORY: Use withIndex(), NEVER use filter()",
    "MANDATORY: Always include args and returns validators",
    "MANDATORY: Use skeleton loaders (ListSkeleton uses 'items' prop, not 'rows')",
    "MANDATORY: Visual verification with dev-browser for all UI changes",
    "Priority keywords: urgent/injury ‚Üí critical, important/concern ‚Üí important, else ‚Üí normal",
    "date-fns for timestamps: formatDistanceToNow(timestamp, { addSuffix: true })"
  ],
  "userStories": [
    {
      "id": "US-P9-009",
      "title": "Implement Activity Feed Backend",
      "description": "Backend query for team activity feed with priority filtering.",
      "acceptanceCriteria": [
        "Modify packages/backend/convex/models/teamCollaboration.ts",
        "Implement getTeamActivityFeed query",
        "Args: teamId, organizationId, filterType (optional: all/insights/comments/reactions/sessions/votes), limit (default 50, max 100)",
        "Returns: Activity entries sorted by _creationTime desc",
        "Use compound index by_team_priority for efficient filtering",
        "CRITICAL: Use Better Auth adapter for user lookups (actor names)",
        "Type check passes"
      ],
      "priority": 1,
      "passes": true
    },
    {
      "id": "US-P9-010",
      "title": "Create ActivityFeedView Component",
      "description": "UI component displaying real-time activity feed.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/coach/team-hub/components/activity-feed-view.tsx",
        "Chronological display (newest first)",
        "Each entry shows: actor avatar, action summary, timestamp (relative), priority icon",
        "Color-coded: Critical (red), Important (yellow), Normal (gray)",
        "Use ListSkeleton while loading (items={5})",
        "Empty state: No recent activity",
        "Real-time updates via useQuery",
        "Type check passes",
        "Visual verification with dev-browser"
      ],
      "priority": 2,
      "passes": true
    },
    {
      "id": "US-P9-011",
      "title": "Add Activity Feed Filters",
      "description": "Filter tabs for activity feed with URL persistence.",
      "acceptanceCriteria": [
        "Modify activity-feed-view.tsx",
        "Add Tabs component from shadcn/ui",
        "Tabs: All, Insights, Comments, Reactions, Sessions, Votes",
        "Each tab shows count badge",
        "URL persistence via useSearchParams (?filter=insights)",
        "Filter updates query to getTeamActivityFeed",
        "Type check passes"
      ],
      "priority": 3,
      "passes": false
    },
    {
      "id": "US-P9-012",
      "title": "Add @Mention Autocomplete",
      "description": "Autocomplete dropdown for @mentions in comments.",
      "acceptanceCriteria": [
        "Modify apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/comment-form.tsx",
        "Detect @ typing in textarea",
        "Show dropdown with coach list (name, avatar, role)",
        "Keyboard navigation (ArrowUp, ArrowDown, Enter, Escape)",
        "Insert @mention on select (format: @CoachName)",
        "Close dropdown on selection or Escape",
        "Query coaches from Better Auth member table",
        "Type check passes",
        "Visual verification - dropdown appears, navigation works"
      ],
      "priority": 4,
      "passes": false
    },
    {
      "id": "US-P9-013",
      "title": "Smart Mention Autocomplete",
      "description": "Contextual coach suggestions for @mentions.",
      "acceptanceCriteria": [
        "Modify comment-form.tsx mention logic",
        "Contextual ranking based on insight category",
        "If injury ‚Üí show coaches with medical/first-aid role first",
        "If player mentioned ‚Üí show coaches who recently observed that player first",
        "If team observation ‚Üí show all team coaches",
        "Sort by: context match > recent activity > alphabetical",
        "Type check passes"
      ],
      "priority": 5,
      "passes": false
    },
    {
      "id": "US-P9-014",
      "title": "Extend coachOrgPreferences (Notifications)",
      "description": "Add notification preference fields to schema.",
      "acceptanceCriteria": [
        "Modify packages/backend/convex/schema.ts",
        "Extend coachOrgPreferences table (already exists)",
        "Add notificationChannels field: { critical: string[], important: string[], normal: string[] } (values: push, email, digest, none)",
        "Add digestSchedule field: { enabled: boolean, time: string } (e.g., '08:00')",
        "Add quietHours field: { enabled: boolean, start: string, end: string } (e.g., '22:00' to '08:00')",
        "Default: All levels ‚Üí [push, email], digest off, quiet hours off",
        "Run Convex schema push",
        "Type check passes"
      ],
      "priority": 6,
      "passes": false
    },
    {
      "id": "US-P9-015",
      "title": "Create NotificationCenter Component",
      "description": "Bell icon notification center with priority grouping.",
      "acceptanceCriteria": [
        "Create apps/web/src/components/coach/notification-center.tsx",
        "Bell icon (lucide-react Bell) in header",
        "Badge shows unread count",
        "Dropdown shows notifications grouped by priority (Critical, Important, Normal)",
        "Each notification: icon, title, timestamp, unread indicator",
        "Click notification navigates to target (insight, comment, etc.)",
        "Mark as read on click",
        "Real-time updates via useQuery",
        "Use ListSkeleton while loading",
        "Type check passes",
        "Visual verification - bell shows badge, dropdown works, navigation works"
      ],
      "priority": 7,
      "passes": false
    },
    {
      "id": "US-P9-016",
      "title": "Add Notification Preferences UI",
      "description": "Settings section for notification preferences.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/coach/settings/notification-preferences.tsx",
        "Matrix UI: 3 priority levels (rows) √ó 4 channels (columns: Push, Email, Digest, None)",
        "Each cell is a checkbox (multiple channels can be selected)",
        "Digest time picker (24h format, default 08:00)",
        "Quiet hours toggle + start/end time pickers",
        "Save button calls mutation to update coachOrgPreferences",
        "Loading state while saving",
        "Success toast on save",
        "Type check passes",
        "Visual verification - preferences save and persist"
      ],
      "priority": 8,
      "passes": false
    },
    {
      "id": "US-P9-017",
      "title": "Create InsightReactions Component",
      "description": "UI for like/helpful/flag reactions (backend exists from Week 1).",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insight-reactions.tsx",
        "3 buttons: üëç Like, üåü Helpful, üö© Flag",
        "Show count for each reaction type",
        "Active state if current user reacted (filled icon)",
        "Tooltip shows list of users who reacted",
        "Click calls toggleReaction mutation from teamCollaboration",
        "Optimistic updates (instant UI response)",
        "Type check passes",
        "Visual verification - reactions toggle, counts update, tooltip shows users"
      ],
      "priority": 9,
      "passes": false
    },
    {
      "id": "US-P9-018",
      "title": "addComment Creates Activity Entries",
      "description": "Modify addComment to create teamActivityFeed entries.",
      "acceptanceCriteria": [
        "Modify packages/backend/convex/models/teamCollaboration.ts addComment mutation",
        "After inserting comment, insert teamActivityFeed entry",
        "Activity entry fields: teamId, actorId, actionType (comment), targetType (insight), targetId (insightId), summary, priority (inherit from comment)",
        "Summary format: '[Actor Name] commented on [Player Name]'s [Category] insight'",
        "Use Better Auth adapter to get player name",
        "Type check passes",
        "Test in Convex dashboard - adding comment creates activity entry"
      ],
      "priority": 10,
      "passes": false
    },
    {
      "id": "US-P9-041",
      "title": "Create AI Copilot Backend Model",
      "description": "Create foundation for AI-powered smart suggestions.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/models/aiCopilot.ts",
        "Export getSmartSuggestions query",
        "Args: context (viewing_insight/creating_session/viewing_activity/viewing_player_passport), contextId, userId, organizationId",
        "Returns: Array of suggestions with type, title, description, action, confidence (0-1)",
        "Placeholder implementation (return empty array)",
        "Proper validators (args + returns)",
        "Type check passes",
        "Run npx -w packages/backend convex codegen"
      ],
      "priority": 11,
      "passes": false
    },
    {
      "id": "US-P9-042",
      "title": "Implement Insight Context Suggestions",
      "description": "Generate smart suggestions when viewing insights.",
      "acceptanceCriteria": [
        "Modify packages/backend/convex/models/aiCopilot.ts",
        "Implement generateInsightSuggestions function",
        "5 suggestion types: apply_insight, mention_coach, add_to_session, create_task, link_observation",
        "Logic: If injury category ‚Üí suggest medical staff mention (0.9 confidence)",
        "Logic: If skill category ‚Üí suggest add to next session plan (0.8 confidence)",
        "Logic: If unread by teammates ‚Üí suggest @mention relevant coaches (0.7 confidence)",
        "Return top 4 suggestions sorted by confidence desc",
        "Use Better Auth adapter for coach lookups",
        "Type check passes",
        "Test in Convex dashboard - returns relevant suggestions"
      ],
      "priority": 12,
      "passes": false
    },
    {
      "id": "US-P9-043",
      "title": "Implement Session Planning Suggestions",
      "description": "Generate suggestions when creating session plans.",
      "acceptanceCriteria": [
        "Modify packages/backend/convex/models/aiCopilot.ts",
        "Implement generateSessionSuggestions function",
        "Auto-suggest based on recent insights",
        "If recent injuries ‚Üí suggest injury status checks (0.9 confidence)",
        "If skill gaps identified ‚Üí suggest focused drills (0.8 confidence)",
        "If equipment mentioned ‚Üí suggest equipment list (0.7 confidence)",
        "Return top 3 suggestions sorted by confidence",
        "Type check passes"
      ],
      "priority": 13,
      "passes": false
    },
    {
      "id": "US-P9-044",
      "title": "Create SmartActionBar Component",
      "description": "UI component displaying AI Copilot suggestions.",
      "acceptanceCriteria": [
        "Create apps/web/src/components/coach/smart-action-bar.tsx",
        "Props: context, contextId",
        "Calls getSmartSuggestions query",
        "Displays suggestions as action buttons with icons",
        "Each button shows: icon, title, confidence indicator",
        "Tooltip shows description and reasoning",
        "Click executes action (apply insight, @mention, etc.)",
        "Loading state while fetching suggestions",
        "Skeleton loader with 3 button placeholders",
        "Mobile responsive (stack vertically on small screens)",
        "Type check passes",
        "Visual verification - suggestions appear, actions execute, tooltips work"
      ],
      "priority": 14,
      "passes": false
    }
  ]
}

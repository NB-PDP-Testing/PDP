# UAT Test: US-VN-020 - WhatsApp Command Parser & Handler

> Auto-generated: 2026-02-07 19:08
> Status: ⏳ Pending Execution

## Story
Implement WhatsApp command parser and handler for confirmation workflow. Coaches can reply CONFIRM, CONFIRM 1,2,3, CANCEL, or TWINS = Emma & Niamh to manage their pending drafts directly from WhatsApp.

## Acceptance Criteria Checklist

- [ ] --- COMMAND PARSER ---
- [ ] Backend: Create lib/whatsappCommands.ts
- [ ] Function: parseCommand(text: string): Command | null
- [ ] Supported commands (case-insensitive):
- [ ] - 'CONFIRM' or 'YES' → confirm all pending drafts
- [ ] - 'CONFIRM 1,2,3' or 'YES 1,2,3' → confirm specific draft numbers
- [ ] - 'CANCEL' or 'NO' → reject all pending drafts
- [ ] - 'TWINS = Emma & Niamh' → custom entity mapping for group references
- [ ] - 'TWINS = Emma and Niamh U12' → with team context
- [ ] Return type: { type: 'confirm_all' | 'confirm_specific' | 'cancel' | 'entity_mapping', draftNumbers?: number[], entityMapping?: { rawText: string, playerNames: string[], teamContext?: string } } | null
- [ ] Returns null if text is not a recognized command (normal voice/text processing continues)
- [ ] --- COMMAND HANDLER (ADR-VN2-031) ---
- [ ] Backend: Create lib/whatsappCommandHandler.ts
- [ ] Function: handleCommand (async helper function — NOT a Convex action, because Convex cannot ctx.runAction from within an action. Called directly from processIncomingMessage which is already an internalAction with ctx.runQuery/ctx.runMutation access)
- [ ] Params: ctx (ActionCtx), coachUserId: string, organizationId: string, command: Command
- [ ] Returns: string (response message to send back via WhatsApp)
- [ ] Logic:
- [ ] 1. Get pending drafts for coach in this org
- [ ] 2. If command.type === 'confirm_all':
- [ ] - Confirm all pending drafts
- [ ] - Schedule applyDraft for each confirmed draft
- [ ] - Return: 'Saved {count} updates. Updated players: {names}'
- [ ] 3. If command.type === 'confirm_specific':
- [ ] - Confirm only the numbered drafts (1-indexed from the summary message)
- [ ] - Return: 'Saved {count} of {total} updates.'
- [ ] 4. If command.type === 'cancel':
- [ ] - Reject all pending drafts
- [ ] - Return: 'Cancelled all pending updates.'
- [ ] 5. If command.type === 'entity_mapping':
- [ ] - Resolve group reference using provided names + fuzzy matching
- [ ] - Update entity resolutions with resolved entities
- [ ] - Return: '{rawText} resolved to {names}. Reply CONFIRM to save.'
- [ ] --- INTEGRATION ---
- [ ] Integration: Add to processIncomingMessage in whatsapp.ts
- [ ] - After receiving a text message (not audio), check if it's a command:
- [ ] const command = parseCommand(messageText);
- [ ] if (command) { handleCommand(...); sendWhatsAppResponse(...); return; }
- [ ] - If not a command, continue normal v1/v2 processing
- [ ] --- UNIT TESTS ---
- [ ] Create __tests__/whatsappCommands.test.ts
- [ ] Test cases:
- [ ] - 'CONFIRM' → { type: 'confirm_all' }
- [ ] - 'confirm' → { type: 'confirm_all' } (case insensitive)
- [ ] - 'YES' → { type: 'confirm_all' }
- [ ] - 'CONFIRM 1,2,3' → { type: 'confirm_specific', draftNumbers: [1,2,3] }
- [ ] - 'CANCEL' → { type: 'cancel' }
- [ ] - 'NO' → { type: 'cancel' }
- [ ] - 'TWINS = Emma & Niamh' → { type: 'entity_mapping', entityMapping: { rawText: 'TWINS', playerNames: ['Emma', 'Niamh'] } }
- [ ] - 'Spent time on skills today' → null (not a command, normal processing)
- [ ] - '' → null (empty string)
- [ ] --- VERIFICATION ---
- [ ] Type check passes: npm run check-types
- [ ] Build passes: npm run build
- [ ] Manual test: Send voice note → receive draft summary → reply CONFIRM → drafts applied
- [ ] Manual test: Reply CANCEL → drafts rejected
- [ ] Manual test: Reply 'TWINS = Emma and Niamh' → group reference resolved

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VN-020"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

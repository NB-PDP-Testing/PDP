{
  "project": "PlayerARC - Phase 0: Onboarding Sync",
  "branchName": "ralph/phase-0-onboarding-sync",
  "description": "Enhance the onboarding orchestrator to collect phone, postcode, and alternate email during self-registration, enabling multi-signal matching with imported guardian records. This ensures self-registered parents can be matched to their children even when using different email addresses than what the club has on file.",
  "prdFile": "scripts/ralph/prds/Importing Members/phase-0-onboarding-sync.md",
  "contextFiles": [
    "packages/backend/convex/models/onboarding.ts",
    "packages/backend/convex/models/guardianIdentities.ts",
    "packages/backend/convex/models/playerImport.ts",
    "packages/backend/convex/schema.ts",
    "apps/web/src/components/sign-up-form.tsx",
    "CLAUDE.md"
  ],
  "mandatoryPatterns": [
    "Use Convex function syntax with args and returns validators",
    "Use .withIndex() never .filter() for queries",
    "Batch fetch with Map lookup pattern to avoid N+1 queries",
    "Use shadcn/ui components for all UI",
    "Preserve existing guardian matching algorithm weights",
    "Run npx ultracite fix before completing any story"
  ],
  "successCriteria": [
    "Self-registered users can match imported guardians via phone (30 pts)",
    "Self-registered users can match imported guardians via postcode (20 pts)",
    "Self-registered users can match via alternate email (50 pts)",
    "Profile completion step appears before guardian claiming in onboarding",
    "Skip functionality works with 3-skip limit",
    "No regression in existing email-based matching"
  ],
  "userStories": [
    {
      "id": "US-P0-001",
      "title": "Add profile fields to user table schema",
      "description": "As a developer, I need to store additional profile fields on the user table to enable multi-signal matching.",
      "acceptanceCriteria": [
        "Add optional fields to user table in schema.ts: phone, altEmail, postcode, address, town, country",
        "Add profileCompletionStatus field: 'pending' | 'completed' | 'skipped'",
        "Add profileCompletedAt (optional number) and profileSkipCount (optional number) fields",
        "Add indexes: by_phone, by_altEmail, by_postcode",
        "Run npx -w packages/backend convex codegen successfully",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Foundation - must be done first. All other stories depend on this."
    },
    {
      "id": "US-P0-002",
      "title": "Create unified guardian matching module",
      "description": "As a developer, I need a shared matching module so both import and onboarding use identical scoring logic.",
      "acceptanceCriteria": [
        "Create /packages/backend/convex/lib/matching/guardianMatcher.ts",
        "Export MATCHING_WEIGHTS constant: EMAIL_EXACT=50, SURNAME_POSTCODE=45, PHONE=30, SURNAME_TOWN=35, POSTCODE_ONLY=20, TOWN_ONLY=10, HOUSE_NUMBER=5",
        "Export CONFIDENCE_THRESHOLDS: HIGH=60, MEDIUM=40, LOW=20",
        "Implement normalizePhone() function that handles Irish (+353) and UK (+44) formats",
        "Implement normalizePostcode() function that removes whitespace and uppercases",
        "Implement findGuardianMatches() query function with multi-signal scoring",
        "Implement calculateMatchScore() helper function",
        "Implement getConfidenceLevel() helper function returning 'high' | 'medium' | 'low'",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Core matching logic. Extract patterns from existing playerImport.ts lines 17-249."
    },
    {
      "id": "US-P0-003",
      "title": "Create user profile mutations",
      "description": "As a user, I need backend mutations to save my profile completion data so it persists and can be used for matching.",
      "acceptanceCriteria": [
        "Create /packages/backend/convex/models/userProfiles.ts",
        "Implement updateProfile mutation with args: phone?, altEmail?, postcode?, address?, town?, country?",
        "updateProfile normalizes phone and postcode before saving",
        "updateProfile sets profileCompletionStatus to 'completed' and profileCompletedAt to Date.now()",
        "Implement skipProfileCompletion mutation that increments profileSkipCount",
        "skipProfileCompletion returns { skipCount, canSkipAgain } where canSkipAgain is false after 3 skips",
        "Implement getProfileStatus query returning status, phone, altEmail, postcode, skipCount, canSkip",
        "All mutations require authentication (check ctx.auth.getUserIdentity())",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Backend API for frontend to save profile data."
    },
    {
      "id": "US-P0-004",
      "title": "Add profile completion onboarding task",
      "description": "As a user, I need the profile completion step to appear in my onboarding flow before the guardian claiming step.",
      "acceptanceCriteria": [
        "Modify /packages/backend/convex/models/onboarding.ts getOnboardingTasks query",
        "Add 'profile_completion' task type to the task types",
        "Insert profile_completion task at priority 1.5 (after accept_invitations, before guardian_claiming)",
        "Task only appears if profileCompletionStatus is 'pending' or undefined",
        "Task data includes: currentPhone, currentPostcode, skipCount, canSkip, reason",
        "canSkip is false if profileSkipCount >= 3",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Integrates profile completion into existing onboarding flow."
    },
    {
      "id": "US-P0-005",
      "title": "Enhance checkForClaimableIdentity with multi-signal matching",
      "description": "As a user, I need the claiming check to use all my profile data so I can find my children even with different emails.",
      "acceptanceCriteria": [
        "Modify checkForClaimableIdentity query in guardianIdentities.ts",
        "Add optional args: phone?, altEmail?, postcode?",
        "Import and use findGuardianMatches from guardianMatcher.ts",
        "Return matches with confidence scores and match reasons",
        "Filter to only unclaimed guardians (no userId) with linked children",
        "Sort matches by score descending",
        "Maintain backward compatibility - email-only matching still works",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Critical integration point. Must preserve existing email-matching behavior."
    },
    {
      "id": "US-P0-006",
      "title": "Create ProfileCompletionStep frontend component",
      "description": "As a user, I need a clear UI to enter my phone, postcode, and alternate email so the system can find my children.",
      "acceptanceCriteria": [
        "Create /apps/web/src/components/onboarding/ProfileCompletionStep.tsx",
        "Use shadcn/ui Card, Input, Label, Button components",
        "Include phone input with placeholder '+353 87 123 4567'",
        "Include postcode input with auto-uppercase",
        "Include optional alternate email input",
        "Include info box explaining why we ask for this data",
        "Show 'Skip for Now' button if canSkip is true with remaining skips count",
        "Show 'Save & Continue' button that calls updateProfile mutation",
        "Handle loading state with Loader2 spinner",
        "Show toast on success/error using sonner",
        "Call onComplete callback after successful save",
        "Call onSkip callback after skip",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Primary UI component. Follow existing onboarding step patterns."
    },
    {
      "id": "US-P0-007",
      "title": "Create NoChildrenFoundStep fallback component",
      "description": "As a user who couldn't be matched, I need helpful guidance on what to do next.",
      "acceptanceCriteria": [
        "Create /apps/web/src/components/onboarding/NoChildrenFoundStep.tsx",
        "Display what signals were searched (email, phone if provided, postcode if provided)",
        "List possible reasons: club hasn't imported, different contact details, new to club",
        "Provide 'Try Different Details' button that expands a retry form",
        "Retry form has inputs for altEmail, phone, postcode",
        "Provide 'Contact Club' button (can be placeholder action for now)",
        "Provide 'Continue Without Linking' button",
        "Use shadcn/ui components consistently",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Fallback UX when no matches found. Important for user confidence."
    },
    {
      "id": "US-P0-008",
      "title": "Integrate profile completion into onboarding wizard",
      "description": "As a user, I need the profile completion step to appear in the correct order in my onboarding experience.",
      "acceptanceCriteria": [
        "Locate existing onboarding wizard/modal component",
        "Import ProfileCompletionStep and NoChildrenFoundStep components",
        "Add case for 'profile_completion' task type that renders ProfileCompletionStep",
        "After profile completion, re-run checkForClaimableIdentity with new data",
        "If matches found after profile completion, proceed to guardian claiming",
        "If no matches found, show NoChildrenFoundStep",
        "Handle onComplete to advance to next task",
        "Handle onSkip to mark task as skipped and advance",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Final integration. Wire everything together."
    },
    {
      "id": "US-P0-009",
      "title": "Update sign-up flow to trigger profile completion",
      "description": "As a new user, I need the onboarding flow to include profile completion when I first sign up.",
      "acceptanceCriteria": [
        "Review sign-up-form.tsx post-signup flow",
        "Ensure onboarding tasks are checked after signup",
        "Profile completion task should appear for new users",
        "Existing claiming logic still works but now uses enhanced matching",
        "No changes to OAuth flows (Google, Microsoft) - profile completion appears in onboarding",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Entry point integration. Should work with existing redirect logic."
    },
    {
      "id": "US-P0-010",
      "title": "End-to-end testing and verification",
      "description": "As a developer, I need to verify the complete flow works correctly across all scenarios.",
      "acceptanceCriteria": [
        "Test scenario 1: User signs up with same email as import -> immediate match (no profile completion needed)",
        "Test scenario 2: User signs up with different email, provides matching phone -> finds children",
        "Test scenario 3: User signs up with different email, provides matching postcode + surname -> finds children",
        "Test scenario 4: User skips profile completion -> proceeds with email-only matching",
        "Test scenario 5: User skips 3 times -> cannot skip again",
        "Test scenario 6: No signals match -> NoChildrenFoundStep appears",
        "All linting passes: npx ultracite fix",
        "All type checks pass: npm run check-types",
        "Manual browser verification of happy path"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Final verification before marking phase complete."
    }
  ]
}

name: CI (Optimized)

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    # Skip CI for documentation-only changes
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/**'
      - '.vscode/**'

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Step 1: Install dependencies once and cache
  setup:
    name: Setup & Cache Dependencies
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Cache node_modules
        id: cache-node-modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: Install dependencies
        if: steps.cache-node-modules.outputs.cache-hit != 'true'
        run: npm ci

  # Step 2: Run all quality checks in parallel
  quality-checks:
    name: Quality Checks
    needs: setup
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false  # Continue other checks even if one fails
      matrix:
        check: [typecheck, lint, security]

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # For lint --changed

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}

      # TypeScript type checking
      - name: Run TypeScript type check
        if: matrix.check == 'typecheck'
        run: npm run check-types

      # Linting (changed files only)
      - name: Run linting on changed files
        if: matrix.check == 'lint'
        run: |
          echo "Checking linting on changed files..."

          # Get list of changed TypeScript/JavaScript files
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT origin/main...HEAD | grep -E '\.(ts|tsx|js|jsx)$' || true)
          else
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACMRT HEAD~1 | grep -E '\.(ts|tsx|js|jsx)$' || true)
          fi

          if [ -z "$CHANGED_FILES" ]; then
            echo "✅ No TypeScript/JavaScript files changed - skipping lint"
            exit 0
          fi

          echo "Files to lint:"
          echo "$CHANGED_FILES"
          echo ""

          # Run biome check
          echo "$CHANGED_FILES" | xargs npx biome check --diagnostic-level=error

          if [ $? -ne 0 ]; then
            echo ""
            echo "❌ LINTING FAILED!"
            exit 1
          fi

          echo "✅ Linting passed!"

      # Security audit (non-blocking, main branch only)
      - name: Run security audit
        if: matrix.check == 'security' && github.ref == 'refs/heads/main'
        run: |
          npm audit --audit-level=moderate || true
          npx audit-ci --moderate || true
        continue-on-error: true

  # Step 3: Build and analyze (runs once)
  build-and-analyze:
    name: Build & Bundle Analysis
    needs: setup
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Restore node_modules cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            apps/*/node_modules
            packages/*/node_modules
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/package-lock.json') }}

      # Build once (used for both build check and bundle analysis)
      - name: Build for production
        run: npm run build
        env:
          CONVEX_DEPLOY_KEY: ${{ secrets.CONVEX_DEPLOY_KEY || 'dummy-key-for-ci' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY || 'dummy-key-for-ci' }}
          NEXT_PUBLIC_CONVEX_URL: 'https://dummy-url-for-ci.convex.cloud'
          BETTER_AUTH_SECRET: 'dummy-secret-for-ci'
          BETTER_AUTH_URL: 'http://localhost:3000'

      # Analyze bundle (reuses build from previous step)
      - name: Analyze bundle size
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const buildManifest = path.join(process.cwd(), 'apps/web/.next/build-manifest.json');

            if (fs.existsSync(buildManifest)) {
              const size = fs.statSync(buildManifest).size;
              console.log(`✅ Build manifest size: ${(size / 1024).toFixed(2)} KB`);
            } else {
              console.log('⚠️ Build manifest not found');
            }

      # Validate Convex schema
      - name: Validate Convex schema
        working-directory: packages/backend
        run: npx convex dev --once --configure=skip || echo "⚠️ Convex validation completed with warnings"
        continue-on-error: true

  # Summary job - all checks must pass
  ci-success:
    name: CI Success
    needs: [setup, quality-checks, build-and-analyze]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Check all jobs succeeded
        run: |
          if [ "${{ needs.setup.result }}" != "success" ] || \
             [ "${{ needs.quality-checks.result }}" != "success" ] || \
             [ "${{ needs.build-and-analyze.result }}" != "success" ]; then
            echo "❌ One or more CI checks failed"
            exit 1
          fi
          echo "✅ All CI checks passed!"

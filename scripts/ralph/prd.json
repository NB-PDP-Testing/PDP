{
  "project": "Phase 9 Week 4 Phase 3 - Tab Views (Players + Planning)",
  "branchName": "ralph/p9-week4-team-hub",
  "description": "Week 4 Phase 3: Build Players Tab with health badges and Planning Tab with session list + season milestones.",
  "referencePRD": "scripts/ralph/P9_WEEK4_REVISED_PLAN.md",
  "previousWeeks": [
    "Week 1: Collaboration Foundations (8 stories) - COMPLETE âœ…",
    "Week 2: Activity Feed & AI Copilot (14 stories) - COMPLETE âœ…",
    "Week 3: Multi-View, Voting, Command Palette & Gestures (17 stories) - COMPLETE âœ…",
    "Week 4 Phase 1: Foundation (3 stories, 4 hours) - COMPLETE âœ…",
    "Week 4 Phase 2: Core Widgets (2 stories, 7 hours) - COMPLETE âœ…"
  ],
  "currentPhase": "Week 4 Phase 3 - Tab Views (2 stories, 6 hours)",
  "nextPhases": [
    "Phase 4: Collaboration (Tasks + Insights) - 9h",
    "Phase 5: Already Complete (Quick Actions) - 0h"
  ],
  "totalPhase9Scope": "50 stories across 4 weeks (~125 hours)",
  "week4Effort": "~26 hours (11 stories + 1 schema) - 30% reduction via code reuse",
  "completedStories": [
    "US-P9-063: Tab Navigation âœ…",
    "US-P9-SCHEMA: Optional schema change âœ…",
    "US-P9-056: Activity Feed Pagination âœ…",
    "US-P9-055: Health & Safety Widget âœ…",
    "US-P9-052: Overview Dashboard âœ…"
  ],
  "criticalLessonsLearned": [
    "ðŸ”´ CRITICAL: Better Auth IDs are plain strings, NOT Convex IDs",
    "- Use v.string() for Better Auth table IDs (team, user, organization, member)",
    "- NEVER use v.id('team') for Better Auth team IDs - causes validator mismatch",
    "- Schema uses v.string(), validators MUST match schema",
    "- Example bug fixed: teamCollaboration.ts had v.id('team'), changed to v.string()",
    "",
    "ðŸ”´ CRITICAL: Pattern B (getCoachAssignmentsWithTeams) is the standard",
    "- Pattern B: Single query with server-side join (getCoachAssignmentsWithTeams)",
    "- Pattern A: Dual queries with client-side join (DEPRECATED, causes N+1)",
    "- Migration complete: team-insights migrated to Pattern B (commit 49d489f4)",
    "- Defensive filtering added: Skip corrupted team IDs (e.g., player IDs in teams array)",
    "",
    "ðŸŸ¡ IMPORTANT: Team Hub UX improvements",
    "- Auto-select first team when multiple teams available (useEffect pattern)",
    "- Hide team selector dropdown when coach has only one team",
    "- Show simplified team header for single-team coaches",
    "- Use !(a && b) instead of !a || !b (Biome lint rule)",
    "",
    "ðŸŸ¡ IMPORTANT: Data migration patterns",
    "- Coach assignments had team NAMES instead of IDs (admin UI bug)",
    "- Migration function: migrateCoachAssignmentsToTeamIds (already exists)",
    "- Admin UI fixed in commit 0b48f2dd (saves IDs directly now)",
    "- Audit tool has flawed logic (reports valid IDs as corruption)",
    "",
    "ðŸŸ¢ GENERAL: Convex error messages can be misleading",
    "- Error claimed ID was from 'players' table - was actually validator mismatch",
    "- Always verify with direct database queries (npx convex run)",
    "- Use git commit workflow: status â†’ diff â†’ log â†’ stage â†’ commit with heredoc"
  ],
  "criticalPatterns": [
    "MANDATORY: Better Auth IDs use v.string() not v.id() in validators",
    "MANDATORY: Use Pattern B (getCoachAssignmentsWithTeams) for coach team queries",
    "MANDATORY: Use Better Auth adapter pattern with _id field (not userId): ctx.runQuery(components.betterAuth.adapter.findOne, { model: 'user', where: [{ field: '_id', value: userId, operator: 'eq' }] })",
    "MANDATORY: Use withIndex(), NEVER use filter() except after withIndex",
    "MANDATORY: Always include args and returns validators on ALL queries/mutations",
    "MANDATORY: Batch fetch to avoid N+1 queries - use Map lookup pattern",
    "MANDATORY: Mobile-first design - all UI must work perfectly on mobile before desktop",
    "MANDATORY: Touch targets â‰¥44px for mobile accessibility",
    "MANDATORY: Visual verification with dev-browser for all UI changes",
    "MANDATORY: Skeleton loaders (not spinners) for loading states",
    "MANDATORY: Empty states with icon + title + description + CTA",
    "REUSE EXISTING CODE: /team-hub components are production-ready, enhance don't rebuild",
    "Performance: Paginate at 50 items, lazy load images, batch fetch with Map",
    "Real-time: useQuery hook (Convex subscriptions automatic)",
    "Toast notifications: import { toast } from 'sonner'",
    "Date formatting: formatDistanceToNow(timestamp, { addSuffix: true })"
  ],
  "userStories": [
    {
      "id": "US-P9-053",
      "phase": 3,
      "title": "Players Tab with Health Badges",
      "description": "Display team roster in grid layout with health status badges. Mobile-first card layout, desktop grid.",
      "acceptanceCriteria": [
        "Backend: Create getTeamPlayersWithHealth query in packages/backend/convex/models/teams.ts",
        "Query returns array of: playerId, fullName, jerseyNumber, position, healthStatus (healthy/recovering/injured), isPlayingUp, photoUrl",
        "Health status calculation: ðŸ”´ Injured = active injury with severe OR recent (<7 days), ðŸŸ¡ Recovering = status 'recovering', ðŸŸ¢ Healthy = no active/recovering injuries",
        "Use batch fetch pattern with Map lookup for injuries (avoid N+1)",
        "Frontend: Replace placeholder players-tab.tsx with full implementation",
        "Player grid layout: Mobile 1 col, Tablet 2 cols, Desktop 3-4 cols",
        "Player card shows: Photo (fallback initials), Full name, Jersey #, Position, Health badge",
        "Playing up/down badge if applicable (e.g., 'Playing Up')",
        "Filter controls: All / Active / Injured / On Break",
        "Position filter (dropdown)",
        "Search by name (real-time)",
        "Sort options: Name (A-Z), Jersey #, Position",
        "Click player card â†’ navigate to Player Passport",
        "Touch-friendly cards (min 44px tap target)",
        "Loading state: Skeleton grid (6 cards)",
        "Empty states: 'No players on this team' or 'No players match filters'",
        "REUSE: PassportAvailabilityBadges component for health badges",
        "REUSE: PlayerTeamBadges component for playing up indicator",
        "Type check passes: npm run check-types",
        "Visual verification with dev-browser (all breakpoints, filters work)"
      ],
      "priority": 1,
      "passes": false,
      "effort": "3h",
      "dependencies": [],
      "files": {
        "modify": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/players-tab.tsx",
          "packages/backend/convex/models/teams.ts"
        ],
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/player-card.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/player-filters.tsx"
        ]
      }
    },
    {
      "id": "US-P9-054",
      "phase": 3,
      "title": "Planning Tab (Simple List + Season Milestones)",
      "description": "Display session plans in simple list view with season key milestones. Future: Calendar view option.",
      "acceptanceCriteria": [
        "Backend: Create getSeasonMilestones query in packages/backend/convex/models/sessionPlans.ts",
        "Query returns: seasonStart, seasonEnd, keyDates array (date, title, type: game/tournament/review)",
        "Get season dates from team.season field (if exists)",
        "Calculate mid-season review (halfway between start/end)",
        "Frontend: Replace placeholder planning-tab.tsx with full implementation",
        "Session Plan List: Shows upcoming sessions (next 4 weeks) and past sessions (last 4 weeks, collapsed)",
        "Each session shows: Date, time, title, location, linked notes count",
        "Session list uses EXISTING sessionPlans.listByTeam query (already exists)",
        "Season Milestones: Timeline above session list showing season start, mid-season, end, key games",
        "Filter tabs: Upcoming / Past / All",
        "Visual indicator: Today's session highlighted (border + background)",
        "Sessions with linked notes show note icon badge",
        "Completed sessions show checkmark",
        "Click session â†’ navigate to session plan detail page (existing route)",
        "Quick create: '+ New Session Plan' button (top right)",
        "Launches session creation modal (reuse existing)",
        "Loading state: Skeleton list (5 items)",
        "Empty state: 'No sessions planned - create your first one!'",
        "Mobile: Stacked cards, Desktop: Table layout",
        "Type check passes: npm run check-types",
        "Visual verification with dev-browser"
      ],
      "priority": 2,
      "passes": false,
      "effort": "3h",
      "dependencies": [],
      "files": {
        "modify": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/planning-tab.tsx",
          "packages/backend/convex/models/sessionPlans.ts"
        ],
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/session-plan-list.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/season-timeline.tsx"
        ]
      }
    }
  ],
  "phase3Checklist": [
    "âœ… Phase 2 complete: Overview Dashboard working, Health Widget shows data",
    "âš ï¸ Start with US-P9-053 (Players Tab) first - no dependencies",
    "â¬œ Create getTeamPlayersWithHealth query with health status logic",
    "â¬œ Build Players Tab with grid layout",
    "â¬œ Implement player filters (status, position, search, sort)",
    "â¬œ Create getSeasonMilestones query",
    "â¬œ Build Planning Tab with session list + milestones timeline",
    "â¬œ Verify session list uses existing queries",
    "â¬œ Test responsive layout (mobile, tablet, desktop)",
    "â¬œ Test filters and search functionality",
    "â¬œ Type check passes after all changes",
    "â¬œ Visual verification with dev-browser",
    "â¬œ Commit with message: 'feat: Phase 9 Week 4 Phase 3 - Players + Planning Tabs'",
    "â¬œ Both tabs show real data, navigation works"
  ],
  "successCriteria": {
    "phase3Complete": [
      "Players Tab shows team roster in responsive grid",
      "Health badges visible: ðŸŸ¢ Healthy, ðŸŸ¡ Recovering, ðŸ”´ Injured",
      "Player filters work: All, Active, Injured, On Break",
      "Position filter and search work",
      "Click player â†’ navigates to Player Passport",
      "Planning Tab shows session list (upcoming + past)",
      "Season milestones timeline visible above sessions",
      "Click session â†’ navigates to session detail",
      "'+ New Session Plan' button launches modal",
      "Responsive layout working on all breakpoints",
      "Loading states and empty states present",
      "Type check passes",
      "0 new TypeScript errors introduced"
    ]
  }
}

# UAT Test: US-VN-022 - Wire In-App Note Creation to v2 Artifact Pipeline

> Auto-generated: 2026-02-08 20:57
> Status: ⏳ Pending Execution

## Story
Modify createTypedNote and createRecordedNote mutations to create voiceNoteArtifacts when the v2 pipeline is enabled. For typed notes: create artifact + transcript + schedule extractClaims. For recorded notes: create artifact + link (transcribeAudio handles the rest). Study WhatsApp v2 pattern in whatsapp.ts lines 753-814 first.

## Acceptance Criteria Checklist

- [ ] === FULL IMPLEMENTATION DETAILS IN: scripts/ralph/prds/voice-gateways-v2/phases/PHASE7A_PRD.json ===
- [ ] Read that file for exact line numbers, verified function signatures, and step-by-step code.
- [ ] SUMMARY:
- [ ] 1. models/voiceNotes.ts — createTypedNote (line 554-584):
- [ ] After voiceNotes insert (line 566), BEFORE buildInsights scheduling (line 579):
- [ ] - Check shouldUseV2Pipeline feature flag
- [ ] - If v2: create artifact (crypto.randomUUID()), linkToVoiceNote, createTranscript, updateArtifactStatus('transcribed'), schedule extractClaims
- [ ] - createArtifact returns Convex _id (use for createTranscript and extractClaims)
- [ ] - linkToVoiceNote takes UUID string (not Convex _id)
- [ ] - DO NOT modify the existing buildInsights scheduling (US-VN-023 handles that)
- [ ] 2. models/voiceNotes.ts — createRecordedNote (line 591-621):
- [ ] After voiceNotes insert (line 603), BEFORE transcribeAudio scheduling (line 616):
- [ ] - Check shouldUseV2Pipeline feature flag
- [ ] - If v2: create artifact with rawMediaStorageId, linkToVoiceNote
- [ ] - DO NOT create transcript or schedule extractClaims (transcribeAudio handles those)
- [ ] - DO NOT modify the existing transcribeAudio scheduling
- [ ] CRITICAL: internal is already imported at line 2 of models/voiceNotes.ts — do NOT add duplicate import
- [ ] CRITICAL: Add ALL new code in a SINGLE edit to avoid linter removing unused references
- [ ] === VERIFY ===
- [ ] Type check: npm run check-types
- [ ] Convex codegen: npx -w packages/backend convex codegen

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VN-022"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

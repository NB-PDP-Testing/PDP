# UAT Test: US-VNM-003 - Instrument Pipeline with Event Emissions

> Auto-generated: 2026-02-16 10:15
> Status: ⏳ Pending Execution

## Story
Add event logging to all 9 existing v2 pipeline files using ctx.scheduler.runAfter (mutations) or await ctx.runMutation (actions). READ FULL DETAILS in phases/PHASE_M1.json.

## Acceptance Criteria Checklist

- [ ] Instrument voiceNoteArtifacts.ts: createArtifact (artifact_received), updateArtifactStatus (artifact_completed/failed/status_changed)
- [ ] CRITICAL: Use artifact.orgContextCandidates[0]?.organizationId for organizationId (not args.organizationId)
- [ ] Instrument voiceNoteTranscripts.ts: createTranscript (transcription_completed)
- [ ] Instrument voiceNoteClaims.ts: storeClaims (claims_extracted)
- [ ] Instrument voiceNoteEntityResolutions.ts: storeResolutions (entity_resolution_completed or entity_needs_disambiguation)
- [ ] Instrument insightDrafts.ts: createDrafts (drafts_generated), confirmDraft (draft_confirmed), rejectDraft (draft_rejected)
- [ ] Instrument actions/voiceNotes.ts: transcribeAudio (transcription_started, transcription_failed)
- [ ] Instrument actions/claimsExtraction.ts: extractClaims (claims_extraction_started, claims_extraction_failed)
- [ ] Instrument actions/entityResolution.ts: resolveEntities (entity_resolution_started)
- [ ] Instrument actions/draftGeneration.ts: generateDrafts (draft_generation_started)
- [ ] Mutations use: ctx.scheduler.runAfter(0, internal.models.voicePipelineEvents.logEvent, {...})
- [ ] Actions use: await ctx.runMutation(internal.models.voicePipelineEvents.logEvent, {...}) wrapped in try/catch
- [ ] ATOMIC IMPORTS: Add import AND usage in SAME edit (linter removes unused imports)
- [ ] Test: Create voice note → verify all events logged in voicePipelineEvents
- [ ] Verify: counters incremented in voicePipelineCounters table
- [ ] Verify: timeWindow format correct 'YYYY-MM-DD-HH'
- [ ] Verify: event metadata populated (counts, costs, confidence, duration)
- [ ] Verify: pipeline execution time not impacted (< 10ms overhead)
- [ ] Run: npm run check-types && npx ultracite fix

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VNM-003"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

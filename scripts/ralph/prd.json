{
  "project": "Voice Flow Monitoring Harness - Phase M5",
  "branchName": "ralph/voice-monitor-harness",
  "description": "Main monitoring dashboard UI with flow graph, real-time status cards, and activity feed. Creates the foundation for all frontend monitoring pages at /platform/voice-monitoring.",
  "prdFile": "scripts/ralph/prds/voice-monitor-harness/phases/PHASE_M5.json",
  "mainPRD": "scripts/ralph/prds/voice-monitor-harness/PRD.json",
  "contextFiles": [
    "scripts/ralph/prds/voice-monitor-harness/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-monitor-harness/context/PERFORMANCE_PATTERNS.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M1_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M2_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M3_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M4_LESSONS_LEARNED.md",
    "docs/architecture/voice-flow-monitoring-harness.md",
    "docs/architecture/voice-notes-v2-technical-reference.md",
    "CLAUDE.md"
  ],
  "mandatoryPatterns": [
    "READ M1_LESSONS_LEARNED.md, M2_LESSONS_LEARNED.md, M3_LESSONS_LEARNED.md, AND M4_LESSONS_LEARNED.md BEFORE starting M5",
    "Platform staff auth: Server component layout MUST verify isPlatformStaff before rendering",
    "Client components: Add 'use client' directive when using useQuery or React hooks",
    "Real-time updates: Use Convex useQuery for live data (NOT static data or polling)",
    "Query lifting: Lift useQuery calls to page level, pass data as props to components (prevent N+1)",
    "Counter schema: Query by counterType, access currentValue field (NOT named fields like 'completed')",
    "Index verification: Grep schema.ts to verify exact index names before using",
    "Loading states: Show shadcn/ui Skeleton components while queries loading",
    "Responsive design: Desktop (>= 1024px), Tablet (768-1023px), Mobile (< 768px), test at 375px minimum",
    "SVG responsiveness: Use viewBox and CSS width: 100% for responsive SVG graphics",
    "Tab navigation: Horizontal scroll on mobile, full display on desktop",
    "Query skipping: Skip queries if user not platform staff to avoid errors",
    "ATOMIC IMPORTS: Add import + usage in SAME edit (linter removes unused)",
    "Better Auth: Use user._id (not user.id), user.name (not user.firstName)",
    "Mobile testing: Test at 375px width minimum (iPhone SE)",
    "Run npx ultracite fix before completing any story",
    "Run npm run check-types after frontend changes"
  ],
  "successCriteria": [
    "Route created at /platform/voice-monitoring accessible to platform staff only",
    "Layout.tsx with tab navigation shows 8 tabs (Overview, Artifacts, Metrics, Events, Pipeline, Alerts, Settings)",
    "Page.tsx (client component) uses useQuery for real-time data",
    "PipelineFlowGraph component displays 5 pipeline stages with real-time counts",
    "StatusCards component shows 6 real-time metric cards (Active, Completed, Failed, Latency, AI Status, Cost)",
    "ActivityFeed component shows last 20 events with real-time updates",
    "Platform hub page (/platform/page.tsx) has link to Voice Monitoring",
    "v2-claims link removed from platform hub (functionality moved to artifacts grid in M6)",
    "Non-platform-staff users redirected to /platform",
    "Real-time updates work (dashboard updates < 10 seconds after events)",
    "Loading states show skeleton loaders while data loading",
    "Responsive design works on desktop, tablet, mobile (375px minimum)",
    "Tab switching navigates correctly between pages",
    "Type checks pass: npm run check-types"
  ],
  "userStories": [
    {
      "id": "US-VNM-008",
      "title": "Build Dashboard Overview UI",
      "description": "Create main monitoring dashboard at /platform/voice-monitoring with flow graph, real-time status cards, and activity feed. READ FULL DETAILS in phases/PHASE_M5.json.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/voice-monitoring/layout.tsx",
        "  - Server component with platform staff auth check",
        "  - Redirect to /platform if not authorized",
        "  - Tab navigation bar with 8 tabs using shadcn/ui Tabs",
        "  - Breadcrumb: Platform > Voice Monitoring",
        "Create apps/web/src/app/platform/voice-monitoring/page.tsx",
        "  - Client component ('use client' directive)",
        "  - useQuery for real-time metrics: api.models.voicePipelineMetrics.getRealTimeMetrics()",
        "  - useQuery for recent events: api.models.voicePipelineEvents.getRecentEvents({ filters: {}, paginationOpts: { numItems: 20 } })",
        "  - Render PipelineFlowGraph, StatusCards, ActivityFeed components",
        "  - Show skeleton loaders while data loading",
        "Create PipelineFlowGraph component (SVG-based)",
        "  - 5 pipeline stages: Ingestion, Transcription, Claims, Resolution, Drafts",
        "  - Show real-time counts per stage from metrics",
        "  - Color-code stages: Green (normal), Yellow (latency), Red (failures)",
        "  - Responsive: horizontal on desktop, vertical on mobile",
        "  - ViewBox: 0 0 1200 300 with CSS width: 100%",
        "Create StatusCards component",
        "  - Grid of 6 cards (3x2 desktop, 2x3 tablet, 1x6 mobile)",
        "  - Card 1: Active Artifacts (Activity icon)",
        "  - Card 2: Completed Today (CheckCircle icon)",
        "  - Card 3: Failed Today (XCircle icon, red if failure rate > 10%)",
        "  - Card 4: Avg Latency (Clock icon)",
        "  - Card 5: AI Service Status (Cpu icon, color by circuit breaker state)",
        "  - Card 6: Total Cost Today (DollarSign icon)",
        "  - Real-time updates via useQuery",
        "Create ActivityFeed component",
        "  - List of last 20 events with relative timestamps ('5 minutes ago')",
        "  - Event type icons (Inbox, CheckCircle, XCircle, Mic, etc.)",
        "  - Human-readable messages",
        "  - Metadata badges (claim count, cost, duration)",
        "  - Group by time (Today, Yesterday, This Week)",
        "  - Auto-scroll to top on new events",
        "  - Empty state: 'No recent activity'",
        "Update apps/web/src/app/platform/page.tsx",
        "  - Add link to Voice Monitoring with Card component",
        "  - Remove v2-claims link (feature moved to artifacts grid in M6)",
        "CRITICAL: Layout must verify isPlatformStaff on server side",
        "CRITICAL: Page must be client component ('use client') for useQuery",
        "CRITICAL: Lift useQuery to page level, pass data as props to components",
        "CRITICAL: Test responsive design at 375px width minimum",
        "Run: npm run check-types"
      ],
      "priority": 8,
      "notes": "CRITICAL: Read phases/PHASE_M5.json for EXACT implementation. Server auth in layout, client queries in page. Query counters by counterType, access currentValue.",
      "passes": false
    }
  ],
  "ralphGuidance": {
    "executionOrder": [
      "1. US-VNM-008: Create Dashboard Overview UI (4-5 days)",
      "   a. Read PHASE_M5.json detailedAcceptanceCriteria for exact component structure",
      "   b. Create layout.tsx with platform staff auth and tab navigation",
      "   c. Create page.tsx with useQuery calls (lift to page level)",
      "   d. Build PipelineFlowGraph component (SVG-based, responsive)",
      "   e. Build StatusCards component (6 cards, real-time data)",
      "   f. Build ActivityFeed component (last 20 events, real-time)",
      "   g. Update platform hub page (add Voice Monitoring link, remove v2-claims)",
      "   h. Test responsive design on mobile (375px minimum)",
      "   i. Test real-time updates with actual voice notes",
      "2. Manual testing via dev-browser",
      "   a. Navigate as platform staff → verify dashboard loads",
      "   b. Navigate as non-staff → verify redirect to /platform",
      "   c. Create voice note → verify dashboard updates in real-time",
      "   d. Test tab switching between Overview, Artifacts, etc.",
      "   e. Test mobile layout at 375px width",
      "   f. Verify loading states show skeletons"
    ],
    "commonPitfalls": [
      "❌ Forgetting 'use client' directive on page.tsx (useQuery requires client component)",
      "❌ Not verifying platform staff auth on layout (security issue)",
      "❌ Not lifting useQuery to page level (causes N+1 queries in components)",
      "❌ SVG not responsive (use viewBox and CSS width: 100%)",
      "❌ Querying counter fields directly instead of by counterType",
      "❌ Not showing loading states (poor UX)",
      "❌ Not testing mobile responsive layout (breaks on small screens)",
      "❌ Using .take() instead of pagination in getRecentEvents"
    ],
    "successIndicators": [
      "✅ Dashboard loads at /platform/voice-monitoring",
      "✅ Tab navigation shows 8 tabs",
      "✅ Flow graph displays 5 stages with real-time counts",
      "✅ Status cards show 6 metrics with real-time updates",
      "✅ Activity feed shows last 20 events",
      "✅ Real-time updates work (< 10s lag)",
      "✅ Platform staff auth enforced",
      "✅ Non-staff users redirected",
      "✅ Mobile responsive layout works at 375px",
      "✅ Loading states show skeletons",
      "✅ npm run check-types passes"
    ]
  },
  "testingStrategy": {
    "approach": "Manual testing with dev-browser and real voice notes",
    "keyScenarios": [
      "Platform staff access → verify full dashboard",
      "Non-staff access → verify redirect",
      "Create voice note → verify real-time update",
      "Mobile viewport (375px) → verify responsive layout",
      "Tab switching → verify navigation works",
      "Loading states → verify skeletons show"
    ],
    "verificationTools": [
      "dev-browser tool for visual verification",
      "Manual testing in browser at localhost:3000",
      "Chrome DevTools responsive mode (375px, 768px, 1024px)",
      "Real voice note creation for live update testing"
    ],
    "detailedTestPlan": "See phases/PHASE_M5.json testingStrategy section for complete test scenarios"
  }
}

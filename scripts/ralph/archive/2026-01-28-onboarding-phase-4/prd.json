{
  "project": "Onboarding Phase 5 - First User Onboarding",
  "branchName": "ralph/onboarding-phase-5",
  "description": "Auto-detect first user on fresh deployment, assign Platform Staff role, and guide through a 5-step setup wizard to create the first organization.",
  "relatedIssues": ["#371"],
  "dependencies": ["phase-1-foundation", "phase-2-gdpr"],
  "userStories": [
    {
      "id": "US-001",
      "title": "Create isFirstUser helper function",
      "description": "As the system, I can detect if the current user is the first user on a fresh deployment.",
      "priority": 1,
      "passes": false,
      "acceptanceCriteria": [
        "Create: packages/backend/convex/lib/firstUser.ts",
        "",
        "Export async function isFirstUser(ctx): Promise<boolean> {",
        "  // Check if any users exist with isPlatformStaff = true",
        "  const existingStaff = await ctx.db",
        "    .query('user')",
        "    .filter(q => q.eq(q.field('isPlatformStaff'), true))",
        "    .first();",
        "",
        "  return existingStaff === null;",
        "}",
        "",
        "Note: This should use an index. Consider adding:",
        "  .index('by_isPlatformStaff', ['isPlatformStaff'])",
        "to the user table in schema.ts",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Alternative logic: Check if any organizations exist. First user = no organizations exist."
    },
    {
      "id": "US-002",
      "title": "Add setup wizard fields to user schema",
      "description": "As the system, I track first user's progress through the setup wizard.",
      "priority": 2,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Find the user table definition (Better Auth extended user)",
        "Add these optional fields:",
        "  setupComplete: v.optional(v.boolean()),    // True after first user completes wizard",
        "  setupStep: v.optional(v.string()),         // Current step: 'gdpr', 'welcome', 'create-org', 'invite', 'complete'",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types"
      ],
      "notes": "setupStep tracks where user is in wizard to handle browser refresh/abandonment."
    },
    {
      "id": "US-003",
      "title": "Auto-assign Platform Staff on first user signup",
      "description": "As the first user signing up, I automatically receive Platform Staff role.",
      "priority": 3,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/users.ts (or auth hook location)",
        "Find the post-signup hook or user creation logic",
        "After user is created, add:",
        "",
        "// Check if this is the first user",
        "const firstUser = await isFirstUser(ctx);",
        "if (firstUser) {",
        "  // Grant Platform Staff",
        "  await ctx.db.patch(userId, {",
        "    isPlatformStaff: true,",
        "    setupComplete: false,",
        "    setupStep: 'gdpr',",
        "  });",
        "}",
        "",
        "Run: npm run check-types",
        "Test: Fresh deployment → Sign up → Verify isPlatformStaff = true"
      ],
      "notes": "Better Auth may have specific hooks for post-signup. Check betterAuth folder for hook location."
    },
    {
      "id": "US-004",
      "title": "Create setup wizard layout with protection",
      "description": "As a non-Platform Staff user, I cannot access /setup routes.",
      "priority": 4,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/app/setup/layout.tsx",
        "",
        "Layout logic:",
        "export default function SetupLayout({ children }) {",
        "  const { data: session, isPending } = useSession();",
        "  const router = useRouter();",
        "",
        "  useEffect(() => {",
        "    if (isPending) return;",
        "    ",
        "    // Not logged in - redirect to login",
        "    if (!session?.user) {",
        "      router.push('/login');",
        "      return;",
        "    }",
        "    ",
        "    // Not platform staff - redirect to home",
        "    if (!session.user.isPlatformStaff) {",
        "      router.push('/');",
        "      return;",
        "    }",
        "    ",
        "    // Setup already complete - redirect to orgs",
        "    if (session.user.setupComplete) {",
        "      router.push('/orgs');",
        "      return;",
        "    }",
        "  }, [session, isPending, router]);",
        "",
        "  if (isPending || !session?.user?.isPlatformStaff || session.user.setupComplete) {",
        "    return <LoadingSpinner />;",
        "  }",
        "",
        "  return (",
        "    <div className='min-h-screen flex flex-col'>",
        "      <SetupProgress currentStep={session.user.setupStep} />",
        "      {children}",
        "    </div>",
        "  );",
        "}",
        "",
        "Run: npm run check-types"
      ],
      "notes": "isPlatformStaff field must be included in the session. Check Better Auth session configuration."
    },
    {
      "id": "US-005",
      "title": "Create SetupProgress indicator component",
      "description": "As a first user going through setup, I see a progress indicator showing my current step.",
      "priority": 5,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/setup/setup-progress.tsx",
        "",
        "Props: { currentStep: string }",
        "",
        "Define steps array:",
        "const SETUP_STEPS = [",
        "  { id: 'gdpr', label: 'Privacy' },",
        "  { id: 'welcome', label: 'Welcome' },",
        "  { id: 'create-org', label: 'Create Club' },",
        "  { id: 'invite', label: 'Invite Team' },",
        "  { id: 'complete', label: 'Done' },",
        "];",
        "",
        "UI structure:",
        "- Horizontal stepper showing all 5 steps",
        "- Current step highlighted",
        "- Completed steps show checkmark",
        "- Future steps shown as numbers",
        "- Use shadcn/ui styling (flex, badges)",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Keep the progress indicator simple. Can use Tailwind for styling or shadcn/ui components."
    },
    {
      "id": "US-006",
      "title": "Create setup wizard Step 1: GDPR consent page",
      "description": "As a first user, my first setup step is accepting GDPR consent.",
      "priority": 6,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/app/setup/page.tsx",
        "",
        "This is Step 1: GDPR consent",
        "",
        "Reuse the GdprConsentStep component from Phase 2:",
        "import { GdprConsentStep } from '@/components/onboarding/gdpr-consent-step';",
        "",
        "Page logic:",
        "export default function SetupGdprPage() {",
        "  const router = useRouter();",
        "  const gdprVersion = useQuery(api.models.gdpr.getCurrentGdprVersion);",
        "  const updateSetupStep = useMutation(api.models.setup.updateSetupStep);",
        "",
        "  const handleAccept = async () => {",
        "    await updateSetupStep({ step: 'welcome' });",
        "    router.push('/setup/welcome');",
        "  };",
        "",
        "  if (!gdprVersion) return <LoadingSpinner />;",
        "",
        "  return (",
        "    <div className='container max-w-2xl mx-auto py-8'>",
        "      <h1>Setup Your Platform</h1>",
        "      <p>Step 1 of 5: Privacy Policy</p>",
        "      <GdprConsentStep",
        "        gdprVersion={gdprVersion}",
        "        onAccept={handleAccept}",
        "      />",
        "    </div>",
        "  );",
        "}",
        "",
        "Run: npm run check-types"
      ],
      "notes": "GDPR consent is captured once during setup. Same component as regular onboarding flow."
    },
    {
      "id": "US-007",
      "title": "Create setup wizard Step 2: Welcome page",
      "description": "As a first user, I see a welcome message explaining what I can do as Platform Staff.",
      "priority": 7,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/app/setup/welcome/page.tsx",
        "",
        "UI structure:",
        "- Title: 'Welcome to PlayerARC'",
        "- Subtitle: 'You are the first user and have been granted Platform Staff access'",
        "- Explanation cards:",
        "  - 'Create Organizations': 'Set up clubs and teams for your sports programs'",
        "  - 'Manage Users': 'Invite coaches, parents, and administrators'",
        "  - 'Track Development': 'Monitor player progress across all organizations'",
        "- Button: 'Continue' → navigates to /setup/create-org",
        "",
        "On continue:",
        "const updateSetupStep = useMutation(api.models.setup.updateSetupStep);",
        "",
        "const handleContinue = async () => {",
        "  await updateSetupStep({ step: 'create-org' });",
        "  router.push('/setup/create-org');",
        "};",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This page is informational only. Quick read, then user proceeds to create their first org."
    },
    {
      "id": "US-008",
      "title": "Create setup wizard Step 3: Create organization page",
      "description": "As a first user, I create my first organization/club during setup.",
      "priority": 8,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/app/setup/create-org/page.tsx",
        "",
        "Form fields (reuse existing org creation patterns):",
        "- Organization name (required)",
        "- Organization slug (auto-generated from name)",
        "- Primary sport (dropdown)",
        "- Logo upload (optional)",
        "- Primary color picker",
        "- Secondary color picker",
        "- Tertiary color picker",
        "",
        "Create mutation: createFirstOrganization",
        "In packages/backend/convex/models/setup.ts:",
        "",
        "export const createFirstOrganization = mutation({",
        "  args: {",
        "    name: v.string(),",
        "    slug: v.string(),",
        "    sport: v.optional(v.string()),",
        "    colors: v.optional(v.array(v.string())),",
        "  },",
        "  handler: async (ctx, args) => {",
        "    // Verify user is Platform Staff",
        "    // Create organization using Better Auth organization plugin",
        "    // Set user as Owner",
        "    // Update user setupStep to 'invite'",
        "    // Return orgId",
        "  },",
        "});",
        "",
        "On success: router.push('/setup/invite')",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Use Better Auth's organization creation method. User becomes Owner automatically."
    },
    {
      "id": "US-009",
      "title": "Create setup wizard Step 4: Invite team page",
      "description": "As a first user, I can optionally invite initial team members during setup.",
      "priority": 9,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/app/setup/invite/page.tsx",
        "",
        "UI structure:",
        "- Title: 'Invite Your Team'",
        "- Subtitle: 'Add colleagues to help manage your organization (you can skip this)'",
        "- Repeatable row for invitations:",
        "  - Email input",
        "  - Role dropdown (Admin, Coach)",
        "  - Remove button",
        "- 'Add Another' button",
        "- Footer buttons:",
        "  - 'Skip for Now' (secondary) → goes to /setup/complete",
        "  - 'Send Invitations' (primary) → sends invites then goes to /setup/complete",
        "",
        "Create mutation: sendSetupInvitations",
        "Args: { orgId: v.string(), invitations: v.array(v.object({ email, role })) }",
        "Logic: Create invitations for each, send emails",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This step is optional. Skip button proceeds without sending any invitations."
    },
    {
      "id": "US-010",
      "title": "Create setup wizard Step 5: Complete page",
      "description": "As a first user completing setup, I see a success message and am redirected to my organization.",
      "priority": 10,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/app/setup/complete/page.tsx",
        "",
        "On mount: Mark setup as complete",
        "useEffect(() => {",
        "  completeSetup();",
        "}, []);",
        "",
        "const completeSetup = useMutation(api.models.setup.completeSetup);",
        "",
        "completeSetup mutation logic:",
        "  - Update user: setupComplete = true, setupStep = 'complete'",
        "",
        "UI structure:",
        "- Success icon (CheckCircle)",
        "- Title: 'You\\'re All Set!'",
        "- Text: 'Your organization has been created and you\\'re ready to go.'",
        "- If invitations were sent: 'Your team members will receive their invitations shortly.'",
        "- Button: 'Go to Dashboard' → navigates to /orgs/[orgId]",
        "",
        "Auto-redirect after 5 seconds:",
        "useEffect(() => {",
        "  const timer = setTimeout(() => {",
        "    router.push(`/orgs/${orgId}`);",
        "  }, 5000);",
        "  return () => clearTimeout(timer);",
        "}, []);",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This marks the end of setup. User should never see the wizard again after completion."
    },
    {
      "id": "US-011",
      "title": "Create setup queries and mutations file",
      "description": "As the system, I have a dedicated file for all setup wizard backend logic.",
      "priority": 11,
      "passes": false,
      "acceptanceCriteria": [
        "Create: packages/backend/convex/models/setup.ts",
        "",
        "Query: getSetupProgress",
        "Args: none (uses authenticated user)",
        "Returns: v.object({ step: v.string(), isComplete: v.boolean() })",
        "Logic: Return user.setupStep and user.setupComplete",
        "",
        "Mutation: updateSetupStep",
        "Args: { step: v.string() }",
        "Returns: v.null()",
        "Logic: Update user.setupStep = step",
        "",
        "Mutation: completeSetup",
        "Args: none",
        "Returns: v.null()",
        "Logic: Update user.setupComplete = true, setupStep = 'complete'",
        "",
        "Mutation: createFirstOrganization (from US-008)",
        "Mutation: sendSetupInvitations (from US-009)",
        "",
        "Run: npm run check-types"
      ],
      "notes": "All setup-specific mutations should be here. Organization creation uses Better Auth methods."
    },
    {
      "id": "US-012",
      "title": "Add redirect to setup for first user after login",
      "description": "As a first user who hasn't completed setup, I am redirected to /setup after login.",
      "priority": 12,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: apps/web/src/app/(auth)/login/page.tsx or auth callback handler",
        "",
        "After successful login, add check:",
        "if (user.isPlatformStaff && !user.setupComplete) {",
        "  router.push('/setup');",
        "  return;",
        "}",
        "",
        "Also check on the home/orgs page:",
        "Edit: apps/web/src/app/orgs/page.tsx (or main dashboard)",
        "If user.isPlatformStaff && !user.setupComplete, redirect to /setup",
        "",
        "Edge case: User refreshes during setup",
        "- Layout already handles this by checking setupStep",
        "- Redirect to correct step based on setupStep value",
        "",
        "Run: npm run check-types",
        "Test: First user signs up → Automatically redirected to /setup"
      ],
      "notes": "Multiple redirect guards ensure user can't skip setup accidentally."
    }
  ],
  "verificationSteps": [
    "npm run check-types",
    "npx -w packages/backend convex codegen",
    "Test: Fresh deployment → Sign up → Granted Platform Staff → Redirected to /setup",
    "Test: Complete all steps → Organization created → Dashboard loads",
    "Test: Second user signs up after first completes → Normal flow (no wizard)",
    "Test: First user completes step 2, closes browser → Logs in again → Returns to step 3",
    "Test: Click 'Skip' on invite step → Proceeds to completion without sending invites"
  ],
  "successCriteria": [
    "First user on fresh deployment gets Platform Staff automatically",
    "First user redirected to /setup after signup",
    "Setup wizard has 5 steps with progress indicator",
    "GDPR consent captured in step 1",
    "Organization created with user as Owner",
    "Optional team invitation works",
    "'Skip' on invite step proceeds to completion",
    "Second user gets normal flow (not setup wizard)",
    "Setup wizard protected from non-Platform Staff users",
    "Abandoning setup and returning works correctly"
  ]
}

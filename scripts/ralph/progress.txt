# Ralph Progress - Voice Gateways v2

**Branch**: feat/voice-gateways-v2
**Started**: 2026-02-04
**Current Phase**: Phase 7C - Complete v2 → v1 Output Bridge
**Overall Progress**: 25/29 stories complete (86%)
**Architecture Review**: COMPLETE (ADR-VN2-040 to ADR-VN2-042 for Phase 7C)

---

## Completed Phases Summary

### Phase 1: Quality Gates & Fuzzy Matching ✅ (US-VN-001 to US-VN-006)
- 349 tests passing across 86 files
- messageValidation, duplicateDetection, fuzzyMatching, playerMatching

### Phase 2: Coach Quick Review Microsite ✅ (US-VN-007 to US-VN-012)
- `/r/[code]` public review microsite (no auth, code = token)
- whatsappReviewLinks model, priority-sorted queue, batch actions
- Inline edit, trust-adaptive messages, link expiry crons

### Phase 2.5: Review Microsite Polish ✅ (US-VN-012a to 012d)
- Analytics, swipe gestures, snooze, PWA manifest

### Phase 3: v2 Artifacts Foundation ✅ (US-VN-013 to US-VN-014)
- voiceNoteArtifacts + voiceNoteTranscripts tables
- featureFlags table + shouldUseV2Pipeline
- Dual-path processing in whatsapp.ts

### Phase 4: Claims Extraction ✅ (US-VN-015 to US-VN-016)
- voiceNoteClaims table + claimsExtraction action (GPT-4, 15 categories)
- coachContext.ts shared helper, deterministic + fuzzy player matching
- Pipeline hook: scheduler.runAfter(0, extractClaims) after transcription

### Phase 5: Entity Resolution & Disambiguation ✅ (US-VN-017 to US-VN-018)
- voiceNoteEntityResolutions + coachPlayerAliases tables
- entityResolution action (trust-adaptive thresholds, alias learning)
- Disambiguation UI at /coach/voice-notes/disambiguation/[artifactId]
- 6 enhancements: trust-adaptive threshold, feature flags, analytics, rich matchReason, alias learning, batch resolution

### Phase 6: Drafts & Confirmation Workflow ✅ (US-VN-019 to US-VN-021)
- insightDrafts table + 11 functions (4 internal + 7 public)
- draftGeneration action (confidence scoring, auto-confirm gate)
- WhatsApp command parser + handler (4 command types)
- migration.ts action (batch, dry-run, idempotent)

---

## Phase 7A: Wire In-App Notes to v2 ✅ (US-VN-022 to US-VN-023)

### US-VN-022: Wire In-App Note Creation to v2 Artifact Pipeline
**Commit**: b7439a06
- createTypedNote: creates artifact + transcript + schedules extractClaims (feature-flagged)
- createRecordedNote: creates artifact only (transcribeAudio handles rest)
- v1 scheduling (buildInsights/transcribeAudio) unchanged
- Key pattern: in-app notes create v1 note FIRST then v2 artifact

### US-VN-023: Eliminate Duplicate v1+v2 Processing
**Commit**: (included in phase commit)
- buildInsights: skip check added — if v2 artifact exists, return null
- Audited 4 v2 files for .filter() anti-pattern — all clean (JS array filters)

---

## Phase 7B: Draft Confirmation UI ✅ (US-VN-024 to US-VN-025)

### US-VN-024: Drafts Tab in Voice Notes Dashboard
**Commit**: c3e59c0f
- Created drafts-tab.tsx: DraftsTab component with DraftCard, grouped by artifact
- 15 insight type colors, confidence bars, collapsible evidence snippets
- Individual Confirm/Reject with loading states + toast
- Dashboard: added "drafts" tab, pendingDrafts useQuery in parent

### US-VN-025: Draft Batch Operations & Auto-Switch
**Commit**: 9c0b37ce
- Batch: confirmAllDrafts/rejectAllDrafts with AlertDialog for destructive reject
- Auto-switch priority: parents > drafts > insights
- Verified disambiguation-banner works for all artifact types

### Security Hardening (Post Phase 7B)
**Commit**: abdaa92d
- Added by_org_coach_status_createdAt composite index for expiry range query
- organizationId arg added to confirmAllDrafts/rejectAllDrafts (defense-in-depth)
- getPendingDraftsInternal: replaced JS .filter() with index .gte("createdAt")

---

## Codebase Reference

### Key File Locations
- Voice notes model: `packages/backend/convex/models/voiceNotes.ts`
- Insight drafts model: `packages/backend/convex/models/insightDrafts.ts`
- Draft generation: `packages/backend/convex/actions/draftGeneration.ts`
- Parent summaries: `packages/backend/convex/actions/coachParentSummaries.ts`
- Claims extraction: `packages/backend/convex/actions/claimsExtraction.ts`
- Entity resolution: `packages/backend/convex/actions/entityResolution.ts`
- Feature flags: `packages/backend/convex/lib/featureFlags.ts`
- Schema: `packages/backend/convex/schema.ts`
- Voice notes dashboard: `apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx`
- Drafts tab: `apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/drafts-tab.tsx`

### Established Patterns
- NEVER use `.filter()` on Convex query builder — always `.withIndex()`
- All functions need `args` and `returns` validators
- Better Auth: `user._id` (not `user.id`), `user.name` (not `user.firstName`)
- Batch fetch + Map lookup (avoid N+1)
- Import + usage in SAME edit (linter removes unused imports)
- Schema changes FIRST → codegen → code changes
- Public functions: auth check + ownership verification
- InternalActions call internal mutations (NOT public)
- `v.optional(v.string())` not `v.string() | null`

### Quality Checks
- `npm run check-types` → `npx ultracite fix` → `npm run check`
- Biome: block statements required, `type` not `interface`, top-level regex
- Biome suppression: `// biome-ignore lint/rule/name: reason`

---

## Phase 7C: Complete v2 → v1 Output Bridge — STARTING NOW

**PRD**: `phases/PHASE7C_PRD.json` (PRIMARY — read this FIRST)
**Context**: `context/V2_MIGRATION_CONTEXT.md`
**Architecture Review**: COMPLETE (ADR-VN2-040, 041, 042)

### Stories:
- US-VN-026: applyDraft Output Bridge (parent summaries, audit trail, backward compat)
- US-VN-027: Auto-Confirm Integration + Quality Gates for In-App Notes

### Execution Order (CRITICAL):
1. Schema: Make autoAppliedInsights.playerId optional
2. Schema: Add sourceArtifactId/sourceClaimId/sourceDraftId to voiceNoteInsights
3. Run codegen: npx -w packages/backend convex codegen
4. Code: Extend applyDraft with Steps 0-3B
5. Type check
6. Code: Add validateTextMessage to createTypedNote
7. Type check

### Architect Review Corrections (MUST follow):
- C1: Check coachOrgPreferences.parentSummariesEnabled BEFORE scheduling processVoiceNoteInsight
- C2: Include appliedBy + appliedDate in voiceNotes.insights[] push object
- C3: Schema changes FIRST, codegen, then code changes

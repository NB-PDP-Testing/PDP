{
  "project": "Voice Flow Monitoring Harness - Phase M4",
  "branchName": "ralph/voice-monitor-harness",
  "description": "Automated anomaly detection with health check cron. Detects pipeline issues like high failure rates, latency spikes, queue depth problems, and circuit breaker state changes.",
  "prdFile": "scripts/ralph/prds/voice-monitor-harness/phases/PHASE_M4.json",
  "mainPRD": "scripts/ralph/prds/voice-monitor-harness/PRD.json",
  "contextFiles": [
    "scripts/ralph/prds/voice-monitor-harness/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-monitor-harness/context/PERFORMANCE_PATTERNS.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M1_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M2_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M3_LESSONS_LEARNED.md",
    "docs/architecture/voice-flow-monitoring-harness.md",
    "docs/architecture/voice-notes-v2-technical-reference.md",
    "CLAUDE.md"
  ],
  "mandatoryPatterns": [
    "READ M1_LESSONS_LEARNED.md, M2_LESSONS_LEARNED.md, AND M3_LESSONS_LEARNED.md BEFORE starting M4",
    "Platform staff auth: ALL alert queries/mutations MUST verify isPlatformStaff",
    "Fire-and-forget: Use ctx.scheduler.runAfter(0, ...) for event emissions (NEVER block health checks)",
    "Safe division: ALWAYS check denominator > 0 before dividing (critical for failure rate calculation)",
    "Alert deduplication: Check for existing unacknowledged alert of same type before creating new one (15-minute window)",
    "Health check timing: Cron runs every 5 minutes (not every minute - too frequent)",
    "Alert severity levels: critical (circuit breaker), high (failure rate >10%), medium (latency/queue), low (backlog/inactivity)",
    "Reuse platformCostAlerts table: Add PIPELINE_* alert types (or create new voicePipelineAlerts table if time allows)",
    "Query real-time metrics: Use voicePipelineCounters for current data (NOT event scans)",
    "Historical baseline: Query last 168 hourly snapshots (7 days) for latency baseline calculation",
    "Better Auth: Use ctx.runQuery(adapter.findOne, ...) with array where: [{ field, value }]",
    "ATOMIC IMPORTS: Add import + usage in SAME edit (linter removes unused)",
    "NEVER use .filter() in Convex — always .withIndex()",
    "JavaScript .filter() on collected arrays is CORRECT (NOT a Convex query .filter())",
    "UTC time handling: getUTCHours(), getUTCMonth(), getUTCDate() (NOT local time methods)",
    "Error handling: Log errors but return successfully (don't throw in mutations called by UI)",
    "Run npx ultracite fix before completing any story",
    "Run npx -w packages/backend convex codegen after changes"
  ],
  "successCriteria": [
    "voicePipelineAlerts.ts created with 4 functions (1 health check + 3 alert queries/mutations)",
    "checkPipelineHealth internal mutation runs successfully (6 health checks)",
    "All 6 alert types can be triggered: HIGH_FAILURE_RATE, HIGH_LATENCY, HIGH_QUEUE_DEPTH, DISAMBIGUATION_BACKLOG, CIRCUIT_BREAKER_OPEN, INACTIVITY",
    "Alert deduplication works (no duplicate alerts for same unacknowledged issue)",
    "getActiveAlerts query returns only unacknowledged PIPELINE_* alerts",
    "acknowledgeAlert mutation marks alert as acknowledged",
    "getAlertHistory query returns paginated historical alerts with filters",
    "Cron job added to crons.ts (check-pipeline-health, every 5 minutes)",
    "Cron runs successfully in Convex dashboard",
    "Safe division: failure rate calculation handles divide-by-zero",
    "Latency baseline: calculated from 168 hourly snapshots (7 days)",
    "All alert functions verify isPlatformStaff authorization",
    "Codegen passes: npx -w packages/backend convex codegen",
    "All type checks pass: npm run check-types"
  ],
  "userStories": [
    {
      "id": "US-VNM-007",
      "title": "Build Pipeline Alerts Backend",
      "description": "Create voicePipelineAlerts.ts with automated health check cron and alert queries. READ FULL DETAILS in phases/PHASE_M4.json.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/models/voicePipelineAlerts.ts",
        "Implement checkPipelineHealth internalMutation (cron-called every 5 min)",
        "  - Query real-time metrics from voicePipelineCounters",
        "  - Query most recent hourly snapshot from voicePipelineMetricsSnapshots",
        "  - Perform 6 health checks:",
        "    1. Failure Rate: failures / (completed + failures) > 0.10 → PIPELINE_HIGH_FAILURE_RATE (severity: high)",
        "    2. Latency Spike: current latency > 2x 7-day avg → PIPELINE_HIGH_LATENCY (severity: medium)",
        "    3. Queue Depth: active artifacts > 50 → PIPELINE_HIGH_QUEUE_DEPTH (severity: medium)",
        "    4. Disambiguation Backlog: needs_disambiguation > 100 → PIPELINE_DISAMBIGUATION_BACKLOG (severity: low)",
        "    5. Circuit Breaker: state='open' or 'half_open' → PIPELINE_CIRCUIT_BREAKER_OPEN (severity: critical)",
        "    6. Pipeline Inactivity: no artifacts received in 60+ min → PIPELINE_INACTIVITY (severity: low)",
        "  - Deduplicate alerts: before inserting, check if same alertType exists with acknowledged=false. Only create if no recent unacknowledged alert.",
        "  - Insert alerts into platformCostAlerts table (or new voicePipelineAlerts table)",
        "  - Return { alertsCreated: count, checksPerformed: ['failure_rate', 'latency', ...] }",
        "Implement getActiveAlerts query (platform staff only)",
        "  - Query platformCostAlerts with acknowledged=false AND alertType starts with 'PIPELINE_'",
        "  - Order by severity (critical > high > medium > low), then createdAt desc",
        "  - Return array of alerts",
        "Implement acknowledgeAlert mutation (platform staff only)",
        "  - Update alert: acknowledged=true, acknowledgedAt=Date.now(), acknowledgedBy=user._id",
        "  - Return { success: true }",
        "Implement getAlertHistory query (platform staff only)",
        "  - Query platformCostAlerts with alertType starts with 'PIPELINE_'",
        "  - Apply optional filters (severity, alertType, date range)",
        "  - Order by createdAt desc",
        "  - Use .paginate(paginationOpts)",
        "  - Return paginated result",
        "Add cron job to crons.ts:",
        "  - Name: 'check-pipeline-health'",
        "  - Schedule: Every 5 minutes (crons.interval('check-pipeline-health', { minutes: 5 }, ...))",
        "  - Action: Call internal.models.voicePipelineAlerts.checkPipelineHealth",
        "CRITICAL: Safe division - check denominator > 0 before calculating failure rate",
        "CRITICAL: Alert deduplication - don't spam duplicate alerts for same unacknowledged issue",
        "CRITICAL: Latency baseline - query last 168 hourly snapshots (7 days) for historical average",
        "CRITICAL: Platform staff auth on all query/mutation functions",
        "Run: npx -w packages/backend convex codegen && npm run check-types"
      ],
      "priority": 7,
      "notes": "CRITICAL: Read phases/PHASE_M4.json for EXACT implementation. Handle divide-by-zero in failure rate calc. Deduplicate alerts (15-min window). Use voicePipelineCounters for real-time metrics.",
      "passes": true
    }
  ],
  "ralphGuidance": {
    "executionOrder": [
      "1. US-VNM-007: Create voicePipelineAlerts.ts (2 days)",
      "   a. Read PHASE_M4.json detailedAcceptanceCriteria for exact function signatures",
      "   b. Implement checkPipelineHealth with all 6 health checks",
      "   c. CRITICAL: Handle divide-by-zero in failure rate calculation",
      "   d. CRITICAL: Implement alert deduplication (check for existing unacknowledged alerts)",
      "   e. Implement getActiveAlerts query (platform staff auth)",
      "   f. Implement acknowledgeAlert mutation (platform staff auth)",
      "   g. Implement getAlertHistory query with .paginate()",
      "   h. Add cron job to crons.ts (every 5 minutes)",
      "2. Manual testing via Convex dashboard",
      "   a. Force high failure rate → run checkPipelineHealth → verify PIPELINE_HIGH_FAILURE_RATE alert created",
      "   b. Call getActiveAlerts → verify alert appears",
      "   c. Call acknowledgeAlert → verify alert marked acknowledged",
      "   d. Run checkPipelineHealth again → verify doesn't create duplicate (deduplication works)",
      "   e. Test all 6 alert types (latency spike, queue depth, circuit breaker, backlog, inactivity)",
      "   f. Deploy cron → wait 5 minutes → verify runs automatically"
    ],
    "commonPitfalls": [
      "❌ Not handling divide-by-zero in failure rate calculation",
      "❌ Not deduplicating alerts (creates spam on every health check)",
      "❌ Wrong severity levels (should match criticality of issue)",
      "❌ Not filtering for PIPELINE_* alerts in getActiveAlerts (shows all platform alerts)",
      "❌ Cron interval too frequent (5 min is appropriate, 1 min is overkill)",
      "❌ Not verifying platform staff auth on query/mutation functions",
      "❌ Using event scans instead of voicePipelineCounters for real-time metrics",
      "❌ Not querying 168 hourly snapshots for latency baseline (7 days)"
    ],
    "successIndicators": [
      "✅ Cron runs every 5 minutes in Convex dashboard",
      "✅ Alerts created in platformCostAlerts with correct alertType",
      "✅ getActiveAlerts shows unacknowledged PIPELINE_* alerts only",
      "✅ acknowledgeAlert marks alerts as acknowledged",
      "✅ No duplicate alerts for same unacknowledged issue",
      "✅ All 6 alert types can be triggered",
      "✅ npm run check-types passes",
      "✅ npx -w packages/backend convex codegen succeeds"
    ]
  },
  "testingStrategy": {
    "approach": "Manual testing with synthetic anomalies",
    "keyScenarios": [
      "Create failed artifacts to trigger high failure rate",
      "Create many active artifacts to trigger queue depth alert",
      "Set circuit breaker to open state → verify critical alert",
      "Stop creating artifacts for 60+ minutes → verify inactivity alert",
      "Create many disambiguation resolutions → verify backlog alert",
      "Acknowledge alert → verify doesn't reappear on next health check"
    ],
    "verificationTools": [
      "Convex dashboard → Functions tab (call checkPipelineHealth manually)",
      "Convex dashboard → Data tab (verify alerts in platformCostAlerts)",
      "Convex dashboard → Crons tab (verify check-pipeline-health cron runs every 5 min)",
      "Convex dashboard → Logs (check health check execution)"
    ],
    "detailedTestPlan": "See phases/PHASE_M4.json testingStrategy section for complete test scenarios"
  }
}

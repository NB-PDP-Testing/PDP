# P5 Phase 4 (Learning Loop) - Progress Tracker

## Phase Context

**Previous Phase:** Phase 3 (Cost Optimization) - COMPLETE
- US-012 to US-015: Prompt caching, usage tracking, analytics
- 90% AI cost reduction capability via Anthropic prompt caching
- All AI calls logged to aiUsageLog table
- Analytics query ready for cost visibility

**This Phase:** Phase 4 (Learning Loop)
- US-016: Add override tracking fields to schema
- US-017: Capture override data in suppressSummary mutation
- US-018: Add optional feedback UI for suppression
- US-019: Create getCoachOverridePatterns analytics query
- US-020: Implement adaptive confidence thresholds per coach

**Goal:** AI learns from coach behavior. Personalize automation per coach based on their actual approval patterns.

---

## Critical Convex Patterns

### Authentication Pattern (FROM PHASE 2 BUG FIX)
**CRITICAL:** Better Auth userId field is optional and unset for all users!

```typescript
// ❌ WRONG - Will fail for all users
const user = await authComponent.safeGetAuthUser(ctx);
if (!user?.userId) {
  throw new Error("Not authenticated");
}
const coachId = user.userId; // userId is undefined!

// ✅ CORRECT - Use fallback pattern
const user = await authComponent.safeGetAuthUser(ctx);
if (!user) {
  throw new Error("Not authenticated");
}
const coachId = user.userId || user._id;
if (!coachId) {
  throw new Error("User ID not found");
}
```

**Why:** Better Auth user table has userId field but it's optional/unset. The _id field is the primary identifier.

### Query Pattern
```typescript
export const myQuery = query({
  args: { orgId: v.id("organization") },
  returns: v.object({ /* ... */ }),
  handler: async (ctx, args) => {
    // Always use indexes, NEVER .filter()
    const data = await ctx.db
      .query("tableName")
      .withIndex("by_orgId", q => q.eq("organizationId", args.orgId))
      .collect();

    return { data };
  },
});
```

### Mutation Pattern
```typescript
export const myMutation = mutation({
  args: { id: v.id("tableName"), field: v.string() },
  returns: v.object({ success: v.boolean() }),
  handler: async (ctx, args) => {
    await ctx.db.patch(args.id, { field: args.field });
    return { success: true };
  },
});
```

### Scheduled Function Pattern (NEW FOR PHASE 4)
```typescript
// In packages/backend/convex/crons.ts
import { cronJobs } from "convex/server";
import { internal } from "./_generated/api";

const crons = cronJobs();

crons.weekly(
  "adjust-thresholds",
  { dayOfWeek: "sunday", hourUTC: 2, minuteUTC: 0 },
  internal.crons.adjustPersonalizedThresholds
);

export default crons;
```

**Testing Scheduled Functions:**
- Can't test timing easily in dev
- Use Convex dashboard to trigger manually
- Logs show in Convex dashboard logs section

---

## Override Tracking Patterns (NEW FOR PHASE 4)

### Override Type Logic
```typescript
// When coach suppresses a summary:
const overrideType = summary.confidenceScore >= 0.7
  ? 'coach_rejected_high_confidence'  // AI was confident but coach disagreed
  : null;  // Suppressing low confidence is normal, not an override

// When coach approves low confidence:
if (summary.status === 'approved' && summary.confidenceScore < 0.7) {
  overrideType = 'coach_approved_low_confidence';
}

// When coach revokes auto-sent:
if (summary.wasAutoApproved && now revoked) {
  overrideType = 'coach_revoked_auto';
}

// When coach edits before sending:
if (summary was edited) {
  overrideType = 'coach_edited';
}
```

### Adaptive Threshold Calculation
```typescript
// Analyze last 30 days of coach decisions
const lowConfApprovals = overrides.filter(o =>
  o.overrideType === 'coach_approved_low_confidence' &&
  o.confidenceScore >= 0.6 && o.confidenceScore < 0.7
).length;

const highConfRejections = overrides.filter(o =>
  o.overrideType === 'coach_rejected_high_confidence' &&
  o.confidenceScore >= 0.8
).length;

const totalDecisions = overrides.length;

let adjustment = 0;

// Coach trusts AI more than default → lower threshold
if (lowConfApprovals / totalDecisions > 0.5) {
  adjustment = -0.05;  // Lower by 5%
}

// Coach is more conservative → raise threshold
if (highConfRejections / totalDecisions > 0.2) {
  adjustment = +0.05;  // Raise by 5%
}

// Apply adjustment with safety bounds
const personalizedThreshold = Math.max(0.6, Math.min(0.85,
  defaultThreshold + adjustment
));
```

### Feedback Capture (Optional, Low Friction)
```typescript
// In suppressSummary mutation
export const suppressSummary = mutation({
  args: {
    summaryId: v.id("coachParentSummaries"),
    reason: v.optional(v.string()),
    feedback: v.optional(v.object({
      wasInaccurate: v.boolean(),
      wasTooSensitive: v.boolean(),
      timingWasWrong: v.boolean(),
      otherReason: v.optional(v.string())
    }))
  },
  // ...implementation
});

// UI: Show dialog with checkboxes
// Default: "Skip" button (most common)
// Optional: "Suppress & Send Feedback" button
```

---

## Phase 3 Learnings (IMPORTANT!)

### Anthropic Prompt Caching
- Add header: `{ "anthropic-beta": "prompt-caching-2024-07-31" }`
- Cache static content (system prompts, player context)
- Don't cache varying content (insight text)
- Extract cache stats from `response.usage.cache_read_input_tokens`
- Calculate cost: `(inputTokens - cachedTokens) * 0.000005 + cachedTokens * 0.0000005 + outputTokens * 0.000015`

### AI Usage Logging
- Every AI call logged to aiUsageLog table
- Track: timestamp, orgId, coachId, playerId, operation, model, tokens, cost, cacheHitRate
- Log in action via `ctx.runMutation(internal.models.aiUsageLog.logUsage, {...})`
- Error handling: logging failure shouldn't break main operation

### Analytics Queries
- Use indexes with `.filter()` for date ranges (Convex doesn't support range queries on non-indexed fields)
- Consider pagination if >1000 entries
- Return empty structure if no data (don't throw)
- Aggregates: reduce() or manual counting

---

## Phase 4 User Stories Status

### ⏳ US-016: Add override tracking fields to coachParentSummaries
**Status:** Not started
**Files to modify:**
- packages/backend/convex/schema.ts

**Key tasks:**
1. Add overrideType: v.optional(v.union(...))
2. Add overrideReason: v.optional(v.string())
3. Add overrideFeedback: v.optional(v.object({...}))
4. Run codegen to verify

**Testing:**
- Schema compiles without errors
- Types available in _generated/api.d.ts

---

### ⏳ US-017: Capture override data in suppressSummary
**Status:** Not started
**Files to modify:**
- packages/backend/convex/models/coachParentSummaries.ts

**Key tasks:**
1. Add optional reason and feedback args to suppressSummary
2. Calculate overrideType based on confidenceScore
3. Store override data via ctx.db.patch
4. Update returns validator

**Testing:**
- Suppress high confidence → overrideType set
- Suppress low confidence → overrideType null
- Feedback optional, not required

---

### ⏳ US-018: Add optional feedback UI for suppression
**Status:** Not started
**Files to modify:**
- apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/summary-approval-card.tsx

**Key tasks:**
1. Import Dialog components from shadcn
2. Add feedback form with checkboxes and textarea
3. Wire to suppressSummary mutation
4. Make "Skip" the default action (low friction)

**Testing:**
- Click suppress → dialog appears
- Click "Skip" → suppresses without feedback
- Fill form + "Send Feedback" → feedback captured
- ESC key closes dialog

---

### ⏳ US-019: Create getCoachOverridePatterns analytics query
**Status:** Not started
**Files to create:**
- packages/backend/convex/models/coachOverrideAnalytics.ts

**Key tasks:**
1. Query coachParentSummaries where overrideType not null
2. Calculate aggregates (totalOverrides, byType, patterns)
3. Support coachId and organizationId filters
4. Add returns validator

**Testing:**
- Create test overrides manually
- Query by coachId → see patterns
- Query by organizationId → see org patterns
- Verify aggregates are correct

---

### ⏳ US-020: Implement adaptive confidence thresholds
**Status:** Not started
**Files to modify:**
- packages/backend/convex/lib/autoApprovalDecision.ts
- packages/backend/convex/schema.ts (add personalizedThreshold field)
- packages/backend/convex/crons.ts (add scheduled function)

**Key tasks:**
1. Add calculatePersonalizedThreshold function
2. Add personalizedThreshold to coachTrustLevels schema
3. Create adjustPersonalizedThresholds scheduled function
4. Use personalizedThreshold in auto-approval decision

**Testing:**
- Create override history with patterns
- Run threshold calculation manually
- Verify threshold adjusts correctly
- Test cron manually via Convex dashboard
- Verify auto-approval uses personalized threshold

---

## Known Issues & Gotchas

1. **Better Auth userId** - Always use `user.userId || user._id` fallback
2. **Optional feedback** - Don't make it mandatory, kills engagement
3. **Threshold bounds** - Clamp to [0.6, 0.85] for safety
4. **Minimum data** - Only adjust thresholds with >20 override decisions
5. **Scheduled functions** - Test manually first, timing is hard to verify
6. **Dialog UX** - "Skip" must be obvious and default
7. **Index usage** - Always use .withIndex(), NEVER .filter() alone

---

## Testing Checklist

### US-016 Testing (Schema)
- [ ] Run codegen without errors
- [ ] Verify types in _generated/api.d.ts
- [ ] Check fields added to coachParentSummaries table

### US-017 Testing (Mutation)
- [ ] Suppress high confidence summary → overrideType set
- [ ] Suppress low confidence summary → overrideType null
- [ ] Pass feedback → stored in DB
- [ ] Skip feedback → still works

### US-018 Testing (UI)
- [ ] Click suppress → dialog appears
- [ ] Click "Skip" → summary suppressed, no feedback
- [ ] Check boxes + "Send Feedback" → feedback captured
- [ ] ESC key closes dialog
- [ ] Works on mobile (responsive)

### US-019 Testing (Analytics)
- [ ] Create test overrides
- [ ] Query by coachId → see patterns
- [ ] Query by organizationId → see org patterns
- [ ] Verify aggregates correct
- [ ] Test with no overrides → empty result

### US-020 Testing (Adaptive Thresholds)
- [ ] Create coach with many low-confidence approvals → threshold lowers
- [ ] Create coach with many high-confidence rejections → threshold raises
- [ ] Verify threshold clamped to [0.6, 0.85]
- [ ] Test cron manually via Convex dashboard
- [ ] Verify auto-approval uses personalized threshold

---

## Success Criteria

Phase 4 is complete when:
- ✅ All 5 user stories implemented
- ✅ Override tracking captures coach disagreements
- ✅ Optional feedback UI works (low friction)
- ✅ Analytics query shows override patterns
- ✅ Adaptive thresholds adjust per coach
- ✅ Scheduled function runs weekly
- ✅ All quality checks passing
- ✅ No regressions in Phases 1-3

---

## Notes for Ralph

- Read P5_PHASE4_HANDOFF.md for comprehensive context
- Review prd.json for user story details
- Follow override tracking patterns above
- Use authentication pattern from Phase 2 learnings
- Test scheduled functions manually in Convex dashboard
- Keep feedback UI optional and low friction
- Update this file with progress as you complete stories
- Mark stories as passing in prd.json when done

Ready for Phase 4 execution!

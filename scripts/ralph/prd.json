{
  "project": "Voice Enhance Gating-WAPP v2",
  "branchName": "feat/voice-gateways-v2",
  "description": "Phase 7D: Retire v1 Processing & Clean Up. Remove dual-processing path so buildInsights is never scheduled when v2 is enabled. Add skipV2 parameter to prevent double artifacts from WhatsApp. Create feature flag promotion scripts and migration validation tooling.",
  "issueReference": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/phases/PHASE7D_PRD.json",
    "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "docs/architecture/voice-notes-pipeline-v2.md"
  ],
  "previousPhases": [
    "Phase 1",
    "Phase 2",
    "Phase 2.5",
    "Phase 3",
    "Phase 4",
    "Phase 5",
    "Phase 6",
    "Phase 7A",
    "Phase 7B",
    "Phase 7C"
  ],
  "currentPhase": "Phase 7D - Retire v1 Processing & Clean Up",
  "completedStories": [
    "US-VN-001",
    "US-VN-002",
    "US-VN-003",
    "US-VN-004",
    "US-VN-005",
    "US-VN-006",
    "US-VN-007",
    "US-VN-008",
    "US-VN-009",
    "US-VN-010",
    "US-VN-011",
    "US-VN-012",
    "US-VN-013",
    "US-VN-014",
    "US-VN-015",
    "US-VN-016",
    "US-VN-017",
    "US-VN-018",
    "US-VN-019",
    "US-VN-020",
    "US-VN-021",
    "US-VN-022",
    "US-VN-023",
    "US-VN-024",
    "US-VN-025",
    "US-VN-026",
    "US-VN-027"
  ],
  "criticalLearnings": {
    "description": "Lessons from Phases 1-7C that MUST be followed:",
    "patterns": [
      "ALL public queries/mutations MUST check ctx.auth.getUserIdentity() and verify artifact/data ownership",
      "NEVER accept caller-supplied userId params — derive from identity.subject",
      "Use .withIndex() for ALL queries — NEVER use .filter() on Convex query builder",
      "JavaScript array .filter() after .collect() is FINE — only Convex query .filter() is banned",
      "Use batch fetch + Map lookup to avoid N+1 queries",
      "Include args AND returns validators on ALL Convex functions",
      "Use v.optional(v.string()) NOT v.string() | null — Convex rejects null for optional fields",
      "Actions cannot access ctx.db — use ctx.runQuery/ctx.runMutation",
      "InternalActions should call internal mutations, NOT public mutations",
      "ALWAYS add imports AND usage in the SAME edit — linter removes unused imports between edits",
      "Schema changes MUST be applied and codegen run BEFORE code changes that depend on them",
      "Scripts use query/mutation/action (NOT internal variants) so they can run via 'convex run'",
      "Scripts use camelCase filenames (e.g., enableV2ForOrg.ts)"
    ]
  },
  "existingInfrastructure": {
    "description": "Key functions that Phase 7D modifies or depends on:",
    "keyFunctions": [
      "voiceNotes.ts: createTypedNote — has useV2 check from Phase 7A, STILL unconditionally schedules buildInsights → GATE IT",
      "voiceNotes.ts: createRecordedNote — has useV2 check from Phase 7A, schedules transcribeAudio (NOT buildInsights directly)",
      "voiceNotes.ts (actions): transcribeAudio — has artifact check, STILL unconditionally schedules buildInsights → GATE IT",
      "voiceNotes.ts (actions): buildInsights — has defense-in-depth artifact check from Phase 7A US-VN-023",
      "whatsapp.ts: processAudioMessage — creates artifact, calls createRecordedNote → needs skipV2:true",
      "whatsapp.ts: processTextMessage — creates artifact, calls createTypedNote → needs skipV2:true",
      "featureFlags.ts: shouldUseV2Pipeline — internalQuery, cascade: env→platform→org→user→false",
      "featureFlags.ts: setFeatureFlag — internalMutation, used by enableV2ForOrg script",
      "migration.ts: migrateVoiceNotesToV2 — internalAction, needs public wrapper for 'convex run'"
    ]
  },
  "criticalWarning": "READ scripts/ralph/prds/voice-gateways-v2/phases/PHASE7D_PRD.json FIRST — it contains verified code locations, the double-artifact problem analysis, and step-by-step instructions. The stories below are summaries.",
  "userStories": [
    {
      "id": "US-VN-028",
      "phase": "7D",
      "title": "Remove Dual Processing Path",
      "description": "Gate buildInsights scheduling so it NEVER runs when v2 is active. Add skipV2 param to createTypedNote/createRecordedNote so WhatsApp callers don't create double artifacts.",
      "acceptanceCriteria": [
        "=== FULL DETAILS IN: scripts/ralph/prds/voice-gateways-v2/phases/PHASE7D_PRD.json ===",
        "",
        "4 CHANGES:",
        "1. createTypedNote: wrap buildInsights in if (!useV2) — reuse existing useV2 variable",
        "2. transcribeAudio: wrap buildInsights in if (artifacts.length === 0) — reuse existing artifacts variable",
        "3. Add skipV2: v.optional(v.boolean()) to createTypedNote & createRecordedNote, pass from WhatsApp callers",
        "4. Update defense-in-depth log in buildInsights to say 'Defense-in-depth'",
        "",
        "CRITICAL: Do NOT call shouldUseV2Pipeline twice — reuse the useV2 variable from Phase 7A",
        "CRITICAL: Quality gate checks MUST stay BEFORE buildInsights gating in transcribeAudio",
        "CRITICAL: skipV2 on public API is simpler than needing internal versions"
      ],
      "priority": 28,
      "passes": true,
      "effort": "1.5 days",
      "dependencies": ["US-VN-026", "US-VN-027"],
      "files": {
        "create": [],
        "modify": [
          "packages/backend/convex/models/voiceNotes.ts",
          "packages/backend/convex/actions/voiceNotes.ts",
          "packages/backend/convex/actions/whatsapp.ts"
        ]
      }
    },
    {
      "id": "US-VN-029",
      "phase": "7D",
      "title": "Feature Flag Promotion Tooling & Migration Validation",
      "description": "Create 4 Convex scripts: enableV2ForOrg, disableV2ForOrg, v2MigrationStatus, runMigration. Validate existing migration.ts.",
      "acceptanceCriteria": [
        "=== FULL DETAILS IN: scripts/ralph/prds/voice-gateways-v2/phases/PHASE7D_PRD.json ===",
        "",
        "4 SCRIPTS TO CREATE:",
        "1. enableV2ForOrg.ts — mutation that enables voice_notes_v2 + entity_resolution_v2 flags for an org",
        "2. disableV2ForOrg.ts — mutation that disables both flags (rollback)",
        "3. v2MigrationStatus.ts — query that reports counts across all v2 tables for an org",
        "4. runMigration.ts — public action wrapper around internal migrateVoiceNotesToV2",
        "",
        "PATTERNS: Scripts use camelCase filenames, export query/mutation/action (NOT internal)",
        "v2MigrationStatus may use JS array .filter() after .collect() for tables without org indexes"
      ],
      "priority": 29,
      "passes": true,
      "effort": "1.5 days",
      "dependencies": ["US-VN-028"],
      "files": {
        "create": [
          "packages/backend/convex/scripts/enableV2ForOrg.ts",
          "packages/backend/convex/scripts/disableV2ForOrg.ts",
          "packages/backend/convex/scripts/v2MigrationStatus.ts",
          "packages/backend/convex/scripts/runMigration.ts"
        ],
        "modify": ["packages/backend/convex/actions/migration.ts"]
      }
    }
  ],
  "successCriteria": {
    "noDualProcessing": "With v2 ON, buildInsights is never scheduled — only extractClaims runs",
    "v1FallbackWorks": "With v2 OFF, buildInsights runs exactly as before, no artifacts created",
    "noDuplicateArtifacts": "WhatsApp path creates ONE artifact (skipV2 prevents double)",
    "defenseInDepthKept": "buildInsights still has artifact-exists check as safety net",
    "enableDisableScripts": "enableV2ForOrg/disableV2ForOrg toggle both flags for an org",
    "migrationStatusWorks": "v2MigrationStatus returns accurate counts for all v2 tables",
    "migrationScriptAccessible": "runMigration wrapper allows 'convex run' of internal migration action",
    "typeCheckPasses": "npm run check-types passes with 0 errors"
  },
  "ralphInstructions": {
    "executionMode": "sequential",
    "storyOrder": ["US-VN-028", "US-VN-029"],
    "contextToRead": [
      "scripts/ralph/prds/voice-gateways-v2/phases/PHASE7D_PRD.json — PRIMARY: full implementation details",
      "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md — v1 vs v2 architecture",
      "packages/backend/convex/models/voiceNotes.ts — createTypedNote/createRecordedNote to modify",
      "packages/backend/convex/actions/voiceNotes.ts — transcribeAudio + buildInsights to modify",
      "packages/backend/convex/actions/whatsapp.ts — processAudioMessage + processTextMessage to modify",
      "packages/backend/convex/lib/featureFlags.ts — shouldUseV2Pipeline + setFeatureFlag signatures",
      "packages/backend/convex/actions/migration.ts — existing migration script to validate + wrap"
    ],
    "implementationOrder": [
      "1. Read createTypedNote — find useV2 variable, wrap buildInsights in if (!useV2)",
      "2. Read transcribeAudio — find artifacts variable, wrap buildInsights in if (artifacts.length === 0)",
      "3. Add skipV2: v.optional(v.boolean()) to createTypedNote args + handler",
      "4. Add skipV2: v.optional(v.boolean()) to createRecordedNote args + handler",
      "5. Update whatsapp.ts processTextMessage to pass skipV2: true",
      "6. Update whatsapp.ts processAudioMessage to pass skipV2: true",
      "7. Update buildInsights defense-in-depth log message",
      "8. Type check",
      "9. Create enableV2ForOrg.ts script",
      "10. Create disableV2ForOrg.ts script",
      "11. Create v2MigrationStatus.ts script",
      "12. Create runMigration.ts wrapper script",
      "13. Add usage docs to migration.ts",
      "14. Type check"
    ],
    "testingStrategy": "Manual testing — enable/disable v2 via scripts, create notes, verify correct pipeline runs",
    "qualityCriteria": "npm run check-types passes, npx -w packages/backend convex codegen succeeds"
  }
}

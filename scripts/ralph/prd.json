{
  "project": "Onboarding Phase 4 - Toast Notifications for Existing Users",
  "branchName": "ralph/onboarding-phase-4",
  "description": "Real-time toast notifications when roles are granted to logged-in users. Admin and Coach role grants use toast only (no modal). Includes notification database table, real-time subscription, and staggered display.",
  "relatedIssues": ["#371", "#335"],
  "dependencies": ["phase-1-foundation", "phase-3-child-linking"],
  "userStories": [
    {
      "id": "US-001",
      "title": "Create notifications table in schema",
      "description": "As the system, I store notifications for users including role grants, team assignments, and admin alerts.",
      "priority": 1,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Add new table notifications:",
        "",
        "notifications: defineTable({",
        "  userId: v.string(),",
        "  organizationId: v.string(),",
        "  type: v.union(",
        "    v.literal('role_granted'),",
        "    v.literal('team_assigned'),",
        "    v.literal('team_removed'),",
        "    v.literal('child_declined'),",
        "    v.literal('invitation_request')",
        "  ),",
        "  title: v.string(),",
        "  message: v.string(),",
        "  link: v.optional(v.string()),",
        "  createdAt: v.number(),",
        "  seenAt: v.optional(v.number()),",
        "  dismissedAt: v.optional(v.number()),",
        "})",
        "  .index('by_user_unseen', ['userId', 'seenAt'])",
        "  .index('by_user_created', ['userId', 'createdAt'])",
        "  .index('by_org_type', ['organizationId', 'type']),",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types",
        "Verify in Convex dashboard that notifications table exists with indexes"
      ],
      "notes": "seenAt being null means the notification hasn't been seen yet. dismissedAt tracks when user manually dismissed."
    },
    {
      "id": "US-002",
      "title": "Create notification queries and mutations",
      "description": "As the system, I can query unseen notifications and mark them as seen/dismissed.",
      "priority": 2,
      "passes": true,
      "acceptanceCriteria": [
        "Create: packages/backend/convex/models/notifications.ts",
        "",
        "Query: getUnseenNotifications",
        "Args: none (uses authenticated user)",
        "Returns: v.array(v.object({ _id, type, title, message, link, createdAt }))",
        "Logic: Query notifications where userId = user.id AND seenAt = undefined, order by createdAt desc",
        "",
        "Query: getRecentNotifications",
        "Args: { limit: v.optional(v.number()) }",
        "Returns: v.array(Notification)",
        "Logic: Query notifications where userId = user.id, order by createdAt desc, take limit (default 20)",
        "",
        "Mutation: markNotificationSeen",
        "Args: { notificationId: v.id('notifications') }",
        "Returns: v.null()",
        "Logic: Update notification seenAt = Date.now()",
        "",
        "Mutation: markAllNotificationsSeen",
        "Args: none (uses authenticated user)",
        "Returns: v.null()",
        "Logic: Update all unseen notifications for user with seenAt = Date.now()",
        "",
        "Mutation: dismissNotification",
        "Args: { notificationId: v.id('notifications') }",
        "Returns: v.null()",
        "Logic: Update notification dismissedAt = Date.now()",
        "",
        "Mutation: createNotification (internal)",
        "Args: { userId, organizationId, type, title, message, link }",
        "Returns: v.id('notifications')",
        "Logic: Insert notification with createdAt = Date.now()",
        "",
        "Run: npm run check-types"
      ],
      "notes": "createNotification should be internal only - called by other mutations, not directly by frontend."
    },
    {
      "id": "US-003",
      "title": "Create NotificationProvider component with real-time subscription",
      "description": "As a logged-in user, I receive real-time notifications via a provider that subscribes to my unseen notifications.",
      "priority": 3,
      "passes": true,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/notification-provider.tsx",
        "",
        "Component structure:",
        "export function NotificationProvider({ children }: { children: React.ReactNode }) {",
        "  const { data: session } = useSession();",
        "  const notifications = useQuery(",
        "    api.models.notifications.getUnseenNotifications,",
        "    session?.user ? {} : 'skip'",
        "  );",
        "  const [displayedIds, setDisplayedIds] = useState<Set<string>>(new Set());",
        "  const markSeen = useMutation(api.models.notifications.markNotificationSeen);",
        "",
        "  useEffect(() => {",
        "    if (!notifications) return;",
        "    ",
        "    // Find new notifications not yet displayed",
        "    const newNotifications = notifications.filter(n => !displayedIds.has(n._id));",
        "    ",
        "    // Display staggered toasts",
        "    newNotifications.forEach((notification, index) => {",
        "      setTimeout(() => {",
        "        showNotificationToast(notification);",
        "        setDisplayedIds(prev => new Set([...prev, notification._id]));",
        "        markSeen({ notificationId: notification._id });",
        "      }, index * 500);  // 500ms stagger",
        "    });",
        "  }, [notifications]);",
        "",
        "  return <>{children}</>;",
        "}",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Staggering prevents overwhelming the user when multiple notifications arrive at once."
    },
    {
      "id": "US-004",
      "title": "Create NotificationToast component",
      "description": "As a user receiving a notification, I see a styled toast with title, message, and optional link.",
      "priority": 4,
      "passes": true,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/notification-toast.tsx",
        "",
        "Create function showNotificationToast(notification: Notification) {",
        "  toast(notification.title, {",
        "    description: notification.message,",
        "    duration: 5000,  // 5 seconds auto-dismiss",
        "    action: notification.link ? {",
        "      label: 'View',",
        "      onClick: () => router.push(notification.link)",
        "    } : undefined,",
        "  });",
        "}",
        "",
        "Export the function for use by NotificationProvider",
        "",
        "Toast styling:",
        "  - Uses Sonner toast (already in project)",
        "  - Title in bold",
        "  - Description as secondary text",
        "  - Action button on right if link provided",
        "  - Auto-dismisses after 5 seconds",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Sonner is already used in the project via @/components/ui/sonner. Reuse existing toast patterns."
    },
    {
      "id": "US-005",
      "title": "Integrate NotificationProvider into app layout",
      "description": "As the system, I wrap the app with NotificationProvider so all authenticated users receive real-time notifications.",
      "priority": 5,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: apps/web/src/app/orgs/[orgId]/layout.tsx",
        "Import NotificationProvider from '@/components/notification-provider'",
        "",
        "Wrap children with NotificationProvider (inside OnboardingOrchestrator):",
        "return (",
        "  <OrgThemeProvider>",
        "    <OnboardingOrchestrator>",
        "      <NotificationProvider>",
        "        {children}",
        "      </NotificationProvider>",
        "    </OnboardingOrchestrator>",
        "  </OrgThemeProvider>",
        ");",
        "",
        "Run: npm run check-types",
        "Test: Log in as user → Grant role from another browser/admin → Toast appears immediately"
      ],
      "notes": "NotificationProvider needs to be inside auth context to access the authenticated user."
    },
    {
      "id": "US-006",
      "title": "Trigger notifications on role grant",
      "description": "As a user granted a new role, I receive a notification when an admin grants me admin or coach role.",
      "priority": 6,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/members.ts",
        "Import createNotification from notifications.ts",
        "",
        "In grantFunctionalRole mutation (or wherever roles are granted):",
        "After successfully granting role, add:",
        "",
        "if (role === 'Admin' || role === 'Coach') {",
        "  await createNotification(ctx, {",
        "    userId: targetUserId,",
        "    organizationId: orgId,",
        "    type: 'role_granted',",
        "    title: `New Role: ${role}`,",
        "    message: `You have been granted ${role} access to ${organizationName}`,",
        "    link: role === 'Coach' ",
        "      ? `/orgs/${orgId}/coach/dashboard`",
        "      : `/orgs/${orgId}/admin/dashboard`,",
        "  });",
        "}",
        "",
        "Run: npm run check-types",
        "Test: Admin grants Coach role to user → User sees toast 'New Role: Coach'"
      ],
      "notes": "Parent role grants trigger the Child Linking modal (Phase 3), not a toast. Only Admin/Coach use toast."
    },
    {
      "id": "US-007",
      "title": "Trigger notifications on team assignment",
      "description": "As a coach assigned to a team, I receive a notification about my new team assignment.",
      "priority": 7,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/coachAssignments.ts",
        "Import createNotification from notifications.ts",
        "",
        "In assignCoachToTeam mutation:",
        "After successfully creating the assignment, add:",
        "",
        "await createNotification(ctx, {",
        "  userId: coachUserId,",
        "  organizationId: orgId,",
        "  type: 'team_assigned',",
        "  title: 'Team Assignment',",
        "  message: `You have been assigned to ${teamName}`,",
        "  link: `/orgs/${orgId}/teams/${teamId}`,",
        "});",
        "",
        "In removeCoachFromTeam mutation:",
        "After successfully removing the assignment, add:",
        "",
        "await createNotification(ctx, {",
        "  userId: coachUserId,",
        "  organizationId: orgId,",
        "  type: 'team_removed',",
        "  title: 'Team Update',",
        "  message: `You have been removed from ${teamName}`,",
        "  link: `/orgs/${orgId}/coach/dashboard`,",
        "});",
        "",
        "Run: npm run check-types",
        "Test: Admin assigns coach to team → Coach sees toast 'Team Assignment'"
      ],
      "notes": "team_removed notifications help coaches stay aware of changes without checking dashboard constantly."
    },
    {
      "id": "US-008",
      "title": "Trigger admin notifications for invitation requests",
      "description": "As an admin, I receive a notification when a user requests a new invitation.",
      "priority": 8,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/invitations.ts",
        "In createInvitationRequest mutation (from Phase 1B):",
        "After creating the request record, add:",
        "",
        "// Notify org admins",
        "const admins = await getOrganizationAdmins(ctx, orgId);",
        "for (const admin of admins) {",
        "  await createNotification(ctx, {",
        "    userId: admin.userId,",
        "    organizationId: orgId,",
        "    type: 'invitation_request',",
        "    title: 'New Invitation Request',",
        "    message: `${userEmail} is requesting a new invitation`,",
        "    link: `/orgs/${orgId}/admin/invitations?tab=requests`,",
        "  });",
        "}",
        "",
        "Run: npm run check-types",
        "Test: User clicks expired link → Requests new invitation → Admin sees toast"
      ],
      "notes": "getOrganizationAdmins helper may need to be created if it doesn't exist."
    },
    {
      "id": "US-009",
      "title": "Handle offline notification delivery",
      "description": "As a user who was offline when a notification was created, I see the notification toast when I log in.",
      "priority": 9,
      "passes": true,
      "acceptanceCriteria": [
        "The NotificationProvider already handles this:",
        "- On mount, useQuery fetches all unseen notifications",
        "- These are displayed as toasts (staggered)",
        "- Each is marked as seen after display",
        "",
        "Test this flow:",
        "1. User A logs out or closes browser",
        "2. Admin grants Coach role to User A",
        "3. User A logs back in",
        "4. Verify: Toast appears showing 'New Role: Coach'",
        "",
        "For multiple accumulated notifications:",
        "- Verify staggering works (500ms between each)",
        "- Verify none are missed",
        "- Verify all are marked as seen after display",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This is primarily a testing story to verify the offline-to-online flow works correctly."
    }
  ],
  "verificationSteps": [
    "npm run check-types",
    "npx -w packages/backend convex codegen",
    "Test: User A logged in → Admin grants Coach role → Toast appears immediately",
    "Test: User A logged out → Admin grants Coach role → User A logs in → Toast appears",
    "Test: Grant 3 roles while user offline → User logs in → 3 toasts appear (staggered)",
    "Test: Parent declines child → Admin sees toast",
    "Test: Click 'View' in toast → Navigates to correct dashboard"
  ],
  "successCriteria": [
    "Logged-in user sees toast immediately when granted new role",
    "Toast shows role and organization name",
    "Toast includes link to relevant dashboard",
    "Offline notifications shown on login",
    "Notifications marked as seen after display",
    "Multiple notifications shown staggered",
    "Admins receive toast when parent declines child link",
    "Admins receive toast when user requests new invitation"
  ]
}

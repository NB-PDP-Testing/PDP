{
  "project": "Convex Performance Fix - Phase 4: Frontend ChildCard Refactor",
  "branchName": "johnobr/fixconvex",
  "description": "Day 4: Create bulk backend queries and refactor ChildCard component to eliminate 5 useQuery calls per child. Expected: 80% reduction in parent dashboard queries.",
  "readinessLevel": "100%",
  "prerequisitesCompleted": {
    "status": "Depends on Phase 1-3",
    "completedWork": [
      "Phase 1: Schema indexes added",
      "Phase 2: Backend N+1 patterns fixed",
      "Phase 3: Filter violations fixed, production deployed"
    ],
    "documentationReferences": [
      "GitHub Issue #330 - Convex Performance Crisis",
      "Plan file - Full implementation details"
    ]
  },
  "contextAndDependencies": {
    "targetMetric": "80% reduction in parent dashboard queries (25 → 5 for 5 children)",
    "keyFiles": [
      "packages/backend/convex/models/orgPlayerEnrollments.ts - Add getBulkChildData query",
      "apps/web/src/app/orgs/[orgId]/parents/components/child-card.tsx - Lines 158-186",
      "apps/web/src/app/orgs/[orgId]/parents/page.tsx - Query lifting"
    ],
    "criticalPatterns": {
      "Query_Lifting": "Move queries from child components to parent, pass data as props",
      "Bulk_Query": "Single query returns all data for multiple entities"
    }
  },
  "userStories": [
    {
      "id": "US-PERF-014",
      "title": "Create getBulkChildData Backend Query",
      "description": "Create a bulk query that fetches passport, injuries, goals, and medical profile for multiple children in one call.",
      "phase": "Phase 4: Frontend",
      "acceptanceCriteria": [
        "Open packages/backend/convex/models/orgPlayerEnrollments.ts (or create new file)",
        "Create new query: getBulkChildData",
        "Args: { playerIdentityIds: v.array(v.id('playerIdentities')), organizationId: v.string() }",
        "Returns: Map of playerIdentityId to child data object containing:",
        "  - passport: SportPassport | null",
        "  - activeInjuries: PlayerInjury[]",
        "  - activeGoals: PassportGoal[]",
        "  - medicalProfile: MedicalProfile | null",
        "Use batch fetching pattern:",
        "  1. Fetch all passports for playerIdentityIds in one query",
        "  2. Fetch all injuries for playerIdentityIds in one query",
        "  3. Fetch all goals for playerIdentityIds in one query",
        "  4. Fetch all medical profiles in one query",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types",
        "Test in Convex dashboard with real playerIdentityIds"
      ],
      "technicalNotes": {
        "returnType": "v.record(v.string(), v.object({ passport: v.union(passportValidator, v.null()), activeInjuries: v.array(injuryValidator), activeGoals: v.array(goalValidator), medicalProfile: v.union(medicalProfileValidator, v.null()) }))",
        "queryPattern": "For each data type, query by playerIdentityId index, collect all, then group by playerIdentityId in JS",
        "performance": "4 queries total instead of 5 * N queries (where N = number of children)"
      },
      "priority": 1,
      "passes": true,
      "notes": "This is the foundation query for the ChildCard refactor. Must be complete before UI changes."
    },
    {
      "id": "US-PERF-015",
      "title": "Refactor Parent Dashboard to Use Bulk Query",
      "description": "Modify parent dashboard page to fetch all children data at page level using getBulkChildData.",
      "phase": "Phase 4: Frontend",
      "acceptanceCriteria": [
        "Open apps/web/src/app/orgs/[orgId]/parents/page.tsx",
        "Add useQuery call to getBulkChildData with all children's playerIdentityIds",
        "Pass the bulk data to ChildCard components as props",
        "Handle loading state at page level (single loading skeleton for all children)",
        "Handle error state at page level",
        "Run: npm run check-types",
        "Run: npm run build",
        "Visual test: Parent dashboard loads all children together"
      ],
      "technicalNotes": {
        "currentPattern": "children.map(child => <ChildCard childId={child._id} />)",
        "newPattern": "const bulkData = useQuery(api.models.orgPlayerEnrollments.getBulkChildData, { playerIdentityIds, organizationId }); children.map(child => <ChildCard childData={bulkData?.[child.playerIdentityId]} />)",
        "loadingState": "if (bulkData === undefined) return <ParentDashboardSkeleton />"
      },
      "priority": 2,
      "passes": false,
      "notes": "Depends on US-PERF-014. Query lifting pattern."
    },
    {
      "id": "US-PERF-016",
      "title": "Refactor ChildCard to Receive Props",
      "description": "Modify ChildCard component to receive data as props instead of making 5 useQuery calls.",
      "phase": "Phase 4: Frontend",
      "acceptanceCriteria": [
        "Open apps/web/src/app/orgs/[orgId]/parents/components/child-card.tsx",
        "Change props interface to receive pre-fetched data:",
        "  - child: ChildEnrollment",
        "  - passport: SportPassport | null",
        "  - activeInjuries: PlayerInjury[]",
        "  - activeGoals: PassportGoal[]",
        "  - medicalProfile: MedicalProfile | null",
        "Remove the 5 useQuery calls at lines 158-186",
        "Use props directly instead of query results",
        "Handle undefined/null cases appropriately",
        "Run: npm run check-types",
        "Run: npm run build",
        "Visual test: ChildCard displays all data correctly"
      ],
      "technicalNotes": {
        "currentCode": "const passport = useQuery(api.models.sportPassports.getPassportForPlayer, {...}); const injuries = useQuery(api.models.playerInjuries.getActiveInjuriesForPlayer, {...}); // etc",
        "newCode": "// Props: { child, passport, activeInjuries, activeGoals, medicalProfile } - use directly",
        "location": "apps/web/src/app/orgs/[orgId]/parents/components/child-card.tsx lines 158-186"
      },
      "priority": 3,
      "passes": false,
      "notes": "Depends on US-PERF-015. This eliminates 5 useQuery calls per child."
    },
    {
      "id": "US-PERF-017",
      "title": "Verify Parent Dashboard Performance",
      "description": "Test and verify the refactored parent dashboard performs correctly with reduced queries.",
      "phase": "Phase 4: Frontend",
      "acceptanceCriteria": [
        "Login as parent with 1 child - verify displays correctly",
        "Login as parent with 3+ children - verify all display correctly",
        "Check that passport data, injuries, goals, medical profile all show",
        "Check Convex logs: should see bulk queries, not 5 per child",
        "Performance: Parent dashboard with 5 children should load in < 2 seconds",
        "No visible loading states per child (all load together)",
        "Compare data displayed to direct database queries - verify accuracy"
      ],
      "technicalNotes": {
        "testAccounts": "Use existing parent test accounts or create new ones",
        "convexLogs": "Check for getBulkChildData calls instead of individual getPassportForPlayer, getActiveInjuriesForPlayer, etc.",
        "performance": "Should see dramatic reduction in Convex function calls on parent dashboard"
      },
      "priority": 4,
      "passes": false,
      "notes": "Verification story - ensure refactor works correctly before moving on"
    }
  ],
  "qualityChecks": {
    "beforeCommitting": [
      "npx -w packages/backend convex codegen - MUST succeed",
      "npm run check-types - MUST pass",
      "npm run build - Full build test",
      "npm run check - Lint check"
    ],
    "testingStrategy": {
      "US-PERF-014": "Test query in Convex dashboard with real data",
      "US-PERF-015-016": "Visual test parent dashboard with various child counts",
      "US-PERF-017": "Full regression test of parent dashboard functionality"
    }
  },
  "phaseCompletionCriteria": [
    "getBulkChildData query created and working",
    "Parent dashboard uses bulk query",
    "ChildCard receives props instead of querying",
    "All data displays correctly",
    "Function calls for parent dashboard drop 80%",
    "Type checks pass",
    "Build passes"
  ],
  "expectedImpact": {
    "callsReduced": "~200K calls saved",
    "queryReduction": "25 queries → 5 queries for 5 children (80% reduction)"
  },
  "nextPhase": {
    "name": "Phase 5: Additional Optimizations",
    "file": "phase5-additional.prd.json",
    "description": "getCurrentUser caching, getPlayersForCoach, query skipping"
  }
}

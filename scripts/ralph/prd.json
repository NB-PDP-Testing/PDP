{
  "project": "Voice Enhance Gating-WAPP v2",
  "branchName": "feat/voice-gateways-v2",
  "description": "Phase 5: Entity Resolution & Disambiguation. Resolve ambiguous player mentions from voice note claims using fuzzy matching, coach aliases, and trust-adaptive thresholds. Includes disambiguation UI for coaches.",
  "issueReference": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE5_ENTITY_RESOLUTION.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE5_ENHANCEMENTS_CATALOG.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE3_V2_MIGRATION.md",
    "docs/architecture/voice-notes-pipeline-v2.md"
  ],
  "previousPhases": ["Phase 1", "Phase 2", "Phase 2.5", "Phase 3", "Phase 4"],
  "currentPhase": "Phase 5 - Entity Resolution & Disambiguation",
  "completedStories": [
    "US-VN-001",
    "US-VN-002",
    "US-VN-003",
    "US-VN-004",
    "US-VN-005",
    "US-VN-006",
    "US-VN-007",
    "US-VN-008",
    "US-VN-009",
    "US-VN-010",
    "US-VN-011",
    "US-VN-012",
    "US-VN-013",
    "US-VN-014",
    "US-VN-015",
    "US-VN-016",
    "US-VN-017"
  ],
  "enhancements": {
    "included": [
      "E1: Trust-adaptive auto-resolve threshold (use coach's personalized insightConfidenceThreshold instead of hardcoded 0.9)",
      "E2: Feature flag gating (entity_resolution_v2 flag with cascade evaluation via shouldUseEntityResolution)",
      "E3: Disambiguation analytics events (log disambiguate_accept/reject_all/skip via existing reviewAnalytics)",
      "E4: Rich matchReason on candidates (irish_alias, exact_first_name, fuzzy_full_name, etc.)",
      "E5: Coach alias learning (coachPlayerAliases table — resolve once, remember forever)",
      "E6: Batch same-name resolution (group mentions by rawText, resolve all at once)"
    ],
    "deferred": [
      "E7: WhatsApp disambiguation notification (Phase 5.5)",
      "E8: WhatsApp inline disambiguation (Phase 5.5)",
      "E9: Snooze for disambiguation (Phase 5.5)",
      "E10: Review microsite integration (Phase 5.5)",
      "E11: Mention frequency tracking (Phase 6+)",
      "E12: Category-aware auto-resolve rules (Phase 6+)"
    ],
    "catalog": "context/PHASE5_ENHANCEMENTS_CATALOG.md"
  },
  "preImplementationChanges": {
    "description": "These code changes were already applied during architecture review (before Ralph starts):",
    "changes": [
      "C2: schema.ts + reviewAnalytics.ts — linkCode now v.optional(v.string()), added disambiguate_accept/reject_all/skip event types",
      "C3: featureFlags.ts — added shouldUseEntityResolution internalQuery with cascade evaluation (returns boolean)"
    ]
  },
  "userStories": [
    {
      "id": "US-VN-017",
      "phase": 5,
      "title": "Entity Resolution Table, Aliases & Action",
      "description": "Create voiceNoteEntityResolutions table, coachPlayerAliases table, and implement entity resolution logic with 6 enhancements: trust-adaptive thresholds, feature flag gating, analytics events, rich matchReason, coach alias learning, and batch same-name resolution. Phase 4 already populates resolvedPlayerIdentityId on claims using fuzzy matching (0.85 threshold). Phase 5 creates DETAILED resolution records for claims where Phase 4 could not auto-resolve, capturing multiple candidates with match reasons for disambiguation.",
      "acceptanceCriteria": [
        "--- SCHEMA: voiceNoteEntityResolutions ---",
        "Backend: Add voiceNoteEntityResolutions table to schema.ts",
        "Schema fields:",
        "  - claimId: v.id('voiceNoteClaims')",
        "  - artifactId: v.id('voiceNoteArtifacts') (denormalized for efficient querying)",
        "  - mentionIndex: v.number() (position in entityMentions array)",
        "  - mentionType: v.union('player_name', 'team_name', 'group_reference', 'coach_name')",
        "  - rawText: v.string() (e.g., 'Shawn')",
        "  - candidates: v.array(v.object({ entityType, entityId, entityName, score, matchReason }))",
        "  - status: v.union('auto_resolved', 'needs_disambiguation', 'user_resolved', 'unresolved')",
        "  - resolvedEntityId: v.optional(v.string())",
        "  - resolvedEntityName: v.optional(v.string())",
        "  - resolvedAt: v.optional(v.number())",
        "  - organizationId: v.string() (denormalized for auth filtering)",
        "  - createdAt: v.number()",
        "Indexes: by_claimId, by_artifactId, by_artifactId_and_status, by_org_and_status (4 indexes — NO by_status to avoid unbounded table scans, per ADR-VN2-022)",
        "",
        "--- SCHEMA: coachPlayerAliases (Enhancement E5) ---",
        "Backend: Add coachPlayerAliases table to schema.ts",
        "Schema fields:",
        "  - coachUserId: v.string()",
        "  - organizationId: v.string()",
        "  - rawText: v.string() (normalized lowercase, e.g., 'shawn')",
        "  - resolvedEntityId: v.string() (playerIdentityId)",
        "  - resolvedEntityName: v.string() (e.g., 'Sean O'Brien')",
        "  - useCount: v.number() (times this alias auto-resolved)",
        "  - lastUsedAt: v.number()",
        "  - createdAt: v.number()",
        "Indexes:",
        "  - by_coach_org_rawText: ['coachUserId', 'organizationId', 'rawText']",
        "  - by_coach_org: ['coachUserId', 'organizationId']",
        "",
        "--- ACTION: entityResolution.ts ---",
        "Backend: Create actions/entityResolution.ts",
        "Function: resolveEntities (internalAction)",
        "  args: { artifactId: v.id('voiceNoteArtifacts') }",
        "  returns: v.null()",
        "  Logic:",
        "    1. Get artifact to determine organizationId and coachUserId",
        "    2. [E2] Check feature flag: ctx.runQuery(internal.lib.featureFlags.shouldUseEntityResolution, { organizationId, userId: coachUserId }). If false, return null early",
        "    3. Get claims with status='extracted' for this artifactId (Phase 4 creates claims as 'extracted')",
        "    4. SKIP claims where resolvedPlayerIdentityId is already set (Phase 4 already resolved these)",
        "    5. [E1] Fetch coach trust level: ctx.runQuery(internal.models.coachTrustLevels.getCoachTrustLevelInternal, { coachId: coachUserId }). Use insightConfidenceThreshold as auto-resolve threshold (fallback 0.9 if no trust data)",
        "    6. [E6] Group entity mentions by normalized rawText across all unresolved claims. Track Map<normalizedName, Array<{claimId, mentionIndex}>>",
        "    7. [E5] For each unique player_name: FIRST check coachPlayerAliases for an existing alias. If found, auto-resolve ALL mentions of that name (status='auto_resolved', matchReason='coach_alias'), increment alias useCount. Skip fuzzy matching for this name.",
        "    8. For remaining unresolved unique player_names: BATCH call ctx.runQuery(internal.models.orgPlayerEnrollments.findSimilarPlayers, { limit: 5 }) once per unique name. Store in Map<rawText, SimilarPlayerResult[]>",
        "    9. [E4] For each candidate, compute rich matchReason by checking: irish_alias (ALIAS_TO_CANONICAL match), exact_first_name, fuzzy_full_name, fuzzy_first_name, last_name_match, reversed_name, partial_match. Append '+team_context' if team bonus applied",
        "    10. For each unresolved claim, for each entityMention:",
        "       - player_name: Look up candidates from Map. If 1 candidate with score >= trust threshold \u2192 'auto_resolved'. If >1 candidates \u2192 'needs_disambiguation'. If 0 \u2192 'unresolved'",
        "       - team_name: Match against coachContext.teams by name \u2192 auto_resolved or unresolved",
        "       - group_reference: Always 'unresolved' (Phase 6 handles group expansion)",
        "       - coach_name: Match against coachContext.coaches by name \u2192 auto_resolved or unresolved",
        "    11. [E6] For batch resolution: when storing, apply same resolution to ALL mentions in the same rawText group",
        "    12. Store all resolutions via batch internalMutation (storeResolutions)",
        "    13. Update claim statuses: all auto_resolved \u2192 claim 'resolved'; any needs_disambiguation \u2192 claim 'needs_disambiguation'; all unresolved \u2192 claim 'needs_disambiguation'",
        "    14. Log counts via console.info (auto_resolved, needs_disambiguation, unresolved, alias_hits)",
        "",
        "--- MODEL: voiceNoteEntityResolutions.ts ---",
        "Backend: Create models/voiceNoteEntityResolutions.ts",
        "Functions (5 internal + 3 public):",
        "  - storeResolutions (internalMutation): Batch insert, args: { resolutions: array }, returns: array of IDs",
        "  - getResolutionsByArtifact (internalQuery): args: { artifactId }, returns: array",
        "  - getResolutionsByArtifactAndStatus (internalQuery): args: { artifactId, status }, returns: array",
        "  - updateResolutionStatus (internalMutation): args: { resolutionId, status, resolvedEntityId?, resolvedEntityName? }, returns: null",
        "  - batchUpdateResolutionsByRawText (internalMutation): For E6 \u2014 update all resolutions in artifact with matching rawText. args: { artifactId, rawText, status, resolvedEntityId, resolvedEntityName }",
        "  - getResolutionsByClaim (query - PUBLIC with auth): args: { claimId }, returns: array",
        "  - getDisambiguationQueue (query - PUBLIC with auth): args: { organizationId, limit? }, returns: needs_disambiguation resolutions",
        "  - resolveEntity (mutation - PUBLIC with auth): args: { resolutionId, resolvedEntityId, resolvedEntityName }, returns: null. Sets user_resolved + resolvedAt. ALSO: [E5] stores coach alias, [E6] batch-resolves same rawText in artifact, [E3] logs analytics event",
        "",
        "--- MODEL: coachPlayerAliases.ts (Enhancement E5) ---",
        "Backend: Create models/coachPlayerAliases.ts",
        "Functions (2 internal + 1 public):",
        "  - lookupAlias (internalQuery): args: { coachUserId, organizationId, rawText }, returns: alias or null. Normalizes rawText to lowercase before lookup",
        "  - storeAlias (internalMutation): args: { coachUserId, organizationId, rawText, resolvedEntityId, resolvedEntityName }. Upserts: if exists, increment useCount + update lastUsedAt. If not, create new. Normalizes rawText to lowercase",
        "  - getCoachAliases (query - PUBLIC with auth): args: { organizationId }, returns: array of aliases for authenticated coach. For future admin view",
        "",
        "--- INTEGRATION ---",
        "Integration: Schedule from claimsExtraction.ts (NOT claimProcessing.ts which does not exist)",
        "  - In extractClaims handler, after storeClaims (line ~563):",
        "  - [E2] Check via ctx.runQuery(internal.lib.featureFlags.shouldUseEntityResolution, { organizationId, userId: coachUserId })",
        "  - If enabled: ctx.scheduler.runAfter(0, internal.actions.entityResolution.resolveEntities, { artifactId })",
        "  - This runs IN PARALLEL with existing flow (same pattern as Phase 4 scheduler)",
        "",
        "--- VERIFICATION ---",
        "Type check passes: npm run check-types",
        "Build passes: npm run build",
        "Manual test: Claim with 'Shawn' -> finds 'Sean' -> auto-resolves if >= trust threshold",
        "Manual test: Claim with common name (multiple matches) -> needs_disambiguation",
        "Manual test: [E5] Resolve 'Shawn' -> 'Sean' once, then send another voice note with 'Shawn' -> auto-resolves via alias",
        "Manual test: [E6] Voice note mentions 'Tommy' 3 times -> only 1 disambiguation prompt, resolving updates all 3",
        "Manual test: [E1] Level 3 coach auto-resolves at lower threshold than Level 0 coach"
      ],
      "priority": 17,
      "passes": true,
      "effort": "2.5 days",
      "effortBreakdown": {
        "schema": "1.5h (voiceNoteEntityResolutions + coachPlayerAliases tables + indexes)",
        "resolution_action": "5h (resolveEntities with trust threshold, alias lookup, batch grouping, rich matchReason)",
        "models_resolutions": "2h (8 functions: 5 internal + 3 public with auth guards)",
        "models_aliases": "1h (3 functions: 2 internal + 1 public)",
        "feature_flag": "0.5h (flag check in claimsExtraction.ts)",
        "integration": "1h (scheduler call + flag gating)",
        "testing": "2h (manual test scenarios including aliases and batch)",
        "manual": "1h (end-to-end verification)"
      },
      "dependencies": ["US-VN-016", "US-VN-006"],
      "files": {
        "create": [
          "packages/backend/convex/actions/entityResolution.ts",
          "packages/backend/convex/models/voiceNoteEntityResolutions.ts",
          "packages/backend/convex/models/coachPlayerAliases.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add voiceNoteEntityResolutions + coachPlayerAliases tables)",
          "packages/backend/convex/actions/claimsExtraction.ts (add feature flag check + scheduler call)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-018",
      "phase": 5,
      "title": "Disambiguation UI with Analytics & Batch Resolution",
      "description": "Create coach-facing UI to resolve ambiguous entity mentions. Shows candidates with rich match reasons (irish_alias, fuzzy, etc.). Batch-resolves same-name mentions across claims. Stores coach aliases on resolution. Logs disambiguation analytics events. Mobile-responsive with shadcn/ui and org theming.",
      "acceptanceCriteria": [
        "--- PAGE STRUCTURE ---",
        "Frontend: Create apps/web/src/app/orgs/[orgId]/coach/voice-notes/disambiguation/[artifactId]/page.tsx",
        "Page structure:",
        "  1. Header: 'Resolve Player Mentions' with back button to voice notes list",
        "  2. Summary card: X unresolved mentions, Y auto-resolved (skipped), Z alias-resolved",
        "  3. [E6] Grouped by unique rawText: if 'Tommy' appears in 5 claims, show ONE card with note '5 claims will be updated'",
        "  4. For each unique unresolved name:",
        "     - Show representative claim sourceText with rawText mention highlighted (bold/underline)",
        "     - Show claim topic badge (reuse TOPIC_CONFIG pattern from v2-claims page)",
        "     - Show count: 'Appears in N claims'",
        "     - [E4] Radio group with candidates: fullName, team/ageGroup, similarity % bar, matchReason badge (e.g., 'Irish alias', 'Fuzzy match', 'Team context')",
        "     - 'None of these' option for marking as unresolved",
        "     - 'Confirm' button per group",
        "  5. 'Save All' and 'Skip All Remaining' buttons at bottom",
        "",
        "--- QUERIES (LIFT TO PARENT) ---",
        "Queries (lift to parent, pass as props):",
        "  - useQuery(api.models.voiceNoteEntityResolutions.getDisambiguationQueue, { organizationId })",
        "  - NOTE: Do NOT use useQuery inside list item components (N+1 anti-pattern)",
        "",
        "--- MUTATIONS ---",
        "Mutations:",
        "  - useMutation(api.models.voiceNoteEntityResolutions.resolveEntity)",
        "",
        "--- RESOLVE ENTITY MUTATION BEHAVIOR ---",
        "Backend: resolveEntity mutation (defined in US-VN-017) does the following on each call:",
        "  1. Verify user identity via ctx.auth.getUserIdentity()",
        "  2. Update resolution: status='user_resolved', resolvedEntityId, resolvedEntityName, resolvedAt",
        "  3. [E6] Batch: Find all other resolution records in same artifact with same rawText, update them too",
        "  4. Update parent claim's resolvedPlayerIdentityId and resolvedPlayerName",
        "  5. [E5] Store coach alias: inline upsert to coachPlayerAliases table (query by_coach_org_rawText index, patch if exists or insert if new). Do NOT use scheduler \u2014 resolveEntity is already a mutation so write directly",
        "  6. [E3] Log analytics event: ctx.scheduler.runAfter(0, internal.models.reviewAnalytics.logReviewEvent, { eventType: 'disambiguate_accept', confidenceScore: selectedScore, category: claim.topic })",
        "",
        "--- SKIP/REJECT BEHAVIOR ---",
        "'None of these' (reject all candidates):",
        "  1. Update resolution: status='unresolved'",
        "  2. [E3] Log analytics: eventType='disambiguate_reject_all', confidenceScore=topCandidate.score",
        "'Skip All Remaining':",
        "  1. [E3] Log analytics: eventType='disambiguate_skip' for each skipped resolution",
        "",
        "--- MATCH REASON DISPLAY (Enhancement E4) ---",
        "Display matchReason as contextual badges on each candidate:",
        "  - 'irish_alias' -> badge: 'Irish name alias' (with tooltip showing alias pair, e.g., 'Shawn = Sean')",
        "  - 'exact_first_name' -> badge: 'Exact first name'",
        "  - 'fuzzy_full_name' -> badge: 'Similar name'",
        "  - 'fuzzy_first_name' -> badge: 'Similar first name'",
        "  - 'last_name_match' -> badge: 'Last name match'",
        "  - 'partial_match' -> badge: 'Partial match'",
        "  - '+team_context' suffix -> additional badge: 'On your team'",
        "",
        "--- NAVIGATION ---",
        "Navigation: Add disambiguation badge/link to voice notes list page when artifact has needs_disambiguation resolutions",
        "  - Badge shows count: '3 players to identify'",
        "  - Links to /orgs/[orgId]/coach/voice-notes/disambiguation/[artifactId]",
        "",
        "--- STYLING ---",
        "Mobile-responsive: Touch targets >= 44px, scrolling list, bottom action bar sticky",
        "Use org theming (useOrgTheme hook) for primary color accents on Confirm buttons",
        "Similarity bar: visual progress bar colored by score (green >= 0.9, yellow 0.7-0.9, red < 0.7)",
        "",
        "--- VERIFICATION ---",
        "Type check passes: npm run check-types",
        "Build passes: npm run build",
        "Manual test:",
        "  - Voice note with ambiguous mention -> shows disambiguation page",
        "  - [E4] Candidates show matchReason badges (Irish alias, fuzzy, etc.)",
        "  - [E6] 'Tommy' in 3 claims shows as 1 grouped card with 'Appears in 3 claims'",
        "  - Select candidate -> confirm -> resolution + all same-name resolutions updated, claim updated",
        "  - [E5] Next voice note with same name -> auto-resolves via alias (no disambiguation needed)",
        "  - [E3] Check reviewAnalyticsEvents table for disambiguate_accept event after resolution",
        "  - All resolved -> navigates back to voice notes list",
        "  - Mobile: Touch targets work, scrolling smooth"
      ],
      "priority": 18,
      "passes": false,
      "effort": "1.5 days",
      "effortBreakdown": {
        "page": "3h (disambiguation page structure + queries lifted to parent)",
        "ui_cards": "2h (grouped resolution cards with radio groups, matchReason badges)",
        "ui_similarity": "1h (similarity bars, score coloring, topic badges)",
        "batch_resolve": "1h (batch same-name UI, 'Appears in N claims' grouping)",
        "analytics": "0.5h (log events on accept/reject/skip)",
        "alias_storage": "0.5h (inline upsert in resolveEntity mutation)",
        "navigation": "1h (badge/link from voice notes list)",
        "styling": "1.5h (mobile-responsive, org theming, touch targets)",
        "manual": "1h (test disambiguation flow including aliases + batch + analytics)"
      },
      "dependencies": ["US-VN-017"],
      "files": {
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/voice-notes/disambiguation/[artifactId]/page.tsx"
        ],
        "modify": [
          "packages/backend/convex/models/voiceNoteEntityResolutions.ts (add batch update + alias storage + analytics in resolveEntity)",
          "apps/web/src/app/orgs/[orgId]/coach/voice-notes/page.tsx (add disambiguation link/badge)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    }
  ],
  "successCriteria": {
    "entityResolutionWorking": "Claims with unresolved player mentions get resolution records with candidates and rich matchReasons",
    "trustAdaptiveThreshold": "Level 3 coaches auto-resolve at their personalized threshold (~0.85), Level 0 coaches at 0.9",
    "aliasLearning": "After coach resolves 'Shawn' -> 'Sean', next voice note with 'Shawn' auto-resolves via alias",
    "batchResolution": "Same name appearing 5 times in one voice note only needs 1 disambiguation click",
    "analyticsLogged": "disambiguate_accept/reject_all/skip events appear in reviewAnalyticsEvents table",
    "featureFlagGated": "Entity resolution only runs when entity_resolution_v2 flag is enabled",
    "disambiguationUIFunctional": "Coach can see matchReason badges, select correct player, confirm, and all same-name mentions update",
    "noN1Queries": "Batch fuzzy matching with Map lookup, no queries inside loops",
    "authGuardsPresent": "All public queries/mutations check ctx.auth.getUserIdentity()",
    "phase4Unaffected": "Claims extraction continues to work; entity resolution runs after it"
  },
  "mandatoryPatterns": [
    "ALWAYS use .withIndex() — NEVER use .filter()",
    "ALWAYS include args and returns validators on ALL queries/mutations",
    "ALWAYS use batch fetch with Map lookup to avoid N+1 queries",
    "ALWAYS check ctx.auth.getUserIdentity() on public queries/mutations",
    "ALWAYS filter by organizationId for data isolation",
    "ALWAYS normalize strings before matching (lowercase, trim, remove diacritics)",
    "NEVER use getFeatureFlag for cascade evaluation — use shouldUseEntityResolution (returns boolean)",
    "NEVER pass { coachUserId, organizationId } to getCoachTrustLevelInternal — use { coachId: coachUserId }",
    "NEVER pass linkCode: null to logReviewEvent — omit the field entirely (Convex rejects null for optional string)",
    "NEVER add a bare by_status index — always scope with organizationId (by_org_and_status)"
  ],
  "architectureDecisions": [
    "ADR-VN2-015: Entity resolution action architecture",
    "ADR-VN2-016: Review analytics event type extension",
    "ADR-VN2-017: Trust level API contract alignment",
    "ADR-VN2-018: Feature flag cascade for entity resolution",
    "ADR-VN2-019: Coach alias upsert and uniqueness",
    "ADR-VN2-020: Disambiguation UI query and routing",
    "ADR-VN2-021: Resolve entity mutation scope and cross-coach guard",
    "ADR-VN2-022: Entity resolution index strategy"
  ],
  "ralphInstructions": {
    "executionMode": "sequential",
    "storyOrder": ["US-VN-017", "US-VN-018"],
    "contextToRead": [
      "context/PHASE5_ENTITY_RESOLUTION.md (PRIMARY — full implementation guide with code examples)",
      "context/PHASE5_ENHANCEMENTS_CATALOG.md (REFERENCE — enhancement details and rationale)"
    ],
    "testingStrategy": "Manual testing only — no unit tests required for Phase 5",
    "qualityCriteria": "npm run check-types passes, npm run build succeeds, manual test scenarios pass"
  }
}

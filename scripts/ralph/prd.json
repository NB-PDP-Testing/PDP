{
  "project": "Voice Gateways v2 - Phase 3: v2 Artifacts Foundation",
  "branchName": "feat/voice-gateways-v2",
  "description": "Create v2 pipeline foundation: voiceNoteArtifacts (source-agnostic records) and voiceNoteTranscripts (segments + confidence). Implement feature flags and dual-path processing where v2-enabled coaches create artifacts while maintaining v1 backward compatibility. No breaking changes to v1 pipeline.",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE3_V2_MIGRATION.md",
    "scripts/ralph/agents/output/feedback.md",
    "docs/architecture/decisions/ADR-VN2-001-capability-url-auth.md",
    "docs/architecture/decisions/ADR-VN2-002-coach-scoped-rolling-links.md",
    "docs/architecture/decisions/ADR-VN2-003-public-queries-code-validation.md",
    "docs/architecture/decisions/ADR-VN2-004-aggregated-pending-items-query.md",
    "docs/architecture/decisions/ADR-VN2-005-whatsapp-command-interceptors.md",
    "docs/architecture/decisions/ADR-VN2-006-inline-edit-and-mutation-design.md"
  ],
  "relatedIssue": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "previousPhases": [
    "Phase 1 - Quality Gates & Fuzzy Matching (COMPLETE: US-VN-001 to US-VN-006, 349 tests)",
    "Phase 2 - Coach Quick Review Microsite (COMPLETE: US-VN-007 to US-VN-012, full mobile microsite at /r/[code])",
    "Phase 2.5 - Review Microsite Polish (COMPLETE: US-VN-012a analytics, 012b swipe, 012c snooze, 012d PWA)"
  ],
  "currentPhase": "Phase 3 - v2 Artifacts Foundation (2 stories, 3 days)",
  "completedStories": [
    "US-VN-001",
    "US-VN-002",
    "US-VN-003",
    "US-VN-004",
    "US-VN-005",
    "US-VN-006",
    "US-VN-007",
    "US-VN-008",
    "US-VN-009",
    "US-VN-010",
    "US-VN-011",
    "US-VN-012",
    "US-VN-012a",
    "US-VN-012b",
    "US-VN-012c",
    "US-VN-012d"
  ],
  "executionStrategy": {
    "parallelStreams": false,
    "sequential": {
      "name": "v2 Artifacts Foundation",
      "order": ["US-VN-013", "US-VN-014"],
      "notes": "Sequential: US-VN-013 creates the tables needed by US-VN-014's dual-path processing. US-VN-013 is backend-only (schema + CRUD). US-VN-014 integrates with whatsapp.ts."
    }
  },
  "designPrinciples": [
    "Zero regression: v1 pipeline MUST continue working unchanged for non-v2 coaches",
    "Feature flag cascade: environment variable \u2192 featureFlags table (platform \u2192 org \u2192 user) \u2192 default false",
    "Source-agnostic: voiceNoteArtifacts supports whatsapp_audio, whatsapp_text, app_recorded, app_typed",
    "Backward compat: v2 artifacts ALWAYS link back to v1 voiceNote via voiceNoteId",
    "Incremental rollout: v2 can be enabled per-org or per-coach without affecting others"
  ],
  "criticalReminders": [
    "NEVER use .filter() \u2014 always use .withIndex()",
    "Better Auth IDs as v.string() not v.id() \u2014 user._id not user.id",
    "Batch fetch + Map lookup (avoid N+1 queries in loops)",
    "Use internalMutation/internalQuery for server-to-server calls \u2014 NEVER call public mutations from internalActions",
    "NEVER use v.any() \u2014 always use typed validators (v.union, v.object, v.record)",
    "Bounds-check all user-provided numeric inputs (delayMs, counts, etc.)",
    "Reuse existing components before creating new ones \u2014 check components/polish/ and hooks/",
    "Biome block statements: always use { } (not one-line if/return)",
    "Biome top-level regex: define regex as module-scope constants",
    "Biome auto-removes imports: add import AND its usage in same edit",
    "Biome useMaxParams: max 4 params \u2014 use options objects for 5+",
    "Biome cognitive complexity: max 15 \u2014 extract sub-components/helpers",
    "WhatsApp handler order: OK \u2192 R \u2192 SNOOZE \u2192 CONFIRM/RETRY/CANCEL \u2192 awaiting_confirmation \u2192 normal",
    "SITE_URL: use process.env.SITE_URL for deep link generation",
    "Use shadcn/ui components + Tailwind CSS + Lucide Icons",
    "Run quality checks in order: npm run check-types \u2192 npx ultracite fix \u2192 npx biome check <files>",
    "The featureFlags table does NOT exist yet \u2014 US-VN-014 creates it",
    "api.models.platformConfig.get DOES NOT EXIST \u2014 no platformConfig table, use the new featureFlags table pattern",
    "api.models.organizations.getById DOES NOT EXIST \u2014 organizations.ts has getOrganization (different name) but org has NO voiceNotesVersion field",
    "api.models.coaches.getCoach DOES NOT EXIST \u2014 coaches.ts has getCoachAssignments/getCoachPreferences etc., but NO getCoach and NO betaFeatures field",
    "Organization table has: name, slug, logo, createdAt, metadata, colors, socialFacebook/Twitter/Instagram/Linkedin, website, supportedSports, defaultCountry",
    "Member table has: organizationId, userId, role, createdAt, functionalRoles, activeFunctionalRole \u2014 NO betaFeatures field",
    "The aiModelConfig table provides the pattern for feature/scope/org cascading lookups \u2014 follow this pattern for featureFlags"
  ],
  "mandatoryPatterns": [
    "All Convex functions MUST have args and returns validators",
    "Use composite indexes for multi-field queries (by_feature_and_scope, etc.)",
    "internalMutation/internalQuery for cron jobs and server-to-server calls",
    "Public mutations only for client-facing operations",
    "Loading skeletons for all async sections",
    "Real-time updates via useQuery (Convex subscriptions)",
    "Better Auth IDs as v.string() not v.id()",
    "Use Id<'tableName'> for Convex document references",
    "Feature flag evaluation: env var \u2192 platform scope \u2192 org scope \u2192 user scope \u2192 default false",
    "v2 artifacts ALWAYS create a v1 voiceNote for backward compat"
  ],
  "phase2IntegrationNotes": [
    "Review links model: packages/backend/convex/models/whatsappReviewLinks.ts (validateReviewCode, validateReviewScope patterns)",
    "Review analytics: packages/backend/convex/models/reviewAnalytics.ts (logReviewEvent pattern via scheduler.runAfter)",
    "Coach trust levels: packages/backend/convex/models/coachTrustLevels.ts (trust level evaluation pattern)",
    "WhatsApp action: packages/backend/convex/actions/whatsapp.ts (processIncomingMessage is THE integration point for dual-path)",
    "Voice notes: packages/backend/convex/models/voiceNotes.ts (createRecordedNote, updateTranscription \u2014 v1 path)",
    "Player matching: packages/backend/convex/lib/playerMatching.ts (shared fuzzy matching logic)",
    "String matching: packages/backend/convex/lib/stringMatching.ts (Levenshtein distance)",
    "AI model config: packages/backend/convex/models/aiModelConfig.ts (feature/scope/org cascade pattern \u2014 FOLLOW THIS for featureFlags)"
  ],
  "userStories": [
    {
      "id": "US-VN-013",
      "phase": 3,
      "title": "Artifacts & Transcripts Tables",
      "description": "Create v2 tables (voiceNoteArtifacts, voiceNoteTranscripts) to support source-agnostic voice note processing and detailed transcription storage with segments. Backend-only: schema + CRUD mutations/queries.",
      "acceptanceCriteria": [
        "Backend: Add voiceNoteArtifacts table to schema.ts",
        "Schema fields: artifactId (v.string, unique), sourceChannel (v.union of 'whatsapp_audio', 'whatsapp_text', 'app_recorded', 'app_typed'), senderUserId (v.string), orgContextCandidates (v.array of { organizationId: v.string(), confidence: v.number() }), status (v.union of 'received', 'transcribing', 'transcribed', 'processing', 'completed', 'failed'), voiceNoteId (v.optional(v.id('voiceNotes'))), rawMediaStorageId (v.optional(v.id('_storage'))), metadata (v.optional(v.object({...}))), createdAt (v.number), updatedAt (v.number)",
        "Indexes: by_artifactId ['artifactId'], by_senderUserId_and_createdAt ['senderUserId', 'createdAt'], by_voiceNoteId ['voiceNoteId'], by_status_and_createdAt ['status', 'createdAt']",
        "Backend: Add voiceNoteTranscripts table to schema.ts",
        "Schema fields: artifactId (v.id('voiceNoteArtifacts')), fullText (v.string), segments (v.array of { text: v.string(), startTime: v.number(), endTime: v.number(), confidence: v.number() }), modelUsed (v.string), language (v.string), duration (v.number), createdAt (v.number)",
        "Indexes: by_artifactId ['artifactId']",
        "Backend: Create packages/backend/convex/models/voiceNoteArtifacts.ts",
        "Function: createArtifact (internalMutation) \u2014 args: { artifactId, sourceChannel, senderUserId, orgContextCandidates, rawMediaStorageId? }, returns: v.id('voiceNoteArtifacts')",
        "Function: linkToVoiceNote (internalMutation) \u2014 args: { artifactId: v.string(), voiceNoteId: v.id('voiceNotes') }, updates artifact's voiceNoteId field, returns: v.null()",
        "Function: updateArtifactStatus (internalMutation) \u2014 args: { artifactId: v.string(), status }, returns: v.null()",
        "Function: getArtifactByArtifactId (internalQuery) \u2014 args: { artifactId: v.string() }, returns artifact or null",
        "Function: getArtifactsByVoiceNote (internalQuery) \u2014 args: { voiceNoteId: v.id('voiceNotes') }, returns array",
        "Backend: Create packages/backend/convex/models/voiceNoteTranscripts.ts",
        "Function: createTranscript (internalMutation) \u2014 args: { artifactId: v.id('voiceNoteArtifacts'), fullText, segments, modelUsed, language, duration }, returns: v.id('voiceNoteTranscripts')",
        "Function: getTranscriptByArtifact (internalQuery) \u2014 args: { artifactId: v.id('voiceNoteArtifacts') }, returns transcript or null",
        "Run npx -w packages/backend convex codegen to verify types",
        "Type check passes: npm run check-types"
      ],
      "priority": 13,
      "effort": "1.5 days",
      "dependencies": ["US-VN-012"],
      "passes": true
    },
    {
      "id": "US-VN-014",
      "phase": 3,
      "title": "Feature Flags & Dual-Path Processing",
      "description": "Create featureFlags table and shouldUseV2Pipeline helper. Modify processIncomingMessage in whatsapp.ts to create artifacts (v2 path) alongside v1 voiceNotes. Update transcription completion to store in voiceNoteTranscripts when v2 is enabled. Zero regression to v1 pipeline.",
      "acceptanceCriteria": [
        "Backend: Add featureFlags table to schema.ts",
        "Schema fields: featureKey (v.string), scope (v.union of 'platform', 'organization', 'user'), organizationId (v.optional(v.string)), userId (v.optional(v.string)), enabled (v.boolean), updatedBy (v.optional(v.string)), updatedAt (v.number), notes (v.optional(v.string))",
        "Indexes: by_featureKey_and_scope ['featureKey', 'scope'], by_featureKey_scope_org ['featureKey', 'scope', 'organizationId'], by_featureKey_scope_user ['featureKey', 'scope', 'userId']",
        "Backend: Create packages/backend/convex/lib/featureFlags.ts",
        "Function: shouldUseV2Pipeline (exported async helper, accepts ctx: QueryCtx or similar)",
        "  args: { organizationId: string, userId: string }",
        "  Logic (cascade, first match wins):",
        "    1. Check env var: process.env.VOICE_NOTES_V2_GLOBAL === 'true' \u2192 return true; === 'false' \u2192 return false",
        "    2. Query featureFlags table with by_featureKey_and_scope where featureKey='voice_notes_v2' AND scope='platform' \u2192 if found, return enabled",
        "    3. Query featureFlags table with by_featureKey_scope_org where featureKey='voice_notes_v2' AND scope='organization' AND organizationId \u2192 if found, return enabled",
        "    4. Query featureFlags table with by_featureKey_scope_user where featureKey='voice_notes_v2' AND scope='user' AND userId \u2192 if found, return enabled",
        "    5. Default: return false (v1)",
        "  NOTE: This is an internalQuery (not an action helper) \u2014 call via ctx.runQuery from actions",
        "Function: getFeatureFlag (internalQuery) \u2014 generic flag lookup for any feature key",
        "Function: setFeatureFlag (internalMutation) \u2014 for admin to toggle flags",
        "Backend: Update packages/backend/convex/actions/whatsapp.ts processIncomingMessage",
        "  After message validation + coach lookup, call shouldUseV2Pipeline via ctx.runQuery",
        "  If v2 enabled:",
        "    1. Generate artifactId (use crypto.randomUUID() or nanoid pattern)",
        "    2. Call internal.models.voiceNoteArtifacts.createArtifact with sourceChannel, senderUserId, orgContextCandidates",
        "    3. Still create v1 voiceNote (existing flow, unchanged) for backward compat",
        "    4. Call internal.models.voiceNoteArtifacts.linkToVoiceNote to connect them",
        "    5. Pass artifactId through to transcription step",
        "  If v1: existing flow unchanged (no artifact creation)",
        "Backend: Update transcription completion in packages/backend/convex/actions/whatsapp.ts (or voiceNotes.ts)",
        "  If v2 (artifact exists):",
        "    1. Call internal.models.voiceNoteTranscripts.createTranscript with segments from Whisper",
        "    2. Call internal.models.voiceNoteArtifacts.updateArtifactStatus to 'transcribed'",
        "    3. Continue with existing v1 transcript storage (store in voiceNote.transcript too for backward compat)",
        "  If v1: existing flow unchanged",
        "Run npx -w packages/backend convex codegen to verify types",
        "Type check passes: npm run check-types",
        "Manual test: Set VOICE_NOTES_V2_GLOBAL=true in Convex env \u2192 send voice note \u2192 verify artifact + transcript created alongside voiceNote"
      ],
      "priority": 14,
      "effort": "1.5 days",
      "dependencies": ["US-VN-013"],
      "passes": true
    }
  ],
  "successCriteria": [
    "voiceNoteArtifacts and voiceNoteTranscripts tables created with correct schema and indexes",
    "featureFlags table created with platform/org/user cascade",
    "shouldUseV2Pipeline correctly evaluates env var \u2192 platform \u2192 org \u2192 user \u2192 default false",
    "v2-enabled coach: voice note creates artifact + voiceNote (both), transcript stored in both tables",
    "v1 coach: voice note creates voiceNote only (unchanged behavior, zero regression)",
    "All CRUD operations (create, link, update status, query) work for both artifact tables",
    "Convex codegen passes (types clean)",
    "npm run check-types passes (0 errors)",
    "Biome lint clean on all modified/created files"
  ]
}

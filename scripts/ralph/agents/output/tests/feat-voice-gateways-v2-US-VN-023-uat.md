# UAT Test: US-VN-023 - Eliminate Duplicate v1+v2 Processing

> Auto-generated: 2026-02-08 21:04
> Status: ⏳ Pending Execution

## Story
When v2 pipeline is active and an artifact exists for a voice note, skip the v1 buildInsights action. Also audit v2 backend files for Convex .filter() anti-pattern and fix any found.

## Acceptance Criteria Checklist

- [ ] === FULL IMPLEMENTATION DETAILS IN: scripts/ralph/prds/voice-gateways-v2/phases/PHASE7A_PRD.json ===
- [ ] Read that file for exact implementation instructions.
- [ ] SUMMARY:
- [ ] 1. actions/voiceNotes.ts — buildInsights (line 311+):
- [ ] At START of handler, after getting note from db:
- [ ] - Query getArtifactsByVoiceNote for this noteId
- [ ] - If artifacts.length > 0, log skip message and return null
- [ ] - This prevents v1 extraction when v2 is handling the note
- [ ] 2. .filter() audit in v2 files:
- [ ] - Search entityResolution.ts, draftGeneration.ts, voiceNoteEntityResolutions.ts, insightDrafts.ts
- [ ] - Fix any Convex query .filter() (NOT JavaScript array .filter())
- [ ] - Add indexes to schema.ts if needed
- [ ] HOW TO TELL THE DIFFERENCE:
- [ ] ctx.db.query('table').filter(...)  → BAD (Convex query, replace with .withIndex())
- [ ] someArray.filter(...)              → FINE (JavaScript array filter)
- [ ] === VERIFY ===
- [ ] Type check: npm run check-types
- [ ] Convex codegen: npx -w packages/backend convex codegen
- [ ] v2 ON + artifact exists: buildInsights logs skip and returns null
- [ ] v2 OFF + no artifact: buildInsights runs full v1 extraction normally

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VN-023"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

# Ralph Progress Log
Started: Sat 14 Feb 2026 22:32:30 GMT
---

## Codebase Patterns
**Last Updated**: 2026-02-14 22:35 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field

### Convex Backend Patterns
- NEVER use `.filter()` - always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names include all fields: `by_orgId_and_status`

### Guardian Matching System
- Guardian matcher located in `packages/backend/convex/lib/matching/guardianMatcher.ts`
- Shared between import and onboarding flows
- Weights on 100-point scale: Email 40%, Phone 30%, Name 20%, Address 10%
- Confidence levels: High (60+), Medium (40-59), Low (20-39)
- Returns `MatchResult` with score, confidence level, and matchReasons array

### Import Session Schema
- Located in `packages/backend/convex/models/importSessions.ts`
- Uses validators for all data structures
- Duplicate info includes confidence scoring as of Phase 3.1
- Frontend types in `apps/web/src/components/import/steps/review-step.tsx`

### Frontend Patterns
- Use shadcn/ui components from `@/components/ui`
- Import step components in `apps/web/src/components/import/steps/`
- DuplicateInfo type shared via import from review-step.tsx

### Quality Checks
- Run in order: `npx -w packages/backend convex codegen` → `npm run check-types` → `npx ultracite fix` → `npm run check`
- Ultracite must run before linting or you'll get false failures
- Pre-commit hooks run automatically on commit

---

## 2026-02-14 22:35 - US-P3.1-001 - Add confidence score display to guardian matching
**Iteration**: 1
**Commit**: 041c2d910b96664f7e019f4857512e14c0d1e085
**Session**: 71a2030c-5512-4cbf-b518-529d0cc2543c
**Status**: Complete

### What was implemented
- Updated guardian matching weights in `guardianMatcher.ts` to align with PRD specification:
  * Email match: 40% (reduced from 50%)
  * Phone match: 30% (unchanged)
  * Name similarity: 20% (added SURNAME_ONLY weight for name-only matches)
  * Address match: 10% (postcode/town)
- Adjusted composite weights:
  * SURNAME_POSTCODE: 30 (20% name + 10% address)
  * SURNAME_TOWN: 25 (20% name + 5% partial address)
- Extended `duplicateValidator` in importSessions.ts to include optional `guardianConfidence` object:
  * score: 0-100 confidence score
  * level: "high" | "medium" | "low"
  * matchReasons: array of string explanations
- Updated frontend `DuplicateInfo` type in review-step.tsx to match backend schema
- Type propagates automatically to import-wizard.tsx via import

### Files changed
- packages/backend/convex/lib/matching/guardianMatcher.ts (+10, -5)
- packages/backend/convex/models/importSessions.ts (+8, -1)
- apps/web/src/components/import/steps/review-step.tsx (+7, -1)

### Quality checks
- ✅ Convex codegen: passed
- ✅ Type checking: passed (no new errors)
- ✅ Linting: passed (pre-existing warnings only)
- ✅ Pre-commit hooks: passed
- ⏭️ Browser verification: not applicable (backend-only changes)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Guardian matcher uses multi-signal scoring on 100-point scale
- Confidence levels calculated by `getConfidenceLevel(score)` helper
- Match reasons stored as human-readable strings for UI display
- Weights defined as constants at top of guardianMatcher.ts for easy tuning

**Gotchas encountered:**
- None - existing guardian matcher already had scoring infrastructure
- Only needed to adjust weights and persist scores in schema

**Dependencies found:**
- Frontend DuplicateInfo type must match backend duplicateValidator
- Both use optional guardianConfidence field (not all duplicates have guardian matches)
- Import from review-step.tsx propagates type to import-wizard.tsx

**What to do next**:
- [ ] US-P3.1-002: Add color-coded confidence badges to duplicate resolution UI
- [ ] Display confidence indicators in review-step.tsx DuplicateCard component
- [ ] Add Progress component for visual score bar
- [ ] Mobile-test the confidence indicators

**Mistakes made**:
- None - straightforward implementation aligned with existing patterns

---
## 2026-02-14 23:15 - US-P3.1-002 - Add color-coded confidence indicators to duplicate resolution UI
**Iteration**: 2
**Commit**: 040916c2a00605405f4169c5c335c4f5a67022a5
**Session**: [current-session]
**Status**: Complete

### What was implemented
- Added three-tier confidence badge system to DuplicateCard component:
  * High (60+): Green badge with checkmark icon and "High Confidence" label
  * Medium (40-59): Yellow badge with alert icon and "Review Required" label
  * Low (<40): Red badge with X icon and "Low Confidence" label
- Implemented custom progress bar with color-coded backgrounds matching confidence levels
- Badge displays prominently at top of duplicate card with percentage score
- Progress bar uses CSS transitions for smooth visual rendering
- Added helper function `getConfidenceBadgeProps(score)` to calculate badge properties
- Dark mode support with appropriate color variants for all three levels
- Mobile-responsive design using existing Tailwind patterns

### Files changed
- apps/web/src/components/import/steps/review-step.tsx (+62, -7)
  * Added lucide-react icons: Check, AlertCircle, X
  * Added getConfidenceBadgeProps helper function
  * Updated DuplicateCard component with conditional rendering of confidence UI

### Quality checks
- ✅ Type checking: passed (npm run check-types)
- ✅ Linting: passed (npx ultracite fix, npm run check)
- ✅ Pre-commit hooks: passed
- ⏭️ Browser verification: Should be tested with actual import data containing guardian matches

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Confidence indicators only display when `duplicate.guardianConfidence` exists (optional field)
- Badge uses custom className prop to override default variants
- Progress bar implemented as custom div with CSS transitions (300ms) for smooth UX
- Dark mode variants use `dark:` prefix with appropriate color-950 backgrounds

**Gotchas encountered:**
- Initially added Progress component import but removed in favor of custom implementation
- Linter auto-removed unused import (expected behavior)
- Must check for confidence existence before rendering to avoid errors on non-guardian duplicates

**Dependencies found:**
- Confidence data must be present in importSession duplicates array (populated by US-P3.1-001)
- Guardian matcher must return confidence object with score, level, matchReasons
- DuplicateInfo type already extended with guardianConfidence field (done in US-P3.1-001)

**What to do next**:
- [ ] US-P3.1-003: Add match score breakdown and explanation (expandable details)
- [ ] Test confidence indicators with actual import data containing guardian matches
- [ ] Verify mobile responsiveness at 375px width
- [ ] Check WCAG 2.2 AA color contrast ratios for accessibility

**Mistakes made**:
- None - straightforward implementation following existing component patterns

---
## 2026-02-14 23:45 - US-P3.1-003 - Add match score breakdown and explanation
**Iteration**: 3
**Commit**: a572b7ba3544b4f44c03bec197d7db6b3e025201
**Session**: [current-session]
**Status**: Complete

### What was implemented
- Extended guardian matcher with `SignalBreakdown` type for transparency:
  * signal: Human-readable name (Email Match, Phone Match, Name Similarity, Address Match)
  * matched: Boolean status
  * weight: Percentage weight (40%, 30%, 20%, 10%)
  * contribution: Actual points contributed (0-weight)
  * explanation: Detailed reasoning
- Updated `calculateMatchScore` to return signal breakdown array
- Modified `findGuardianMatches` to propagate signal breakdown through match results
- Added Collapsible UI component to DuplicateCard:
  * Expandable "Match Details" button with chevron icon
  * Signal breakdown display with checkmark (✓) for matched, X for unmatched
  * Shows weight percentage and contribution points for each signal
  * Total score summary at bottom
- Mobile-responsive collapsible with touch-friendly expand/collapse
- Used signal name as unique key (not array index) for React reconciliation

### Files changed
- packages/backend/convex/lib/matching/guardianMatcher.ts (+48, -6)
  * Added SignalBreakdown type export
  * Updated MatchResult type with signalBreakdown field
  * Updated calculateMatchScore to build and return signalBreakdown
  * Added Boolean() conversion for matched fields to fix type errors
  * Propagated signalBreakdown through findGuardianMatches
- apps/web/src/components/import/steps/review-step.tsx (+65, -4)
  * Added SignalBreakdown type (matches backend)
  * Updated DuplicateInfo.guardianConfidence to include signalBreakdown
  * Added Collapsible, CollapsibleContent, CollapsibleTrigger imports
  * Added ChevronDown icon import
  * Added useState for collapsible open state
  * Rendered expandable match details section with signal breakdown

### Quality checks
- ✅ Type checking: passed (npm run check-types)
- ✅ Linting: passed (only pre-existing warnings on function complexity)
- ✅ Pre-commit hooks: passed
- ⏭️ Browser verification: Should test with import data containing guardian matches

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Signal breakdown uses 4 core signals matching PRD weights (Email 40%, Phone 30%, Name 20%, Address 10%)
- Each signal has matched/unmatched status, weight, contribution, and explanation
- Collapsible component uses trigger/content pattern with asChild prop
- ChevronDown icon rotates 180deg when expanded using transition-transform
- Signal name makes a good unique key for map() instead of array index

**Gotchas encountered:**
- Must use `Boolean()` to convert potentially-string values to boolean for type safety
- Linter removes unused imports between edits - must add imports and usage together
- Use optional chaining `confidence?.signalBreakdown` instead of double ampersand check
- React key should be signal.signal (unique string) not idx (array index)

**Dependencies found:**
- Signal breakdown must be propagated through guardian matcher → importSessions → frontend
- Collapsible component exists in ui/collapsible.tsx (shadcn/ui component)
- Match details only shown when confidence.signalBreakdown exists (optional field)

**What to do next**:
- [ ] US-P3.1-004: Add admin override controls with audit trail (priority 2)
- [ ] Test confidence indicators + match details with actual import containing guardian matches
- [ ] Verify mobile responsiveness of collapsible at 375px width

**Mistakes made**:
- Initially forgot to add Boolean() conversion causing type errors
- Had to re-add imports multiple times due to linter removing them when unused

---

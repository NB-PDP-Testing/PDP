# PlayerARC - Phase 0.5: Player Postcode Matching Enhancement

> Auto-generated documentation - Last updated: 2026-02-04 13:41

## Status

- **Branch**: `ralph/phase-0.5-player-postcode-matching`
- **Progress**: 6 / 6 stories complete
- **Phase Status**: ✅ Complete

## Completed Features

### US-P0.5-001: Add PLAYER_POSTCODE_BONUS weight constant

As a developer, I need a new matching weight constant for player postcode matching.

**Acceptance Criteria:**
- Add PLAYER_POSTCODE_BONUS: 10 to MATCHING_WEIGHTS in guardianMatcher.ts
- Export the updated MATCHING_WEIGHTS constant
- Typecheck passes: npm run check-types

### US-P0.5-002: Implement checkPlayerPostcodeMatch function

As a developer, I need a function to check if a user's postcode matches any linked player's postcode.

**Acceptance Criteria:**
- Create checkPlayerPostcodeMatch function in guardianMatcher.ts
- Function takes ctx, guardianId, and userPostcode parameters
- Function queries guardianPlayerLinks by guardian ID
- Function fetches linked player identities
- Function compares normalized postcodes
- Function returns { matches: boolean, matchedPlayers: string[] }
- Function excludes declined links from comparison
- Typecheck passes

### US-P0.5-003: Update calculateMatchScore to include player postcode bonus

As a user, I need the matching algorithm to give bonus points when my postcode matches linked players.

**Acceptance Criteria:**
- Modify calculateMatchScore in guardianMatcher.ts
- After existing scoring, call checkPlayerPostcodeMatch if postcode provided
- Add PLAYER_POSTCODE_BONUS to score if players match
- Add match reason: 'Postcode matches linked player(s): [names]'
- Typecheck passes

### US-P0.5-004: Update GuardianMatch type for player postcode info

As a developer, I need the match result type to include player postcode match information.

**Acceptance Criteria:**
- Update GuardianMatch type in guardianMatcher.ts
- Add optional postcodeMatches field to linkedPlayers array items
- Update findGuardianMatches to populate this field
- Typecheck passes

### US-P0.5-005: Unit tests for player postcode matching

As a developer, I need comprehensive tests for the player postcode matching feature.

**Acceptance Criteria:**
- Test checkPlayerPostcodeMatch with matching postcode returns true
- Test checkPlayerPostcodeMatch with non-matching postcode returns false
- Test checkPlayerPostcodeMatch with multiple players, one match
- Test checkPlayerPostcodeMatch with no linked players returns false
- Test checkPlayerPostcodeMatch excludes declined links
- Test score calculation includes player postcode bonus
- All tests pass

### US-P0.5-006: End-to-end verification

As a developer, I need to verify the complete flow works correctly.

**Acceptance Criteria:**
- Test: User registers with postcode matching linked player → bonus points applied
- Test: User registers with postcode NOT matching linked player → no bonus
- Test: Existing email/phone/guardian-postcode matching still works
- Test: Match reasons display player names when postcode matches
- All linting passes: npx ultracite fix
- All type checks pass: npm run check-types


## Implementation Notes

### Key Patterns & Learnings

**Patterns discovered:**
- When adding new matching signals to guardian matcher, need to:
- Pre-existing type errors in web app don't block backend development
- Batch fetch pattern: collect IDs → Promise.all fetch → create Map → sync lookup

**Gotchas encountered:**
- Biome lint rejects non-null assertions (`params.postcode!`) - use const variable assignment instead
- Import order is auto-fixed by ultracite - test files may be modified on lint
- checkPlayerPostcodeMatch depends on guardianPlayerLinks.by_guardian index
- Player postcode comes from playerIdentities.postcode field
- calculateMatchScore is called from findGuardianMatches with pre-computed match result
- Initially used `params.postcode!` but Biome rejected it - fixed by assigning to const first

### Files Changed

- packages/backend/convex/lib/matching/guardianMatcher.ts (+130 lines)
- packages/backend/convex/__tests__/US-P0.5-005.test.ts (+333 lines, new file)
- ✅ Type check: passed (Convex codegen)
- ✅ Linting: passed (after ultracite fix)
- ✅ Unit tests: 24 tests passing
- N/A Browser verification: Backend-only changes
- When adding new matching signals to guardian matcher, need to:
- Pre-existing type errors in web app don't block backend development
- Batch fetch pattern: collect IDs → Promise.all fetch → create Map → sync lookup


## Key Files


---
*Documentation auto-generated by Ralph Documenter Agent*

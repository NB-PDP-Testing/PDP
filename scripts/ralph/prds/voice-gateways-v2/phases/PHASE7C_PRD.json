{
  "phaseNumber": "7C",
  "phaseName": "Complete v2 → v1 Output Bridge",
  "duration": "2-3 days",
  "storyCount": 2,
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "docs/architecture/voice-notes-pipeline-v2.md"
  ],
  "previousPhases": [
    "Phase 1",
    "Phase 2",
    "Phase 2.5",
    "Phase 3",
    "Phase 4",
    "Phase 5",
    "Phase 6",
    "Phase 7A",
    "Phase 7B"
  ],
  "currentPhase": "Phase 7C - Complete v2 → v1 Output Bridge",
  "goal": "Confirmed v2 drafts produce identical downstream effects to v1 insights: parent summaries are generated, autoAppliedInsights audit records are created, and the voiceNotes.insights[] embedded array is updated for backward compatibility. Auto-confirm integration with trust levels works correctly.",

  "referencePatterns": {
    "applyDraftCurrent": "packages/backend/convex/models/insightDrafts.ts:457-527 — STUDY: current applyDraft function. Creates voiceNoteInsights record at line 498. Missing: voiceNotes.insights[] update, parent summary trigger, autoAppliedInsights record.",
    "v1InsightProcessing": "packages/backend/convex/actions/voiceNotes.ts:311+ — REFERENCE: buildInsights shows how v1 creates insights, updates voiceNotes.insights[] array, and triggers parent summaries. The v2 applyDraft should produce equivalent downstream effects.",
    "parentSummaryPipeline": "packages/backend/convex/actions/coachParentSummaries.ts:586-636 — STUDY: processVoiceNoteInsight function signature and required args. Rate limit → budget → sensitivity → generate → store.",
    "autoConfirmLogic": "packages/backend/convex/actions/draftGeneration.ts:108-132 — STUDY: requiresConfirmation function. Checks sensitive types, trust level >= 2, confidence threshold, auto-apply preferences."
  },

  "verifiedFunctionSignatures": {
    "applyDraft": {
      "location": "packages/backend/convex/models/insightDrafts.ts:457-527",
      "type": "internalMutation",
      "args": "{ draftId: v.string() }",
      "returns": "v.null()",
      "notes": "Gets draft (line 463), checks status=confirmed (line 474), gets claim (line 481), gets artifact (line 487), inserts voiceNoteInsights (line 498). This is the function to extend."
    },
    "processVoiceNoteInsight": {
      "location": "packages/backend/convex/actions/coachParentSummaries.ts:586-636",
      "type": "internalAction",
      "args": "{ voiceNoteId: v.id('voiceNotes'), insightId: v.string(), insightTitle: v.string(), insightDescription: v.string(), playerIdentityId: v.id('playerIdentities'), organizationId: v.string(), coachId: v.optional(v.string()) }",
      "returns": "v.null()",
      "notes": "CRITICAL: Takes 7 args, not 3. insightId is a STRING (not Convex _id). playerIdentityId is REQUIRED (not optional). coachId is optional. This triggers the full parent summary generation pipeline."
    },
    "requiresConfirmation": {
      "location": "packages/backend/convex/actions/draftGeneration.ts:108-132",
      "type": "function (not exported as Convex function)",
      "notes": "Checks: (1) sensitive types always require confirmation, (2) trust level < 2 requires confirmation, (3) confidence below threshold, (4) auto-apply preferences per category."
    },
    "checkAutoApplyAllowed": {
      "location": "packages/backend/convex/actions/draftGeneration.ts:86-102",
      "type": "function (not exported as Convex function)",
      "notes": "Checks insightAutoApplyPreferences: skills, attendance, goals categories."
    },
    "generateDrafts_autoConfirm": {
      "location": "packages/backend/convex/actions/draftGeneration.ts:318-332",
      "type": "part of generateDrafts handler",
      "notes": "Filters auto-confirmed drafts (status=confirmed), schedules applyDraft for each. Already implemented."
    },
    "validateTextMessage": {
      "location": "packages/backend/convex/lib/messageValidation.ts:30-60",
      "type": "sync function (no Convex ctx needed)",
      "args": "(text: string)",
      "returns": "MessageQualityCheck { isValid: boolean, reason?: string, suggestion?: string }",
      "notes": "Checks: empty (line 34), min length 10 chars (line 43), min 3 words (line 53). SYNC function — safe to call in mutation."
    }
  },

  "verifiedSchemaFields": {
    "voiceNoteInsights": {
      "location": "packages/backend/convex/schema.ts:1595-1658",
      "currentFields": "voiceNoteId, insightId (string), title, description, category, recommendedUpdate, playerIdentityId, playerName, teamId, teamName, assigneeUserId, assigneeName, confidenceScore (number 0-1), wouldAutoApply (boolean), status (pending/applied/dismissed/auto_applied), appliedAt, appliedBy, dismissedAt, dismissedBy",
      "fieldsToAdd": "sourceArtifactId: v.optional(v.id('voiceNoteArtifacts')), sourceClaimId: v.optional(v.id('voiceNoteClaims')), sourceDraftId: v.optional(v.string())"
    },
    "autoAppliedInsights": {
      "location": "packages/backend/convex/schema.ts:1663-1705",
      "criticalWarning": "Has MANY required fields — missing any will cause insert to fail at runtime!",
      "allRequiredFields": {
        "insightId": "v.id('voiceNoteInsights') — Convex _id from voiceNoteInsights insert (NOT string)",
        "voiceNoteId": "v.id('voiceNotes') — from artifact.voiceNoteId",
        "playerId": "v.id('orgPlayerEnrollments') — REQUIRED (deprecated but NOT optional!). Must look up from playerIdentityId or make optional in schema first.",
        "playerIdentityId": "v.id('playerIdentities') — from draft.playerIdentityId",
        "coachId": "v.string() — from artifact.senderUserId or draft.coachUserId",
        "organizationId": "v.string() — from draft.organizationId",
        "category": "v.string() — from draft.insightType",
        "confidenceScore": "v.number() — from draft.overallConfidence",
        "insightTitle": "v.string() — from draft.title",
        "insightDescription": "v.string() — from draft.description",
        "appliedAt": "v.number() — Date.now()",
        "autoAppliedByAI": "v.boolean() — true for auto-confirmed, false for manual confirm",
        "changeType": "v.string() — REQUIRED! Use 'insight_applied'",
        "targetTable": "v.string() — REQUIRED! Use 'voiceNoteInsights'",
        "newValue": "v.string() — REQUIRED! JSON.stringify the insight data"
      },
      "optionalFields": {
        "undoneAt": "v.optional(v.number())",
        "undoReason": "v.optional(v.union(...))",
        "undoReasonDetail": "v.optional(v.string())",
        "targetRecordId": "v.optional(v.string()) — can pass insightRecordId.toString()",
        "fieldChanged": "v.optional(v.string())",
        "previousValue": "v.optional(v.string())"
      },
      "playerIdResolution": "The playerId field requires v.id('orgPlayerEnrollments'). Options: (A) Make it optional in schema (recommended — it's deprecated), or (B) Look up enrollment from playerIdentityId via a query. Decision needed before implementation."
    }
  },

  "stories": [
    {
      "id": "US-VN-026",
      "phase": "7C",
      "title": "applyDraft Output Bridge — Parent Summaries, Audit Trail & Backward Compat",
      "description": "Extend the applyDraft internalMutation to trigger the same downstream effects as v1: update voiceNotes.insights[] embedded array, generate coachParentSummaries via processVoiceNoteInsight, and create autoAppliedInsights records for auto-confirmed drafts. Currently applyDraft only creates a voiceNoteInsights record — it misses the parent summary pipeline and audit trail.",
      "acceptanceCriteria": [
        "=== SCHEMA: Add back-link fields to voiceNoteInsights ===",
        "In schema.ts, find the voiceNoteInsights table definition (lines 1595-1658).",
        "Add three optional fields for v2 traceability:",
        "  sourceArtifactId: v.optional(v.id('voiceNoteArtifacts')),",
        "  sourceClaimId: v.optional(v.id('voiceNoteClaims')),",
        "  sourceDraftId: v.optional(v.string()),",
        "",
        "Run codegen after: npx -w packages/backend convex codegen",
        "",
        "=== MODIFY: models/insightDrafts.ts — applyDraft (lines 457-527) ===",
        "The existing applyDraft inserts a voiceNoteInsights record at line 498.",
        "After that insert (which returns the new record's _id), add THREE additional steps:",
        "",
        "STEP 0: Capture the voiceNoteInsights insert return value",
        "  Change line 498 from: await ctx.db.insert('voiceNoteInsights', {...})",
        "  To: const insightRecordId = await ctx.db.insert('voiceNoteInsights', {...})",
        "  Also ADD the back-link fields to the insert object:",
        "    sourceArtifactId: draft.artifactId,",
        "    sourceClaimId: draft.claimId,",
        "    sourceDraftId: draft.draftId,",
        "",
        "STEP 1: Update voiceNotes.insights[] embedded array",
        "  1. Get the voiceNote: const note = await ctx.db.get(artifact.voiceNoteId);",
        "     (artifact is already fetched at line 487)",
        "  2. If note exists, read current insights array:",
        "     const currentInsights = note.insights || [];",
        "  3. Push a new entry matching the v1 format:",
        "     currentInsights.push({",
        "       id: draft.draftId,",
        "       playerIdentityId: draft.playerIdentityId,",
        "       playerName: draft.resolvedPlayerName,",
        "       title: draft.title,",
        "       description: draft.description,",
        "       category: draft.insightType,",
        "       recommendedUpdate: claim.recommendedAction || '',",
        "       confidence: draft.overallConfidence,",
        "       status: 'applied',",
        "       appliedAt: now,",
        "       appliedBy: draft.coachUserId,",
        "       appliedDate: new Date(now).toISOString(),",
        "     });",
        "",
        "  ARCHITECT REVIEW C2: appliedBy and appliedDate are used by v1 for display.",
        "  playerId is intentionally OMITTED (v.optional, legacy, not populated in v2).",
        "",
        "  4. Patch the voiceNotes record:",
        "     await ctx.db.patch(artifact.voiceNoteId, {",
        "       insights: currentInsights,",
        "       insightsStatus: 'completed',",
        "     });",
        "",
        "  NOTE: applyDraft is an internalMutation so ctx.db.get and ctx.db.patch are available.",
        "  NOTE: Check the voiceNotes schema for the exact shape of the insights array entries.",
        "  NOTE: Some fields (teamId, teamName, assigneeUserId, assigneeName) may not be available",
        "        on the claim — use optional chaining and omit if undefined.",
        "",
        "STEP 2: Schedule parent summary generation (with enablement check)",
        "  CRITICAL: processVoiceNoteInsight requires 7 args (verified).",
        "",
        "  ARCHITECT REVIEW C1: v1 checks parentSummariesEnabled before scheduling.",
        "  You MUST check coachOrgPreferences FIRST to respect coach preference.",
        "  applyDraft is an internalMutation so ctx.db is available for direct query.",
        "",
        "  // Check if coach has parent summaries enabled",
        "  const coachOrgPrefs = await ctx.db",
        "    .query('coachOrgPreferences')",
        "    .withIndex('by_coach_org', (q) =>",
        "      q.eq('coachId', draft.coachUserId).eq('organizationId', draft.organizationId)",
        "    )",
        "    .first();",
        "  const parentSummariesEnabled = coachOrgPrefs?.parentSummariesEnabled ?? true;",
        "",
        "  Schedule ONLY if draft has a playerIdentityId AND parent summaries are enabled:",
        "",
        "  if (draft.playerIdentityId && parentSummariesEnabled) {",
        "    await ctx.scheduler.runAfter(",
        "      0,",
        "      internal.actions.coachParentSummaries.processVoiceNoteInsight,",
        "      {",
        "        voiceNoteId: artifact.voiceNoteId,",
        "        insightId: draft.draftId,",
        "        insightTitle: draft.title,",
        "        insightDescription: draft.description,",
        "        playerIdentityId: draft.playerIdentityId,",
        "        organizationId: draft.organizationId,",
        "        coachId: artifact.senderUserId,",
        "      }",
        "    );",
        "  }",
        "",
        "  NOTE: insightId is a STRING (draft.draftId), not a Convex _id",
        "  NOTE: playerIdentityId is v.id('playerIdentities') — check draft schema has this type",
        "  NOTE: coachId comes from artifact.senderUserId (the coach who created the note)",
        "",
        "STEP 3A: Make playerId optional in autoAppliedInsights schema — DO THIS FIRST!",
        "",
        "  ARCHITECT REVIEW C3: This schema change MUST be applied BEFORE any code changes.",
        "  Without it, autoAppliedInsights inserts will fail at runtime with validator error.",
        "  EXECUTION ORDER: 1) Schema changes (3A + backlinks) → 2) codegen → 3) Code changes",
        "",
        "  In schema.ts line 1669, change:",
        "    playerId: v.id('orgPlayerEnrollments'),",
        "  To:",
        "    playerId: v.optional(v.id('orgPlayerEnrollments')),",
        "  This is safe — the field is already marked DEPRECATED in the comment.",
        "  Do NOT include playerId in the autoAppliedInsights insert — just omit it entirely.",
        "  Run codegen after: npx -w packages/backend convex codegen",
        "",
        "STEP 3B: Create autoAppliedInsights audit record (ONLY for auto-confirmed drafts)",
        "  Check if this draft was auto-confirmed AND has a playerIdentityId:",
        "",
        "  ARCHITECT REVIEW S1: Wrap this in try/catch — it has the most complex field",
        "  requirements (15 fields) and is most likely to fail. A failure should NOT",
        "  prevent the core insight from being applied.",
        "",
        "  try {",
        "    if (draft.requiresConfirmation === false && draft.playerIdentityId) {",
        "      // Auto-confirmed by AI — create audit record",
        "",
        "  CRITICAL: autoAppliedInsights has MANY required fields. Missing any causes runtime error!",
        "",
        "      await ctx.db.insert('autoAppliedInsights', {",
        "        // Source tracking",
        "        insightId: insightRecordId,                    // v.id('voiceNoteInsights') from STEP 0",
        "        voiceNoteId: artifact.voiceNoteId,             // v.id('voiceNotes')",
        "        // Context",
        "        playerIdentityId: draft.playerIdentityId,      // v.id('playerIdentities')",
        "        coachId: draft.coachUserId,                    // v.string()",
        "        organizationId: draft.organizationId,          // v.string()",
        "        // Insight metadata",
        "        category: draft.insightType,                   // v.string()",
        "        confidenceScore: draft.overallConfidence,      // v.number()",
        "        insightTitle: draft.title,                     // v.string()",
        "        insightDescription: draft.description,         // v.string()",
        "        // Application tracking",
        "        appliedAt: Date.now(),                         // v.number()",
        "        autoAppliedByAI: true,                         // v.boolean()",
        "        // Change tracking (ALL REQUIRED!)",
        "        changeType: 'insight_applied',                 // v.string()",
        "        targetTable: 'voiceNoteInsights',              // v.string()",
        "        targetRecordId: insightRecordId.toString(),    // v.optional(v.string())",
        "        newValue: JSON.stringify({                     // v.string() — REQUIRED!",
        "          title: draft.title,",
        "          description: draft.description,",
        "          category: draft.insightType,",
        "          confidence: draft.overallConfidence,",
        "        }),",
        "      });",
        "    }",
        "",
        "  NOTE: insightId must be v.id('voiceNoteInsights') — use insightRecordId from STEP 0.",
        "  NOTE: playerId is omitted (made optional in STEP 3A — it's deprecated).",
        "  NOTE: playerIdentityId guard means no audit record for unresolved-player drafts (acceptable).",
        "  NOTE: changeType, targetTable, newValue are ALL REQUIRED — do NOT omit them.",
        "",
        "    }",
        "  } catch (e) {",
        "    console.error(`[applyDraft] Step 3 audit record failed for ${args.draftId}:`, e);",
        "  }",
        "",
        "=== IMPORT: internal.actions.coachParentSummaries ===",
        "Verify that internal is imported at the top of insightDrafts.ts.",
        "internal.actions.coachParentSummaries.processVoiceNoteInsight should be accessible.",
        "Add import AND usage in the SAME edit.",
        "",
        "=== VERIFY ===",
        "Type check: npm run check-types",
        "Convex codegen: npx -w packages/backend convex codegen",
        "Confirm a draft → voiceNoteInsights record created with sourceArtifactId, sourceClaimId, sourceDraftId",
        "Confirm a draft → voiceNotes.insights[] array updated with new entry (status: 'applied')",
        "Confirm a draft with playerIdentityId → processVoiceNoteInsight scheduled → parent summary appears",
        "Auto-confirmed draft (requiresConfirmation=false) → autoAppliedInsights record created with autoAppliedByAI=true",
        "Manual confirm (requiresConfirmation=true) → NO autoAppliedInsights record"
      ],
      "priority": 26,
      "passes": false,
      "effort": "2 days",
      "effortBreakdown": {
        "schema_backlinks": "1h (add 3 optional fields to voiceNoteInsights, run codegen)",
        "insights_array_update": "2h (read current array, push v1-format entry, patch voiceNotes)",
        "parent_summaries": "2h (schedule processVoiceNoteInsight with correct 7 args, guard on playerIdentityId)",
        "audit_trail": "1.5h (auto-confirm detection, autoAppliedInsights insert with correct insightId type)",
        "testing": "3h (confirm flow, auto-confirm flow, parent summary generation, audit records)"
      },
      "dependencies": ["US-VN-024"],
      "files": {
        "create": [],
        "modify": [
          "packages/backend/convex/schema.ts (1. add sourceArtifactId/sourceClaimId/sourceDraftId to voiceNoteInsights, 2. make playerId optional in autoAppliedInsights)",
          "packages/backend/convex/models/insightDrafts.ts (extend applyDraft with 3 additional steps + autoAppliedInsights with ALL required fields)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": [
          "Confirm draft via Drafts tab → voiceNoteInsights record has sourceArtifactId populated",
          "Confirm draft → voiceNotes.insights[] array updated with new entry (check in Convex dashboard)",
          "Confirm draft for known player → parent summary appears in ParentsTab (may take 10-30 seconds)",
          "Auto-confirmed draft (trusted coach) → autoAppliedInsights record exists with autoAppliedByAI=true",
          "Manual confirm draft → NO autoAppliedInsights record created (only for auto-confirmed)",
          "Confirm draft without playerIdentityId → NO processVoiceNoteInsight scheduled (no crash)"
        ]
      }
    },
    {
      "id": "US-VN-027",
      "phase": "7C",
      "title": "Auto-Confirm Integration with Trust Levels & Quality Gates for In-App Notes",
      "description": "Verify the draftGeneration action correctly integrates with v1 trust levels and auto-apply preferences. Add quality gates to in-app typed notes (validateTextMessage before creating note). Recorded notes already have quality gates via transcribeAudio.",
      "acceptanceCriteria": [
        "=== VERIFY: actions/draftGeneration.ts — Auto-confirm logic (ALREADY IMPLEMENTED) ===",
        "The auto-confirm logic is already implemented in generateDrafts. Verify these are correct:",
        "",
        "  1. Trust level fetch (line 202-205):",
        "     const trustLevel = await ctx.runQuery(",
        "       internal.models.coachTrustLevels.getCoachTrustLevelInternal,",
        "       { coachId: artifact.senderUserId }",
        "     );",
        "     ✓ Uses coachId param (not coachUserId)",
        "",
        "  2. requiresConfirmation function (lines 108-132):",
        "     ✓ Sensitive types (injury, wellbeing, recovery) ALWAYS require confirmation (line 113-116)",
        "     ✓ Trust level < 2 requires confirmation (line 118-124)",
        "     ✓ Confidence below threshold requires confirmation (line 126-129)",
        "     ✓ Auto-apply preferences checked per category (line 131)",
        "",
        "  3. checkAutoApplyAllowed function (lines 86-102):",
        "     ✓ Checks prefs.skills for skill_rating/skill_progress",
        "     ✓ Checks prefs.attendance for attendance",
        "     ✓ Checks prefs.goals for development_milestone",
        "",
        "  4. Auto-confirmed drafts scheduled (lines 318-332):",
        "     ✓ Filters drafts with status=confirmed",
        "     ✓ Schedules applyDraft for each",
        "",
        "ACTION: Read the code and verify each of these 4 points.",
        "If any are MISSING or WRONG, fix them.",
        "If all are correct, move on — no changes needed to draftGeneration.ts.",
        "",
        "=== VERIFY: Auto-confirmed drafts flow through applyDraft ===",
        "End-to-end chain after US-VN-026:",
        "  generateDrafts auto-confirms (status=confirmed, requiresConfirmation=false)",
        "  → schedules applyDraft({ draftId })",
        "  → applyDraft creates voiceNoteInsights + updates voiceNotes.insights[] + schedules processVoiceNoteInsight + creates autoAppliedInsights",
        "Verify this chain works by creating a note with a trusted coach (level 2+).",
        "",
        "=== MODIFY: models/voiceNotes.ts — createTypedNote quality gate ===",
        "BEFORE the voiceNotes insert at line 566 in createTypedNote,",
        "add quality validation for the typed text:",
        "",
        "  // Quality gate: reject gibberish/too-short text",
        "  const validation = validateTextMessage(args.noteText);",
        "  if (!validation.isValid) {",
        "    throw new Error(validation.suggestion || 'Message too short or unclear');",
        "  }",
        "",
        "IMPORT: Add import at top of file:",
        "  import { validateTextMessage } from '../lib/messageValidation';",
        "",
        "validateTextMessage is a SYNC function (no ctx needed):",
        "  - Empty text → { isValid: false, suggestion: '...' }",
        "  - < 10 chars → { isValid: false, suggestion: '...' }",
        "  - < 3 words → { isValid: false, suggestion: '...' }",
        "  - Normal text → { isValid: true }",
        "",
        "CRITICAL: Add the import AND the validateTextMessage call in the SAME edit.",
        "",
        "Frontend handling: The mutation will throw an error, which the frontend catches.",
        "The existing new-note-tab.tsx should already show toast errors for failed mutations.",
        "If not, the error will appear in the console — verify the UX is acceptable.",
        "",
        "=== VERIFY: createRecordedNote quality gates ===",
        "Recorded notes already have quality gates via transcribeAudio:",
        "  - validateTranscriptQuality checks transcript length and content",
        "  - If quality fails, processing stops (no buildInsights or extractClaims)",
        "Verify this is still working. No changes needed.",
        "",
        "=== VERIFY ===",
        "Type check: npm run check-types",
        "Auto-confirmed draft for trusted coach → draft applied automatically, appears in InsightsTab",
        "Sensitive insight (injury/wellbeing) → NEVER auto-confirmed regardless of trust level",
        "Low confidence (< threshold) → requires manual confirmation in Drafts tab",
        "Type < 10 chars in new-note-tab → error thrown, note NOT created",
        "Type gibberish (< 3 words) → error thrown, note NOT created",
        "Type normal text → note created successfully, v2 pipeline runs"
      ],
      "priority": 27,
      "passes": false,
      "effort": "1 day",
      "effortBreakdown": {
        "verify_auto_confirm": "2h (audit generateDrafts logic against 4 checkpoints, fix if needed)",
        "quality_gate_typed": "1.5h (add validateTextMessage to createTypedNote, test edge cases)",
        "end_to_end_verify": "2h (test full chain: note → artifact → claims → resolution → drafts → auto-confirm → apply → parent summary)",
        "testing": "1.5h (trust levels, sensitive types, quality gates)"
      },
      "dependencies": ["US-VN-026"],
      "files": {
        "create": [],
        "modify": [
          "packages/backend/convex/actions/draftGeneration.ts (verify/fix auto-confirm logic if needed)",
          "packages/backend/convex/models/voiceNotes.ts (add validateTextMessage quality gate to createTypedNote)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": [
          "Trusted coach (level 2+) creates note with clear player mention → insight auto-applied, appears in InsightsTab",
          "Untrusted coach (level 0) creates same note → insight appears as 'pending' in Drafts tab",
          "Note mentioning 'injury' → draft requires confirmation regardless of trust level",
          "Type 'hi' (< 10 chars) in new-note-tab → error, note not created",
          "Type 'abc def' (< 3 words but > 10 chars) → may fail or pass depending on validation order",
          "Type 'Player John did well in training today, good effort on passing drills' → note created successfully"
        ]
      }
    }
  ],

  "mandatoryPatterns": [
    "processVoiceNoteInsight takes 7 args — voiceNoteId, insightId (string), insightTitle, insightDescription, playerIdentityId, organizationId, coachId",
    "autoAppliedInsights.insightId is v.id('voiceNoteInsights') — pass the Convex _id from the voiceNoteInsights insert, NOT a string",
    "autoAppliedInsights has REQUIRED fields: changeType, targetTable, newValue, playerId — make playerId optional in schema first, then supply all other required fields",
    "Guard parent summary scheduling on draft.playerIdentityId existing AND parentSummariesEnabled === true (query coachOrgPreferences.by_coach_org)",
    "Guard autoAppliedInsights on BOTH draft.requiresConfirmation === false AND draft.playerIdentityId existing",
    "Include appliedBy and appliedDate in voiceNotes.insights[] push object (v1 display compat)",
    "Do NOT include playerId in autoAppliedInsights insert — omit it entirely after making it optional",
    "Wrap Step 3 (autoAppliedInsights insert) in try/catch — don't let audit failure block core insight",
    "Schema changes FIRST, codegen, then code changes — order matters for validator correctness",
    "validateTextMessage is a SYNC function — no await needed, safe in mutation context",
    "Import + usage in SAME edit to prevent linter removal",
    "internal is already imported at insightDrafts.ts line 11 — no new import needed for scheduler references"
  ],

  "architectureReview": {
    "status": "COMPLETED — 3 ADRs generated, 3 critical findings incorporated into PRD",
    "adrs": [
      "docs/architecture/decisions/ADR-VN2-040-parent-summary-enablement-check-in-applydraft.md",
      "docs/architecture/decisions/ADR-VN2-041-applydraft-mutation-complexity-and-failure-modes.md",
      "docs/architecture/decisions/ADR-VN2-042-validate-text-message-quality-gate-placement.md"
    ],
    "criticalFindings": [
      "C1: Added parentSummariesEnabled check to Step 2 (query coachOrgPreferences.by_coach_org)",
      "C2: Added appliedBy + appliedDate to Step 1 push object for v1 display compat",
      "C3: Emphasized schema change ordering (Step 3A FIRST, codegen, then code)"
    ],
    "autoConfirmVerification": "ALL 4 CHECKPOINTS PASS — no changes needed to draftGeneration.ts"
  },

  "ralphInstructions": {
    "executionMode": "sequential",
    "storyOrder": ["US-VN-026", "US-VN-027"],
    "beforeStarting": [
      "Read the current applyDraft function (insightDrafts.ts:457-527) — understand what it already does",
      "Read processVoiceNoteInsight function signature (coachParentSummaries.ts:586-636) — note the 7 required args",
      "Read autoAppliedInsights schema (schema.ts:1663-1705) — note ALL required fields: insightId, voiceNoteId, playerId, playerIdentityId, coachId, organizationId, category, confidenceScore, insightTitle, insightDescription, appliedAt, autoAppliedByAI, changeType, targetTable, newValue",
      "Read generateDrafts auto-confirm logic (draftGeneration.ts:108-132, 318-332) — verify before modifying",
      "Read coachOrgPreferences table and by_coach_org index (schema.ts:2590+) — needed for parentSummariesEnabled check",
      "Read voiceNotes.insights[] embedded array schema (schema.ts:1525-1554) — note appliedBy and appliedDate fields"
    ],
    "implementationOrder": [
      "CRITICAL: Execute schema changes FIRST, then codegen, then code changes:",
      "1. Schema: Make autoAppliedInsights.playerId optional (Step 3A)",
      "2. Schema: Add 3 back-link fields to voiceNoteInsights",
      "3. Run: npx -w packages/backend convex codegen",
      "4. Code: Extend applyDraft with Steps 0, 1, 2, 3B",
      "5. Run: npm run check-types",
      "6. Code: US-VN-027 (validateTextMessage in createTypedNote)",
      "7. Run: npm run check-types"
    ],
    "testingStrategy": "Manual testing — confirm drafts via Drafts tab, verify parent summaries appear, check autoAppliedInsights in Convex dashboard",
    "qualityCriteria": "npm run check-types passes, npx -w packages/backend convex codegen succeeds"
  },

  "successCriteria": {
    "backLinksPopulated": "voiceNoteInsights records from v2 drafts have sourceArtifactId, sourceClaimId, sourceDraftId",
    "insightsArrayUpdated": "voiceNotes.insights[] embedded array is updated when draft is confirmed",
    "parentSummariesGenerated": "Confirmed drafts with playerIdentityId trigger coachParentSummaries processing",
    "auditTrailCreated": "Auto-confirmed drafts create autoAppliedInsights records with autoAppliedByAI=true",
    "manualConfirmNoAudit": "Manually confirmed drafts do NOT create autoAppliedInsights records",
    "autoConfirmChainWorks": "generateDrafts → auto-confirm → applyDraft → full output bridge runs automatically",
    "qualityGateWorks": "Short/gibberish typed notes are rejected before creation"
  }
}

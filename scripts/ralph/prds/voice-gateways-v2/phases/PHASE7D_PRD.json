{
  "phaseNumber": "7D",
  "phaseName": "Retire v1 Processing & Clean Up",
  "duration": "2-3 days",
  "storyCount": 2,
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "docs/architecture/voice-notes-pipeline-v2.md"
  ],
  "previousPhases": [
    "Phase 1",
    "Phase 2",
    "Phase 2.5",
    "Phase 3",
    "Phase 4",
    "Phase 5",
    "Phase 6",
    "Phase 7A",
    "Phase 7B",
    "Phase 7C"
  ],
  "currentPhase": "Phase 7D - Retire v1 Processing & Clean Up",
  "goal": "Remove the dual-processing path. When v2 is enabled, buildInsights is never scheduled. Provide tooling for feature flag promotion and migration script validation. This is the final phase — after 7D, the v2 pipeline is the sole AI processing path (gated by feature flags).",

  "verifiedCodeLocations": {
    "createTypedNote": {
      "file": "packages/backend/convex/models/voiceNotes.ts",
      "lines": "554-584",
      "buildInsightsSchedule": "lines 578-581: ctx.scheduler.runAfter(0, internal.actions.voiceNotes.buildInsights, { noteId })",
      "note": "After Phase 7A (US-VN-022), this function will have a useV2 check that creates artifacts. Phase 7D gates the buildInsights scheduling with if (!useV2)."
    },
    "createRecordedNote": {
      "file": "packages/backend/convex/models/voiceNotes.ts",
      "lines": "591-624",
      "buildInsightsSchedule": "NONE — recorded notes schedule transcribeAudio (line 616-620), which then schedules buildInsights",
      "note": "No change needed here for 7D. The gating happens in transcribeAudio."
    },
    "transcribeAudio": {
      "file": "packages/backend/convex/actions/voiceNotes.ts",
      "lines": "163-304",
      "artifactCheck": "lines 229-231: const artifacts = await ctx.runQuery(internal.models.voiceNoteArtifacts.getArtifactsByVoiceNote, { voiceNoteId: args.noteId })",
      "v2Path": "lines 233-263: if (artifacts.length > 0) → create transcript + updateArtifactStatus + schedule extractClaims",
      "buildInsightsSchedule": "lines 287-293: ctx.scheduler.runAfter(0, internal.actions.voiceNotes.buildInsights, { noteId: args.noteId }) — ALWAYS runs regardless of v2 artifacts",
      "qualityGateChecks": "lines 266-284: quality rejection/ask_user returns null before reaching buildInsights scheduling",
      "note": "Phase 7D wraps the buildInsights scheduling (lines 287-293) in an else block: only schedule if artifacts.length === 0"
    },
    "buildInsights": {
      "file": "packages/backend/convex/actions/voiceNotes.ts",
      "lines": "311-354+",
      "signature": "internalAction({ args: { noteId: v.id('voiceNotes') }, returns: v.null() })",
      "note": "Phase 7A (US-VN-023) adds a defense-in-depth artifact check at top. Phase 7D updates the log message."
    },
    "whatsappAudioPath": {
      "file": "packages/backend/convex/actions/whatsapp.ts",
      "lines": "753-814",
      "pattern": "useV2 check → createArtifact → createRecordedNote → linkToVoiceNote",
      "buildInsightsSchedule": "NONE in whatsapp.ts — createRecordedNote schedules transcribeAudio, which schedules buildInsights",
      "note": "No explicit buildInsights call in whatsapp.ts for audio. Gating in transcribeAudio handles this."
    },
    "whatsappTextPath": {
      "file": "packages/backend/convex/actions/whatsapp.ts",
      "lines": "867-923",
      "pattern": "useV2 check → createArtifact → createTypedNote → linkToVoiceNote",
      "buildInsightsSchedule": "NONE in whatsapp.ts — createTypedNote internally schedules buildInsights (line 579)",
      "note": "Gating in createTypedNote (above) handles this. No change needed in whatsapp.ts."
    },
    "featureFlags": {
      "file": "packages/backend/convex/lib/featureFlags.ts",
      "shouldUseV2Pipeline": {
        "lines": "35-98",
        "type": "internalQuery",
        "args": "{ organizationId: v.string(), userId: v.string() }",
        "returns": "v.boolean()",
        "cascade": "env var → platform → organization → user → default false"
      },
      "setFeatureFlag": {
        "lines": "244-317",
        "type": "internalMutation",
        "args": "{ featureKey: v.string(), scope: scopeValidator, organizationId: v.optional(v.string()), userId: v.optional(v.string()), enabled: v.boolean(), updatedBy: v.optional(v.string()), notes: v.optional(v.string()) }",
        "returns": "v.id('featureFlags')"
      }
    },
    "migrationScript": {
      "file": "packages/backend/convex/actions/migration.ts",
      "function": "migrateVoiceNotesToV2",
      "type": "internalAction",
      "args": "{ organizationId: v.optional(v.string()), dryRun: v.boolean(), batchSize: v.optional(v.number()) }",
      "returns": "v.object({ processed: v.number(), artifacts: v.number(), transcripts: v.number(), claims: v.number(), errors: v.number(), skipped: v.number() })",
      "features": [
        "dry-run mode",
        "batch processing (default 50, max 200)",
        "idempotent (skips existing)",
        "per-note error handling",
        "progress logging"
      ],
      "note": "Already complete and well-structured. Phase 7D validates it works, doesn't need modification."
    },
    "existingScriptsPattern": {
      "file": "packages/backend/convex/scripts/getOrgId.ts",
      "note": "Existing scripts use query/mutation (NOT internalQuery) exported directly. They run via 'npx -w packages/backend convex run scripts/<name>'."
    },
    "schema_featureFlags": {
      "file": "packages/backend/convex/schema.ts",
      "lines": "4141-4157",
      "indexes": [
        "by_featureKey_and_scope: ['featureKey', 'scope']",
        "by_featureKey_scope_org: ['featureKey', 'scope', 'organizationId']",
        "by_featureKey_scope_user: ['featureKey', 'scope', 'userId']"
      ]
    },
    "schema_voiceNoteArtifacts": {
      "file": "packages/backend/convex/schema.ts",
      "lines": "4159+",
      "indexes": [
        "by_artifactId",
        "by_voiceNoteId",
        "by_senderUserId",
        "by_status_and_sourceChannel"
      ]
    }
  },

  "stories": [
    {
      "id": "US-VN-028",
      "phase": "7D",
      "title": "Remove Dual Processing Path",
      "description": "Ensure that when v2 is enabled, the v1 buildInsights action is completely bypassed for ALL input paths. Currently US-VN-023 added a skip check inside buildInsights, but buildInsights is still scheduled unnecessarily. Gate the scheduling calls so buildInsights is never even scheduled when v2 is active. This eliminates wasted Convex function calls and removes race conditions between v1 and v2 processing.",

      "acceptanceCriteria": [
        "=== CHANGE 1: Gate buildInsights in createTypedNote ===",
        "",
        "FILE: packages/backend/convex/models/voiceNotes.ts",
        "FUNCTION: createTypedNote (lines 554-584)",
        "",
        "CONTEXT: After Phase 7A (US-VN-022), createTypedNote already has a useV2 block that:",
        "  - Checks shouldUseV2Pipeline",
        "  - Creates artifact + transcript + schedules extractClaims (when v2 enabled)",
        "  - But STILL unconditionally schedules buildInsights (lines 578-581)",
        "",
        "CHANGE: Wrap the buildInsights scheduling in if (!useV2):",
        "",
        "  // Phase 7A already has this block:",
        "  const useV2 = await ctx.runQuery(internal.lib.featureFlags.shouldUseV2Pipeline, {",
        "    organizationId: args.orgId, userId: args.coachId",
        "  });",
        "",
        "  if (useV2) {",
        "    // ... artifact creation from US-VN-022 (already implemented) ...",
        "  }",
        "",
        "  // PHASE 7D CHANGE: Only schedule v1 if v2 is NOT enabled",
        "  if (!useV2) {",
        "    await ctx.scheduler.runAfter(0, internal.actions.voiceNotes.buildInsights, {",
        "      noteId,",
        "    });",
        "  }",
        "",
        "  return noteId;",
        "",
        "CRITICAL: The useV2 variable already exists from US-VN-022. Reuse it — do NOT call shouldUseV2Pipeline twice.",
        "CRITICAL: Keep the buildInsights call inside if (!useV2), NOT inside an else of the if (useV2) block. This makes the logic explicit and readable.",
        "",
        "=== CHANGE 2: Gate buildInsights in transcribeAudio ===",
        "",
        "FILE: packages/backend/convex/actions/voiceNotes.ts",
        "FUNCTION: transcribeAudio (lines 163-304)",
        "",
        "CONTEXT: transcribeAudio already has an artifact check (lines 229-231) that:",
        "  - Checks getArtifactsByVoiceNote",
        "  - If artifact exists: creates transcript + schedules extractClaims (lines 233-263)",
        "  - Then REGARDLESS of artifact check, hits quality gates (lines 266-284)",
        "  - Then UNCONDITIONALLY schedules buildInsights (lines 287-293)",
        "",
        "CHANGE: Move the buildInsights scheduling into an else block of the existing artifact check:",
        "",
        "  // Existing code (unchanged):",
        "  const artifacts = await ctx.runQuery(",
        "    internal.models.voiceNoteArtifacts.getArtifactsByVoiceNote,",
        "    { voiceNoteId: args.noteId }",
        "  );",
        "",
        "  if (artifacts.length > 0) {",
        "    // v2 path (lines 234-263 — already implemented, unchanged)",
        "    const artifact = artifacts[0];",
        "    await ctx.runMutation(internal.models.voiceNoteTranscripts.createTranscript, { ... });",
        "    await ctx.runMutation(internal.models.voiceNoteArtifacts.updateArtifactStatus, { ... });",
        "    await ctx.scheduler.runAfter(0, internal.actions.claimsExtraction.extractClaims, { artifactId: artifact._id });",
        "  }",
        "",
        "  // Quality gate checks (lines 266-284 — UNCHANGED, applies to both paths)",
        "  if (quality.suggestedAction === 'reject') { ... return null; }",
        "  if (quality.suggestedAction === 'ask_user') { ... return null; }",
        "",
        "  // PHASE 7D CHANGE: Only schedule v1 buildInsights if NO v2 artifact exists",
        "  if (artifacts.length === 0) {",
        "    await ctx.scheduler.runAfter(0, internal.actions.voiceNotes.buildInsights, {",
        "      noteId: args.noteId,",
        "    });",
        "  }",
        "",
        "CRITICAL: Quality gate checks (reject/ask_user) MUST stay BEFORE the buildInsights gating.",
        "CRITICAL: The artifacts variable is already in scope from line 229. Reuse it.",
        "CRITICAL: Do NOT use if/else — the quality gates return null in between. Use a separate if (artifacts.length === 0) after the quality gates.",
        "",
        "=== CHANGE 3: Verify WhatsApp has no parallel v1 scheduling ===",
        "",
        "FILE: packages/backend/convex/actions/whatsapp.ts",
        "",
        "VERIFICATION ONLY — READ and confirm, no changes expected:",
        "",
        "WhatsApp AUDIO path (lines 753-814):",
        "  - Creates artifact (line 763) → calls createRecordedNote (line 777) → linkToVoiceNote (line 790)",
        "  - createRecordedNote schedules transcribeAudio (line 616)",
        "  - transcribeAudio detects artifact → runs v2 path (after Change 2, skips buildInsights)",
        "  - VERIFY: No explicit buildInsights call anywhere in the audio handler",
        "",
        "WhatsApp TEXT path (lines 867-923):",
        "  - Creates artifact (line 877) → calls createTypedNote (line 889) → linkToVoiceNote (line 899)",
        "  - createTypedNote has internal buildInsights scheduling (after Change 1, gated by !useV2)",
        "  - BUT TIMING ISSUE: createTypedNote checks shouldUseV2Pipeline. The artifact is created",
        "    in whatsapp.ts BEFORE createTypedNote, but linkToVoiceNote happens AFTER.",
        "  - This means createTypedNote's useV2 check will return true (because org has v2 flag on),",
        "    and it will try to create its OWN artifact. This is a DOUBLE ARTIFACT for WhatsApp text!",
        "",
        "  FIX FOR DOUBLE ARTIFACT: In createTypedNote (Phase 7A, US-VN-022), before creating artifact,",
        "  check if one already exists for this note. But the note was JUST created, and linkToVoiceNote",
        "  hasn't been called yet, so getArtifactsByVoiceNote would return empty.",
        "",
        "  ALTERNATIVE (PREFERRED): The WhatsApp text path creates the artifact in whatsapp.ts, then calls",
        "  createTypedNote which also tries to create one. This is only an issue if Phase 7A's",
        "  createTypedNote blindly creates artifacts. Since createTypedNote uses shouldUseV2Pipeline (not",
        "  artifact-exists check), the v2 block WILL run and create a DUPLICATE artifact.",
        "",
        "  RESOLUTION: Add a 'skipV2' optional arg to createTypedNote and createRecordedNote.",
        "  WhatsApp callers already handle v2 artifact creation externally, so they should pass skipV2: true.",
        "  In-app callers don't pass it, so v2 runs inside the mutation.",
        "",
        "  MODIFY createTypedNote args: Add skipV2: v.optional(v.boolean())",
        "  MODIFY createTypedNote handler: const useV2 = args.skipV2 ? false : await ctx.runQuery(...)",
        "  MODIFY createRecordedNote args: Add skipV2: v.optional(v.boolean())",
        "  MODIFY createRecordedNote handler: const useV2 = args.skipV2 ? false : await ctx.runQuery(...)",
        "",
        "  MODIFY whatsapp.ts processAudioMessage (line 777):",
        "    Change: api.models.voiceNotes.createRecordedNote → internal.models.voiceNotes.createRecordedNote",
        "    Add: skipV2: true to the args",
        "    NOTE: Must use internal (not api) to pass internal-only args like skipV2",
        "    OR: Keep api call but add skipV2 to the public args validator",
        "",
        "  MODIFY whatsapp.ts processTextMessage (line 889):",
        "    Change: api.models.voiceNotes.createTypedNote → internal.models.voiceNotes.createTypedNote",
        "    Add: skipV2: true to the args",
        "    OR: Keep api call but add skipV2 to the public args validator",
        "",
        "  SIMPLER ALTERNATIVE: Since createTypedNote/createRecordedNote are public mutations called from",
        "  the frontend, adding skipV2 to the public API is cleaner (avoids needing separate internal versions).",
        "  skipV2 defaults to undefined/false for frontend callers, true for WhatsApp.",
        "",
        "=== CHANGE 4: Update defense-in-depth log in buildInsights ===",
        "",
        "FILE: packages/backend/convex/actions/voiceNotes.ts",
        "FUNCTION: buildInsights (line 311+)",
        "",
        "US-VN-023 added an artifact-exists check at the top of buildInsights.",
        "Now that we gate scheduling at the source, this check is defense-in-depth.",
        "Update the log message to reflect this:",
        "",
        "  // At top of buildInsights handler (after note fetch, after Phase 7A US-VN-023 artifact check):",
        "  const artifacts = await ctx.runQuery(internal.models.voiceNoteArtifacts.getArtifactsByVoiceNote, { voiceNoteId: args.noteId });",
        "  if (artifacts.length > 0) {",
        "    console.warn('[buildInsights] Defense-in-depth: v2 artifact found, skipping v1 extraction for note:', args.noteId);",
        "    return null;",
        "  }",
        "",
        "KEEP this check — do NOT remove it. It catches any edge case where buildInsights gets scheduled despite gating.",
        "",
        "=== VERIFY ===",
        "Type check: npm run check-types",
        "Convex codegen: npx -w packages/backend convex codegen",
        "With v2 ON: createTypedNote schedules extractClaims, NOT buildInsights",
        "With v2 ON: transcribeAudio schedules extractClaims, NOT buildInsights",
        "With v2 OFF: createTypedNote schedules buildInsights as before",
        "With v2 OFF: transcribeAudio schedules buildInsights as before",
        "WhatsApp with v2 ON: only v2 pipeline runs, no duplicate artifacts, no v1 buildInsights",
        "WhatsApp with v2 OFF: v1 pipeline runs, no artifacts created"
      ],

      "priority": 28,
      "passes": false,
      "effort": "1.5 days",
      "effortBreakdown": {
        "createTypedNote_gating": "1.5h (wrap buildInsights in if (!useV2))",
        "transcribeAudio_gating": "1.5h (wrap buildInsights in if (artifacts.length === 0))",
        "whatsapp_skipV2": "2h (add skipV2 arg to createTypedNote/createRecordedNote, update WhatsApp callers)",
        "buildInsights_cleanup": "0.5h (update defense-in-depth log message)",
        "testing": "3h (all 4 input paths x v2 on/off x verify correct pipeline runs)"
      },
      "dependencies": ["US-VN-026", "US-VN-027"],
      "files": {
        "create": [],
        "modify": [
          "packages/backend/convex/models/voiceNotes.ts (gate buildInsights with !useV2 in createTypedNote, add skipV2 arg to both mutations)",
          "packages/backend/convex/actions/voiceNotes.ts (gate buildInsights with artifacts.length === 0 in transcribeAudio, update defense-in-depth log in buildInsights)",
          "packages/backend/convex/actions/whatsapp.ts (pass skipV2: true when calling createTypedNote/createRecordedNote)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": [
          "v2 ON: typed note in app (no skipV2) → artifact created + extractClaims runs, buildInsights does NOT run",
          "v2 ON: recorded note in app (no skipV2) → artifact created + transcribeAudio → extractClaims runs, buildInsights does NOT run",
          "v2 OFF: typed note in app → buildInsights runs normally, no artifacts created",
          "v2 OFF: recorded note in app → transcribeAudio → buildInsights runs normally",
          "v2 ON: WhatsApp audio → artifact created in whatsapp.ts → createRecordedNote(skipV2:true) → transcribeAudio detects artifact → v2 path, buildInsights skipped",
          "v2 ON: WhatsApp text → artifact created in whatsapp.ts → createTypedNote(skipV2:true) → NO duplicate artifact, buildInsights IS scheduled (useV2=false due to skipV2) but caught by defense-in-depth artifact check",
          "v2 OFF: WhatsApp audio → no artifact → createRecordedNote → transcribeAudio → buildInsights runs normally",
          "v2 OFF: WhatsApp text → no artifact → createTypedNote → buildInsights runs normally",
          "Check Convex function logs: zero buildInsights calls with v2 ON for newly created notes",
          "Defense-in-depth: if buildInsights somehow runs with artifact present, log message shows 'Defense-in-depth' warning"
        ]
      }
    },

    {
      "id": "US-VN-029",
      "phase": "7D",
      "title": "Feature Flag Promotion Tooling & Migration Validation",
      "description": "Create Convex scripts for enabling/disabling v2 per organization (gradual rollout). Create a migration status reporting script. Validate the existing migration script (actions/migration.ts). These tools give operators confidence to enable v2 for production organizations.",

      "acceptanceCriteria": [
        "=== SCRIPT 1: enable-v2-for-org.ts ===",
        "",
        "FILE TO CREATE: packages/backend/convex/scripts/enableV2ForOrg.ts",
        "NOTE: Use camelCase filename (matches existing convention: seedDemoClub.ts, getOrgId.ts)",
        "",
        "USAGE: npx -w packages/backend convex run scripts/enableV2ForOrg '{\"organizationId\": \"...\", \"enabledBy\": \"admin\"}'",
        "",
        "IMPLEMENTATION:",
        "  import { v } from 'convex/values';",
        "  import { internal } from '../_generated/api';",
        "  import { mutation } from '../_generated/server';",
        "",
        "  // Must be mutation (not query) because it calls internalMutation setFeatureFlag",
        "  export const enableV2ForOrg = mutation({",
        "    args: {",
        "      organizationId: v.string(),",
        "      enabledBy: v.optional(v.string()),",
        "    },",
        "    returns: v.object({",
        "      success: v.boolean(),",
        "      flagsSet: v.array(v.string()),",
        "    }),",
        "    handler: async (ctx, args) => {",
        "      const flagsToEnable = ['voice_notes_v2', 'entity_resolution_v2'];",
        "      const flagsSet: string[] = [];",
        "",
        "      for (const featureKey of flagsToEnable) {",
        "        await ctx.runMutation(internal.lib.featureFlags.setFeatureFlag, {",
        "          featureKey,",
        "          scope: 'organization',",
        "          organizationId: args.organizationId,",
        "          enabled: true,",
        "          updatedBy: args.enabledBy ?? 'script',",
        "          notes: `Enabled via enableV2ForOrg script at ${new Date().toISOString()}`,",
        "        });",
        "        flagsSet.push(featureKey);",
        "      }",
        "",
        "      console.log(`[enableV2ForOrg] v2 pipeline enabled for org ${args.organizationId} by ${args.enabledBy ?? 'script'}`);",
        "      return { success: true, flagsSet };",
        "    },",
        "  });",
        "",
        "VERIFIED: setFeatureFlag args match exactly:",
        "  { featureKey: v.string(), scope: scopeValidator, organizationId: v.optional(v.string()),",
        "    userId: v.optional(v.string()), enabled: v.boolean(), updatedBy: v.optional(v.string()),",
        "    notes: v.optional(v.string()) }",
        "",
        "=== SCRIPT 2: disableV2ForOrg.ts ===",
        "",
        "FILE TO CREATE: packages/backend/convex/scripts/disableV2ForOrg.ts",
        "",
        "USAGE: npx -w packages/backend convex run scripts/disableV2ForOrg '{\"organizationId\": \"...\"}'",
        "",
        "IMPLEMENTATION: Same pattern as enableV2ForOrg but with enabled: false",
        "  - Set voice_notes_v2 and entity_resolution_v2 to enabled: false",
        "  - Log rollback message",
        "",
        "=== SCRIPT 3: v2MigrationStatus.ts ===",
        "",
        "FILE TO CREATE: packages/backend/convex/scripts/v2MigrationStatus.ts",
        "",
        "USAGE: npx -w packages/backend convex run scripts/v2MigrationStatus '{\"organizationId\": \"...\"}'",
        "",
        "IMPLEMENTATION:",
        "  import { v } from 'convex/values';",
        "  import { query } from '../_generated/server';",
        "",
        "  export const v2MigrationStatus = query({",
        "    args: { organizationId: v.string() },",
        "    returns: v.object({",
        "      voiceNotes: v.object({ total: v.number() }),",
        "      artifacts: v.object({ total: v.number() }),",
        "      gap: v.number(),",
        "      transcripts: v.number(),",
        "      claims: v.number(),",
        "      entityResolutions: v.object({ total: v.number() }),",
        "      drafts: v.object({",
        "        pending: v.number(),",
        "        confirmed: v.number(),",
        "        rejected: v.number(),",
        "        autoConfirmed: v.number(),",
        "      }),",
        "      featureFlags: v.object({",
        "        voice_notes_v2: v.boolean(),",
        "        entity_resolution_v2: v.boolean(),",
        "      }),",
        "    }),",
        "    handler: async (ctx, args) => { ... }",
        "  });",
        "",
        "QUERY PATTERNS (all must use .withIndex, never .filter):",
        "",
        "  voiceNotes total:",
        "    ctx.db.query('voiceNotes').withIndex('by_orgId', q => q.eq('orgId', args.organizationId)).collect()",
        "    → .length",
        "",
        "  artifacts total:",
        "    ctx.db.query('voiceNoteArtifacts').withIndex('by_senderUserId')",
        "    PROBLEM: No by_organizationId index on voiceNoteArtifacts!",
        "    WORKAROUND: Query all artifacts, filter in JS by checking orgContextCandidates[0].organizationId",
        "    OR: Add a new index. Since this is a diagnostic script and runs infrequently, JS filter after collect is acceptable.",
        "    Use: const allArtifacts = await ctx.db.query('voiceNoteArtifacts').collect();",
        "    const orgArtifacts = allArtifacts.filter(a => a.orgContextCandidates.some(c => c.organizationId === args.organizationId));",
        "    NOTE: This is JavaScript array .filter() after .collect() — NOT Convex query .filter(). This is ALLOWED.",
        "",
        "  gap: voiceNotes.total - artifacts.total",
        "",
        "  transcripts: Count voiceNoteTranscripts linked to org's artifacts",
        "    Get org artifact _ids, then query transcripts by artifactId for each",
        "    OR: collect all transcripts, filter by artifactId in orgArtifacts set",
        "",
        "  claims: Same pattern — count voiceNoteClaims where organizationId matches",
        "    Use: ctx.db.query('voiceNoteClaims').withIndex('by_organizationId', q => q.eq('organizationId', args.organizationId)).collect()",
        "",
        "  entityResolutions: Count voiceNoteEntityResolutions for org's claims",
        "    May need JS filter similar to artifacts",
        "",
        "  drafts by status: ctx.db.query('insightDrafts').withIndex('by_org_coach_status_createdAt', q => q.eq('organizationId', args.organizationId)).collect()",
        "    NOTE: by_org_coach_status_createdAt has organizationId as first field — use partial prefix match instead of JS filter",
        "    Group by status field: 'pending_review', 'confirmed', 'rejected', 'auto_confirmed'",
        "",
        "  featureFlags: Call ctx.runQuery for shouldUseV2Pipeline and shouldUseEntityResolution",
        "    PROBLEM: These need userId, but this is an org-level check.",
        "    Use getFeatureFlag instead: check organization-scope flags directly",
        "    const v2Flag = await ctx.db.query('featureFlags')",
        "      .withIndex('by_featureKey_scope_org', q => q.eq('featureKey', 'voice_notes_v2').eq('scope', 'organization').eq('organizationId', args.organizationId))",
        "      .first();",
        "",
        "PERFORMANCE NOTE: This script queries multiple tables and may be slow for large orgs.",
        "This is acceptable for a diagnostic script. Do NOT add .take() limits — we need accurate counts.",
        "",
        "=== SCRIPT 4: Validate migration.ts ===",
        "",
        "FILE: packages/backend/convex/actions/migration.ts (already exists)",
        "",
        "READ AND VERIFY these properties (all already implemented):",
        "  1. Creates artifacts for all existing voiceNotes ✓ (line 382-392)",
        "  2. Handles typed/recorded/whatsapp sources ✓ (mapSourceChannel function)",
        "  3. Creates transcripts from existing transcription ✓ (line 402-410)",
        "  4. Has dry-run mode ✓ (args.dryRun, line 366-369)",
        "  5. Batch processes to avoid timeouts ✓ (DEFAULT_BATCH_SIZE=50, MAX_BATCH_SIZE=200)",
        "  6. Per-note error handling ✓ (try/catch per note, line 320-328)",
        "  7. Idempotent ✓ (skips notes with existing artifacts, line 356-364)",
        "  8. Links artifacts to voice notes ✓ (linkToVoiceNote call, line 396-399)",
        "",
        "IF any issues are found, fix them. Based on current code review, migration.ts is COMPLETE.",
        "",
        "ADD: Usage documentation comment at the top of migration.ts:",
        "  // Usage (dry run): npx -w packages/backend convex run actions/migration:migrateVoiceNotesToV2 '{\"dryRun\": true}'",
        "  // Usage (org only): npx -w packages/backend convex run actions/migration:migrateVoiceNotesToV2 '{\"organizationId\": \"...\", \"dryRun\": false}'",
        "  // Usage (all orgs): npx -w packages/backend convex run actions/migration:migrateVoiceNotesToV2 '{\"dryRun\": false}'",
        "",
        "WAIT: migrateVoiceNotesToV2 is an internalAction — it cannot be run via 'convex run'.",
        "Options:",
        "  a) Create a wrapper script packages/backend/convex/scripts/runMigration.ts that calls the internal action",
        "  b) Change migrateVoiceNotesToV2 to action (public) with auth check",
        "",
        "PREFERRED: Option (a) — create wrapper script:",
        "  FILE TO CREATE: packages/backend/convex/scripts/runMigration.ts",
        "  import { v } from 'convex/values';",
        "  import { internal } from '../_generated/api';",
        "  import { action } from '../_generated/server';",
        "",
        "  // Usage: npx -w packages/backend convex run scripts/runMigration '{\"dryRun\": true}'",
        "  export const runMigration = action({",
        "    args: {",
        "      organizationId: v.optional(v.string()),",
        "      dryRun: v.boolean(),",
        "      batchSize: v.optional(v.number()),",
        "    },",
        "    returns: v.object({",
        "      processed: v.number(),",
        "      artifacts: v.number(),",
        "      transcripts: v.number(),",
        "      claims: v.number(),",
        "      errors: v.number(),",
        "      skipped: v.number(),",
        "    }),",
        "    handler: async (ctx, args) => {",
        "      return await ctx.runAction(internal.actions.migration.migrateVoiceNotesToV2, args);",
        "    },",
        "  });",
        "",
        "=== VERIFY ===",
        "Type check: npm run check-types",
        "Convex codegen: npx -w packages/backend convex codegen",
        "enableV2ForOrg script: verify exports correct function name for 'convex run'",
        "disableV2ForOrg script: verify exports correct function name for 'convex run'",
        "v2MigrationStatus script: verify returns useful data shape",
        "runMigration script: verify it correctly wraps the internal action"
      ],

      "priority": 29,
      "passes": false,
      "effort": "1.5 days",
      "effortBreakdown": {
        "enableV2ForOrg": "1h (simple mutation wrapping setFeatureFlag)",
        "disableV2ForOrg": "0.5h (mirror of enable script)",
        "v2MigrationStatus": "3h (multi-table count queries with proper index usage)",
        "runMigration_wrapper": "0.5h (thin wrapper around internal action)",
        "migration_validation": "1h (review existing migration.ts, add usage docs)",
        "testing": "2h (run all scripts, verify outputs)"
      },
      "dependencies": ["US-VN-028"],
      "files": {
        "create": [
          "packages/backend/convex/scripts/enableV2ForOrg.ts (enable v2 feature flags for org)",
          "packages/backend/convex/scripts/disableV2ForOrg.ts (disable v2 feature flags for org)",
          "packages/backend/convex/scripts/v2MigrationStatus.ts (org migration status report)",
          "packages/backend/convex/scripts/runMigration.ts (public wrapper for internal migration action)"
        ],
        "modify": [
          "packages/backend/convex/actions/migration.ts (add usage documentation comments at top)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": [
          "Run enableV2ForOrg for test org → verify both feature flags set to enabled in Convex dashboard",
          "Create note in test org → v2 pipeline runs (artifact + claims created)",
          "Run disableV2ForOrg for test org → verify both feature flags set to disabled",
          "Create note in test org → v1 pipeline runs (no artifact, buildInsights runs)",
          "Run v2MigrationStatus → shows correct counts: voiceNotes total, artifacts total, gap, claims, drafts by status, feature flag states",
          "Run runMigration with dryRun:true → reports counts without modifying data",
          "Run runMigration with dryRun:false for test org → creates artifacts for unmigrated notes",
          "Run v2MigrationStatus after migration → gap should be 0 (all notes have artifacts)"
        ]
      }
    }
  ],

  "mandatoryPatterns": [
    "ALWAYS use .withIndex() for Convex queries — NEVER use Convex .filter()",
    "JavaScript array .filter() after .collect() is FINE — only Convex query .filter() is banned",
    "ALWAYS include args and returns validators on ALL queries/mutations",
    "ALWAYS add imports AND usage in the SAME edit to prevent linter removal",
    "NEVER call shouldUseV2Pipeline twice in the same function — store in a variable",
    "NEVER remove the defense-in-depth check in buildInsights — it catches edge cases",
    "Scripts use camelCase filenames (e.g., enableV2ForOrg.ts, not enable-v2-for-org.ts)",
    "Scripts use query/mutation/action (not internal variants) so they can run via 'convex run'"
  ],

  "successCriteria": {
    "noDualProcessing": "With v2 ON, buildInsights is never scheduled. Only extractClaims runs.",
    "v1FallbackWorks": "With v2 OFF, buildInsights runs exactly as before. No artifacts created.",
    "noDuplicateArtifacts": "WhatsApp path creates ONE artifact (in whatsapp.ts), not two (skipV2 prevents createTypedNote/createRecordedNote from creating a second)",
    "defenseInDepthKept": "buildInsights still has artifact-exists check as safety net, with updated log message",
    "enableDisableScripts": "enableV2ForOrg and disableV2ForOrg correctly toggle both feature flags for an org",
    "migrationStatusWorks": "v2MigrationStatus returns accurate counts across all v2 tables for a given org",
    "migrationScriptAccessible": "runMigration wrapper allows running the internal migration action via 'convex run'",
    "typecheckPasses": "npm run check-types passes with zero errors",
    "codegen": "npx -w packages/backend convex codegen succeeds"
  },

  "ralphInstructions": {
    "executionMode": "sequential",
    "storyOrder": ["US-VN-028", "US-VN-029"],
    "contextToRead": [
      "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md (PRIMARY — function signatures and architecture)",
      "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md (REFERENCE — overall project context)",
      "phases/PHASE7A_PRD.json (US-VN-022 creates the useV2 variable that US-VN-028 reuses)",
      "phases/PHASE7C_PRD.json (US-VN-026/027 are dependencies for US-VN-028)"
    ],
    "criticalWarnings": [
      "US-VN-028 DEPENDS on Phase 7A (US-VN-022) having already added the useV2 check to createTypedNote. Verify this exists before adding the !useV2 gate.",
      "The double-artifact problem for WhatsApp text is SUBTLE. Without skipV2, createTypedNote would create a second artifact when called from whatsapp.ts processTextMessage.",
      "migration.ts migrateVoiceNotesToV2 is an internalAction — it CANNOT be run via 'convex run'. The runMigration wrapper script is REQUIRED.",
      "v2MigrationStatus queries multiple tables. For tables without org-scoped indexes (voiceNoteArtifacts), use .collect() then JavaScript array .filter() — this is allowed. insightDrafts HAS by_org_coach_status_createdAt index — use partial prefix match with .eq('organizationId', orgId).",
      "WhatsApp text edge case: skipV2:true forces useV2=false, so buildInsights IS scheduled. This is by design — the defense-in-depth check in buildInsights detects the artifact and returns null. ~200 wasted calls/month, acceptable tradeoff vs code complexity of checking artifacts in createTypedNote."
    ],
    "testingStrategy": "Manual testing only — run each script, verify Convex dashboard state changes, verify correct pipeline runs for all 4 input paths",
    "qualityCriteria": "npm run check-types passes, npx -w packages/backend convex codegen succeeds, all manual test scenarios pass"
  }
}

name: UAT Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  # Allow manual trigger for on-demand testing
  workflow_dispatch:
    inputs:
      test_category:
        description: "Test category to run (leave empty for all)"
        required: false
        default: ""
        type: choice
        options:
          - ""
          - "auth"
          - "admin"
          - "coach"
          - "flows"
          - "player"
          - "parent"
          - "org"

# Cancel previous runs when new commits are pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  # Default base URL for deployed staging/preview environment
  PLAYWRIGHT_BASE_URL: ${{ secrets.PLAYWRIGHT_BASE_URL || 'https://your-staging-url.vercel.app' }}

jobs:
  uat-tests:
    name: Playwright UAT Tests
    runs-on: ubuntu-latest
    timeout-minutes: 45
    # Enable when staging environment and secrets are configured
    # Remove 'if: false' after completing setup steps below
    if: false

    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install root dependencies
        run: npm ci
        working-directory: .

      - name: Install web app dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Create auth storage directory
        run: mkdir -p uat/.auth

      - name: Setup test authentication
        run: |
          echo "Setting up pre-authenticated sessions..."
          # The global-setup.ts will create auth states for each user
        env:
          CI: true

      - name: Run Playwright UAT tests
        run: |
          if [ -n "${{ github.event.inputs.test_category }}" ]; then
            npx playwright test --config=uat/playwright.config.ts uat/tests/${{ github.event.inputs.test_category }}/
          else
            npx playwright test --config=uat/playwright.config.ts
          fi
        env:
          CI: true
          PLAYWRIGHT_BASE_URL: ${{ env.PLAYWRIGHT_BASE_URL }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.NEXT_PUBLIC_CONVEX_URL }}
          # Test user credentials from GitHub secrets
          TEST_OWNER_EMAIL: ${{ secrets.TEST_OWNER_EMAIL }}
          TEST_OWNER_PASSWORD: ${{ secrets.TEST_OWNER_PASSWORD }}
          TEST_ADMIN_EMAIL: ${{ secrets.TEST_ADMIN_EMAIL }}
          TEST_ADMIN_PASSWORD: ${{ secrets.TEST_ADMIN_PASSWORD }}
          TEST_COACH_EMAIL: ${{ secrets.TEST_COACH_EMAIL }}
          TEST_COACH_PASSWORD: ${{ secrets.TEST_COACH_PASSWORD }}
          TEST_PARENT_EMAIL: ${{ secrets.TEST_PARENT_EMAIL }}
          TEST_PARENT_PASSWORD: ${{ secrets.TEST_PARENT_PASSWORD }}

      - name: Upload Playwright Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ github.run_id }}
          path: apps/web/uat/playwright-report/
          retention-days: 30

      - name: Upload Test Screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots-${{ github.run_id }}
          path: apps/web/uat/test-results/
          retention-days: 7

      - name: Create Test Summary
        if: always()
        run: |
          echo "## üß™ UAT Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f uat/test-results/results.json ]; then
            echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
            cat uat/test-results/results.json | jq -r '"- **Total Tests:** \(.stats.expected)"' >> $GITHUB_STEP_SUMMARY
            cat uat/test-results/results.json | jq -r '"- **Passed:** \(.stats.passed)"' >> $GITHUB_STEP_SUMMARY
            cat uat/test-results/results.json | jq -r '"- **Failed:** \(.stats.failed)"' >> $GITHUB_STEP_SUMMARY
            cat uat/test-results/results.json | jq -r '"- **Skipped:** \(.stats.skipped)"' >> $GITHUB_STEP_SUMMARY
          else
            echo "No test results file found." >> $GITHUB_STEP_SUMMARY
          fi

  # Placeholder job to show UAT tests are disabled
  uat-tests-disabled:
    name: Playwright UAT Tests (Disabled)
    runs-on: ubuntu-latest
    steps:
      - name: UAT Tests Skipped
        run: |
          echo "‚ö†Ô∏è UAT Tests are currently disabled"
          echo ""
          echo "These tests require a running Convex backend and environment setup."
          echo ""
          echo "To enable UAT tests, configure the following GitHub secrets:"
          echo "  - NEXT_PUBLIC_CONVEX_URL: Your Convex deployment URL"
          echo "  - TEST_ORG_ID: Test organization ID"
          echo "  - TEST_ADMIN_EMAIL / TEST_ADMIN_PASSWORD"
          echo "  - TEST_COACH_EMAIL / TEST_COACH_PASSWORD"
          echo ""
          echo "Then remove 'if: false' from the uat-tests job."

  # Optional: Run against staging environment
  uat-staging:
    name: UAT Tests (Staging)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Only run on main branch push when staging is configured
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && false

    defaults:
      run:
        working-directory: apps/web

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci
        working-directory: .

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run Playwright UAT tests against staging
        run: npx playwright test
        env:
          CI: true
          # Point to staging URL
          PLAYWRIGHT_BASE_URL: ${{ secrets.STAGING_URL }}
          NEXT_PUBLIC_CONVEX_URL: ${{ secrets.STAGING_CONVEX_URL }}
          TEST_ORG_ID: ${{ secrets.STAGING_TEST_ORG_ID }}

      - name: Upload staging test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-staging
          path: apps/web/playwright-report/
          retention-days: 30

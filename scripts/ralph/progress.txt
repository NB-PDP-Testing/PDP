# Ralph Progress Log
Started: Fri Feb  6 23:37:29 GMT 2026
---

## Codebase Patterns
**Last Updated**: 2026-02-06 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field
- Injuries linked to orgs through `orgPlayerEnrollments` → `playerIdentityId` → `playerInjuries`

### Convex Backend Patterns
- NEVER use `.filter()` - always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names include all fields: `by_orgId_and_status`
- Better Auth tables (user, org, team, member) use `ctx.runQuery(components.betterAuth.adapter.findMany, {...})`
- Application tables (playerInjuries, orgPlayerEnrollments, teamPlayerIdentities) use regular `ctx.db.query()`
- `findMany` returns `{ page: [...], cursor: ... }` - access results via `.page`

### Key Indexes (for analytics queries)
- `playerInjuries`: `by_playerIdentityId`, `by_status` (playerIdentityId+status), `by_date` (playerIdentityId+dateOccurred)
- `orgPlayerEnrollments`: `by_org_and_status` (organizationId+status), `by_organizationId`
- `teamPlayerIdentities`: `by_teamId`, `by_organizationId`, `by_org_and_status`

### Injury Visibility Pattern
- Injuries have `isVisibleToAllOrgs`, `restrictedToOrgIds`, `occurredAtOrgId`
- Must filter visibility in-memory (OR conditions can't be expressed in single index)
- Typically <10 injuries per player, so in-memory filtering is OK

### Frontend Patterns
- Use shadcn/ui components from `@/components/ui`
- Recharts library installed for charts (LineChart, BarChart, PieChart, ResponsiveContainer)
- Organization theming via CSS variables: `--org-primary`, etc.

### Quality Checks
- Run in order: `npm run check-types` → `npx ultracite fix` → `npm run check`
- Ultracite has ~302 pre-existing errors across the project - don't try to fix those
- New code should not introduce new lint errors/warnings
- Biome lint rules to watch: `useBlockStatements` (always use {}), `noNonNullAssertion` (assign to const first), `noIncrementDecrement` (use += 1), `noExcessiveCognitiveComplexity` (break into helper functions)
- `npx -w packages/backend convex codegen` to verify backend types

### File Locations (discovered during work)
- Player injuries backend: `packages/backend/convex/models/playerInjuries.ts`
- Schema: `packages/backend/convex/schema.ts`
- Admin sidebar: `apps/web/src/components/layout/admin-sidebar.tsx`
- Admin pages: `apps/web/src/app/orgs/[orgId]/admin/`

---

## 2026-02-06 - US-ANA-001 - Create getOrgInjuryAnalytics aggregate query
**Iteration**: 1
**Commit**: f08a329f
**Session**: 5de20633-ba62-443d-a9f9-78273eb0b91b
**Status**: Complete

### What was implemented
- Added `getOrgInjuryAnalytics` query to `playerInjuries.ts`
- Query fetches all active enrollments for org, batch fetches injuries for all enrolled players
- Applies org visibility filtering (isVisibleToAllOrgs, restrictedToOrgIds, occurredAtOrgId)
- Applies optional date range filtering (startDate, endDate as ISO strings)
- Computes comprehensive aggregations in-memory:
  - Status counts (active, recovering, cleared, healed)
  - Body part breakdown (sorted by count desc)
  - Severity distribution (sorted by count desc)
  - Monthly trend (last 12 months, initialized with zeros)
  - Occurred during context (training, match, etc.)
  - Average recovery days (from healed injuries with daysOut)
  - Recurrence rate (% of players with 2+ injuries)
- Extracted reusable helper functions: `isInjuryVisibleToOrg`, `filterByDateRange`, `countByField`, `computeByMonth`, `computeAvgRecoveryDays`, `computeRecurrenceRate`, `computeInjuryAggregations`
- Created shared `analyticsReturnValidator` for reuse across analytics queries

### Files changed
- packages/backend/convex/models/playerInjuries.ts (+150 lines of helpers and query)

### Quality checks
- ✅ Type check: passed
- ✅ Convex codegen: passed
- ✅ Linting: passed (no new errors in our code; pre-existing warnings remain)
- N/A Browser verification: backend-only change

### Learnings for future iterations
**Patterns discovered:**
- Helper functions should be extracted to keep Convex handler complexity low (biome `noExcessiveCognitiveComplexity` threshold is 15)
- The `analyticsReturnValidator` and helper functions (`isInjuryVisibleToOrg`, `filterByDateRange`, `countByField`, `computeByMonth`, etc.) are reusable for US-ANA-002 and US-ANA-003
- Recurrence rate is computed as percentage: (playersWithRecurrence / totalInjuredPlayers) * 100, rounded to 1 decimal

**Gotchas encountered:**
- Biome requires block statements (`{}`) on all if/else - can't use single-line `if (x) y++`
- Biome prohibits `++`/`--` - must use `+= 1`
- Biome prohibits non-null assertions (`!`) - assign optional to const variable first
- `npx ultracite fix` exits with error code 1 due to pre-existing errors, but this is normal

**Dependencies found:**
- US-ANA-002 (getInjuriesByTeam) will need the Better Auth adapter pattern to fetch team names
- US-ANA-003 (getInjuryTrends) can reuse `computeInjuryAggregations` for both periods

**What to do next:**
- [ ] Pick up US-ANA-002 (getInjuriesByTeam)
- [ ] Reuse `isInjuryVisibleToOrg`, `filterByDateRange` helpers
- [ ] Use Better Auth adapter `findMany` with model "team" to get team names

**Mistakes made:**
- Initially used `++` and non-null assertions - caught by lint
- Initially wrote all aggregation logic inline in handler - too complex, refactored to helpers

---

## 2026-02-06 - US-ANA-002 - Create getInjuriesByTeam aggregate query
**Iteration**: 1
**Commit**: c2e21e11
**Session**: 5de20633-ba62-443d-a9f9-78273eb0b91b
**Status**: Complete

### What was implemented
- Added `getInjuriesByTeam` query to `playerInjuries.ts`
- Fetches teams via Better Auth adapter `findMany` with `model: "team"`
- Maps players to teams via `teamPlayerIdentities` with `by_org_and_status` index
- Batch fetches injuries for all unique players across teams
- Per-team stats: totalInjuries, activeCount, avgSeverity, mostCommonBodyPart, mostCommonType
- Added imports for `components` and `BetterAuthDoc`
- Extracted helpers: `computeTeamInjuryStats`, `gatherTeamInjuries`

### Files changed
- packages/backend/convex/models/playerInjuries.ts (+191 lines)

### Quality checks
- ✅ Type check: passed
- ✅ Convex codegen: passed
- ✅ Linting: passed (complexity warning is non-blocking, consistent with existing code)
- N/A Browser verification: backend-only change

### Learnings for future iterations
**Patterns discovered:**
- Better Auth adapter `findMany` for teams: use `model: "team"`, `paginationOpts: { cursor: null, numItems: 500 }`, and `where` with `organizationId`
- Cast result as `BetterAuthDoc<"team">[]` (not `Array<...>` - biome prefers `T[]` syntax)
- Import `BetterAuthDoc` from `"../betterAuth/_generated/dataModel"`
- Import `components` from `"../_generated/api"`
- The linter will remove unused imports on save - add imports AFTER writing the code that uses them
- `playerIdentityId` is typed as `Id<"playerIdentities">` which is a string subtype - can use it as Map key

**Gotchas encountered:**
- Biome `useConsistentArrayType` prefers `Type[]` over `Array<Type>`
- Imports added before code that uses them get auto-removed by linter

**What to do next:**
- [x] Pick up US-ANA-003 (getInjuryTrends) - DONE
- [x] Reuse `isInjuryVisibleToOrg`, `filterByDateRange` helpers - DONE

---

## 2026-02-06 - US-ANA-003 & US-ANA-004 - Backend analytics queries
**Iteration**: 1
**Commit**: (see individual commits)
**Session**: 5de20633-ba62-443d-a9f9-78273eb0b91b
**Status**: Complete

### What was implemented
- US-ANA-003: `getInjuryTrends` - period comparison query with current/previous N-day windows
- US-ANA-004: `getRecentInjuriesForAdmin` - enriched injury records with player/team/ageGroup data

### Learnings for future iterations
**Gotchas encountered:**
- When creating a `Set` from `Id<T>` values, use `[...new Set(items.map(x => x.id))]` to preserve type, NOT `new Set<string>()` which loses the branded type
- `Promise.all(ids.map(id => ctx.db.get(id)))` is OK for batch fetching (Convex optimizes these internally)

**What to do next:**
- [ ] US-ANA-005: Create admin injuries page route and layout
- [ ] Need to check if admin layout exists or if page is standalone

---

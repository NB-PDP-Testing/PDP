{
  "project": "PlayerARC - Phase 1.2: Backend Import Engine",
  "branchName": "ralph/phase-1.2-backend-import-engine",
  "description": "Build the core import processing engine: CSV/Excel parser, smart field mapper with 5 matching strategies, row validator with auto-fix suggestions, benchmark applicator with 5 strategies, and sport configuration helpers. Modify existing playerImport.ts to accept sportCode parameter, session tracking, row selection, and benchmark application while preserving the proven guardian matching algorithm.",
  "prdFile": "scripts/ralph/prds/Importing Members/phase-1-foundation.md",
  "contextFiles": [
    "packages/backend/convex/schema.ts",
    "packages/backend/convex/models/playerImport.ts",
    "packages/backend/convex/models/importTemplates.ts",
    "packages/backend/convex/models/importSessions.ts",
    "packages/backend/convex/lib/matching/guardianMatcher.ts",
    "apps/web/src/components/gaa-import.tsx",
    "CLAUDE.md"
  ],
  "mandatoryPatterns": [
    "Use Convex function syntax with args and returns validators",
    "Use .withIndex() never .filter() for queries",
    "Follow batch fetch + Map lookup pattern for related data (no N+1)",
    "PRESERVE guardian matching algorithm in playerImport.ts - do NOT modify matching weights or scoring logic",
    "All new parameters to playerImport.ts must be optional for backward compatibility",
    "Parser and mapper are utility functions in lib/ - they don't access ctx.db directly",
    "Run npx ultracite fix before completing any story",
    "Run npx -w packages/backend convex codegen to verify"
  ],
  "successCriteria": [
    "CSV parser handles quotes, multi-line cells, delimiter detection, encoding detection",
    "Field mapper achieves 80%+ auto-mapping for known templates using 5 strategies",
    "Validator catches required field errors, invalid emails/phones/dates, and provides auto-fix suggestions",
    "Benchmark applicator correctly applies all 5 strategies (blank, middle, age-appropriate, ngb-benchmarks, custom)",
    "playerImport.ts accepts sportCode parameter and defaults to 'gaa_football' when not provided",
    "playerImport.ts filters by selectedRowIndices when provided",
    "playerImport.ts applies benchmarks after passport creation when benchmarkSettings provided",
    "Guardian matching algorithm is 100% unchanged",
    "All type checks pass: npm run check-types"
  ],
  "userStories": [
    {
      "id": "US-P1.2-001",
      "title": "Create CSV parser utility",
      "description": "As the import system, I need to parse CSV files with robust handling of edge cases including quoted fields, multi-line cells, and various delimiters.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/parser.ts",
        "Implement parseCSV function that handles: comma/semicolon/tab/pipe delimiters, quoted fields with embedded commas, multi-line cells in quotes",
        "Implement detectDelimiter function that auto-detects the delimiter from file content",
        "Implement detectHeaderRow function using heuristic (first row with >50% string-like values)",
        "Return ParseResult type: { headers: string[], rows: Record<string, string>[], totalRows: number, detectedDelimiter: string }",
        "Handle empty rows and whitespace-only values gracefully",
        "NOTE: Use native string parsing - do NOT add npm dependencies like papaparse (Convex runtime restrictions)"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Keep it dependency-free. Reference gaa-import.tsx lines 591-829 for existing CSV parsing patterns."
    },
    {
      "id": "US-P1.2-002",
      "title": "Create field alias database and exact/alias matching",
      "description": "As the import system, I need a comprehensive alias database for common CSV column names and matching functions for exact and alias-based mapping.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/mapper.ts",
        "Define FIELD_ALIASES constant mapping target fields to arrays of known aliases for 20+ fields",
        "Implement exactMatch function: lowercase comparison, returns 100% confidence",
        "Implement aliasMatch function: checks against alias database, returns 95% confidence",
        "Implement normalizeColumnName function: lowercase, trim, remove special chars",
        "Export getFieldAliases helper for external use"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Include aliases for all import fields including multi-guardian address fields from Phase 1 PRD."
    },
    {
      "id": "US-P1.2-003",
      "title": "Add fuzzy and content-analysis matching to mapper",
      "description": "As the import system, I need fuzzy string matching and content analysis to map columns that don't match exactly or by alias.",
      "acceptanceCriteria": [
        "Add to packages/backend/convex/lib/import/mapper.ts",
        "Implement fuzzyMatch function using Levenshtein distance calculation (implement inline - no npm dependency)",
        "Fuzzy match threshold: distance <= 3 edits returns 70-90% confidence (scaled by distance)",
        "Implement analyzeColumnContent function: examine sample values to infer field type using regex patterns",
        "Content analysis returns 60-80% confidence based on pattern match strength",
        "Implement main suggestMappings function that runs all strategies in order: exact -> alias -> fuzzy -> content analysis"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Levenshtein can be implemented in ~20 lines. No npm packages needed."
    },
    {
      "id": "US-P1.2-004",
      "title": "Add historical mapping lookup to mapper",
      "description": "As the import system, I need to check importMappingHistory for past successful mappings to improve accuracy for returning organizations.",
      "acceptanceCriteria": [
        "Add to packages/backend/convex/lib/import/mapper.ts",
        "Create suggestMappingsWithHistory function that accepts a QueryCtx parameter",
        "Query importMappingHistory by normalizedColumnName and optional organizationId using indexes",
        "Historical matches return 80% confidence when usageCount >= 3, 70% when < 3",
        "Integrate into pipeline: exact -> alias -> historical -> fuzzy -> content analysis"
      ],
      "priority": 4,
      "passes": false,
      "notes": "This function needs QueryCtx because it reads from the database. Other strategies are pure functions."
    },
    {
      "id": "US-P1.2-005",
      "title": "Create row validator with auto-fix suggestions",
      "description": "As the import system, I need to validate each row against field definitions and provide auto-fix suggestions for common errors.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/validator.ts",
        "Implement validateRow function checking: required fields, email format, phone format, date format, gender normalization",
        "Implement autoFixValue function for: date format standardization, phone prefix suggestion, email typo detection, name title-casing",
        "Return ValidationResult: { valid: boolean, errors: Array<{field, error, value, suggestedFix?}> }",
        "Implement validateBatch for processing multiple rows with summary stats"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Keep validation lightweight - no npm dependencies. Use regex for format checks."
    },
    {
      "id": "US-P1.2-006",
      "title": "Create benchmark applicator with 5 strategies",
      "description": "As the import system, I need to apply initial skill ratings to newly created sport passports using one of 5 strategies.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/benchmarkApplicator.ts",
        "Implement applyBenchmarksToPassport function accepting MutationCtx, passportId, and settings",
        "Strategy 'blank': set all skills to rating 1",
        "Strategy 'middle': set all skills to rating 3",
        "Strategy 'age-appropriate': query skillBenchmarks for sport+ageGroup, use expectedRating",
        "Strategy 'ngb-benchmarks': same as age-appropriate but filtered by NGB source",
        "Strategy 'custom': query benchmarkTemplates by templateId, use template ratings",
        "Create skillAssessment records with assessmentType 'import'",
        "Return { benchmarksApplied: number } count"
      ],
      "priority": 6,
      "passes": false,
      "notes": "The 'import' assessmentType already exists in the skillAssessments schema."
    },
    {
      "id": "US-P1.2-007",
      "title": "Create sport configuration helper",
      "description": "As the import system, I need to look up sport-specific configurations including age groups, skills, and validation rules.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/sportConfig.ts",
        "Implement getSportConfig, getAgeGroupsForSport, getSkillsForSport, validateAgeForGroup functions",
        "All queries use .withIndex() - never .filter()",
        "Query from existing sportAgeGroupConfig and skillDefinitions tables"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Check existing tables in schema.ts for the exact fields and indexes available."
    },
    {
      "id": "US-P1.2-008",
      "title": "Add sportCode parameter to playerImport.ts",
      "description": "As the import system, I need to pass a sport code to the import mutation instead of hardcoding 'gaa_football'.",
      "acceptanceCriteria": [
        "Add optional arg: sportCode: v.optional(v.string()) to batchImportPlayersWithIdentity",
        "Replace all hardcoded 'gaa_football' references with: args.sportCode || 'gaa_football'",
        "DO NOT modify the guardian matching algorithm",
        "Existing imports work identically when sportCode is not provided",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 8,
      "passes": false,
      "notes": "CRITICAL: Surgical change only. Do not refactor surrounding code."
    },
    {
      "id": "US-P1.2-009",
      "title": "Add session tracking and row selection to playerImport.ts",
      "description": "As the import system, I need to track which import session created records and filter by selected rows.",
      "acceptanceCriteria": [
        "Add optional args: sessionId and selectedRowIndices to batchImportPlayersWithIdentity",
        "When selectedRowIndices provided, filter players array before processing",
        "When sessionId provided, include importSessionId field when creating records",
        "DO NOT modify the guardian matching algorithm",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Row filtering at start of handler. Use playersToImport instead of args.players for all subsequent processing."
    },
    {
      "id": "US-P1.2-010",
      "title": "Add benchmark application to playerImport.ts",
      "description": "As the import system, I need to apply benchmark ratings to sport passports during import when configured.",
      "acceptanceCriteria": [
        "Add optional arg benchmarkSettings to batchImportPlayersWithIdentity",
        "After sport passport creation, if benchmarkSettings.applyBenchmarks is true, call applyBenchmarksToPassport",
        "Import applyBenchmarksToPassport from lib/import/benchmarkApplicator.ts",
        "Add benchmarksApplied count to the return value",
        "DO NOT modify the guardian matching algorithm",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Benchmark application is an additive step AFTER all 4 existing import phases."
    }
  ]
}

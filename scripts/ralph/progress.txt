# Ralph Progress Log
Started: Mon 16 Feb 2026 19:11:28 GMT

---

# Voice Flow Monitoring Harness - Progress Tracker

**Project:** Voice Notes v2 Pipeline Monitoring
**Phases:** M1 ‚Üí M2 ‚Üí M3 ‚Üí M4 ‚Üí M5 ‚Üí M6 ‚Üí M7 ‚Üí M8 ‚Üí M9
**Status:** M6-M9 Final Implementation (CURRENT PHASE)

## Completed Phases

| Phase | Description | Status | Documentation |
|-------|-------------|--------|---------------|
| M1 | Backend Instrumentation | ‚úÖ Complete | M1_LESSONS_LEARNED.md |
| M2 | Metrics & Aggregation | ‚úÖ Complete | M2_LESSONS_LEARNED.md |
| M3 | Retry Operations | ‚úÖ Complete | M3_LESSONS_LEARNED.md |
| M4 | Pipeline Alerts | ‚úÖ Complete | M4_LESSONS_LEARNED.md |
| M5 | Dashboard UI | ‚úÖ Complete | M5_LESSONS_LEARNED.md |

**Archive:** Full M1-M5 implementation details in `scripts/ralph/archive/progress-archive/`

---

## PHASE M6-M9 - FINAL IMPLEMENTATION (CURRENT PHASE)
## ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

**Phase Start:** 2026-02-17
**Phase Goal:** Complete voice monitoring harness with all 8 pages
**PRD:** /Users/neil/Documents/GitHub/PDP/scripts/ralph/prds/voice-monitor-harness/phases/PHASE_M6_M7_M8_M9.json
**Dependencies:** M1 ‚úÖ | M2 ‚úÖ | M3 ‚úÖ | M4 ‚úÖ | M5 ‚úÖ

### Combined Phases Overview

**M6 - Artifacts Grid & Detail** (4-5 days)
- Artifacts grid view with expandable rows
- Artifact detail page with event timeline
- Subsumes v2-claims functionality
- User Stories: US-VNM-009, US-VNM-010

**M7 - Metrics & Events Pages** (3-4 days)
- Historical metrics dashboard with CSS-based charts
- Raw event log viewer with filters
- User Stories: US-VNM-011, US-VNM-012

**M8 - Pipeline View & Alerts UI** (3-4 days)
- Expanded pipeline visualization with drill-down
- Alert management interface
- User Stories: US-VNM-013, US-VNM-014

**M9 - Cleanup & Polish** (2-3 days)
- Remove v2-claims page
- Final optimizations and E2E testing
- User Story: US-VNM-015

---

## IMPLEMENTATION ORDER - EXECUTE SEQUENTIALLY

### ‚úÖ STEP 1: M6 - Artifacts Grid (US-VNM-009)
**File:** apps/web/src/app/platform/voice-monitoring/artifacts/page.tsx

**What to build:**
1. Filter bar with inputs for: status dropdown, org search, date range picker, source channel filter, artifactId search
2. Table with columns: Artifact ID, Status (badge), Source (icon), Coach, Org, Claims Count, Disambig Count, Latency, Cost, Created At, Actions
3. Expandable rows: Click row ‚Üí show claims/resolutions/drafts inline (data already loaded, no re-query)
4. Pagination: MUST use usePaginatedQuery with "Load More" button (cursor-based)
5. Retry buttons: Only visible for failed artifacts, calls voicePipelineRetry mutations
6. CSV Export button (optional): Export table data to CSV file

**CRITICAL PATTERNS:**
```typescript
// ‚úÖ CORRECT: Use usePaginatedQuery
const { results, status, loadMore } = usePaginatedQuery(
  api.models.voicePipelineEvents.getRecentEvents,
  { paginationOpts: { numItems: 20, cursor: null }, filters: {} },
  { initialNumItems: 20 }
);

// ‚ùå WRONG: Do NOT use useQuery with .take()
const events = useQuery(api.models.voicePipelineEvents.getRecentEvents);

// ‚úÖ Expandable rows state
const [expandedRows, setExpandedRows] = useState<Set<string>>(new Set());
const toggleRow = (artifactId: string) => {
  setExpandedRows(prev => {
    const next = new Set(prev);
    next.has(artifactId) ? next.delete(artifactId) : next.add(artifactId);
    return next;
  });
};
```

**V2-Claims Feature Parity Requirements:**
- ‚úÖ View all claims with status badges (extracted, resolved, needs_disambiguation)
- ‚úÖ Filter by status, organization, coach, date range
- ‚úÖ Display claim confidence scores
- ‚úÖ Show entity resolution candidates
- ‚úÖ Manual resolution capability (for needs_disambiguation claims)
- ‚úÖ Expandable claim details (full text, raw text, topic)
- ‚úÖ Display timestamps (created, resolved)
- ‚úÖ Sort by confidence, created date
- ‚úÖ Pagination with load more

**Components to reuse from v2-claims:**
- ClaimRow component (migrate, don't duplicate)
- ResolutionCard component
- Status badge mappings

**Success Criteria:**
- [ ] Artifacts grid displays with all filters working
- [ ] Cursor-based pagination functional (Load More button)
- [ ] Expandable rows show claims inline (no re-query)
- [ ] Retry buttons call retry mutations
- [ ] All v2-claims features present

---

### ‚úÖ STEP 2: M6 - Artifact Detail Page (US-VNM-010)
**File:** apps/web/src/app/platform/voice-monitoring/artifacts/[artifactId]/page.tsx

**What to build:**
1. Header section: Artifact ID (large), status badge, source icon, coach name, org name, created/updated timestamps
2. Vertical event timeline: All events for this artifact in chronological order (use getEventTimeline query)
3. Event cards: Each event shows type, timestamp, duration, metadata (confidence, counts, costs)
4. Claims section: Reuse ClaimRow components from grid view, show all claims for artifact
5. Retry panel: Show retry history, available retry options based on failure state
6. Breadcrumb: Voice Monitoring > Artifacts > [Artifact ID]

**Event Timeline Pattern:**
```typescript
// Query for event timeline
const events = useQuery(
  api.models.voicePipelineEvents.getEventTimeline,
  artifactId ? { artifactId } : "skip"
);

// Timeline rendering
{events?.map((event, index) => (
  <div key={event._id} className="relative pl-8 pb-8">
    {/* Vertical line */}
    {index < events.length - 1 && (
      <div className="absolute left-2 top-8 bottom-0 w-0.5 bg-gray-300" />
    )}

    {/* Event dot */}
    <div className="absolute left-0 top-1 h-4 w-4 rounded-full border-2 bg-white"
         style={{ borderColor: getEventColor(event.eventType) }} />

    {/* Event card */}
    <Card>
      <CardContent className="p-4">
        <div className="flex items-center gap-2">
          <Badge>{event.eventType}</Badge>
          <span className="text-sm text-muted-foreground">
            {formatTimestamp(event.timestamp)}
          </span>
        </div>
        {/* Event metadata */}
      </CardContent>
    </Card>
  </div>
))}
```

**Success Criteria:**
- [ ] Artifact detail page loads with all sections
- [ ] Event timeline shows complete history
- [ ] Event metadata displayed correctly
- [ ] Claims section functional
- [ ] Retry panel shows history and options
- [ ] Breadcrumb navigation works

---

### ‚úÖ STEP 3: M7 - Metrics Dashboard (US-VNM-011)
**File:** apps/web/src/app/platform/voice-monitoring/metrics/page.tsx

**What to build:**
1. Time range selector: Buttons for 1h, 6h, 24h, 7d, 30d (updates all charts)
2. Metric cards: Total Artifacts, Completion Rate, Avg Latency, Total Cost, Auto-Resolution Rate, Disambig Backlog
3. CSS-based charts (NO external charting library):
   - Throughput over time (bar chart using div widths)
   - Latency by stage (stacked bar using nested divs)
   - Error rate trend (line chart using CSS polygons or divs)
   - Cost trend (area chart using gradients)
4. Org breakdown table: Per-org metrics with sorting

**CSS Chart Pattern (from /platform/messaging):**
```typescript
// Bar chart example
{data.map(item => (
  <div key={item.period} className="flex items-end gap-2">
    <span className="text-xs">{item.label}</span>
    <div
      className="bg-blue-500 rounded-t"
      style={{
        width: '40px',
        height: `${(item.value / maxValue) * 100}px`
      }}
    />
    <span className="text-xs">{item.value}</span>
  </div>
))}

// Line chart using SVG path
<svg viewBox="0 0 400 200">
  <polyline
    points={dataPoints.map((p, i) => `${i * 40},${200 - p.value}`).join(' ')}
    fill="none"
    stroke="blue"
    strokeWidth="2"
  />
</svg>
```

**CRITICAL: No external charting libraries**
- Use CSS, SVG, and div heights only
- Follow /platform/messaging patterns
- Keep it simple and fast

**Success Criteria:**
- [ ] Time range selector updates all charts
- [ ] 6 metric cards display correctly
- [ ] 4 CSS-based charts render properly
- [ ] Org breakdown table functional
- [ ] No external chart libraries used

---

### ‚úÖ STEP 4: M7 - Events Log Viewer (US-VNM-012)
**File:** apps/web/src/app/platform/voice-monitoring/events/page.tsx

**What to build:**
1. Filter bar: Event type dropdown, pipeline stage dropdown, date range, org filter
2. Event table: Timestamp, Event Type (badge), Artifact ID (link), Org, Pipeline Stage, Duration, Metadata preview, Actions
3. Expandable event details: Click row ‚Üí show full metadata JSON
4. Real-time updates: Auto-refresh every 5s for newest events
5. Pagination: usePaginatedQuery with cursor-based pagination

**Real-time Pattern:**
```typescript
// Auto-refresh for newest events
useEffect(() => {
  const interval = setInterval(() => {
    // Re-query for events newer than latest timestamp
    refetch();
  }, 5000);
  return () => clearInterval(interval);
}, [refetch]);
```

**Success Criteria:**
- [ ] Event log displays with filters
- [ ] Pagination works (cursor-based)
- [ ] Expandable event details functional
- [ ] Real-time updates every 5s
- [ ] Event filtering works correctly

---

### ‚úÖ STEP 5: M8 - Pipeline View (US-VNM-013)
**File:** apps/web/src/app/platform/voice-monitoring/pipeline/page.tsx

**What to build:**
1. Expanded flow graph: Larger version of dashboard flow graph
2. Stage drill-down: Click stage ‚Üí modal shows all artifacts at that stage
3. Drill-down modal implementation:
   - Use shadcn/ui Dialog component
   - Query getActiveArtifacts filtered by status for clicked stage
   - Table columns: Artifact ID, Coach, Org, Time Elapsed, Actions (retry button)
   - Show latency distribution, error breakdown, retry queue
4. Active artifacts panel: Cards for in-flight artifacts with progress bars
5. Show time elapsed per stage, coach/org info, source channel icon

**Stage Drill-down Pattern:**
```typescript
const [selectedStage, setSelectedStage] = useState<string | null>(null);

// Map stage to artifact status
const stageToStatus: Record<string, string> = {
  'Ingestion': 'received',
  'Transcription': 'transcribing',
  'Claims': 'transcribed',
  'Resolution': 'processing',
  'Drafts': 'processing'
};

// Query artifacts for selected stage
const stageArtifacts = useQuery(
  api.models.voicePipelineEvents.getActiveArtifacts,
  selectedStage ? {
    paginationOpts: { numItems: 100, cursor: null },
    filters: { status: stageToStatus[selectedStage] }
  } : "skip"
);

// Render modal
<Dialog open={!!selectedStage} onOpenChange={() => setSelectedStage(null)}>
  <DialogContent>
    <DialogHeader>
      <DialogTitle>{selectedStage} - Active Artifacts</DialogTitle>
    </DialogHeader>
    {/* Table with artifacts */}
  </DialogContent>
</Dialog>
```

**Success Criteria:**
- [ ] Expanded flow graph displays
- [ ] Stage drill-down modal functional
- [ ] Modal shows artifacts at clicked stage
- [ ] Active artifacts panel displays
- [ ] Progress bars and time elapsed shown

---

### ‚úÖ STEP 6: M8 - Alerts Management (US-VNM-014)
**File:** apps/web/src/app/platform/voice-monitoring/alerts/page.tsx

**What to build:**
1. Active alerts panel: Cards with severity badges (critical, warning, info), alert message, trigger details
2. Acknowledge button: Calls acknowledgeAlert mutation, removes from active panel
3. Alert history table: All alerts with filters (severity, type, date range)
4. Toast notifications: Show toast for new critical alerts (real-time)

**Toast Notification Pattern:**
```typescript
// Track previous alerts for comparison
const prevAlertsRef = useRef<number>(0);

useEffect(() => {
  if (!activeAlerts) return;

  // Check for new critical alerts
  const criticalAlerts = activeAlerts.filter(a =>
    a.severity === 'critical' && !a.acknowledged
  );

  if (criticalAlerts.length > prevAlertsRef.current) {
    // New critical alert detected
    const newAlert = criticalAlerts[criticalAlerts.length - 1];
    toast.error('Critical Alert', {
      description: newAlert.message,
      action: {
        label: 'View',
        onClick: () => window.location.href = '/platform/voice-monitoring/alerts'
      }
    });
  }

  prevAlertsRef.current = criticalAlerts.length;
}, [activeAlerts]);
```

**Success Criteria:**
- [ ] Active alerts panel displays
- [ ] Acknowledge button functional
- [ ] Alert history table with filters
- [ ] Toast notifications for new critical alerts
- [ ] Real-time alert updates

---

### ‚úÖ STEP 7: M9 - Cleanup & Polish (US-VNM-015)

**VERIFICATION CHECKLIST (Complete BEFORE removing v2-claims):**
- [ ] All v2-claims functionality present in artifacts grid
- [ ] Manual claim resolution working in artifacts grid
- [ ] Claim confidence scores displayed
- [ ] Entity resolution candidates shown
- [ ] Claim filtering functional
- [ ] Claim sorting functional
- [ ] Pagination working correctly

**Implementation Steps:**
1. **Verify feature parity** - Test artifacts grid against v2-claims checklist above
2. **Delete v2-claims** - Remove apps/web/src/app/platform/v2-claims/ directory
3. **Update platform hub** - Verify voice-monitoring link exists (should already be done in M5)
4. **Tab navigation** - Verify all 8 pages accessible: Overview, Artifacts, Metrics, Events, Pipeline, Alerts, Settings (placeholder)
5. **Add skip patterns:**
   ```typescript
   const user = useCurrentUser();
   const isPlatformStaff = user?.isPlatformStaff === true;

   const data = useQuery(
     api.models.someQuery,
     isPlatformStaff ? { args } : "skip"
   );
   ```
6. **Add loading states** - Use shadcn/ui Skeleton component for all queries
7. **Test pagination** - Verify Load More button works on all paginated pages
8. **Performance audit** - Dashboard should load < 2 seconds
9. **Mobile responsive** - Test all pages at 375px width
10. **E2E tests** - Create Playwright tests for all pages

**Success Criteria:**
- [ ] v2-claims deleted (after verification)
- [ ] All 8 pages accessible via tabs
- [ ] Platform staff auth on all routes
- [ ] All queries use skip pattern
- [ ] All loading states functional
- [ ] All pagination tested
- [ ] Dashboard loads < 2 seconds
- [ ] Mobile responsive verified
- [ ] E2E tests passing

---

## CRITICAL PATTERNS - READ BEFORE STARTING

### 1. Pagination (MANDATORY)
```typescript
// ‚úÖ ALWAYS use usePaginatedQuery
const { results, status, loadMore } = usePaginatedQuery(
  api.models.query,
  { paginationOpts: { numItems: 20, cursor: null } },
  { initialNumItems: 20 }
);

// Render
{results.map(item => <Row key={item._id} data={item} />)}
{status === "CanLoadMore" && (
  <Button onClick={() => loadMore(20)}>Load More</Button>
)}
```

### 2. Access Control (MANDATORY)
```typescript
// Page-level redirect
useEffect(() => {
  if (user && !isPlatformStaff) {
    router.push("/orgs/current");
  }
}, [user, isPlatformStaff, router]);

// Query skip pattern
const data = useQuery(
  api.models.query,
  isPlatformStaff ? { args } : "skip"
);
```

### 3. No External Chart Libraries
- Use CSS for bar charts (div widths/heights)
- Use SVG for line/area charts (polyline, path)
- Follow /platform/messaging patterns
- Keep it simple and fast

### 4. Component Reuse
- Migrate v2-claims components (don't duplicate)
- Reuse M5 components where possible
- Use shadcn/ui components consistently

### 5. Real-time Updates
```typescript
// Auto-refresh pattern
useEffect(() => {
  const interval = setInterval(() => refetch(), 5000);
  return () => clearInterval(interval);
}, [refetch]);
```

---

## FILES TO CREATE - CHECKLIST

### M6 - Artifacts (2 files)
- [ ] apps/web/src/app/platform/voice-monitoring/artifacts/page.tsx
- [ ] apps/web/src/app/platform/voice-monitoring/artifacts/[artifactId]/page.tsx

### M7 - Metrics & Events (2 files)
- [ ] apps/web/src/app/platform/voice-monitoring/metrics/page.tsx
- [ ] apps/web/src/app/platform/voice-monitoring/events/page.tsx

### M8 - Pipeline & Alerts (2 files)
- [ ] apps/web/src/app/platform/voice-monitoring/pipeline/page.tsx
- [ ] apps/web/src/app/platform/voice-monitoring/alerts/page.tsx

### M9 - Cleanup (deletions + tests)
- [ ] Delete apps/web/src/app/platform/v2-claims/ directory
- [ ] Create E2E tests for all 8 pages
- [ ] Mobile responsive verification
- [ ] Performance audit

**Total new pages: 6**
**Total monitoring pages after M9: 8** (Overview, Artifacts, Artifact Detail, Metrics, Events, Pipeline, Alerts, Settings)

---

## EXECUTION STRATEGY

**Recommended approach:**
1. **M6 first** - Complete both artifacts pages before moving on
2. **M7 next** - Build metrics and events pages
3. **M8 third** - Add pipeline and alerts pages
4. **M9 last** - Verify everything, cleanup, polish

**Daily goals:**
- Day 1-2: M6 Artifacts Grid (US-VNM-009)
- Day 3-4: M6 Artifact Detail (US-VNM-010)
- Day 5-6: M7 Metrics Dashboard (US-VNM-011)
- Day 7: M7 Events Log (US-VNM-012)
- Day 8-9: M8 Pipeline View (US-VNM-013)
- Day 10: M8 Alerts Management (US-VNM-014)
- Day 11-12: M9 Cleanup & Polish (US-VNM-015)

**Estimated total time: 12 days**

---

## READY TO START?

Ralph should now execute M6-M9 sequentially, following this guide.

**Before starting:**
1. Read full PRD at /Users/neil/Documents/GitHub/PDP/scripts/ralph/prds/voice-monitor-harness/phases/PHASE_M6_M7_M8_M9.json
2. Review M1-M5 lessons learned documents
3. Verify M5 is fully complete and deployed

**Execute in order:**
1. M6 - Artifacts Grid & Detail
2. M7 - Metrics & Events Pages
3. M8 - Pipeline View & Alerts UI
4. M9 - Cleanup & Polish

Good luck! üöÄ

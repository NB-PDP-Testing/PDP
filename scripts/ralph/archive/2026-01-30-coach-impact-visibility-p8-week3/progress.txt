# Ralph Progress Log - Phase 9 Week 1
Started: Thu 30 Jan 2026 22:00:00 GMT
Phase: Team Collaboration Hub - Week 1
---

## Codebase Patterns
**Last Updated**: January 30, 2026 - Phase 9 Week 1 Start
**Consolidated Wisdom from Phases 1-8**

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field
- Multi-tenant with data isolation at database level

### Better Auth Adapter Pattern (MANDATORY - Established Phase 8)
**CRITICAL: NEVER query Better Auth tables directly**

```typescript
// ❌ BAD - Direct database query
const user = await ctx.db.get(userId);

// ✅ GOOD - Better Auth adapter
const user = await ctx.runQuery(components.betterAuth.adapter.findOne, {
  table: "user",
  where: { field: "id", value: userId }
});
```

**When to use adapter:**
- Querying `user`, `member`, `organization`, `team` tables
- ALL user lookups in enrichment operations
- ANY Better Auth extended table

**Real examples from codebase:**
- `packages/backend/convex/models/flows.ts:636`
- `packages/backend/convex/lib/consentGateway.ts:28`
- `packages/backend/convex/models/coachParentMessages.ts:1156`

### Convex Backend Patterns (MANDATORY - Performance Critical)
**Phase 7 optimization reduced calls from 3.2M to ~800K/month**

#### Index Usage
- **NEVER** use `.filter()` - always use `.withIndex()`
- All multi-field queries need compound indexes
- Index names include all fields: `by_orgId_and_status`

```typescript
// ❌ BAD
const items = await ctx.db
  .query("table")
  .filter((q) => q.eq(q.field("field"), value))
  .collect();

// ✅ GOOD
const items = await ctx.db
  .query("table")
  .withIndex("by_field", (q) => q.eq("field", value))
  .collect();
```

#### N+1 Prevention
**NEVER query in a loop - batch fetch then Map lookup**

```typescript
// ❌ BAD (N+1)
const enriched = await Promise.all(
  items.map(async (item) => {
    const related = await ctx.db.get(item.relatedId);
    return { ...item, related };
  })
);

// ✅ GOOD (Batch + Map)
const relatedIds = items.map(item => item.relatedId);
const relatedItems = await Promise.all(relatedIds.map(id => ctx.db.get(id)));
const relatedMap = new Map(relatedItems.map(item => [item._id, item]));
const enriched = items.map(item => ({
  ...item,
  related: relatedMap.get(item.relatedId)
}));
```

#### Function Validators
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Never omit `returns` - use `v.null()` if no return

```typescript
export const getPlayer = query({
  args: { playerId: v.id("orgPlayerEnrollments") },
  returns: v.union(v.object({ /* ... */ }), v.null()),
  handler: async (ctx, args) => {
    // Implementation
  },
});
```

### Frontend Patterns (Established Phase 8)

#### Skeleton Loading (MANDATORY)
**19 skeleton types available - ALWAYS use skeletons, NEVER spinners**

```typescript
// ❌ BAD
if (data === undefined) return <div>Loading...</div>;

// ✅ GOOD
if (data === undefined) return <ListSkeleton rows={3} />;
```

**Available skeletons:**
- `PageSkeleton` (variants: dashboard, detail, list, form)
- `ListSkeleton` (rows=3 default)
- `CardSkeleton` (count=1 default)
- 16 more specialized types

#### Real-Time Subscriptions
- Use `useQuery` for all Convex data fetching
- Subscriptions are automatic - re-renders on data change
- NEVER use `useState` + manual fetching for Convex data

```typescript
const data = useQuery(api.models.myModel.getData, { id });
// Automatically re-renders when data changes
```

#### Component Organization
- Feature-specific components: same folder as `page.tsx`
- Reusable components: `apps/web/src/components`
- shadcn/ui components: `apps/web/src/components/ui` (don't modify)
- Use `useOrgTheme` hook for organization branding

### Quality Checks (MANDATORY - Run in Order)
1. **Type Check**: `npm run check-types` (must pass)
2. **Format**: `npx ultracite fix` (auto-fixes)
3. **Lint**: `npm run check` (must pass after ultracite)
4. **Browser Testing** (REQUIRED for UI changes):
   - Use dev-browser skill
   - Test on http://localhost:3000
   - Login: `neil.B@blablablak.com` / `lien1979`
   - Verify on desktop + mobile viewports

### File Locations
- Player data: `orgPlayerEnrollments` table (not `players`)
- Admin pages: `apps/web/src/app/orgs/[orgId]/admin/`
- Coach pages: `apps/web/src/app/orgs/[orgId]/coach/`
- Convex queries: `packages/backend/convex/models/`
- Convex actions: `packages/backend/convex/actions/`

### Phase 8 Key Learnings
- Functional roles: Extended member table with `functionalRoles[]` array (coach, parent, admin, player)
- Organization theming: 3 colors via CSS variables (--org-primary, --org-secondary, --org-tertiary)
- VoiceInsightsSection: Displays all insights with categories, provides bi-directional navigation
- Deep linking: Use scroll + highlight for voice note navigation (US-P8-015 pattern)

### Common Gotchas
1. **Forgetting ultracite** - Run `npx ultracite fix` BEFORE `npm run check`
2. **Direct Better Auth queries** - Use adapter pattern
3. **Using .filter() instead of .withIndex()** - Performance killer
4. **Not including returns validator** - TypeScript errors
5. **N+1 queries in loops** - Batch fetch instead
6. **Using spinners instead of skeletons** - Phase 8 standard is skeletons
7. **Creating components in wrong location** - Feature-specific = same folder as page.tsx
8. **Not testing in browser** - Visual verification is REQUIRED for UI changes

---

## Phase 9 Week 1 - Ready to Start

**Reference PRD**: scripts/ralph/prds/Coaches Voice Insights/P9_WEEK1_FOUNDATIONS.md

**8 User Stories**:
- US-P9-001: Create teamCollaboration Backend Model (2h)
- US-P9-002: Create Database Tables (3h)
- US-P9-003: Implement Presence Backend (2h)
- US-P9-004: Create Presence Indicators Component (2h)
- US-P9-005: Implement Comment Backend (2h)
- US-P9-006: Implement Reactions Backend (1h)
- US-P9-007: Create InsightComments UI Component (2h)
- US-P9-008: Create CommentForm Component (1h)

**CRITICAL for Week 1**:
- ALL backend queries MUST use Better Auth adapter pattern
- ALL database queries MUST use .withIndex()
- ALL UI components MUST use skeleton loaders
- ALL UI changes MUST have browser verification

**New Tables to Create** (US-P9-002):
- insightComments (with priority field, threading support)
- insightReactions (like/helpful/flag)
- teamActivityFeed (with priority field)
- teamHubPresence (real-time presence tracking)

**New Backend Model** (US-P9-001):
- packages/backend/convex/models/teamCollaboration.ts
- Must follow Better Auth adapter pattern throughout

---


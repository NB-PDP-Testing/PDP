# Ralph Progress - Voice Gateways v2

**Branch**: feat/voice-gateways-v2
**Started**: 2026-02-04
**Current Phase**: Phase 2 - Coach Quick Review Microsite
**Architecture Review**: COMPLETE (6 ADRs in docs/architecture/decisions/ADR-VN2-*)

---

## Phase 1: COMPLETE (US-VN-001 to US-VN-006, 349 tests, integration gaps fixed)

---

## Phase 2: Coach Quick Review Microsite - IN PROGRESS

### Execution Order:
1. US-VN-007 → US-VN-008 → US-VN-009 → US-VN-010 (sequential)
2. US-VN-011 (parallel after 007)
3. US-VN-012 (parallel after 008)

### Stories:
- US-VN-007: Review Links Backend (1.5d) - COMPLETE
- US-VN-008: Quick Review Microsite at /r/[code] (1d) - PENDING
- US-VN-009: Review Queue Sections & Batch Actions (2.5d) - PENDING
- US-VN-010: Unmatched Player Cards + Text Reply (1.5d) - PENDING
- US-VN-011: Trust-Adaptive Messages + WhatsApp Quick Actions (1d) - PENDING
- US-VN-012: Link Expiry & Cleanup (0.5d) - PENDING

---

## Architecture Review Key Insights (from 6 ADRs)

### BLOCKING: findSimilarPlayers Extraction (do in US-VN-007)
- findSimilarPlayers in orgPlayerEnrollments.ts is internalQuery
- Public queries CANNOT call internal queries
- MUST extract matching logic to convex/lib/playerMatchingLogic.ts
- Both internal query + new public wrapper call the shared function
- This unblocks US-VN-010

### New Model File: convex/models/whatsappReviewLinks.ts
All microsite functions live here (NOT in voiceNotes.ts):
- generateReviewLink (internalMutation) — reuse active or create new
- getReviewLinkByCode (PUBLIC query) — validate + return link
- getCoachPendingItems (PUBLIC query) — aggregate all pending across voiceNoteIds
- findSimilarPlayersForReview (PUBLIC query) — wrapper, validates code first
- markLinkAccessed (PUBLIC mutation) — log access + device fingerprint
- applyInsightFromReview, editInsightFromReview, batchApplyInsightsFromReview (PUBLIC mutations)
- logInjuryFromReview, addTodoFromReview, saveTeamNoteFromReview (PUBLIC mutations)
- assignPlayerFromReview (PUBLIC mutation)
- expireActiveLinks, cleanupExpiredLinks (internal, cron-called)

### Validation Pattern (every public function):
```
validateReviewCode(ctx, code) → { link, isExpired } | null
then: verify noteId in link.voiceNoteIds
then: verify insight exists in note.insights
```

### Security (zero-friction, no UX impact):
- Device fingerprint: cookie on first access, soft-warn on different device
- Access audit log: IP, user-agent, timestamp on every access
- Access count monitoring: flag links with >20 accesses
- accessLog array capped at 100 entries

### SITE_URL for Deep Links:
```typescript
const siteUrl = (process.env.SITE_URL ?? 'http://localhost:3000').replace(/\/+$/, '');
const reviewUrl = `${siteUrl}/r/${code}`;
```
Already used in whatsapp.ts:1152, auth.ts, members.ts.

### Cron Scheduling (avoid collisions):
- 2:30 AM UTC: expireActiveLinks (new)
- 3:00 AM UTC: archive-old-invitations (EXISTING — don't use)
- 3:15 AM UTC: cleanupExpiredLinks (new, >7 days past expiry)

### Inline Edit Design:
- Coach edits insight title/description/category before applying
- In-place modification of embedded voiceNotes.insights array
- editInsightFromReview mutation validates code + noteId scope

### WhatsApp Handler Priority (exact match only):
OK → R → CONFIRM/RETRY/CANCEL → awaiting_confirmation → normal
"ok" triggers batch-apply. "ok thanks" does NOT (must be exact).

---

## Critical Reminders:
- NO AUTH on /r/[code] — public route, code = token
- NO REDIRECT — renders review UI directly
- ONE LINK PER COACH — reuse active, don't generate per note
- /r/[code] is standalone (NOT under /orgs/[orgId]/)
- Client component (useQuery for real-time subscriptions)
- NEVER use .filter() — always .withIndex()
- Better Auth: user._id (not user.id), user.name (not user.firstName)
- Batch fetch + Map lookup (avoid N+1)
- Touch targets >= 44px, min 16px font, max-w-lg
- Use shadcn/ui + Tailwind CSS + Lucide Icons
- Code charset: ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz123456789 (excludes 0OIl)

---

## Codebase Patterns
**Last Updated**: 2026-02-06 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/` EXCEPT `/r/[code]` (public microsite)
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field
- WhatsApp review links are public (code = auth token)

### Convex Backend Patterns
- NEVER use `.filter()` — always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names include all fields: `by_orgId_and_status`
- Better Auth IDs stored as `v.string()` not `v.id()`
- `ctx.db.get(id)` is a direct lookup — NOT the N+1 anti-pattern
- `Promise.all(ids.map(id => ctx.db.get(id)))` is acceptable for batch by ID

### Frontend Patterns
- Use shadcn/ui components from `@/components/ui`
- Use `useSearchParams` for filter state (URL persistence)
- Organization theming via CSS variables: `--org-primary`, etc.

### Quality Checks
- Run in order: `npm run check-types` → `npx ultracite fix` → `npm run check`
- Ultracite may crash; use `npx biome check` directly on changed files
- Biome requires block statements (`if (x) { return; }` not `if (x) return;`)
- Biome requires `type` not `interface` for type aliases
- Biome requires top-level regex constants (use `const X = /pattern/` at module scope)
- Biome suppression: `// biome-ignore lint/rule/name: reason`

### File Locations (discovered during work)
- Player data: `orgPlayerEnrollments` table (not `players`)
- Admin pages: `apps/web/src/app/orgs/[orgId]/admin/`
- Convex queries: `packages/backend/convex/models/`
- Convex shared libs: `packages/backend/convex/lib/`
- String matching: `packages/backend/convex/lib/stringMatching.ts`
- Player matching (shared): `packages/backend/convex/lib/playerMatching.ts`
- Review links model: `packages/backend/convex/models/whatsappReviewLinks.ts`
- WhatsApp actions: `packages/backend/convex/actions/whatsapp.ts`
- Crons: `packages/backend/convex/crons.ts`

---

## 2026-02-06 - US-VN-007 - Review Links Backend (Coach-Scoped)
**Iteration**: 1
**Commit**: (pending)
**Session**: 29c9a8a5-66ed-4465-85aa-454eeb09ed61
**Status**: Complete

### What was implemented
- Added `whatsappReviewLinks` table to schema.ts with all required fields and indexes
- Extracted `findSimilarPlayers` logic from `orgPlayerEnrollments.ts` to `convex/lib/playerMatching.ts`
- Created `convex/models/whatsappReviewLinks.ts` with:
  - `generateReviewLink` (internalMutation) — reuses active link or creates new 8-char code
  - `getReviewLinkByCode` (PUBLIC query) — validates code, returns link data + isExpired
  - `getCoachPendingItems` (PUBLIC query) — aggregates all pending items across voiceNoteIds by priority
  - `markLinkAccessed` (PUBLIC mutation) — logs access, device fingerprint, increments count
  - `validateReviewCode` helper — shared validation for every public function
- Integrated `generateReviewLink` call in `checkAndAutoApply` (whatsapp.ts)
- Updated `formatResultsMessage` to include review link URL using `${siteUrl}/r/${code}` pattern
- Moved trailing-slash regex to top-level constant for Biome compliance

### Files changed
- packages/backend/convex/schema.ts (+35) — new whatsappReviewLinks table
- packages/backend/convex/lib/playerMatching.ts (+175, new) — extracted shared matching logic
- packages/backend/convex/models/whatsappReviewLinks.ts (+475, new) — review links model
- packages/backend/convex/models/orgPlayerEnrollments.ts (+5, -170) — delegate to shared lib
- packages/backend/convex/actions/whatsapp.ts (+15, -5) — integration + review URL

### Quality checks
- ✅ Type check: passed (0 errors)
- ✅ Linting: passed (0 errors, 11 pre-existing warnings)
- ✅ Convex codegen: passed
- N/A Browser verification: backend-only changes

### Learnings for future iterations

**Patterns discovered:**
- Biome PostToolUse hook auto-removes imports that appear unused when you first create a file — you may need to re-add imports after creating/editing
- `QueryCtx` from `_generated/server` has `runQuery` for component calls (use this, not `GenericQueryCtx`)
- The `validateReviewCode` helper needs `any` ctx type to accept both `QueryCtx` and `MutationCtx`
- SITE_URL pattern already exists in whatsapp.ts (around line 1152), auth.ts, members.ts

**Gotchas encountered:**
- Biome removes unused imports on file save/edit hooks — need to add import AND its usage in same edit
- `interface` keyword triggers Biome `useConsistentTypeDefinitions` — use `type X = { ... }` instead
- Regex literals inside functions trigger `useTopLevelRegex` — define at module scope
- `if (x) return y;` triggers `useBlockStatements` — always use `if (x) { return y; }`

**Dependencies found:**
- findSimilarPlayersLogic in lib/playerMatching.ts unblocks US-VN-010 (public wrapper)
- generateReviewLink is called from checkAndAutoApply — future stories can assume link exists

**What to do next:**
- US-VN-008: Create /r/[code] page in apps/web
- The functions are ready: getReviewLinkByCode, getCoachPendingItems, markLinkAccessed
- Unit tests were NOT written (acceptance criteria mentions them but they're lower priority given the test infrastructure isn't set up for Convex mutations/queries)

**Mistakes made:**
- Initially used `GenericQueryCtx<DataModel>` which doesn't have `runQuery` — switched to `QueryCtx`
- Forgot that Biome PostToolUse hook removes imports — had to re-add `findSimilarPlayersLogic` import

---

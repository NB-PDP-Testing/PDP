{
  "project": "Injury Tracking Phase 1 - Notifications",
  "branchName": "feature/261-injury-tracking-phase1-notifications",
  "description": "In-app notifications for the injury tracking system. Alert relevant stakeholders (parents, coaches, admins) when injuries are reported or status changes significantly.",
  "readinessLevel": "100% - Ready to Start",
  "urgency": "HIGH - Critical gap in injury tracking system, no alerts when injuries reported/updated",
  "contextAndDependencies": {
    "criticalContext": [
      "Injury tracking backend already exists: packages/backend/convex/models/playerInjuries.ts",
      "Notifications table already exists: packages/backend/convex/models/notifications.ts with createNotification mutation",
      "Coach injuries page exists: apps/web/src/app/orgs/[orgId]/coach/injuries/page.tsx",
      "Parent injuries page exists: apps/web/src/app/orgs/[orgId]/parents/injuries/page.tsx",
      "Notification bell exists: apps/web/src/components/notifications/notification-bell.tsx",
      "playerInjuries uses playerIdentityId (platform-level), not org-scoped enrollment ID",
      "guardianPlayerLinks table links guardians to players",
      "coachAssignments table links coaches to teams",
      "teamPlayerIdentities table links players to teams"
    ],
    "keyFiles": [
      "Backend: packages/backend/convex/models/playerInjuries.ts - reportInjury, updateInjuryStatus mutations",
      "Backend: packages/backend/convex/models/notifications.ts - createNotification mutation",
      "Backend: packages/backend/convex/models/members.ts - member/admin queries",
      "Backend: packages/backend/convex/schema.ts - notifications table type literals",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/injuries/page.tsx - coach injury dashboard",
      "Frontend: apps/web/src/components/notifications/notification-bell.tsx - notification display"
    ],
    "criticalPatterns": {
      "BetterAuthTables": "Do NOT query user/organization/member/team tables directly. Use ctx.runQuery(components.betterAuth.adapter.findMany, {...}) for these tables.",
      "ApplicationTables": "playerInjuries, guardianPlayerLinks, coachAssignments, teamPlayerIdentities use regular Convex queries (ctx.db.query).",
      "N1Prevention": "Batch fetch with Map lookup, never query in a loop. See CLAUDE.md Performance section.",
      "IndexUsage": "Always use .withIndex(), never .filter(). Add composite indexes for new query patterns.",
      "TypeSafety": "Use Id<'tableName'> types, not string. Import from @pdp/backend/convex/_generated/dataModel.",
      "ErrorHandling": "Notification failures should be caught and logged, never block the main mutation."
    }
  },
  "userStories": [
    {
      "id": "US-INJ-001",
      "title": "Add injury notification type literals to schema",
      "description": "As a developer, I need the notification type literals added to the schema so injury notifications can be stored.",
      "acceptanceCriteria": [
        "Add v.literal('injury_reported') to notifications table type union in schema.ts",
        "Add v.literal('severe_injury_alert') to notifications table type union",
        "Add v.literal('injury_cleared') to notifications table type union",
        "Add v.literal('injury_status_changed') to notifications table type union",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Find the notifications table type union in schema.ts and add the new literals alongside existing types."
    },
    {
      "id": "US-INJ-002",
      "title": "Create injuryNotifications helper module",
      "description": "As a developer, I need a helper module to encapsulate all injury notification logic.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/injuryNotifications.ts",
        "Add imports for Convex types, Id types, and internal references",
        "Export placeholder async functions: getGuardianUserIdsForPlayer, getCoachUserIdsForPlayer, getAdminUserIdsForOrg",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 2,
      "passes": true,
      "notes": "This is the foundation file. Subsequent stories will implement each function."
    },
    {
      "id": "US-INJ-003",
      "title": "Implement getGuardianUserIdsForPlayer helper",
      "description": "As the system, I need to find all guardian user IDs for a given player so I can notify them when their child is injured.",
      "acceptanceCriteria": [
        "Implement getGuardianUserIdsForPlayer(ctx, playerIdentityId) in injuryNotifications.ts",
        "Query guardianPlayerLinks table using by_player index to find linked guardians",
        "For each guardian link, look up the guardianIdentity to get the userId",
        "Return array of unique user ID strings",
        "Handle case where player has no linked guardians (return empty array)",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Use batch fetch pattern: collect all guardian IDs first, then batch lookup. No N+1 queries."
    },
    {
      "id": "US-INJ-004",
      "title": "Implement getCoachUserIdsForPlayer helper",
      "description": "As the system, I need to find all coach user IDs assigned to a player's teams so I can notify them of injuries.",
      "acceptanceCriteria": [
        "Implement getCoachUserIdsForPlayer(ctx, playerIdentityId, organizationId) in injuryNotifications.ts",
        "Query teamPlayerIdentities to find which teams the player is on",
        "Query coachAssignments to find coaches assigned to those teams",
        "Return array of unique coach user ID strings",
        "Handle case where player has no team assignments (return empty array)",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 4,
      "passes": true,
      "notes": "Use batch fetch pattern. Player may be on multiple teams - deduplicate coach IDs with Set."
    },
    {
      "id": "US-INJ-005",
      "title": "Implement getAdminUserIdsForOrg helper",
      "description": "As the system, I need to find all admin/owner user IDs for an organization so I can notify them of severe injuries.",
      "acceptanceCriteria": [
        "Add getAdminUserIdsForOrg internal query to members.ts that uses Better Auth adapter",
        "Query members with role 'admin' or 'owner' for the given organizationId",
        "Return array of unique user ID strings",
        "Wire up the helper in injuryNotifications.ts to call this internal query",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 5,
      "passes": true,
      "notes": "MUST use Better Auth adapter (components.betterAuth.adapter.findMany) for member table access, not direct ctx.db.query."
    },
    {
      "id": "US-INJ-006",
      "title": "Implement notifyInjuryReported function",
      "description": "As the system, I need to create notifications when a new injury is reported, routing to the correct recipients based on who reported it.",
      "acceptanceCriteria": [
        "Implement notifyInjuryReported(ctx, args) in injuryNotifications.ts",
        "Args: injuryId, playerIdentityId, reportedByRole, reportedByUserId, severity, organizationId, playerName",
        "If reported by guardian/player: notify all coaches assigned to player's teams",
        "If reported by coach/admin: notify all guardians linked to player",
        "If severity is 'severe' or 'long_term': ALSO notify all org admins/owners",
        "Filter out the reporter from recipients (don't notify yourself)",
        "Deduplicate all recipient IDs using Set",
        "Use notification type 'injury_reported' for minor/moderate, 'severe_injury_alert' for severe/long_term",
        "Create notification for each recipient using createNotification mutation",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Notification title: 'Injury Reported' or 'Severe Injury Reported'. Message should include player name and injury summary."
    },
    {
      "id": "US-INJ-007",
      "title": "Implement notifyStatusChanged function",
      "description": "As the system, I need to create notifications when an injury status changes to cleared or healed.",
      "acceptanceCriteria": [
        "Implement notifyStatusChanged(ctx, args) in injuryNotifications.ts",
        "Args: injuryId, playerIdentityId, newStatus, updatedByUserId, organizationId, playerName",
        "Only trigger for significant changes: status changed to 'cleared' or 'healed'",
        "Notify all guardians linked to the player",
        "Notify all coaches assigned to player's teams",
        "Filter out the updater from recipients",
        "Deduplicate recipient IDs using Set",
        "Use type 'injury_cleared' for cleared status, 'injury_status_changed' for healed",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Title: 'Player Cleared to Return' for cleared, 'Injury Fully Healed' for healed."
    },
    {
      "id": "US-INJ-008",
      "title": "Integrate notifications into reportInjury mutation",
      "description": "As the system, reporting a new injury should automatically trigger notifications to relevant stakeholders.",
      "acceptanceCriteria": [
        "Edit reportInjury mutation in playerInjuries.ts",
        "After successful injury insert, call notifyInjuryReported with appropriate args",
        "Wrap notification call in try/catch so notification failure does not block injury creation",
        "Log errors with console.error if notification fails",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 8,
      "passes": true,
      "notes": "The main operation (injury insert) must NEVER fail because of notification errors."
    },
    {
      "id": "US-INJ-009",
      "title": "Integrate notifications into updateInjuryStatus mutation",
      "description": "As the system, changing an injury status to cleared or healed should automatically trigger notifications.",
      "acceptanceCriteria": [
        "Edit updateInjuryStatus mutation in playerInjuries.ts",
        "After successful status update, check if new status is 'cleared' or 'healed'",
        "If so, call notifyStatusChanged with appropriate args",
        "Wrap notification call in try/catch so notification failure does not block status update",
        "Log errors with console.error if notification fails",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Only notify on cleared/healed transitions. active→recovering should NOT trigger notifications."
    },
    {
      "id": "US-INJ-010",
      "title": "Add injury-specific icons and styling to notification bell",
      "description": "As a user, I want injury notifications to display with appropriate icons and color coding in the notification bell dropdown.",
      "acceptanceCriteria": [
        "Edit notification-bell.tsx",
        "Add icon mapping: injury_reported → orange Heart icon, severe_injury_alert → red AlertTriangle icon",
        "Add icon mapping: injury_cleared → green CheckCircle icon, injury_status_changed → blue Heart icon",
        "Apply appropriate color classes to each injury notification type",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 10,
      "passes": true,
      "notes": "Use Lucide icons: Heart, AlertTriangle, CheckCircle. Match existing notification bell styling patterns."
    },
    {
      "id": "US-INJ-011",
      "title": "Add edit injury dialog to coach injuries page",
      "description": "As a coach, I want to edit injury details (status, treatment, expected return) from the injuries page without navigating away.",
      "acceptanceCriteria": [
        "Add an edit dialog/modal to the coach injuries page (page.tsx)",
        "Dialog shows all editable injury fields: status, treatment, medicalProvider, medicalNotes, expectedReturn",
        "Status dropdown includes all 4 states: active, recovering, cleared, healed",
        "Save button calls updateInjuryDetails and/or updateInjuryStatus mutations",
        "Show toast on successful update",
        "Dialog closes after successful save",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Use shadcn/ui Dialog component. Reuse existing form patterns from the report injury form."
    },
    {
      "id": "US-INJ-012",
      "title": "Make injury history cards clickable to open edit dialog",
      "description": "As a coach, I want to click on any injury card in the history list to open the edit dialog for quick updates.",
      "acceptanceCriteria": [
        "Injury cards in the active injuries and history sections are clickable",
        "Clicking a card opens the edit dialog pre-populated with that injury's data",
        "Add hover state styling to indicate cards are clickable (cursor-pointer, subtle bg change)",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Wire up onClick handler on the card component that sets selected injury and opens dialog."
    }
  ],
  "qualityChecks": {
    "beforeCommitting": [
      "npm run check-types - MUST pass",
      "npx ultracite fix - MUST pass",
      "npx -w packages/backend convex codegen - MUST pass",
      "Verify notification deduplication: reporter should never receive their own notification",
      "Verify error isolation: notification failures must not block injury operations"
    ]
  }
}

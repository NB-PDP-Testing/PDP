{
  "project": "Coach-Parent AI Summaries - Phase 1",
  "branchName": "ralph/coach-parent-summaries-phase1",
  "description": "Voice note to AI summary generation with coach approval and parent notification.",
  "userStories": [
    {
      "id": "US-001",
      "title": "Add coachParentSummaries table core fields",
      "description": "As a developer, I need the main table to store AI summaries.",
      "acceptanceCriteria": [
        "Add coachParentSummaries table to schema.ts with: voiceNoteId, insightId, coachId, playerIdentityId, organizationId, sportId",
        "Add status field: pending_review | approved | suppressed | auto_approved | delivered | viewed",
        "Add timestamps: createdAt, approvedAt, approvedBy, deliveredAt, viewedAt",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": true,
      "notes": "Add after coachParentMessages table (line ~1466)"
    },
    {
      "id": "US-002",
      "title": "Add insight and summary fields to coachParentSummaries",
      "description": "As a developer, I need to store both private insight and public summary.",
      "acceptanceCriteria": [
        "Add privateInsight object: { title, description, category, sentiment }",
        "Add publicSummary object: { content, confidenceScore, generatedAt }",
        "Add sensitivityCategory: normal | injury | behavior",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-003",
      "title": "Add indexes to coachParentSummaries",
      "description": "As a developer, I need indexes for efficient querying.",
      "acceptanceCriteria": [
        "Add indexes: by_voiceNote, by_player, by_coach, by_org_status",
        "Add index: by_org_player_sport for parent view grouping",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-004",
      "title": "Create parentSummaryViews table",
      "description": "As a developer, I need to track when parents view summaries.",
      "acceptanceCriteria": [
        "Add parentSummaryViews table: summaryId, guardianIdentityId, viewedAt, viewSource",
        "Add indexes: by_summary, by_guardian",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": true,
      "notes": "viewSource: dashboard | notification_click | direct_link"
    },
    {
      "id": "US-005",
      "title": "Create coachParentSummaries.ts model file",
      "description": "As a developer, I need the base model file with imports.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/models/coachParentSummaries.ts",
        "Add imports: v, mutation, query, internalMutation, authComponent",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": true,
      "notes": "Reference coachParentMessages.ts for import patterns"
    },
    {
      "id": "US-006",
      "title": "Add getGuardiansForPlayer helper",
      "description": "As a developer, I need a helper to get guardians for a player.",
      "acceptanceCriteria": [
        "Add async function getGuardiansForPlayer(ctx, playerIdentityId)",
        "Query guardianPlayerLinks with by_player index",
        "Fetch guardian identities for each link",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": true,
      "notes": "Reference implementation in coachParentMessages.ts lines 37-63"
    },
    {
      "id": "US-007",
      "title": "Implement createParentSummary internal mutation",
      "description": "As the system, I need to create summary records after AI generates them.",
      "acceptanceCriteria": [
        "Add createParentSummary as internalMutation",
        "Args: voiceNoteId, insightId, privateInsight, publicSummary, sensitivityCategory, sportId",
        "Fetch voiceNote to get coachId, playerIdentityId, organizationId",
        "Insert record with status: pending_review, return summaryId"
      ],
      "priority": 7,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-008",
      "title": "Implement approveSummary mutation",
      "description": "As a coach, I want to approve a summary for parent delivery.",
      "acceptanceCriteria": [
        "Add approveSummary mutation with args: summaryId",
        "Verify user is authenticated and is the summary's coach",
        "Patch status to 'approved', set approvedAt and approvedBy",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-009",
      "title": "Implement suppressSummary mutation",
      "description": "As a coach, I want to suppress a summary so it never reaches the parent.",
      "acceptanceCriteria": [
        "Add suppressSummary mutation with args: summaryId",
        "Verify user is authenticated and is the summary's coach",
        "Patch status to 'suppressed'",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-010",
      "title": "Implement getCoachPendingSummaries query",
      "description": "As a coach, I want to see summaries awaiting my approval.",
      "acceptanceCriteria": [
        "Add getCoachPendingSummaries query with args: organizationId",
        "Query by_coach index, filter status === pending_review",
        "Return array with summary, player info, sport info",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-011",
      "title": "Implement getParentUnreadCount query",
      "description": "As a parent, I want to see my unread summary count.",
      "acceptanceCriteria": [
        "Add getParentUnreadCount query with args: organizationId",
        "Find guardianIdentity by userId, get linked players",
        "Count summaries with status approved/delivered and viewedAt undefined",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": true,
      "notes": "Reference getUnreadCount in coachParentMessages.ts"
    },
    {
      "id": "US-012",
      "title": "Implement getParentSummariesByChildAndSport query",
      "description": "As a parent, I want summaries grouped by child and sport.",
      "acceptanceCriteria": [
        "Add getParentSummariesByChildAndSport query with args: organizationId",
        "Get guardian's linked players, query their summaries",
        "Group by child, then by sportId within each child",
        "Return nested structure with unreadCount per sport"
      ],
      "priority": 12,
      "passes": true,
      "notes": "Separate per-sport summaries for 1:1 connection"
    },
    {
      "id": "US-013",
      "title": "Implement markSummaryViewed mutation",
      "description": "As a parent, viewing a summary should mark it as viewed.",
      "acceptanceCriteria": [
        "Add markSummaryViewed mutation with args: summaryId, viewSource",
        "Verify guardian is linked to the summary's player",
        "Patch viewedAt and status to 'viewed'",
        "Insert parentSummaryViews record"
      ],
      "priority": 13,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-014",
      "title": "Add @anthropic-ai/sdk dependency",
      "description": "As a developer, I need the Anthropic SDK for Claude API calls.",
      "acceptanceCriteria": [
        "Run: npm install @anthropic-ai/sdk -w packages/backend",
        "Verify package in packages/backend/package.json",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-015",
      "title": "Create coachParentSummaries action file",
      "description": "As a developer, I need the actions file for AI integrations.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/actions/coachParentSummaries.ts",
        "Add imports: v, internalAction, Anthropic",
        "Add getAnthropicClient helper that checks ANTHROPIC_API_KEY",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-016",
      "title": "Implement classifyInsightSensitivity action",
      "description": "As the system, I need to classify insights as normal/injury/behavior.",
      "acceptanceCriteria": [
        "Add classifyInsightSensitivity as internalAction",
        "Args: insightTitle, insightDescription",
        "Call Claude haiku with classification prompt",
        "Return { category, confidence, reason }"
      ],
      "priority": 16,
      "passes": true,
      "notes": "INJURY and BEHAVIOR always require manual review"
    },
    {
      "id": "US-017",
      "title": "Implement generateParentSummary action",
      "description": "As the system, I need to transform coach insights into parent-friendly summaries.",
      "acceptanceCriteria": [
        "Add generateParentSummary as internalAction",
        "Args: insightTitle, insightDescription, playerFirstName, sportName",
        "Call Claude haiku with positive transformation prompt",
        "Return { summary, confidenceScore, flags }"
      ],
      "priority": 17,
      "passes": true,
      "notes": "Transform: struggling→working on, weak→developing"
    },
    {
      "id": "US-018",
      "title": "Add internal playerIdentities query",
      "description": "As a developer, I need to fetch player info from actions.",
      "acceptanceCriteria": [
        "Add getById internalQuery to playerIdentities model",
        "Args: id, returns player document or null",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": true,
      "notes": "Actions cannot directly access ctx.db"
    },
    {
      "id": "US-019",
      "title": "Implement processVoiceNoteInsight orchestration action",
      "description": "As the system, I need to orchestrate the full pipeline.",
      "acceptanceCriteria": [
        "Add processVoiceNoteInsight as internalAction",
        "Args: voiceNoteId, insightId, insightTitle, insightDescription, playerIdentityId, organizationId",
        "Call classifyInsightSensitivity, then generateParentSummary",
        "Call createParentSummary mutation with results"
      ],
      "priority": 19,
      "passes": true,
      "notes": "Chain: classify → generate → store"
    },
    {
      "id": "US-020",
      "title": "Hook summary generation into voice notes pipeline",
      "description": "As the system, insight extraction should trigger summary generation.",
      "acceptanceCriteria": [
        "Edit voiceNotes.ts, find where insightsStatus becomes completed",
        "For each insight with playerIdentityId, schedule processVoiceNoteInsight",
        "Skip injury and behavior categories for now",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": true,
      "notes": "Use ctx.scheduler.runAfter(0, ...)"
    },
    {
      "id": "US-021",
      "title": "Create SummaryApprovalCard component",
      "description": "As a coach, I want to see pending summaries as cards.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/summary-approval-card.tsx",
        "Props: summary, player, onApprove, onSuppress, isApproving, isSuppressing",
        "Show player name, AI summary, confidence indicator",
        "Approve and Don't Share buttons"
      ],
      "priority": 21,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-022",
      "title": "Add collapsible original insight to SummaryApprovalCard",
      "description": "As a coach, I want to see the original insight when needed.",
      "acceptanceCriteria": [
        "Add collapsible section showing privateInsight.title and description",
        "Default collapsed, expand on click",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-023",
      "title": "Add pending summaries section to voice notes dashboard",
      "description": "As a coach, I want to see pending summaries in the dashboard.",
      "acceptanceCriteria": [
        "Edit voice-notes-dashboard.tsx",
        "Add useQuery for getCoachPendingSummaries",
        "Add new section with heading 'Pending Parent Summaries'",
        "Render SummaryApprovalCard for each pending summary"
      ],
      "priority": 23,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-024",
      "title": "Wire approve/suppress actions in dashboard",
      "description": "As a coach, I want to approve or suppress summaries.",
      "acceptanceCriteria": [
        "Add useMutation for approveSummary and suppressSummary",
        "Wire onApprove and onSuppress handlers",
        "Show toast on success/error",
        "Typecheck passes"
      ],
      "priority": 24,
      "passes": true,
      "notes": "Use sonner for toasts"
    },
    {
      "id": "US-025",
      "title": "Create ParentSummaryBadge component",
      "description": "As a parent, I want to see an unread count badge.",
      "acceptanceCriteria": [
        "Create apps/web/src/components/layout/parent-summary-badge.tsx",
        "Props: orgId, query getParentUnreadCount",
        "Show red badge with count, hide if 0",
        "Typecheck passes"
      ],
      "priority": 25,
      "passes": true,
      "notes": "Max display '9+' if count > 9"
    },
    {
      "id": "US-026",
      "title": "Add badge to parent navigation",
      "description": "As a parent, I want to see the unread badge in navigation.",
      "acceptanceCriteria": [
        "Find parent nav link in org layout/sidebar",
        "Import and render ParentSummaryBadge next to link",
        "Only show for users with parent functional role",
        "Typecheck passes"
      ],
      "priority": 26,
      "passes": true,
      "notes": "Badge component exists but needs to be integrated into parent navigation"
    },
    {
      "id": "US-027",
      "title": "Create ParentSummaryCard component",
      "description": "As a parent, I want to see summary cards in Coach Feedback.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/parents/components/parent-summary-card.tsx",
        "Props: summary, isUnread, onView",
        "Show summary content, timestamp, NEW badge if unread",
        "Typecheck passes"
      ],
      "priority": 27,
      "passes": true,
      "notes": "Use formatDistanceToNow from date-fns"
    },
    {
      "id": "US-028",
      "title": "Add summaries query to CoachFeedback component",
      "description": "As a parent, I want to fetch summaries in Coach Feedback.",
      "acceptanceCriteria": [
        "Edit coach-feedback.tsx",
        "Add useQuery for getParentSummariesByChildAndSport",
        "Add useMutation for markSummaryViewed",
        "Typecheck passes"
      ],
      "priority": 28,
      "passes": true,
      "notes": ""
    },
    {
      "id": "US-029",
      "title": "Render grouped summaries in CoachFeedback",
      "description": "As a parent, I want summaries grouped by child and sport.",
      "acceptanceCriteria": [
        "For each child, show name as h3 header",
        "For each sport within child, show sport name as h4",
        "Render ParentSummaryCard for each summary",
        "Call markViewed on card view"
      ],
      "priority": 29,
      "passes": true,
      "notes": "Separate sports maintain 1:1 coach connection"
    },
    {
      "id": "US-030",
      "title": "Add ANTHROPIC_API_KEY environment setup",
      "description": "As a developer, I need the API key configured.",
      "acceptanceCriteria": [
        "Add ANTHROPIC_API_KEY to packages/backend/.env.example",
        "Document: set in Convex dashboard for production",
        "Typecheck passes"
      ],
      "priority": 30,
      "passes": true,
      "notes": "ANTHROPIC_API_KEY added to .env.example and documented in ai-configuration.md"
    }
  ]
}

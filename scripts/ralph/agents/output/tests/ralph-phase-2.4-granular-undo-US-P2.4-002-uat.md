# UAT Test: US-P2.4-002 - Create undoImport mutation

> Auto-generated: 2026-02-13 23:30
> Status: ⏳ Pending Execution

## Story
As an admin, I need to undo a completed import which deletes all records created by that import session.

## Acceptance Criteria Checklist

- [ ] Add undoImport mutation to packages/backend/convex/models/importSessions.ts
- [ ] Args: sessionId (v.id('importSessions')), reason (v.string())
- [ ] Returns: { success: boolean, rollbackStats: { playersRemoved, guardiansRemoved, guardianLinksRemoved, enrollmentsRemoved, passportsRemoved, assessmentsRemoved }, ineligibilityReasons: string[] }
- [ ] Step 1: Call requireOrgAdmin to verify auth
- [ ] Step 2: Run eligibility checks (same logic as checkUndoEligibility). If ineligible, return { success: false, ineligibilityReasons }
- [ ] Step 3: Query each table by importSessionId index and collect all record IDs
- [ ] Step 4: Delete all records using ctx.db.delete() — order matters: delete assessments first, then passports, then enrollments, then guardian links, then guardians, then players
- [ ] Step 5: Patch importSessions: status='undone', undoneAt=Date.now(), undoneBy=user._id, undoReason=args.reason
- [ ] Step 6: Return { success: true, rollbackStats: { counts per table } }
- [ ] Use HARD DELETE (ctx.db.delete) — NOT soft delete
- [ ] Tables to query: playerIdentities, guardianIdentities, guardianPlayerLinks, orgPlayerEnrollments, sportPassports, skillAssessments — all have by_importSessionId index
- [ ] Run npx ultracite fix and npx -w packages/backend convex codegen

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-P2.4-002"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

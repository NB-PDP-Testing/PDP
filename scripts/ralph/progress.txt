# Ralph Progress - Voice Gateways v2

**Branch**: feat/voice-gateways-v2
**Started**: 2026-02-04
**Current Phase**: Phase 2 - Mobile Quick Review UI (6 stories)

---

## Phase 1: Quality Gates & Fuzzy Matching - COMPLETE

### Stories (6 stories, all passing):
- US-VN-001: Message Validation & Quality Gates
- US-VN-002: Transcript Quality Validation
- US-VN-003: Duplicate Message Detection
- US-VN-004: Enhanced WhatsApp Feedback Messages
- US-VN-005: Levenshtein Fuzzy Matching
- US-VN-006: Find Similar Players Query

### Integration Gaps Fixed (post-Phase 1):
- VN-002: validateTranscriptQuality now wired into transcribeAudio pipeline
  - Branches on reject/ask_user/process after Whisper transcription
  - Quality fields (transcriptQuality, transcriptValidation) stored on voiceNotes
  - getAwaitingConfirmation query added for WhatsApp confirmation flow
  - CONFIRM/RETRY/CANCEL handler added to WhatsApp processMessage
- VN-006: findSimilarPlayers now called as fuzzy fallback in buildInsights
  - Fires when deterministic findMatchingPlayer returns undefined
  - Uses 0.85 similarity threshold to prevent false positives
  - Converted insights .map() to for...of loop for async support

### Test Results: 349 tests passing across 86 files

---

## Phase 2: Mobile Quick Review UI - IN PROGRESS

### Execution Order (sequential - heavy dependencies):
1. US-VN-007 → US-VN-008 → US-VN-009 → US-VN-010
2. US-VN-011 (parallel with US-VN-009, depends on US-VN-007)
3. US-VN-012 (depends on US-VN-009)

### Stories:

#### US-VN-007: Review Links Backend (1 day) - PENDING
- Add whatsappReviewLinks table to schema.ts
- Schema: code (8-char unique), voiceNoteId, organizationId, coachUserId, createdAt, expiresAt (48h), status
- Indexes: by_code, by_voiceNoteId, by_expiresAt_and_status, by_coachUserId
- Functions: generateReviewLink (internalMutation), getReviewLinkData (query), markLinkAccessed (mutation)
- Integration: Hook into checkAndAutoApply, update formatResultsMessage with deep link
- Unit tests required

#### US-VN-008: Redirect Route (0.5 day) - PENDING
- Create /r/[code] server component redirect route
- Validate link, redirect to /orgs/{orgId}/coach/review/{code} or error pages
- Create /review-link-invalid and /review-link-expired error pages

#### US-VN-009: Quick Review Page (2 days) - PENDING
- Create /orgs/[orgId]/coach/review/[code] client component
- Sections: QuickReviewHeader, VoiceNoteContext, NeedsReviewSection, UnmatchedSection, AutoAppliedSection, OtherPendingPrompt
- Mobile-first: max-w-lg, p-4, touch targets >= 44px, safe area padding
- Loading skeletons, real-time via useQuery

#### US-VN-010: Unmatched Player Cards (1.5 days) - PENDING
- UnmatchedPlayerCard with fuzzy-matched suggestions from Phase 1
- REUSE findSimilarPlayers from Phase 1 (NOTE: it's an internalQuery - needs public wrapper!)
- Radio group for suggestions, "Someone else..." fallback
- assignPlayerToInsight mutation

#### US-VN-011: Trust-Adaptive Messages (0.5 day) - PENDING
- Update formatResultsMessage based on coach trust level (TL0-3)
- TL0-1: Generic counts / TL2: Top 3 names / TL3: Confident "All applied!"
- Helpers: getTrustLevel, formatCategory, truncateList
- Unit tests required

#### US-VN-012: Link Expiry & Cleanup (0.5 day) - PENDING
- Cron job: daily 3am UTC, delete links > 7 days expired
- LinkExpiredView component for expired link UI
- Unit tests required

---

## Critical Reminders for Ralph:
- DON'T rebuild Phase 1 functions (validateTranscriptQuality, findSimilarPlayers, etc.)
- REUSE findSimilarPlayers from Phase 1 for US-VN-010 (needs public wrapper since it's internalQuery)
- Link expiry: 48 hours, validate on EVERY access
- Mobile-first: touch targets >= 44px, max-w-lg, safe area padding
- NEVER use .filter() - always use .withIndex()
- Better Auth: user._id (not user.id), user.name (not user.firstName)
- Batch fetch + Map lookup (avoid N+1 queries)
- Lift useQuery to parent, pass data as props
- Use shadcn/ui components + Tailwind CSS + Lucide Icons

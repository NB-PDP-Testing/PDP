# Ralph Progress Log
Started: Wed  4 Feb 2026 08:13:17 GMT
---

## Codebase Patterns
**Last Updated**: Wed 4 Feb 2026 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field

### Convex Backend Patterns
- NEVER use `.filter()` - always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names should be descriptive: `by_phone`, `by_altEmail`, `by_postcode`

### Better Auth Schema Location
- User table schema is in: `packages/backend/convex/betterAuth/schema.ts`
- NOT in the main schema.ts - that imports and extends from betterAuth/schema.ts
- Indexes are added to the user table definition in schema.ts

### Quality Checks
- Run in order: `npm run check-types` -> `npx ultracite fix` -> `npm run check`
- Convex codegen: `npx -w packages/backend convex codegen`
- Pre-existing type errors exist in migration files and some frontend code - don't let them block progress
- Lint-staged runs automatically on commit

---

## Wed 4 Feb 2026 - US-P0-001 - Add profile fields to user table schema
**Iteration**: 1
**Commit**: ed0823ba71e62c0ea06df3ab499de7f18def786a
**Status**: Complete

### What was implemented
- Added profile completion fields to user table in betterAuth/schema.ts:
  - `altEmail` - Alternative email for guardian matching
  - `address`, `town`, `postcode`, `country` - Address fields
  - `profileCompletionStatus` - pending/completed/skipped union type
  - `profileCompletedAt` - Timestamp when profile was completed
  - `profileSkipCount` - Number of times user skipped
- Added indexes: `by_phone`, `by_altEmail`, `by_postcode`
- Note: `phone` field already existed in the schema

### Files changed
- packages/backend/convex/betterAuth/schema.ts (+17)
- packages/backend/convex/_generated/api.d.ts (auto-generated)
- packages/backend/convex/betterAuth/_generated/component.ts (auto-generated)

### Quality checks
- ✅ Convex codegen: passed
- ✅ Lint-staged on commit: passed
- ⚠️ npm run check-types: Pre-existing errors in migration files and frontend code (not related to changes)

### Learnings for future iterations
**Patterns discovered:**
- User schema extensions go in `packages/backend/convex/betterAuth/schema.ts`, not main schema.ts
- The `phone` field already exists on the user table - didn't need to add it
- Convex codegen validates the schema - if it passes, schema is valid

**Gotchas encountered:**
- Pre-existing type errors in migration files and frontend modules (remotion, framer-motion) - these are not related to current work

**Dependencies found:**
- Generated files (api.d.ts, component.ts) must be committed along with schema changes

---

## Wed 4 Feb 2026 - Phase 0: Onboarding Sync - Complete Implementation
**Iteration**: 2-10
**Status**: Complete - All 10 user stories passing

### Summary of Phase 0 Implementation

Phase 0 enhances the onboarding orchestrator to collect phone, postcode, and alternate email during self-registration, enabling multi-signal matching with imported guardian records.

### User Stories Completed

1. **US-P0-001**: Schema updates for profile fields (ed0823ba)
2. **US-P0-002**: Guardian matching module (43978c9c)
3. **US-P0-003**: User profile mutations (32a4db95)
4. **US-P0-004**: Profile completion onboarding task (461a4e54)
5. **US-P0-005**: Enhanced checkForClaimableIdentity (ce2c945a)
6. **US-P0-006**: ProfileCompletionStep frontend component (28fc185e)
7. **US-P0-007**: NoChildrenFoundStep fallback component (97a6376e)
8. **US-P0-008**: Onboarding wizard integration (6ed959d8)
9. **US-P0-009**: Sign-up flow verification (c2d54200)
10. **US-P0-010**: E2E testing and verification

### Key Files Created/Modified

**Backend:**
- `packages/backend/convex/lib/matching/guardianMatcher.ts` (NEW)
- `packages/backend/convex/models/userProfiles.ts` (NEW)
- `packages/backend/convex/models/onboarding.ts` (MODIFIED)
- `packages/backend/convex/models/guardianIdentities.ts` (MODIFIED)
- `packages/backend/convex/betterAuth/schema.ts` (MODIFIED)
- `packages/backend/convex/betterAuth/userFunctions.ts` (MODIFIED)

**Frontend:**
- `apps/web/src/components/onboarding/profile-completion-step.tsx` (NEW)
- `apps/web/src/components/onboarding/no-children-found-step.tsx` (NEW)
- `apps/web/src/components/onboarding/onboarding-orchestrator.tsx` (MODIFIED)

### Matching System
- **EMAIL_EXACT**: 50 points - Exact email match
- **SURNAME_POSTCODE**: 45 points - Same surname + postcode
- **SURNAME_TOWN**: 35 points - Same surname + town
- **PHONE**: 30 points - Phone number match
- **POSTCODE_ONLY**: 20 points - Postcode match
- **TOWN_ONLY**: 10 points - Town match
- **HOUSE_NUMBER**: 5 points - House number tiebreaker

### Confidence Levels
- **HIGH (60+)**: Auto-link
- **MEDIUM (40-59)**: Suggest with confirmation
- **LOW (20-39)**: Show as option

### Key Patterns Discovered
- Better Auth user updates require `ctx.runMutation(components.betterAuth.userFunctions....)` pattern
- Onboarding tasks are query-based - no sign-up form changes needed
- Profile completion task appears at priority 1.5 (between invitations and guardian claiming)
- Users can skip profile completion up to 3 times

### Quality Checks
- ✅ Convex codegen passes
- ✅ Lint-staged passes on all commits
- ⚠️ Pre-existing type errors (remotion, framer-motion, migrations) - unrelated to changes

---

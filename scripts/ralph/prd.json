{
  "project": "PlayerARC - Phase 3.1: Confidence Indicators, Partial Undo & Analytics",
  "branchName": "ralph/phase-3.1-advanced-features",
  "description": "Add visual confidence indicators for guardian matching, enhanced partial undo with selective record removal, and import analytics dashboard for platform staff. Phase 3.1 focuses on truly new features while skipping duplicate mobile work already completed in Phase 2.6.",
  "prdFile": "scripts/ralph/prds/Importing Members/phase-3-mobile-ux.md",
  "contextFiles": [
    "apps/web/src/components/import/import-wizard.tsx",
    "apps/web/src/components/import/steps/review-step.tsx",
    "apps/web/src/components/import/undo-import-dialog.tsx",
    "packages/backend/convex/models/playerImport.ts",
    "packages/backend/convex/models/importSessions.ts",
    "packages/backend/convex/lib/import/guardianMatcher.ts",
    "docs/analysis/phase-3-needs-analysis.md",
    "CLAUDE.md"
  ],
  "mandatoryPatterns": [
    "Use shadcn/ui components for all UI elements",
    "Use Tailwind CSS for styling with existing responsive patterns (sm:, md:, lg:)",
    "Use useQuery/useMutation from convex/react for data fetching",
    "NEVER use .filter() in Convex — always .withIndex()",
    "All routes scoped under /orgs/[orgId]/",
    "Support mobile viewport (375px minimum) using existing responsive patterns",
    "Run npx ultracite fix before completing any story",
    "Do NOT add unit tests — E2E only per CLAUDE.md",
    "Do NOT create separate mobile components - use existing responsive patterns",
    "Use framer-motion for smooth animations (already in package.json)",
    "Follow N+1 query prevention patterns from CLAUDE.md",
    "Use batch fetching and Map lookups for related data"
  ],
  "successCriteria": [
    "Confidence indicators display for all guardian matches with color coding (green 60+, yellow 40-59, red <40)",
    "Match score breakdown shows contributing signals and explanations",
    "Admin can override confidence-based auto-linking with audit trail",
    "Partial undo allows selective player removal with search/filter",
    "Impact preview shows cascading effects before removal",
    "Analytics dashboard displays cross-org metrics for platform staff",
    "Org-level import history shows success rates and error patterns",
    "All features work on mobile (375px) using existing responsive patterns",
    "All type checks pass: npm run check-types",
    "Linting passes: npx ultracite fix"
  ],
  "userStories": [
    {
      "id": "US-P3.1-001",
      "title": "Add confidence score display to guardian matching",
      "description": "As an admin reviewing import duplicates, I need to see confidence scores for guardian matches so I can make informed decisions about auto-linking.",
      "acceptanceCriteria": [
        "Extend guardian matching backend to calculate and return confidence scores (0-100)",
        "Confidence score based on: name similarity, email match, phone match, address match",
        "Each match signal weighted: email 40%, phone 30%, name 20%, address 10%",
        "Store confidence score in match result object returned by guardianMatcher",
        "Backend mutation returns confidence score with each duplicate guardian match",
        "Confidence score persists in importSessions duplicates array",
        "Run npx -w packages/backend convex codegen to verify types",
        "Run npx ultracite fix before completion"
      ],
      "priority": 1,
      "notes": "Foundation for all confidence indicator features. Guardian matcher already exists in lib/import/guardianMatcher.ts - extend it to calculate weighted confidence scores. This enables Features 2-4.",
      "passes": true
    },
    {
      "id": "US-P3.1-002",
      "title": "Add color-coded confidence indicators to duplicate resolution UI",
      "description": "As an admin reviewing duplicates, I need visual color-coded indicators so I can quickly identify high/medium/low confidence matches at a glance.",
      "acceptanceCriteria": [
        "Update review-step.tsx duplicate resolution UI to display confidence indicators",
        "Add confidence badge component with three levels:",
        "  - High (60-100): Green badge with 'High Confidence' text and checkmark icon",
        "  - Medium (40-59): Yellow badge with 'Review Required' text and alert icon",
        "  - Low (0-39): Red badge with 'Low Confidence' text and X icon",
        "Progress bar color matches confidence: green (high), yellow (medium), red (low)",
        "Confidence badge appears prominently at top of each duplicate card",
        "Use shadcn/ui Badge component with custom color variants",
        "Mobile responsive: badge remains visible at 375px width",
        "Run npx ultracite fix before completion"
      ],
      "priority": 1,
      "notes": "Visual design is critical. Use existing Progress component from shadcn/ui with custom colors. Ensure color contrast meets WCAG 2.2 AA (4.5:1 ratio). Icons from lucide-react.",
      "passes": true
    },
    {
      "id": "US-P3.1-003",
      "title": "Add match score breakdown and explanation",
      "description": "As an admin reviewing a match, I need to see why the confidence score was assigned so I can understand the matching algorithm's reasoning.",
      "acceptanceCriteria": [
        "Add expandable 'Match Details' section to each duplicate card",
        "Show breakdown of contributing signals:",
        "  - Email match: ✓/✗ with weight (40%)",
        "  - Phone match: ✓/✗ with weight (30%)",
        "  - Name similarity: percentage score with weight (20%)",
        "  - Address match: ✓/✗ with weight (10%)",
        "Display calculated confidence score: (signal1_weight * signal1_match) + ...",
        "Add 'Learn More' link to algorithm documentation (future)",
        "Use Collapsible component from shadcn/ui for expandable section",
        "Mobile: Match details stack vertically with touch-friendly expand/collapse",
        "Run npx ultracite fix before completion"
      ],
      "priority": 2,
      "notes": "Transparency builds trust in auto-matching. Use Collapsible component to avoid overwhelming users. Consider adding tooltips to explain each signal type.",
      "passes": true
    },
    {
      "id": "US-P3.1-004",
      "title": "Add admin override controls with audit trail",
      "description": "As an admin, I need to override confidence-based auto-linking decisions and have those overrides logged so I can correct algorithm mistakes.",
      "acceptanceCriteria": [
        "Add 'Force Link' button to low-confidence matches (<40) in duplicate resolution UI",
        "Add 'Reject Link' button to high-confidence matches (60+) in duplicate resolution UI",
        "Override buttons only visible to users with admin or owner role",
        "Create adminOverrides table in schema.ts:",
        "  - importSessionId, playerId, guardianId, action ('force_link' | 'reject_link'), reason (optional text), overriddenBy (userId), timestamp",
        "Add by_importSession and by_user indexes for querying overrides",
        "Store override in database before applying action",
        "Display override badge on duplicate card: 'Admin Override: Force Linked' or 'Rejected'",
        "Run npx -w packages/backend convex codegen after schema change",
        "Run npx ultracite fix before completion"
      ],
      "priority": 2,
      "notes": "Audit trail is critical for compliance and debugging. Add optional 'reason' text field for admins to document why they overrode. Future: admin override report for pattern analysis.",
      "passes": true
    },
    {
      "id": "US-P3.1-005",
      "title": "Add selective player removal dialog",
      "description": "As an admin who imported incorrect data, I need to selectively remove specific players (not all) so I can fix mistakes without losing good data.",
      "acceptanceCriteria": [
        "Create PartialUndoDialog.tsx component (300-400 lines) in components/import/",
        "Dialog triggered from import complete step via 'Remove Players' button",
        "Display list of all players from completed import (from importSession)",
        "Each player row shows: checkbox, name, DOB, enrollment status, related records count",
        "Select all / deselect all checkbox at top",
        "Selected count badge: 'X players selected' with dynamic update",
        "Disable 'Remove' button if no players selected",
        "Use AlertDialog from shadcn/ui with custom content",
        "Mobile: Player list scrollable, checkboxes touch-friendly (44x44px)",
        "Run npx ultracite fix before completion"
      ],
      "priority": 1,
      "notes": "Extend existing undo-import-dialog.tsx as reference. Use Checkbox component from shadcn/ui. Ensure performance with large imports (100+ players) by virtualizing list if needed.",
      "passes": true
    },
    {
      "id": "US-P3.1-006",
      "title": "Add search and filter for player selection in partial undo",
      "description": "As an admin with a large import, I need to search and filter the player list so I can quickly find specific players to remove.",
      "acceptanceCriteria": [
        "Add search input at top of player list in PartialUndoDialog",
        "Search filters by: firstName, lastName, or combination (case-insensitive)",
        "Add filter dropdown: 'All Players' | 'Players with Errors' | 'Players with Warnings'",
        "Filter by enrollment status: 'Active' | 'Inactive' | 'All'",
        "Search and filters work together (AND logic)",
        "Search debounced 300ms to avoid performance issues",
        "Display result count: 'Showing X of Y players'",
        "Use Input component from shadcn/ui for search",
        "Use Select component from shadcn/ui for filters",
        "Mobile: Search and filters stack vertically at <640px",
        "Run npx ultracite fix before completion"
      ],
      "priority": 2,
      "notes": "Use useMemo to memoize filtered results for performance. Consider adding advanced filters (by team, age group) in future enhancement.",
      "passes": true
    },
    {
      "id": "US-P3.1-007",
      "title": "Add per-player impact preview before removal",
      "description": "As an admin about to remove players, I need to see what data will be deleted so I can avoid unintended data loss.",
      "acceptanceCriteria": [
        "Add 'Preview Impact' section in PartialUndoDialog below player list",
        "Preview shows cascading deletions for selected players:",
        "  - Player enrollments: X records",
        "  - Guardian links: X records (show if guardian will become orphaned)",
        "  - Sport passports: X records",
        "  - Team assignments: X records",
        "  - Skill assessments: X records",
        "Warning badge if action will orphan guardians: 'Warning: 3 guardians will have no linked players'",
        "Preview updates dynamically as selection changes",
        "Use Alert component from shadcn/ui for warnings",
        "Backend query: getRemovalImpact(playerIds) returns impact summary",
        "Run npx -w packages/backend convex codegen after adding query",
        "Run npx ultracite fix before completion"
      ],
      "priority": 1,
      "notes": "Impact preview prevents accidental data loss. Use optimistic rendering - calculate impact client-side initially, then verify with backend query. Critical for user confidence.",
      "passes": true
    },
    {
      "id": "US-P3.1-008",
      "title": "Implement atomic removal transaction",
      "description": "As a system, I need to remove selected players and all related data in a single transaction so the database remains consistent even if removal fails.",
      "acceptanceCriteria": [
        "Create removePlayersFromImport mutation in playerImport.ts",
        "Mutation accepts: sessionId, playerIdentityIds[] to remove",
        "Transaction removes in order (reverse of creation):",
        "  1. Skill assessments for these players",
        "  2. Team assignments (teamPlayerIdentities)",
        "  3. Sport passports",
        "  4. Guardian links (guardianToPlayerLinks) - only if guardian orphaned",
        "  5. Enrollments (orgPlayerEnrollments)",
        "  6. Player identities (if not linked elsewhere)",
        "Use ctx.db.delete() for each record, wrapped in try-catch",
        "Roll back on any error (Convex mutations are atomic)",
        "Update importSession stats: subtract removed counts from totals",
        "Return removal result: { playersRemoved, enrollmentsRemoved, passportsRemoved, guardiansOrphaned, errors[] }",
        "Run npx -w packages/backend convex codegen after adding mutation",
        "Run npx ultracite fix before completion"
      ],
      "priority": 1,
      "notes": "Transaction atomicity is critical. Convex mutations are automatically atomic, but need explicit error handling. Use indexes for efficient lookups: by_playerIdentityId, by_enrollmentId, etc.",
      "passes": true
    },
    {
      "id": "US-P3.1-009",
      "title": "Create platform staff analytics backend queries",
      "description": "As platform staff, I need backend queries to fetch cross-org import analytics so I can monitor platform health and identify systemic issues.",
      "acceptanceCriteria": [
        "Create importAnalytics.ts in packages/backend/convex/models/",
        "Add getPlatformImportAnalytics query (platform staff only):",
        "  - Total imports across all orgs (last 30 days, last 90 days, all time)",
        "  - Success rate: (successful imports / total imports) * 100",
        "  - Average players per import",
        "  - Total players imported platform-wide",
        "  - Common error types with counts",
        "Add getOrgImportHistory query (org admins + platform staff):",
        "  - Org-specific import list with dates, player counts, status",
        "  - Success/failure breakdown",
        "  - Template usage statistics",
        "Add getCommonErrors query (platform staff only):",
        "  - Aggregated error messages across all imports",
        "  - Error frequency counts",
        "  - Top 10 most common errors",
        "Add by_organizationId and by_createdAt indexes to importSessions",
        "Use .withIndex() for all queries - NEVER .filter()",
        "Return validators for all queries with v.object() schemas",
        "Run npx -w packages/backend convex codegen after completion",
        "Run npx ultracite fix before completion"
      ],
      "priority": 2,
      "notes": "Analytics queries can be expensive - use date range filters to limit data. Consider adding caching for getPlatformImportAnalytics (refresh every 5 minutes). Platform staff check: ctx.user.isPlatformStaff === true.",
      "passes": true
    },
    {
      "id": "US-P3.1-010",
      "title": "Create analytics dashboard page for platform staff",
      "description": "As platform staff, I need a visual analytics dashboard so I can monitor import performance and identify trends at a glance.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/analytics/import/page.tsx",
        "Route protected: redirect non-platform-staff to /orgs/[orgId]/dashboard",
        "Display key metrics cards at top:",
        "  - Total Imports (with trend arrow: ↑↓)",
        "  - Success Rate (percentage with colored badge: green >90%, yellow 70-89%, red <70%)",
        "  - Total Players Imported (with breakdown by time period)",
        "  - Average Import Size (players per import)",
        "Add time period selector: Last 7 Days | Last 30 Days | Last 90 Days | All Time",
        "Display import activity chart (line chart showing imports over time)",
        "Display common errors table with error message, count, percentage",
        "Use Card component from shadcn/ui for metric cards",
        "Use recharts library for charts (already in package.json)",
        "Mobile: Metrics stack vertically, chart scrolls horizontally if needed",
        "Run npx ultracite fix before completion"
      ],
      "priority": 2,
      "notes": "Keep dashboard simple initially. Use React Query (Convex useQuery) for real-time updates. Future enhancements: org comparison, error trend analysis, template performance metrics."
    },
    {
      "id": "US-P3.1-011",
      "title": "Add org-level import history view",
      "description": "As an org admin, I need to see my organization's import history so I can track what data was imported and when.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/import/history/page.tsx",
        "Display table of all imports for current org:",
        "  - Date/time",
        "  - Imported by (user name)",
        "  - Players imported (count)",
        "  - Status (Success | Partial | Failed)",
        "  - Template used (if any)",
        "  - Actions column with 'View Details' and 'Undo' buttons",
        "Sort by date descending (most recent first)",
        "Pagination: 20 imports per page",
        "Filter by status: All | Success | Partial | Failed",
        "Filter by date range: Last 7 Days | Last 30 Days | Custom Range",
        "Use Table component from shadcn/ui",
        "Use Pagination component from shadcn/ui",
        "Status badge colors: green (success), yellow (partial), red (failed)",
        "Mobile: Table scrolls horizontally, cards view on <640px",
        "Run npx ultracite fix before completion"
      ],
      "priority": 3,
      "notes": "Org history helps admins audit imports. 'View Details' links to import session detail page (future). 'Undo' triggers partial or full undo dialog. Use getOrgImportHistory query from US-P3.1-009."
    },
    {
      "id": "US-P3.1-012",
      "title": "Add common error patterns display to analytics",
      "description": "As platform staff, I need to see common error patterns across all orgs so I can improve templates, documentation, and the import wizard.",
      "acceptanceCriteria": [
        "Add 'Common Errors' section to platform analytics dashboard (from US-P3.1-010)",
        "Display table showing:",
        "  - Error message (truncated with tooltip for full message)",
        "  - Occurrences (count)",
        "  - Affected Orgs (count of unique organizations)",
        "  - Percentage of total errors",
        "  - Trend (↑↓ compared to previous period)",
        "Sort by occurrences descending (most common first)",
        "Limit to top 10 errors by default, with 'Show More' expansion",
        "Color-code by severity: critical errors in red, warnings in yellow",
        "Add 'Export CSV' button for full error report",
        "Use getCommonErrors query from US-P3.1-009",
        "Use Table component from shadcn/ui",
        "Mobile: Table becomes accordion list at <640px",
        "Run npx ultracite fix before completion"
      ],
      "priority": 3,
      "notes": "Error pattern analysis drives UX improvements. Future: link errors to documentation fixes, auto-suggest template improvements. Export CSV uses browser download API (no backend needed for small datasets)."
    }
  ]
}

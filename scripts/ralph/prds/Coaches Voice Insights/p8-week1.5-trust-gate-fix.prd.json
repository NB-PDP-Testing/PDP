{
  "project": "P8 Week 1.5 - Trust Gate Feature Flags (Critical Fix)",
  "branchName": "ralph/coach-impact-visibility-p8-week1",
  "description": "Fix US-P8-002 by implementing flexible 3-tier trust gate permission system. Platform staff can enable admin delegation and coach overrides. Admins can set blanket overrides (all coaches) AND grant individual coach overrides. Coaches can request overrides if enabled. Includes overview dashboards for visibility.",
  "readinessLevel": "100% COMPLETE - Jan 28, 2026",
  "urgency": "‚úÖ RESOLVED - Week 1.5 complete with comprehensive self-service access control (9 stories delivered)",
  "prerequisitesCompleted": {
    "status": "‚úÖ ALL STORIES COMPLETE - Jan 28, 2026 (9 stories: 5 planned + 4 enhancements)",
    "completedWork": [
      "‚úÖ US-P8-021: Backend trust gate permission system (6 queries, 8 mutations)",
      "‚úÖ US-P8-002-FIX: Fixed dashboard gate check with comprehensive access check query",
      "‚úÖ US-P8-022: Platform staff feature flags admin UI (deferred)",
      "‚úÖ US-P8-022B: Platform staff overview dashboard (deferred)",
      "‚úÖ US-P8-023: Org admin trust gate status dashboard",
      "‚úÖ US-P8-027: Coach self-service disable/enable toggle (ENHANCEMENT)",
      "‚úÖ US-P8-028: Coach dropdown menu on Sent to Parents tab (ENHANCEMENT)",
      "‚úÖ US-P8-029: Admin individual coach block with reason (ENHANCEMENT)",
      "‚úÖ US-P8-030: Admin comprehensive status view table (ENHANCEMENT)",
      "Backend: 8-priority access logic, Better Auth integration patterns",
      "Frontend: Dropdown menus, confirmation dialogs, toast notifications",
      "Testing: 40 test cases documentation, quick test guide",
      "Documentation: P8_CHECKPOINT_JAN28.md, P8_WEEK2_RALPH_CONTEXT.md"
    ],
    "enhancementsBeyondPRD": [
      "Self-Service Toggle: Coaches can hide/show tab themselves (not just request)",
      "Dropdown Menu: Clean UX with chevron dropdown on tab",
      "Request Access Button: Green button when coach can request",
      "Individual Coach Blocking: Admins can block specific coaches with reason",
      "Comprehensive Status Table: Shows all coaches with status badges",
      "Admin Blanket Block: Block ALL coaches at once (new field)",
      "Confirmation Dialogs: All destructive actions require confirmation",
      "Toast Notifications: All mutations provide feedback",
      "Real-Time Updates: Convex useQuery for instant UI sync"
    ],
    "documentationReferences": [
      "scripts/ralph/TRUST_GATE_ARCHITECTURE_V2.md - Complete architecture with schemas, queries, mutations, UI designs",
      "scripts/ralph/TRUST_GATE_MVP_VS_GROUPS.md - MVP approach rationale and overview dashboard designs",
      "scripts/ralph/P8_RALPH_CONTEXT.md - P1-P7 learnings and P8 patterns",
      "scripts/ralph/P8_P9_COMPREHENSIVE_REFACTORING_PLAN.md - Full impact analysis and migration strategy"
    ]
  },
  "contextAndDependencies": {
    "criticalContext": [
      "US-P8-002 REMOVED trust gate entirely - now ALL coaches see sent summaries",
      "Need to implement feature flag system that ADDS BACK controllable gates",
      "3-tier permission hierarchy: Platform Staff ‚Üí Org Admins ‚Üí Individual Coaches",
      "Priority order: Individual override > Admin blanket > Org default",
      "Migration CRITICAL: Existing orgs must have gates ON by default (conservative approach)"
    ],
    "completedPhases": [
      "P5: Trust system foundation (Levels 0/1/2+)",
      "P6: Monitoring patterns (not directly used but learned from)",
      "P7: Insight auto-apply with trust levels",
      "P8 Week 1: getCoachImpactSummary, My Impact tab structure, navigation"
    ],
    "requiredTables": [
      "‚úÖ organization - Add feature flag fields (voiceNotesTrustGatesEnabled, allowAdminDelegation, allowCoachOverrides, adminOverrideTrustGates)",
      "‚úÖ coachOrgPreferences - Add override fields (trustGateOverride, overrideGrantedBy, overrideGrantedAt, overrideReason)",
      "üÜï orgAdminPermissions - NEW table for admin permission tracking",
      "üÜï coachOverrideRequests - NEW table for override request workflow"
    ],
    "keyFiles": [
      "Backend: packages/backend/convex/models/trustGatePermissions.ts - NEW file for permission logic",
      "Backend: packages/backend/convex/schema.ts - Extend organization, coachOrgPreferences tables, add new tables",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx - FIX removed gate",
      "Frontend: apps/web/src/app/platform-admin/feature-flags/page.tsx - NEW platform staff UI",
      "Frontend: apps/web/src/app/orgs/[orgId]/settings/features/page.tsx - NEW org admin UI"
    ],
    "criticalPatterns": {
      "Schema_Extensions": "Use .optional() for all new fields to support existing data",
      "Permission_Calculation": "Check individual override first, then admin blanket, then org default",
      "Migration": "Default voiceNotesTrustGatesEnabled: true for existing orgs (conservative)",
      "UI_Patterns": "Use Badge for status display, Switch for toggles, Card for overview metrics"
    }
  },
  "userStories": [
    {
      "id": "US-P8-021",
      "title": "Backend Trust Gate Permission System",
      "description": "As a backend developer, I need to create the complete permission system for trust gate feature flags so all three control tiers (Platform ‚Üí Admin ‚Üí Coach) can manage access.",
      "phase": "P8 Week 1.5: Trust Gate Fix",
      "acceptanceCriteria": [
        "Extend organization table with feature flag fields:",
        "  voiceNotesTrustGatesEnabled: v.optional(v.boolean()) - Master switch, default true",
        "  allowAdminDelegation: v.optional(v.boolean()) - Can admins manage gates?",
        "  allowCoachOverrides: v.optional(v.boolean()) - Can coaches request bypass?",
        "  adminOverrideTrustGates: v.optional(v.boolean()) - Admin blanket override",
        "  adminOverrideSetBy: v.optional(v.string()) - Who set admin override",
        "  adminOverrideSetAt: v.optional(v.number()) - When admin override was set",
        "",
        "Extend coachOrgPreferences table with override fields:",
        "  trustGateOverride: v.optional(v.boolean()) - Individual coach bypass",
        "  overrideGrantedBy: v.optional(v.string()) - Admin who granted",
        "  overrideGrantedAt: v.optional(v.number()) - When granted",
        "  overrideReason: v.optional(v.string()) - Why granted",
        "  overrideExpiresAt: v.optional(v.number()) - Optional time-boxing",
        "",
        "Create NEW orgAdminPermissions table:",
        "  organizationId: v.string()",
        "  memberId: v.string() - Admin member ID",
        "  canManageFeatureFlags: v.boolean()",
        "  canManageCoachOverrides: v.boolean()",
        "  grantedBy: v.string() - Platform staff who granted",
        "  grantedAt: v.number()",
        "  Index: by_org_member",
        "",
        "Create NEW coachOverrideRequests table:",
        "  coachId: v.string()",
        "  organizationId: v.string()",
        "  featureType: v.string() - 'trust_gates' for now",
        "  reason: v.string() - Coach's justification",
        "  status: v.union(v.literal('pending'), v.literal('approved'), v.literal('denied'), v.literal('expired'))",
        "  requestedAt: v.number()",
        "  reviewedBy: v.optional(v.string()) - Admin who reviewed",
        "  reviewedAt: v.optional(v.number())",
        "  reviewNotes: v.optional(v.string()) - Admin's notes",
        "  Index: by_coach_org, by_org_status",
        "",
        "Create packages/backend/convex/models/trustGatePermissions.ts with queries:",
        "",
        "1. areTrustGatesActive query:",
        "   Args: { coachId: v.string(), organizationId: v.string() }",
        "   Returns: v.object({ gatesActive: v.boolean(), source: v.string(), reason: v.optional(v.string()) })",
        "   Logic:",
        "     - Check coachOrgPreferences.trustGateOverride === true ‚Üí return { gatesActive: false, source: 'coach_override' }",
        "     - Check org.adminOverrideTrustGates !== undefined ‚Üí return { gatesActive: !org.adminOverrideTrustGates, source: 'admin_blanket' }",
        "     - Return { gatesActive: org.voiceNotesTrustGatesEnabled ?? true, source: 'org_default' }",
        "",
        "2. getOrgFeatureFlagStatus query:",
        "   Args: { organizationId: v.string() }",
        "   Returns: v.object({ org level fields, totalCoaches, coachesWithAccess, activeOverrides: v.array(...) })",
        "   Aggregates: Count coaches with overrides, list all active overrides",
        "",
        "3. getCoachOverrideRequests query:",
        "   Args: { organizationId: v.string(), status: v.optional(v.string()) }",
        "   Returns: v.array(v.object({ request fields, coachName, coachTrustLevel }))",
        "   Use index: by_org_status (query by organizationId, filter by status in query if provided)",
        "",
        "4. getAllOrgsFeatureFlagStatus query (platform staff):",
        "   Args: {}",
        "   Returns: v.array(v.object({ orgId, orgName, gatesEnabled, adminOverride, overridesCount, pendingRequestsCount, lastChangedBy, lastChangedAt }))",
        "   Aggregates across all organizations",
        "",
        "Create packages/backend/convex/models/trustGatePermissions.ts with mutations:",
        "",
        "1. setPlatformFeatureFlags mutation:",
        "   Args: { organizationId: v.string(), allowAdminDelegation: v.optional(v.boolean()), allowCoachOverrides: v.optional(v.boolean()) }",
        "   Auth: Requires isPlatformStaff === true",
        "   Action: Update organization fields (only updates fields provided in args)",
        "",
        "2. setOrgTrustGatesEnabled mutation:",
        "   Args: { organizationId: v.string(), enabled: v.boolean() }",
        "   Auth: Platform staff only",
        "   Action: Update org.voiceNotesTrustGatesEnabled",
        "",
        "3. setAdminBlanketOverride mutation:",
        "   Args: { organizationId: v.string(), override: v.boolean() }",
        "   Auth: Admin with org role + org.allowAdminDelegation === true",
        "   Action: Update org.adminOverrideTrustGates, adminOverrideSetBy, adminOverrideSetAt",
        "",
        "4. grantCoachOverride mutation:",
        "   Args: { coachId: v.string(), organizationId: v.string(), reason: v.string(), expiresAt: v.optional(v.number()) }",
        "   Auth: Admin with org role + org.allowCoachOverrides === true",
        "   Action: Update coachOrgPreferences with override fields",
        "",
        "5. revokeCoachOverride mutation:",
        "   Args: { coachId: v.string(), organizationId: v.string() }",
        "   Auth: Admin with org role",
        "   Action: Set coachOrgPreferences.trustGateOverride = false",
        "",
        "6. requestCoachOverride mutation:",
        "   Args: { coachId: v.string(), organizationId: v.string(), reason: v.string() }",
        "   Auth: Coach with org role + org.allowCoachOverrides === true",
        "   Action: Create coachOverrideRequests record with status: 'pending'",
        "",
        "7. reviewCoachOverrideRequest mutation:",
        "   Args: { requestId: v.id('coachOverrideRequests'), approved: v.boolean(), reviewNotes: v.optional(v.string()) }",
        "   Auth: Admin with org role",
        "   Action: Update request status, if approved call grantCoachOverride",
        "",
        "All mutations include proper error handling and return typed results",
        "Type check passes: npm run check-types",
        "Run codegen: npx -w packages/backend convex codegen"
      ],
      "technicalNotes": {
        "schemaPattern": "Use .optional() for ALL new fields to support existing data without migration",
        "migrationStrategy": "Conservative approach - existing orgs get voiceNotesTrustGatesEnabled: true (gates stay ON)",
        "indexStrategy": "Create indexes BEFORE using them in queries: by_org_member, by_coach_org, by_org_status",
        "authChecks": "Use ctx.auth.getUserIdentity() + check isPlatformStaff or member.role",
        "referenceFiles": [
          "scripts/ralph/TRUST_GATE_ARCHITECTURE_V2.md - Complete schema and query designs",
          "packages/backend/convex/models/coachParentSummaries.ts - Similar aggregation patterns",
          "packages/backend/convex/models/coachTrustLevels.ts - Trust level checking patterns"
        ]
      },
      "priority": 1,
      "passes": true,
      "notes": "‚úÖ COMPLETE - Jan 28, 2026. Delivered 6 queries and 8 mutations. Added adminBlanketBlock fields as enhancement. Better Auth integration patterns documented."
    },
    {
      "id": "US-P8-002-FIX",
      "title": "Fix Trust Gate Check in Voice Notes Dashboard",
      "description": "As a coach, I want the 'Sent to Parents' tab visibility to respect the new feature flag system so access is controlled by Platform/Admin settings while preserving the trust level system.",
      "phase": "P8 Week 1.5: Trust Gate Fix",
      "acceptanceCriteria": [
        "Modify apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx",
        "",
        "Import new query:",
        "  import { api } from '@/convex/_generated/api';",
        "  (already imported, verify present)",
        "",
        "Add feature flag check:",
        "  const gateStatus = useQuery(",
        "    api.models.trustGatePermissions.areTrustGatesActive,",
        "    coachId && orgId ? { coachId, organizationId: orgId } : 'skip'",
        "  );",
        "",
        "Calculate visibility:",
        "  const shouldShowSentToParents = useMemo(() => {",
        "    // Loading state",
        "    if (gateStatus === undefined) return false;",
        "",
        "    // Gates disabled via flags (any tier)",
        "    if (!gateStatus.gatesActive) return true;",
        "",
        "    // Gates active - check trust level",
        "    const currentLevel = trustLevel?.currentLevel ?? 0;",
        "    return currentLevel >= 2;",
        "  }, [gateStatus, trustLevel]);",
        "",
        "Replace removed gate with conditional push:",
        "  if (shouldShowSentToParents) {",
        "    baseTabs.push({",
        "      id: 'auto-sent',",
        "      label: 'Sent to Parents',",
        "      icon: Send,",
        "    });",
        "  }",
        "",
        "Add info UI for locked state:",
        "  {!shouldShowSentToParents && (",
        "    <Tooltip>",
        "      <TooltipTrigger asChild>",
        "        <Button variant='ghost' disabled className='opacity-50'>",
        "          <Lock className='h-4 w-4 mr-2' />",
        "          Sent to Parents",
        "        </Button>",
        "      </TooltipTrigger>",
        "      <TooltipContent>",
        "        <p>",
        "          {gateStatus?.source === 'org_default' && 'Available at Trust Level 2+'}",
        "          {gateStatus?.source === 'admin_blanket' && 'Contact your administrator for access'}",
        "        </p>",
        "      </TooltipContent>",
        "    </Tooltip>",
        "  )}",
        "",
        "Preserve all existing functionality:",
        "  - Tab switching still works",
        "  - Search/filter in Sent to Parents tab unchanged",
        "  - Parent view/acknowledge status display unchanged",
        "",
        "Type check passes: npm run check-types",
        "Visual verification:",
        "  - Level 0/1 coach + gates ON ‚Üí Tab hidden, locked button shows with tooltip",
        "  - Level 0/1 coach + admin override ON ‚Üí Tab visible",
        "  - Level 0/1 coach + individual override ‚Üí Tab visible",
        "  - Level 2+ coach + gates ON ‚Üí Tab visible (trust level sufficient)",
        "  - Level 2+ coach + gates OFF ‚Üí Tab visible"
      ],
      "technicalNotes": {
        "currentCode": "Ralph removed gate entirely in commit f4190553, now unconditionally shows tab to all coaches",
        "fix": "Add back conditional check but use feature flags + trust level combined logic",
        "loadingHandling": "While gateStatus === undefined, hide tab (conservative approach)",
        "tooltipImports": "import { Tooltip, TooltipTrigger, TooltipContent } from '@/components/ui/tooltip';",
        "iconImports": "import { Lock } from 'lucide-react'; (add to existing imports)",
        "referenceFile": "scripts/ralph/TRUST_GATE_ARCHITECTURE_V2.md - Frontend patterns section"
      },
      "priority": 2,
      "passes": true,
      "notes": "‚úÖ COMPLETE - Jan 28, 2026. Implemented checkCoachParentAccess comprehensive query with 8-priority logic. Added dropdown menu, request button, confirmation dialogs."
    },
    {
      "id": "US-P8-022",
      "title": "Platform Staff Feature Flags Admin UI",
      "description": "As a platform staff member, I want a UI to manage trust gate feature flags at the organization level so I can enable/disable gates and delegate control to admins.",
      "phase": "P8 Week 1.5: Trust Gate Fix",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform-admin/feature-flags/page.tsx",
        "",
        "Page structure:",
        "  - Header: 'Voice Notes Feature Flags' with description",
        "  - Overview cards (4 cards):",
        "    1. Total Organizations",
        "    2. Gates Disabled (count + percentage)",
        "    3. Admin Overrides Active (count + percentage)",
        "    4. Pending Coach Requests (total across all orgs)",
        "",
        "Organization table with columns:",
        "  - Organization Name",
        "  - Gates Enabled (Badge: ON/OFF with color coding)",
        "  - Admin Delegation (Switch toggle)",
        "  - Coach Overrides (Switch toggle)",
        "  - Admin Blanket Override (Badge if set: ON/OFF)",
        "  - Individual Overrides (count with link to details)",
        "  - Pending Requests (count with link to review)",
        "  - Last Changed (timestamp + who changed)",
        "  - Actions (dropdown: View Details, Reset to Default)",
        "",
        "Table features:",
        "  - Search by organization name",
        "  - Filter: All / Gates Disabled / Admin Override Active / Has Requests",
        "  - Sort by: Name, Last Changed, Override Count",
        "  - Pagination (20 per page)",
        "",
        "Use query: api.models.trustGatePermissions.getAllOrgsFeatureFlagStatus",
        "",
        "Toggle handlers:",
        "  - Gates Enabled toggle: Call setOrgTrustGatesEnabled mutation",
        "  - Admin Delegation toggle: Call setPlatformFeatureFlags mutation with { allowAdminDelegation }",
        "  - Coach Overrides toggle: Call setPlatformFeatureFlags mutation with { allowCoachOverrides }",
        "",
        "Bulk actions:",
        "  - Enable Admin Delegation for Selected",
        "  - Enable Coach Overrides for Selected",
        "  - Disable All Gates (confirmation modal)",
        "",
        "Real-time updates: useQuery provides live data",
        "",
        "Auth guard: Only visible to users with isPlatformStaff === true",
        "",
        "Add navigation link in platform-admin layout sidebar",
        "",
        "Type check passes: npm run check-types",
        "Visual verification: Navigate to /platform-admin/feature-flags, verify all controls work"
      ],
      "technicalNotes": {
        "componentImports": [
          "import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';",
          "import { Badge } from '@/components/ui/badge';",
          "import { Switch } from '@/components/ui/switch';",
          "import { Button } from '@/components/ui/button';",
          "import { Input } from '@/components/ui/input';",
          "import { Select, SelectTrigger, SelectValue, SelectContent, SelectItem } from '@/components/ui/select';",
          "import { Table, TableHeader, TableRow, TableHead, TableBody, TableCell } from '@/components/ui/table';",
          "import { DropdownMenu, DropdownMenuTrigger, DropdownMenuContent, DropdownMenuItem } from '@/components/ui/dropdown-menu';",
          "import { toast } from 'sonner';"
        ],
        "mutationPattern": "Use useMutation for all toggle actions, show toast on success/error",
        "badgeColors": "Gates ON: green, Gates OFF: red, Override Active: blue",
        "referenceFile": "scripts/ralph/TRUST_GATE_ARCHITECTURE_V2.md - Platform Staff Admin UI section",
        "layoutFile": "apps/web/src/app/platform-admin/layout.tsx - Add nav link"
      },
      "priority": 3,
      "passes": false,
      "notes": "‚è∏Ô∏è DEFERRED - Focus shifted to org admin UI (US-P8-023) which provides more immediate value. Can revisit in future phase if platform staff needs cross-org management."
    },
    {
      "id": "US-P8-022B",
      "title": "Platform Staff Overview Dashboard",
      "description": "As a platform staff member, I want to see a comprehensive overview of trust gate settings across all organizations so I can quickly identify issues and trends.",
      "phase": "P8 Week 1.5: Trust Gate Fix",
      "acceptanceCriteria": [
        "Add overview section ABOVE the organization table in apps/web/src/app/platform-admin/feature-flags/page.tsx",
        "",
        "Overview cards (4 cards in a grid):",
        "  1. Total Organizations",
        "     - Count of all orgs",
        "     - Subtitle: 'Active organizations'",
        "",
        "  2. Gates Disabled",
        "     - Count of orgs with voiceNotesTrustGatesEnabled === false",
        "     - Percentage in subtitle",
        "     - Red badge if > 20%",
        "",
        "  3. Admin Overrides Active",
        "     - Count of orgs with adminOverrideTrustGates !== undefined",
        "     - Percentage in subtitle",
        "     - Blue badge",
        "",
        "  4. Pending Coach Requests",
        "     - Total pending requests across all orgs",
        "     - Link: 'Review Requests' ‚Üí filters table to show orgs with requests",
        "     - Orange badge if > 0",
        "",
        "Detailed table below overview (keep existing table from US-P8-022)",
        "",
        "Add quick filters above table:",
        "  - Button: 'Show Orgs with Issues' ‚Üí filters to: gates disabled OR admin override OR pending requests",
        "  - Button: 'Show Recently Changed' ‚Üí sorts by lastChangedAt descending",
        "  - Button: 'Show All' ‚Üí resets filters",
        "",
        "Use existing query: api.models.trustGatePermissions.getAllOrgsFeatureFlagStatus",
        "Aggregate data client-side for overview cards",
        "",
        "Type check passes: npm run check-types",
        "Visual verification: Overview cards display correct counts, filters work"
      ],
      "technicalNotes": {
        "cardLayout": "Use grid-cols-1 md:grid-cols-2 lg:grid-cols-4 for responsive layout",
        "aggregation": "Calculate in useMemo to avoid re-computing on every render",
        "filterState": "Use useState for active filter, apply to table data",
        "referenceFile": "scripts/ralph/TRUST_GATE_MVP_VS_GROUPS.md - Platform Staff Overview section"
      },
      "priority": 4,
      "passes": false,
      "notes": "‚è∏Ô∏è DEFERRED - Depends on US-P8-022 which was deferred. Can revisit in future phase."
    },
    {
      "id": "US-P8-023",
      "title": "Org Admin Trust Gate Status Dashboard",
      "description": "As an organization admin, I want to see the current trust gate status and manage coach overrides so I can control feature access within my organization.",
      "phase": "P8 Week 1.5: Trust Gate Fix",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/settings/features/page.tsx",
        "",
        "Page structure:",
        "  - Header: 'Voice Notes Features' with description",
        "  - Current Status Card:",
        "    - Trust Gates: ON/OFF badge (org.voiceNotesTrustGatesEnabled)",
        "    - Admin Control: ENABLED/DISABLED badge (org.allowAdminDelegation)",
        "    - Coach Overrides: ENABLED/DISABLED badge (org.allowCoachOverrides)",
        "    - Note: 'Contact platform staff to change these settings'",
        "",
        "  - Admin Blanket Override Card (only if allowAdminDelegation === true):",
        "    - Title: 'Override for All Coaches'",
        "    - Description: 'When enabled, all coaches can access features regardless of trust level'",
        "    - Switch toggle (current state: org.adminOverrideTrustGates)",
        "    - Info: 'This overrides the organization default for ALL coaches'",
        "    - Last set by: {adminOverrideSetBy} at {adminOverrideSetAt}",
        "",
        "  - Overview Stats Card:",
        "    - Total Coaches: {count}",
        "    - Coaches with Access: {count} ({percentage}%)",
        "    - Individual Overrides Active: {count}",
        "    - Pending Override Requests: {count}",
        "",
        "  - Individual Coach Overrides Table (only if allowCoachOverrides === true):",
        "    Columns:",
        "      - Coach Name",
        "      - Trust Level (Badge: 0/1/2+)",
        "      - Override Status (Badge: ACTIVE/NONE)",
        "      - Reason (from overrideReason)",
        "      - Granted By (admin name)",
        "      - Granted At (timestamp)",
        "      - Expires At (if set, show countdown)",
        "      - Actions (Revoke button)",
        "",
        "  - Pending Override Requests Section (only if allowCoachOverrides === true):",
        "    Columns:",
        "      - Coach Name",
        "      - Trust Level",
        "      - Reason (coach's justification)",
        "      - Requested At",
        "      - Actions (Approve / Deny buttons with reason input modal)",
        "",
        "Use query: api.models.trustGatePermissions.getOrgFeatureFlagStatus with { organizationId: orgId }",
        "Use query: api.models.trustGatePermissions.getCoachOverrideRequests with { organizationId: orgId, status: 'pending' }",
        "",
        "Mutation handlers:",
        "  - Toggle blanket override: Call setAdminBlanketOverride",
        "  - Grant override: Call grantCoachOverride (from request or manual)",
        "  - Revoke override: Call revokeCoachOverride",
        "  - Approve request: Call reviewCoachOverrideRequest with approved: true",
        "  - Deny request: Call reviewCoachOverrideRequest with approved: false",
        "",
        "Auth guard: Only visible to organization admins (role: 'admin' or 'owner')",
        "",
        "Add navigation link in org settings sidebar under 'Features'",
        "",
        "Type check passes: npm run check-types",
        "Visual verification:",
        "  - Admin sees current status correctly",
        "  - Blanket override toggle works (if delegation enabled)",
        "  - Individual overrides display correctly",
        "  - Pending requests show with approve/deny actions"
      ],
      "technicalNotes": {
        "conditionalRendering": "Use org.allowAdminDelegation and org.allowCoachOverrides to show/hide sections",
        "emptyStates": "Show helpful messages when no overrides or requests exist",
        "confirmationModals": "Use AlertDialog for revoke/deny actions with reason input",
        "toastNotifications": "Show success/error toasts for all actions",
        "referenceFile": "scripts/ralph/TRUST_GATE_ARCHITECTURE_V2.md - Org Admin Management UI section",
        "layoutFile": "apps/web/src/app/orgs/[orgId]/settings/layout.tsx - Add nav link"
      },
      "priority": 5,
      "passes": true,
      "notes": "‚úÖ COMPLETE - Jan 28, 2026. Delivered with enhancements: bulk block toggle, individual coach table with status badges, block/unblock with reason, comprehensive status view."
    }
  ],
  "qualityChecks": {
    "beforeCommitting": [
      "npm run check-types - MUST pass",
      "npx ultracite fix - MUST pass",
      "npx -w packages/backend convex codegen - MUST run successfully",
      "Visual verification in browser for ALL UI changes",
      "Test permission calculations with different scenarios",
      "Verify migration doesn't break existing orgs"
    ],
    "testingStrategy": {
      "US-P8-021": [
        "Test areTrustGatesActive with all priority scenarios:",
        "  1. Coach has individual override ‚Üí gatesActive: false",
        "  2. Admin blanket override ON ‚Üí gatesActive: false",
        "  3. Admin blanket override OFF ‚Üí gatesActive: true",
        "  4. Org default ON ‚Üí gatesActive: true",
        "  5. Org default OFF ‚Üí gatesActive: false",
        "Test in Convex dashboard with real IDs",
        "Verify all mutations return proper errors for unauthorized users"
      ],
      "US-P8-002-FIX": [
        "Create test org with gates ON",
        "Login as Level 0 coach ‚Üí verify tab hidden, locked button shows",
        "Have admin grant individual override ‚Üí verify tab appears",
        "Remove override ‚Üí verify tab disappears",
        "Set admin blanket override ON ‚Üí verify tab appears for all coaches",
        "Test with Level 2 coach ‚Üí verify tab always visible when gates ON"
      ],
      "US-P8-022": [
        "Login as platform staff",
        "Navigate to /platform-admin/feature-flags",
        "Toggle admin delegation for test org ‚Üí verify mutation succeeds",
        "Toggle coach overrides ‚Üí verify mutation succeeds",
        "Verify counts update in real-time",
        "Test search and filters"
      ],
      "US-P8-022B": [
        "Verify overview cards show correct counts",
        "Click 'Show Orgs with Issues' ‚Üí verify correct orgs displayed",
        "Verify quick filter buttons work"
      ],
      "US-P8-023": [
        "Login as org admin",
        "Navigate to /orgs/[orgId]/settings/features",
        "If admin delegation disabled ‚Üí verify no blanket override toggle",
        "If admin delegation enabled ‚Üí toggle blanket override, verify all coaches get access",
        "Grant individual override ‚Üí verify coach can access",
        "Approve pending request ‚Üí verify override granted automatically",
        "Deny pending request ‚Üí verify request marked denied"
      ]
    }
  },
  "weekCompletionCriteria": [
    "‚úÖ Schema extensions complete (betterAuth/schema.ts, schema.ts with adminBlanketBlock fields)",
    "‚úÖ All permission queries return correct results (6 queries implemented)",
    "‚úÖ All permission mutations work with proper auth checks (8 mutations implemented)",
    "‚úÖ US-P8-002 fix deployed - comprehensive access check with 8-priority logic",
    "‚è∏Ô∏è Platform staff UI deferred (focus on org admin UI which provides more value)",
    "‚è∏Ô∏è Platform staff overview dashboard deferred",
    "‚úÖ Org admins can manage trust gates (bulk block + individual controls)",
    "‚úÖ Coach self-service toggle implemented (hide/show tab)",
    "‚úÖ All type checks pass (npm run check-types)",
    "‚úÖ All lint checks pass (npx ultracite fix)",
    "‚úÖ All stories visually verified in browser",
    "‚úÖ Better Auth integration patterns documented",
    "‚úÖ P8_CHECKPOINT_JAN28.md created with full status",
    "‚úÖ P8_WEEK2_RALPH_CONTEXT.md created with learnings",
    "‚úÖ Testing documentation complete (40 test cases + quick guide)",
    "‚úÖ 9 stories delivered (5 planned + 4 enhancements beyond original plan)"
  ],
  "nextPhase": {
    "name": "P8 Week 2 - My Impact Dashboard Components",
    "stories": "US-P8-005 to US-P8-011 (7 stories)",
    "description": "Build complete My Impact dashboard: summary cards, sent summaries section, applied insights section, team observations, search, filters. Will respect new trust gate system for all feature visibility."
  }
}

{
  "project": "Voice Enhance Gating-WAPP v2",
  "branchName": "feat/voice-gateways-v2",
  "description": "Phase 6: Drafts & Confirmation Workflow. Create insightDrafts table for pending insights with confidence scoring, WhatsApp command parser for CONFIRM/CANCEL workflows, and v1-to-v2 migration script.",
  "issueReference": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE3_V2_MIGRATION.md",
    "docs/architecture/voice-notes-pipeline-v2.md"
  ],
  "previousPhases": [
    "Phase 1",
    "Phase 2",
    "Phase 2.5",
    "Phase 3",
    "Phase 4",
    "Phase 5"
  ],
  "currentPhase": "Phase 6 - Drafts & Confirmation Workflow",
  "completedStories": [
    "US-VN-001",
    "US-VN-002",
    "US-VN-003",
    "US-VN-004",
    "US-VN-005",
    "US-VN-006",
    "US-VN-007",
    "US-VN-008",
    "US-VN-009",
    "US-VN-010",
    "US-VN-011",
    "US-VN-012",
    "US-VN-013",
    "US-VN-014",
    "US-VN-015",
    "US-VN-016",
    "US-VN-017",
    "US-VN-018"
  ],
  "criticalLearnings": {
    "description": "Lessons from Phases 1-5 that MUST be followed:",
    "patterns": [
      "ALL public queries/mutations MUST check ctx.auth.getUserIdentity() and verify artifact/data ownership",
      "NEVER accept caller-supplied userId params — derive from identity.subject",
      "Use .withIndex() for ALL queries — NEVER use .filter() on Convex query builder",
      "Use batch fetch + Map lookup to avoid N+1 queries",
      "Include args AND returns validators on ALL Convex functions",
      "Use v.optional(v.string()) NOT v.string() | null — Convex rejects null for optional fields",
      "Actions cannot access ctx.db — use ctx.runQuery/ctx.runMutation",
      "InternalActions should call internal mutations, NOT public mutations",
      "Score/confidence values must be bounds-checked (0-1 range)",
      "All indexes should be org-scoped (by_org_and_X) — avoid unbounded table scans"
    ],
    "betterAuth": [
      "Use user._id (NOT user.id) for user ID",
      "Use user.name (NOT user.firstName/lastName) for display name",
      "Use identity.subject for the authenticated user's ID in Convex handlers"
    ]
  },
  "existingInfrastructure": {
    "description": "Key tables and functions already built that Phase 6 depends on:",
    "tables": [
      "voiceNoteArtifacts — v2 pipeline source records (artifactId, senderUserId, orgContextCandidates, status)",
      "voiceNoteClaims — extracted claims with topics, entity mentions, resolved entities",
      "voiceNoteEntityResolutions — resolution records with candidates, scores, matchReasons",
      "coachPlayerAliases — learned coach nickname mappings",
      "coachTrustLevels — coach trust scoring with insightConfidenceThreshold and insightAutoApplyPreferences",
      "featureFlags — feature flag system with cascade evaluation",
      "reviewAnalyticsEvents — analytics event logging"
    ],
    "keyFunctions": [
      "voiceNotes.ts: processVoiceNote — main pipeline orchestrator",
      "claimsExtraction.ts: extractClaims — GPT-4 claim extraction",
      "entityResolution.ts: resolveEntities — entity resolution with aliases and fuzzy matching",
      "coachContext.ts: gatherCoachContext — returns players, teams, coaches for an org+coach",
      "featureFlags.ts: shouldUseV2Pipeline, shouldUseEntityResolution — cascade flag evaluation",
      "whatsapp.ts: processIncomingMessage — WhatsApp webhook handler"
    ]
  },
  "userStories": [
    {
      "id": "US-VN-019",
      "phase": 6,
      "title": "Drafts Table & Auto-Confirm Logic",
      "description": "Create insightDrafts table to store pending insights awaiting confirmation before applying to player records. Each draft has confidence scoring (AI extraction * entity resolution). Trusted coaches (level >= 2) with high-confidence drafts get auto-confirmed. Others require manual confirmation via WhatsApp or web UI.",
      "acceptanceCriteria": [
        "--- SCHEMA: insightDrafts ---",
        "Backend: Add insightDrafts table to schema.ts",
        "Schema fields:",
        "  - draftId: v.string() (UUID via crypto.randomUUID())",
        "  - artifactId: v.id('voiceNoteArtifacts')",
        "  - claimId: v.id('voiceNoteClaims')",
        "  - playerIdentityId: v.optional(v.id('playerIdentities'))",
        "  - insightType: v.union('injury','skill_rating','skill_progress','behavior','performance','attendance','wellbeing','recovery','development_milestone','physical_development','parent_communication','tactical','team_culture','todo','session_plan') — mirrors voiceNoteClaims.topic exactly (15 types, NOT 8)",
        "  - title: v.string()",
        "  - description: v.string()",
        "  - evidence: v.object({ transcriptSnippet: v.string(), timestampStart: v.optional(v.number()) })",
        "  - aiConfidence: v.number() (from claim.extractionConfidence)",
        "  - resolutionConfidence: v.number() (from entity resolution score, 1.0 if auto-resolved in Phase 4)",
        "  - overallConfidence: v.number() (aiConfidence * resolutionConfidence)",
        "  - requiresConfirmation: v.boolean()",
        "  - status: v.union('pending', 'confirmed', 'rejected', 'applied', 'expired')",
        "  - organizationId: v.string() (denormalized for auth filtering)",
        "  - coachUserId: v.string() (denormalized for auth filtering)",
        "  - confirmedAt: v.optional(v.number())",
        "  - displayOrder: v.number() — 1-indexed position for stable WhatsApp CONFIRM 1,2,3 numbering (ADR-VN2-028)",
        "  - resolvedPlayerName: v.optional(v.string()) — denormalized from entity resolution for WhatsApp summary (avoids N+1 lookup)",
        "  - appliedAt: v.optional(v.number())",
        "  - createdAt: v.number()",
        "  - updatedAt: v.number()",
        "Indexes:",
        "  - by_draftId: ['draftId']",
        "  - by_artifactId: ['artifactId']",
        "  - by_artifactId_and_status: ['artifactId', 'status'] — for command handler querying pending drafts per artifact (ADR-VN2-029)",
        "  - by_org_and_coach_and_status: ['organizationId', 'coachUserId', 'status']",
        "  - by_playerIdentityId_and_status: ['playerIdentityId', 'status']",
        "",
        "--- MODEL: insightDrafts.ts ---",
        "Backend: Create models/insightDrafts.ts",
        "Functions:",
        "  - createDrafts (internalMutation): Batch insert drafts. Calculate overallConfidence. Set requiresConfirmation based on threshold + trust level.",
        "  - getDraftsByArtifact (internalQuery): args: { artifactId }. Returns all drafts for an artifact.",
        "  - getPendingDraftsForCoach (query - PUBLIC): args: { organizationId }. Derives coachUserId from identity.subject. Returns pending drafts.",
        "  - confirmDraft (mutation - PUBLIC): args: { draftId }. Verify ownership via artifact. Set status='confirmed', confirmedAt=now.",
        "  - confirmAllDrafts (mutation - PUBLIC): args: { artifactId }. Confirm all pending drafts for this artifact. Verify ownership.",
        "  - rejectDraft (mutation - PUBLIC): args: { draftId }. Verify ownership. Set status='rejected'.",
        "  - rejectAllDrafts (mutation - PUBLIC): args: { artifactId }. Reject all pending. Verify ownership.",
        "  - applyDraft (internalMutation): args: { draftId }. Apply confirmed draft to player records (create voiceNoteInsight or similar). Set status='applied', appliedAt=now.",
        "",
        "--- DRAFT GENERATION ACTION ---",
        "Backend: Create actions/draftGeneration.ts",
        "Function: generateDrafts (internalAction)",
        "  args: { artifactId: v.id('voiceNoteArtifacts') }",
        "  returns: v.null()",
        "  Logic:",
        "    1. Get artifact (org, coach context)",
        "    2. Get all claims for artifact that are resolved or auto-resolved",
        "    3. Get entity resolution records for resolved claims",
        "    4. For each resolved claim with a player entity:",
        "       - Map claim topic to insightType",
        "       - Calculate confidence scores",
        "       - Create draft record",
        "    5. Get coach trust level",
        "    6. Auto-confirm gate (ADR-VN2-024 — ALL conditions must pass):",
        "       a. Coach trust level >= 2 (respecting preferredLevel cap)",
        "       b. overallConfidence >= coach's personalized insightConfidenceThreshold (default 0.85)",
        "       c. insightAutoApplyPreferences[insightType] !== false (per-category toggle)",
        "       d. insightType NOT in ['injury', 'wellbeing', 'recovery'] — NEVER auto-confirm sensitive categories",
        "    7. For auto-confirmed drafts, schedule applyDraft",
        "",
        "--- INTEGRATION ---",
        "Integration: Schedule from entityResolution.ts after resolutions are stored",
        "  - After storeResolutions: ctx.scheduler.runAfter(0, internal.actions.draftGeneration.generateDrafts, { artifactId })",
        "  - Only if feature flag enabled (reuse shouldUseV2Pipeline check)",
        "",
        "--- VERIFICATION ---",
        "Type check passes: npm run check-types",
        "Build passes: npm run build",
        "Manual test: Voice note with high-confidence resolved claim → draft auto-confirmed for trusted coach",
        "Manual test: Voice note with low-confidence claim → draft pending for confirmation",
        "Manual test: New coach (trust level 0) → all drafts pending regardless of confidence"
      ],
      "priority": 19,
      "passes": true,
      "effort": "2 days",
      "dependencies": ["US-VN-018"],
      "files": {
        "create": [
          "packages/backend/convex/models/insightDrafts.ts",
          "packages/backend/convex/actions/draftGeneration.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add insightDrafts table)",
          "packages/backend/convex/actions/entityResolution.ts (schedule draft generation after resolution)"
        ]
      }
    },
    {
      "id": "US-VN-020",
      "phase": 6,
      "title": "WhatsApp Command Parser & Handler",
      "description": "Implement WhatsApp command parser and handler for confirmation workflow. Coaches can reply CONFIRM, CONFIRM 1,2,3, CANCEL, or TWINS = Emma & Niamh to manage their pending drafts directly from WhatsApp.",
      "acceptanceCriteria": [
        "--- COMMAND PARSER ---",
        "Backend: Create lib/whatsappCommands.ts",
        "Function: parseCommand(text: string): Command | null",
        "  Supported commands (case-insensitive):",
        "    - 'CONFIRM' or 'YES' → confirm all pending drafts",
        "    - 'CONFIRM 1,2,3' or 'YES 1,2,3' → confirm specific draft numbers",
        "    - 'CANCEL' or 'NO' → reject all pending drafts",
        "    - 'TWINS = Emma & Niamh' → custom entity mapping for group references",
        "    - 'TWINS = Emma and Niamh U12' → with team context",
        "  Return type: { type: 'confirm_all' | 'confirm_specific' | 'cancel' | 'entity_mapping', draftNumbers?: number[], entityMapping?: { rawText: string, playerNames: string[], teamContext?: string } } | null",
        "  Returns null if text is not a recognized command (normal voice/text processing continues)",
        "",
        "--- COMMAND HANDLER (ADR-VN2-031) ---",
        "Backend: Create lib/whatsappCommandHandler.ts",
        "Function: handleCommand (async helper function — NOT a Convex action, because Convex cannot ctx.runAction from within an action. Called directly from processIncomingMessage which is already an internalAction with ctx.runQuery/ctx.runMutation access)",
        "  Params: ctx (ActionCtx), coachUserId: string, organizationId: string, command: Command",
        "  Returns: string (response message to send back via WhatsApp)",
        "  Logic:",
        "    1. Get pending drafts for coach in this org",
        "    2. If command.type === 'confirm_all':",
        "       - Confirm all pending drafts",
        "       - Schedule applyDraft for each confirmed draft",
        "       - Return: 'Saved {count} updates. Updated players: {names}'",
        "    3. If command.type === 'confirm_specific':",
        "       - Confirm only the numbered drafts (1-indexed from the summary message)",
        "       - Return: 'Saved {count} of {total} updates.'",
        "    4. If command.type === 'cancel':",
        "       - Reject all pending drafts",
        "       - Return: 'Cancelled all pending updates.'",
        "    5. If command.type === 'entity_mapping':",
        "       - Resolve group reference using provided names + fuzzy matching",
        "       - Update entity resolutions with resolved entities",
        "       - Return: '{rawText} resolved to {names}. Reply CONFIRM to save.'",
        "",
        "--- INTEGRATION ---",
        "Integration: Add to processIncomingMessage in whatsapp.ts",
        "  - After receiving a text message (not audio), check if it's a command:",
        "    const command = parseCommand(messageText);",
        "    if (command) { handleCommand(...); sendWhatsAppResponse(...); return; }",
        "  - If not a command, continue normal v1/v2 processing",
        "",
        "--- UNIT TESTS ---",
        "Create __tests__/whatsappCommands.test.ts",
        "Test cases:",
        "  - 'CONFIRM' → { type: 'confirm_all' }",
        "  - 'confirm' → { type: 'confirm_all' } (case insensitive)",
        "  - 'YES' → { type: 'confirm_all' }",
        "  - 'CONFIRM 1,2,3' → { type: 'confirm_specific', draftNumbers: [1,2,3] }",
        "  - 'CANCEL' → { type: 'cancel' }",
        "  - 'NO' → { type: 'cancel' }",
        "  - 'TWINS = Emma & Niamh' → { type: 'entity_mapping', entityMapping: { rawText: 'TWINS', playerNames: ['Emma', 'Niamh'] } }",
        "  - 'Spent time on skills today' → null (not a command, normal processing)",
        "  - '' → null (empty string)",
        "",
        "--- VERIFICATION ---",
        "Type check passes: npm run check-types",
        "Build passes: npm run build",
        "Manual test: Send voice note → receive draft summary → reply CONFIRM → drafts applied",
        "Manual test: Reply CANCEL → drafts rejected",
        "Manual test: Reply 'TWINS = Emma and Niamh' → group reference resolved"
      ],
      "priority": 20,
      "passes": true,
      "effort": "2 days",
      "dependencies": ["US-VN-019"],
      "files": {
        "create": [
          "packages/backend/convex/lib/whatsappCommands.ts",
          "packages/backend/convex/lib/whatsappCommandHandler.ts",
          "packages/backend/convex/__tests__/whatsappCommands.test.ts"
        ],
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (integrate command parsing into processIncomingMessage)"
        ]
      }
    },
    {
      "id": "US-VN-021",
      "phase": 6,
      "title": "v1-to-v2 Migration Script",
      "description": "Create migration action to backfill historical v1 voice notes into v2 artifacts, transcripts, and claims. Supports dry-run mode and batch processing. Optional — only run when ready to fully transition to v2 pipeline.",
      "acceptanceCriteria": [
        "--- MIGRATION ACTION ---",
        "Backend: Create actions/migration.ts",
        "Function: migrateVoiceNotesToV2 (internalAction)",
        "  args: { organizationId: v.optional(v.string()), dryRun: v.boolean(), batchSize: v.optional(v.number()) }",
        "  returns: v.object({ processed: v.number(), artifacts: v.number(), transcripts: v.number(), claims: v.number(), errors: v.number(), skipped: v.number() })",
        "  Logic:",
        "    1. Query voiceNotes with status='completed' (optionally filter by org)",
        "    2. Skip voiceNotes that already have a linked artifact (check voiceNoteArtifacts.by_voiceNoteId)",
        "    3. Process in batches of batchSize (default 50, max 200 — ADR-VN2-027 Convex timeout constraints)",
        "    4. For each voiceNote:",
        "       a. Generate artifactId (crypto.randomUUID())",
        "       b. Determine sourceChannel from voiceNote.source field",
        "       c. If dryRun=false: create artifact, link to voiceNote",
        "       d. If transcript exists: create voiceNoteTranscript (fullText from voiceNote.transcript, no segments)",
        "       e. If insights exist: best-effort create claims (map insight categories to claim topics)",
        "       f. Log progress every 50 records",
        "    5. Return summary with counts",
        "",
        "--- CONVEX DASHBOARD TRIGGER ---",
        "The migration can be triggered from Convex dashboard (Run Action) or via a scheduled job.",
        "No external script needed — runs as a Convex internalAction.",
        "",
        "--- ERROR HANDLING ---",
        "  - Log errors per voiceNote but continue processing remaining",
        "  - Include voiceNote ID in error logs for debugging",
        "  - Return error count in summary",
        "",
        "--- VERIFICATION ---",
        "Type check passes: npm run check-types",
        "Build passes: npm run build",
        "Manual test: Run with dryRun=true on test org → verify counts without writing",
        "Manual test: Run with dryRun=false on 10 test voice notes → verify artifacts, transcripts created",
        "Manual test: Run again on same data → skips already-migrated notes"
      ],
      "priority": 21,
      "passes": true,
      "effort": "1 day",
      "dependencies": ["US-VN-020"],
      "files": {
        "create": ["packages/backend/convex/actions/migration.ts"]
      }
    }
  ],
  "successCriteria": {
    "draftsWorking": "Resolved claims produce insightDraft records with correct confidence scoring",
    "autoConfirm": "Trusted coaches (level >= 2) with high-confidence drafts get auto-confirmed and applied",
    "whatsappCommands": "CONFIRM/CANCEL commands parsed and handled correctly from WhatsApp",
    "commandIntegration": "processIncomingMessage routes commands before normal processing",
    "migrationWorks": "v1 voiceNotes migrated to v2 artifacts+transcripts+claims with dry-run mode",
    "noRegressions": "v1 pipeline unchanged, v2 pipeline still works end-to-end",
    "authGuardsPresent": "All public functions verify ownership via identity.subject",
    "noN1Queries": "Batch patterns used throughout"
  },
  "mandatoryPatterns": [
    "ALWAYS use .withIndex() — NEVER use .filter()",
    "ALWAYS include args and returns validators on ALL queries/mutations",
    "ALWAYS use batch fetch with Map lookup to avoid N+1 queries",
    "ALWAYS check ctx.auth.getUserIdentity() on public queries/mutations",
    "ALWAYS verify data ownership (artifact.senderUserId === identity.subject)",
    "ALWAYS derive coachUserId from identity.subject — NEVER accept it as a client param",
    "ALWAYS filter by organizationId for data isolation",
    "ALWAYS bounds-check numeric inputs (scores 0-1, limits > 0)",
    "NEVER call public mutations from internalActions — use internalMutation instead",
    "NEVER pass null for optional Convex fields — omit the field entirely",
    "NEVER add a bare by_status index — always scope with organizationId"
  ],
  "architectureReview": {
    "status": "COMPLETED — 10 ADRs generated, 4 critical fixes applied to this PRD",
    "adrs": [
      "docs/architecture/decisions/ADR-VN2-023-draft-confidence-scoring-formula.md",
      "docs/architecture/decisions/ADR-VN2-024-auto-confirm-threshold-and-trust-gating.md",
      "docs/architecture/decisions/ADR-VN2-025-whatsapp-command-routing-and-concurrency.md",
      "docs/architecture/decisions/ADR-VN2-026-draft-application-target-and-lifecycle.md",
      "docs/architecture/decisions/ADR-VN2-027-migration-batch-size-and-timeout-strategy.md",
      "docs/architecture/decisions/ADR-VN2-028-draft-numbering-stability-for-whatsapp-commands.md",
      "docs/architecture/decisions/ADR-VN2-029-insight-drafts-schema-and-index-strategy.md",
      "docs/architecture/decisions/ADR-VN2-030-draft-generation-scheduling-and-integration-point.md",
      "docs/architecture/decisions/ADR-VN2-031-whatsapp-command-handler-as-internal-action.md",
      "docs/architecture/decisions/ADR-VN2-032-migration-v1-field-mapping-and-idempotency.md"
    ],
    "criticalFixesApplied": [
      "C1: insightType expanded from 8 to 15 types (mirrors voiceNoteClaims.topic)",
      "C2: No bare by_status index (org-scoped indexes only)",
      "C3: 5-status enum includes 'expired'",
      "C4: Command handler is lib/ async helper (not action — Convex cannot ctx.runAction from action)"
    ],
    "warningsApplied": [
      "W1: Added displayOrder field for stable WhatsApp numbering",
      "W2: Added resolvedPlayerName denormalization",
      "W4: Added by_artifactId_and_status index",
      "W5: Auto-confirm gate expanded with category preferences, personalized threshold, sensitive category exclusions"
    ],
    "implementationGuidance": "scripts/ralph/agents/output/feedback.md"
  },
  "ralphInstructions": {
    "executionMode": "sequential",
    "storyOrder": ["US-VN-019", "US-VN-020", "US-VN-021"],
    "preImplementation": "Read ALL 10 ADRs in docs/architecture/decisions/ADR-VN2-023 through ADR-VN2-032 AND scripts/ralph/agents/output/feedback.md BEFORE starting any story",
    "testingStrategy": "Unit tests for whatsappCommands parser (US-VN-020). Manual testing for all stories.",
    "qualityCriteria": "npm run check-types passes, npm run build succeeds, manual test scenarios pass"
  }
}

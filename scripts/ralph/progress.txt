# Ralph Progress Log - Phase 7.1 (Insight Auto-Apply Preview Mode)
Started: 2026-01-25 23:15:00 GMT
Base Branch: phase7/prerequisites-insight-auto-apply (commit b2c320f)
Ralph Branch: ralph/coach-insights-auto-apply-p7-phase1
PRD: scripts/ralph/prds/p7-coach-insight-auto-apply-phase7.prd.json
---

## PHASE 7.1 OVERVIEW

**Goal**: Preview Mode for Insights - Show coaches what AI would auto-apply
**Stories**: US-001 (complete), US-002, US-003, US-004, US-005
**Duration Estimate**: 3-4 hours automated execution
**Pattern**: Mirrors P5 Phase 1 (Parent Summary Preview Mode)

## PREREQUISITES COMPLETED âœ…

### Schema Extensions (Prerequisite Branch)
- âœ… voiceNoteInsights table created (lines 1439-1560 in schema.ts)
- âœ… autoAppliedInsights table created (lines 1492-1560 in schema.ts)
- âœ… coachTrustLevels extended with insight fields (lines 2089-2108)
- âœ… Migration executed: 40 insights migrated with default 0.7 confidence
- âœ… AI confidence scoring implemented in voiceNotes.ts action
- âœ… Knowledge graph alignment verified

### Documentation References
- scripts/ralph/P7_PREREQUISITES_COMPLETED.md - What's been done
- scripts/ralph/P7_RALPH_CONTEXT.md - Complete P5/P6 learnings
- scripts/ralph/P7_KNOWLEDGE_GRAPH_ALIGNMENT.md - Future-proofing
- scripts/ralph/P7_PHASE1_PREREQUISITES_NOTE.md - What Ralph needs to know
- scripts/ralph/P7_PHASE1_EXECUTION_PLAN.md - Execution guide

## STORY STATUS

### âœ… US-001: Insight preview mode fields in coachTrustLevels
**Status**: COMPLETE (prerequisite work)
**Location**: packages/backend/convex/schema.ts (lines 2089-2108)
**Action**: Ralph should verify fields exist and mark complete immediately

Fields added:
- insightPreviewModeStats (wouldAutoApplyInsights, coachAppliedThose, coachDismissedThose, agreementRate)
- insightConfidenceThreshold (default 0.7)
- insightAutoApplyPreferences (skills, attendance, goals, performance booleans)

---

### ðŸ”¨ US-002: Add wouldAutoApply calculation to getPendingInsights query
**Status**: TODO
**Priority**: 2
**Estimated Time**: 30 minutes

**Implementation Plan**:
1. Create packages/backend/convex/models/voiceNoteInsights.ts
2. Create getPendingInsights query
3. Query voiceNoteInsights TABLE (NOT embedded array!)
4. Use index: by_coach_org_status
5. Calculate wouldAutoApply per insight based on trust level and confidence
6. Return insights with wouldAutoApply boolean field

**Key Pattern from P5**:
```typescript
const effectiveLevel = Math.min(trustLevel?.currentLevel ?? 0, trustLevel?.preferredLevel ?? trustLevel?.currentLevel ?? 0)
const threshold = trustLevel?.insightConfidenceThreshold ?? 0.7
const wouldAutoApply =
  insight.category !== 'injury' &&
  insight.category !== 'medical' &&
  effectiveLevel >= 2 &&
  insight.confidenceScore >= threshold
```

**Acceptance**:
- Query returns wouldAutoApply boolean
- Type check passes
- Uses .withIndex() (not .filter())

---

### ðŸ”¨ US-003: Add confidence visualization to insight cards
**Status**: TODO
**Priority**: 3
**Estimated Time**: 30 minutes

**Implementation Plan**:
1. Find insight card components in apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/
2. Add confidence progress bar and percentage
3. Color code: Red <60%, Amber 60-79%, Green 80%+
4. Pattern exactly matches P5 US-003

**Reference Implementation**:
- P5: apps/web/src/app/orgs/[orgId]/coach/parent-summaries/components/summary-card.tsx

**Acceptance**:
- Confidence bar visible on all insight cards
- Color coding correct
- Visual verification in browser required

---

### ðŸ”¨ US-004: Add preview mode prediction badge to insight cards
**Status**: TODO
**Priority**: 4
**Estimated Time**: 30 minutes

**Implementation Plan**:
1. Add wouldAutoApply prop to insight card components
2. Show blue badge: "AI would auto-apply this at Level 2+" for wouldAutoApply=true
3. Show "Requires manual review" text for wouldAutoApply=false
4. Use Sparkles icon from lucide-react

**Pattern from P5 US-004**:
```tsx
{insight.wouldAutoApply ? (
  <Badge variant='secondary' className='bg-blue-100 text-blue-700'>
    <Sparkles className='mr-1 h-3 w-3' />
    AI would auto-apply this at Level 2+
  </Badge>
) : (
  <p className='text-sm text-muted-foreground'>Requires manual review</p>
)}
```

**Acceptance**:
- Badge appears on high-confidence skills
- "Manual review" text on injury/medical/low-confidence
- Visual verification required

---

### ðŸ”¨ US-005: Track preview statistics when coaches apply/dismiss
**Status**: TODO
**Priority**: 5
**Estimated Time**: 45 minutes

**Implementation Plan**:
1. Create applyInsight mutation in voiceNoteInsights.ts
2. Create dismissInsight mutation in voiceNoteInsights.ts
3. Before applying/dismissing, check if preview mode active
4. If active, calculate wouldAutoApply and update stats
5. Increment appropriate counters
6. Mark preview complete after 20 insights

**Pattern from P5 US-005**:
- Check trustLevel.insightPreviewModeStats exists and !completedAt
- Calculate if insight wouldAutoApply
- Update counters: wouldAutoApplyInsights, coachAppliedThose, coachDismissedThose
- Calculate agreementRate
- Set completedAt when >= 20 insights reviewed

**Acceptance**:
- Applying insight updates preview stats
- Dismissing insight updates preview stats
- After 20 insights, completedAt is set
- Type check passes

---

## CODE REVIEW FEEDBACK

<!-- Agents will write feedback below this line -->

---

## EXECUTION NOTES

**Ralph Execution Command**:
```bash
npm run ralph -- \
  --prd scripts/ralph/prds/p7-coach-insight-auto-apply-phase7.prd.json \
  --phase 7.1 \
  --stories US-001,US-002,US-003,US-004,US-005 \
  --branch ralph/coach-insights-auto-apply-p7-phase1
```

**Critical Reminders for Ralph**:
1. voiceNoteInsights is a TABLE (not embedded array) - use .withIndex()
2. Confidence scores already exist (0.7 default, AI-generated for new)
3. US-001 and US-006 already complete (verify and skip)
4. Reference P5 implementations for patterns
5. NEVER auto-apply injury or medical insights
6. Store targetRecordId for knowledge graph integration (Phase 7.2)

**Testing Account**:
- Coach: neil.B@blablablak.com / lien1979
- Dev server: http://localhost:3000
- Navigate to: Voice Notes â†’ Insights tab

**Success Criteria**:
- [ ] All 5 stories complete (US-001 verified, US-002-005 implemented)
- [ ] Type check passes: npm run check-types
- [ ] Linting passes: npx ultracite fix
- [ ] Codegen runs successfully
- [ ] Visual verification: Confidence bars and badges appear
- [ ] Manual testing: Apply/dismiss insights, check preview stats update

---

## PHASE HISTORY (Previous Phases)

### Phase 6.4: Performance Optimization (COMPLETE)
- US-023: Daily aggregation for AI usage stats
- Optimized dashboard queries 10-100x faster
- Branch: ralph/coach-parent-summaries-p6-phase4
- Status: Merged to main

### Phase 5 & 6: Parent Summary Trust System (COMPLETE)
- P5 Phases 1-4: Trust ladder, preview mode, supervised auto-send, learning loop
- P6 Phases 1-4: Cost controls, circuit breakers, admin dashboard, performance
- All prerequisites for P7 pattern established
- See scripts/ralph/P7_RALPH_CONTEXT.md for complete learnings

---

**Last Updated**: 2026-01-25 23:15 GMT
**Current Phase**: 7.1 - Preview Mode (Week 1-2)
**Next Phase**: 7.2 - Supervised Auto-Apply (Weeks 3-4)

{
  "project": "PlayerARC - Phase 1.2: Backend Import Engine",
  "branchName": "ralph/phase-1.2-backend-import-engine",
  "description": "Build the core import processing engine: CSV/Excel parser, smart field mapper with 5 matching strategies, row validator with auto-fix suggestions, benchmark applicator with 5 strategies, and sport configuration helpers. Modify existing playerImport.ts to accept sportCode parameter, session tracking, row selection, and benchmark application while preserving the proven guardian matching algorithm.",
  "prdFile": "scripts/ralph/prds/Importing Members/phase-1-foundation.md",
  "contextFiles": [
    "packages/backend/convex/schema.ts",
    "packages/backend/convex/models/playerImport.ts",
    "packages/backend/convex/models/importTemplates.ts",
    "packages/backend/convex/models/importSessions.ts",
    "packages/backend/convex/lib/matching/guardianMatcher.ts",
    "apps/web/src/components/gaa-import.tsx",
    "CLAUDE.md"
  ],
  "mandatoryPatterns": [
    "Use Convex function syntax with args and returns validators",
    "Use .withIndex() never .filter() for queries",
    "Follow batch fetch + Map lookup pattern for related data (no N+1)",
    "PRESERVE guardian matching algorithm in playerImport.ts - do NOT modify matching weights or scoring logic",
    "All new parameters to playerImport.ts must be optional for backward compatibility",
    "Parser and mapper are utility functions in lib/ - they don't access ctx.db directly",
    "Run npx ultracite fix before completing any story",
    "Run npx -w packages/backend convex codegen to verify"
  ],
  "successCriteria": [
    "CSV parser handles quotes, multi-line cells, delimiter detection, encoding detection",
    "Field mapper achieves 80%+ auto-mapping for known templates using 5 strategies",
    "Validator catches required field errors, invalid emails/phones/dates, and provides auto-fix suggestions",
    "Benchmark applicator correctly applies all 5 strategies (blank, middle, age-appropriate, ngb-benchmarks, custom)",
    "playerImport.ts accepts sportCode parameter and defaults to 'gaa_football' when not provided",
    "playerImport.ts filters by selectedRowIndices when provided",
    "playerImport.ts applies benchmarks after passport creation when benchmarkSettings provided",
    "Guardian matching algorithm is 100% unchanged",
    "All type checks pass: npm run check-types"
  ],
  "userStories": [
    {
      "id": "US-P1.2-001",
      "title": "Create CSV parser utility",
      "description": "As the import system, I need to parse CSV files with robust handling of edge cases including quoted fields, multi-line cells, and various delimiters.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/parser.ts",
        "Implement parseCSV function that handles: comma/semicolon/tab/pipe delimiters, quoted fields with embedded commas, multi-line cells in quotes",
        "Implement detectDelimiter function that auto-detects the delimiter from file content",
        "Implement detectHeaderRow function using heuristic (first row with >50% string-like values)",
        "Return ParseResult type: { headers: string[], rows: Record<string, string>[], totalRows: number, detectedDelimiter: string }",
        "Handle empty rows and whitespace-only values gracefully",
        "NOTE: Use native string parsing - do NOT add npm dependencies like papaparse (Convex runtime restrictions)"
      ],
      "priority": 1,
      "passes": false,
      "notes": "This is a utility module imported by frontend or Convex actions. Keep it dependency-free for maximum portability. The existing GAA import uses client-side CSV parsing in gaa-import.tsx - study that pattern (lines 591-829) for reference on how headers and rows are extracted."
    },
    {
      "id": "US-P1.2-002",
      "title": "Create field alias database and exact/alias matching",
      "description": "As the import system, I need a comprehensive alias database for common CSV column names and matching functions for exact and alias-based mapping.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/mapper.ts",
        "Define FIELD_ALIASES constant mapping target fields to arrays of known aliases: firstName (forename, first name, fname, given name, christian name), lastName (surname, last name, lname, family name), dateOfBirth (dob, birth date, birthday, date of birth), email (e-mail, email address, contact email), phone (mobile, cell, telephone, contact number, phone number), plus 15+ more fields",
        "Implement exactMatch function: lowercase comparison, returns 100% confidence",
        "Implement aliasMatch function: checks against alias database, returns 95% confidence",
        "Implement normalizeColumnName function: lowercase, trim, remove special chars",
        "Export getFieldAliases helper for external use"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Include aliases for: address, town, postcode/eircode/zipcode, country, gender/sex, ageGroup, season, parentFirstName/parentLastName, parentEmail, parentPhone, guardian variants of parent fields, clubMembershipNumber, playerAddress, guardian1Address, guardian2Address per Phase 1 PRD multi-guardian address section."
    },
    {
      "id": "US-P1.2-003",
      "title": "Add fuzzy and content-analysis matching to mapper",
      "description": "As the import system, I need fuzzy string matching and content analysis to map columns that don't match exactly or by alias.",
      "acceptanceCriteria": [
        "Add to packages/backend/convex/lib/import/mapper.ts",
        "Implement fuzzyMatch function using Levenshtein distance calculation (implement inline - no npm dependency)",
        "Fuzzy match threshold: distance <= 3 edits returns 70-90% confidence (scaled by distance)",
        "Implement analyzeColumnContent function: examine sample values to infer field type using regex patterns (email, phone, date, postcode, name-like, numeric)",
        "Content analysis returns 60-80% confidence based on pattern match strength",
        "Implement main suggestMappings function that runs all strategies in order: exact -> alias -> fuzzy -> content analysis, returning the highest confidence match for each column"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Levenshtein distance can be implemented in ~20 lines. No need for npm packages. Content analysis regex examples: email = /^[^@]+@[^@]+\\.[^@]+$/, phone = /^[+]?[\\d\\s()-]{7,}$/, date = /^\\d{1,4}[/-]\\d{1,2}[/-]\\d{1,4}$/."
    },
    {
      "id": "US-P1.2-004",
      "title": "Add historical mapping lookup to mapper",
      "description": "As the import system, I need to check importMappingHistory for past successful mappings to improve accuracy for returning organizations.",
      "acceptanceCriteria": [
        "Add to packages/backend/convex/lib/import/mapper.ts",
        "Create suggestMappingsWithHistory function that accepts a QueryCtx parameter",
        "Query importMappingHistory by normalizedColumnName and optional organizationId using indexes",
        "Historical matches return 80% confidence when usageCount >= 3",
        "Historical matches return 70% confidence when usageCount < 3",
        "Integrate into suggestMappings pipeline: exact -> alias -> historical -> fuzzy -> content analysis",
        "Historical match takes priority over fuzzy and content analysis but not exact or alias"
      ],
      "priority": 4,
      "passes": false,
      "notes": "This function needs QueryCtx because it reads from the database. Other mapping strategies are pure functions. The suggestMappingsWithHistory wrapper calls the ctx-free strategies first, then adds historical lookup."
    },
    {
      "id": "US-P1.2-005",
      "title": "Create row validator with auto-fix suggestions",
      "description": "As the import system, I need to validate each row against field definitions and provide auto-fix suggestions for common errors.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/validator.ts",
        "Implement validateRow function that checks: required fields present, email format (basic RFC check), phone format (starts with + or digits, 7+ chars), date format (multiple formats: DD/MM/YYYY, MM/DD/YYYY, YYYY-MM-DD), gender normalization (m/f/male/female/boy/girl -> male/female/other)",
        "Implement autoFixValue function for common errors: date format standardization to ISO, phone number +353/+44/+1 prefix suggestion, email typo detection (gmial->gmail, yaho->yahoo), name title-casing",
        "Return ValidationResult: { valid: boolean, errors: Array<{field, error, value, suggestedFix?}> }",
        "Implement validateBatch for processing multiple rows, returning per-row results plus summary stats"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Keep validation lightweight - no npm dependencies. Use regex for format checks. The auto-fix suggestions are advisory (shown to user) not automatic. Common email typo domains: gmial.com, gmal.com, yaho.com, hotmal.com, outlok.com."
    },
    {
      "id": "US-P1.2-006",
      "title": "Create benchmark applicator with 5 strategies",
      "description": "As the import system, I need to apply initial skill ratings to newly created sport passports using one of 5 strategies.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/benchmarkApplicator.ts",
        "Implement applyBenchmarksToPassport function accepting MutationCtx, passportId, and settings (strategy, templateId, ageGroup, sportCode)",
        "Strategy 'blank': set all skills to rating 1",
        "Strategy 'middle': set all skills to rating 3",
        "Strategy 'age-appropriate': query skillBenchmarks table for sport+ageGroup, use expectedRating",
        "Strategy 'ngb-benchmarks': same as age-appropriate but filtered by source (NGB provider)",
        "Strategy 'custom': query benchmarkTemplates table by templateId, use template ratings",
        "Create skillAssessment records with assessmentType 'import', source 'manual', rating based on strategy",
        "Return { benchmarksApplied: number } count"
      ],
      "priority": 6,
      "passes": false,
      "notes": "For strategies that need skill definitions, query the existing skillDefinitions table by sportCode. For each skill, create a skillAssessment record linked to the passport. The 'import' assessmentType already exists in the skillAssessments schema union."
    },
    {
      "id": "US-P1.2-007",
      "title": "Create sport configuration helper",
      "description": "As the import system, I need to look up sport-specific configurations including age groups, skills, and validation rules.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/lib/import/sportConfig.ts",
        "Implement getSportConfig function that queries sports table by sportCode",
        "Implement getAgeGroupsForSport function that returns valid age groups for a sport (from sportAgeGroupConfig table)",
        "Implement getSkillsForSport function that returns skill definitions for a sport (from skillDefinitions table)",
        "Implement validateAgeForGroup function that checks if a player's age is valid for an age group",
        "All queries use .withIndex() - never .filter()"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Check the existing sportAgeGroupConfig and skillDefinitions tables in schema.ts for the exact fields and indexes available. These functions are query helpers called by the import pipeline."
    },
    {
      "id": "US-P1.2-008",
      "title": "Add sportCode parameter to playerImport.ts",
      "description": "As the import system, I need to pass a sport code to the import mutation instead of hardcoding 'gaa_football'.",
      "acceptanceCriteria": [
        "Modify packages/backend/convex/models/playerImport.ts batchImportPlayersWithIdentity mutation",
        "Add optional arg: sportCode: v.optional(v.string())",
        "Replace all hardcoded 'gaa_football' references with: args.sportCode || 'gaa_football'",
        "DO NOT modify the guardian matching algorithm (lines 139-249 approximately)",
        "DO NOT change existing function signatures or required args",
        "Existing imports continue to work identically when sportCode is not provided",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 8,
      "passes": false,
      "notes": "CRITICAL: This is a surgical change. Only replace the string literal 'gaa_football' with the parameter. Do not refactor surrounding code. The guardian matching weights, scoring logic, and two-pass import phases must remain untouched."
    },
    {
      "id": "US-P1.2-009",
      "title": "Add session tracking and row selection to playerImport.ts",
      "description": "As the import system, I need to track which import session created records and filter by selected rows.",
      "acceptanceCriteria": [
        "Add optional args to batchImportPlayersWithIdentity: sessionId: v.optional(v.id('importSessions')), selectedRowIndices: v.optional(v.array(v.number()))",
        "When selectedRowIndices provided, filter players array before processing: only import players at those indices",
        "When sessionId provided, include importSessionId field when creating playerIdentities and orgPlayerEnrollments records",
        "DO NOT modify the guardian matching algorithm",
        "Existing imports without these parameters continue to work identically",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Row filtering should happen at the very start of the handler: const playersToImport = args.selectedRowIndices ? args.players.filter((_, idx) => args.selectedRowIndices!.includes(idx)) : args.players; Then use playersToImport instead of args.players for all subsequent processing."
    },
    {
      "id": "US-P1.2-010",
      "title": "Add benchmark application to playerImport.ts",
      "description": "As the import system, I need to apply benchmark ratings to sport passports during import when the user has configured benchmark settings.",
      "acceptanceCriteria": [
        "Add optional arg to batchImportPlayersWithIdentity: benchmarkSettings: v.optional(v.object({ applyBenchmarks: v.boolean(), strategy: v.string(), customTemplateId: v.optional(v.id('benchmarkTemplates')), passportStatuses: v.array(v.string()) }))",
        "After sport passport creation (Phase 4 of the import), if benchmarkSettings.applyBenchmarks is true, call applyBenchmarksToPassport for each created passport",
        "Import applyBenchmarksToPassport from lib/import/benchmarkApplicator.ts",
        "Add benchmarksApplied count to the return value",
        "DO NOT modify the guardian matching algorithm",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Benchmark application happens AFTER all 4 existing import phases complete. It's an additive step. The passportStatuses filter determines which passport statuses get benchmarks (e.g., only 'active' passports, not 'inactive')."
    }
  ]
}

# UAT Test: US-012 - ✅ COMPLETE: Implement adaptive confidence threshold based on undo patterns

> Auto-generated: 2026-01-26 12:13
> Status: ⏳ Pending Execution

## Story
As a coach, my confidence threshold auto-adjusts based on my undo behavior (high accuracy = lower threshold for more auto-apply).

## Acceptance Criteria Checklist

- [ ] Create or edit: packages/backend/convex/crons.ts
- [ ] Export const adjustInsightThresholds = internalMutation({
- [ ] handler: async (ctx) => {
- [ ] // Get all coaches with auto-apply enabled
- [ ] const coaches = await ctx.db.query('coachTrustLevels').collect()
- [ ] for (const coach of coaches) {
- [ ] // Skip if no preferences set
- [ ] if (!coach.insightAutoApplyPreferences) continue
- [ ] // Get recent auto-applied insights (last 30 days)
- [ ] const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000)
- [ ] const recentAudits = await ctx.db
- [ ] .query('autoAppliedInsights')
- [ ] .withIndex('by_coach_org', (q) => q.eq('coachId', coach.coachId).eq('organizationId', coach.organizationId))
- [ ] .filter((q) => q.gte(q.field('appliedAt'), thirtyDaysAgo))
- [ ] .collect()
- [ ] // Need at least 10 auto-applied insights for meaningful data
- [ ] if (recentAudits.length < 10) continue
- [ ] // Calculate undo rate
- [ ] const undoCount = recentAudits.filter(a => a.undoneAt !== undefined).length
- [ ] const undoRate = undoCount / recentAudits.length
- [ ] // Get current threshold
- [ ] const currentThreshold = coach.insightConfidenceThreshold ?? 0.7
- [ ] // Adjust threshold based on undo rate
- [ ] let newThreshold = currentThreshold
- [ ] if (undoRate < 0.03) {
- [ ] // Less than 3% undo rate = high trust, lower threshold
- [ ] newThreshold = Math.max(0.6, currentThreshold - 0.05)
- [ ] } else if (undoRate > 0.1) {
- [ ] // More than 10% undo rate = low trust, raise threshold
- [ ] newThreshold = Math.min(0.9, currentThreshold + 0.05)
- [ ] }
- [ ] // Update if changed
- [ ] if (newThreshold !== currentThreshold) {
- [ ] await ctx.db.patch(coach._id, { insightConfidenceThreshold: newThreshold })
- [ ] console.log(`Coach ${coach.coachId} threshold adjusted: ${currentThreshold} → ${newThreshold} (undo rate: ${Math.round(undoRate * 100)}%)`)
- [ ] }
- [ ] }
- [ ] }
- [ ] })
- [ ] Add to cron schedule: daily at 2am UTC
- [ ] Schedule in convex.json or crons configuration
- [ ] Type check passes
- [ ] Test: Manually call mutation, verify thresholds adjust correctly

## Test Scenarios

### Happy Path
1. Navigate to the feature
2. Perform the primary action described in the story
3. Verify all acceptance criteria are met
4. **Expected:** Feature works as described

### Edge Cases
1. Test with empty/null values
2. Test with boundary values
3. Test rapid repeated actions
4. **Expected:** Graceful handling, no errors

### Error Handling
1. Test with invalid inputs
2. Test without proper permissions
3. Test with network issues (if applicable)
4. **Expected:** Clear error messages, no crashes

## Visual Verification
- [ ] UI matches design expectations
- [ ] Responsive on mobile (if applicable)
- [ ] Loading states are appropriate
- [ ] Error states are user-friendly

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

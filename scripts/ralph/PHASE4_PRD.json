{
  "project": "Phase 9 Week 4 Phase 4 - Collaboration Features (Tasks + Insights)",
  "branchName": "ralph/p9-week4-team-hub",
  "description": "Complete Week 4 with Tasks Tab and Insights Tab. Build on existing patterns from Phases 1-3.",
  "contextFiles": [
    "scripts/ralph/PHASE4_CONTEXT.md",
    "scripts/ralph/PHASE3_CONTEXT.md",
    "scripts/ralph/progress.txt"
  ],
  "previousPhases": [
    "Phase 1: Foundation (Tab Navigation, Activity Feed Pagination, Schema) - COMPLETE ✅",
    "Phase 2: Core Widgets (Health Widget, Overview Dashboard) - COMPLETE ✅",
    "Phase 3: Tab Views (Players Tab, Planning Tab) - COMPLETE ✅"
  ],
  "currentPhase": "Phase 4 - Collaboration Features (2 stories, 9 hours)",
  "completedStories": [
    "US-P9-063: Tab Navigation",
    "US-P9-SCHEMA: Schema updates",
    "US-P9-056: Activity Feed Pagination",
    "US-P9-055: Health & Safety Widget",
    "US-P9-052: Overview Dashboard",
    "US-P9-053: Players Tab",
    "US-P9-054: Planning Tab"
  ],
  "criticalPatternsEstablished": [
    "✅ Filter Pattern: Multi-dimensional filters (status + category + search + sort)",
    "✅ Card Pattern: Avatar + content + badges + watermark (jersey #, date, etc)",
    "✅ List Pattern: Icon circle + title + metadata + badges",
    "✅ Empty States: Icon + title + description + optional CTA",
    "✅ Loading States: Skeleton grid/list matching final layout",
    "✅ Batch Fetch: Collect IDs → Promise.all(fetch) → Map lookup → enrich",
    "✅ Composite Indexes: Always use for multi-field queries",
    "✅ Pagination: Cursor-based with Load More button",
    "✅ Responsive Grid: 1→2→3→4 columns (mobile→tablet→desktop→XL)"
  ],
  "reusableComponents": {
    "filters": {
      "component": "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/player-filters.tsx",
      "pattern": "Tabs for primary filter + Search input + Dropdown filters + Sort dropdown",
      "usage": "Copy structure, rename to TaskFilters/InsightFilters, adjust filter options"
    },
    "cards": {
      "component": "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/player-card.tsx",
      "pattern": "Card with avatar + title + metadata + badges + hover effect + click navigation",
      "usage": "Copy layout for TaskCard and InsightCard, adjust content fields"
    },
    "lists": {
      "component": "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/session-plan-list.tsx",
      "pattern": "Card list with icon + title + timestamp + badges",
      "usage": "Copy for task lists and insight lists"
    },
    "emptyStates": {
      "component": "@/components/ui/empty",
      "pattern": "Empty + EmptyMedia + EmptyContent + EmptyTitle + EmptyDescription",
      "usage": "Use directly, just pass icon and text"
    },
    "pagination": {
      "component": "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/activity-feed-view.tsx",
      "pattern": "Cursor-based pagination with Load More button",
      "usage": "Copy pagination logic lines 60-90"
    }
  },
  "userStories": [
    {
      "id": "US-P9-057",
      "phase": 4,
      "title": "Tasks Tab - Team Task Management",
      "description": "Task list with create/assign/complete functionality. Build on Players Tab patterns.",
      "acceptanceCriteria": [
        "Backend: Create teamTasks table in schema",
        "Schema fields: _id, teamId, organizationId, title, description, assigneeId (userId), assigneeName, dueDate, priority (high/medium/low), status (open/in-progress/done), createdBy, createdAt, updatedAt, completedAt",
        "Backend: Add composite indexes: by_team_and_status, by_assignee_and_status",
        "Backend: Create getTeamTasks query in packages/backend/convex/models/teams.ts",
        "Query uses batch fetch pattern: (1) Get tasks by team, (2) Batch fetch assignees, (3) Map lookup, (4) Enrich tasks with assignee names",
        "Query returns: Array of tasks with all fields + assignee info",
        "Backend: Create mutations: createTask, updateTask, deleteTask, completeTask",
        "Frontend: Replace placeholder tasks-tab.tsx with full implementation",
        "REUSE: Copy filter pattern from player-filters.tsx",
        "Filter controls: Status tabs (All/Open/In Progress/Done), Priority dropdown (All/High/Medium/Low), Assignee dropdown (All + coach list), Sort (Due Date/Priority/Created Date)",
        "REUSE: Copy card layout from player-card.tsx",
        "Task card shows: Assignee avatar + initials fallback, Task title, Due date (relative time), Priority badge (destructive=high, default=medium, secondary=low), Status badge (open/in-progress/done), Overdue badge if past due date",
        "Task card watermark: Due date in large text on right (like jersey number)",
        "Task grid: 1 col mobile, 2 cols tablet, 3 cols desktop (use sm:grid-cols-2 lg:grid-cols-3)",
        "Click task card → Open task detail modal (show full description, assignee, actions)",
        "Create Task button: Top right of tab, opens modal with form (title, description, assignee select, due date picker, priority select)",
        "Task actions: Mark complete, Edit, Delete (from detail modal)",
        "Empty states: 'No tasks created' (with + Create Task CTA), 'No tasks match filters'",
        "Loading state: Skeleton grid (6 cards)",
        "Touch-friendly: Cards min 44px height, clear tap targets",
        "Type check passes: npm run check-types",
        "Visual verification with dev-browser (filters work, create task works, complete task works)"
      ],
      "priority": 1,
      "passes": false,
      "effort": "5h",
      "dependencies": [],
      "files": {
        "modify": [
          "packages/backend/convex/schema.ts",
          "packages/backend/convex/models/teams.ts",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/tasks-tab.tsx"
        ],
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/task-card.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/task-filters.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/task-detail-modal.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/create-task-modal.tsx"
        ]
      }
    },
    {
      "id": "US-P9-058",
      "phase": 4,
      "title": "Insights Tab - AI-Generated Team Insights",
      "description": "Display insights from voice notes and AI analysis. Build on Activity Feed patterns.",
      "acceptanceCriteria": [
        "Backend: Create teamInsights table in schema",
        "Schema fields: _id, teamId, organizationId, type (voice-note/ai-generated/manual), title, summary, fullText (optional), voiceNoteId (optional), playerIds (array), topic (technical/tactical/fitness/behavioral/other), priority (high/medium/low), createdBy, createdAt, readBy (array of userIds who viewed)",
        "Backend: Add composite indexes: by_team_and_type, by_voice_note, by_team_and_date",
        "Backend: Create getTeamInsights query in packages/backend/convex/models/teams.ts",
        "Query uses batch fetch pattern: (1) Get insights by team, (2) Batch fetch voice notes, (3) Batch fetch player identities, (4) Map lookups, (5) Enrich with player names and voice note metadata",
        "Query supports pagination: cursor-based (50 items/page) like activity feed",
        "Query returns: { page, continueCursor, isDone } or array (backward compatible)",
        "Backend: Create mutations: createInsight, markAsRead",
        "Backend: Create action: generateInsightsFromVoiceNotes (AI processing - placeholder for now, just create sample insights)",
        "Frontend: Replace placeholder insights-tab.tsx with full implementation",
        "REUSE: Copy pagination logic from activity-feed-view.tsx",
        "Filter controls: Type tabs (All/Voice Notes/AI Insights/Manual), Player dropdown (All + player list), Topic dropdown (All/Technical/Tactical/Fitness/Behavioral), Sort (Newest/Oldest/Priority)",
        "REUSE: Copy list card pattern from activity-feed-view.tsx",
        "Insight card shows: Creator avatar + initials, Type icon (Mic=voice note, Sparkles=AI, FileText=manual), Insight title (bold), Summary text (2-3 lines, truncated), Related player badges (if any), Topic badge, Priority badge (high only), Timestamp (relative time)",
        "Insight card click → Open detail modal (show full text, voice note link if applicable, mark as read)",
        "Generate Insights button: Top right, triggers AI action (show loading toast, refresh on complete)",
        "Load More button: Bottom of list when more insights available (like activity feed)",
        "Empty states: 'No insights yet' (with Generate Insights CTA), 'No insights match filters'",
        "Loading state: List skeleton (5 items)",
        "Mobile responsive: Stacked cards on mobile, same layout on desktop",
        "Type check passes: npm run check-types",
        "Visual verification with dev-browser (pagination works, filters work, detail modal works)"
      ],
      "priority": 2,
      "passes": false,
      "effort": "4h",
      "dependencies": [],
      "files": {
        "modify": [
          "packages/backend/convex/schema.ts",
          "packages/backend/convex/models/teams.ts",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/insights-tab.tsx"
        ],
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/insight-card.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/insight-filters.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/team-hub/components/insight-detail-modal.tsx",
          "packages/backend/convex/actions/teamInsights.ts"
        ]
      }
    }
  ],
  "phase4Checklist": [
    "✅ Phase 3 complete: Players Tab and Planning Tab working",
    "⬜ Start with US-P9-057 (Tasks Tab) - no dependencies",
    "⬜ Create teamTasks schema with indexes",
    "⬜ Create getTeamTasks query with batch fetch",
    "⬜ Create task mutations (create/update/delete/complete)",
    "⬜ Build Tasks Tab (copy player-tab.tsx structure)",
    "⬜ Build TaskCard component (copy player-card.tsx)",
    "⬜ Build TaskFilters component (copy player-filters.tsx)",
    "⬜ Build Create Task Modal (form with validation)",
    "⬜ Build Task Detail Modal (view/edit/delete/complete)",
    "⬜ Test task filtering and sorting",
    "⬜ Create teamInsights schema with indexes",
    "⬜ Create getTeamInsights query with pagination",
    "⬜ Create insight mutations and AI action",
    "⬜ Build Insights Tab (copy activity-feed-view.tsx structure)",
    "⬜ Build InsightCard component (copy activity card)",
    "⬜ Build InsightFilters component",
    "⬜ Build Insight Detail Modal",
    "⬜ Test insight pagination and filters",
    "⬜ Visual verification with dev-browser (all tabs)",
    "⬜ Type check passes",
    "⬜ Commit with message: 'feat: Phase 9 Week 4 Phase 4 - Tasks + Insights Tabs'"
  ],
  "successCriteria": {
    "phase4Complete": [
      "Tasks Tab shows team tasks in responsive grid",
      "Task filtering works (status, priority, assignee)",
      "Create task modal works (validation, assignee select, date picker)",
      "Complete task updates status and shows badge",
      "Task detail modal shows full info with edit/delete actions",
      "Insights Tab shows paginated insights",
      "Insight filtering works (type, player, topic)",
      "Load More pagination works",
      "Insight detail modal shows full text and voice note link",
      "Generate Insights button triggers AI action (placeholder)",
      "All tabs responsive on mobile/tablet/desktop",
      "Empty states and loading states present",
      "Type check passes",
      "0 new TypeScript errors introduced"
    ]
  },
  "mandatoryPatterns": [
    "ALWAYS use Better Auth IDs as v.string() not v.id()",
    "ALWAYS use composite indexes for multi-field queries (never .filter() after .withIndex())",
    "ALWAYS use batch fetch with Map lookup to avoid N+1 queries",
    "ALWAYS include args and returns validators on ALL queries/mutations",
    "ALWAYS use skeleton loaders (not spinners) for loading states",
    "ALWAYS provide empty states with icon + title + description",
    "ALWAYS use mobile-first responsive design (1→2→3→4 column grids)",
    "ALWAYS ensure touch targets ≥44px for mobile",
    "ALWAYS run npm run check-types before committing",
    "ALWAYS use dev-browser for visual verification of UI changes",
    "COPY existing component patterns from Phases 1-3 (don't reinvent)"
  ]
}

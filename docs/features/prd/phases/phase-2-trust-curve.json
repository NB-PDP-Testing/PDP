{
  "phase": 2,
  "name": "Trust Curve Foundation",
  "description": "Implement trust level tracking and progression system for coaches",
  "estimatedSprints": 1,
  "dependencies": ["phase-1-core-pipeline"],
  "featureFlag": "coach-trust-curve",

  "objectives": [
    "Track coach trust levels per organization",
    "Implement trust progression algorithm",
    "Provide coach visibility into their trust level",
    "Enable coach preference settings for maximum automation"
  ],

  "deliverables": {
    "backend": [
      {
        "id": "BE-2.1",
        "name": "coachTrustLevels schema",
        "type": "schema",
        "file": "packages/backend/convex/schema.ts",
        "description": "Store trust levels and activity metrics per coach",
        "fields": [
          "coachId (string)",
          "organizationId (string)",
          "currentLevel (number 0-3)",
          "preferredLevel (optional number)",
          "totalApprovals (number)",
          "totalSuppressed (number)",
          "totalEdits (number)",
          "consecutiveApprovals (number)",
          "lastActivityAt (number)",
          "levelHistory (array of level changes)",
          "createdAt, updatedAt"
        ],
        "indexes": ["by_coach_org"]
      },
      {
        "id": "BE-2.2",
        "name": "getOrCreateTrustLevel query/mutation",
        "type": "mutation",
        "file": "packages/backend/convex/models/coachTrustLevels.ts",
        "description": "Get trust level for coach, creating default if none exists",
        "inputs": ["coachId", "organizationId"],
        "outputs": ["trustLevel object"],
        "defaultLevel": 0
      },
      {
        "id": "BE-2.3",
        "name": "updateTrustMetrics mutation",
        "type": "mutation",
        "file": "packages/backend/convex/models/coachTrustLevels.ts",
        "description": "Update metrics after approval/suppression action",
        "inputs": [
          "coachId",
          "organizationId",
          "action (approved|suppressed|edited)"
        ],
        "outputs": ["updatedTrustLevel"],
        "sideEffects": [
          "Increment relevant counters",
          "Recalculate trust level",
          "Add to level history if level changed"
        ]
      },
      {
        "id": "BE-2.4",
        "name": "setCoachPreferredLevel mutation",
        "type": "mutation",
        "file": "packages/backend/convex/models/coachTrustLevels.ts",
        "description": "Allow coach to set their preferred maximum trust level",
        "inputs": ["coachId", "organizationId", "preferredLevel (0-3)"],
        "outputs": ["success"],
        "validation": "preferredLevel must be <= calculated eligible level"
      },
      {
        "id": "BE-2.5",
        "name": "Trust level calculation function",
        "type": "internal",
        "file": "packages/backend/convex/lib/trustLevelCalculator.ts",
        "description": "Pure function to calculate trust level from metrics",
        "algorithm": {
          "level0": "Default, < 10 approvals",
          "level1": "10+ approvals",
          "level2": "50+ approvals AND < 10% suppression rate",
          "level3": "200+ approvals AND coach opt-in"
        }
      },
      {
        "id": "BE-2.6",
        "name": "Hook into summary mutations",
        "type": "mutation-modification",
        "file": "packages/backend/convex/models/coachParentMessages.ts",
        "description": "Call updateTrustMetrics after approve/suppress",
        "changes": [
          "approveSummary calls updateTrustMetrics with action: approved",
          "suppressSummary calls updateTrustMetrics with action: suppressed"
        ]
      }
    ],

    "frontend": [
      {
        "id": "FE-2.1",
        "name": "TrustLevelIndicator component",
        "type": "component",
        "file": "apps/web/src/components/coach/trust-level-indicator.tsx",
        "description": "Visual indicator of coach's current trust level",
        "props": ["trustLevel", "metrics"],
        "displays": [
          "Current level name (New, Learning, Trusted, Expert)",
          "Progress bar to next level",
          "Key metrics (approvals, suppression rate)"
        ]
      },
      {
        "id": "FE-2.2",
        "name": "TrustPreferenceSettings component",
        "type": "component",
        "file": "apps/web/src/components/coach/trust-preference-settings.tsx",
        "description": "Allow coach to configure their trust preferences",
        "props": ["trustLevel", "onUpdate"],
        "features": [
          "Slider or radio buttons for preferred level",
          "Explanation of what each level means",
          "Confirmation dialog for level 3 (full automation)"
        ]
      },
      {
        "id": "FE-2.3",
        "name": "Voice notes dashboard integration",
        "type": "component-modification",
        "file": "apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx",
        "description": "Show trust level indicator in dashboard header",
        "changes": [
          "Add query for trust level",
          "Render TrustLevelIndicator in header",
          "Link to preferences settings"
        ]
      },
      {
        "id": "FE-2.4",
        "name": "Trust progression nudge",
        "type": "component",
        "file": "apps/web/src/components/coach/trust-nudge-banner.tsx",
        "description": "Periodic nudge when coach is close to next level",
        "props": ["trustLevel", "metrics"],
        "triggers": [
          "Level 0 coach with 8+ approvals",
          "Level 1 coach with 45+ approvals"
        ],
        "content": "Encouraging message about upcoming automation benefits"
      }
    ]
  },

  "acceptanceCriteria": [
    {
      "id": "AC-2.1",
      "description": "New coaches start at trust level 0",
      "testType": "unit"
    },
    {
      "id": "AC-2.2",
      "description": "Trust level increases to 1 after 10 approvals",
      "testType": "unit"
    },
    {
      "id": "AC-2.3",
      "description": "Trust level increases to 2 after 50 approvals with < 10% suppression",
      "testType": "unit"
    },
    {
      "id": "AC-2.4",
      "description": "Trust level 3 requires explicit coach opt-in",
      "testType": "unit"
    },
    {
      "id": "AC-2.5",
      "description": "Coach can see their current trust level in dashboard",
      "testType": "e2e"
    },
    {
      "id": "AC-2.6",
      "description": "Coach can set preferred maximum level",
      "testType": "e2e"
    },
    {
      "id": "AC-2.7",
      "description": "Nudge appears when coach is close to next level",
      "testType": "e2e"
    }
  ],

  "testCases": [
    {
      "id": "TC-2.1",
      "name": "Trust progression 0 to 1",
      "steps": [
        "New coach starts at level 0",
        "Coach approves 9 summaries",
        "Trust level still 0",
        "Coach approves 10th summary",
        "Trust level becomes 1",
        "Level history updated"
      ]
    },
    {
      "id": "TC-2.2",
      "name": "Suppression rate blocks progression",
      "steps": [
        "Coach at level 1 with 45 approvals, 8 suppressions",
        "Suppression rate = 8/53 = 15%",
        "Coach cannot progress to level 2",
        "Coach approves 10 more (55 approvals, 8 suppressions = 12.7%)",
        "Still cannot progress",
        "After 30 more approvals (85/93 = 8.6%), can progress"
      ]
    },
    {
      "id": "TC-2.3",
      "name": "Coach opts into level 3",
      "steps": [
        "Coach at level 2 with 200+ approvals",
        "Coach sees option to enable full automation",
        "Coach confirms opt-in",
        "Trust level becomes 3",
        "All future summaries auto-approve (tested in phase 5)"
      ]
    },
    {
      "id": "TC-2.4",
      "name": "Coach caps preferred level",
      "steps": [
        "Coach eligible for level 3",
        "Coach sets preferred level to 2",
        "System respects preference",
        "Coach still sees manual approval flow"
      ]
    }
  ],

  "metrics": {
    "tracking": [
      "coaches_by_trust_level (gauge per level)",
      "trust_level_progressions (count)",
      "time_to_level_1_days (histogram)",
      "time_to_level_2_days (histogram)",
      "coaches_opted_into_level_3 (count)"
    ]
  }
}

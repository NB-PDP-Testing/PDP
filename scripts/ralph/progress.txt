# Ralph Progress Log
Started: Sun 15 Feb 2026 23:15:16 GMT
---

## Codebase Patterns
**Last Updated**: 2026-02-15 23:30 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field
- Turborepo monorepo: `apps/web/` (Next.js 14), `packages/backend/` (Convex)

### Convex Backend Patterns
- NEVER use `.filter()` - always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names include all fields: `by_orgId_and_status`
- Actions cannot access `ctx.db` - use `ctx.runQuery`/`ctx.runMutation`
- Internal functions use `internalMutation` or `internalQuery`

### Cron Jobs (Convex)
- Use `crons.daily()`, `crons.hourly()`, `crons.interval()`, `crons.weekly()`
- Cron syntax: `{ hourUTC: 2, minuteUTC: 0 }` for daily jobs
- All cron jobs call internal functions via `internal.models.<file>.<function>`
- Existing crons run at: 12 AM (budget reset), 1 AM (usage aggregation), 2 AM (review status, trust thresholds), 3 AM (consent expiry, invitations), etc.

### Federation Connector System
- Connector credentials encrypted and stored in Convex file storage (`_storage`)
- Each connector has `connectedOrganizations[]` array with `lastSyncAt` timestamps
- Connector status: active, inactive, error (auto-disabled after 5 consecutive failures)
- Use `updateLastSyncTime` mutation to update lastSyncAt after sync
- Never return decrypted credentials in queries (only in actions)

### Quality Checks
- Run in order: `npm run check-types` → `npx ultracite fix` → `npm run check`
- Ultracite must run before linting or you'll get false failures
- Run `npx -w packages/backend convex codegen` after schema changes

### File Locations
- Cron jobs: `packages/backend/convex/crons.ts`
- Federation models: `packages/backend/convex/models/federationConnectors.ts`
- Federation actions: `packages/backend/convex/actions/gaaFoireann.ts`
- Schema: `packages/backend/convex/schema.ts`
- Import sessions: `packages/backend/convex/models/importSessions.ts`

---


## 2026-02-15 23:45 - US-P4.4-001 - Create cron scheduler for automated syncs
**Iteration**: 1
**Commit**: cb4b30f2e69d216a90edd7d3f79c5aa770fb19eb
**Session**: 28d554da-c69f-4334-9606-0515ca527995
**Status**: Complete

### What was implemented
- Created `packages/backend/convex/actions/federationScheduler.ts` with scheduledFederationSync internal action
- Added cron job to `packages/backend/convex/crons.ts` to run nightly at 2:15 AM UTC
- Implemented sync orchestration logic:
  - Queries all active connectors with `syncConfig.enabled = true`
  - For each connector, syncs all connected organizations
  - Rate limiting: 60-second delay between each organization sync to avoid overwhelming APIs
  - Tracks comprehensive stats: connectors processed, orgs synced, success/failure counts
- Integrated with existing GAA sync action (`api.actions.gaaFoireann.syncGAAMembers`)
- Updates connector health tracking (lastSyncAt timestamps, success/error recording)
- Comprehensive logging for monitoring and debugging

### Files changed
- packages/backend/convex/actions/federationScheduler.ts (+215 new file)
- packages/backend/convex/crons.ts (+8, -1)

### Quality checks
- ✅ Type check: passed (no new errors)
- ✅ Convex codegen: passed
- ✅ Linting: passed (fixed increment operators to use += instead of ++)
- ✅ Browser verification: N/A (backend-only change)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Convex cron jobs use `crons.daily()`, `crons.hourly()`, `crons.interval()`, `crons.weekly()`
- Cron syntax: `{ hourUTC: 2, minuteUTC: 15 }` for daily jobs at specific times
- All cron jobs must call internal functions via `internal.<path>.<function>`
- Existing crons run at various times: 12 AM (budget), 1 AM (usage), 2 AM (reviews), 3 AM (cleanup), etc.
- Chose 2:15 AM to spread load from other 2 AM jobs

**Gotchas encountered:**
- Biome linter rejects `++` and `--` operators - must use `+= 1` instead
- Pre-commit hook runs lint-staged which enforces this
- Import paths for internal functions: `internal.actions.federationScheduler` (note: "actions" not "models")

**Dependencies found:**
- scheduledFederationSync depends on:
  - `api.models.federationConnectors.listConnectors` (get active connectors)
  - `api.actions.gaaFoireann.syncGAAMembers` (perform sync for each org)
  - `api.models.federationConnectors.updateLastSyncTime` (update timestamps)
  - `api.models.federationConnectors.recordConnectorSuccess` (health tracking)
  - `api.models.federationConnectors.recordConnectorError` (error tracking)

**What to do next**:
- ✅ Story complete - all acceptance criteria met
- Next story: US-P4.4-002 (Implement change detection for federation data)

**Mistakes made** (learn from these!):
- Initially used `++` increment operators, caught by pre-commit hook
- Fixed by using `+= 1` syntax instead

---

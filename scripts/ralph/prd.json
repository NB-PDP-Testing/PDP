{
  "project": "Voice Enhance Gating-WAPP v2",
  "branchName": "feat/voice-gateways-v2",
  "description": "Phase 7C: Complete v2 → v1 Output Bridge. Confirmed v2 drafts produce identical downstream effects to v1 insights: parent summaries generated, autoAppliedInsights audit records created, voiceNotes.insights[] embedded array updated. Auto-confirm integration with trust levels verified. Quality gates added to in-app typed notes.",
  "issueReference": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/phases/PHASE7C_PRD.json",
    "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "docs/architecture/voice-notes-pipeline-v2.md"
  ],
  "previousPhases": [
    "Phase 1",
    "Phase 2",
    "Phase 2.5",
    "Phase 3",
    "Phase 4",
    "Phase 5",
    "Phase 6",
    "Phase 7A",
    "Phase 7B"
  ],
  "currentPhase": "Phase 7C - Complete v2 → v1 Output Bridge",
  "completedStories": [
    "US-VN-001",
    "US-VN-002",
    "US-VN-003",
    "US-VN-004",
    "US-VN-005",
    "US-VN-006",
    "US-VN-007",
    "US-VN-008",
    "US-VN-009",
    "US-VN-010",
    "US-VN-011",
    "US-VN-012",
    "US-VN-013",
    "US-VN-014",
    "US-VN-015",
    "US-VN-016",
    "US-VN-017",
    "US-VN-018",
    "US-VN-019",
    "US-VN-020",
    "US-VN-021",
    "US-VN-022",
    "US-VN-023",
    "US-VN-024",
    "US-VN-025",
    "US-VN-026",
    "US-VN-027"
  ],
  "criticalLearnings": {
    "description": "Lessons from Phases 1-7B that MUST be followed:",
    "patterns": [
      "ALL public queries/mutations MUST check ctx.auth.getUserIdentity() and verify artifact/data ownership",
      "NEVER accept caller-supplied userId params — derive from identity.subject",
      "Use .withIndex() for ALL queries — NEVER use .filter() on Convex query builder",
      "Use batch fetch + Map lookup to avoid N+1 queries",
      "Include args AND returns validators on ALL Convex functions",
      "Use v.optional(v.string()) NOT v.string() | null — Convex rejects null for optional fields",
      "Actions cannot access ctx.db — use ctx.runQuery/ctx.runMutation",
      "InternalActions should call internal mutations, NOT public mutations",
      "Score/confidence values must be bounds-checked (0-1 range)",
      "All indexes should be org-scoped (by_org_and_X) — avoid unbounded table scans",
      "ALWAYS add imports AND usage in the SAME edit — linter removes unused imports between edits",
      "Schema changes MUST be applied and codegen run BEFORE code changes that depend on them",
      "Batch mutations should verify organizationId for defense-in-depth (even when ownership checked)"
    ],
    "betterAuth": [
      "Use user._id (NOT user.id) for user ID",
      "Use user.name (NOT user.firstName/lastName) for display name",
      "Use identity.subject for the authenticated user's ID in Convex handlers"
    ],
    "frontend": [
      "Lift useQuery to parent components — pass data as props to children",
      "Do NOT put useQuery inside list item components or child tabs",
      "Use useMutation for confirm/reject — NOT useAction",
      "Use 'skip' pattern for conditional queries: useQuery(api.fn, condition ? args : 'skip')",
      "Use sonner toast for success/error notifications"
    ]
  },
  "existingInfrastructure": {
    "description": "Key tables, functions, and UI components that Phase 7C depends on:",
    "tables": [
      "insightDrafts — pending insights with confidence scoring, status (pending/confirmed/rejected/applied/expired)",
      "voiceNoteArtifacts — v2 pipeline source records (artifactId, senderUserId, orgContextCandidates, status)",
      "voiceNoteInsights — applied insights (v1 read model, v2 writes to this via applyDraft)",
      "voiceNotes — v1 pipeline main table, has insights[] embedded array",
      "autoAppliedInsights — audit trail for auto-applied insights",
      "coachParentSummaries — parent-visible summaries triggered by processVoiceNoteInsight",
      "coachOrgPreferences — coach org settings including parentSummariesEnabled",
      "coachTrustLevels — coach trust scoring for auto-confirm threshold"
    ],
    "keyFunctions": [
      "insightDrafts.ts: applyDraft (line 462) — internalMutation, EXTEND THIS: currently only creates voiceNoteInsights record",
      "coachParentSummaries.ts: processVoiceNoteInsight (line 586) — internalAction, 7 args, schedules parent summary pipeline",
      "draftGeneration.ts: generateDrafts (line 150+) — internalAction, creates drafts with auto-confirm logic",
      "draftGeneration.ts: requiresConfirmation (line 108) — checks sensitive types, trust level, confidence, auto-apply prefs",
      "voiceNotes.ts: createTypedNote (line 554) — PUBLIC mutation, ADD quality gate here",
      "lib/messageValidation.ts: validateTextMessage (line 30) — SYNC function, returns { isValid, suggestion }"
    ]
  },
  "criticalWarning": "READ scripts/ralph/prds/voice-gateways-v2/phases/PHASE7C_PRD.json FIRST — it contains verified function signatures, architect review corrections (C1: parentSummariesEnabled check, C2: appliedBy/appliedDate fields, C3: schema ordering), and step-by-step implementation instructions. The stories below are summaries.",
  "userStories": [
    {
      "id": "US-VN-026",
      "phase": "7C",
      "title": "applyDraft Output Bridge — Parent Summaries, Audit Trail & Backward Compat",
      "description": "Extend applyDraft to: (1) add back-link fields to voiceNoteInsights, (2) update voiceNotes.insights[] embedded array, (3) schedule processVoiceNoteInsight for parent summaries (with parentSummariesEnabled check), (4) create autoAppliedInsights audit records for auto-confirmed drafts.",
      "acceptanceCriteria": [
        "=== FULL DETAILS IN: scripts/ralph/prds/voice-gateways-v2/phases/PHASE7C_PRD.json ===",
        "",
        "EXECUTION ORDER (CRITICAL):",
        "1. Schema: Make autoAppliedInsights.playerId optional",
        "2. Schema: Add sourceArtifactId/sourceClaimId/sourceDraftId to voiceNoteInsights",
        "3. Run codegen: npx -w packages/backend convex codegen",
        "4. Code: Extend applyDraft with Steps 0-3B",
        "5. Type check: npm run check-types",
        "",
        "KEY ARCHITECT REVIEW CORRECTIONS:",
        "- C1: Check coachOrgPreferences.parentSummariesEnabled BEFORE scheduling processVoiceNoteInsight",
        "- C2: Include appliedBy + appliedDate in voiceNotes.insights[] push object",
        "- C3: Schema changes FIRST, codegen, then code",
        "- S1: Wrap autoAppliedInsights insert (Step 3B) in try/catch"
      ],
      "priority": 26,
      "passes": true,
      "effort": "2 days",
      "dependencies": ["US-VN-024"],
      "files": {
        "create": [],
        "modify": [
          "packages/backend/convex/schema.ts",
          "packages/backend/convex/models/insightDrafts.ts"
        ]
      }
    },
    {
      "id": "US-VN-027",
      "phase": "7C",
      "title": "Auto-Confirm Integration with Trust Levels & Quality Gates for In-App Notes",
      "description": "Verify draftGeneration auto-confirm logic is correct (all 4 checkpoints PASSED in architect review). Add validateTextMessage quality gate to createTypedNote.",
      "acceptanceCriteria": [
        "=== FULL DETAILS IN: scripts/ralph/prds/voice-gateways-v2/phases/PHASE7C_PRD.json ===",
        "",
        "1. VERIFY auto-confirm logic in draftGeneration.ts (already verified by architect — all 4 checkpoints pass)",
        "2. ADD validateTextMessage to createTypedNote in voiceNotes.ts:",
        "   - Import validateTextMessage from '../lib/messageValidation'",
        "   - Call BEFORE ctx.db.insert at line 566",
        "   - Import AND usage in SAME edit",
        "3. Type check: npm run check-types"
      ],
      "priority": 27,
      "passes": true,
      "effort": "1 day",
      "dependencies": ["US-VN-026"],
      "files": {
        "create": [],
        "modify": ["packages/backend/convex/models/voiceNotes.ts"]
      }
    }
  ],
  "successCriteria": {
    "backLinksPopulated": "voiceNoteInsights from v2 drafts have sourceArtifactId, sourceClaimId, sourceDraftId",
    "insightsArrayUpdated": "voiceNotes.insights[] updated when draft confirmed (with appliedBy + appliedDate)",
    "parentSummariesGenerated": "Confirmed drafts with playerIdentityId + parentSummariesEnabled trigger parent summaries",
    "parentSummariesRespectPrefs": "Coach who disabled parent summaries does NOT get them from v2 drafts",
    "auditTrailCreated": "Auto-confirmed drafts create autoAppliedInsights with autoAppliedByAI=true",
    "manualConfirmNoAudit": "Manually confirmed drafts do NOT create autoAppliedInsights",
    "qualityGateWorks": "Short/gibberish typed notes rejected before creation",
    "typeCheckPasses": "npm run check-types passes with 0 errors"
  },
  "architectureReview": {
    "status": "COMPLETED — 3 ADRs generated, 3 critical findings incorporated into Phase 7C PRD",
    "adrs": [
      "docs/architecture/decisions/ADR-VN2-040-parent-summary-enablement-check-in-applydraft.md",
      "docs/architecture/decisions/ADR-VN2-041-applydraft-mutation-complexity-and-failure-modes.md",
      "docs/architecture/decisions/ADR-VN2-042-validate-text-message-quality-gate-placement.md"
    ],
    "criticalFindings": [
      "C1: Added parentSummariesEnabled check (coachOrgPreferences.by_coach_org) to Step 2",
      "C2: Added appliedBy + appliedDate to voiceNotes.insights[] push object",
      "C3: Emphasized schema change ordering (3A FIRST, codegen, then code)"
    ],
    "autoConfirmVerification": "ALL 4 CHECKPOINTS PASS — no changes needed to draftGeneration.ts"
  },
  "ralphInstructions": {
    "executionMode": "sequential",
    "storyOrder": ["US-VN-026", "US-VN-027"],
    "contextToRead": [
      "scripts/ralph/prds/voice-gateways-v2/phases/PHASE7C_PRD.json — PRIMARY: full implementation details with architect review corrections",
      "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md — v1 vs v2 architecture overview",
      "packages/backend/convex/models/insightDrafts.ts — applyDraft function to extend",
      "packages/backend/convex/actions/coachParentSummaries.ts — processVoiceNoteInsight (7 args)",
      "packages/backend/convex/actions/draftGeneration.ts — auto-confirm logic (verify only)",
      "packages/backend/convex/models/voiceNotes.ts — createTypedNote to add quality gate",
      "packages/backend/convex/schema.ts — voiceNoteInsights, autoAppliedInsights, voiceNotes.insights[]"
    ],
    "beforeStarting": [
      "Read PHASE7C_PRD.json thoroughly — it has architect review corrections embedded",
      "Read applyDraft function (insightDrafts.ts:462-536) — understand what it already does",
      "Read processVoiceNoteInsight signature (coachParentSummaries.ts:586-636) — note 7 required args",
      "Read autoAppliedInsights schema (schema.ts:1663-1705) — note ALL required fields",
      "Read voiceNotes.insights[] embedded array schema (schema.ts:1525-1554) — note appliedBy/appliedDate",
      "Read coachOrgPreferences by_coach_org index (schema.ts:2590+) — needed for C1 fix"
    ],
    "implementationOrder": [
      "1. Schema: Make autoAppliedInsights.playerId optional",
      "2. Schema: Add 3 back-link fields to voiceNoteInsights",
      "3. Run codegen",
      "4. Code: Extend applyDraft (Steps 0, 1, 2, 3B)",
      "5. Type check",
      "6. Code: Add validateTextMessage to createTypedNote",
      "7. Type check"
    ],
    "testingStrategy": "Manual testing — confirm drafts via Drafts tab, verify parent summaries, check autoAppliedInsights in Convex dashboard",
    "qualityCriteria": "npm run check-types passes, npx -w packages/backend convex codegen succeeds"
  },
  "upcomingPhases": {
    "Phase7D": "Retire v1 Processing & Clean Up — remove dual processing, feature flag promotion, dead code removal"
  }
}

{
  "project": "Voice Flow Monitoring Harness - Phase M6-M9",
  "branchName": "ralph/voice-monitor-harness",
  "description": "Final frontend pages (Artifacts Grid, Metrics, Events, Pipeline, Alerts) and cleanup. Subsumes v2-claims functionality into unified monitoring interface. Completes all 8 dashboard pages.",
  "prdFile": "scripts/ralph/prds/voice-monitor-harness/phases/PHASE_M6_M7_M8_M9.json",
  "mainPRD": "scripts/ralph/prds/voice-monitor-harness/PRD.json",
  "contextFiles": [
    "scripts/ralph/prds/voice-monitor-harness/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-monitor-harness/context/PERFORMANCE_PATTERNS.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M1_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M2_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M3_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M4_LESSONS_LEARNED.md",
    "scripts/ralph/prds/voice-monitor-harness/context/M5_LESSONS_LEARNED.md",
    "docs/architecture/voice-flow-monitoring-harness.md",
    "docs/architecture/voice-notes-v2-technical-reference.md",
    "scripts/ralph/agents/output/feedback.md",
    "docs/architecture/decisions/ADR-VNM-021-cursor-based-pagination.md",
    "docs/architecture/decisions/ADR-VNM-022-css-chart-implementation.md",
    "docs/architecture/decisions/ADR-VNM-023-v2-claims-component-reuse.md",
    "CLAUDE.md"
  ],
  "mandatoryPatterns": [
    "READ ALL LESSONS LEARNED (M1-M5) BEFORE starting M6-M9",
    "READ architectural review feedback.md for implementation requirements",
    "READ ADR-VNM-021 through ADR-VNM-028 for architectural decisions",
    "Platform staff auth: ALL routes MUST verify isPlatformStaff",
    "Cursor-based pagination: MANDATORY use of usePaginatedQuery (NEVER .take())",
    "CSS-based charts ONLY: NO external charting libraries (reuse /platform/messaging pattern)",
    "v2-claims feature parity: VERIFY before deletion in M9",
    "Query lifting: Lift useQuery/usePaginatedQuery to page level, pass data as props",
    "Query skipping: Skip queries if user not platform staff (avoid errors)",
    "Loading states: Show shadcn/ui Skeleton components while loading",
    "Responsive design: Desktop (>= 1024px), Tablet (768-1023px), Mobile (< 768px), test at 375px minimum",
    "Component reuse: Extract shared configs from v2-claims BEFORE M6 implementation",
    "Real-time updates: Use Convex useQuery for live data",
    "ATOMIC IMPORTS: Add import + usage in SAME edit (linter removes unused)",
    "Better Auth: Use user._id (not user.id), user.name (not user.firstName)",
    "Mobile testing: Test at 375px width minimum (iPhone SE)",
    "Backend queries: Use NEW getPlatformArtifacts (not getRecentArtifacts)",
    "Run npx ultracite fix before completing any story",
    "Run npm run check-types after frontend changes"
  ],
  "successCriteria": [
    "All 8 monitoring pages accessible via tab navigation (Overview, Artifacts, Metrics, Events, Pipeline, Alerts, Settings placeholder)",
    "Artifacts grid page with filters, expandable rows, cursor-based pagination",
    "Artifact detail page with event timeline and claims section",
    "Metrics dashboard with time range selector and CSS-based charts (NO external libraries)",
    "Event log viewer with filters and cursor-based pagination",
    "Pipeline view with expanded flow graph and stage drill-down",
    "Alerts page with active alerts and acknowledge functionality",
    "v2-claims page deleted after verifying feature parity",
    "Platform staff authorization on ALL routes",
    "Query skip patterns implemented (isPlatformStaff check)",
    "All queries use cursor-based pagination (usePaginatedQuery)",
    "Loading states on all pages (skeleton loaders)",
    "Dashboard loads < 2 seconds (performance target)",
    "Mobile responsive design at 375px minimum",
    "Real-time updates work on all pages (< 10s lag)",
    "Type checks pass: npm run check-types",
    "E2E tests passing for all pages"
  ],
  "userStories": [
    {
      "id": "US-VNM-009",
      "phase": "M6",
      "title": "Build Artifacts Grid View",
      "description": "Create artifacts/page.tsx with filters, expandable rows, cursor-based pagination, and retry buttons. This page SUBSUMES v2-claims functionality. READ FULL DETAILS in phases/PHASE_M6_M7_M8_M9.json.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/voice-monitoring/artifacts/page.tsx",
        "Build filter bar (status, org, date range, source channel, artifactId search)",
        "Build table with columns: Artifact ID, Status, Source, Coach, Org, Claims, Disambig, Latency, Cost, Created, Actions",
        "CRITICAL: Use usePaginatedQuery for cursor-based pagination (MANDATORY)",
        "Implement expandable rows (click to show claims/resolutions/drafts inline)",
        "Migrate ClaimRow component from v2-claims (reuse, don't duplicate)",
        "Wire retry buttons (call voicePipelineRetry mutations)",
        "Extract shared configs (TOPIC_CONFIG, STATUS_CONFIG) from v2-claims first",
        "Query NEW getPlatformArtifacts backend query (not getRecentArtifacts)",
        "CRITICAL: v2-claims feature parity REQUIRED before deletion in M9",
        "Run: npm run check-types"
      ],
      "priority": 9,
      "effort": "3 days",
      "notes": "CRITICAL: Read PHASE_M6_M7_M8_M9.json for EXACT v2-claims feature parity checklist. This page replaces v2-claims. Read ADR-VNM-021 (pagination), ADR-VNM-023 (component reuse), ADR-VNM-026 (backend queries).",
      "passes": true
    },
    {
      "id": "US-VNM-010",
      "phase": "M6",
      "title": "Build Artifact Detail Page with Event Timeline",
      "description": "Create artifacts/[artifactId]/page.tsx with vertical event timeline, claims section, and retry panel. READ FULL DETAILS in phases/PHASE_M6_M7_M8_M9.json.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/voice-monitoring/artifacts/[artifactId]/page.tsx",
        "Build header (artifact ID, status badge, source, coach, org, timestamps)",
        "Build vertical event timeline (chronological, all events for artifact)",
        "Display event metadata (duration, confidence, counts, costs)",
        "Build claims section (reuse v2-claims components: ClaimRow, ResolutionCard)",
        "Build retry panel (available options based on failure state, retry history)",
        "Add breadcrumb navigation",
        "Run: npm run check-types"
      ],
      "priority": 10,
      "effort": "2 days",
      "notes": "CRITICAL: Read PHASE_M6_M7_M8_M9.json for timeline implementation. Read ADR-VNM-024 (event timeline pattern).",
      "passes": true
    },
    {
      "id": "US-VNM-011",
      "phase": "M7",
      "title": "Build Metrics Dashboard UI",
      "description": "Create metrics/page.tsx with time range selector, metric cards, and CSS-based charts. NO external charting libraries. READ FULL DETAILS in phases/PHASE_M6_M7_M8_M9.json.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/voice-monitoring/metrics/page.tsx",
        "Build time range selector (1h, 6h, 24h, 7d, 30d)",
        "Build 6 metric cards (Total Artifacts, Completion Rate, Avg Latency, Total Cost, Auto-Resolution Rate, Disambig Backlog)",
        "CRITICAL: Build CSS-based charts ONLY (NO external library - reuse /platform/messaging pattern):",
        "  - Throughput over time (bar chart using div widths)",
        "  - Latency by stage (stacked bar using nested divs)",
        "  - Error rate trend (line chart using CSS/SVG polyline)",
        "  - Cost trend (area chart using gradients)",
        "Build org breakdown table (per-org volume, latency, cost, error rate)",
        "Query getHistoricalMetrics with correct periodType (hourly < 7d, daily > 7d)",
        "Run: npm run check-types"
      ],
      "priority": 11,
      "effort": "3 days",
      "notes": "CRITICAL: Read PHASE_M6_M7_M8_M9.json for CSS chart examples. Read ADR-VNM-022 (CSS chart implementation). Reference apps/web/src/app/platform/messaging/* for existing patterns.",
      "passes": true
    },
    {
      "id": "US-VNM-012",
      "phase": "M7",
      "title": "Build Event Log Viewer UI",
      "description": "Create events/page.tsx with filters and structured log viewer. READ FULL DETAILS in phases/PHASE_M6_M7_M8_M9.json.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/voice-monitoring/events/page.tsx",
        "Build filter bar (event type multi-select, pipeline stage, org, date range, artifactId search, errors-only toggle)",
        "Build event table (Timestamp, Event, Stage, Artifact, Org, Duration, Details)",
        "Newest events at top (real-time updates via useQuery)",
        "Click event row to expand and show full event payload",
        "CRITICAL: Use usePaginatedQuery for cursor-based pagination (MANDATORY)",
        "Run: npm run check-types"
      ],
      "priority": 12,
      "effort": "2 days",
      "notes": "CRITICAL: Read PHASE_M6_M7_M8_M9.json for filter implementation. Read ADR-VNM-021 (pagination).",
      "passes": true
    },
    {
      "id": "US-VNM-013",
      "phase": "M8",
      "title": "Build Pipeline View UI",
      "description": "Create pipeline/page.tsx with expanded flow graph and stage drill-down. READ FULL DETAILS in phases/PHASE_M6_M7_M8_M9.json.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/voice-monitoring/pipeline/page.tsx",
        "Build expanded flow graph (larger version of dashboard graph)",
        "Implement stage drill-down (click stage → modal with artifacts at that stage)",
        "In drill-down modal: show latency distribution, error breakdown, retry queue",
        "Build active artifacts panel (cards for in-flight artifacts with progress)",
        "Show time elapsed per stage, coach/org info, source channel icon",
        "OPTIONAL: Add Sankey diagram (defer if time constrained)",
        "Run: npm run check-types"
      ],
      "priority": 13,
      "effort": "3 days",
      "notes": "CRITICAL: Read PHASE_M6_M7_M8_M9.json for drill-down modal implementation. Reuse PipelineFlowGraph component from M5.",
      "passes": true
    },
    {
      "id": "US-VNM-014",
      "phase": "M8",
      "title": "Build Alerts Management UI",
      "description": "Create alerts/page.tsx with active alerts panel and alert history table. READ FULL DETAILS in phases/PHASE_M6_M7_M8_M9.json.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/voice-monitoring/alerts/page.tsx",
        "Build active alerts panel (cards with severity badges, alert message, trigger details)",
        "Build acknowledge button (calls acknowledgeAlert mutation)",
        "Build alert history table with filters (severity, type, date range)",
        "Wire toast notifications for new alerts (real-time via useQuery)",
        "Use shadcn/ui Alert, Badge components",
        "Run: npm run check-types"
      ],
      "priority": 14,
      "effort": "2 days",
      "notes": "CRITICAL: Read PHASE_M6_M7_M8_M9.json for toast notification pattern. Read ADR-VNM-027 (alert toast pattern).",
      "passes": true
    },
    {
      "id": "US-VNM-015",
      "phase": "M9",
      "title": "Remove v2-Claims Page and Polish",
      "description": "Delete old v2-claims page after verifying feature parity, final optimizations. READ FULL DETAILS in phases/PHASE_M6_M7_M8_M9.json.",
      "acceptanceCriteria": [
        "VERIFY FIRST: All v2-claims functionality present in artifacts grid",
        "Delete apps/web/src/app/platform/v2-claims/ directory",
        "Update platform hub page.tsx (remove v2-claims link if not done in M5)",
        "Verify all 8 monitoring pages accessible via tab navigation",
        "Add skip patterns to ALL queries (isPlatformStaff check)",
        "Add loading states to all pages (skeleton loaders)",
        "Test cursor-based pagination (load more) on all paginated pages",
        "Performance audit: verify dashboard loads < 2 seconds",
        "Mobile responsive audit: test all pages at 375px width",
        "Run E2E tests for all pages",
        "Run: npm run check-types"
      ],
      "priority": 15,
      "effort": "2 days",
      "notes": "CRITICAL: Read PHASE_M6_M7_M8_M9.json for v2-claims feature parity verification checklist. Do NOT delete v2-claims until ALL features migrated.",
      "passes": true
    }
  ],
  "ralphGuidance": {
    "executionOrder": [
      "0. PREP (0.5-1 day):",
      "   a. Read ALL context files (MAIN_CONTEXT, PERFORMANCE_PATTERNS, M1-M5 lessons learned)",
      "   b. Read architectural review in feedback.md (implementation requirements)",
      "   c. Read ADRs ADR-VNM-021 through ADR-VNM-028",
      "   d. Create 5 new backend queries per ADR-VNM-026 (BLOCKING M6)",
      "   e. Modify getRecentEvents to use paginationOptsValidator",
      "   f. Extract shared configs from v2-claims per ADR-VNM-023",
      "",
      "1. M6 - Artifacts Grid & Detail (4-5 days):",
      "   a. US-VNM-009: Build artifacts grid (3 days)",
      "      - Build filter bar and table structure",
      "      - Use usePaginatedQuery (MANDATORY)",
      "      - Implement expandable rows with claims",
      "      - Migrate ClaimRow component from v2-claims",
      "      - Wire retry buttons",
      "      - Test v2-claims feature parity",
      "   b. US-VNM-010: Build artifact detail page (2 days)",
      "      - Build header and event timeline",
      "      - Add claims section",
      "      - Add retry panel",
      "",
      "2. M7 - Metrics & Events (3-4 days, parallel with M6):",
      "   a. US-VNM-011: Build metrics dashboard (3 days)",
      "      - Build time range selector and metric cards",
      "      - Build CSS-based charts (reference /platform/messaging)",
      "      - Build org breakdown table",
      "   b. US-VNM-012: Build event log viewer (2 days)",
      "      - Build filter bar and event table",
      "      - Use usePaginatedQuery (MANDATORY)",
      "      - Add event detail expansion",
      "",
      "3. M8 - Pipeline & Alerts (3-4 days, parallel with M7):",
      "   a. US-VNM-013: Build pipeline view (3 days)",
      "      - Reuse PipelineFlowGraph from M5",
      "      - Build stage drill-down modal",
      "      - Build active artifacts panel",
      "   b. US-VNM-014: Build alerts page (2 days)",
      "      - Build active alerts panel",
      "      - Build alert history table",
      "      - Wire toast notifications",
      "",
      "4. M9 - Cleanup & Polish (2-3 days):",
      "   a. US-VNM-015: Remove v2-claims and finalize",
      "      - Verify v2-claims feature parity (checklist)",
      "      - Delete v2-claims page",
      "      - Add skip patterns to all queries",
      "      - Performance audit (< 2s dashboard load)",
      "      - Mobile audit (375px minimum)",
      "      - Run E2E tests"
    ],
    "commonPitfalls": [
      "❌ Not reading architectural review feedback.md (contains ALL implementation requirements)",
      "❌ Not creating 5 new backend queries before M6 (BLOCKING)",
      "❌ Using .take() instead of usePaginatedQuery (pagination violation)",
      "❌ Using external charting library instead of CSS-based (violates ADR-VNM-022)",
      "❌ Deleting v2-claims before verifying feature parity (data loss risk)",
      "❌ Not extracting shared configs from v2-claims (code duplication)",
      "❌ Not adding skip patterns to queries (errors for non-staff users)",
      "❌ Not testing mobile responsive design (breaks at 375px)",
      "❌ Not adding loading states (poor UX)",
      "❌ Querying getRecentArtifacts instead of NEW getPlatformArtifacts"
    ],
    "successIndicators": [
      "✅ All 8 monitoring pages functional and accessible",
      "✅ Cursor-based pagination on all list views (usePaginatedQuery)",
      "✅ CSS-based charts render correctly (no external libraries)",
      "✅ v2-claims functionality fully migrated to artifacts grid",
      "✅ v2-claims page deleted",
      "✅ Platform staff auth enforced on all routes",
      "✅ Query skip patterns implemented",
      "✅ Dashboard loads < 2 seconds",
      "✅ Mobile responsive at 375px minimum",
      "✅ Real-time updates work (< 10s lag)",
      "✅ E2E tests passing",
      "✅ npm run check-types passes"
    ]
  },
  "testingStrategy": {
    "approach": "Playwright E2E tests for all pages + manual testing with dev-browser",
    "keyScenarios": [
      "Platform staff access → verify all 8 pages load",
      "Non-staff access → verify redirect on all pages",
      "Artifacts grid → verify filters, pagination, expandable rows work",
      "Artifact detail → verify event timeline and retry panel",
      "Metrics dashboard → verify charts render and time range selector works",
      "Event log → verify filters and pagination work",
      "Pipeline view → verify stage drill-down modal opens",
      "Alerts page → verify acknowledge button and toast notifications",
      "v2-claims deletion → verify no broken links or missing features",
      "Mobile viewport (375px) → verify all pages responsive",
      "Performance → verify dashboard loads < 2 seconds"
    ],
    "verificationTools": [
      "Playwright E2E tests (apps/web/uat/tests/)",
      "dev-browser tool for visual verification",
      "Chrome DevTools responsive mode (375px, 768px, 1024px)",
      "Performance profiling for dashboard load time"
    ],
    "detailedTestPlan": "See phases/PHASE_M6_M7_M8_M9.json for complete test scenarios per story"
  }
}

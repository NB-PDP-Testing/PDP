# Ralph Progress Log
Started: Sun 15 Feb 2026 21:29:25 GMT
---

## Codebase Patterns
**Last Updated**: Sun 15 Feb 2026 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field
- Federation connectors link to importTemplates via templateId

### Convex Backend Patterns
- NEVER use `.filter()` - always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names include all fields: `by_orgId_and_status`
- Actions can use `ctx.storage` and `ctx.runMutation/runQuery`
- Mutations have direct `ctx.db` access
- Actions run in "use node" runtime (can use Node.js APIs)

### Import System Patterns
- Import templates stored in `importTemplates` table
- Templates have `scope` (platform/organization) and `sportCode`
- Seed mutations should be idempotent - check for existing records
- Federation connectors link to templates via `templateId` field

### Encryption & Storage
- Federation credentials encrypted using `lib/federation/encryption.ts`
- OAuth credentials stored as encrypted blobs in `ctx.storage`
- Use `encryptCredentials()` to encrypt before storing
- Placeholder credentials allowed for seed data

### Federation API Client
- Use `createFederationApiClient(ctx, connectorId)` for all federation API calls
- Client handles authentication (OAuth/API Key/Basic), retries, and rate limiting
- Returns typed responses via `client.request<ResponseType>(endpoint)`
- Automatically refreshes OAuth tokens if expired

### Linting Rules
- Biome linter enforces `nursery/noIncrementDecrement` - use `page += 1` NOT `page++`
- Pre-commit hooks run biome check - must pass to commit
- Ultracite may fail but still apply fixes - check git status after running

### Quality Checks
- Run in order: `npx -w packages/backend convex codegen` → `npx ultracite fix` → `npm run check-types`
- Ultracite may fail but still apply fixes - check git diff to confirm
- Pre-existing type errors in migrations/ and admin pages are OK

### File Locations (discovered during work)
- Import template seeds: `packages/backend/convex/models/importTemplateSeeds.ts`
- Federation connector CRUD: `packages/backend/convex/models/federationConnectors.ts`
- Federation API client: `packages/backend/convex/lib/federation/apiClient.ts`
- Encryption utilities: `packages/backend/convex/lib/federation/encryption.ts`
- GAA Foireann actions: `packages/backend/convex/actions/gaaFoireann.ts`

---

## Sun 15 Feb 2026 21:45 - US-P4.2-001 - Create GAA Foireann connector configuration seed
**Iteration**: 1
**Commit**: 8cf4cb648dbe943d31264fa392bd187bcb1ea834
**Session**: 58f28692-5087-4431-ab96-e1dc7e836e5e
**Status**: Complete

### What was implemented
- Added `seedGAAConnector` action to `packages/backend/convex/models/importTemplateSeeds.ts`
- Creates GAA Foireann connector with encrypted placeholder OAuth credentials
- Links connector to existing GAA Foireann import template (auto-created if missing)
- Connector configuration:
  - name: "GAA Foireann"
  - federationCode: "gaa_foireann"
  - authType: oauth2
  - Endpoints:
    - membershipList: "https://api.foireann.ie/v2/clubs/{clubId}/members"
    - memberDetail: "https://api.foireann.ie/v2/members/{memberId}"
  - syncConfig.conflictStrategy: "federation_wins" (Foireann is source of truth)
  - status: inactive (until OAuth configured per organization)
- Implementation is idempotent - returns existing connector if already exists

### Files changed
- packages/backend/convex/models/importTemplateSeeds.ts (+113 lines)
  - Added seedGAAConnector action
  - Added findGAATemplate internal query
  - Added createGAAConnectorInternal internal mutation

### Quality checks
- ✅ Convex codegen: passed
- ✅ Type check: passed (pre-existing errors OK per MEMORY.md)
- ✅ Linting: passed (ultracite fix applied)
- ⚠️ Browser verification: N/A (backend-only change)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Actions can use `ctx.storage.store()` to save encrypted credentials as blobs
- Seed mutations should be actions (not mutations) when they need storage access
- Import templates must exist before creating connectors that link to them
- Use internal mutations for database operations from actions

**Gotchas encountered:**
- Initial attempt used placeholder string for `credentialsStorageId` - WRONG
- Must create actual encrypted blob in storage, even for placeholder credentials
- Actions cannot directly call mutations - must use `ctx.runMutation(internal.*)`
- Need to import encryption utilities dynamically in actions: `await import("../lib/federation/encryption")`

**Dependencies found:**
- GAA connector depends on GAA import template existing first
- Must call `seedDefaultTemplates` before creating connector
- Connector schema requires valid `credentialsStorageId` of type `Id<"_storage">`

**Mistakes made** (learn from these!):
- Initially tried to use `v.literal("placeholder")` for credentialsStorageId - type error
- Forgot that actions need to use `ctx.runMutation` for database writes
- Almost forgot to make seed idempotent - added existence check in mutation

---

## Sun 15 Feb 2026 22:15 - US-P4.2-002 - Implement GAA membership list fetcher action
**Iteration**: 1
**Commit**: 5027ea6e (feat: US-P4.2-002 - Implement GAA membership list fetcher action)
**Session**: 58f28692-5087-4431-ab96-e1dc7e836e5e
**Status**: Complete

### What was implemented
- Created `packages/backend/convex/actions/gaaFoireann.ts` with `fetchMembershipList` action
- Fetches complete membership list from GAA Foireann API with automatic pagination
- Handles 100 members per page, fetches all pages automatically
- Safety limit of 100 pages to prevent infinite loops
- Uses FederationApiClient for authenticated requests with retry/rate limiting
- Returns array of members with totalCount and fetchedAt timestamp

Member fields fetched:
- memberId, firstName, lastName, dateOfBirth
- email, phone, address (all optional)
- membershipNumber (XXX-XXXXX-XXX format)
- membershipStatus, joinDate

Error handling for specific HTTP status codes:
- 401: "Authentication failed: Invalid or expired credentials..."
- 404: "Club not found: The club ID X does not exist..."
- 429: "Rate limit exceeded: Too many requests..."
- 500: "GAA Foireann API server error: The Foireann service is experiencing issues..."

Logging:
- Logs sync start with connector ID, org ID, club ID, timestamp
- Logs each page fetch with member count
- Logs sync success/failure with duration and total member count
- All logs prefixed with `[GAA Foireann]`

### Files changed
- packages/backend/convex/actions/gaaFoireann.ts (new file, +223 lines)
  - Added GAAMember and MembershipListResponse TypeScript types
  - Added fetchMembershipList action with pagination logic

### Quality checks
- ✅ Convex codegen: passed
- ✅ Type check: passed
- ✅ Linting: passed (fixed page++ → page += 1 for noIncrementDecrement rule)
- ⚠️ Browser verification: N/A (backend-only action)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Federation API client handles all auth, retries, rate limiting automatically
- Use `createFederationApiClient(ctx, connectorId)` in actions
- Client auto-loads connector config and decrypts credentials
- Pagination pattern: loop while `hasMore` is true, increment `page += 1`
- Safety checks needed to prevent infinite loops (max 100 pages)

**Gotchas encountered:**
- Biome linter rejects `page++` - must use `page += 1`
- Pre-commit hook runs biome check - commit fails if linting errors exist
- API client throws FederationApiError with status codes - check error.message.toLowerCase()
- Must find organization's `federationOrgId` from connector.connectedOrganizations array

**Dependencies found:**
- Requires connector to be in "active" status (FederationApiClient checks this)
- Organization must be in connector.connectedOrganizations array
- Connector must have valid encrypted credentials stored

**Mistakes made** (learn from these!):
- First commit failed due to `page++` linting error
- Initial error handling only threw generic errors - enhanced with specific status code messages

---

## Sun 15 Feb 2026 22:30 - US-P4.2-003 - Implement GAA member detail fetcher action
**Iteration**: 1
**Commit**: 777684fe (feat: US-P4.2-003 - Implement GAA member detail fetcher action)
**Session**: 58f28692-5087-4431-ab96-e1dc7e836e5e
**Status**: Complete

### What was implemented
- Added `fetchMemberDetail` action to `packages/backend/convex/actions/gaaFoireann.ts`
- Fetches detailed member profile from GAA Foireann API
- Endpoint: `/members/{memberId}`
- Returns GAAMemberDetail with all base member fields PLUS:
  - emergencyContactName, emergencyContactPhone
  - medicalConditions, allergies
  - playerPositions (array of position names, e.g., ["Full Forward", "Midfielder"])
  - teams (array with teamId, teamName, ageGroup)

Error handling:
- 404: "Member not found: The member ID X does not exist..."
- 403: "Access denied: You do not have permission to view details for member X..."
- 401: "Authentication failed: Invalid or expired credentials..."

Logging:
- Logs fetch start with member ID and timestamp
- Logs success with fetch duration
- Logs failure with error details
- All logs prefixed with `[GAA Foireann]`

### Files changed
- packages/backend/convex/actions/gaaFoireann.ts (+151 lines)
  - Added GAAMemberDetail interface (extends GAAMember)
  - Added MemberDetailResponse interface
  - Added fetchMemberDetail action

### Quality checks
- ✅ Convex codegen: passed
- ✅ Type check: passed
- ✅ Linting: passed
- ⚠️ Browser verification: N/A (backend-only action)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Member detail endpoint provides richer data than membership list
- Use for initial import or when syncing specific members
- TypeScript interfaces can extend base interfaces for detail types
- Single member fetch doesn't need pagination logic

**Gotchas encountered:**
- Member detail endpoint has additional error case: 403 Forbidden (no access to member)
- Must handle this separately from 401 (auth failed) and 404 (not found)

**What to do next**:
- [ ] Implement US-P4.2-004: Create GAA field mapping transformer
- [ ] Will create `packages/backend/convex/lib/federation/gaaMapper.ts`
- [ ] Transform GAA field names/formats to match PlayerARC schema
- [ ] Handle address parsing (GAA uses single-line addresses)
- [ ] Validate membership numbers (XXX-XXXXX-XXX format)
- [ ] Phone normalization (add +353 if missing country code)

---
## Sun 15 Feb 2026 22:52 - US-P4.2-004 - Create GAA field mapping transformer
**Iteration**: 1
**Commit**: c85f49a632e82208d502ca4033a31ce91be465f8
**Session**: b2ee1cce-0789-408c-a3de-b60c1f7b1b24
**Status**: Complete

### What was implemented
- Created `packages/backend/convex/lib/federation/gaaMapper.ts` with comprehensive field mapping
- Implemented `transformGAAMember()` function to convert GAA member data to PlayerARC import schema
- Implemented `transformGAAMembers()` bulk transform function
- Field mappings with validation:
  - Name fields: trim and titlecase (John Doe format)
  - Email: lowercase, validate format
  - Phone: normalize to +353 format (Irish country code)
  - Address: parse single-line GAA format into street1, city, county, postcode
  - Date fields: validate ISO YYYY-MM-DD format
  - Membership number: validate XXX-XXXXX-XXX format
  - Status: map Active/Current/Registered → active, others → inactive
- Validation system:
  - `errors` array for critical issues (missing required fields, invalid dates)
  - `warnings` array for non-fatal issues (invalid email/phone, malformed membership number)
- External ID mapping: stores GAA membership number in `externalIds.foireann` for deduplication
- Country auto-set to "Ireland" for all GAA members

### Files changed
- packages/backend/convex/lib/federation/gaaMapper.ts (+397 lines, new file)
  - GAAMember interface (re-declared to avoid circular deps)
  - ImportRowData interface (matching PlayerARC import schema)
  - Helper functions: toTitleCase, validateEmail, normalizePhone, parseAddress
  - Validation functions: validateMembershipNumber, validateISODate
  - Main transformers: transformGAAMember, transformGAAMembers

### Quality checks
- ✅ Convex codegen: passed
- ✅ Type check: passed (pre-existing admin errors OK)
- ✅ Linting: passed (fixed block statement and top-level regex issues)
- ⚠️ Browser verification: N/A (backend-only library)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Import system expects data with fields matching DEFAULT_TARGET_FIELDS from mapper.ts
- Validation should distinguish between errors (block import) and warnings (log but continue)
- GAA addresses use comma-separated format: "Street, Town, County, Postcode"
- Phone normalization must handle multiple formats: 087, (01), +353 87, etc.

**Gotchas encountered:**
- Biome linter requires block statements for single-line if returns: `if (!x) return;` → `if (!x) { return; }`
- Biome requires regex literals to be top-level constants (not declared in functions)
- Must use `return;` (not `return undefined;`) for consistent style
- Pre-commit hooks run biome with --diagnostic-level=error (catches more than ultracite)

**Dependencies found:**
- Import row data structure matches fields from lib/import/mapper.ts
- Errors/warnings arrays expected by import session tracking
- externalIds field used for deduplication (next story US-P4.2-006)

**What to do next**:
- [ ] Implement US-P4.2-005: GAA sync orchestrator action
- [ ] Will tie together fetchMembershipList, transformGAAMembers, and import pipeline
- [ ] Create import session, handle duplicates, update stats

**Mistakes made** (learn from these!):
- Initially used inline regex in functions - had to move to top-level constants
- First attempt didn't use block statements for early returns - biome rejected
- Forgot about playerCounty field (Ireland-specific) - added to address parsing

---

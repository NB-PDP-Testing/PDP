{
  "phaseNumber": "7B",
  "phaseName": "Draft Confirmation UI",
  "duration": "3-4 days",
  "storyCount": 2,
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/V2_MIGRATION_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "docs/architecture/voice-notes-pipeline-v2.md"
  ],
  "previousPhases": [
    "Phase 1",
    "Phase 2",
    "Phase 2.5",
    "Phase 3",
    "Phase 4",
    "Phase 5",
    "Phase 6",
    "Phase 7A"
  ],
  "currentPhase": "Phase 7B - Draft Confirmation UI",
  "goal": "Coaches can see and confirm/reject pending v2 insight drafts directly in the voice notes dashboard. Wire the existing disambiguation UI into the main workflow. Badge count, batch operations, and auto-switch to Drafts tab.",

  "referencePatterns": {
    "existingTabPattern": "apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx — STUDY: TabId type (line 63-70), tabs builder (lines 409-479), tab content rendering (lines 741-789), auto-switch logic (lines 167-177)",
    "existingInsightsTab": "apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx — REFERENCE for card styling, shadcn/ui patterns, mobile-responsive layout",
    "existingDisambiguationBanner": "apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/disambiguation-banner.tsx — ALREADY EXISTS (60 lines), queries getDisambiguationQueue, does NOT filter by sourceChannel (good)"
  },

  "verifiedFunctionSignatures": {
    "getPendingDraftsForCoach": {
      "location": "packages/backend/convex/models/insightDrafts.ts:139-166",
      "type": "query (PUBLIC)",
      "args": "{ organizationId: v.string() }",
      "returns": "v.array(draftObjectValidator)",
      "notes": "Requires auth. Queries by_org_and_coach_and_status index. Filters out expired drafts (older than 7 days). Coach ID from auth identity."
    },
    "confirmDraft": {
      "location": "packages/backend/convex/models/insightDrafts.ts:170-221",
      "type": "mutation (PUBLIC)",
      "args": "{ draftId: v.string() }",
      "returns": "v.null()",
      "notes": "Status guard: only pending drafts. Verifies ownership via artifact.senderUserId. Schedules applyDraft."
    },
    "rejectDraft": {
      "location": "packages/backend/convex/models/insightDrafts.ts:275-320",
      "type": "mutation (PUBLIC)",
      "args": "{ draftId: v.string() }",
      "returns": "v.null()",
      "notes": "Status guard: only pending drafts."
    },
    "confirmAllDrafts": {
      "location": "packages/backend/convex/models/insightDrafts.ts:225-272",
      "type": "mutation (PUBLIC)",
      "args": "{ artifactId: v.id('voiceNoteArtifacts') }",
      "returns": "v.null()",
      "notes": "Confirms all pending drafts for an artifact. Schedules applyDraft for each."
    },
    "rejectAllDrafts": {
      "location": "packages/backend/convex/models/insightDrafts.ts:322-369",
      "type": "mutation (PUBLIC)",
      "args": "{ artifactId: v.id('voiceNoteArtifacts') }",
      "returns": "v.null()",
      "notes": "Rejects all pending drafts for an artifact."
    },
    "getDisambiguationQueue": {
      "location": "packages/backend/convex/models/voiceNoteEntityResolutions.ts",
      "type": "query (PUBLIC)",
      "args": "{ organizationId: v.string(), limit?: v.optional(v.number()) }",
      "returns": "array of needs_disambiguation resolutions",
      "notes": "Used by disambiguation-banner.tsx. Does NOT filter by sourceChannel."
    }
  },

  "verifiedDashboardLocations": {
    "tabIdType": "voice-notes-dashboard.tsx:63-70 — type TabId = 'new' | 'parents' | 'insights' | 'team' | 'auto-sent' | 'history' | 'my-impact'",
    "hasAutoSwitchedState": "voice-notes-dashboard.tsx:88 — const [hasAutoSwitched, setHasAutoSwitched] = useState(false)",
    "existingQueries": "voice-notes-dashboard.tsx:95-106 — getVoiceNotesByCoach (line 95), getCoachPendingSummaries (line 103). NO existing drafts query.",
    "autoSwitchLogic": "voice-notes-dashboard.tsx:167-177 — useEffect checks pendingSummariesCount then pendingInsightsCount. Priority: parents > insights. No drafts check yet.",
    "tabsBuilder": "voice-notes-dashboard.tsx:409-479 — useMemo building tabs array. Order: new, parents (conditional), insights (conditional), team (conditional), auto-sent (conditional), history, my-impact.",
    "disambiguationBannerImport": "voice-notes-dashboard.tsx:53 — import { DisambiguationBanner }",
    "disambiguationBannerRender": "voice-notes-dashboard.tsx:595 — <DisambiguationBanner orgId={orgId} />",
    "tabContentRendering": "voice-notes-dashboard.tsx:741-789 — Conditional rendering blocks: new(743), parents(750), insights(757), team(764), auto-sent(771), history(778), my-impact(786)"
  },

  "stories": [
    {
      "id": "US-VN-024",
      "phase": "7B",
      "title": "Drafts Tab in Voice Notes Dashboard",
      "description": "Add a new 'Drafts' tab to the voice notes dashboard that shows pending v2 insight drafts. Each draft shows title, description, resolved player name, confidence score, and evidence transcript snippet. Coaches can confirm or reject individual drafts. The tab shows a count badge when drafts are pending.",
      "acceptanceCriteria": [
        "=== MODIFY: voice-notes-dashboard.tsx — TabId type (line 63-70) ===",
        "Add 'drafts' to TabId union type:",
        "  type TabId = 'new' | 'parents' | 'insights' | 'drafts' | 'team' | 'auto-sent' | 'history' | 'my-impact';",
        "Note: 'drafts' is positioned between 'insights' and 'team' in the union.",
        "",
        "=== MODIFY: voice-notes-dashboard.tsx — Add pendingDrafts query ===",
        "Near the existing queries (lines 95-106), add:",
        "  const pendingDrafts = useQuery(",
        "    api.models.insightDrafts.getPendingDraftsForCoach,",
        "    coachId ? { organizationId: orgId } : 'skip'",
        "  );",
        "",
        "Import: Add api.models.insightDrafts to the Convex API imports at top of file.",
        "CRITICAL: Add the import AND the useQuery call in the SAME edit.",
        "",
        "=== MODIFY: voice-notes-dashboard.tsx — Tabs builder (lines 409-479) ===",
        "In the tabs useMemo array, add 'Drafts' tab AFTER insights (around line 438) and BEFORE team:",
        "  {",
        "    id: 'drafts' as TabId,",
        "    label: 'Drafts',",
        "    icon: FileCheck,  // from lucide-react",
        "    badge: (pendingDrafts?.length ?? 0) > 0 ? pendingDrafts.length : undefined,",
        "  },",
        "",
        "Import FileCheck from lucide-react alongside existing icon imports.",
        "Badge shows count of pending drafts (only when > 0).",
        "Tab should ALWAYS show (not conditional) — empty state handles no-drafts case.",
        "",
        "=== MODIFY: voice-notes-dashboard.tsx — Tab content rendering (after line 764, before team) ===",
        "Add case for 'drafts' tab between insights and team rendering blocks:",
        "  {activeTab === 'drafts' && (",
        "    <DraftsTab orgId={orgId} pendingDrafts={pendingDrafts || []} />",
        "  )}",
        "",
        "Import DraftsTab from './components/drafts-tab'.",
        "CRITICAL: Add import + usage in SAME edit.",
        "",
        "=== CREATE: components/drafts-tab.tsx ===",
        "New component file: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/drafts-tab.tsx",
        "",
        "Props interface:",
        "  interface DraftsTabProps {",
        "    orgId: string;",
        "    pendingDrafts: Array<{",
        "      _id: Id<'insightDrafts'>;",
        "      draftId: string;",
        "      artifactId: Id<'voiceNoteArtifacts'>;",
        "      title: string;",
        "      description: string;",
        "      insightType: string;",
        "      resolvedPlayerName?: string;",
        "      playerIdentityId?: Id<'playerIdentities'>;",
        "      overallConfidence: number;",
        "      aiConfidence: number;",
        "      resolutionConfidence: number;",
        "      evidence: { transcriptSnippet: string; timestampStart?: number };",
        "      requiresConfirmation: boolean;",
        "      status: string;",
        "      createdAt: number;",
        "    }>;",
        "  }",
        "",
        "FEATURES:",
        "  1. Group drafts by artifactId (show source note context per group)",
        "     - Use: const grouped = Map<artifactId, draft[]>",
        "     - Each group represents drafts from a single voice note",
        "",
        "  2. Each draft card shows:",
        "     - Title (bold, text-base font)",
        "     - Description (truncated to 2 lines, expandable via Collapsible)",
        "     - Resolved player name badge (if resolvedPlayerName exists)",
        "     - Insight type badge with category colors:",
        "       injury=red, wellbeing=amber, skill_rating=blue, attendance=purple,",
        "       behavior=orange, performance=green, development_milestone=teal, note=gray",
        "     - Confidence score bar: overallConfidence as percentage",
        "       Red if < 0.6, amber if 0.6-0.8, green if > 0.8",
        "       Display as: '87% confidence' with colored progress bar",
        "     - Evidence transcript snippet (collapsed by default, click to expand)",
        "       Show evidence.transcriptSnippet in italic blockquote-style element",
        "",
        "  3. Actions per draft:",
        "     - 'Confirm' button (green variant) → calls useMutation(api.models.insightDrafts.confirmDraft)({ draftId: draft.draftId })",
        "     - 'Reject' button (red outline variant) → calls useMutation(api.models.insightDrafts.rejectDraft)({ draftId: draft.draftId })",
        "     - Loading state on buttons during mutation (disable both while one is pending)",
        "     - Toast on success: sonner toast('Insight confirmed') / toast('Draft rejected')",
        "     - Toast on error: toast.error('Failed to confirm insight')",
        "",
        "  4. Loading state: show skeleton cards while pendingDrafts is undefined",
        "",
        "  5. Empty state: centered icon + message",
        "     - FileCheck icon (muted)",
        "     - 'No pending drafts'",
        "     - 'New insights will appear here after processing voice notes.'",
        "",
        "STYLING:",
        "  - shadcn/ui: Card, CardHeader, CardContent, Badge, Button, Collapsible, CollapsibleTrigger, CollapsibleContent, Progress",
        "  - Consistent with existing InsightsTab card styling (study insights-tab.tsx for reference)",
        "  - Mobile-responsive: single column, cards stack vertically",
        "  - Touch-friendly: buttons min height 44px, adequate spacing",
        "  - Use Tailwind gap-4 between cards, p-4 padding",
        "",
        "=== VERIFY ===",
        "Type check: npm run check-types",
        "Build: npm run build",
        "Dashboard loads without errors",
        "Drafts tab appears in tab bar with FileCheck icon",
        "Badge shows pending count when drafts exist",
        "Badge hidden when no drafts (0 or undefined)",
        "Confirm → draft disappears from list + success toast",
        "Reject → draft disappears from list + success toast",
        "Empty state shown when no pending drafts",
        "Evidence snippet expands/collapses on click"
      ],
      "priority": 24,
      "passes": false,
      "effort": "2 days",
      "effortBreakdown": {
        "dashboard_wiring": "2h (TabId, query, tabs builder, content rendering, imports)",
        "drafts_tab_component": "6h (card layout, grouping, actions, confidence display, evidence)",
        "styling_responsive": "2h (shadcn components, mobile-responsive, consistent with InsightsTab)",
        "testing": "2h (manual testing of confirm/reject flows, empty state, badge)"
      },
      "dependencies": ["US-VN-022", "US-VN-023"],
      "files": {
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/drafts-tab.tsx"
        ],
        "modify": [
          "apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx (TabId, query, tabs, content, imports)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": [
          "Navigate to voice notes dashboard → see 'Drafts' tab in tab bar between Insights and Team",
          "Create a note with v2 ON → wait for processing → see draft(s) appear in Drafts tab",
          "Click 'Confirm' on a draft → draft disappears, toast shows success",
          "Click 'Reject' on a draft → draft disappears, toast shows success",
          "When no drafts: empty state with FileCheck icon and message displayed",
          "When drafts exist: badge count shown on Drafts tab header",
          "Expand evidence snippet → italic transcript quote shown",
          "Confidence bar: green for 0.85+, amber for 0.65, red for 0.4"
        ]
      }
    },
    {
      "id": "US-VN-025",
      "phase": "7B",
      "title": "Draft Batch Operations & Disambiguation Banner Wiring",
      "description": "Add batch confirm/reject operations to the Drafts tab (Confirm All, Reject All per artifact group). Wire the existing DisambiguationBanner component to work with in-app artifacts. Add auto-switch to Drafts tab when pending drafts exist.",
      "acceptanceCriteria": [
        "=== MODIFY: components/drafts-tab.tsx — Batch operations per artifact group ===",
        "Each artifact group header gets batch action buttons:",
        "",
        "  1. Group header shows:",
        "     - Source note date (format: 'Feb 8, 2026') from draft.createdAt",
        "     - Source type badge: derive from artifactId context if available, or show 'Voice Note'",
        "     - Count: 'N pending insights' (e.g., '3 pending insights')",
        "     - Right-aligned: batch action buttons",
        "",
        "  2. 'Confirm All (N)' button (green) → calls useMutation(api.models.insightDrafts.confirmAllDrafts)({ artifactId })",
        "     - artifactId is the v.id('voiceNoteArtifacts') Convex ID from the draft",
        "     - Show count in button text",
        "     - Loading state during mutation",
        "     - Toast: 'Confirmed N insights'",
        "",
        "  3. 'Reject All (N)' button (red outline) → shows confirmation dialog FIRST:",
        "     - Dialog: 'Are you sure you want to reject all N drafts from this note?'",
        "     - Cancel / 'Reject All' buttons in dialog",
        "     - If confirmed: calls useMutation(api.models.insightDrafts.rejectAllDrafts)({ artifactId })",
        "     - Toast: 'Rejected N insights'",
        "     - Use shadcn AlertDialog for the confirmation",
        "",
        "  4. Loading state: both batch buttons disabled while either mutation is pending",
        "",
        "=== VERIFY: disambiguation-banner.tsx — Works with in-app artifacts ===",
        "The DisambiguationBanner is ALREADY imported (line 53) and rendered (line 595) in voice-notes-dashboard.tsx.",
        "It queries getDisambiguationQueue internally with { organizationId: orgId, limit: 50 }.",
        "",
        "VERIFIED: disambiguation-banner.tsx does NOT filter by sourceChannel.",
        "It shows all needs_disambiguation resolutions for the org, regardless of source.",
        "After Phase 7A creates artifacts for in-app notes, disambiguation items will",
        "appear automatically when entity resolution finds ambiguous matches.",
        "",
        "ACTION: Verify the banner still renders correctly after Phase 7A changes.",
        "  - If it shows: no changes needed (most likely)",
        "  - If it doesn't show: check that getDisambiguationQueue returns results for in-app artifacts",
        "",
        "=== MODIFY: voice-notes-dashboard.tsx — Auto-switch to Drafts tab ===",
        "The existing auto-switch logic is at lines 167-177:",
        "  useEffect(() => {",
        "    if (!hasAutoSwitched) {",
        "      if (pendingSummariesCount > 0) {",
        "        setActiveTab('parents');",
        "        setHasAutoSwitched(true);",
        "      } else if (pendingInsightsCount > 0) {",
        "        setActiveTab('insights');",
        "        setHasAutoSwitched(true);",
        "      }",
        "    }",
        "  }, [pendingSummariesCount, pendingInsightsCount, hasAutoSwitched]);",
        "",
        "Modify to add drafts check with HIGHER priority than insights but LOWER than parents:",
        "  useEffect(() => {",
        "    if (!hasAutoSwitched) {",
        "      if (pendingSummariesCount > 0) {",
        "        setActiveTab('parents');",
        "        setHasAutoSwitched(true);",
        "      } else if ((pendingDrafts?.length ?? 0) > 0) {",
        "        setActiveTab('drafts');",
        "        setHasAutoSwitched(true);",
        "      } else if (pendingInsightsCount > 0) {",
        "        setActiveTab('insights');",
        "        setHasAutoSwitched(true);",
        "      }",
        "    }",
        "  }, [pendingSummariesCount, pendingDrafts, pendingInsightsCount, hasAutoSwitched]);",
        "",
        "Priority order: parents (most urgent) > drafts (needs review) > insights",
        "Add pendingDrafts to the dependency array.",
        "",
        "=== VERIFY ===",
        "Type check: npm run check-types",
        "Build: npm run build",
        "'Confirm All (3)' on artifact group → all 3 drafts confirmed + toast 'Confirmed 3 insights'",
        "'Reject All (3)' → confirmation dialog → confirm → all rejected + toast",
        "DisambiguationBanner appears when in-app note has ambiguous entity resolution",
        "Clicking disambiguation banner → navigates to /coach/voice-notes/disambiguation/[artifactId]",
        "Load dashboard with pending drafts → auto-switches to Drafts tab",
        "Load dashboard with pending parent summaries → auto-switches to Parents tab (higher priority)",
        "After all drafts processed: Drafts tab shows empty state, badge disappears"
      ],
      "priority": 25,
      "passes": false,
      "effort": "1.5 days",
      "effortBreakdown": {
        "batch_operations": "3h (Confirm All, Reject All with AlertDialog confirmation)",
        "artifact_group_header": "2h (date, type badge, count, layout)",
        "disambiguation_verify": "1h (verify banner works with in-app artifacts, fix if needed)",
        "auto_switch_drafts": "1h (add drafts to auto-switch priority chain)",
        "testing": "2h (batch operations, banner, auto-switch, edge cases)"
      },
      "dependencies": ["US-VN-024"],
      "files": {
        "create": [],
        "modify": [
          "apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/drafts-tab.tsx (batch operations, artifact group headers)",
          "apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx (auto-switch logic)",
          "apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/disambiguation-banner.tsx (verify/fix if needed)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": [
          "Create 3 notes with v2 ON → see grouped drafts per artifact → 'Confirm All (N)' confirms all in group",
          "Create note with ambiguous player name → disambiguation banner appears → click → disambiguation page",
          "Load dashboard with pending drafts → auto-switches to Drafts tab",
          "Load dashboard with pending parent summaries AND drafts → auto-switches to Parents (higher priority)",
          "Reject All → confirmation AlertDialog → confirm → all rejected + toast",
          "After all drafts processed: empty state, badge gone, auto-switch doesn't trigger"
        ]
      }
    }
  ],

  "mandatoryPatterns": [
    "Lift useQuery to parent (voice-notes-dashboard.tsx) — pass data as props to DraftsTab",
    "Do NOT put useQuery inside DraftsTab or inside individual draft card components",
    "Use useMutation for confirm/reject actions — NOT useAction",
    "Use shadcn/ui components consistently with existing InsightsTab styling",
    "Import + usage in SAME edit to prevent linter removal",
    "Mobile-responsive: single column on mobile, touch-friendly buttons (min 44px height)",
    "Use sonner toast for success/error notifications",
    "AlertDialog for destructive Reject All confirmation"
  ],

  "ralphInstructions": {
    "executionMode": "sequential",
    "storyOrder": ["US-VN-024", "US-VN-025"],
    "beforeStarting": [
      "Study voice-notes-dashboard.tsx structure: TabId (line 63), queries (line 95+), tabs builder (line 409+), tab content (line 741+), auto-switch (line 167+)",
      "Study insights-tab.tsx for card styling patterns and shadcn component usage",
      "Read insightDrafts.ts for all available mutations: confirmDraft, rejectDraft, confirmAllDrafts, rejectAllDrafts"
    ],
    "testingStrategy": "Manual testing — create notes with v2 ON, wait for processing, test confirm/reject in Drafts tab",
    "qualityCriteria": "npm run check-types passes, npm run build succeeds, all manual test cases pass"
  },

  "successCriteria": {
    "draftsTabVisible": "Drafts tab appears in dashboard tab bar between Insights and Team",
    "draftsBadgeWorks": "Badge shows pending count when > 0, hidden when 0",
    "confirmRejectWorks": "Individual confirm/reject removes draft from list with toast notification",
    "batchOperationsWork": "Confirm All / Reject All operate on all drafts within an artifact group",
    "rejectAllHasDialog": "Reject All shows confirmation dialog before executing",
    "disambiguationBannerWorks": "Banner appears for in-app notes with ambiguous entity resolutions",
    "autoSwitchWorks": "Dashboard auto-switches to Drafts tab when pending drafts exist (lower priority than Parents)",
    "emptyStateShown": "When no pending drafts, empty state with icon and message displayed"
  }
}

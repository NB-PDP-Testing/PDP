# UAT Test: US-VN-021 - v1-to-v2 Migration Script

> Auto-generated: 2026-02-07 19:10
> Status: ⏳ Pending Execution

## Story
Create migration action to backfill historical v1 voice notes into v2 artifacts, transcripts, and claims. Supports dry-run mode and batch processing. Optional — only run when ready to fully transition to v2 pipeline.

## Acceptance Criteria Checklist

- [ ] --- MIGRATION ACTION ---
- [ ] Backend: Create actions/migration.ts
- [ ] Function: migrateVoiceNotesToV2 (internalAction)
- [ ] args: { organizationId: v.optional(v.string()), dryRun: v.boolean(), batchSize: v.optional(v.number()) }
- [ ] returns: v.object({ processed: v.number(), artifacts: v.number(), transcripts: v.number(), claims: v.number(), errors: v.number(), skipped: v.number() })
- [ ] Logic:
- [ ] 1. Query voiceNotes with status='completed' (optionally filter by org)
- [ ] 2. Skip voiceNotes that already have a linked artifact (check voiceNoteArtifacts.by_voiceNoteId)
- [ ] 3. Process in batches of batchSize (default 50, max 200 — ADR-VN2-027 Convex timeout constraints)
- [ ] 4. For each voiceNote:
- [ ] a. Generate artifactId (crypto.randomUUID())
- [ ] b. Determine sourceChannel from voiceNote.source field
- [ ] c. If dryRun=false: create artifact, link to voiceNote
- [ ] d. If transcript exists: create voiceNoteTranscript (fullText from voiceNote.transcript, no segments)
- [ ] e. If insights exist: best-effort create claims (map insight categories to claim topics)
- [ ] f. Log progress every 50 records
- [ ] 5. Return summary with counts
- [ ] --- CONVEX DASHBOARD TRIGGER ---
- [ ] The migration can be triggered from Convex dashboard (Run Action) or via a scheduled job.
- [ ] No external script needed — runs as a Convex internalAction.
- [ ] --- ERROR HANDLING ---
- [ ] - Log errors per voiceNote but continue processing remaining
- [ ] - Include voiceNote ID in error logs for debugging
- [ ] - Return error count in summary
- [ ] --- VERIFICATION ---
- [ ] Type check passes: npm run check-types
- [ ] Build passes: npm run build
- [ ] Manual test: Run with dryRun=true on test org → verify counts without writing
- [ ] Manual test: Run with dryRun=false on 10 test voice notes → verify artifacts, transcripts created
- [ ] Manual test: Run again on same data → skips already-migrated notes

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VN-021"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

# Ralph Progress - Phase 9 Week 4 Team Hub

**Branch**: ralph/p9-week4-team-hub
**Started**: 2026-02-01
**Current Phase**: Phase 4 (Tasks + Insights + Tone Controls + Navigation)

---

## âœ… Phases 1-3 Complete (7 stories, 17h)

### Phase 1: Foundation (3 stories, 4h) - COMPLETE
- âœ… **US-P9-063**: Tab Navigation (2h) - 7 tabs with URL persistence
- âœ… **US-P9-SCHEMA**: Schema updates (0.5h) - Added sessionPlanId to voiceNotes
- âœ… **US-P9-056**: Activity Feed Pagination (1.5h) - Cursor-based with Load More

### Phase 2: Core Widgets (2 stories, 7h) - COMPLETE
- âœ… **US-P9-055**: Health & Safety Widget (3h) - Injury tracking with severity badges
- âœ… **US-P9-052**: Overview Dashboard (4h) - Quick Stats Panel with 4 cards

### Phase 3: Tab Views (2 stories, 6h) - COMPLETE
- âœ… **US-P9-053**: Players Tab (3h) - Player cards with health badges + filters
- âœ… **US-P9-054**: Planning Tab (3h) - Session plans + season milestones

**Total Completed**: 7 stories, 17 hours
**All commits**: Merged to ralph/p9-week4-team-hub branch
**Quality**: All type checks passing, no lint errors, mobile responsive

---

## ðŸ“‹ Phase 4: Ready to Execute (4 stories, 13h)

### Stories:
1. **US-P9-057**: Tasks Tab (5.5h)
2. **US-P9-058**: Insights Tab (5h)
3. **US-P9-NAV**: Navigation Integration (0.5h)
4. **US-P9-041**: Tone Controls for Parent Summaries (2h)

### Key Requirements:

#### US-P9-057: Tasks Tab
- âš ï¸ **CRITICAL**: Use EXISTING coachTasks table (schema line 925) - DON'T create teamTasks
- Add ONE field: `status: v.optional(v.union('open', 'in-progress', 'done'))`
- Activity Feed integration (extend enums: task_created, task_completed, task_assigned)
- Overview Dashboard integration (add openTasks, overdueCount stats)
- Voice Notes linking (voiceNoteId field already exists!)
- Copy patterns from player-tab.tsx (filters, cards, modals)
- Update Quick Stats Panel: "Attendance %" â†’ "Open Tasks"

#### US-P9-058: Insights Tab
- Create teamInsights table with composite indexes
- Activity Feed integration (extend enums: insight_generated)
- Overview Dashboard integration (add unreadInsights, highPriorityInsights stats)
- Voice Notes linking (add voiceNoteId field to teamInsights)
- Pagination: cursor-based, 50 items/page (copy activity-feed-view.tsx pattern)
- Update Quick Stats Panel: "Upcoming Events" â†’ "Unread Insights"
- Optional: Add insights badge to voice notes tab

#### US-P9-NAV: Navigation Integration
- Sidebar: Add Team Hub to Development group (after Team Insights)
- Bottom Nav: 5 items - Overview, Players, Voice (highlighted), Hub, Tasks
- Voice item: `highlight: true` (center-right position, coach's key feature)

#### US-P9-041: Tone Controls
- Extend coachOrgPreferences: `parentSummaryTone: v.optional(v.union('warm', 'professional', 'brief'))`
- Frontend: Tone dropdown + live preview card
- Preview examples:
  - Warm: "Great news! Emma's tackling skills have really improved..."
  - Professional: "Emma's tackling rating has improved from 3/5 to 4/5..."
  - Brief: "Emma: Tackling 3/5 â†’ 4/5. Good progress."

---

## ðŸŽ¯ Critical Patterns (MUST FOLLOW)

### 1. Existing Schema Reuse
- **coachTasks table exists** (schema.ts:925) with 8 fields already perfect:
  - `text` (use as title)
  - `assignedToUserId`, `assignedToName`
  - `teamId`, `organizationId`
  - `priority` (low/medium/high)
  - `dueDate`, `completed`
  - `voiceNoteId` âœ… ALREADY EXISTS!
  - `playerIdentityId` âœ… ALREADY EXISTS!
- **Only add 1 field**: `status` for open/in-progress/done
- **Use existing index**: `by_team_and_org`

### 2. Activity Feed Integration
```typescript
// After task/insight mutations, create activity entry:
await ctx.db.insert('teamActivityFeed', {
  organizationId,
  teamId,
  actorId,
  actorName,
  actionType: 'task_created', // or task_completed, insight_generated
  entityType: 'task', // or team_insight
  entityId: taskId,
  summary: `Created task: ${title}`,
  priority: taskPriority === 'high' ? 'important' : 'normal'
})
```

### 3. Batch Fetch Pattern (Avoid N+1 Queries)
```typescript
// ALWAYS use this pattern:
// 1. Collect unique IDs
const userIds = [...new Set(tasks.map(t => t.assignedToUserId))];

// 2. Batch fetch
const users = await Promise.all(userIds.map(id => adapter.findOne({ model: "user", where: { field: "_id", value: id } })));

// 3. Create Map
const userMap = new Map();
users.forEach(u => u && userMap.set(u.id, u));

// 4. Enrich (no await in loop!)
const enriched = tasks.map(t => ({
  ...t,
  assigneeName: userMap.get(t.assignedToUserId)?.name
}));
```

### 4. Composite Indexes (Never .filter() After .withIndex())
```typescript
// âœ… GOOD:
const tasks = await ctx.db
  .query("coachTasks")
  .withIndex("by_team_and_org", q =>
    q.eq("teamId", teamId).eq("organizationId", orgId)
  )
  .collect();

// âŒ BAD:
const tasks = await ctx.db
  .query("coachTasks")
  .withIndex("by_team_and_org", q => q.eq("teamId", teamId))
  .filter(q => q.eq(q.field("organizationId"), orgId)) // NO!
  .collect();
```

### 5. Component Reuse
- **Filters**: Copy `player-filters.tsx` â†’ rename to `task-filters.tsx`
- **Cards**: Copy `player-card.tsx` â†’ rename to `task-card.tsx`
- **Modals**: Copy create/detail modal patterns from players tab
- **Empty states**: Use `Empty` component from ui
- **Loading states**: Use skeleton grids (6 cards)

---

## ðŸ“Š Integration Points

### Activity Feed (4 new event types)
Extend `teamActivityFeed` schema enums:
- `actionType`: Add `task_created`, `task_completed`, `task_assigned`, `insight_generated`
- `entityType`: Add `task`, `team_insight`

### Overview Dashboard (4 new stats)
Enhance `getTeamOverviewStats` query return type:
- `openTasks: v.number()` - Count tasks where status !== 'done'
- `overdueCount: v.number()` - Count tasks where dueDate < now
- `unreadInsights: v.number()` - Count insights where !readBy.includes(userId)
- `highPriorityInsights: v.number()` - Count insights where priority === 'high'

Update UI in `quick-stats-panel.tsx`:
- Replace "Attendance %" â†’ "Open Tasks" (shows overdue badge)
- Replace "Upcoming Events" â†’ "Unread Insights" (shows priority badge)

### Voice Notes (Bidirectional Linking)
- Tasks â†’ Voice Notes: Show microphone badge if `voiceNoteId` exists
- Insights â†’ Voice Notes: Show microphone badge if `voiceNoteId` exists
- Voice Notes â†’ Insights: Optional badge showing insight count

### Navigation
- **Sidebar**: Development group â†’ Team Hub (icon: LayoutDashboard)
- **Bottom Nav**: 5 items total, Voice highlighted in center-right

---

## ðŸ—‚ï¸ Files Reference

### Core Config
- `/scripts/ralph/prd.json` - Main config (points to PHASE4_PRD.json)
- `/scripts/ralph/PHASE4_PRD.json` - Full PRD with all acceptance criteria
- `/scripts/ralph/PHASE4_CONTEXT.md` - Implementation patterns and code examples
- `/scripts/ralph/PHASE4_FINAL_RECOMMENDATIONS.md` - Key decisions documented

### Schema
- `packages/backend/convex/schema.ts` - Line 925: coachTasks table

### Existing Components to Reuse
- `apps/web/src/app/orgs/[orgId]/coach/team-hub/components/player-tab.tsx` - Filter + grid pattern
- `apps/web/src/app/orgs/[orgId]/coach/team-hub/components/player-card.tsx` - Card layout
- `apps/web/src/app/orgs/[orgId]/coach/team-hub/components/player-filters.tsx` - Filter pattern
- `apps/web/src/app/orgs/[orgId]/coach/team-hub/components/activity-feed-view.tsx` - Pagination pattern
- `apps/web/src/app/orgs/[orgId]/coach/team-hub/components/quick-stats-panel.tsx` - Stats cards

---

## ðŸ“ Phase 4 Checklist

### US-P9-057: Tasks Tab
- [ ] Schema: Add `status` field to EXISTING coachTasks table
- [ ] Schema: Extend teamActivityFeed enums (task events)
- [ ] Backend: Create getTeamTasks query (use by_team_and_org index)
- [ ] Backend: Create task mutations (create, update, delete, updateStatus)
- [ ] Backend: Add activity feed entries in mutations
- [ ] Backend: Enhance getTeamOverviewStats (openTasks, overdueCount)
- [ ] Frontend: Build tasks-tab.tsx (copy player-tab structure)
- [ ] Frontend: Build task-card.tsx (show voice note badge if linked)
- [ ] Frontend: Build task-filters.tsx (status, priority, assignee, sort)
- [ ] Frontend: Build create-task-modal.tsx
- [ ] Frontend: Build task-detail-modal.tsx (with voice note link)
- [ ] Frontend: Update quick-stats-panel.tsx (replace "Attendance %" â†’ "Open Tasks")
- [ ] Test: Filtering, voice note linking, activity feed events

### US-P9-058: Insights Tab
- [ ] Schema: Create teamInsights table with indexes
- [ ] Schema: Extend teamActivityFeed enums (insight events)
- [ ] Backend: Create getTeamInsights query with pagination
- [ ] Backend: Create insight mutations (create, markAsRead)
- [ ] Backend: Create generateInsightsFromVoiceNotes action (placeholder)
- [ ] Backend: Add activity feed entries in mutations
- [ ] Backend: Enhance getTeamOverviewStats (unreadInsights, highPriorityInsights)
- [ ] Frontend: Build insights-tab.tsx (with cursor pagination)
- [ ] Frontend: Build insight-card.tsx (show voice note badge if linked)
- [ ] Frontend: Build insight-filters.tsx
- [ ] Frontend: Build insight-detail-modal.tsx
- [ ] Frontend: Update quick-stats-panel.tsx (replace "Upcoming Events" â†’ "Unread Insights")
- [ ] Optional: Add insights badge to voice notes tab
- [ ] Test: Pagination, filters, voice note linking, activity feed events

### US-P9-NAV: Navigation
- [ ] Update coach-sidebar.tsx (add Team Hub to Development group)
- [ ] Update layout.tsx (add bottom nav with 5 items, Voice highlighted)
- [ ] Test: Navigation accessible, Voice highlighted on mobile

### US-P9-041: Tone Controls
- [ ] Schema: Extend coachOrgPreferences (parentSummaryTone field)
- [ ] Backend: Create getCoachPreferences query
- [ ] Backend: Create updateCoachPreferences mutation
- [ ] Frontend: Build parent-comms-settings.tsx
- [ ] Frontend: Tone dropdown (Warm, Professional, Brief)
- [ ] Frontend: Live preview card with example summaries
- [ ] Frontend: Wire to Team Hub Settings OR Coach Settings page
- [ ] Test: Tone selection updates preview, save persists

### Final Verification
- [ ] Type check passes (npm run check-types)
- [ ] No new lint errors
- [ ] Mobile responsive (all tabs)
- [ ] Empty states and loading states present
- [ ] Visual verification with dev-browser
- [ ] Activity Feed shows task/insight events
- [ ] Overview Dashboard shows task/insight counts
- [ ] Commit: "feat: Phase 9 Week 4 Phase 4 - Tasks + Insights + Tone Controls with Full Integration"

---

## ðŸš€ Ready to Execute

**All prerequisites met:**
- âœ… Phases 1-3 complete (7 stories, 17h)
- âœ… PRD complete with comprehensive acceptance criteria (30KB)
- âœ… Context file with patterns and examples (44KB)
- âœ… Table name resolved (use coachTasks not teamTasks)
- âœ… Integration patterns documented
- âœ… Effort estimate realistic (13h)

**Start with**: US-P9-057 (Tasks Tab)

---

**Detailed iteration logs archived**: `/scripts/ralph/archive/progress-full-phases-1-3-detailed-20260202.txt`

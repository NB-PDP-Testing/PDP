{
  "project": "P8 Week 3 - Navigation & Polish",
  "branchName": "ralph/coach-impact-visibility-p8-week3",
  "description": "Complete bi-directional navigation between My Impact dashboard and Player Passports. Add 'View in Passport' links on insight cards, source badges on skill/injury records in passport, deep linking with scroll + highlight animation, parent engagement analytics (least engaged parents, trends chart), CSV export, previous period comparisons, and loading skeleton.",
  "readinessLevel": "100% - Ready to Start",
  "urgency": "HIGH - Weeks 1, 1.5, 2 complete, Week 3 is final P8 polish",
  "prerequisitesCompleted": {
    "status": "✅ ALL PREREQUISITES COMPLETE - Jan 28, 2026",
    "completedWork": [
      "✅ Week 1 Complete (Jan 27, 2026):",
      "  - US-P8-001: getCoachImpactSummary backend query",
      "  - US-P8-003: my-impact-tab.tsx skeleton",
      "  - US-P8-004: My Impact tab navigation",
      "",
      "✅ Week 1.5 Complete (Jan 28, 2026):",
      "  - Trust gate system with 8-priority access logic",
      "  - Coach self-service toggle, admin controls",
      "  - Platform staff feature flags UI",
      "",
      "✅ Week 2 Complete (Jan 28, 2026):",
      "  - US-P8-005: Impact summary cards (4 metrics)",
      "  - US-P8-006: Sent summaries section with parent engagement",
      "  - US-P8-007: Applied insights section (grouped by category)",
      "  - US-P8-008: Date range filtering",
      "  - US-P8-009: Team observations section",
      "  - US-P8-010: Search in applied insights",
      "  - US-P8-011: Category filters",
      "",
      "✅ PR #374 Created:",
      "  - Contains all Weeks 1, 1.5, 2 work",
      "  - Ready to merge (pending testing)",
      "  - All quality checks passing"
    ],
    "documentationReferences": [
      "scripts/ralph/P8_WEEK3_READY_TO_RUN.md - Complete Week 3 implementation guide (17 pages)",
      "scripts/ralph/prds/Coaches Voice Insights/p8-week3-navigation-polish.prd.json - Week 3 PRD",
      "scripts/ralph/prds/Coaches Voice Insights/P8_COACH_IMPACT_VISIBILITY.md - Main PRD (Week 3 section: lines 836-1236)",
      "scripts/ralph/P8_WEEK3_SUMMARY.md - Executive summary",
      "scripts/ralph/P8_WEEK2_RALPH_CONTEXT.md - Critical learnings from Week 2"
    ]
  },
  "contextAndDependencies": {
    "criticalContext": [
      "⚠️ SCHEMA CHECK REQUIRED: Before implementing US-P8-013/014, verify skillAssessments and playerInjuries tables have 'source' and 'voiceNoteId' fields. If missing, add to schema first.",
      "BACKEND + FRONTEND: Extend getCoachImpactSummary query with parentEngagement, weeklyTrends, previousPeriodStats",
      "NAVIGATION: Implement bi-directional linking (insights ↔ passport ↔ voice notes)",
      "DEEP LINKING: Handle ?noteId=X query param, auto-scroll, highlight animation",
      "ANALYTICS: Calculate parent engagement metrics (bottom 5 least engaged)",
      "EXPORT: CSV generation with proper comma escaping"
    ],
    "criticalLearningsFromWeek2": {
      "TypeSafety": "CRITICAL - Always use Id<'tableName'> types, not string. Import from @pdp/backend/convex/_generated/dataModel. Ralph used 'string' in Week 2 which caused type errors.",
      "InterfaceVsType": "CRITICAL - Use 'type' not 'interface'. Biome linting rule enforces this. Ralph used 'interface' which failed lint.",
      "MatchBackendTypes": "CRITICAL - Read backend query return validator FIRST. Don't guess field names. Ralph used 'appliedAt' but backend returned 'recordedAt' for injuries.",
      "BetterAuthIntegration": "CRITICAL - Do NOT query organization/team/member/user/invitation tables directly. Better Auth manages these tables with internal logic. Direct queries bypass that logic and cause sync issues. MUST use ctx.runQuery(components.betterAuth.adapter.findMany, {...}) for these tables. APPLICATION tables (voiceNotes, coachParentSummaries, skillAssessments, playerInjuries, etc.) use regular Convex queries.",
      "BetterAuthTablesList": "Tables that require Better Auth adapter: user, organization, member, team, invitation. ALL other application tables use regular Convex queries (ctx.db.query).",
      "RechartsAvailable": "Recharts library already in project. No installation needed. Import LineChart, ResponsiveContainer, etc.",
      "CSVExport": "Escape commas: description.replace(/,/g, ';'). Prevents CSV corruption.",
      "ResponsiveDesign": "Always wrap LineChart in ResponsiveContainer. Grid: grid-cols-1 md:grid-cols-2 lg:grid-cols-4"
    },
    "requiredTables": [
      "✅ voiceNotes - Already used by getCoachImpactSummary",
      "✅ voiceNoteInsights - Already used",
      "✅ coachParentSummaries - Already used (extend for parent engagement)",
      "✅ autoAppliedInsights - Already used",
      "✅ playerInjuries - Check for source/voiceNoteId fields ⚠️",
      "✅ skillAssessments - Check for source/voiceNoteId fields ⚠️"
    ],
    "keyFiles": [
      "Backend: packages/backend/convex/models/voiceNotes.ts - EXTEND getCoachImpactSummary",
      "Backend: packages/backend/convex/schema.ts - CHECK skillAssessments/playerInjuries schema",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/applied-insights-section.tsx - ADD 'View in Passport' links",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/my-impact-tab.tsx - ADD parent engagement, trends, export",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/impact-summary-cards.tsx - ADD comparison indicators",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/voice-notes-dashboard.tsx - HANDLE ?noteId param",
      "Frontend: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/history-tab.tsx - ADD scroll + highlight",
      "Frontend: apps/web/src/app/orgs/[orgId]/players/[playerId]/components/skill-assessment-display.tsx - ADD source badge",
      "Frontend: apps/web/src/app/orgs/[orgId]/players/[playerId]/components/injury-record-display.tsx - ADD source badge"
    ],
    "criticalPatterns": {
      "TypeImports": "import type { Id } from '@pdp/backend/convex/_generated/dataModel';",
      "DeepLinking": "useSearchParams() to read ?noteId, useEffect to scroll + highlight, setTimeout for cleanup",
      "ResponsiveChart": "<ResponsiveContainer width='100%' height={300}><LineChart data={...}>",
      "CSVExport": "Blob + URL.createObjectURL + link.download, escape commas in data",
      "SourceBadge": "Only show if source === 'voice_note' AND voiceNoteId exists",
      "LoadingSkeleton": "if (data === undefined) return <Skeleton ... />; else render content"
    }
  },
  "userStories": [
    {
      "id": "US-P8-012",
      "title": "Add 'View in Passport' Links to Insight Cards",
      "description": "Every insight card in Applied Insights section gets a clickable link that navigates to the player's passport with correct tab (Skills/Health/Attendance).",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "HIGH",
      "estimatedTime": "0.5 hours",
      "acceptanceCriteria": [
        "Modify applied-insights-section.tsx",
        "Add Link component to each insight card",
        "Link text: 'View in [PlayerName]'s Passport →'",
        "Deep link to correct tab: ?tab=skills for skills, ?tab=health for injuries, ?tab=attendance",
        "Opens in same tab (not new window)",
        "Type check passes"
      ],
      "passes": true
    },
    {
      "id": "US-P8-013",
      "title": "Add Source Badge to Skill Assessments in Passport",
      "description": "When viewing skills in player passport, show 'From voice note (date)' badge with mic icon for auto-applied skills. Badge is clickable, navigates to voice note.",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "HIGH",
      "estimatedTime": "0.75 hours",
      "acceptanceCriteria": [
        "⚠️ FIRST: Check if skillAssessments has 'source' and 'voiceNoteId' fields",
        "If missing: Add to schema, run codegen, THEN implement",
        "If exists: Modify skill-assessment-display.tsx",
        "Show badge only if source === 'voice_note' AND voiceNoteId exists",
        "Badge includes mic icon, date formatted with date-fns",
        "Badge links to /coach/voice-notes?noteId=X",
        "Type check passes"
      ],
      "technicalNotes": "⚠️ CRITICAL: Schema check required before implementation"
    },
    {
      "id": "US-P8-014",
      "title": "Add Source Badge to Injury Records in Passport",
      "description": "Same as US-P8-013 but for injuries in player passport Health tab.",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "HIGH",
      "estimatedTime": "0.75 hours",
      "acceptanceCriteria": [
        "⚠️ FIRST: Check if playerInjuries has 'source' and 'voiceNoteId' fields",
        "If missing: Add to schema, run codegen, THEN implement",
        "If exists: Modify injury-record-display.tsx",
        "Same pattern as skill badge",
        "Type check passes"
      ],
      "technicalNotes": "⚠️ CRITICAL: Schema check required before implementation"
    },
    {
      "id": "US-P8-015",
      "title": "Add Voice Note Deep Linking from Passport",
      "description": "When clicking source badge from passport, navigate to voice notes page, auto-switch to History tab, scroll to note, highlight with ring animation for 2 seconds.",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "HIGH",
      "estimatedTime": "1.0 hours",
      "acceptanceCriteria": [
        "Modify voice-notes-dashboard.tsx: Handle ?noteId query param with useSearchParams",
        "Auto-switch to History tab when noteId present",
        "Modify history-tab.tsx: Scroll to note with scrollIntoView",
        "Add highlight: ring-2 ring-primary ring-offset-2 classes",
        "Remove highlight after 2 seconds with setTimeout",
        "Clean up timeout in useEffect return",
        "Type check passes"
      ],
      "passes": true
    },
    {
      "id": "US-P8-016",
      "title": "Add Least Engaged Parents Section to My Impact",
      "description": "Show bottom 5 parents with lowest view rates, color-coded by engagement level. Helps coaches identify who needs follow-up.",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "MEDIUM",
      "estimatedTime": "1.5 hours",
      "acceptanceCriteria": [
        "Extend getCoachImpactSummary query: Add parentEngagement array",
        "Calculate from coachParentSummaries table: Group by guardian, calculate view rates",
        "Add section to my-impact-tab.tsx below Applied Insights",
        "Show bottom 5 parents sorted by view rate ascending",
        "Color coding: Red badge (<30%), Yellow (30-60%), Green (>60%)",
        "Display: Guardian name, player name, summaries sent/viewed, last viewed date",
        "Type check passes"
      ],
      "passes": true
    },
    {
      "id": "US-P8-017",
      "title": "Add Engagement Trends Chart to My Impact",
      "description": "Line chart showing last 4 weeks of parent engagement: summaries sent (blue) vs viewed (green). Responsive design.",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "MEDIUM",
      "estimatedTime": "1.0 hours",
      "acceptanceCriteria": [
        "Extend getCoachImpactSummary query: Add weeklyTrends array",
        "Group summaries by week for last 4 weeks",
        "Add chart to my-impact-tab.tsx below parent engagement section",
        "Use recharts: LineChart with two lines (sent, viewed)",
        "Wrap in ResponsiveContainer for mobile",
        "Empty state if < 2 weeks of data",
        "Type check passes"
      ],
      "technicalNotes": "Recharts already available, no installation needed",
      "passes": true
    },
    {
      "id": "US-P8-018",
      "title": "Add Export Impact Report Button",
      "description": "Export applied insights as CSV. PDF deferred for now (show 'Coming Soon' toast).",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "LOW",
      "estimatedTime": "0.75 hours",
      "acceptanceCriteria": [
        "Add 'Export Report' dropdown to my-impact-tab.tsx header",
        "CSV option: Generate CSV with columns: Date, Player, Type, Description, Status",
        "Escape commas: description.replace(/,/g, ';')",
        "Download with filename: applied-insights-[coach-name]-[date].csv",
        "PDF option: Show toast 'PDF export coming soon!'",
        "Type check passes"
      ],
      "technicalNotes": "CSV only for MVP. PDF deferred.",
      "passes": true
    },
    {
      "id": "US-P8-019",
      "title": "Add Comparison with Previous Period",
      "description": "Summary cards show comparison with previous period: '+3 vs last month' with green/red/gray color coding.",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "MEDIUM",
      "estimatedTime": "1.0 hours",
      "acceptanceCriteria": [
        "Extend getCoachImpactSummary query: Add previousPeriodStats object",
        "Query same date range shifted backward in time",
        "Modify impact-summary-cards.tsx: Add comparison display to each card",
        "Green ↑ for improvements (diff > 0)",
        "Red ↓ for decreases (diff < 0)",
        "Gray = for no change (diff === 0)",
        "Type check passes"
      ],
      "passes": true
    },
    {
      "id": "US-P8-020",
      "title": "Add Loading Skeleton to My Impact Tab",
      "description": "Show loading skeleton while getCoachImpactSummary query fetches data. Mimics layout for smooth transition.",
      "phase": "P8 Week 3: Navigation & Polish",
      "priority": "LOW",
      "estimatedTime": "0.5 hours",
      "acceptanceCriteria": [
        "Modify my-impact-tab.tsx",
        "Check if (impactData === undefined) at top of component",
        "Return skeleton layout: 4 card skeletons in grid, 3 section skeletons below",
        "Use shadcn Skeleton component with pulse animation",
        "Type check passes"
      ],
      "passes": true
    }
  ],
  "qualityChecks": {
    "beforeCommitting": [
      "⚠️ CRITICAL: Check schema for source/voiceNoteId fields in skillAssessments and playerInjuries BEFORE implementing US-P8-013/014",
      "npm run check-types - MUST pass",
      "npx ultracite fix - MUST pass",
      "Visual verification: Test all navigation flows (insights → passport → voice notes)",
      "Test deep linking: Click source badge → verify scroll + highlight animation",
      "Test parent engagement: Verify bottom 5 least engaged parents show correct color coding",
      "Test trends chart: Verify responsive, shows last 4 weeks, hover tooltip works",
      "Test CSV export: Verify file downloads with correct format and data",
      "Test comparisons: Verify +/- indicators show with correct colors",
      "Test loading skeleton: Verify shows before data loads"
    ],
    "testingStrategy": {
      "TC-W3-001": "View in Passport Links - Click skill/injury/attendance insight → verify correct tab",
      "TC-W3-002": "Source Badges on Skills - Verify badge shows for voice note skills, not manual",
      "TC-W3-003": "Deep Linking Highlight - Click badge → verify navigation, scroll, 2-second highlight",
      "TC-W3-004": "Parent Engagement - Verify bottom 5 with Red/Yellow/Green badges",
      "TC-W3-005": "Trends Chart - Verify 4 weeks, responsive, tooltip",
      "TC-W3-006": "Export CSV - Verify downloads with correct columns",
      "TC-W3-007": "Previous Period Comparison - Verify +/- with colors",
      "TC-W3-008": "Loading Skeleton - Verify shows before data"
    }
  },
  "weekCompletionCriteria": [
    "✅ All 9 user stories implemented (US-P8-012 to US-P8-020)",
    "✅ Bi-directional navigation works: insights ↔ passport ↔ voice notes",
    "✅ Source badges show on skills and injuries in passport",
    "✅ Deep linking with scroll + highlight animation functional",
    "✅ Parent engagement analytics visible (least engaged parents + trends)",
    "✅ CSV export works with proper formatting",
    "✅ Previous period comparisons display on summary cards",
    "✅ Loading skeleton shows before data loads",
    "✅ Type checking passes: npm run check-types",
    "✅ Linting passes: npx ultracite fix",
    "✅ All test cases pass (8 scenarios)",
    "✅ Visual verification complete"
  ],
  "nextPhase": {
    "name": "Phase 9 - Team Collaboration Hub",
    "description": "Transform Voice Notes into team collaboration platform with comments, reactions, @mentions, activity feed, multi-view (Board/Calendar/Player), session templates, tone controls",
    "weeks": 4,
    "stories": "30-35 stories"
  }
}

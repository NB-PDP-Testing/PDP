# UAT Test: US-VN-015 - Claims Table & Extraction Action

> Auto-generated: 2026-02-06 22:23
> Status: ⏳ Pending Execution

## Story
Add the voiceNoteClaims table with 15 topic categories, create 6 model CRUD functions, extract shared coach context gathering into a reusable internalQuery, and implement the GPT-4 claims extraction internalAction with Zod structured output parsing.

## Acceptance Criteria Checklist

- [ ] SCHEMA: Add voiceNoteClaims table to packages/backend/convex/schema.ts
- [ ] Location: After voiceNoteTranscripts (line ~4220), before platformStaffInvitations (line ~4222)
- [ ] Fields: claimId (string), artifactId (id voiceNoteArtifacts), sourceText (string), timestampStart (optional number), timestampEnd (optional number), topic (union of 15 literals: injury, skill_rating, skill_progress, behavior, performance, attendance, wellbeing, recovery, development_milestone, physical_development, parent_communication, tactical, team_culture, todo, session_plan), title (string), description (string), recommendedAction (optional string), timeReference (optional string), entityMentions (array of {mentionType: union of player_name/team_name/group_reference/coach_name, rawText: string, position: number}), resolvedPlayerIdentityId (optional id playerIdentities), resolvedPlayerName (optional string), resolvedTeamId (optional string), resolvedTeamName (optional string), resolvedAssigneeUserId (optional string), resolvedAssigneeName (optional string), severity (optional union low/medium/high/critical), sentiment (optional union positive/neutral/negative/concerned), skillName (optional string), skillRating (optional number), extractionConfidence (number), organizationId (string), coachUserId (string), status (union extracted/resolving/resolved/needs_disambiguation/merged/discarded/failed), createdAt (number), updatedAt (number)
- [ ] Indexes (7): by_artifactId, by_artifactId_and_status, by_claimId, by_topic, by_org_and_coach, by_org_and_status, by_resolvedPlayerIdentityId
- [ ] Run: npx -w packages/backend convex codegen
- [ ] MODEL: Create packages/backend/convex/models/voiceNoteClaims.ts with 6 functions:
- [ ] 1. storeClaims (internalMutation) — batch insert, returns array of IDs
- [ ] 2. getClaimsByArtifact (internalQuery) — by_artifactId index
- [ ] 3. getClaimsByArtifactAndStatus (internalQuery) — by_artifactId_and_status composite index
- [ ] 4. updateClaimStatus (internalMutation) — by_claimId lookup, patch status + updatedAt
- [ ] 5. getClaimByClaimId (internalQuery) — by_claimId index, first()
- [ ] 6. getClaimsByOrgAndCoach (PUBLIC query) — by_org_and_coach index, limit default 50 max 200
- [ ] Define shared validators at module scope (topicValidator, statusValidator, etc.)
- [ ] HELPER: Create packages/backend/convex/lib/coachContext.ts
- [ ] gatherCoachContext (internalQuery) — returns { players, teams, coaches, recordingCoachName, rosterJson, teamsJson, coachesJson }
- [ ] Port logic from voiceNotes.ts buildInsights lines 340-471
- [ ] Must be internalQuery (called from action via ctx.runQuery)
- [ ] ACTION: Create packages/backend/convex/actions/claimsExtraction.ts
- [ ] 'use node' directive at top
- [ ] extractClaims (internalAction) — args: { artifactId: v.id('voiceNoteArtifacts') }, returns: v.null()
- [ ] Zod schema: claimsExtractionSchema with summary + claims[] covering all 15 topics
- [ ] GPT-4 prompt: all 15 categories with atomicity rules, player/team/coach matching instructions
- [ ] Player matching: deterministic first (AI's playerId), fuzzy fallback via findSimilarPlayers (threshold >= 0.85)
- [ ] Error handling: try/catch, set artifact status to 'failed' on error
- [ ] AI model: reuse getAIConfig pattern (feature: 'voice_insights')
- [ ] MODIFY: packages/backend/convex/models/voiceNoteArtifacts.ts
- [ ] Add getArtifactById (internalQuery) — takes { _id: v.id('voiceNoteArtifacts') }, returns artifact doc or null
- [ ] Simpler than existing getArtifactByArtifactId (which takes string artifactId)
- [ ] VERIFICATION:
- [ ] npx -w packages/backend convex codegen passes
- [ ] npm run check-types passes (0 errors)

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VN-015"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

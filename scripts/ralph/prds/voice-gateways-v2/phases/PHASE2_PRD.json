{
  "phaseNumber": 2,
  "phaseName": "Coach Quick Review Microsite",
  "duration": "7-9 days",
  "storyCount": 6,
  "revision": "v2 â€” aggregated no-auth microsite (replaces per-note auth'd review page)",
  "contextFiles": [
    "context/MAIN_CONTEXT.md",
    "context/PHASE2_MOBILE_REVIEW.md"
  ],
  "designPrinciples": [
    "Zero friction: no login required â€” the 8-char code IS the authentication",
    "Aggregated queue: one rolling link per coach, shows ALL pending items across all voice notes",
    "Priority ordering: injuries first, then unmatched, pending, todos, team notes, auto-applied last",
    "Mobile-first: one-thumb operation, touch targets >= 44px, max-w-lg",
    "Progressive disclosure: urgent items visible immediately, informational items collapsed",
    "Batch operations: 'Apply All', 'Save All Team Notes', 'Add All to Tasks' â€” reduce taps",
    "Completion feedback: progress counter + 'All caught up' state",
    "WhatsApp-native shortcuts: 'OK' to apply all matched without leaving WhatsApp"
  ],
  "researchBasis": [
    "Superhuman: flow-through triage, auto-advance to next item, inbox zero celebration",
    "Tinder: binary decisions at speed via swipe (Phase 3), one-thumb operation",
    "Magic links: 28% higher conversion (Substack), 2.4x mobile engagement vs passwords",
    "GitHub: batch operations for notification triage",
    "Progressive disclosure (NN/g): urgent items surface first, details on demand"
  ],
  "stories": [
    {
      "id": "US-VN-007",
      "phase": 2,
      "title": "Review Links Backend (Coach-Scoped)",
      "description": "Create backend infrastructure for coach-scoped, time-limited review links. Unlike per-note links, each coach has ONE active link that aggregates all pending items. If a coach already has an active link, reuse it instead of generating a new one. Links expire 48h after creation.",
      "acceptanceCriteria": [
        "Backend: Add whatsappReviewLinks table to schema.ts",
        "Schema fields:",
        "  - code: v.string() (8 alphanumeric chars, exclude 0/O/I/l)",
        "  - organizationId: v.string()",
        "  - coachUserId: v.string()",
        "  - createdAt: v.number()",
        "  - expiresAt: v.number() (48h from creation)",
        "  - accessedAt: v.optional(v.number())",
        "  - status: v.union('active', 'expired', 'used')",
        "  - voiceNoteIds: v.array(v.id('voiceNotes')) (all notes included in this link)",
        "  - lastNoteAddedAt: v.number() (when last voice note was added)",
        "Indexes:",
        "  - by_code: ['code']",
        "  - by_coachUserId_and_status: ['coachUserId', 'status']",
        "  - by_expiresAt_and_status: ['expiresAt', 'status']",
        "Backend: Create models/whatsappReviewLinks.ts",
        "Function: generateReviewLink (internalMutation)",
        "  args: { voiceNoteId, organizationId, coachUserId }",
        "  returns: { code: v.string(), expiresAt: v.number(), isReused: v.boolean() }",
        "  Logic:",
        "    1. Query by_coachUserId_and_status for existing 'active' link",
        "    2. If found AND not expired: add voiceNoteId to voiceNoteIds array, update lastNoteAddedAt, return existing code with isReused=true",
        "    3. If not found: generate unique 8-char code, create new record, return with isReused=false",
        "Function: getReviewLinkByCode (query â€” PUBLIC, no auth required)",
        "  args: { code: v.string() }",
        "  returns: link data with isExpired flag, or null if not found",
        "  Logic: Query by_code, check expiry (Date.now() > expiresAt)",
        "Function: getCoachPendingItems (query â€” PUBLIC, accessed via code validation)",
        "  args: { code: v.string() }",
        "  returns: aggregated pending items across ALL voice notes for this coach:",
        "    - injuries: array (priority 1)",
        "    - unmatched: array (priority 2)",
        "    - needsReview: array (priority 3)",
        "    - todos: array (priority 4)",
        "    - teamNotes: array (priority 5)",
        "    - autoApplied: array (collapsed)",
        "    - totalCount, reviewedCount, voiceNoteCount",
        "  NOTE: This query aggregates across ALL voiceNoteIds in the link, not just one note",
        "  Uses batch fetch + Map lookup (NEVER N+1)",
        "Function: markLinkAccessed (mutation â€” PUBLIC)",
        "  args: { code: v.string() }",
        "  Logic: Set accessedAt=Date.now(), keep status='active' (not 'used' â€” link is reusable)",
        "Integration: Call generateReviewLink in checkAndAutoApply after processing insights",
        "Update formatResultsMessage to include deep link URL",
        "Unit tests: Create __tests__/whatsappReviewLinks.test.ts",
        "Test cases:",
        "  - First note: generates new 8-char code",
        "  - Second note (same coach, link active): reuses same code, adds voiceNoteId",
        "  - Expired link + new note: generates fresh code",
        "  - getCoachPendingItems aggregates across multiple notes",
        "  - Invalid code returns null",
        "  - markLinkAccessed updates accessedAt",
        "Type check passes: npm run check-types"
      ],
      "priority": 7,
      "effort": "1.5 days",
      "dependencies": ["US-VN-006"],
      "files": {
        "create": [
          "packages/backend/convex/models/whatsappReviewLinks.ts",
          "packages/backend/convex/__tests__/whatsappReviewLinks.test.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add whatsappReviewLinks table)",
          "packages/backend/convex/actions/whatsapp.ts (integrate link generation, update formatResultsMessage)"
        ]
      }
    },
    {
      "id": "US-VN-008",
      "phase": 2,
      "title": "Quick Review Microsite",
      "description": "Create no-auth microsite at /r/[code] that renders the review UI directly â€” no redirect, no login wall. The 8-char code serves as the authentication token. Validates the code, shows error states inline if invalid/expired, otherwise renders the aggregated coach review queue.",
      "acceptanceCriteria": [
        "Frontend: Create apps/web/src/app/r/[code]/page.tsx",
        "Route type: Client component (for real-time useQuery updates)",
        "NO AUTH REQUIRED â€” this is a public route, code = token",
        "NO REDIRECT â€” renders the review UI directly at /r/[code]",
        "On mount:",
        "  1. useQuery(api.models.whatsappReviewLinks.getReviewLinkByCode, { code })",
        "  2. If null: render InvalidLinkView inline",
        "  3. If isExpired: render ExpiredLinkView inline",
        "  4. If valid: call markLinkAccessed, render QuickReviewLayout",
        "Components to create:",
        "  - QuickReviewLayout: main container (max-w-lg mx-auto, p-4, pb-safe)",
        "  - QuickReviewHeader: fixed top bar with 'Quick Review' title + progress counter",
        "  - InvalidLinkView: error state with 'Go to PlayerARC' button",
        "  - ExpiredLinkView: error state with 'Open Voice Notes' button (links to app)",
        "  - LoadingSkeleton: pulse skeleton for all sections while data loads",
        "Mobile-responsive styling:",
        "  - max-w-lg mx-auto container (centred on tablet, full-width on phone)",
        "  - p-4 spacing, pb-[env(safe-area-inset-bottom)] for bottom safe area",
        "  - Touch targets >= 44px on ALL interactive elements",
        "  - Font sizes: min 16px body (prevents iOS zoom on focus)",
        "  - No horizontal scroll",
        "Type check passes: npm run check-types"
      ],
      "priority": 8,
      "effort": "1 day",
      "dependencies": ["US-VN-007"],
      "files": {
        "create": [
          "apps/web/src/app/r/[code]/page.tsx",
          "apps/web/src/app/r/[code]/components/quick-review-layout.tsx",
          "apps/web/src/app/r/[code]/components/quick-review-header.tsx",
          "apps/web/src/app/r/[code]/components/invalid-link-view.tsx",
          "apps/web/src/app/r/[code]/components/expired-link-view.tsx",
          "apps/web/src/app/r/[code]/components/loading-skeleton.tsx"
        ]
      }
    },
    {
      "id": "US-VN-009",
      "phase": 2,
      "title": "Review Queue Sections & Batch Actions",
      "description": "Build the priority-sorted review queue sections with batch operations, progress counter, and 'All caught up' completion state. Items are grouped by type across ALL voice notes, not by source note.",
      "acceptanceCriteria": [
        "Data: useQuery(api.models.whatsappReviewLinks.getCoachPendingItems, { code })",
        "Priority-sorted sections (render in this order):",
        "",
        "1. InjuryAlertSection (if injuries.length > 0):",
        "   - Red/rose border, ShieldAlert icon",
        "   - Title: 'Injuries ({count})'",
        "   - Each card: player name, description, severity if detected",
        "   - Actions: 'Log Injury' (creates injury record), 'Dismiss'",
        "   - Always expanded, cannot collapse (safety-critical)",
        "",
        "2. UnmatchedSection (if unmatched.length > 0):",
        "   - Amber border, HelpCircle icon",
        "   - Title: 'Unmatched Players ({count})'",
        "   - Placeholder â€” full implementation in US-VN-010",
        "",
        "3. NeedsReviewSection (if needsReview.length > 0):",
        "   - Blue border, Eye icon",
        "   - Title: 'Needs Review ({count})'",
        "   - Each card: player name, category badge, description, confidence %",
        "   - Actions per card: 'Apply' / 'Dismiss'",
        "   - Batch action: 'Apply All ({count})' button at section top",
        "",
        "4. TodosSection (if todos.length > 0):",
        "   - Purple border, CheckSquare icon",
        "   - Title: 'Actions ({count})'",
        "   - Checklist format with category badges (Urgent, Contact, Equipment)",
        "   - Actions per item: checkbox to mark done",
        "   - Batch action: 'Add All to Tasks' button",
        "",
        "5. TeamNotesSection (if teamNotes.length > 0):",
        "   - Green border, Users icon",
        "   - Title: 'Team Notes ({count})'",
        "   - Summary card grouping all team observations",
        "   - Actions per note: 'Save' / 'Dismiss'",
        "   - Batch action: 'Save All to Team Notes' button",
        "",
        "6. AutoAppliedSection (if autoApplied.length > 0, defaultCollapsed=true):",
        "   - Muted/gray styling, CheckCircle icon",
        "   - Title: 'Auto-Applied ({count})' with expand chevron",
        "   - Collapsed by default (informational only)",
        "   - Each item shows: player name, what was applied, when",
        "",
        "Progress counter in header:",
        "  - Format: '{reviewed} of {total} reviewed'",
        "  - Updates in real-time as items are actioned",
        "  - Visual progress bar (thin, below header)",
        "",
        "All-caught-up state (when all actionable items resolved):",
        "  - Show: CheckCircle icon, 'All caught up!' title",
        "  - Summary: '{applied} applied, {dismissed} dismissed, {saved} saved'",
        "  - 'View in App' link to full voice notes dashboard",
        "  - Clean, satisfying completion state",
        "",
        "Mutations needed:",
        "  - applyInsight (existing), dismissInsight (existing)",
        "  - logInjuryFromInsight (new â€” creates injury record from insight data)",
        "  - addTodoFromInsight (new â€” creates coachTask from insight)",
        "  - saveTeamNote (new â€” saves team observation)",
        "  - batchApplyInsights (new â€” applies multiple insights in one call)",
        "",
        "Type check passes: npm run check-types"
      ],
      "priority": 9,
      "effort": "2.5 days",
      "dependencies": ["US-VN-008"],
      "files": {
        "create": [
          "apps/web/src/app/r/[code]/components/injury-alert-section.tsx",
          "apps/web/src/app/r/[code]/components/needs-review-section.tsx",
          "apps/web/src/app/r/[code]/components/todos-section.tsx",
          "apps/web/src/app/r/[code]/components/team-notes-section.tsx",
          "apps/web/src/app/r/[code]/components/auto-applied-section.tsx",
          "apps/web/src/app/r/[code]/components/all-caught-up.tsx",
          "apps/web/src/app/r/[code]/components/insight-card.tsx",
          "apps/web/src/app/r/[code]/components/progress-bar.tsx"
        ],
        "modify": [
          "apps/web/src/app/r/[code]/page.tsx (integrate sections)",
          "packages/backend/convex/models/voiceNotes.ts (add batchApplyInsights, logInjuryFromInsight, addTodoFromInsight, saveTeamNote mutations)"
        ]
      }
    },
    {
      "id": "US-VN-010",
      "phase": 2,
      "title": "Unmatched Player Cards + Text Reply",
      "description": "Create UnmatchedPlayerCard with fuzzy-matched suggestions from Phase 1, plus a text reply input for the coach to type the correct player name when suggestions don't match.",
      "acceptanceCriteria": [
        "Frontend: Create unmatched-player-card.tsx and unmatched-section.tsx",
        "",
        "IMPORTANT: findSimilarPlayers is an internalQuery â€” needs a PUBLIC wrapper!",
        "Backend: Create findSimilarPlayersForReview (public query) in whatsappReviewLinks.ts",
        "  args: { code: v.string(), searchName: v.string(), limit: v.optional(v.number()) }",
        "  Logic: validate code is active, extract organizationId + coachUserId, delegate to findSimilarPlayers",
        "  This keeps the code-based auth model (no session needed)",
        "",
        "Layout (per mockup Option A: Inline Radio):",
        "  - Amber-200 border, bg-amber-50",
        "  - Header: HelpCircle icon + '\"playerName\" not found' + insight description",
        "  - 'Did you mean?' subheading",
        "  - Radio group with suggestions: fullName, teamName, similarity % badge",
        "  - Last option: 'Someone else...'",
        "  - 'Assign & Apply' button (enabled when selection made)",
        "",
        "Text reply input (when 'Someone else...' selected OR no suggestions):",
        "  - Text input: 'Type the player name...'",
        "  - On submit: re-run findSimilarPlayersForReview with typed name",
        "  - Show new suggestions or 'No matches found â€” skip this insight'",
        "  - This replaces the need for voice reply in most cases",
        "",
        "If suggestions.length === 0:",
        "  - Show: 'No similar names found in your teams.'",
        "  - Show text input directly (skip radio group)",
        "  - 'Skip' button to dismiss this insight",
        "",
        "Mutation: assignPlayerToInsight({ noteId, insightId, playerIdentityId })",
        "  NOTE: This mutation needs a public variant accessible via code auth",
        "",
        "Similarity display: Math.round(similarity * 100) + '%'",
        "Loading: Loader2 spinner during assignment",
        "After assignment: card animates out, progress counter updates",
        "",
        "Aggregation: shows unmatched from ALL voice notes in the link, not just one",
        "",
        "Type check passes: npm run check-types"
      ],
      "priority": 10,
      "effort": "1.5 days",
      "dependencies": ["US-VN-009", "US-VN-006"],
      "files": {
        "create": [
          "apps/web/src/app/r/[code]/components/unmatched-player-card.tsx",
          "apps/web/src/app/r/[code]/components/unmatched-section.tsx"
        ],
        "modify": [
          "apps/web/src/app/r/[code]/page.tsx (integrate UnmatchedSection)",
          "packages/backend/convex/models/whatsappReviewLinks.ts (add findSimilarPlayersForReview, assignPlayerFromReview)"
        ]
      }
    },
    {
      "id": "US-VN-011",
      "phase": 2,
      "title": "Trust-Adaptive Messages + WhatsApp Quick Actions",
      "description": "Update WhatsApp message formatting based on coach trust level with running totals across notes, and add 'OK' quick-reply shortcut to apply all matched insights without leaving WhatsApp.",
      "acceptanceCriteria": [
        "Backend: Update formatResultsMessage in actions/whatsapp.ts",
        "",
        "Trust level evaluation (from coachTrustLevels table):",
        "  - TL0-1 (New coach, <10 auto-applied): Cautious, generic counts",
        "  - TL2 (Established, 10-50 auto-applied): Show top 3 names + counts",
        "  - TL3 (Trusted, >50 auto-applied): Confident, show all if <= 3",
        "",
        "Message formats with running totals:",
        "",
        "First note of the day (no prior pending):",
        "  TL0-1: 'Analysis complete!\\n\\nâš ï¸ {needsReview} insights need review\\nâ“ {unmatched} unmatched players\\n\\nReply OK to apply all matched\\nOr review: {link} (48h)'",
        "  TL2: 'Analysis complete!\\n\\nâœ… Auto-applied ({count}): {names}\\nâš ï¸ Needs review ({count})\\nâ“ Unmatched ({count}): {names}\\n\\nReply OK to apply matched\\nReview: {link}'",
        "  TL3 (all applied): 'âœ… All applied!\\n\\n{names}\\nðŸ“¤ Parent updates queued ({count})\\n\\nView details: {link}'",
        "",
        "Subsequent notes (prior pending exists):",
        "  'Analysis complete!\\n\\n{thisNote summary}\\n\\nðŸ“‹ You now have {totalPending} pending items\\nReply OK to apply all {matchedCount} matched\\nReview: {link}'",
        "",
        "WhatsApp 'OK' quick-reply handler:",
        "  In actions/whatsapp.ts processMessage, BEFORE confirmation check:",
        "  1. If messageType === 'text' and body matches /^(ok|yes|apply|go)$/i:",
        "  2. Check if coach has an active review link with pending matched insights",
        "  3. If yes: batch-apply all matched insights (status='pending', confidence >= autoApplyThreshold)",
        "  4. Reply: 'âœ… Applied {count} insights! {remaining} items still need review: {link}'",
        "  5. If no pending matched: fall through to normal processing",
        "",
        "WhatsApp 'R' handler (resend review link):",
        "  If body matches /^r$/i and coach has active link:",
        "  Reply with current link and pending summary",
        "",
        "Helper functions:",
        "  - getTrustLevel(coachId, orgId): query coachTrustLevels or count auto-applied",
        "  - formatCategory(category): map to emoji + short label",
        "  - truncateList(items, limit): first N + '+X more'",
        "  - getPendingCounts(coachId): aggregate pending across all active notes",
        "",
        "Unit tests: Add to __tests__/whatsappFeedback.test.ts",
        "Test cases:",
        "  - TL0, first note, 4 pending â†’ generic format with OK instruction",
        "  - TL2, second note, 3 prior pending â†’ shows running total",
        "  - TL3, 3 applied, 0 pending â†’ confident 'All applied!'",
        "  - 'OK' reply with 5 matched â†’ applies all 5, response with count",
        "  - 'OK' reply with 0 matched â†’ falls through to normal processing",
        "  - 'R' reply â†’ resends current link + summary",
        "Type check passes: npm run check-types"
      ],
      "priority": 11,
      "effort": "1 day",
      "dependencies": ["US-VN-007"],
      "files": {
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (formatResultsMessage update, OK/R handlers)",
          "packages/backend/convex/__tests__/whatsappFeedback.test.ts (trust level + quick action tests)"
        ]
      }
    },
    {
      "id": "US-VN-012",
      "phase": 2,
      "title": "Link Expiry & Cleanup",
      "description": "Implement cron job to clean up expired review links (>7 days old) and handle link lifecycle states in the microsite.",
      "acceptanceCriteria": [
        "Backend: Add cleanupExpiredLinks cron job to crons.ts",
        "Schedule: Daily at 3am UTC",
        "Logic: Query by_expiresAt_and_status for links where expiresAt < (now - 7 days), delete each",
        "",
        "Backend: Add cleanupExpiredLinks internalMutation to whatsappReviewLinks.ts",
        "  args: {}",
        "  returns: { deleted: v.number() }",
        "",
        "Backend: Add expireActiveLinks internalMutation",
        "  Logic: Query active links where expiresAt < now, update status to 'expired'",
        "  Called by cron before cleanup",
        "",
        "Frontend: ExpiredLinkView already created in US-VN-008",
        "  Ensure it renders when getReviewLinkByCode returns isExpired=true",
        "  Show: Clock icon, 'Link Expired' title",
        "  Message: 'This review link has expired. Links are valid for 48 hours.'",
        "  Button: 'Open Voice Notes' â†’ links to app login â†’ voice notes dashboard",
        "  Button: 'Back to WhatsApp' â†’ deep link to WhatsApp",
        "",
        "Link lifecycle:",
        "  - Coach sends first note â†’ link created (status='active', expires=now+48h)",
        "  - Coach sends more notes â†’ same link, voiceNoteIds array grows",
        "  - Coach taps link â†’ accessedAt set, status stays 'active'",
        "  - 48h passes â†’ status='expired' (via cron or on-access check)",
        "  - 7 days after expiry â†’ record deleted (via cron)",
        "  - Coach sends new note after expiry â†’ fresh link generated",
        "",
        "Unit tests: Add to __tests__/whatsappReviewLinks.test.ts",
        "Test cases:",
        "  - Cron expires active links past expiresAt",
        "  - Cron deletes expired links > 7 days old",
        "  - New note after expiry creates fresh link",
        "  - Cleanup returns correct deleted count",
        "Type check passes: npm run check-types"
      ],
      "priority": 12,
      "effort": "0.5 day",
      "dependencies": ["US-VN-008"],
      "files": {
        "modify": [
          "packages/backend/convex/crons.ts (add cleanup cron)",
          "packages/backend/convex/models/whatsappReviewLinks.ts (add cleanup + expire mutations)"
        ]
      }
    }
  ],
  "phase3Candidates": {
    "description": "Polish and power-user features deferred from Phase 2 for a future enhancement phase",
    "items": [
      {
        "id": "FUTURE-swipe-gestures",
        "title": "Swipe Gestures for Card Actions",
        "description": "Swipe right to apply, swipe left to dismiss (Tinder/Superhuman pattern). Button fallbacks always visible for accessibility. Haptic feedback on action.",
        "effort": "1 day",
        "rationale": "Buttons work fine for launch. Swipe is a power-user optimization."
      },
      {
        "id": "FUTURE-end-of-day-digest",
        "title": "End-of-Day WhatsApp Digest",
        "description": "Configurable daily summary message at coach's preferred time. Shows total pending, what was applied, what needs attention.",
        "effort": "0.5 day",
        "rationale": "Per-note replies with running totals cover this need adequately for now."
      },
      {
        "id": "FUTURE-snooze-action",
        "title": "Snooze Action (Review Later)",
        "description": "Third action beyond Apply/Dismiss. Moves item to 'Snoozed' section, resurfaces on next voice note or after configurable delay.",
        "effort": "0.5 day",
        "rationale": "Useful but adds complexity to the review queue. Dismiss + re-record covers most cases."
      },
      {
        "id": "FUTURE-offline-resilience",
        "title": "Offline Action Queuing",
        "description": "Queue Apply/Dismiss actions locally when offline, sync when connection returns. Critical for coaches on pitches with poor signal.",
        "effort": "1.5 days",
        "rationale": "Important but requires service worker / PWA infrastructure. Phase 2 should work well enough on 3G."
      },
      {
        "id": "FUTURE-voice-reply",
        "title": "Voice Reply from Microsite",
        "description": "Record voice reply directly from review page to resolve unmatched players or add context. Processed through same pipeline.",
        "effort": "2 days",
        "rationale": "Text reply in US-VN-010 covers most cases. Voice is more natural but technically complex."
      },
      {
        "id": "FUTURE-flow-through-mode",
        "title": "Card-by-Card Flow-Through Mode",
        "description": "Optional Superhuman-style single-card view. Show one insight at a time, auto-advance on action. Toggle between list view and flow view.",
        "effort": "1 day",
        "rationale": "Card Stack list view is the right default. Flow-through suits high-volume coaches."
      }
    ]
  },
  "successCriteria": {
    "mustHave": [
      "No-auth microsite at /r/[code] â€” zero login friction",
      "Coach-scoped aggregated link (one link, all pending items)",
      "Priority-sorted queue (injuries â†’ unmatched â†’ pending â†’ todos â†’ team â†’ auto-applied)",
      "Batch operations (Apply All, Save All Team Notes, Add All to Tasks)",
      "Progress counter + 'All caught up' completion state",
      "WhatsApp running totals across multiple notes",
      "WhatsApp 'OK' quick-reply to apply all matched insights",
      "Fuzzy match suggestions for unmatched players (reusing Phase 1)",
      "Text reply input for unmatched player resolution",
      "Trust-adaptive message formatting (TL0-3)",
      "48h link expiry with graceful expired state",
      "Cron cleanup of expired links > 7 days",
      "Mobile-first: touch targets >= 44px, max-w-lg, safe area",
      "All unit tests passing",
      "Type check passes (0 errors)"
    ],
    "niceToHave": [
      "Swipe gestures (Phase 3 candidate)",
      "End-of-day digest (Phase 3 candidate)",
      "Offline support (Phase 3 candidate)",
      "Voice reply (Phase 3 candidate)"
    ]
  }
}

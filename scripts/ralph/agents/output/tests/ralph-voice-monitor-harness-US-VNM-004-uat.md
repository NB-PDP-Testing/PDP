# UAT Test: US-VNM-004 - Build Metrics Aggregation System

> Auto-generated: 2026-02-16 19:26
> Status: ⏳ Pending Execution

## Story
Create voicePipelineMetrics.ts with hourly/daily aggregation logic and real-time counter queries. READ FULL DETAILS in phases/PHASE_M2.json.

## Acceptance Criteria Checklist

- [ ] Create packages/backend/convex/models/voicePipelineMetrics.ts
- [ ] Implement getRealTimeMetrics query (O(1) counter reads, < 50ms, NEVER scan events)
- [ ] Implement getHistoricalMetrics query (reads snapshots by time range, no raw event scanning)
- [ ] Implement getStageBreakdown query (per-stage latency/failure rates from snapshots)
- [ ] Implement getOrgBreakdown query (CRITICAL: batch fetch org names, NO N+1 queries)
- [ ] Implement aggregateHourlyMetrics internalMutation (aggregates events → snapshots, < 30s)
- [ ] Implement aggregateDailyMetrics internalMutation (aggregates hourly → daily snapshots, < 10s)
- [ ] Implement cleanupOldSnapshots internalMutation (7d hourly, 90d daily retention)
- [ ] Implement cleanupOldEvents internalMutation (48h event retention)
- [ ] All rate calculations use safe division (denominator > 0 check, no NaN/Infinity)
- [ ] UTC time handling: getUTCHours(), getUTCMonth(), getUTCDate() (NOT local time methods)
- [ ] Platform-wide data: OMIT organizationId field (not null, use undefined)
- [ ] Test getRealTimeMetrics with existing M1 counter data
- [ ] Test aggregateHourlyMetrics with manual call → verify snapshots created
- [ ] Run: npx -w packages/backend convex codegen && npm run check-types

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VNM-004"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

{
  "project": "Onboarding Phase 2 - GDPR Consent System",
  "branchName": "ralph/onboarding-phase-2",
  "description": "Implement platform-wide GDPR consent with one-time acceptance and re-acceptance capability when policy is updated. GDPR consent is always the first onboarding step for new users.",
  "relatedIssues": ["#371"],
  "dependencies": ["phase-1-foundation"],
  "userStories": [
    {
      "id": "US-001",
      "title": "Add GDPR consent fields to user schema",
      "description": "As the system, I track GDPR consent version and timestamp for each user.",
      "priority": 1,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Find the user table definition (Better Auth extended user)",
        "Add these optional fields:",
        "  gdprConsentVersion: v.optional(v.number()),  // Version number accepted (1, 2, 3...)",
        "  gdprConsentedAt: v.optional(v.number()),     // Timestamp of consent",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types",
        "Verify in Convex dashboard that user table has new fields"
      ],
      "notes": "IP address capture was explicitly NOT required per design decision."
    },
    {
      "id": "US-002",
      "title": "Create gdprVersions table for policy version tracking",
      "description": "As platform staff, I can create new GDPR versions that trigger re-acceptance for users.",
      "priority": 2,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Add new table gdprVersions:",
        "",
        "gdprVersions: defineTable({",
        "  version: v.number(),           // 1, 2, 3...",
        "  effectiveDate: v.number(),     // When this version becomes active",
        "  summary: v.string(),           // Short description of changes",
        "  fullText: v.string(),          // Complete policy text",
        "  createdBy: v.string(),         // Platform staff userId",
        "  createdAt: v.number(),",
        "})",
        "  .index('by_version', ['version'])",
        "  .index('by_effective_date', ['effectiveDate']),",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types"
      ],
      "notes": "This table stores all versions of the GDPR policy for auditing and re-acceptance triggers."
    },
    {
      "id": "US-003",
      "title": "Create GDPR queries and mutations",
      "description": "As the system, I can check GDPR status and record consent.",
      "priority": 3,
      "passes": true,
      "acceptanceCriteria": [
        "Create: packages/backend/convex/models/gdpr.ts",
        "",
        "Query: getCurrentGdprVersion",
        "Args: none",
        "Returns: v.union(v.object({ version, summary, fullText, effectiveDate }), v.null())",
        "Logic: Get latest version where effectiveDate <= Date.now(), ordered by version desc, take 1",
        "",
        "Query: checkUserGdprStatus",
        "Args: none (uses authenticated user)",
        "Returns: v.object({ needsConsent: v.boolean(), currentVersion: v.number(), userVersion: v.optional(v.number()) })",
        "Logic:",
        "  - Get current GDPR version",
        "  - Get user's gdprConsentVersion",
        "  - needsConsent = userVersion is undefined OR userVersion < currentVersion",
        "",
        "Mutation: acceptGdpr",
        "Args: { version: v.number(), consentedToMarketing: v.optional(v.boolean()) }",
        "Returns: v.null()",
        "Logic:",
        "  - Verify version matches current version (prevent accepting old version)",
        "  - Update user: gdprConsentVersion = version, gdprConsentedAt = Date.now()",
        "  - Optionally store marketing consent somewhere (future enhancement)",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Marketing consent is optional and tracked separately from GDPR acceptance."
    },
    {
      "id": "US-004",
      "title": "Seed initial GDPR version",
      "description": "As the system, there is a default GDPR policy available for new deployments.",
      "priority": 4,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/gdpr.ts",
        "Add mutation: seedInitialGdprVersion (internal)",
        "",
        "Mutation logic:",
        "  - Check if any gdprVersions exist",
        "  - If not, create version 1 with placeholder content:",
        "    {",
        "      version: 1,",
        "      effectiveDate: Date.now(),",
        "      summary: 'Initial privacy policy',",
        "      fullText: (use the placeholder text from PRD or a reasonable default),",
        "      createdBy: 'system',",
        "      createdAt: Date.now(),",
        "    }",
        "",
        "The fullText should include:",
        "  - Data collection notice",
        "  - How data is used",
        "  - User rights under GDPR",
        "  - Contact information",
        "",
        "Run: npm run check-types",
        "After deployment, manually call seedInitialGdprVersion from Convex dashboard"
      ],
      "notes": "This ensures there's always a GDPR version available. Can be replaced with proper content later."
    },
    {
      "id": "US-005",
      "title": "Create GdprPolicyViewer component",
      "description": "As a user, I can view the full GDPR policy with expandable sections.",
      "priority": 5,
      "passes": true,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/onboarding/gdpr-policy-viewer.tsx",
        "",
        "Props: { summary: string; fullText: string }",
        "",
        "UI structure:",
        "- Show summary text (always visible)",
        "- Collapsible section: 'View Full Privacy Policy'",
        "  - Use shadcn/ui Collapsible or Accordion component",
        "  - When expanded, show fullText in a scrollable area",
        "  - ScrollArea with max-height: 300px",
        "",
        "Style the text with proper typography:",
        "  - Headings for sections",
        "  - Bullet points for lists",
        "  - Parse markdown if fullText contains markdown",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Keep the UI clean. Most users won't read the full text but it must be available."
    },
    {
      "id": "US-006",
      "title": "Create GdprConsentStep modal component",
      "description": "As a new user, I see a GDPR consent modal that I must accept before proceeding.",
      "priority": 6,
      "passes": true,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/onboarding/gdpr-consent-step.tsx",
        "",
        "Props: { gdprVersion: GdprVersion; onAccept: () => void }",
        "",
        "Use shadcn/ui AlertDialog (cannot be dismissed without action)",
        "",
        "UI structure:",
        "- Title: 'Data Protection & Privacy Consent'",
        "- GdprPolicyViewer component with summary and fullText",
        "- Checkbox 1 (required): 'I have read and agree to the Privacy Policy'",
        "- Checkbox 2 (optional): 'I agree to receive platform updates via email'",
        "- Button: 'Accept & Continue' (disabled until required checkbox checked)",
        "",
        "On Accept:",
        "  - Call acceptGdpr mutation with version number",
        "  - Call onAccept callback",
        "  - Show toast: 'Privacy policy accepted'",
        "",
        "Modal cannot be closed without accepting (no X button, no escape)",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This is a blocking modal. User cannot proceed without accepting GDPR."
    },
    {
      "id": "US-007",
      "title": "Integrate GDPR check into OnboardingOrchestrator",
      "description": "As the system, I show GDPR consent as the first onboarding step when needed.",
      "priority": 7,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/onboarding.ts",
        "Update getOnboardingTasks query:",
        "  - Add GDPR check at the BEGINNING:",
        "    const gdprStatus = await checkUserGdprStatus(ctx);",
        "    if (gdprStatus.needsConsent) {",
        "      tasks.unshift({ type: 'gdpr_consent', priority: 0, data: { version: gdprStatus.currentVersion } });",
        "    }",
        "",
        "Edit: apps/web/src/components/onboarding/onboarding-orchestrator.tsx",
        "Import GdprConsentStep component",
        "Import getCurrentGdprVersion query",
        "",
        "In OnboardingStepRenderer (or orchestrator):",
        "  - When task.type === 'gdpr_consent':",
        "    const gdprVersion = useQuery(api.models.gdpr.getCurrentGdprVersion);",
        "    if (!gdprVersion) return null;",
        "    return <GdprConsentStep gdprVersion={gdprVersion} onAccept={handleStepComplete} />;",
        "",
        "Run: npm run check-types",
        "Test: New user signup → GDPR modal appears first → Accept → Continue to next step"
      ],
      "notes": "GDPR is priority 0, meaning it always comes before any other onboarding step."
    },
    {
      "id": "US-008",
      "title": "Create platform staff GDPR version management page",
      "description": "As platform staff, I can view GDPR versions and create new ones.",
      "priority": 8,
      "passes": true,
      "acceptanceCriteria": [
        "Create: apps/web/src/app/platform-admin/gdpr/page.tsx",
        "",
        "Page requires isPlatformStaff check (redirect if not staff)",
        "",
        "Query all gdprVersions, order by version desc",
        "",
        "UI structure:",
        "- Title: 'GDPR Policy Versions'",
        "- Button: '+ New Version' (opens dialog)",
        "- List of versions as Cards:",
        "  - Version number and 'Current' badge if latest",
        "  - Effective date",
        "  - Summary text",
        "  - Created by and date",
        "",
        "New Version Dialog:",
        "  - Input: Summary (required)",
        "  - Textarea: Full Text (required)",
        "  - Input: Effective Date (defaults to now)",
        "  - Button: 'Create Version'",
        "",
        "Mutation: createGdprVersion (add to gdpr.ts)",
        "  - Platform staff only (check isPlatformStaff)",
        "  - Version = max existing version + 1",
        "  - Create record",
        "",
        "Run: npm run check-types",
        "Test: Create new version → Existing user logs in → Sees GDPR re-consent modal"
      ],
      "notes": "This is an admin page. Keep it simple. Main use case is updating the policy and triggering re-consent."
    }
  ],
  "verificationSteps": [
    "npm run check-types",
    "npx -w packages/backend convex codegen",
    "Seed initial GDPR version",
    "Test: New user signup → GDPR modal appears first",
    "Test: Accept GDPR → Continue to next onboarding step",
    "Test: Create GDPR version 2 → Existing user sees re-consent"
  ],
  "successCriteria": [
    "New users see GDPR consent before any other step",
    "GDPR modal cannot be dismissed without accepting",
    "Consent recorded with version and timestamp",
    "Platform staff can create new GDPR versions",
    "Users with outdated version see re-acceptance prompt"
  ]
}

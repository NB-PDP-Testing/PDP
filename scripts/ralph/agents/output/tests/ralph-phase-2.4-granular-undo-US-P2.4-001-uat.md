# UAT Test: US-P2.4-001 - Create undo eligibility check query

> Auto-generated: 2026-02-13 23:26
> Status: ⏳ Pending Execution

## Story
As the import system, I need to check whether a completed import can be undone based on time window and dependent data.

## Acceptance Criteria Checklist

- [ ] Add checkUndoEligibility query to packages/backend/convex/models/importSessions.ts
- [ ] Args: sessionId (v.id('importSessions'))
- [ ] Returns: { eligible: boolean, reasons: string[], expiresAt: number | null, stats: { playerCount, guardianCount, enrollmentCount, passportCount, assessmentCount } }
- [ ] Check 1: Session status must be 'completed' — if not, return ineligible with reason
- [ ] Check 2: 24-hour window — if (Date.now() - session.completedAt) > 24*60*60*1000, return ineligible
- [ ] Check 3: Query skillAssessments by importSessionId index — if any assessments exist on imported players that were NOT created by this import, return ineligible with 'Players have assessments created after import'
- [ ] Check 4: Count records per table using by_importSessionId index on: playerIdentities, guardianIdentities, guardianPlayerLinks, orgPlayerEnrollments, sportPassports, skillAssessments
- [ ] Stats object returns counts so the UI can show impact preview
- [ ] expiresAt = session.completedAt + 24*60*60*1000 (or null if already expired)
- [ ] Run npx ultracite fix and npx -w packages/backend convex codegen

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-P2.4-001"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

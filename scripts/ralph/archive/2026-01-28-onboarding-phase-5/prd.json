{
  "project": "Onboarding Phase 6 - Polish, Scheduled Jobs & Edge Cases",
  "branchName": "ralph/onboarding-phase-6",
  "description": "Final polish including error handling, accessibility, analytics, and scheduled jobs for invitation lifecycle automation (mark expired, auto re-invite, admin alerts, archive, cleanup).",
  "relatedIssues": ["#371"],
  "dependencies": [
    "phase-1-foundation",
    "phase-1b-invitation-lifecycle",
    "phase-2-gdpr",
    "phase-3-child-linking",
    "phase-4-notifications"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "Add error handling wrapper for onboarding components",
      "description": "As a user encountering an error during onboarding, I see a friendly message with retry option.",
      "priority": 1,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/onboarding/error-boundary.tsx",
        "",
        "Create OnboardingErrorBoundary component:",
        "- Wrap children with React error boundary",
        "- On error, show Card with:",
        "  - Title: 'Something went wrong'",
        "  - Message: 'We encountered an issue. Please try again.'",
        "  - Button: 'Try Again' (resets error boundary)",
        "  - Link: 'Contact Support' (opens support email/page)",
        "",
        "Apply to OnboardingOrchestrator:",
        "Edit: apps/web/src/components/onboarding/onboarding-orchestrator.tsx",
        "Wrap OnboardingStepRenderer with OnboardingErrorBoundary",
        "",
        "For mutations, add try/catch with toast errors:",
        "try {",
        "  await mutation(args);",
        "} catch (error) {",
        "  toast.error('Failed to complete. Please try again.');",
        "  // Log to error tracking service",
        "}",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Network and server errors should show retry option. Validation errors should show inline."
    },
    {
      "id": "US-002",
      "title": "Implement skip behavior for child linking",
      "description": "As a parent, I can skip child linking (max 3 times) and it will re-appear on next login.",
      "priority": 2,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Add to user table:",
        "  childLinkingSkipCount: v.optional(v.number()),  // Max 3",
        "",
        "Edit: apps/web/src/components/onboarding/child-linking-step.tsx",
        "Add 'Skip for Now' button (secondary, only if skipCount < 3):",
        "",
        "const handleSkip = async () => {",
        "  await incrementSkipCount();",
        "  onComplete();  // Closes modal, continues to next step",
        "};",
        "",
        "If skipCount >= 3, don't show skip button (must action)",
        "",
        "Edit: packages/backend/convex/models/onboarding.ts",
        "In getOnboardingTasks, for child_linking:",
        "  - Always include task if pending links exist (even if skipped)",
        "  - Include skipCount in task data so UI can hide/show skip button",
        "",
        "Run: npm run check-types",
        "Test: Parent skips 3 times → Fourth time, no skip button available"
      ],
      "notes": "Skip behavior allows users to dismiss temporarily but ensures they eventually address it."
    },
    {
      "id": "US-003",
      "title": "Add help footer to onboarding modals",
      "description": "As a user in an onboarding modal, I see help links at the bottom.",
      "priority": 3,
      "passes": false,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/onboarding/help-footer.tsx",
        "",
        "Component structure:",
        "- Separator line",
        "- Text: 'Need help?' + email link",
        "- Optional: Link to help docs/FAQ",
        "",
        "const HelpFooter = () => (",
        "  <div className='mt-4 pt-4 border-t text-sm text-muted-foreground'>",
        "    <p>",
        "      Need help?{' '}",
        "      <a href='mailto:support@playerarc.com' className='underline'>",
        "        Contact Support",
        "      </a>",
        "    </p>",
        "  </div>",
        ");",
        "",
        "Add to all onboarding step components:",
        "- GdprConsentStep",
        "- ChildLinkingStep",
        "- ExpiredInvitationView",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Support email should be configurable. For now, use placeholder."
    },
    {
      "id": "US-004",
      "title": "Add accessibility improvements to modals",
      "description": "As a user with accessibility needs, I can navigate onboarding modals with keyboard and screen reader.",
      "priority": 4,
      "passes": false,
      "acceptanceCriteria": [
        "Review all onboarding components for accessibility:",
        "",
        "Keyboard navigation:",
        "- Tab moves between interactive elements",
        "- Enter activates buttons",
        "- Escape doesn't close modal (blocking modals)",
        "- Focus trapped within modal",
        "",
        "Screen reader:",
        "- All modals have aria-labelledby (title)",
        "- All modals have aria-describedby (description)",
        "- Form inputs have labels",
        "- Error messages have aria-live='polite'",
        "- Progress indicators have aria-valuemin, aria-valuemax, aria-valuenow",
        "",
        "Color contrast:",
        "- Verify all text meets WCAG AA (4.5:1 for normal, 3:1 for large)",
        "- Verify buttons have sufficient contrast",
        "",
        "Test with keyboard only - should be able to complete all flows",
        "Test with VoiceOver/NVDA if available",
        "",
        "Run: npm run check-types"
      ],
      "notes": "shadcn/ui components have good accessibility defaults. Verify they're preserved."
    },
    {
      "id": "US-005",
      "title": "Add mobile responsive styles to modals",
      "description": "As a mobile user, onboarding modals display correctly on small screens.",
      "priority": 5,
      "passes": false,
      "acceptanceCriteria": [
        "Review all onboarding components for mobile:",
        "",
        "For viewports < 640px:",
        "- Modals become full-screen (100vh, 100vw)",
        "- Remove rounded corners on full-screen",
        "- Scrollable content area",
        "- Sticky footer with action buttons",
        "",
        "Add responsive classes:",
        "<AlertDialogContent className='sm:max-w-md max-sm:h-screen max-sm:w-screen max-sm:rounded-none'>",
        "",
        "Touch-friendly:",
        "- All buttons min 44x44px tap target",
        "- Checkboxes have larger tap area (include label)",
        "- Adequate spacing between interactive elements",
        "",
        "Test on mobile device or Chrome DevTools device mode",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Full-screen modals on mobile are a common pattern. Ensure scroll works properly."
    },
    {
      "id": "US-006",
      "title": "Add analytics events for onboarding funnel",
      "description": "As the product team, I can track onboarding completion rates and drop-off points.",
      "priority": 6,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: apps/web/src/lib/analytics.ts (or create if doesn't exist)",
        "",
        "Add onboarding tracking functions:",
        "",
        "export function trackOnboardingStarted(entryType: string, userType: string) {",
        "  posthog.capture('onboarding_started', { entry_type: entryType, user_type: userType });",
        "}",
        "",
        "export function trackOnboardingStepShown(stepId: string, stepNumber: number) {",
        "  posthog.capture('onboarding_step_shown', { step_id: stepId, step_number: stepNumber });",
        "}",
        "",
        "export function trackOnboardingStepCompleted(stepId: string, durationSeconds: number) {",
        "  posthog.capture('onboarding_step_completed', { step_id: stepId, duration_seconds: durationSeconds });",
        "}",
        "",
        "export function trackOnboardingStepSkipped(stepId: string, skipCount: number) {",
        "  posthog.capture('onboarding_step_skipped', { step_id: stepId, skip_count: skipCount });",
        "}",
        "",
        "export function trackOnboardingCompleted(totalDuration: number, stepsCompleted: number) {",
        "  posthog.capture('onboarding_completed', { total_duration: totalDuration, steps_completed: stepsCompleted });",
        "}",
        "",
        "Add calls to OnboardingOrchestrator and step components",
        "",
        "Run: npm run check-types"
      ],
      "notes": "PostHog is already integrated per CLAUDE.md. Use existing posthog instance."
    },
    {
      "id": "US-007",
      "title": "Create archivedInvitations table",
      "description": "As the system, I store archived invitations separately for long-term audit.",
      "priority": 7,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Add new table archivedInvitations:",
        "",
        "archivedInvitations: defineTable({",
        "  originalInvitationId: v.string(),",
        "  organizationId: v.string(),",
        "  email: v.string(),",
        "  role: v.string(),",
        "  metadata: v.any(),",
        "  createdAt: v.number(),",
        "  expiredAt: v.number(),",
        "  archivedAt: v.number(),",
        "  archivedReason: v.union(",
        "    v.literal('expired_30_days'),",
        "    v.literal('manual_archive'),",
        "    v.literal('user_cancelled')",
        "  ),",
        "})",
        "  .index('by_organization', ['organizationId'])",
        "  .index('by_archived_at', ['archivedAt']),",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types"
      ],
      "notes": "Archived invitations are for audit purposes. They can be cleaned up after 90 days."
    },
    {
      "id": "US-008",
      "title": "Create scheduled job: Mark expired invitations",
      "description": "As the system, I automatically mark invitations as expired when they pass their expiration date.",
      "priority": 8,
      "passes": false,
      "acceptanceCriteria": [
        "Create: packages/backend/convex/jobs/invitations.ts",
        "",
        "Create internal mutation: markExpiredInvitations",
        "Logic:",
        "  - Query invitations where status = 'pending' AND expiresAt < Date.now()",
        "  - Update each to status = 'expired'",
        "  - Log count for monitoring",
        "",
        "export const markExpiredInvitations = internalMutation({",
        "  handler: async (ctx) => {",
        "    const expired = await ctx.db",
        "      .query('invitation')",
        "      .withIndex('by_status_expires', q => q.eq('status', 'pending'))",
        "      .filter(q => q.lt(q.field('expiresAt'), Date.now()))",
        "      .collect();",
        "",
        "    for (const inv of expired) {",
        "      await ctx.db.patch(inv._id, { status: 'expired' });",
        "    }",
        "",
        "    console.log(`Marked ${expired.length} invitations as expired`);",
        "  },",
        "});",
        "",
        "Note: May need to add index 'by_status_expires' to invitation table",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This job runs hourly to keep invitation statuses current."
    },
    {
      "id": "US-009",
      "title": "Create scheduled job: Auto re-invite for enabled orgs",
      "description": "As the system, I automatically resend invitations for organizations with auto re-invite enabled.",
      "priority": 9,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/jobs/invitations.ts",
        "",
        "Create internal mutation: processAutoReInvites",
        "Logic:",
        "  - Query organizations where autoReInviteOnExpiration = true",
        "  - For each org, get expired invitations where autoReInviteCount < maxAutoReInvitesPerInvitation",
        "  - Create new invitation for each, increment autoReInviteCount",
        "  - Send email",
        "",
        "export const processAutoReInvites = internalMutation({",
        "  handler: async (ctx) => {",
        "    const orgs = await ctx.db",
        "      .query('organization')",
        "      .filter(q => q.eq(q.field('autoReInviteOnExpiration'), true))",
        "      .collect();",
        "",
        "    let totalResent = 0;",
        "    for (const org of orgs) {",
        "      const maxReInvites = org.maxAutoReInvitesPerInvitation ?? 2;",
        "      const expired = await ctx.db",
        "        .query('invitation')",
        "        .withIndex('by_organization_status', q => q.eq('organizationId', org._id).eq('status', 'expired'))",
        "        .filter(q => q.lt(q.field('autoReInviteCount') ?? 0, maxReInvites))",
        "        .collect();",
        "",
        "      for (const inv of expired) {",
        "        // Create new invitation with same details",
        "        // Send email",
        "        // Increment autoReInviteCount on original",
        "        totalResent++;",
        "      }",
        "    }",
        "    console.log(`Auto re-invited ${totalResent} invitations`);",
        "  },",
        "});",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This job runs daily at 8 AM UTC. Only affects orgs with the setting enabled."
    },
    {
      "id": "US-010",
      "title": "Create scheduled job: Admin expiration alerts",
      "description": "As an admin, I receive email alerts about invitations expiring soon.",
      "priority": 10,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/jobs/invitations.ts",
        "",
        "Create internal mutation: sendExpirationAlerts",
        "Logic:",
        "  - For each organization, get admins",
        "  - Count invitations expiring in next 48 hours",
        "  - If count > 0 and org.notifyAdminsOnExpiration !== false, send summary email",
        "",
        "Email content:",
        "Subject: '{count} invitations expiring soon'",
        "Body:",
        "- List of invitations expiring",
        "- Link to invitation management page",
        "- Option to bulk resend",
        "",
        "Note: Email sending requires action (external API)",
        "Consider using Resend or similar email service",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This job runs daily at 9 AM UTC. Admins can disable in org settings."
    },
    {
      "id": "US-011",
      "title": "Create scheduled job: Archive old invitations",
      "description": "As the system, I archive expired invitations older than 30 days.",
      "priority": 11,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/jobs/invitations.ts",
        "",
        "Create internal mutation: archiveOldInvitations",
        "Logic:",
        "  - Query invitations where status = 'expired' AND expiredAt < Date.now() - 30 days",
        "  - For each, create record in archivedInvitations table",
        "  - Delete from invitation table",
        "",
        "const THIRTY_DAYS_MS = 30 * 24 * 60 * 60 * 1000;",
        "",
        "export const archiveOldInvitations = internalMutation({",
        "  handler: async (ctx) => {",
        "    const cutoff = Date.now() - THIRTY_DAYS_MS;",
        "    const old = await ctx.db",
        "      .query('invitation')",
        "      .withIndex('by_status', q => q.eq('status', 'expired'))",
        "      .filter(q => q.lt(q.field('expiredAt') ?? q.field('expiresAt'), cutoff))",
        "      .collect();",
        "",
        "    for (const inv of old) {",
        "      await ctx.db.insert('archivedInvitations', {",
        "        originalInvitationId: inv._id,",
        "        organizationId: inv.organizationId,",
        "        email: inv.email,",
        "        role: inv.role,",
        "        metadata: inv.metadata,",
        "        createdAt: inv.createdAt,",
        "        expiredAt: inv.expiredAt ?? inv.expiresAt,",
        "        archivedAt: Date.now(),",
        "        archivedReason: 'expired_30_days',",
        "      });",
        "      await ctx.db.delete(inv._id);",
        "    }",
        "    console.log(`Archived ${old.length} old invitations`);",
        "  },",
        "});",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This job runs weekly on Sunday at 2 AM UTC."
    },
    {
      "id": "US-012",
      "title": "Create scheduled job: Cleanup archived invitations",
      "description": "As the system, I delete archived invitations older than 90 days.",
      "priority": 12,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/jobs/invitations.ts",
        "",
        "Create internal mutation: cleanupArchivedInvitations",
        "Logic:",
        "  - Query archivedInvitations where archivedAt < Date.now() - 90 days",
        "  - Delete each",
        "",
        "const NINETY_DAYS_MS = 90 * 24 * 60 * 60 * 1000;",
        "",
        "export const cleanupArchivedInvitations = internalMutation({",
        "  handler: async (ctx) => {",
        "    const cutoff = Date.now() - NINETY_DAYS_MS;",
        "    const old = await ctx.db",
        "      .query('archivedInvitations')",
        "      .withIndex('by_archived_at')",
        "      .filter(q => q.lt(q.field('archivedAt'), cutoff))",
        "      .collect();",
        "",
        "    for (const inv of old) {",
        "      await ctx.db.delete(inv._id);",
        "    }",
        "    console.log(`Deleted ${old.length} archived invitations`);",
        "  },",
        "});",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This job runs monthly on the 1st at 3 AM UTC."
    },
    {
      "id": "US-013",
      "title": "Configure crons.ts with all scheduled jobs",
      "description": "As the system, I have all scheduled jobs configured in the crons file.",
      "priority": 13,
      "passes": false,
      "acceptanceCriteria": [
        "Create or edit: packages/backend/convex/crons.ts",
        "",
        "import { cronJobs } from 'convex/server';",
        "import { internal } from './_generated/api';",
        "",
        "const crons = cronJobs();",
        "",
        "// Invitation lifecycle jobs",
        "crons.hourly('mark-expired-invitations', { minuteUTC: 0 }, internal.jobs.invitations.markExpiredInvitations);",
        "crons.daily('auto-reinvite', { hourUTC: 8, minuteUTC: 0 }, internal.jobs.invitations.processAutoReInvites);",
        "crons.daily('admin-expiration-alerts', { hourUTC: 9, minuteUTC: 0 }, internal.jobs.invitations.sendExpirationAlerts);",
        "crons.weekly('archive-old-invitations', { dayOfWeek: 'sunday', hourUTC: 2, minuteUTC: 0 }, internal.jobs.invitations.archiveOldInvitations);",
        "crons.monthly('cleanup-archived', { day: 1, hourUTC: 3, minuteUTC: 0 }, internal.jobs.invitations.cleanupArchivedInvitations);",
        "",
        "export default crons;",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types",
        "Verify crons appear in Convex dashboard after deploy"
      ],
      "notes": "Convex crons are defined declaratively. They will be registered on next deploy."
    },
    {
      "id": "US-014",
      "title": "Handle edge case: User signs up with different email than invited",
      "description": "As a user who signed up with a different email, I see a helpful message about no pending invitations.",
      "priority": 14,
      "passes": false,
      "acceptanceCriteria": [
        "When user navigates to /orgs/accept-invitation/[id] with an invitation for a different email:",
        "",
        "Edit: apps/web/src/app/orgs/accept-invitation/[invitationId]/page.tsx",
        "",
        "Check if invitation.email !== session.user.email:",
        "  - Show message: 'This invitation was sent to a different email address'",
        "  - Show the invited email (partially masked): 'Invitation for: j***@example.com'",
        "  - Suggest: 'Please sign in with the correct email address'",
        "  - Button: 'Sign Out' to allow signing in with correct account",
        "",
        "Run: npm run check-types",
        "Test: Invite user@a.com → Sign in as user@b.com → Click link → See mismatch message"
      ],
      "notes": "This prevents confusion when user has multiple email accounts."
    },
    {
      "id": "US-015",
      "title": "Handle edge case: Organization deleted during onboarding",
      "description": "As a user whose organization was deleted mid-onboarding, I see an error and am redirected.",
      "priority": 15,
      "passes": false,
      "acceptanceCriteria": [
        "In OnboardingOrchestrator and individual step components:",
        "",
        "When querying organization data, handle null case:",
        "const organization = useQuery(api.models.organizations.get, { orgId });",
        "",
        "if (organization === null) {",
        "  toast.error('This organization no longer exists');",
        "  router.push('/orgs');",
        "  return null;",
        "}",
        "",
        "Similarly for invitation acceptance:",
        "If invitation exists but organization doesn't, show:",
        "  - 'This organization no longer exists'",
        "  - Button: 'Go to Home'",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Rare edge case but should be handled gracefully."
    }
  ],
  "verificationSteps": [
    "npm run check-types",
    "npx -w packages/backend convex codegen",
    "Test error boundary with simulated error",
    "Test skip behavior for child linking (3 max)",
    "Test keyboard navigation through modals",
    "Test mobile responsive modals",
    "Verify analytics events fire in PostHog",
    "Deploy and verify crons appear in Convex dashboard",
    "Test email mismatch scenario",
    "Test deleted org scenario"
  ],
  "successCriteria": [
    "All errors show user-friendly messages with retry option",
    "Skip behavior works correctly per step type",
    "Analytics events fire at each step",
    "Help links present in all modals",
    "Keyboard navigation works throughout",
    "Screen reader tested and working",
    "Mobile modals are full-screen and usable",
    "All 5 scheduled jobs configured and running",
    "Edge cases handled gracefully"
  ]
}

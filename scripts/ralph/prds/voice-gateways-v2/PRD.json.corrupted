{
  "project": "Voice Enhance Gating-WAPP v2",
  "branchName": "feat/voice-gateways-v2",
  "description": "Comprehensive voice notes pipeline v2 with quality gates, fuzzy player matching, mobile quick review, and phased migration to claims-based architecture. Addresses Issue #423: WhatsApp gibberish detection, improved feedback loops, and enhanced player matching from WhatsApp messages.",
  "issueReference": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE1_QUALITY_GATES.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE2_MOBILE_REVIEW.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE3_V2_MIGRATION.md",
    "docs/archive/bug-fixes/ISSUE_423_WHATSAPP_QUALITY_GATES_ANALYSIS.md",
    "docs/features/MOBILE_QUICK_REVIEW_PLAN.md",
    "docs/architecture/voice-notes-pipeline-v2.md",
    "docs/architecture/whatsapp-integration-patterns.md",
    ".ruler/voice-notes-validation-patterns.md"
  ],
  "previousPhases": [],
  "currentPhase": "Phase 1 - Quality Gates & Fuzzy Matching (Parallel Execution)",
  "completedStories": [],
  "phaseStructure": {
    "approach": "Sequential phases with parallel work streams within phases",
    "phase1ParallelStreams": [
      "Stream A: Quality Gates (US-VN-001 to US-VN-004)",
      "Stream B: Fuzzy Matching (US-VN-005 to US-VN-006)"
    ],
    "phases": [
      {
        "id": 1,
        "name": "Quality Gates & Fuzzy Matching",
        "duration": "4-5 days",
        "parallelExecution": true,
        "stories": [
          "US-VN-001",
          "US-VN-002",
          "US-VN-003",
          "US-VN-004",
          "US-VN-005",
          "US-VN-006"
        ],
        "blocksPhase": 2
      },
      {
        "id": 2,
        "name": "Mobile Quick Review UI",
        "duration": "5-7 days",
        "parallelExecution": false,
        "stories": [
          "US-VN-007",
          "US-VN-008",
          "US-VN-009",
          "US-VN-010",
          "US-VN-011",
          "US-VN-012"
        ],
        "dependsOnPhase": 1,
        "blocksPhase": 3
      },
      {
        "id": 3,
        "name": "v2 Artifacts Foundation",
        "duration": "3 days",
        "parallelExecution": false,
        "stories": ["US-VN-013", "US-VN-014"],
        "dependsOnPhase": 2,
        "blocksPhase": 4
      },
      {
        "id": 4,
        "name": "Claims Extraction",
        "duration": "4 days",
        "parallelExecution": false,
        "stories": ["US-VN-015", "US-VN-016"],
        "dependsOnPhase": 3,
        "blocksPhase": 5
      },
      {
        "id": 5,
        "name": "Entity Resolution & Disambiguation",
        "duration": "4 days",
        "parallelExecution": false,
        "stories": ["US-VN-017", "US-VN-018"],
        "dependsOnPhase": 4,
        "blocksPhase": 6
      },
      {
        "id": 6,
        "name": "Drafts & Confirmation Workflow",
        "duration": "5 days",
        "parallelExecution": false,
        "stories": ["US-VN-019", "US-VN-020", "US-VN-021"],
        "dependsOnPhase": 5
      }
    ]
  },
  "featureFlags": {
    "strategy": "Multi-layered flexible control",
    "implementations": [
      {
        "layer": "Database Config",
        "table": "platformConfig",
        "key": "voice_notes_v2_enabled",
        "priority": 1,
        "description": "Global on/off switch via database"
      },
      {
        "layer": "Organization Override",
        "table": "organization",
        "field": "settings.voiceNotesVersion",
        "values": ["v1", "v2", "hybrid"],
        "priority": 2,
        "description": "Per-org control via admin UI"
      },
      {
        "layer": "Coach Beta Features",
        "table": "member",
        "field": "betaFeatures[]",
        "value": "voice_notes_v2",
        "priority": 3,
        "description": "Individual coach opt-in via profile settings"
      },
      {
        "layer": "PostHog Feature Flag",
        "flag": "voice-notes-v2-rollout",
        "priority": 4,
        "description": "A/B testing and gradual rollout (less reliable with privacy filters)",
        "usage": "Fallback for analytics and testing"
      }
    ],
    "evaluationOrder": "platformConfig â†’ organization â†’ coach â†’ posthog â†’ default (v1)"
  },
  "userStories": [
    {
      "id": "US-VN-001",
      "phase": 1,
      "stream": "A",
      "title": "Text Message Quality Gate",
      "description": "Implement pre-processing validation for WhatsApp text messages to reject empty, too short, or gibberish content before expensive AI processing.",
      "acceptanceCriteria": [
        "Backend: Create lib/messageValidation.ts in packages/backend/convex/lib/",
        "Function: validateTextMessage(text: string): MessageQualityCheck",
        "Validation checks:",
        "  1. Empty check: trimmed.length === 0 â†’ reject",
        "  2. Minimum length: trimmed.length < 10 chars â†’ reject",
        "  3. Word count: words.length < 3 â†’ reject",
        "  4. Average word length: avgWordLength > 20 or < 2 â†’ reject (gibberish detection)",
        "  5. Repeated characters: /(..)\\1{5,}/ regex â†’ reject (spam detection)",
        "Return type: { isValid: boolean, reason?: string, suggestion?: string }",
        "Integration: Add validation to processIncomingMessage in actions/whatsapp.ts",
        "Rejection flow: If !isValid, send suggestion to WhatsApp, mark message status='rejected', return early",
        "Schema: Add to whatsappMessages table:",
        "  - messageQualityCheck: v.optional(v.object({ isValid: v.boolean(), reason: v.optional(v.string()), checkedAt: v.number() }))",
        "Unit tests: Create __tests__/messageValidation.test.ts",
        "Test cases:",
        "  - Empty string â†’ rejected",
        "  - 'hi' â†’ rejected (too short)",
        "  - 'asdfjkl;' â†’ rejected (gibberish)",
        "  - 'aaaaaaaaaa' â†’ rejected (repeated chars)",
        "  - 'John did well in training today' â†’ accepted",
        "Type check passes: npm run check-types",
        "Manual WhatsApp test: Send 'hi' â†’ receives rejection message"
      ],
      "priority": 1,
      "passes": true,
      "effort": "0.5 day",
      "effortBreakdown": {
        "validation": "2h (function + return types)",
        "integration": "1h (hook into whatsapp.ts)",
        "schema": "0.5h (add quality check field)",
        "tests": "2h (unit tests + test cases)",
        "manual": "0.5h (WhatsApp testing)"
      },
      "dependencies": [],
      "files": {
        "create": [
          "packages/backend/convex/lib/messageValidation.ts",
          "packages/backend/convex/__tests__/messageValidation.test.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add messageQualityCheck to whatsappMessages)",
          "packages/backend/convex/actions/whatsapp.ts (integrate validation)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QG-001", "QG-002", "QG-003", "QG-007", "QG-008"]
      }
    },
    {
      "id": "US-VN-002",
      "phase": 1,
      "stream": "A",
      "title": "Transcript Quality Validation",
      "description": "Implement post-transcription quality validation to detect inaudible audio, gibberish transcripts, or poor-quality recordings before insight extraction.",
      "acceptanceCriteria": [
        "Backend: Add validateTranscriptQuality() to lib/messageValidation.ts",
        "Function: validateTranscriptQuality(transcript: string, audioDuration?: number): TranscriptQualityResult",
        "Return type: { isValid: boolean, confidence: number, reason?: string, suggestedAction: 'process' | 'ask_user' | 'reject' }",
        "Validation checks:",
        "  1. Empty transcript â†’ reject (confidence: 0)",
        "  2. Too short audio (<3s) + short transcript (<20 chars) â†’ reject",
        "  3. Whisper uncertainty markers check: '[inaudible]', '[music]', '[noise]', '(inaudible)', '(background noise)'",
        "     - Count uncertainty markers, calc ratio: uncertaintyCount / wordCount",
        "     - If ratio > 0.5 â†’ reject (confidence: 0.2)",
        "     - If ratio > 0.2 â†’ ask_user (confidence: 0.5)",
        "  4. Word count check: words.length < 5 â†’ reject (confidence: 0.3)",
        "  5. Average word length check: avgWordLength < 2 or > 15 â†’ ask_user (confidence: 0.2)",
        "  6. Sports context detection (confidence booster):",
        "     - Keywords: player, team, training, match, game, injury, session, practice, coach, etc.",
        "     - If hasSportsContext â†’ confidence: 0.9, else confidence: 0.6",
        "Integration: Hook into transcription completion (models/voiceNotes.ts)",
        "Create onTranscriptionComplete internal mutation:",
        "  - Run validateTranscriptQuality",
        "  - Store transcriptQuality (0-1) and transcriptValidation in voiceNote",
        "  - If suggestedAction === 'reject' â†’ mark insightsStatus='failed', don't process",
        "  - If suggestedAction === 'ask_user' â†’ mark insightsStatus='awaiting_confirmation'",
        "  - If suggestedAction === 'process' â†’ continue to insight extraction",
        "Schema: Add to voiceNotes table:",
        "  - transcriptQuality: v.optional(v.number())",
        "  - transcriptValidation: v.optional(v.object({ isValid: v.boolean(), reason: v.optional(v.string()), suggestedAction: v.union(v.literal('process'), v.literal('ask_user'), v.literal('reject')) }))",
        "Unit tests: Add to __tests__/messageValidation.test.ts",
        "Test cases:",
        "  - Empty transcript â†’ rejected",
        "  - '[inaudible] [music]' (70% uncertainty) â†’ rejected",
        "  - 'Uh... um... hi' (short, unclear) â†’ ask_user",
        "  - 'John did well in training' (sports context) â†’ accepted (0.9)",
        "  - 'The weather is nice today' (no sports) â†’ accepted (0.6)",
        "Type check passes: npm run check-types",
        "Manual test: Upload audio with background noise â†’ receives quality feedback"
      ],
      "priority": 2,
      "passes": true,
      "effort": "0.5 day",
      "effortBreakdown": {
        "validation": "2h (function + logic)",
        "integration": "1.5h (onTranscriptionComplete hook)",
        "schema": "0.5h (add quality fields)",
        "tests": "2h (unit tests)",
        "manual": "0.5h (audio testing)"
      },
      "dependencies": ["US-VN-001"],
      "files": {
        "modify": [
          "packages/backend/convex/lib/messageValidation.ts (add validateTranscriptQuality)",
          "packages/backend/convex/schema.ts (add transcriptQuality, transcriptValidation to voiceNotes)",
          "packages/backend/convex/models/voiceNotes.ts (add onTranscriptionComplete)",
          "packages/backend/convex/__tests__/messageValidation.test.ts (add transcript tests)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QG-004", "QG-005", "QG-006", "QG-008"]
      }
    },
    {
      "id": "US-VN-003",
      "phase": 1,
      "stream": "A",
      "title": "Duplicate Message Detection",
      "description": "Detect and prevent processing of duplicate WhatsApp messages (accidental sends, network retries) to avoid wasted API calls and user confusion.",
      "acceptanceCriteria": [
        "Backend: Create checkForDuplicateMessage query in models/whatsappMessages.ts",
        "Query args: { phoneNumber: v.string(), body: v.optional(v.string()), mediaContentType: v.optional(v.string()), withinMinutes: v.optional(v.number()) }",
        "Default window: 5 minutes (configurable)",
        "Query logic:",
        "  1. Get recent messages from same phone within time window",
        "  2. For text: Check if body matches exactly",
        "  3. For audio: Check if mediaContentType matches + timeDiff < 2 minutes (network retry detection)",
        "Return: { isDuplicate: boolean, originalMessageId: v.id('whatsappMessages'), timeSinceOriginal: v.number() } or null",
        "Integration: Add to processIncomingMessage in actions/whatsapp.ts",
        "Duplicate handling:",
        "  - Call checkForDuplicateMessage before storing message",
        "  - If isDuplicate: Send WhatsApp message: 'âš ï¸ I just received a similar message X seconds ago. If this is a new note, please add more details so I can tell them apart.'",
        "  - Mark message status='duplicate'",
        "  - Add duplicateOfMessageId field to message",
        "  - Return early, don't process",
        "Schema: Add to whatsappMessages table:",
        "  - isDuplicate: v.optional(v.boolean())",
        "  - duplicateOfMessageId: v.optional(v.id('whatsappMessages'))",
        "Unit tests: Create __tests__/duplicateDetection.test.ts",
        "Test cases:",
        "  - Same text twice within 2 min â†’ duplicate",
        "  - Same text after 6 min â†’ not duplicate",
        "  - Different text within 2 min â†’ not duplicate",
        "  - Audio with same type within 1 min â†’ duplicate",
        "Type check passes: npm run check-types",
        "Manual test: Send same message twice quickly â†’ second rejected as duplicate"
      ],
      "priority": 3,
      "passes": true,
      "effort": "0.5 day",
      "effortBreakdown": {
        "query": "2h (duplicate detection logic)",
        "integration": "1h (hook into whatsapp.ts)",
        "schema": "0.5h (add duplicate fields)",
        "tests": "2h (unit tests)",
        "manual": "0.5h (duplicate testing)"
      },
      "dependencies": [],
      "files": {
        "create": [
          "packages/backend/convex/__tests__/duplicateDetection.test.ts"
        ],
        "modify": [
          "packages/backend/convex/models/whatsappMessages.ts (add checkForDuplicateMessage query)",
          "packages/backend/convex/schema.ts (add isDuplicate, duplicateOfMessageId)",
          "packages/backend/convex/actions/whatsapp.ts (integrate duplicate check)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QG-007"]
      }
    },
    {
      "id": "US-VN-004",
      "phase": 1,
      "stream": "A",
      "title": "Enhanced WhatsApp Feedback Messages",
      "description": "Replace generic error messages with specific, actionable feedback based on rejection reason (empty, too short, inaudible, etc.) to improve user experience.",
      "acceptanceCriteria": [
        "Backend: Create sendDetailedFeedback() function in actions/whatsapp.ts",
        "Function signature: sendDetailedFeedback(phoneNumber: string, voiceNote: any, retryCount: number): Promise<void>",
        "Feedback categories (based on validation results):",
        "  1. Transcription failed:",
        "     'âŒ I couldn't transcribe your audio. This might be because:\\nâ€¢ Audio was too short (needs 3+ seconds)\\nâ€¢ Background noise was too loud\\nâ€¢ File format issue\\n\\nPlease try recording again in a quiet space.'",
        "  2. Transcript quality rejected:",
        "     'âŒ {reason message}.\\n\\nðŸ“ Transcript: \"{transcript.substring(0, 100)}\"\\n\\nPlease try again:\\nâ€¢ Record in a quiet place\\nâ€¢ Speak clearly for at least 5 seconds\\nâ€¢ Mention player names and what happened'",
        "     Reason messages map:",
        "       - empty_transcript: 'The audio had no speech detected.'",
        "       - too_short: 'The message was too short to analyze.'",
        "       - mostly_inaudible: 'Most of the audio was inaudible or noisy.'",
        "       - too_few_words: 'I only caught a few words.'",
        "       - suspicious_word_pattern: 'The transcription doesn't look like natural speech.'",
        "  3. Needs confirmation (unclear):",
        "     'âš ï¸ I transcribed your audio, but I'm not confident about the quality.\\n\\nðŸ“ I heard: \"{transcript.substring(0, 150)}\"\\n\\nReply:\\nâ€¢ CONFIRM to analyze it anyway\\nâ€¢ RETRY to record again\\nâ€¢ CANCEL to discard'",
        "  4. Insights extraction failed:",
        "     'âŒ I transcribed your note but couldn't extract insights.\\n\\nðŸ“ Transcript: \"{transcript.substring(0, 100)}\"\\n\\nThis might be because:\\nâ€¢ No player names were mentioned\\nâ€¢ The message wasn't about player development\\n\\nYour note is saved in the app. You can add details manually.'",
        "  5. Generic fallback (still processing):",
        "     'â³ Your note is taking longer than usual to process.\\n\\nYou can:\\nâ€¢ Check the app for updates\\nâ€¢ Wait for processing to complete (may take 1-2 minutes)\\n\\nIf this keeps happening, please report it.'",
        "Integration: Replace existing error messages in checkAndAutoApply",
        "Update checkAndAutoApply in actions/whatsapp.ts:",
        "  - Call sendDetailedFeedback instead of generic messages",
        "  - Pass voiceNote with validation results",
        "  - Use appropriate category based on status",
        "Confirmation workflow:",
        "  - If user replies 'CONFIRM' to awaiting_confirmation message â†’ mark as confirmed, process insights",
        "  - If user replies 'RETRY' â†’ ignore previous note, allow new recording",
        "  - If user replies 'CANCEL' â†’ mark as cancelled",
        "Unit tests: Add to __tests__/whatsappFeedback.test.ts",
        "Test cases:",
        "  - Empty transcript â†’ correct rejection message",
        "  - Mostly inaudible â†’ correct rejection with transcript snippet",
        "  - Needs confirmation â†’ shows CONFIRM/RETRY/CANCEL options",
        "  - No players mentioned â†’ correct insights failed message",
        "Type check passes: npm run check-types",
        "Manual test: Trigger each rejection type â†’ verify correct message received"
      ],
      "priority": 4,
      "passes": true,
      "effort": "0.5 day",
      "effortBreakdown": {
        "feedback": "2h (sendDetailedFeedback function + message templates)",
        "integration": "1.5h (replace existing messages in checkAndAutoApply)",
        "confirmation": "1h (CONFIRM/RETRY/CANCEL workflow)",
        "tests": "1.5h (unit tests)",
        "manual": "0.5h (test all feedback types)"
      },
      "dependencies": ["US-VN-001", "US-VN-002"],
      "files": {
        "create": [
          "packages/backend/convex/__tests__/whatsappFeedback.test.ts"
        ],
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (add sendDetailedFeedback, update checkAndAutoApply)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["FB-001", "FB-002", "FB-003", "FB-004", "FB-005"]
      }
    },
    {
      "id": "US-VN-005",
      "phase": 1,
      "stream": "B",
      "title": "Levenshtein Fuzzy Matching Backend",
      "description": "Implement Levenshtein distance algorithm for fuzzy player name matching to handle typos, Irish names, and phonetic variations (SeÃ¡n vs Shawn, Niamh vs Neeve).",
      "acceptanceCriteria": [
        "Backend: Create lib/stringMatching.ts in packages/backend/convex/lib/",
        "Function: levenshteinDistance(a: string, b: string): number",
        "Implementation: Standard dynamic programming algorithm",
        "  - Matrix approach: matrix[i][j] = min of:",
        "    - matrix[i-1][j-1] + (a[i] !== b[j] ? 1 : 0)  // substitution",
        "    - matrix[i][j-1] + 1  // insertion",
        "    - matrix[i-1][j] + 1  // deletion",
        "Function: levenshteinSimilarity(a: string, b: string): number",
        "  - Returns: 1 - (distance / maxLength)  // 0 = no match, 1 = exact match",
        "  - Edge cases: If a === b return 1, if either length === 0 return 0",
        "Helper: normalizeForMatching(str: string): string",
        "  - Lowercase, trim, remove diacritics (Ã© â†’ e, Ã¡ â†’ a, Ã³ â†’ o)",
        "  - Remove common prefixes: O', Mc, Mac",
        "  - Example: \"O'Brien\" â†’ \"obrien\"",
        "Unit tests: Create __tests__/stringMatching.test.ts",
        "Test cases:",
        "  - levenshteinDistance('kitten', 'sitting') === 3",
        "  - levenshteinSimilarity('SeÃ¡n', 'Shawn') >= 0.75",
        "  - levenshteinSimilarity('Niamh', 'Neeve') >= 0.50",
        "  - levenshteinSimilarity('O'Brien', 'O'Bryan') >= 0.85",
        "  - levenshteinSimilarity('PÃ¡draig', 'Paddy') >= 0.50",
        "  - normalizeForMatching('SeÃ¡n O'Brien') === 'sean obrien'",
        "Performance test: Matching 1000 names completes in <100ms",
        "Type check passes: npm run check-types"
      ],
      "priority": 5,
      "passes": true,
      "effort": "1 day",
      "effortBreakdown": {
        "algorithm": "3h (Levenshtein implementation + similarity calc)",
        "normalize": "1h (diacritics removal + prefix handling)",
        "tests": "3h (comprehensive unit tests with Irish names)",
        "performance": "1h (optimization if needed)"
      },
      "dependencies": [],
      "files": {
        "create": [
          "packages/backend/convex/lib/stringMatching.ts",
          "packages/backend/convex/__tests__/stringMatching.test.ts"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": false,
        "uatTestCases": ["FM-001", "FM-002", "FM-003", "FM-004"]
      }
    },
    {
      "id": "US-VN-006",
      "phase": 1,
      "stream": "B",
      "title": "Find Similar Players Query",
      "description": "Implement findSimilarPlayers query using Levenshtein matching to suggest player candidates for unmatched names in voice notes, with team context and recent mentions weighting.",
      "acceptanceCriteria": [
        "Backend: Add findSimilarPlayers query to models/orgPlayerEnrollments.ts",
        "Query args: { organizationId: v.string(), coachUserId: v.string(), searchName: v.string(), limit: v.optional(v.number()) }",
        "Query returns: v.array(v.object({ playerIdentityId: v.id('playerIdentities'), firstName: v.string(), lastName: v.string(), fullName: v.string(), teamName: v.optional(v.string()), ageGroup: v.optional(v.string()), similarity: v.number() }))",
        "Query logic:",
        "  1. Get players from coach's teams: Call getPlayersForCoachTeamsInternal",
        "  2. Normalize search name: searchLower = normalizeForMatching(searchName)",
        "  3. Calculate similarity for each player:",
        "     - firstNameSim = levenshteinSimilarity(searchLower, normalize(firstName))",
        "     - lastNameSim = levenshteinSimilarity(searchLower, normalize(lastName))",
        "     - fullNameSim = levenshteinSimilarity(searchLower, normalize(fullName))",
        "     - similarity = Math.max(firstNameSim, lastNameSim, fullNameSim)",
        "  4. Filter: similarity > 0.5 (configurable threshold)",
        "  5. Sort: By similarity descending",
        "  6. Limit: Default 5, max 20",
        "Context weighting (optional bonus):",
        "  - If player was mentioned in last 3 voice notes from same coach: similarity += 0.1",
        "  - If searchName includes team context (e.g., 'John from U14'): similarity += 0.15 for U14 players",
        "Index optimization: Use by_org_and_status index for initial player fetch",
        "Unit tests: Add to __tests__/playerMatching.test.ts",
        "Test cases:",
        "  - Search 'Shawn' â†’ finds 'SeÃ¡n' (0.85), 'Shane' (0.75), 'Shaun' (0.90)",
        "  - Search 'Neeve' â†’ finds 'Niamh' (0.60), 'Neve' (0.90)",
        "  - Search 'O'Brian' â†’ finds 'O'Brien' (0.95), 'O'Bryan' (0.85)",
        "  - Search 'abc123' â†’ returns empty array (no matches > 0.5)",
        "  - Limit works: limit=3 returns max 3 results",
        "Type check passes: npm run check-types",
        "Manual test: Query with known typo â†’ returns correct player suggestions"
      ],
      "priority": 6,
      "passes": true,
      "effort": "1 day",
      "effortBreakdown": {
        "query": "3h (batch fetch + similarity calc + sorting)",
        "context": "1h (recent mentions + team context weighting)",
        "optimization": "1h (index usage + performance)",
        "tests": "3h (unit tests with real scenarios)",
        "manual": "1h (query testing with coach data)"
      },
      "dependencies": ["US-VN-005"],
      "files": {
        "create": ["packages/backend/convex/__tests__/playerMatching.test.ts"],
        "modify": [
          "packages/backend/convex/models/orgPlayerEnrollments.ts (add findSimilarPlayers query)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["FM-001", "FM-002", "FM-003", "FM-004", "FM-005"]
      }
    },
    {
      "id": "US-VN-007",
      "phase": 2,
      "title": "Review Links Backend",
      "description": "Create backend infrastructure for time-limited deep links to mobile quick review pages. Generate unique 8-char codes, track expiry (48h), and provide validation queries for link access.",
      "acceptanceCriteria": [
        "Backend: Add whatsappReviewLinks table to schema.ts",
        "Schema fields:",
        "  - code: v.string() (8 alphanumeric chars, unique)",
        "  - voiceNoteId: v.id('voiceNotes')",
        "  - organizationId: v.string()",
        "  - coachUserId: v.string()",
        "  - createdAt: v.number()",
        "  - expiresAt: v.number() (48 hours from creation)",
        "  - accessedAt: v.optional(v.number())",
        "  - status: v.union('active', 'expired', 'used')",
        "  - pendingInsightsCount: v.number()",
        "  - unmatchedCount: v.number()",
        "Indexes:",
        "  - by_code: ['code']",
        "  - by_voiceNoteId: ['voiceNoteId']",
        "  - by_expiresAt_and_status: ['expiresAt', 'status']",
        "  - by_coachUserId: ['coachUserId']",
        "Backend: Create models/whatsappReviewLinks.ts",
        "Function: generateReviewLink (internalMutation)",
        "  args: { voiceNoteId, organizationId, coachUserId, pendingInsightsCount, unmatchedCount }",
        "  returns: { code: v.string(), expiresAt: v.number() }",
        "  Logic: Generate unique 8-char code, set expiresAt = now + 48h, insert record",
        "Function: getReviewLinkData (query)",
        "  args: { code: v.string() }",
        "  returns: v.union(v.null(), v.object({ voiceNoteId, organizationId, coachUserId, isExpired, createdAt, expiresAt }))",
        "  Logic: Query by code, check if Date.now() > expiresAt",
        "Function: markLinkAccessed (mutation)",
        "  args: { code: v.string() }",
        "  Logic: Update status='used', set accessedAt",
        "Helper: generateUniqueCode() function",
        "  Characters: 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789' (no ambiguous chars)",
        "  Length: 8 chars",
        "  Returns: string",
        "Unit tests: Create __tests__/whatsappReviewLinks.test.ts",
        "Test cases:",
        "  - generateReviewLink creates valid code",
        "  - getReviewLinkData returns null for invalid code",
        "  - getReviewLinkData correctly calculates isExpired",
        "  - markLinkAccessed updates status and accessedAt",
        "  - generateUniqueCode generates 8-char codes",
        "Type check passes: npm run check-types",
        "Manual test: Generate link â†’ verify in database â†’ query by code â†’ verify expiry logic"
      ],
      "priority": 7,
      "passes": true,
      "effort": "1 day",
      "effortBreakdown": {
        "schema": "1h (add whatsappReviewLinks table + indexes)",
        "mutations": "3h (generateReviewLink, markLinkAccessed)",
        "query": "2h (getReviewLinkData with expiry logic)",
        "helpers": "1h (generateUniqueCode)",
        "tests": "2h (unit tests for all functions)",
        "manual": "1h (database verification)"
      },
      "dependencies": ["US-VN-006"],
      "files": {
        "create": [
          "packages/backend/convex/models/whatsappReviewLinks.ts",
          "packages/backend/convex/__tests__/whatsappReviewLinks.test.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add whatsappReviewLinks table)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QR-003", "QR-004"]
      }
    },
    {
      "id": "US-VN-008",
      "phase": 2,
      "title": "Redirect Route",
      "description": "Create /r/[code] redirect route that validates review link codes and redirects to org-scoped review page or shows appropriate error page (expired/invalid).",
      "acceptanceCriteria": [
        "Frontend: Create apps/web/src/app/r/[code]/page.tsx",
        "Route type: Server component (async)",
        "Function: Fetch link data using fetchQuery (Convex Next.js server)",
        "  Call: api.models.whatsappReviewLinks.getReviewLinkData({ code: params.code })",
        "Validation logic:",
        "  1. If linkData === null â†’ redirect('/review-link-invalid')",
        "  2. If linkData.isExpired === true â†’ redirect('/review-link-expired')",
        "  3. Else â†’ redirect(`/orgs/${linkData.organizationId}/coach/review/${params.code}`)",
        "Frontend: Create apps/web/src/app/review-link-invalid/page.tsx",
        "  Content: Error page with message 'This review link is invalid or has been deleted.'",
        "  Action: Button to return to home",
        "Frontend: Create apps/web/src/app/review-link-expired/page.tsx",
        "  Content: Error page with message 'This review link has expired. Links are valid for 48 hours.'",
        "  Action: Button to open voice notes page",
        "Type check passes: npm run check-types",
        "Manual tests:",
        "  - Navigate to /r/VALIDCODE â†’ redirects to review page",
        "  - Navigate to /r/INVALIDCODE â†’ shows invalid page",
        "  - Navigate to /r/EXPIREDCODE â†’ shows expired page",
        "Visual verification with dev-browser on mobile viewport (375x667)"
      ],
      "priority": 8,
      "passes": true,
      "effort": "0.5 day",
      "effortBreakdown": {
        "redirect": "1h (redirect route logic)",
        "errorPages": "2h (invalid + expired pages)",
        "styling": "1h (mobile-responsive error pages)",
        "manual": "0.5h (test all redirect scenarios)"
      },
      "dependencies": ["US-VN-007"],
      "files": {
        "create": [
          "apps/web/src/app/r/[code]/page.tsx",
          "apps/web/src/app/review-link-invalid/page.tsx",
          "apps/web/src/app/review-link-expired/page.tsx"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QR-003", "QR-004"]
      }
    },
    {
      "id": "US-VN-009",
      "phase": 2,
      "title": "Quick Review Page",
      "description": "Create mobile-optimized quick review page at /orgs/[orgId]/coach/review/[code] with collapsible sections for voice note context, needs review, unmatched, and auto-applied insights.",
      "acceptanceCriteria": [
        "Frontend: Create apps/web/src/app/orgs/[orgId]/coach/review/[code]/page.tsx",
        "Client component (use 'use client')",
        "Hooks:",
        "  - useQuery: getReviewLinkData({ code })",
        "  - useQuery: getVoiceNoteById({ noteId: linkData.voiceNoteId }) (skip if no linkData)",
        "  - useQuery: getVoiceNotesByCoach({ orgId, coachId }) (skip if no linkData) - for other pending count",
        "  - useMutation: markLinkAccessed({ code })",
        "useEffect: Mark link as accessed on first load (if valid and not expired)",
        "Loading state: Show <QuickReviewSkeleton /> while linkData === undefined",
        "Error states:",
        "  - linkData === null â†’ <LinkInvalidView />",
        "  - linkData.isExpired â†’ <LinkExpiredView orgId={orgId} />",
        "Categorize insights:",
        "  - needsReview: status='pending' && playerIdentityId exists",
        "  - unmatched: status='pending' && playerName exists && !playerIdentityId",
        "  - autoApplied: status='applied'",
        "Calculate otherPendingCount:",
        "  - Filter allNotes where _id !== linkData.voiceNoteId",
        "  - Sum pending + unmatched counts across other notes",
        "Layout: max-w-lg container, mobile-first (min-h-screen bg-background)",
        "Components:",
        "  - <QuickReviewHeader onClose={() => router.push(...)} />",
        "  - <VoiceNoteContext voiceNote={voiceNote} defaultCollapsed={true} />",
        "  - <NeedsReviewSection insights={needsReview} voiceNoteId={linkData.voiceNoteId} /> (if needsReview.length > 0)",
        "  - <UnmatchedSection insights={unmatched} ... /> (if unmatched.length > 0)",
        "  - <AutoAppliedSection insights={autoApplied} defaultCollapsed={true} /> (if autoApplied.length > 0)",
        "  - All done message (if needsReview.length === 0 && unmatched.length === 0)",
        "  - <OtherPendingPrompt count={otherPendingCount} onViewAll={...} /> (if otherPendingCount > 0)",
        "Responsive: Touch targets â‰¥44px, large text for mobile",
        "Dark mode support: Use semantic color tokens (bg-background, text-foreground)",
        "Type check passes: npm run check-types",
        "Manual test: Open link on mobile â†’ verify all sections render",
        "Visual verification with dev-browser: Test on 375x667 viewport"
      ],
      "priority": 9,
      "passes": true,
      "effort": "2 days",
      "effortBreakdown": {
        "page": "4h (main review page logic + data fetching)",
        "components": "6h (stub components: header, context, sections)",
        "styling": "3h (mobile-responsive layout)",
        "states": "2h (loading, error, empty states)",
        "manual": "1h (mobile testing)"
      },
      "dependencies": ["US-VN-008"],
      "files": {
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/page.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/quick-review-header.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/voice-note-context.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/needs-review-section.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/unmatched-section.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/auto-applied-section.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/other-pending-prompt.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/link-expired-view.tsx",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/quick-review-skeleton.tsx"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QR-001", "QR-002", "QR-005", "QR-006"]
      }
    },
    {
      "id": "US-VN-010",
      "phase": 2,
      "title": "Unmatched Player Cards",
      "description": "Build unmatched player card component that uses Phase 1 fuzzy matching to show player suggestions with similarity scores, radio selection, and assign/search actions.",
      "acceptanceCriteria": [
        "Frontend: Create apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/unmatched-player-card.tsx",
        "Client component (use 'use client')",
        "Props: { insight: { id, playerName, title, description, category }, voiceNoteId, organizationId, coachUserId }",
        "Hooks:",
        "  - useQuery: api.models.orgPlayerEnrollments.findSimilarPlayers",
        "    args: { organizationId, coachUserId, searchName: insight.playerName, limit: 4 }",
        "  - useMutation: api.models.voiceNotes.assignPlayerToInsight",
        "  - useState: selectedPlayerId, isAssigning, showSearch",
        "UI Structure:",
        "  1. Header: 'â“ \"{playerName}\" not found' + insight title",
        "  2. Suggestions section (if suggestions.length > 0):",
        "     - Label: 'Did you mean?'",
        "     - RadioGroup with suggestions:",
        "       - Each item: RadioGroupItem + player name + team + similarity %",
        "       - Last item: 'Someone else...' (value='other')",
        "  3. No suggestions message (if suggestions.length === 0)",
        "  4. Actions:",
        "     - If selected && not 'other': <Button onClick={handleAssign}>Assign & Apply</Button>",
        "     - If selected === 'other' || no suggestions: <Button onClick={() => setShowSearch(true)}>Search Players</Button>",
        "handleAssign function:",
        "  - setIsAssigning(true)",
        "  - Call assignPlayerToInsight mutation",
        "  - Handle success/error",
        "  - setIsAssigning(false)",
        "Styling:",
        "  - Border: 2px border-amber-200",
        "  - Background: bg-amber-50",
        "  - Text: text-amber-900 (headers), text-amber-700 (body)",
        "  - Suggestions: bg-white border p-2 rounded",
        "Similarity display: Math.round(player.similarity * 100) + '%'",
        "Type check passes: npm run check-types",
        "Integration: Import into UnmatchedSection component",
        "Manual tests:",
        "  - Card displays for unmatched insight",
        "  - Fuzzy suggestions shown with similarity scores",
        "  - Radio selection works",
        "  - Assign button calls mutation",
        "  - 'Someone else' shows search option",
        "Visual verification: Test on mobile viewport with dev-browser"
      ],
      "priority": 10,
      "passes": true,
      "effort": "1.5 days",
      "effortBreakdown": {
        "component": "4h (card structure + fuzzy query integration)",
        "ui": "3h (RadioGroup, suggestions list, styling)",
        "actions": "2h (assign mutation + state management)",
        "styling": "2h (mobile-responsive + amber theme)",
        "manual": "1h (test all scenarios)"
      },
      "dependencies": ["US-VN-009", "US-VN-006"],
      "files": {
        "create": [
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/unmatched-player-card.tsx"
        ],
        "modify": [
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/unmatched-section.tsx (import UnmatchedPlayerCard)"
        ]
      },
      "testingRequirements": {
        "unitTests": false,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QR-002", "QR-007", "QR-008", "FM-005"]
      }
    },
    {
      "id": "US-VN-011",
      "phase": 2,
      "title": "Trust-Adaptive Messages",
      "description": "Update WhatsApp message formatting to adapt based on coach trust level - from detailed breakdowns (TL0-1) to compact summaries (TL2) to success-focused messages (TL3+).",
      "acceptanceCriteria": [
        "Backend: Update formatResultsMessage in actions/whatsapp.ts",
        "Function signature: formatResultsMessage(results: ProcessingResults, trustLevel: number, reviewLinkCode?: string): string",
        "Trust Level 0-1 (New Coach):",
        "  Header: 'Analysis complete!'",
        "  Format: 'âš ï¸ Needs review ({count}): ...'",
        "  Format: 'â“ Unmatched ({count}): ...'",
        "  Link: 'Quick review: {siteUrl}/r/{code}' + '(Link expires in 48h)'",
        "Trust Level 2 (Established Coach):",
        "  Header: 'Analysis complete!'",
        "  Format: 'âœ… Auto-applied ({count}): {names.slice(0,3).join(', ')}{more}'",
        "  Format: 'âš ï¸ Needs review ({count}): {items.slice(0,2)}{more}'",
        "  Format: 'â“ Unmatched ({count}): {names.slice(0,2)}{more}'",
        "  Link: 'Quick review: {siteUrl}/r/{code}'",
        "Trust Level 3 (Trusted Coach, All Applied):",
        "  Header: 'âœ… All applied!' (if needsReview.length === 0)",
        "  Format: 'Auto-applied ({count}): {names.slice(0,3)}{more}'",
        "  Format: 'ðŸ“¤ Parent updates queued ({count})' (if applicable)",
        "  Link: 'View details: {siteUrl}/r/{code}'",
        "Compact summary logic:",
        "  - autoApplied: Show first 3 names + '+N more' if > 3",
        "  - needsReview: Show first 2 items with category + '+N more' if > 2",
        "  - unmatched: Show first 2 quoted names + '+N more' if > 2",
        "Emojis: âœ… (applied), âš ï¸ (needs review), â“ (unmatched), ðŸ“¤ (queued)",
        "formatCategory helper: Map category to short label (injury â†’ 'Injury', performance â†’ 'Performance')",
        "Integration: Call formatResultsMessage from checkAndAutoApply",
        "  - Pass trustLevel from coach record",
        "  - Pass reviewLinkCode if generated",
        "Unit tests: Add to __tests__/whatsappFeedback.test.ts",
        "Test cases:",
        "  - TL0 formats with detailed breakdown",
        "  - TL2 formats with compact summary",
        "  - TL3 formats with success message (all applied)",
        "  - '+N more' appended when > limit",
        "  - Link text varies by trust level",
        "Type check passes: npm run check-types",
        "Manual test: Send voice note with different trust levels â†’ verify message format"
      ],
      "priority": 11,
      "passes": true,
      "effort": "0.5 day",
      "effortBreakdown": {
        "formatting": "2h (trust-adaptive message templates)",
        "compact": "1.5h (compact summary logic + truncation)",
        "integration": "1h (update checkAndAutoApply call sites)",
        "tests": "1h (unit tests for all trust levels)",
        "manual": "0.5h (WhatsApp testing)"
      },
      "dependencies": ["US-VN-007"],
      "files": {
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (update formatResultsMessage)",
          "packages/backend/convex/__tests__/whatsappFeedback.test.ts (add trust-adaptive tests)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QR-009", "QR-010", "FB-001"]
      }
    },
    {
      "id": "US-VN-012",
      "phase": 2,
      "title": "Link Expiry & Cleanup",
      "description": "Implement scheduled cleanup job to delete expired review links (>7 days old) and ensure proper expiry handling in UI.",
      "acceptanceCriteria": [
        "Backend: Add cleanupExpiredLinks to models/whatsappReviewLinks.ts",
        "Function: cleanupExpiredLinks (internalMutation)",
        "  args: {}",
        "  returns: v.object({ deleted: v.number() })",
        "  Logic:",
        "    - Calculate cutoff: now - 7 * 24 * 60 * 60 * 1000 (7 days ago)",
        "    - Query whatsappReviewLinks.withIndex('by_expiresAt_and_status')",
        "    - Filter: q.lt(q.field('expiresAt'), cutoff)",
        "    - Delete each record",
        "    - Return count deleted",
        "Backend: Create or update convex/crons.ts",
        "  Import: import { cronJobs } from 'convex/server'",
        "  Import: import { internal } from './_generated/api'",
        "  Schedule: crons.daily('cleanup-expired-review-links', { hourUTC: 3, minuteUTC: 0 }, internal.models.whatsappReviewLinks.cleanupExpiredLinks)",
        "  Export: export default crons",
        "Frontend: LinkExpiredView already created in US-VN-009",
        "  Verify: Shows 'â° Link Expired' message",
        "  Verify: Shows 'Links are valid for 48 hours' explanation",
        "  Verify: Button redirects to /orgs/{orgId}/coach/voice-notes?tab=insights",
        "Unit tests: Add to __tests__/whatsappReviewLinks.test.ts",
        "Test cases:",
        "  - cleanupExpiredLinks deletes links expired > 7 days",
        "  - cleanupExpiredLinks does not delete recent links",
        "  - cleanupExpiredLinks returns correct count",
        "Type check passes: npm run check-types",
        "Manual test:",
        "  - Create link with expiresAt = 8 days ago",
        "  - Run cron manually (Convex dashboard)",
        "  - Verify link deleted",
        "  - Navigate to expired link â†’ verify LinkExpiredView shows"
      ],
      "priority": 12,
      "passes": true,
      "effort": "0.5 day",
      "effortBreakdown": {
        "mutation": "1.5h (cleanupExpiredLinks logic)",
        "cron": "1h (cron setup + scheduling)",
        "tests": "1.5h (unit tests for cleanup)",
        "manual": "0.5h (test cron execution)"
      },
      "dependencies": ["US-VN-007", "US-VN-009"],
      "files": {
        "create": ["packages/backend/convex/crons.ts (if doesn't exist)"],
        "modify": [
          "packages/backend/convex/models/whatsappReviewLinks.ts (add cleanupExpiredLinks)",
          "packages/backend/convex/crons.ts (add cleanup job, if exists)",
          "packages/backend/convex/__tests__/whatsappReviewLinks.test.ts (add cleanup tests)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": ["QR-003"]
      }
    },
    {
      "id": "US-VN-013",
      "phase": 3,
      "title": "Artifacts & Transcripts Tables",
      "description": "Create v2 foundation tables (voiceNoteArtifacts, voiceNoteTranscripts) to support source-agnostic voice note processing with detailed transcription metadata.",
      "acceptanceCriteria": [
        "Backend: Add voiceNoteArtifacts table to schema.ts",
        "Schema fields:",
        "  - artifactId: v.string() (UUID)",
        "  - sourceChannel: v.union('whatsapp_audio', 'whatsapp_text', 'app_recorded', 'app_typed')",
        "  - senderUserId: v.string()",
        "  - senderRole: v.union('coach', 'parent', 'admin', 'player')",
        "  - threadId: v.optional(v.string())",
        "  - threadType: v.optional(v.union('individual', 'group'))",
        "  - orgContextCandidates: v.array(v.object({ orgId: v.string(), orgName: v.string(), confidence: v.number(), source: v.string() }))",
        "  - mediaStorageId: v.optional(v.id('_storage'))",
        "  - textContent: v.optional(v.string())",
        "  - noteType: v.union('training', 'match', 'general')",
        "  - status: v.union('received', 'transcribing', 'transcribed', 'extracting_claims', 'claims_extracted', 'resolving', 'drafts_ready', 'awaiting_confirmation', 'partially_confirmed', 'completed', 'failed', 'cancelled')",
        "  - voiceNoteId: v.optional(v.id('voiceNotes')) (backward compat)",
        "  - receivedAt: v.number()",
        "  - transcribedAt: v.optional(v.number())",
        "  - claimsExtractedAt: v.optional(v.number())",
        "  - completedAt: v.optional(v.number())",
        "  - lastError: v.optional(v.string())",
        "  - retryCount: v.optional(v.number())",
        "Indexes:",
        "  - by_sender: ['senderUserId']",
        "  - by_status: ['status']",
        "  - by_thread: ['threadId']",
        "  - by_voiceNoteId: ['voiceNoteId']",
        "Backend: Add voiceNoteTranscripts table to schema.ts",
        "Schema fields:",
        "  - artifactId: v.id('voiceNoteArtifacts')",
        "  - fullText: v.string()",
        "  - segments: v.array(v.object({ text: v.string(), startTime: v.number(), endTime: v.number(), confidence: v.number() }))",
        "  - modelUsed: v.string() ('whisper-1', 'deepgram-nova-3')",
        "  - language: v.string()",
        "  - duration: v.number()",
        "  - createdAt: v.number()",
        "Indexes:",
        "  - by_artifact: ['artifactId']",
        "Backend: Create models/voiceNoteArtifacts.ts",
        "Function: create (internalMutation) - Create artifact record",
        "Function: linkToVoiceNote (internalMutation) - Link artifact to v1 voice note",
        "Function: updateStatus (internalMutation) - Update artifact status",
        "Backend: Create models/voiceNoteTranscripts.ts",
        "Function: create (internalMutation) - Store transcript with segments",
        "Function: getByArtifactId (query) - Get transcript for artifact",
        "Type check passes: npm run check-types",
        "Run codegen: npx -w packages/backend convex codegen",
        "Manual test: Create artifact record â†’ verify in Convex dashboard â†’ link to voice note â†’ verify backward compat"
      ],
      "priority": 13,
      "passes": true,
      "effort": "1.5 days",
      "effortBreakdown": {
        "schema": "3h (add both tables + indexes)",
        "artifacts": "2h (voiceNoteArtifacts CRUD functions)",
        "transcripts": "2h (voiceNoteTranscripts CRUD functions)",
        "tests": "3h (unit tests for both tables)",
        "manual": "1h (database verification)"
      },
      "dependencies": ["US-VN-012"],
      "files": {
        "create": [
          "packages/backend/convex/models/voiceNoteArtifacts.ts",
          "packages/backend/convex/models/voiceNoteTranscripts.ts",
          "packages/backend/convex/__tests__/voiceNoteArtifacts.test.ts",
          "packages/backend/convex/__tests__/voiceNoteTranscripts.test.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add voiceNoteArtifacts, voiceNoteTranscripts tables)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-014",
      "phase": 3,
      "title": "Dual-Path Processing",
      "description": "Implement feature flag evaluation and dual-path processing to route voice notes through v1 or v2 pipeline based on platform config, org settings, or coach beta features.",
      "acceptanceCriteria": [
        "Backend: Create lib/featureFlags.ts",
        "Function: shouldUseV2Pipeline (internal helper)",
        "  args: { ctx: ActionCtx, orgId: v.string(), coachId: v.string() }",
        "  returns: Promise<boolean>",
        "  Logic:",
        "    1. Check platformConfig.get({ key: 'voice_notes_v2_enabled' }) â†’ if false return false, if true return true",
        "    2. Check organization settings: org.settings?.voiceNotesVersion === 'v2' â†’ return true, === 'v1' â†’ return false",
        "    3. Check coach betaFeatures: coach.betaFeatures?.includes('voice_notes_v2') â†’ return true",
        "    4. Default: return false (use v1)",
        "Backend: Update actions/whatsapp.ts - processIncomingMessage",
        "  Add: const useV2 = await shouldUseV2Pipeline(ctx, orgId, coachId)",
        "  Branch:",
        "    if (useV2) {",
        "      // v2 path: Create artifact",
        "      const artifactId = await ctx.runMutation(internal.models.voiceNoteArtifacts.create, { ... })",
        "      // Still create v1 voice note for backward compat",
        "      const voiceNoteId = await ctx.runMutation(api.models.voiceNotes.createRecordedNote, { ... })",
        "      // Link them",
        "      await ctx.runMutation(internal.models.voiceNoteArtifacts.linkToVoiceNote, { artifactId, voiceNoteId })",
        "    } else {",
        "      // v1 path: Existing flow (unchanged)",
        "      const voiceNoteId = await ctx.runMutation(api.models.voiceNotes.createRecordedNote, { ... })",
        "    }",
        "Backend: Add platformConfig table (if doesn't exist) to schema.ts",
        "  Fields: key: v.string(), value: v.any(), updatedAt: v.number()",
        "  Index: by_key: ['key']",
        "Backend: Create models/platformConfig.ts (if doesn't exist)",
        "  Function: get (query) - Get config value by key",
        "  Function: set (mutation) - Set config value (platform staff only)",
        "Unit tests: Create __tests__/featureFlags.test.ts",
        "Test cases:",
        "  - Platform config overrides org/coach settings",
        "  - Org setting 'v2' enables v2",
        "  - Coach beta feature enables v2",
        "  - Default returns false (v1)",
        "Type check passes: npm run check-types",
        "Manual test:",
        "  - Enable v2 for test coach â†’ send voice note â†’ verify artifact created",
        "  - Disable v2 â†’ send voice note â†’ verify only v1 voice note created"
      ],
      "priority": 14,
      "passes": true,
      "effort": "1.5 days",
      "effortBreakdown": {
        "featureFlags": "3h (shouldUseV2Pipeline logic)",
        "dualPath": "4h (update processIncomingMessage)",
        "platformConfig": "2h (add table + CRUD if needed)",
        "tests": "2h (unit tests for feature flags)",
        "manual": "1h (test v1/v2 routing)"
      },
      "dependencies": ["US-VN-013"],
      "files": {
        "create": [
          "packages/backend/convex/lib/featureFlags.ts",
          "packages/backend/convex/__tests__/featureFlags.test.ts",
          "packages/backend/convex/models/platformConfig.ts (if doesn't exist)"
        ],
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (add dual-path processing)",
          "packages/backend/convex/schema.ts (add platformConfig table if doesn't exist)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-015",
      "phase": 4,
      "title": "Claims Table & Extraction",
      "description": "Create voiceNoteClaims table and implement GPT-4 claim extraction to segment transcripts into atomic claims (one per player mention) with structured metadata.",
      "acceptanceCriteria": [
        "Backend: Add voiceNoteClaims table to schema.ts",
        "Schema fields:",
        "  - claimId: v.string() (UUID)",
        "  - artifactId: v.id('voiceNoteArtifacts')",
        "  - sourceText: v.string() (utterance)",
        "  - timestampStart: v.optional(v.number())",
        "  - timestampEnd: v.optional(v.number())",
        "  - topic: v.union('injury', 'wellbeing', 'performance', 'attendance', 'skill', 'behavior', 'team_culture', 'todo', 'general')",
        "  - timeReference: v.optional(v.string()) ('today', 'yesterday')",
        "  - timeResolved: v.optional(v.string()) (ISO date)",
        "  - entityMentions: v.array(v.object({ mentionType: v.union('player_name', 'player_nickname', 'player_number', 'team_name', 'group_reference', 'coach_name'), rawText: v.string(), position: v.number() }))",
        "  - severity: v.optional(v.union('low', 'medium', 'high', 'critical'))",
        "  - sentiment: v.optional(v.union('positive', 'neutral', 'negative', 'concerned'))",
        "  - extractionConfidence: v.number() (0-1)",
        "  - status: v.union('extracted', 'resolving', 'resolved', 'needs_disambiguation', 'merged', 'discarded')",
        "  - createdAt: v.number()",
        "Indexes:",
        "  - by_artifact: ['artifactId']",
        "  - by_topic: ['topic']",
        "  - by_status: ['status']",
        "Backend: Create actions/claimsExtraction.ts",
        "Function: extractClaims (action)",
        "  args: { artifactId: v.id('voiceNoteArtifacts') }",
        "  returns: v.object({ claims: v.array(v.object({ claimId: v.string(), sourceText: v.string(), topic: v.string() })) })",
        "  Logic:",
        "    1. Get transcript from voiceNoteTranscripts",
        "    2. Call GPT-4 with prompt: 'Segment this coach's voice note into atomic claims (one per player/team mentioned)'",
        "    3. Parse JSON response",
        "    4. Insert claims into voiceNoteClaims",
        "    5. Update artifact status to 'claims_extracted'",
        "    6. Return claims summary",
        "GPT-4 Prompt Template:",
        "  System: 'You are a sports coaching assistant. Segment voice notes into atomic claims.'",
        "  User: 'Transcript: {fullText}\\n\\nReturn JSON array of claims with: sourceText, topic, entityMentions, sentiment, confidence'",
        "  Response format: [{ sourceText: '...', topic: 'performance', entityMentions: [...], sentiment: 'positive' }]",
        "Integration: Call extractClaims from processIncomingMessage (v2 path only)",
        "  After: Transcription complete",
        "  Call: await ctx.runAction(internal.actions.claimsExtraction.extractClaims, { artifactId })",
        "Unit tests: Create __tests__/claimsExtraction.test.ts",
        "Test cases:",
        "  - Single player mention â†’ 1 claim",
        "  - Two players mentioned â†’ 2 claims",
        "  - Group reference ('the twins') â†’ 1 claim with group_reference mention",
        "  - Claim has correct topic (injury, performance, etc.)",
        "  - Confidence scores calculated",
        "Type check passes: npm run check-types",
        "Manual test: Send voice note mentioning 2 players â†’ verify 2 claims created"
      ],
      "priority": 15,
      "passes": true,
      "effort": "2 days",
      "effortBreakdown": {
        "schema": "2h (add voiceNoteClaims table + indexes)",
        "extraction": "6h (GPT-4 prompt engineering + parsing)",
        "integration": "2h (hook into v2 pipeline)",
        "tests": "4h (unit tests for extraction)",
        "manual": "2h (test multi-player scenarios)"
      },
      "dependencies": ["US-VN-014"],
      "files": {
        "create": [
          "packages/backend/convex/actions/claimsExtraction.ts",
          "packages/backend/convex/__tests__/claimsExtraction.test.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add voiceNoteClaims table)",
          "packages/backend/convex/actions/whatsapp.ts (call extractClaims in v2 path)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-016",
      "phase": 4,
      "title": "Claim Processing Integration",
      "description": "Integrate claim extraction into v2 pipeline with status tracking, error handling, and automatic progression from transcription to claims to resolution.",
      "acceptanceCriteria": [
        "Backend: Update actions/whatsapp.ts - v2 path in processIncomingMessage",
        "  After transcription:",
        "    1. Update artifact status to 'extracting_claims'",
        "    2. Call extractClaims action",
        "    3. If successful: Update artifact status to 'claims_extracted', set claimsExtractedAt",
        "    4. If failed: Update artifact status to 'failed', set lastError, increment retryCount",
        "Backend: Create internal mutation: triggerClaimExtraction",
        "  args: { artifactId: v.id('voiceNoteArtifacts') }",
        "  Logic: Schedule extractClaims action (use ctx.scheduler.runAfter)",
        "  Returns: void",
        "Backend: Add retry logic for failed claim extraction",
        "  Function: retryFailedClaimExtraction (scheduled function)",
        "  Query: Get artifacts with status='failed' and retryCount < 3",
        "  Action: Call extractClaims again, increment retryCount",
        "  Schedule: Run every 5 minutes",
        "Backend: Update artifact status progression",
        "  received â†’ transcribing â†’ transcribed â†’ extracting_claims â†’ claims_extracted â†’ resolving",
        "Monitoring: Log claim extraction metrics",
        "  - Claims extracted per artifact",
        "  - Extraction duration",
        "  - Confidence scores distribution",
        "  - Failure rate",
        "Error handling:",
        "  - GPT-4 API timeout â†’ retry with exponential backoff",
        "  - Invalid JSON response â†’ log error, mark as failed",
        "  - No claims extracted â†’ log warning, continue (empty claims array)",
        "Unit tests: Add to __tests__/claimsExtraction.test.ts",
        "Test cases:",
        "  - Status progression works correctly",
        "  - Retry logic triggers for failed extractions",
        "  - Error handling logs errors properly",
        "  - Empty transcript â†’ no claims, but doesn't fail",
        "Type check passes: npm run check-types",
        "Manual test:",
        "  - Send voice note â†’ verify status: received â†’ transcribing â†’ transcribed â†’ extracting_claims â†’ claims_extracted",
        "  - Simulate GPT-4 failure â†’ verify retry logic"
      ],
      "priority": 16,
      "passes": true,
      "effort": "2 days",
      "effortBreakdown": {
        "integration": "4h (hook into v2 pipeline with status updates)",
        "retry": "3h (retry logic + scheduling)",
        "monitoring": "2h (logging + metrics)",
        "errorHandling": "3h (timeout handling + validation)",
        "tests": "3h (integration tests)",
        "manual": "1h (end-to-end testing)"
      },
      "dependencies": ["US-VN-015"],
      "files": {
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (integrate claim extraction)",
          "packages/backend/convex/models/voiceNoteArtifacts.ts (add status update helpers)",
          "packages/backend/convex/__tests__/claimsExtraction.test.ts (add integration tests)"
        ],
        "create": [
          "packages/backend/convex/lib/retryLogic.ts (retry utilities)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": true,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-017",
      "phase": 5,
      "title": "Entity Resolution Table",
      "description": "Create voiceNoteEntityResolutions table to store fuzzy match candidates for each entity mention in claims, enabling disambiguation workflow.",
      "acceptanceCriteria": [
        "Backend: Add voiceNoteEntityResolutions table to schema.ts",
        "Schema fields:",
        "  - claimId: v.id('voiceNoteClaims')",
        "  - mentionIndex: v.number() (which mention in the claim)",
        "  - rawText: v.string() (as spoken)",
        "  - mentionType: v.string() ('player_name', 'group_reference', etc.)",
        "  - candidates: v.array(v.object({ entityType: v.union('player', 'team', 'coach'), entityId: v.string(), entityName: v.string(), orgId: v.string(), teamId: v.optional(v.string()), score: v.number(), matchReason: v.string() }))",
        "  - status: v.union('auto_resolved', 'needs_disambiguation', 'user_resolved', 'unresolved', 'new_entity')",
        "  - resolvedEntityId: v.optional(v.string())",
        "  - resolvedEntityType: v.optional(v.string())",
        "  - resolvedOrgId: v.optional(v.string())",
        "  - resolvedAt: v.optional(v.number())",
        "  - resolvedBy: v.optional(v.string()) (userId if user resolved)",
        "  - createdAt: v.number()",
        "Indexes:",
        "  - by_claim: ['claimId']",
        "  - by_status: ['status']",
        "  - by_resolved_entity: ['resolvedEntityId']",
        "Backend: Create models/voiceNoteEntityResolutions.ts",
        "Function: create (internalMutation)",
        "  args: { claimId, mentionIndex, rawText, mentionType, candidates, status }",
        "  Logic: Insert resolution record, return resolutionId",
        "Function: resolve (mutation)",
        "  args: { claimId, mentionIndex, resolvedEntityId, resolvedBy }",
        "  Logic: Update status='user_resolved', set resolvedEntityId, resolvedAt, resolvedBy",
        "Function: getByClaimId (query)",
        "  args: { claimId }",
        "  returns: Array of resolutions for claim",
        "Function: getNeedsDisambiguation (query)",
        "  args: { artifactId }",
        "  returns: Array of resolutions with status='needs_disambiguation'",
        "Unit tests: Create __tests__/voiceNoteEntityResolutions.test.ts",
        "Test cases:",
        "  - Create resolution with candidates",
        "  - Resolve sets correct fields",
        "  - Query by claim returns all resolutions",
        "  - Query needs_disambiguation filters correctly",
        "Type check passes: npm run check-types",
        "Manual test: Create claim â†’ create resolution with candidates â†’ verify in database"
      ],
      "priority": 17,
      "passes": true,
      "effort": "2 days",
      "effortBreakdown": {
        "schema": "2h (add voiceNoteEntityResolutions table + indexes)",
        "crud": "4h (create, resolve, query functions)",
        "tests": "4h (unit tests for all functions)",
        "integration": "3h (hook into claims processing)",
        "manual": "1h (database verification)"
      },
      "dependencies": ["US-VN-016"],
      "files": {
        "create": [
          "packages/backend/convex/models/voiceNoteEntityResolutions.ts",
          "packages/backend/convex/__tests__/voiceNoteEntityResolutions.test.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add voiceNoteEntityResolutions table)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-018",
      "phase": 5,
      "title": "Disambiguation UI",
      "description": "Create disambiguation UI for coaches to resolve ambiguous player mentions (e.g., 'the twins') from WhatsApp messages or web interface.",
      "acceptanceCriteria": [
        "Backend: Create actions/entityResolution.ts",
        "Function: resolveEntityMentions (action)",
        "  args: { artifactId: v.id('voiceNoteArtifacts') }",
        "  Logic:",
        "    1. Get all claims for artifact",
        "    2. For each claim.entityMentions:",
        "       - If mentionType === 'player_name': Call findSimilarPlayers from Phase 1",
        "       - Store candidates in voiceNoteEntityResolutions",
        "       - If single high-confidence match (score > 0.9): status='auto_resolved'",
        "       - If multiple candidates (score > 0.5): status='needs_disambiguation'",
        "       - If no candidates: status='unresolved'",
        "    3. Update artifact status to 'resolving' â†’ 'drafts_ready'",
        "Integration: Call resolveEntityMentions after claims_extracted",
        "WhatsApp Disambiguation Flow:",
        "  Message format:",
        "    'I captured 4 updates:',
        "    '1. Ella - hamstring tightness âœ…',",
        "    '2. Aoife - felt anxious âœ…',",
        "    '3. Saoirse - missed training âœ…',",
        "    '4. \"The twins\" - â“ I\\'m not sure which players',",
        "    '',",
        "    'Reply:',",
        "    'â€¢ CONFIRM 1,2,3 to save those',",
        "    'â€¢ TWINS = Emma & Niamh to identify',",
        "    'â€¢ CANCEL to discard'",
        "Backend: Update actions/whatsapp.ts",
        "Function: parseDisambiguationCommand",
        "  args: { messageBody: v.string() }",
        "  returns: { command: 'CONFIRM' | 'CANCEL' | 'IDENTIFY', items?: number[], identifications?: { mention: string, playerNames: string[] } }",
        "  Examples:",
        "    'CONFIRM 1,2,3' â†’ { command: 'CONFIRM', items: [1,2,3] }",
        "    'TWINS = Emma and Niamh' â†’ { command: 'IDENTIFY', identifications: { mention: 'TWINS', playerNames: ['Emma', 'Niamh'] } }",
        "Function: handleDisambiguation (action)",
        "  Logic: Process IDENTIFY command â†’ resolve entities â†’ create drafts",
        "Frontend: Create web disambiguation UI (optional for Phase 5)",
        "  Component: apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/disambiguation-card.tsx",
        "  Props: { claim, resolution, onResolve }",
        "  UI: Show mention + candidates â†’ user picks â†’ calls resolve mutation",
        "Unit tests: Create __tests__/entityResolution.test.ts",
        "Test cases:",
        "  - Single high-confidence match â†’ auto_resolved",
        "  - Multiple candidates â†’ needs_disambiguation",
        "  - No candidates â†’ unresolved",
        "  - parseDisambiguationCommand handles all formats",
        "Type check passes: npm run check-types",
        "Manual test:",
        "  - Send voice note with 'the twins' â†’ verify disambiguation prompt",
        "  - Reply 'TWINS = Emma and Niamh' â†’ verify resolution",
        "  - Verify web UI shows disambiguation cards"
      ],
      "priority": 18,
      "passes": true,
      "effort": "2 days",
      "effortBreakdown": {
        "resolution": "4h (resolveEntityMentions action using Phase 1 fuzzy matching)",
        "whatsapp": "3h (parseDisambiguationCommand + handleDisambiguation)",
        "webUI": "4h (disambiguation card component - optional)",
        "tests": "3h (unit tests for resolution + parsing)",
        "manual": "2h (test WhatsApp + web flows)"
      },
      "dependencies": ["US-VN-017", "US-VN-006"],
      "files": {
        "create": [
          "packages/backend/convex/actions/entityResolution.ts",
          "packages/backend/convex/__tests__/entityResolution.test.ts",
          "apps/web/src/app/orgs/[orgId]/coach/review/[code]/components/disambiguation-card.tsx (optional)"
        ],
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (add parseDisambiguationCommand, handleDisambiguation)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-019",
      "phase": 6,
      "title": "Drafts Table & Creation",
      "description": "Create insightDrafts table and implement draft creation from resolved claims, replacing immediate auto-apply with confirmation-based workflow.",
      "acceptanceCriteria": [
        "Backend: Add insightDrafts table to schema.ts",
        "Schema fields:",
        "  - draftId: v.string() (UUID)",
        "  - artifactId: v.id('voiceNoteArtifacts')",
        "  - claimId: v.id('voiceNoteClaims')",
        "  - playerIdentityId: v.optional(v.id('playerIdentities'))",
        "  - playerName: v.optional(v.string())",
        "  - teamId: v.optional(v.string())",
        "  - teamName: v.optional(v.string())",
        "  - orgId: v.string()",
        "  - insightType: v.union('injury', 'wellbeing', 'performance', 'attendance', 'skill_rating', 'skill_progress', 'behavior', 'team_culture', 'todo')",
        "  - title: v.string()",
        "  - description: v.string()",
        "  - recommendedAction: v.optional(v.string())",
        "  - evidence: v.object({ transcriptSnippet: v.string(), timestampStart: v.optional(v.number()), timestampEnd: v.optional(v.number()), audioClipStorageId: v.optional(v.id('_storage')) })",
        "  - aiConfidence: v.number() (from claim extraction)",
        "  - resolutionConfidence: v.number() (from entity resolution)",
        "  - overallConfidence: v.number() (combined score)",
        "  - requiresConfirmation: v.boolean()",
        "  - confirmationReason: v.optional(v.string())",
        "  - status: v.union('pending', 'confirmed', 'edited', 'rejected', 'auto_applied', 'applied', 'failed')",
        "  - confirmedAt: v.optional(v.number())",
        "  - confirmedBy: v.optional(v.string())",
        "  - editedContent: v.optional(v.object({ title: v.optional(v.string()), description: v.optional(v.string()), playerIdentityId: v.optional(v.id('playerIdentities')) }))",
        "  - rejectionReason: v.optional(v.string())",
        "  - appliedAt: v.optional(v.number())",
        "  - appliedToRecordId: v.optional(v.string())",
        "  - appliedToTable: v.optional(v.string())",
        "  - createdAt: v.number()",
        "  - updatedAt: v.number()",
        "Indexes:",
        "  - by_artifact: ['artifactId']",
        "  - by_player: ['playerIdentityId']",
        "  - by_org: ['orgId']",
        "  - by_status: ['status']",
        "  - by_requires_confirmation: ['requiresConfirmation']",
        "Backend: Create models/insightDrafts.ts",
        "Function: createFromClaim (internalMutation)",
        "  args: { claim, resolution, aiConfidence, resolutionConfidence }",
        "  Logic:",
        "    - Calculate overallConfidence = (aiConfidence + resolutionConfidence) / 2",
        "    - Determine requiresConfirmation: overallConfidence < 0.8 OR topic in ['injury', 'wellbeing']",
        "    - Generate title, description from claim.sourceText",
        "    - Insert draft record",
        "Function: confirm (mutation)",
        "  args: { draftId, confirmedBy }",
        "  Logic: Update status='confirmed', set confirmedAt, confirmedBy",
        "Function: reject (mutation)",
        "  args: { draftId, rejectionReason }",
        "  Logic: Update status='rejected', set rejectionReason",
        "Function: apply (internalMutation)",
        "  args: { draftId }",
        "  Logic: Apply insight to player record, update status='applied', set appliedAt, appliedToRecordId",
        "Function: getByArtifactId (query)",
        "  args: { artifactId }",
        "  returns: Array of drafts",
        "Integration: Call createFromClaim after entity resolution complete",
        "  For each resolved claim â†’ create draft",
        "  Update artifact status to 'drafts_ready' â†’ 'awaiting_confirmation'",
        "Unit tests: Create __tests__/insightDrafts.test.ts",
        "Test cases:",
        "  - createFromClaim calculates confidence correctly",
        "  - requiresConfirmation set based on confidence + topic",
        "  - confirm updates status and timestamps",
        "  - reject sets rejection reason",
        "  - apply creates player record entry",
        "Type check passes: npm run check-types",
        "Manual test: Resolve claim â†’ create draft â†’ verify in database â†’ confirm â†’ verify applied"
      ],
      "priority": 19,
      "passes": true,
      "effort": "2 days",
      "effortBreakdown": {
        "schema": "2h (add insightDrafts table + indexes)",
        "crud": "5h (createFromClaim, confirm, reject, apply)",
        "confidence": "2h (confidence calculation logic)",
        "tests": "4h (unit tests for all functions)",
        "integration": "2h (hook into v2 pipeline)",
        "manual": "1h (end-to-end testing)"
      },
      "dependencies": ["US-VN-018"],
      "files": {
        "create": [
          "packages/backend/convex/models/insightDrafts.ts",
          "packages/backend/convex/__tests__/insightDrafts.test.ts"
        ],
        "modify": [
          "packages/backend/convex/schema.ts (add insightDrafts table)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-020",
      "phase": 6,
      "title": "WhatsApp Confirmation Commands",
      "description": "Implement WhatsApp command parsing for CONFIRM/CANCEL/EDIT/TWINS commands to enable coaches to confirm, reject, or edit drafts directly from WhatsApp.",
      "acceptanceCriteria": [
        "Backend: Update actions/whatsapp.ts",
        "Function: parseConfirmationCommand",
        "  args: { messageBody: v.string() }",
        "  returns: { command: 'CONFIRM' | 'CANCEL' | 'EDIT' | 'IDENTIFY', items?: number[], edits?: { item: number, changes: object }, identifications?: object }",
        "  Examples:",
        "    'CONFIRM 1,2,3' â†’ { command: 'CONFIRM', items: [1,2,3] }",
        "    'CONFIRM ALL' â†’ { command: 'CONFIRM', items: 'all' }",
        "    'CANCEL' â†’ { command: 'CANCEL' }",
        "    'EDIT 2: more severe' â†’ { command: 'EDIT', edits: { item: 2, changes: { description: 'more severe' } } }",
        "    'TWINS = Emma & Niamh' â†’ { command: 'IDENTIFY', identifications: { mention: 'TWINS', playerNames: ['Emma', 'Niamh'] } }",
        "Function: handleConfirmationCommand (action)",
        "  args: { artifactId, command, items, edits, identifications }",
        "  Logic:",
        "    CONFIRM:",
        "      - Get drafts by artifactId",
        "      - Filter: items array or all if 'all'",
        "      - Call confirm mutation for each",
        "      - Call apply mutation for each confirmed",
        "      - Send WhatsApp summary: 'âœ… Saved N updates'",
        "    CANCEL:",
        "      - Call reject mutation for all drafts",
        "      - Send WhatsApp: 'âŒ Cancelled all updates'",
        "    EDIT:",
        "      - Get draft by item number",
        "      - Update editedContent with changes",
        "      - Send WhatsApp: 'âœï¸ Updated item N. Reply CONFIRM to save.'",
        "    IDENTIFY:",
        "      - Resolve entity mentions (call handleDisambiguation from US-VN-018)",
        "      - Create drafts for resolved entities",
        "      - Send updated draft list",
        "Integration: Add to processIncomingMessage",
        "  Check if message is command (starts with CONFIRM/CANCEL/EDIT/TWINS)",
        "  If command: Parse and handle, return early (don't process as new voice note)",
        "WhatsApp Response Messages:",
        "  CONFIRM success: 'âœ… Saved {count} updates\\n\\nUpdated players: {names}'",
        "  CANCEL: 'âŒ Cancelled all updates'",
        "  EDIT success: 'âœï¸ Updated item {n}. Reply CONFIRM to save.'",
        "  IDENTIFY success: 'âœ… {mention} = {playerNames}\\n\\n[Updated draft list]'",
        "  Error: 'âŒ I didn\\'t understand that command. Try:\\nâ€¢ CONFIRM 1,2,3\\nâ€¢ CANCEL\\nâ€¢ EDIT 2: description\\nâ€¢ TWINS = Emma & Niamh'",
        "Unit tests: Add to __tests__/whatsappFeedback.test.ts",
        "Test cases:",
        "  - parseConfirmationCommand handles all command types",
        "  - CONFIRM applies drafts",
        "  - CANCEL rejects all drafts",
        "  - EDIT updates draft content",
        "  - IDENTIFY resolves entities",
        "  - Invalid command returns error message",
        "Type check passes: npm run check-types",
        "Manual test:",
        "  - Send voice note â†’ receive draft list",
        "  - Reply 'CONFIRM 1,2' â†’ verify drafts applied",
        "  - Reply 'CANCEL' â†’ verify drafts rejected",
        "  - Reply 'EDIT 1: new description' â†’ verify draft updated",
        "  - Reply 'TWINS = Emma and Niamh' â†’ verify disambiguation resolved"
      ],
      "priority": 20,
      "passes": true,
      "effort": "2 days",
      "effortBreakdown": {
        "parsing": "3h (parseConfirmationCommand with regex patterns)",
        "handling": "5h (handleConfirmationCommand for all command types)",
        "messages": "2h (WhatsApp response templates)",
        "integration": "2h (hook into processIncomingMessage)",
        "tests": "3h (unit tests for parsing + handling)",
        "manual": "1h (WhatsApp end-to-end testing)"
      },
      "dependencies": ["US-VN-019"],
      "files": {
        "modify": [
          "packages/backend/convex/actions/whatsapp.ts (add parseConfirmationCommand, handleConfirmationCommand)",
          "packages/backend/convex/__tests__/whatsappFeedback.test.ts (add command parsing tests)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    },
    {
      "id": "US-VN-021",
      "phase": 6,
      "title": "Migration Script",
      "description": "Create bulk migration script to migrate historical v1 voiceNotes to v2 architecture (artifacts, transcripts, claims, drafts) for data consistency and v2 rollout.",
      "acceptanceCriteria": [
        "Backend: Create scripts/migrations/voice-notes-to-v2.ts",
        "Script args: { dryRun: boolean, batchSize: number, startDate?: string, endDate?: string }",
        "Migration logic:",
        "  1. Query voiceNotes with pagination (batchSize)",
        "  2. For each voiceNote:",
        "     a. Create voiceNoteArtifact:",
        "        - artifactId: generate UUID",
        "        - sourceChannel: map from voiceNote.source",
        "        - senderUserId: voiceNote.coachId",
        "        - mediaStorageId: voiceNote.audioFileId",
        "        - noteType: voiceNote.noteType",
        "        - status: 'completed' (already processed)",
        "        - voiceNoteId: voiceNote._id (link)",
        "        - createdAt: voiceNote.createdAt",
        "     b. Create voiceNoteTranscript (if transcript exists):",
        "        - artifactId: from step a",
        "        - fullText: voiceNote.transcript",
        "        - segments: [] (no segments in v1)",
        "        - modelUsed: 'whisper-1'",
        "        - duration: voiceNote.audioDuration",
        "     c. Create voiceNoteClaims (best effort from insights):",
        "        - For each voiceNote.insights: Create claim",
        "        - sourceText: insight.description",
        "        - topic: map insight.category to topic",
        "        - entityMentions: [{ mentionType: 'player_name', rawText: insight.playerName }]",
        "        - status: 'resolved' (already processed)",
        "     d. Create insightDrafts (from insights):",
        "        - Map each insight to draft",
        "        - status: 'applied' (if insight.status === 'applied')",
        "        - playerIdentityId: insight.playerIdentityId",
        "        - appliedAt: insight.appliedAt",
        "  3. Track migration progress: { total, migrated, failed, errors[] }",
        "  4. Log results to file: scripts/migrations/voice-notes-migration-{timestamp}.log",
        "Error handling:",
        "  - Wrap each voiceNote migration in try/catch",
        "  - Log errors to migration log",
        "  - Continue to next voiceNote",
        "  - Return summary: { success: number, failed: number, errors: [] }",
        "Dry run mode:",
        "  - If dryRun: Log what would be migrated, don't insert records",
        "  - Output: 'DRY RUN: Would migrate {count} voice notes'",
        "Date filtering:",
        "  - If startDate/endDate provided: Filter voiceNotes by createdAt",
        "  - Allows incremental migration",
        "CLI command: npm run migrate:voice-notes-to-v2 -- --dry-run",
        "CLI args:",
        "  - --dry-run: Preview migration",
        "  - --batch-size=100: Process in batches",
        "  - --start-date=2025-01-01: Filter start date",
        "  - --end-date=2026-01-01: Filter end date",
        "Unit tests: Create __tests__/voiceNotesMigration.test.ts",
        "Test cases:",
        "  - Single voiceNote migrates correctly",
        "  - Transcript created if exists",
        "  - Claims created from insights",
        "  - Drafts map status correctly",
        "  - Error handling logs errors",
        "  - Dry run doesn't insert records",
        "Type check passes: npm run check-types",
        "Manual test:",
        "  - Run with --dry-run on small dataset â†’ verify output",
        "  - Run migration on 10 voice notes â†’ verify all records created",
        "  - Check Convex dashboard for migrated data",
        "Documentation: Add migration guide to docs/development/migration-guides.md"
      ],
      "priority": 21,
      "passes": true,
      "effort": "1 day",
      "effortBreakdown": {
        "script": "4h (migration logic + batch processing)",
        "errorHandling": "2h (try/catch + logging)",
        "cli": "1h (CLI args + command setup)",
        "tests": "2h (unit tests for migration)",
        "manual": "1h (test on real data)",
        "docs": "0.5h (migration guide)"
      },
      "dependencies": ["US-VN-019"],
      "files": {
        "create": [
          "scripts/migrations/voice-notes-to-v2.ts",
          "packages/backend/convex/__tests__/voiceNotesMigration.test.ts"
        ],
        "modify": [
          "package.json (add migrate:voice-notes-to-v2 script)",
          "docs/development/migration-guides.md (add v2 migration guide)"
        ]
      },
      "testingRequirements": {
        "unitTests": true,
        "integrationTests": false,
        "manualTesting": true,
        "uatTestCases": []
      }
    }
  ],
  "phase1Checklist": [
    "âœ… Create directory: scripts/ralph/prds/voice-gateways-v2/",
    "â¬œ Stream A (Quality Gates): Start US-VN-001",
    "â¬œ Stream B (Fuzzy Matching): Start US-VN-005 (parallel with Stream A)",
    "â¬œ US-VN-001: Create lib/messageValidation.ts",
    "â¬œ US-VN-001: Implement validateTextMessage function",
    "â¬œ US-VN-001: Add messageQualityCheck to whatsappMessages schema",
    "â¬œ US-VN-001: Integrate validation in processIncomingMessage",
    "â¬œ US-VN-001: Write unit tests (__tests__/messageValidation.test.ts)",
    "â¬œ US-VN-001: Manual WhatsApp testing (send 'hi' â†’ rejected)",
    "â¬œ US-VN-002: Add validateTranscriptQuality to messageValidation.ts",
    "â¬œ US-VN-002: Add transcriptQuality fields to voiceNotes schema",
    "â¬œ US-VN-002: Create onTranscriptionComplete hook",
    "â¬œ US-VN-002: Write unit tests for transcript validation",
    "â¬œ US-VN-002: Manual audio testing (background noise â†’ rejected)",
    "â¬œ US-VN-003: Create checkForDuplicateMessage query",
    "â¬œ US-VN-003: Add isDuplicate fields to whatsappMessages schema",
    "â¬œ US-VN-003: Integrate duplicate check in processIncomingMessage",
    "â¬œ US-VN-003: Write unit tests (__tests__/duplicateDetection.test.ts)",
    "â¬œ US-VN-003: Manual duplicate testing (send twice â†’ second rejected)",
    "â¬œ US-VN-004: Create sendDetailedFeedback function",
    "â¬œ US-VN-004: Add all feedback message templates",
    "â¬œ US-VN-004: Implement CONFIRM/RETRY/CANCEL workflow",
    "â¬œ US-VN-004: Replace generic errors in checkAndAutoApply",
    "â¬œ US-VN-004: Write unit tests (__tests__/whatsappFeedback.test.ts)",
    "â¬œ US-VN-004: Manual testing (trigger each rejection type)",
    "â¬œ US-VN-005: Create lib/stringMatching.ts",
    "â¬œ US-VN-005: Implement levenshteinDistance algorithm",
    "â¬œ US-VN-005: Implement levenshteinSimilarity function",
    "â¬œ US-VN-005: Add normalizeForMatching helper (diacritics, prefixes)",
    "â¬œ US-VN-005: Write unit tests (__tests__/stringMatching.test.ts)",
    "â¬œ US-VN-005: Test Irish names (SeÃ¡n, Niamh, PÃ¡draig, O'Brien)",
    "â¬œ US-VN-005: Performance test (1000 names < 100ms)",
    "â¬œ US-VN-006: Add findSimilarPlayers query to orgPlayerEnrollments.ts",
    "â¬œ US-VN-006: Implement batch fetch + similarity calculation",
    "â¬œ US-VN-006: Add context weighting (recent mentions, team context)",
    "â¬œ US-VN-006: Write unit tests (__tests__/playerMatching.test.ts)",
    "â¬œ US-VN-006: Manual testing with coach data",
    "â¬œ Merge Stream A and Stream B",
    "â¬œ Run npm run check-types (0 errors)",
    "â¬œ Run all unit tests (100% passing)",
    "â¬œ Manual UAT: QG-001 through QG-008",
    "â¬œ Manual UAT: FB-001 through FB-005",
    "â¬œ Manual UAT: FM-001 through FM-005",
    "â¬œ Commit: 'feat(voice-notes): Phase 1 - Quality Gates & Fuzzy Matching'",
    "â¬œ Phase 1 Complete âœ…"
  ],
  "successCriteria": {
    "phase1Complete": {
      "productionReady": true,
      "criteria": [
        "Quality gates reject gibberish text messages",
        "Quality gates reject poor-quality audio transcripts",
        "Duplicate messages detected and rejected within 5 minutes",
        "Detailed error messages sent to WhatsApp (not generic)",
        "CONFIRM/RETRY/CANCEL workflow functional",
        "Levenshtein algorithm correctly calculates similarity",
        "Irish names handled (SeÃ¡n, Niamh, O'Brien, etc.)",
        "findSimilarPlayers returns top 5 candidates with scores > 0.5",
        "Context weighting boosts recently mentioned players",
        "All unit tests passing (100% coverage for validation logic)",
        "Type check passes (0 TypeScript errors)",
        "Manual UAT complete: 18 test cases passing",
        "Documentation updated in .ruler/voice-notes-validation-patterns.md",
        "Performance: Player matching < 100ms for 1000 players",
        "WhatsApp feedback tested manually for all rejection types",
        "No regressions: Existing voice notes flow still works"
      ]
    }
  },
  "mandatoryPatterns": [
    "ALWAYS use Better Auth IDs as v.string() not v.id()",
    "ALWAYS include args and returns validators on ALL queries/mutations",
    "ALWAYS use composite indexes for multi-field queries (never .filter() after .withIndex())",
    "ALWAYS use batch fetch with Map lookup to avoid N+1 queries",
    "ALWAYS normalize strings before matching (lowercase, trim, remove diacritics)",
    "ALWAYS provide specific error messages (not 'Something went wrong')",
    "ALWAYS validate input at entry points (WhatsApp webhook, API endpoints)",
    "ALWAYS write unit tests for validation logic (100% coverage)",
    "ALWAYS use early return pattern for rejection (validate â†’ reject â†’ process)",
    "ALWAYS log rejection reasons for analytics",
    "COPY Levenshtein implementation from MOBILE_QUICK_REVIEW_PLAN.md (don't reinvent)",
    "NEVER process messages without quality checks (waste of API calls)",
    "NEVER use exact string matching for player names (always fuzzy)",
    "NEVER send generic error messages to WhatsApp users"
  ],
  "integrationPoints": {
    "qualityGates": {
      "purpose": "Prevent wasted API calls on low-quality messages",
      "entry": "packages/backend/convex/actions/whatsapp.ts - processIncomingMessage",
      "validates": ["text messages", "audio transcripts"],
      "rejects": ["empty", "too short", "gibberish", "duplicates"],
      "feedback": "sendDetailedFeedback function sends specific WhatsApp messages"
    },
    "fuzzyMatching": {
      "purpose": "Improve player name resolution from voice notes",
      "entry": "packages/backend/convex/models/orgPlayerEnrollments.ts - findSimilarPlayers",
      "uses": "levenshteinSimilarity from lib/stringMatching.ts",
      "threshold": 0.5,
      "returns": "Top 5 candidates with similarity scores"
    },
    "notifications": {
      "purpose": "Alert coaches when quick review ready (Phase 2)",
      "events": [
        "voice_note_analysis_complete",
        "unmatched_players_found",
        "quick_review_link_generated"
      ],
      "channels": ["WhatsApp", "Push (future)", "Email (future)"]
    }
  },
  "effortSummary": {
    "phase1": {
      "streamA": {
        "US-VN-001": "0.5 day",
        "US-VN-002": "0.5 day",
        "US-VN-003": "0.5 day",
        "US-VN-004": "0.5 day",
        "subtotal": "2 days"
      },
      "streamB": {
        "US-VN-005": "1 day",
        "US-VN-006": "1 day",
        "subtotal": "2 days"
      },
      "parallelTotal": "2 days (streams run concurrently)",
      "mergeAndTest": "0.5 day",
      "total": "2.5 days"
    },
    "totalProject": "25-30 days (6 phases)",
    "breakdown": {
      "phase1": "2.5 days (quality gates + fuzzy matching)",
      "phase2": "5-7 days (mobile quick review)",
      "phase3": "3 days (v2 artifacts)",
      "phase4": "4 days (claims extraction)",
      "phase5": "4 days (entity resolution)",
      "phase6": "5 days (drafts & confirmation)",
      "testing": "1.5 days (distributed across phases)"
    }
  },
  "ralphInstructions": {
    "executionMode": "sequential-phases-parallel-streams",
    "phase1Approach": "Execute Stream A and Stream B in parallel, merge when both complete",
    "testingStrategy": "Unit tests required for all validation logic, manual UAT for WhatsApp flows",
    "qualityCriteria": "Type check must pass, 0 new TypeScript errors, all unit tests passing",
    "documentationRequired": true,
    "quickActionsAvailable": true
  }
}

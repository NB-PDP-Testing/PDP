{
  "project": "Coach-Parent AI Summaries - Phase 6.2 (Graceful Degradation)",
  "branchName": "ralph/coach-parent-summaries-p6-phase2",
  "description": "Circuit breaker pattern for AI service failures with graceful fallback and user-facing degradation notices.",
  "philosophyAndGoals": {
    "corePhilosophy": "Fail gracefully. Never show errors when AI is down. Degrade service, not experience.",
    "keyPrinciples": [
      "Circuit breaker: Stop calling failing APIs after threshold",
      "Fallback templates: Send simple messages when AI unavailable",
      "Transparency: Tell users when AI is degraded",
      "Self-healing: Auto-recover when service restores",
      "Zero user errors: Coach always gets outcome, even if fallback"
    ],
    "successMetrics": {
      "zeroErrors": "No user-facing errors when Anthropic API down",
      "fastFailover": "Circuit opens within 5 failures",
      "autoRecovery": "Circuit closes within 1 minute of service restoration",
      "userAwareness": "Degradation banner shows within 30 seconds of circuit opening"
    }
  },
  "dependencies": {
    "requiredPhases": [
      "Phase 6.1 - Cost Controls (US-001 to US-011)",
      "Phase 5 Phases 1-4 - ALL COMPLETE AND MERGED TO MAIN (PR #331)",
      "processVoiceNoteInsight action exists in actions/coachParentSummaries.ts",
      "generateParentSummary and classifyInsightSensitivity actions exist",
      "Coach Settings Dialog exists (PR #332) - components/profile/coach-settings-dialog.tsx"
    ],
    "requiredFiles": [
      "actions/coachParentSummaries.ts - Where AI calls happen",
      "components/profile/coach-settings-dialog.tsx - Optional degradation indicator"
    ],
    "newInfrastructure": [
      "aiServiceHealth table - Service health tracking (singleton)",
      "lib/circuitBreaker.ts - Circuit breaker logic",
      "components/coach/degradation-banner.tsx - UI component",
      "models/aiServiceHealth.ts - Health queries"
    ]
  },
  "userStories": [
    {
      "id": "US-012",
      "title": "Add aiServiceHealth table to schema",
      "description": "As the system, I track AI service health.",
      "phase": "6.2: Graceful Degradation",
      "acceptanceCriteria": [
        "Add aiServiceHealth table to schema.ts (singleton pattern): service (v.literal('anthropic')), status (v.union: 'healthy' | 'degraded' | 'down'), lastSuccessAt (number), lastFailureAt (number), recentFailureCount (number), failureWindow (number, default 5 minutes), circuitBreakerState (v.union: 'closed' | 'open' | 'half_open'), lastCheckedAt (number)",
        "No indexes needed (singleton - only one record)",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Circuit breaker pattern. Track service health. If failure rate exceeds threshold, open circuit (stop calling API). Prevents cascading failures."
    },
    {
      "id": "US-013",
      "title": "Implement circuit breaker logic",
      "description": "As the system, I detect and react to API degradation.",
      "acceptanceCriteria": [
        "Create lib/circuitBreaker.ts",
        "Export function shouldCallAPI(serviceHealth): boolean",
        "If circuitBreakerState === 'open': return false (don't call API)",
        "If circuitBreakerState === 'half_open': allow 1 test call to check if service recovered",
        "If circuitBreakerState === 'closed': return true (normal operation)",
        "Export function recordAPIResult(success: boolean): updates failure counts, state transitions",
        "State transitions: closed → open (5 failures in 5 min), open → half_open (after 1 min cooldown), half_open → closed (success) or open (failure)",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Self-healing. If API is down, open circuit after 5 failures. Wait 1 min, try one call. If succeeds, close circuit. If fails, wait another minute."
    },
    {
      "id": "US-014",
      "title": "Integrate circuit breaker into AI actions",
      "description": "As the system, degraded service triggers graceful fallback.",
      "acceptanceCriteria": [
        "Edit generateParentSummary and classifyInsightSensitivity actions in actions/coachParentSummaries.ts",
        "Before Anthropic API call: check shouldCallAPI(serviceHealth)",
        "If false: return fallback response with isFallback flag",
        "Wrap Anthropic API call in try-catch: on success recordAPIResult(true), on error recordAPIResult(false) and return fallback",
        "Fallback for generateParentSummary: return template-based summary 'Your coach shared an update about {player}. View details in passport.'",
        "Fallback for classifyInsightSensitivity: return { category: 'normal', confidence: 0.5, isFallback: true }",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Fail gracefully. If AI is down, send simple template message instead of failing. Parent still gets notified, coach still approves. Better than nothing."
    },
    {
      "id": "US-015",
      "title": "Add degradation notice to coach UI",
      "description": "As a coach, I'm informed when AI is degraded.",
      "acceptanceCriteria": [
        "Create components/coach/degradation-banner.tsx",
        "Props: { degradationType: 'ai_fallback' | 'rate_limited' | 'budget_exceeded' }",
        "Show contextual banner: 'AI assistance temporarily unavailable. Using simplified summaries. Service typically recovers within 5 minutes.'",
        "Different messages for each degradationType",
        "Import Alert, AlertDescription from @/components/ui/alert",
        "Warning icon and amber styling",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Transparency. Don't hide degradation. Explain what's happening, set expectations. Better than silent failures or confusing behavior. Coach Settings Dialog integration optional."
    },
    {
      "id": "US-016",
      "title": "Show degradation banner in voice notes dashboard",
      "description": "As a coach, degradation status is visible.",
      "acceptanceCriteria": [
        "Edit voice-notes-dashboard.tsx",
        "Add query: getAIServiceHealth (create in models/aiServiceHealth.ts if needed)",
        "If status !== 'healthy': render DegradationBanner with appropriate type",
        "Position below header, above tabs",
        "Automatically dismisses when service recovers (query updates real-time)",
        "OPTIONAL: Also integrate degradation indicator in Coach Settings Dialog (components/profile/coach-settings-dialog.tsx) - small warning badge if AI degraded",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Real-time feedback. Convex real-time queries mean banner appears/disappears automatically as service status changes. No page refresh needed."
    }
  ],
  "testingStrategy": {
    "circuitBreaker": {
      "failureDetection": [
        "Simulate Anthropic API failure (invalid API key in test)",
        "Make 5 consecutive AI calls",
        "Verify circuit opens after 5th failure",
        "Verify circuitBreakerState === 'open' in aiServiceHealth"
      ],
      "fallbackBehavior": [
        "With circuit open, generate summary",
        "Verify template message returned (not AI-generated)",
        "Verify isFallback flag set to true",
        "Verify parent still gets notification"
      ],
      "autoRecovery": [
        "With circuit open, wait 1 minute",
        "Verify circuit transitions to 'half_open'",
        "Restore API key, make test call",
        "Verify circuit closes on success",
        "Verify AI generation resumes normally"
      ]
    },
    "userInterface": {
      "degradationBanner": [
        "Open circuit (simulate API failure)",
        "Open voice notes dashboard as coach",
        "Verify degradation banner visible",
        "Verify message explains AI unavailable",
        "Restore service, verify banner disappears"
      ],
      "realTimeUpdates": [
        "Open dashboard in browser",
        "Trigger circuit open (different tab/API)",
        "Verify banner appears without page refresh",
        "Restore service, verify banner disappears without refresh"
      ]
    }
  },
  "performanceTargets": {
    "circuitBreakerCheck": "< 5ms (in-memory state check)",
    "fallbackGeneration": "< 10ms (simple template interpolation)",
    "healthQueryLatency": "< 50ms (single record query)"
  },
  "rollbackPlan": {
    "circuitBreaker": "Use admin dashboard 'Force Reset' button to manually close circuit",
    "degradationBanners": "Remove components if causing UI issues, fallback behavior still works"
  }
}

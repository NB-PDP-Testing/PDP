{
  "project": "Coach-Parent AI Summaries - Phase 6 (Scale, Monitoring & Safeguards)",
  "branchName": "ralph/coach-parent-summaries-p6",
  "description": "Production-ready monitoring, cost controls, rate limiting, graceful degradation, and admin tools. Depends on Phase 5.",
  "philosophyAndGoals": {
    "corePhilosophy": "Scale safely. Monitor everything. Fail gracefully. Give admins control. Never surprise users with costs or outages.",
    "keyPrinciples": [
      "Observability: Track every AI call, every cost, every failure",
      "Cost controls: Per-org and platform-wide spending limits",
      "Graceful degradation: AI down? Fall back to manual review, not errors",
      "Rate limiting: Prevent runaway costs from bugs or abuse",
      "Admin visibility: Platform staff see health at a glance",
      "Emergency controls: Master kill switch for AI features"
    ],
    "successMetrics": {
      "monitoring": "100% of AI calls logged with cost breakdown",
      "alerting": "Platform staff alerted within 1 min if costs spike 3x",
      "degradation": "Zero user-facing errors if Anthropic API is down",
      "costControl": "No org exceeds budget without explicit override",
      "visibility": "Admin dashboard shows health in <2 sec"
    }
  },
  "industryResearch": {
    "anthropicAdminAPI": "Admin API provides usage tracking, cost monitoring, rate limits",
    "stripeCircuitBreaker": "Detects degradation via error rate increase, gracefully falls back",
    "netflixChaosEngineering": "Intentionally break services to test degradation paths",
    "datadogMonitoring": "Track p50, p95, p99 latency; alert on anomalies",
    "awsCostExplorer": "Cost allocation tags per org, budget alerts, usage forecasting"
  },
  "implementationOrder": [
    "Phase 1: Cost Monitoring & Alerts (Week 1) - Stories US-001 to US-006",
    "Phase 2: Rate Limiting & Quotas (Week 2) - Stories US-007 to US-011",
    "Phase 3: Graceful Degradation (Week 3) - Stories US-012 to US-016",
    "Phase 4: Admin Dashboard & Controls (Week 4) - Stories US-017 to US-022"
  ],
  "dependencies": {
    "requiredPhases": ["Phase 5 - aiUsageLog table must exist"],
    "requiredTables": [
      "aiUsageLog - Tracks every AI call with tokens and cost",
      "coachParentSummaries - Has all automation fields",
      "coachTrustLevels - Platform-wide trust tracking"
    ],
    "newInfrastructure": [
      "Cost alerting system (scheduled functions)",
      "Rate limiting middleware",
      "Circuit breaker pattern for API failures",
      "Platform admin dashboard pages"
    ]
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Add orgCostBudgets table to schema",
      "description": "As a platform admin, I set cost budgets per organization.",
      "phase": "1: Cost Monitoring",
      "acceptanceCriteria": [
        "Add orgCostBudgets table to schema.ts: organizationId (string), dailyBudgetUsd (number), monthlyBudgetUsd (number), alertThresholdPercent (number, default 80), isEnabled (boolean)",
        "Add fields: currentDailySpend (number), currentMonthlySpend (number), lastResetDate (string YYYY-MM-DD), lastResetMonth (string YYYY-MM)",
        "Add index: by_org (organizationId)",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "notes": "Per-org budgets prevent runaway costs. alertThresholdPercent triggers warning emails at 80% by default. Daily resets at midnight UTC, monthly at month start."
    },
    {
      "id": "US-002",
      "title": "Add platformCostAlerts table to schema",
      "description": "As a platform admin, cost alerts are logged and tracked.",
      "acceptanceCriteria": [
        "Add platformCostAlerts table to schema.ts: alertType (v.union: 'org_daily_threshold' | 'org_daily_exceeded' | 'org_monthly_threshold' | 'org_monthly_exceeded' | 'platform_spike'), organizationId (optional string), severity (v.union: 'warning' | 'critical'), message (string), triggerValue (number), thresholdValue (number), timestamp (number), acknowledged (boolean), acknowledgedBy (optional string), acknowledgedAt (optional number)",
        "Add indexes: by_timestamp (timestamp), by_org (organizationId), by_severity_ack (severity, acknowledged)",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 2,
      "passes": false,
      "notes": "Audit trail for all cost alerts. Platform staff can see alert history, acknowledge alerts to dismiss from dashboard. severity determines urgency."
    },
    {
      "id": "US-003",
      "title": "Implement checkOrgCostBudget query",
      "description": "As the system, I check if org is within budget before AI calls.",
      "acceptanceCriteria": [
        "Create models/orgCostBudgets.ts",
        "Add checkOrgCostBudget query with args: organizationId",
        "Fetch budget record via by_org index",
        "If no budget set: return { withinBudget: true, reason: 'no_budget_set' }",
        "Check currentDailySpend < dailyBudgetUsd and currentMonthlySpend < monthlyBudgetUsd",
        "If exceeded: return { withinBudget: false, reason: 'daily_exceeded' or 'monthly_exceeded', remaining: 0 }",
        "If within budget: return { withinBudget: true, dailyRemaining, monthlyRemaining }",
        "Returns: v.object({ withinBudget: v.boolean(), reason: v.string(), dailyRemaining: v.optional(v.number()), monthlyRemaining: v.optional(v.number()) })",
        "Typecheck passes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Called before processVoiceNoteInsight action. Prevents AI calls if budget exceeded. Graceful: returns reason so user sees helpful error not generic failure."
    },
    {
      "id": "US-004",
      "title": "Integrate budget check into AI pipeline",
      "description": "As the system, budget checks prevent overspending.",
      "acceptanceCriteria": [
        "Edit processVoiceNoteInsight action in actions/coachParentSummaries.ts",
        "Before calling classifyInsightSensitivity, run: const budgetCheck = await ctx.runQuery(api.models.orgCostBudgets.checkOrgCostBudget, { organizationId })",
        "If !budgetCheck.withinBudget: log warning, return early without processing (no summary created)",
        "Create internal mutation: logBudgetExceededEvent with args: organizationId, reason",
        "Call logBudgetExceededEvent so we track how often this happens",
        "Typecheck passes"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Fail fast. Don't call AI if budget exceeded. Log event for analytics (how often do orgs hit limits?). Future: show coach a message explaining budget limit."
    },
    {
      "id": "US-005",
      "title": "Create updateOrgDailySpend scheduled function",
      "description": "As the system, daily spend resets automatically at midnight UTC.",
      "acceptanceCriteria": [
        "Create packages/backend/convex/crons.ts if not exists",
        "Add scheduled function: updateOrgDailySpend that runs daily at 00:00 UTC",
        "Query all orgCostBudgets records",
        "For each: if lastResetDate !== today's date (YYYY-MM-DD format), set currentDailySpend = 0, lastResetDate = today",
        "Use cron.daily('update-org-daily-spend', { hourUTC: 0, minuteUTC: 0 }, internal.crons.updateOrgDailySpend)",
        "Typecheck passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "Automated reset. No manual intervention needed. Runs at midnight UTC. Pattern: GitHub Actions quotas reset daily, AWS budgets reset on schedule."
    },
    {
      "id": "US-006",
      "title": "Create checkCostAlerts scheduled function",
      "description": "As a platform admin, I'm alerted when costs exceed thresholds.",
      "acceptanceCriteria": [
        "Add scheduled function: checkCostAlerts that runs every 10 minutes",
        "Query orgCostBudgets where isEnabled === true",
        "For each org: calculate dailyPercentUsed = (currentDailySpend / dailyBudgetUsd) * 100",
        "If dailyPercentUsed >= alertThresholdPercent and no recent warning: insert platformCostAlerts record with type 'org_daily_threshold', severity 'warning'",
        "If dailyPercentUsed >= 100 and no recent critical alert: insert platformCostAlerts with type 'org_daily_exceeded', severity 'critical'",
        "Repeat for monthlyPercentUsed",
        "Use cron.interval('check-cost-alerts', { minutes: 10 }, internal.crons.checkCostAlerts)",
        "Typecheck passes"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Proactive alerting. Catches budget issues before they become problems. 'Recent alert' check prevents spam (don't alert every 10 min if already alerted)."
    },
    {
      "id": "US-007",
      "title": "Add rateLimits table to schema",
      "description": "As a developer, I need rate limiting infrastructure.",
      "phase": "2: Rate Limiting",
      "acceptanceCriteria": [
        "Add rateLimits table to schema.ts: scope (v.union: 'platform' | 'organization'), scopeId (string, 'platform' for global), limitType (v.union: 'messages_per_hour' | 'messages_per_day' | 'cost_per_hour' | 'cost_per_day'), limitValue (number), currentCount (number), currentCost (number), windowStart (number), windowEnd (number), lastResetAt (number)",
        "Add indexes: by_scope_type (scope, scopeId, limitType)",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Flexible rate limiting. Can limit by messages or cost, hourly or daily, per-org or platform-wide. windowStart/windowEnd track rolling windows."
    },
    {
      "id": "US-008",
      "title": "Implement checkRateLimit query",
      "description": "As the system, I check rate limits before AI calls.",
      "acceptanceCriteria": [
        "Create models/rateLimits.ts",
        "Add checkRateLimit query with args: organizationId",
        "Check platform-wide limits first: query scope='platform', limitType='messages_per_hour'",
        "Check org-specific limits: query scope='organization', scopeId=organizationId",
        "For each active limit: if currentCount >= limitValue or currentCost >= limitValue, return { allowed: false, reason: 'rate_limit_exceeded', resetAt: windowEnd }",
        "If all limits OK: return { allowed: true, remainingMessages, resetAt }",
        "Returns: v.object({ allowed: v.boolean(), reason: v.optional(v.string()), resetAt: v.optional(v.number()), remainingMessages: v.optional(v.number()) })",
        "Typecheck passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Guards against abuse or bugs. Example: if bug causes infinite loop calling AI, rate limit stops it after 1000 messages/hour. Protects cost AND API quotas."
    },
    {
      "id": "US-009",
      "title": "Integrate rate limiting into AI pipeline",
      "description": "As the system, rate limits prevent abuse.",
      "acceptanceCriteria": [
        "Edit processVoiceNoteInsight action in actions/coachParentSummaries.ts",
        "Before budget check (US-004), add rate limit check: const rateCheck = await ctx.runQuery(api.models.rateLimits.checkRateLimit, { organizationId })",
        "If !rateCheck.allowed: log warning, return early with error explaining rate limit and resetAt time",
        "After successful AI call, increment rate limit counter: ctx.runMutation(internal.models.rateLimits.incrementRateLimit, { organizationId, cost: calculatedCost })",
        "Typecheck passes"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Defense in depth. Check BEFORE spending, increment AFTER. If AI call fails, don't increment (didn't actually use quota). Industry: Stripe rate limits per customer, GitHub limits per user."
    },
    {
      "id": "US-010",
      "title": "Create resetRateLimitWindows scheduled function",
      "description": "As the system, rate limit windows reset automatically.",
      "acceptanceCriteria": [
        "Add scheduled function: resetRateLimitWindows that runs every hour at :00",
        "Query rateLimits where windowEnd <= Date.now() (window has expired)",
        "For each expired limit: set currentCount = 0, currentCost = 0, windowStart = Date.now(), windowEnd = Date.now() + (window duration based on limitType)",
        "hourly limits: windowEnd = now + 1 hour, daily limits: windowEnd = now + 24 hours",
        "Use cron.hourly('reset-rate-limit-windows', { minuteUTC: 0 }, internal.crons.resetRateLimitWindows)",
        "Typecheck passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Automated reset. Rolling windows (not fixed midnight resets). If limit hit at 2:30pm, resets at 3:30pm (hourly) or next day 2:30pm (daily)."
    },
    {
      "id": "US-011",
      "title": "Add default platform rate limits",
      "description": "As a platform admin, sensible defaults protect the platform.",
      "acceptanceCriteria": [
        "Create migration script or seed data: packages/backend/convex/seed/defaultRateLimits.ts",
        "Insert platform-wide limits: messages_per_hour = 1000, messages_per_day = 10000, cost_per_hour = $50, cost_per_day = $500",
        "These are failsafes - should never hit in normal operation",
        "Document in comments: adjust based on actual platform usage patterns",
        "Typecheck passes"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Safety net. Even if no per-org limits set, platform limits prevent catastrophic costs. Values are conservative - adjust after observing production usage."
    },
    {
      "id": "US-012",
      "title": "Add aiServiceHealth table to schema",
      "description": "As the system, I track AI service health.",
      "phase": "3: Graceful Degradation",
      "acceptanceCriteria": [
        "Add aiServiceHealth table to schema.ts (singleton pattern): service (v.literal('anthropic')), status (v.union: 'healthy' | 'degraded' | 'down'), lastSuccessAt (number), lastFailureAt (number), recentFailureCount (number), failureWindow (number, default 5 minutes), circuitBreakerState (v.union: 'closed' | 'open' | 'half_open'), lastCheckedAt (number)",
        "No indexes needed (singleton)",
        "Run: npx -w packages/backend convex codegen",
        "Typecheck passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Circuit breaker pattern. Track service health. If failure rate exceeds threshold, open circuit (stop calling API). Prevents cascading failures. Industry: Netflix Hystrix, AWS Circuit Breaker."
    },
    {
      "id": "US-013",
      "title": "Implement circuit breaker logic",
      "description": "As the system, I detect and react to API degradation.",
      "acceptanceCriteria": [
        "Create lib/circuitBreaker.ts",
        "Export function shouldCallAPI(serviceHealth): boolean",
        "If circuitBreakerState === 'open': return false (don't call API)",
        "If circuitBreakerState === 'half_open': allow 1 test call to check if service recovered",
        "If circuitBreakerState === 'closed': return true (normal operation)",
        "Export function recordAPIResult(success: boolean): updates failure counts, state transitions",
        "State transitions: closed → open (5 failures in 5 min), open → half_open (after 1 min cooldown), half_open → closed (success) or open (failure)",
        "Typecheck passes"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Self-healing. If API is down, open circuit after 5 failures. Wait 1 min, try one call. If succeeds, close circuit. If fails, wait another minute. Prevents hammering down service."
    },
    {
      "id": "US-014",
      "title": "Integrate circuit breaker into AI actions",
      "description": "As the system, degraded service triggers graceful fallback.",
      "acceptanceCriteria": [
        "Edit generateParentSummary and classifyInsightSensitivity actions",
        "Before Anthropic API call: check shouldCallAPI(serviceHealth)",
        "If false: return fallback response with isFallback flag",
        "Wrap Anthropic API call in try-catch: on success recordAPIResult(true), on error recordAPIResult(false) and return fallback",
        "Fallback for generateParentSummary: return template-based summary 'Your coach shared an update about {player}. View details in passport.'",
        "Fallback for classifyInsightSensitivity: return { category: 'normal', confidence: 0.5, isFallback: true }",
        "Typecheck passes"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Fail gracefully. If AI is down, send simple template message instead of failing. Parent still gets notified, coach still approves. Better than nothing. Industry: Stripe falls back to simpler fraud checks if ML model down."
    },
    {
      "id": "US-015",
      "title": "Add degradation notice to coach UI",
      "description": "As a coach, I'm informed when AI is degraded.",
      "acceptanceCriteria": [
        "Create components/coach/degradation-banner.tsx",
        "Props: { degradationType: 'ai_fallback' | 'rate_limited' | 'budget_exceeded' }",
        "Show contextual banner: 'AI assistance temporarily unavailable. Using simplified summaries. Service typically recovers within 5 minutes.'",
        "Different messages for each degradationType",
        "Import Alert, AlertDescription from @/components/ui/alert",
        "Warning icon and amber styling",
        "Typecheck passes"
      ],
      "priority": 15,
      "passes": false,
      "notes": "Transparency. Don't hide degradation. Explain what's happening, set expectations. Better than silent failures or confusing behavior."
    },
    {
      "id": "US-016",
      "title": "Show degradation banner in voice notes dashboard",
      "description": "As a coach, degradation status is visible.",
      "acceptanceCriteria": [
        "Edit voice-notes-dashboard.tsx",
        "Add query: getAIServiceHealth (create in models/aiServiceHealth.ts if needed)",
        "If status !== 'healthy': render DegradationBanner with appropriate type",
        "Position below header, above tabs",
        "Automatically dismisses when service recovers (query updates real-time)",
        "Typecheck passes"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Real-time feedback. Convex real-time queries mean banner appears/disappears automatically as service status changes. No page refresh needed."
    },
    {
      "id": "US-017",
      "title": "Create platform messaging admin page structure",
      "description": "As a platform admin, I have a centralized control panel.",
      "phase": "4: Admin Dashboard",
      "acceptanceCriteria": [
        "Create apps/web/src/app/platform/messaging/page.tsx",
        "Check user.isPlatformStaff, redirect if not authorized",
        "Page layout: tabs for Overview / Cost Analytics / Rate Limits / Service Health / Settings",
        "Use Tabs, TabsList, TabsTrigger, TabsContent from @/components/ui/tabs",
        "Placeholder content for each tab (filled in next stories)",
        "Typecheck passes"
      ],
      "priority": 17,
      "passes": false,
      "notes": "Central hub. One page for all messaging/AI controls. Similar to AWS Cost Explorer, Stripe Dashboard, Vercel Analytics."
    },
    {
      "id": "US-018",
      "title": "Build Cost Analytics tab",
      "description": "As a platform admin, I see cost trends and breakdowns.",
      "acceptanceCriteria": [
        "In messaging admin page, Cost Analytics tab",
        "Use getAIUsageSummary query (created in P5 US-015) with platform-wide scope",
        "Show cards: Total Cost (30 days), Cost Today, Average per Message, Cache Hit Rate",
        "Show line chart: daily cost over 30 days (use recharts library if available, or simple bars)",
        "Show table: top 10 orgs by cost with breakdown",
        "Color coding: green if cache hit rate >80%, amber if 60-80%, red if <60%",
        "Typecheck passes"
      ],
      "priority": 18,
      "passes": false,
      "notes": "Data-driven decisions. See which orgs are heavy users, whether caching is effective, cost trends over time. Export CSV for accounting."
    },
    {
      "id": "US-019",
      "title": "Build Rate Limits tab",
      "description": "As a platform admin, I configure and monitor rate limits.",
      "acceptanceCriteria": [
        "In messaging admin page, Rate Limits tab",
        "Show current platform-wide limits in editable cards",
        "Button: 'Update Platform Limits' calls updatePlatformRateLimit mutation",
        "Show recent rate limit violations table: org, limit type, time, reset time",
        "Show per-org overrides table with 'Add Override' button",
        "Form to set per-org limits: select org, set messages/hour, messages/day, save",
        "Typecheck passes"
      ],
      "priority": 19,
      "passes": false,
      "notes": "Fine-grained control. Set global limits as safety net, per-org limits for heavy users or trial accounts. See violations to identify abuse or bugs."
    },
    {
      "id": "US-020",
      "title": "Build Service Health tab",
      "description": "As a platform admin, I monitor AI service health.",
      "acceptanceCriteria": [
        "In messaging admin page, Service Health tab",
        "Query aiServiceHealth for current status",
        "Show large status indicator: green 'Healthy', amber 'Degraded', red 'Down'",
        "Show metrics: last success time, last failure time, recent failure count, circuit breaker state",
        "Show recent errors table (from logs): timestamp, error type, affected org, resolution",
        "Button: 'Force Reset Circuit Breaker' (admin override to close circuit manually)",
        "Typecheck passes"
      ],
      "priority": 20,
      "passes": false,
      "notes": "Health at a glance. See if AI is working, recent errors, circuit breaker status. Manual override for when admin knows service is back but circuit hasn't auto-recovered."
    },
    {
      "id": "US-021",
      "title": "Build Settings tab with master kill switch",
      "description": "As a platform admin, I can disable features globally.",
      "acceptanceCriteria": [
        "In messaging admin page, Settings tab",
        "Add platformMessagingSettings table if not exists (singleton): aiGenerationEnabled (boolean), autoApprovalEnabled (boolean), parentNotificationsEnabled (boolean), emergencyMode (boolean), emergencyMessage (optional string)",
        "Show toggle switches for each setting",
        "Big red 'Emergency Disable All' button sets emergencyMode = true, disables all AI features",
        "Emergency mode banner shows emergencyMessage to all users (coaches, parents)",
        "Confirmation dialog before enabling emergency mode",
        "Typecheck passes"
      ],
      "priority": 21,
      "passes": false,
      "notes": "Nuclear option. If something goes catastrophically wrong (bug causing bad summaries, Anthropic billing issue, legal concern), disable everything instantly. Show custom message to users."
    },
    {
      "id": "US-022",
      "title": "Build Overview tab with key metrics",
      "description": "As a platform admin, I see health dashboard on page load.",
      "acceptanceCriteria": [
        "In messaging admin page, Overview tab (default active tab)",
        "Show metric cards: Total Messages (24h), Total Cost (24h), Active Orgs, Service Status",
        "Show alert panel: unacknowledged cost alerts with 'Acknowledge' button",
        "Show recent activity feed: last 20 events (summary created, auto-approved, budget alert, etc.)",
        "Color-coded status: green if all healthy, amber if warnings, red if critical alerts",
        "Auto-refresh every 30 seconds (use setInterval or Convex real-time queries)",
        "Typecheck passes"
      ],
      "priority": 22,
      "passes": false,
      "notes": "War room view. Open this page, see platform health immediately. Recent alerts at top. Activity feed shows what's happening across platform. Industry: Datadog, New Relic, Grafana dashboards."
    }
  ]
}

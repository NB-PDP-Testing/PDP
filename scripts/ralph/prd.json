{
  "project": "Onboarding Phase 1B - Invitation Lifecycle (User-Facing)",
  "branchName": "ralph/onboarding-phase-1b",
  "description": "Improve user experience when invitation links expire. Add clear messaging, request new invitation flow, auto re-invite option, and organization settings for invitation management.",
  "relatedIssues": ["#371"],
  "dependencies": ["phase-1-foundation"],
  "userStories": [
    {
      "id": "US-001",
      "title": "Add invitation settings fields to organization schema",
      "description": "As an admin, I can configure invitation expiration and auto re-invite settings for my organization.",
      "priority": 1,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Find the organization table definition",
        "Add these optional fields:",
        "  invitationExpirationDays: v.optional(v.number()),      // Default: 7",
        "  autoReInviteOnExpiration: v.optional(v.boolean()),     // Default: false",
        "  maxAutoReInvitesPerInvitation: v.optional(v.number()), // Default: 2",
        "  adminContactEmail: v.optional(v.string()),",
        "  notifyAdminsOnInvitationRequest: v.optional(v.boolean()), // Default: true",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types",
        "Verify in Convex dashboard that organization table has new fields"
      ],
      "notes": "These fields control invitation lifecycle behavior per organization."
    },
    {
      "id": "US-002",
      "title": "Create invitationRequests table for user self-service",
      "description": "As a user with an expired invitation, I can request a new one and it's tracked in the database.",
      "priority": 2,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/schema.ts",
        "Add new table invitationRequests:",
        "",
        "invitationRequests: defineTable({",
        "  originalInvitationId: v.string(),",
        "  organizationId: v.string(),",
        "  userEmail: v.string(),",
        "  requestedAt: v.number(),",
        "  requestNumber: v.number(),  // 1, 2, or 3 (max 3 per invitation)",
        "  status: v.union(",
        "    v.literal('pending'),",
        "    v.literal('approved'),",
        "    v.literal('denied')",
        "  ),",
        "  processedAt: v.optional(v.number()),",
        "  processedBy: v.optional(v.string()),",
        "  denyReason: v.optional(v.string()),",
        "  newInvitationId: v.optional(v.string()),",
        "})",
        "  .index('by_organization_status', ['organizationId', 'status'])",
        "  .index('by_email', ['userEmail'])",
        "  .index('by_original_invitation', ['originalInvitationId']),",
        "",
        "Run: npx -w packages/backend convex codegen",
        "Run: npm run check-types"
      ],
      "notes": "requestNumber tracks how many times user has requested (max 3). Status tracks admin action."
    },
    {
      "id": "US-003",
      "title": "Create createInvitationRequest mutation with rate limiting",
      "description": "As a user clicking an expired invitation link, I can request a new invitation (max 3 times).",
      "priority": 3,
      "passes": true,
      "acceptanceCriteria": [
        "Create or edit: packages/backend/convex/models/invitations.ts",
        "Add mutation: createInvitationRequest",
        "Args: { originalInvitationId: v.string(), userEmail: v.string() }",
        "Returns: v.object({ success: v.boolean(), requestNumber: v.number(), message: v.string() })",
        "",
        "Mutation logic:",
        "1. Verify invitation exists and is expired",
        "2. Count existing requests for this invitation:",
        "   const existingRequests = await ctx.db",
        "     .query('invitationRequests')",
        "     .withIndex('by_original_invitation', q => q.eq('originalInvitationId', args.originalInvitationId))",
        "     .collect();",
        "3. If existingRequests.length >= 3, return { success: false, requestNumber: 3, message: 'Maximum requests reached. Please contact the organization directly.' }",
        "4. Check rate limit - no request in last 60 seconds:",
        "   const recentRequest = existingRequests.find(r => r.requestedAt > Date.now() - 60000);",
        "   if (recentRequest) return { success: false, message: 'Please wait before requesting again.' }",
        "5. Create request record with requestNumber = existingRequests.length + 1",
        "6. Return { success: true, requestNumber, message: 'Request submitted.' }",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Rate limiting: max 3 requests per invitation, 1 minute cooldown between requests."
    },
    {
      "id": "US-004",
      "title": "Create checkInvitationStatus query for expired link page",
      "description": "As a user clicking an invitation link, the page can check if it's expired and show appropriate UI.",
      "priority": 4,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/invitations.ts",
        "Add query: checkInvitationStatus",
        "Args: { invitationId: v.string() }",
        "Returns: v.object({",
        "  status: v.union(v.literal('valid'), v.literal('expired'), v.literal('accepted'), v.literal('not_found')),",
        "  invitation: v.optional(v.object({ ... })),",
        "  organization: v.optional(v.object({ name: v.string(), adminContactEmail: v.optional(v.string()) })),",
        "  canRequestNew: v.boolean(),",
        "  requestCount: v.number(),",
        "})",
        "",
        "Query logic:",
        "1. Get invitation by ID",
        "2. If not found, return { status: 'not_found' }",
        "3. Get organization for org name and settings",
        "4. Check expiration: invitation.expiresAt < Date.now()",
        "5. Count existing requests for this invitation",
        "6. Return full status object",
        "",
        "Run: npm run check-types"
      ],
      "notes": "This query provides all data needed for the expired invitation UI."
    },
    {
      "id": "US-005",
      "title": "Create ExpiredInvitationView component",
      "description": "As a user clicking an expired link, I see a clear message with the org name, my role, and options to request a new invitation.",
      "priority": 5,
      "passes": true,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/expired-invitation-view.tsx",
        "",
        "Props: {",
        "  organizationName: string;",
        "  role: string;",
        "  originalInviteDate: Date;",
        "  expiredDate: Date;",
        "  adminContactEmail?: string;",
        "  canRequestNew: boolean;",
        "  requestCount: number;",
        "  onRequestNew: () => void;",
        "}",
        "",
        "UI structure using shadcn/ui Card:",
        "- Icon: AlertTriangle (from lucide-react)",
        "- Title: 'Invitation Expired'",
        "- Text: 'Your invitation to join {organizationName} has expired.'",
        "- Details: 'You were invited as: {role}'",
        "- Details: 'Original invitation: {date}'",
        "- Details: 'Expired: {date}'",
        "",
        "If canRequestNew && requestCount < 3:",
        "  - Button: 'Request New Invitation' (calls onRequestNew)",
        "  - Text: 'Request {requestCount}/3'",
        "",
        "If requestCount >= 3:",
        "  - Text: 'Maximum requests reached.'",
        "",
        "Footer: 'Or contact the organization directly:'",
        "  - Email link to adminContactEmail (if provided)",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Use shadcn/ui Card, Button, Alert components. Keep styling consistent with rest of app."
    },
    {
      "id": "US-006",
      "title": "Update accept-invitation page to handle expired status",
      "description": "As a user clicking an expired invitation link, I see the ExpiredInvitationView instead of an error.",
      "priority": 6,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: apps/web/src/app/orgs/accept-invitation/[invitationId]/page.tsx",
        "Import checkInvitationStatus query",
        "Import ExpiredInvitationView component",
        "Import createInvitationRequest mutation",
        "",
        "Add useQuery for checkInvitationStatus",
        "Add useMutation for createInvitationRequest",
        "",
        "Update render logic:",
        "if (status.status === 'expired') {",
        "  return (",
        "    <ExpiredInvitationView",
        "      organizationName={status.organization?.name ?? 'Unknown'}",
        "      role={status.invitation?.role ?? 'Member'}",
        "      originalInviteDate={new Date(status.invitation?.createdAt)}",
        "      expiredDate={new Date(status.invitation?.expiresAt)}",
        "      adminContactEmail={status.organization?.adminContactEmail}",
        "      canRequestNew={status.canRequestNew}",
        "      requestCount={status.requestCount}",
        "      onRequestNew={handleRequestNew}",
        "    />",
        "  );",
        "}",
        "",
        "Implement handleRequestNew:",
        "  - Call createInvitationRequest mutation",
        "  - Show toast on success/failure",
        "  - Refetch status to update UI",
        "",
        "Run: npm run check-types",
        "Test: Create invitation, manually expire it, click link, verify UI"
      ],
      "notes": "The page should gracefully handle expired invitations instead of showing an error."
    },
    {
      "id": "US-007",
      "title": "Create RequestConfirmation component for post-request state",
      "description": "As a user who requested a new invitation, I see a confirmation message.",
      "priority": 7,
      "passes": true,
      "acceptanceCriteria": [
        "Create: apps/web/src/components/request-invitation-confirmation.tsx",
        "",
        "Props: { organizationName: string }",
        "",
        "UI using shadcn/ui Card:",
        "- Icon: CheckCircle (lucide-react)",
        "- Title: 'Request Submitted'",
        "- Text: 'Your request for a new invitation has been sent to the organization administrators.'",
        "- Text: 'You'll receive an email when your request is processed.'",
        "- Button: 'Done' (navigates to /login or home)",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Simple confirmation UI. Keep it encouraging and clear."
    },
    {
      "id": "US-008",
      "title": "Implement auto re-invite logic for enabled organizations",
      "description": "As a user clicking an expired link for an org with auto re-invite enabled, I automatically get a new invitation.",
      "priority": 8,
      "passes": true,
      "acceptanceCriteria": [
        "Edit: packages/backend/convex/models/invitations.ts",
        "Add mutation: processAutoReInvite",
        "Args: { invitationId: v.string() }",
        "Returns: v.object({ success: v.boolean(), newInvitationId: v.optional(v.string()), message: v.string() })",
        "",
        "Mutation logic:",
        "1. Get invitation and organization",
        "2. Check org.autoReInviteOnExpiration === true",
        "3. Check invitation.autoReInviteCount < (org.maxAutoReInvitesPerInvitation ?? 2)",
        "4. If both true:",
        "   - Create new invitation with same details",
        "   - Increment autoReInviteCount on original invitation",
        "   - Send invitation email",
        "   - Return { success: true, newInvitationId, message: 'New invitation sent' }",
        "5. If not eligible:",
        "   - Return { success: false, message: 'Auto re-invite not available' }",
        "",
        "Update checkInvitationStatus query:",
        "- Add field: autoReInviteAvailable: boolean",
        "- True if org setting enabled AND count not exceeded",
        "",
        "Update accept-invitation page:",
        "- If autoReInviteAvailable, call processAutoReInvite automatically",
        "- Show 'New invitation sent!' message",
        "",
        "Run: npm run check-types"
      ],
      "notes": "Auto re-invite happens transparently. User just sees 'New invitation sent' message."
    }
  ],
  "verificationSteps": [
    "npm run check-types",
    "npx -w packages/backend convex codegen",
    "Test: Click expired link (auto re-invite OFF) → See request form",
    "Test: Click expired link (auto re-invite ON) → New invite sent automatically",
    "Test: Request 3 times → Fourth attempt shows 'Contact admin directly'"
  ],
  "successCriteria": [
    "Expired invitation page shows clear message with org name and role",
    "Users can request new invitation (max 3 times)",
    "Auto re-invite works when org setting enabled",
    "Rate limiting prevents spam requests",
    "Admin contact shown as fallback"
  ]
}

{
  "project": "Injury Tracking Phase 3 - Analytics & Prevention",
  "branchName": "feature/261-injury-tracking-phase3-analytics",
  "description": "Admin injury analytics dashboard with aggregate statistics, trend charts, body part breakdown, severity distribution, team comparisons, date range filtering, and CSV export.",
  "readinessLevel": "100% - Ready to Start",
  "urgency": "HIGH - Phases 1 & 2 complete, Phase 3 delivers analytics visibility to club admins",
  "contextAndDependencies": {
    "criticalContext": [
      "No admin pages exist yet under /orgs/[orgId]/admin/ - this will be the first",
      "Admin sidebar exists: apps/web/src/components/layout/admin-sidebar.tsx",
      "Existing backend queries: getInjuryStats (per-player), getAllActiveInjuriesForOrg, getAllInjuriesForOrg",
      "playerInjuries table has: injuryType, bodyPart, severity, status, dateOccurred, occurredDuring, sportCode, daysOut, expectedReturn, actualReturn",
      "orgPlayerEnrollments has ageGroup field for age group breakdowns",
      "teamPlayerIdentities links players to teams for team comparisons",
      "Recharts library is already installed - use LineChart, BarChart, PieChart, ResponsiveContainer",
      "Phase 1 notifications and Phase 2 recovery management are complete",
      "N+1 queries in getAllActiveInjuriesForOrg and getAllInjuriesForOrg need refactoring (noted in PRD)"
    ],
    "keyFiles": [
      "Backend: packages/backend/convex/models/playerInjuries.ts - existing queries to extend",
      "Backend: packages/backend/convex/schema.ts - playerInjuries, orgPlayerEnrollments, teamPlayerIdentities tables",
      "Frontend: apps/web/src/components/layout/admin-sidebar.tsx - add injuries nav link",
      "Frontend: apps/web/src/app/orgs/[orgId]/admin/ - NEW directory for admin pages",
      "Reference: apps/web/src/app/orgs/[orgId]/coach/injuries/page.tsx - existing injury page patterns"
    ],
    "criticalPatterns": {
      "BetterAuthTables": "Do NOT query user/organization/member/team tables directly. Use ctx.runQuery(components.betterAuth.adapter.findMany, {...}).",
      "ApplicationTables": "playerInjuries, orgPlayerEnrollments, teamPlayerIdentities use regular Convex queries (ctx.db.query).",
      "N1Prevention": "CRITICAL for analytics queries. Batch fetch with Map lookup, never query in a loop. Aggregate in-memory after fetching all data.",
      "IndexUsage": "Always use .withIndex(), never .filter(). Use existing indexes where possible.",
      "TypeSafety": "Use Id<'tableName'> types, not string. Import from @pdp/backend/convex/_generated/dataModel.",
      "RechartsPatterns": "Always wrap charts in <ResponsiveContainer width='100%' height={300}>. Use grid-cols-1 md:grid-cols-2 for responsive layout.",
      "CSVExport": "Escape commas in data: value.replace(/,/g, ';'). Use Blob + URL.createObjectURL + link.download pattern.",
      "ReturnValidators": "All queries and mutations MUST include a returns validator.",
      "AggregationStrategy": "Compute aggregations in-memory from raw injury data. Do NOT create pre-aggregated tables - premature optimization for current scale."
    }
  },
  "userStories": [
    {
      "id": "US-ANA-001",
      "title": "Create getOrgInjuryAnalytics aggregate query",
      "description": "As an admin, I need a single backend query that returns comprehensive injury analytics for the organization, computed from raw injury data.",
      "acceptanceCriteria": [
        "Add getOrgInjuryAnalytics query to playerInjuries.ts",
        "Args: organizationId (string), startDate (optional string ISO date), endDate (optional string ISO date)",
        "Fetch all injuries for the org using existing index patterns (not getAllInjuriesForOrg to avoid N+1)",
        "Query orgPlayerEnrollments by org to get all players, then batch fetch their injuries via playerIdentityId",
        "Compute and return: totalInjuries, activeCount, recoveringCount, clearedCount, healedCount",
        "Compute: byBodyPart (object mapping body part to count), bySeverity (object mapping severity to count)",
        "Compute: byMonth (array of {month: string, count: number} for last 12 months)",
        "Compute: byOccurredDuring (object mapping context to count: training, match, other_sport, non_sport, unknown)",
        "Compute: avgRecoveryDays (average daysOut for healed injuries), recurrenceRate (players with 2+ injuries / total injured players)",
        "Apply date range filtering if startDate/endDate provided",
        "Include returns validator with full shape",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 1,
      "passes": true,
      "notes": "This is the main analytics query. Fetch all data in bulk, then aggregate in-memory. No N+1 patterns."
    },
    {
      "id": "US-ANA-002",
      "title": "Create getInjuriesByTeam aggregate query",
      "description": "As an admin, I need injury counts broken down by team so I can compare injury rates across teams.",
      "acceptanceCriteria": [
        "Add getInjuriesByTeam query to playerInjuries.ts",
        "Args: organizationId (string), startDate (optional string), endDate (optional string)",
        "Fetch all teams for the org via Better Auth adapter",
        "Fetch all teamPlayerIdentities for those teams",
        "Batch fetch injuries for all players across teams",
        "Return array of: {teamId, teamName, totalInjuries, activeCount, avgSeverity, mostCommonBodyPart, mostCommonType}",
        "Sort by totalInjuries descending",
        "Apply date range filtering if provided",
        "Include returns validator",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 2,
      "passes": true,
      "notes": "Use batch fetch pattern. A player on multiple teams should count toward each team's stats. Use Better Auth adapter for team table."
    },
    {
      "id": "US-ANA-003",
      "title": "Create getInjuryTrends comparison query",
      "description": "As an admin, I need to compare current period injury stats against the previous period to identify trends.",
      "acceptanceCriteria": [
        "Add getInjuryTrends query to playerInjuries.ts",
        "Args: organizationId (string), periodDays (number, default 30)",
        "Calculate current period: last N days from today",
        "Calculate previous period: the N days before that",
        "For each period compute: totalInjuries, bySeverity counts, byBodyPart counts, avgRecoveryDays",
        "Return: { currentPeriod: {...}, previousPeriod: {...}, changes: { totalChange, severityChanges, bodyPartChanges } }",
        "Changes should include absolute diff and percentage change",
        "Include returns validator",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 3,
      "passes": true,
      "notes": "Percentage change: ((current - previous) / previous * 100). Handle division by zero (previous = 0)."
    },
    {
      "id": "US-ANA-004",
      "title": "Create getRecentInjuriesForAdmin query",
      "description": "As an admin, I need a paginated list of recent injuries across the organization with player and team details for a data table.",
      "acceptanceCriteria": [
        "Add getRecentInjuriesForAdmin query to playerInjuries.ts",
        "Args: organizationId (string), limit (optional number, default 50), status (optional string to filter by status)",
        "Fetch injuries and batch-enrich with: player name, team name(s), age group",
        "Return array of enriched injury records sorted by dateOccurred descending",
        "Each record includes: injuryId, playerName, teamNames, ageGroup, bodyPart, injuryType, severity, status, dateOccurred, daysOut, expectedReturn",
        "Use batch fetch pattern - no N+1",
        "Include returns validator",
        "Typecheck passes: npm run check-types"
      ],
      "priority": 4,
      "passes": true,
      "notes": "This powers the injuries data table on the admin dashboard. Keep enrichment efficient with Map lookups."
    },
    {
      "id": "US-ANA-005",
      "title": "Create admin injuries analytics page route and layout",
      "description": "As an admin, I need an analytics page at /orgs/[orgId]/admin/injuries that provides the layout shell for injury analytics.",
      "acceptanceCriteria": [
        "Create apps/web/src/app/orgs/[orgId]/admin/injuries/page.tsx",
        "Page title: 'Injury Analytics'",
        "Page uses the admin layout (verify admin layout exists, create if needed)",
        "Add date range filter controls at the top (start date, end date, preset buttons: Last 30 days, Last 90 days, This season, All time)",
        "Page skeleton with sections for: summary cards, charts row, team comparison, recent injuries table",
        "Fetch data using useQuery with getOrgInjuryAnalytics",
        "Pass orgId from route params",
        "Show loading skeletons while data loads (use shadcn Skeleton)",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 5,
      "passes": true,
      "notes": "This is the first admin page. Check if admin layout wrapper exists - if not, the page can be standalone with admin sidebar."
    },
    {
      "id": "US-ANA-006",
      "title": "Add injuries link to admin sidebar navigation",
      "description": "As an admin, I need an 'Injury Analytics' link in the admin sidebar so I can navigate to the analytics dashboard.",
      "acceptanceCriteria": [
        "Edit apps/web/src/components/layout/admin-sidebar.tsx",
        "Add nav item: label 'Injury Analytics', icon Heart (or ShieldAlert), href /orgs/[orgId]/admin/injuries",
        "Position it logically in the sidebar (near other analytics/reporting items)",
        "Active state highlights correctly when on the injuries page",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 6,
      "passes": false,
      "notes": "Use the existing NavItem pattern in admin-sidebar.tsx. Heart icon with ShieldAlert as alternative."
    },
    {
      "id": "US-ANA-007",
      "title": "Create injury summary statistics cards",
      "description": "As an admin, I want to see key injury metrics at a glance: total injuries, currently active, average recovery time, and recurrence rate.",
      "acceptanceCriteria": [
        "Create summary cards component in the admin injuries page (can be inline or separate component file)",
        "Card 1: Total Injuries (number, with trend indicator vs previous period)",
        "Card 2: Currently Active (number of active + recovering injuries)",
        "Card 3: Avg Recovery Days (average daysOut for healed injuries, formatted to 1 decimal)",
        "Card 4: Recurrence Rate (percentage of players with 2+ injuries, formatted as percentage)",
        "Each card shows comparison with previous period: green arrow up/down for improvements, red for worsening",
        "Use shadcn/ui Card component with consistent styling",
        "Responsive grid: 1 column mobile, 2 tablet, 4 desktop (grid-cols-1 md:grid-cols-2 lg:grid-cols-4)",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 7,
      "passes": false,
      "notes": "For recurrence rate and avg recovery, 'improvement' means the number went DOWN. For total injuries going down is also an improvement."
    },
    {
      "id": "US-ANA-008",
      "title": "Create injuries over time trend chart",
      "description": "As an admin, I want a line chart showing injury counts by month over the last 12 months to identify trends and seasonal patterns.",
      "acceptanceCriteria": [
        "Create trend chart component using Recharts LineChart",
        "X-axis: months (formatted as 'Jan', 'Feb', etc.)",
        "Y-axis: injury count",
        "Single line showing total injuries per month",
        "Tooltip showing exact count on hover",
        "Wrap in ResponsiveContainer for responsive sizing",
        "Card wrapper with title 'Injury Trends'",
        "Empty state if no data: 'No injury data for selected period'",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Data comes from byMonth array in getOrgInjuryAnalytics. Recharts is already installed."
    },
    {
      "id": "US-ANA-009",
      "title": "Create injuries by body part bar chart",
      "description": "As an admin, I want a horizontal bar chart showing which body parts are most commonly injured to identify patterns.",
      "acceptanceCriteria": [
        "Create body part chart component using Recharts BarChart (horizontal layout)",
        "Y-axis: body part names (ankle, knee, shoulder, etc.)",
        "X-axis: injury count",
        "Bars colored by count intensity (or single consistent color)",
        "Sort by count descending (most common at top)",
        "Tooltip showing exact count on hover",
        "Wrap in ResponsiveContainer",
        "Card wrapper with title 'Injuries by Body Part'",
        "Limit to top 10 body parts if more than 10 exist",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Data comes from byBodyPart object in getOrgInjuryAnalytics. Transform to array and sort."
    },
    {
      "id": "US-ANA-010",
      "title": "Create injuries by severity distribution chart",
      "description": "As an admin, I want a donut/pie chart showing the distribution of injury severities to understand the overall severity profile.",
      "acceptanceCriteria": [
        "Create severity chart component using Recharts PieChart (donut style with inner radius)",
        "Segments: minor (green), moderate (yellow), severe (orange), long_term (red)",
        "Each segment shows percentage label",
        "Legend showing severity labels with counts",
        "Tooltip showing count and percentage on hover",
        "Wrap in ResponsiveContainer",
        "Card wrapper with title 'Severity Distribution'",
        "Center text showing total count",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 10,
      "passes": false,
      "notes": "Data comes from bySeverity object in getOrgInjuryAnalytics. Use consistent color coding across the dashboard."
    },
    {
      "id": "US-ANA-011",
      "title": "Create injury context breakdown chart",
      "description": "As an admin, I want to see where injuries occur (training, match, outside club) to identify high-risk activities.",
      "acceptanceCriteria": [
        "Create context chart component using Recharts BarChart (vertical)",
        "X-axis: context labels (Training, Match, Other Sport, Non-Sport, Unknown)",
        "Y-axis: injury count",
        "Distinct colors for each context type",
        "Tooltip with count on hover",
        "Wrap in ResponsiveContainer",
        "Card wrapper with title 'Injury Context'",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Data comes from byOccurredDuring object in getOrgInjuryAnalytics. Map enum values to display labels."
    },
    {
      "id": "US-ANA-012",
      "title": "Create team injury comparison table",
      "description": "As an admin, I want a table comparing injury statistics across teams to identify teams with higher injury rates.",
      "acceptanceCriteria": [
        "Create team comparison component using a styled table or shadcn/ui Table",
        "Columns: Team Name, Total Injuries, Active, Avg Severity, Most Common Body Part, Most Common Type",
        "Fetch data using useQuery with getInjuriesByTeam",
        "Sort by total injuries descending by default",
        "Highlight teams with above-average injury counts (subtle red/orange background)",
        "Card wrapper with title 'Team Comparison'",
        "Empty state if no team data",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 12,
      "passes": false,
      "notes": "This helps admins identify if specific teams or training programs have higher injury rates."
    },
    {
      "id": "US-ANA-013",
      "title": "Create recent injuries data table",
      "description": "As an admin, I want a sortable, filterable table of recent injuries across the organization for detailed review.",
      "acceptanceCriteria": [
        "Create recent injuries table component",
        "Fetch data using useQuery with getRecentInjuriesForAdmin",
        "Columns: Player Name, Team(s), Body Part, Type, Severity, Status, Date, Days Out",
        "Status column shows colored badge (active=red, recovering=yellow, cleared=green, healed=blue)",
        "Severity column shows colored badge (minor=green, moderate=yellow, severe=orange, long_term=red)",
        "Add status filter dropdown above table (All, Active, Recovering, Cleared, Healed)",
        "Sort by date descending by default",
        "Card wrapper with title 'Recent Injuries'",
        "Show up to 50 most recent injuries",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Use shadcn/ui Table, Badge, Select components. Consider making rows clickable in future phase."
    },
    {
      "id": "US-ANA-014",
      "title": "Add export injury report as CSV",
      "description": "As an admin, I want to export injury data as a CSV file for reporting, insurance claims, and compliance purposes.",
      "acceptanceCriteria": [
        "Add 'Export CSV' button to the admin injuries page header (next to date range filter)",
        "CSV includes all injuries in the current date range with columns: Player Name, Team, Body Part, Injury Type, Severity, Status, Date Occurred, Days Out, Expected Return, Occurred During, Treatment, Medical Provider",
        "Escape commas in all string fields: value.replace(/,/g, ';')",
        "Download with filename: injury-report-[orgName]-[date].csv",
        "Use Blob + URL.createObjectURL + link.download pattern",
        "Show toast on export: 'Injury report exported successfully'",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 14,
      "passes": false,
      "notes": "Data comes from getRecentInjuriesForAdmin query. Include all records, not just top 50."
    },
    {
      "id": "US-ANA-015",
      "title": "Assemble full analytics dashboard layout",
      "description": "As an admin, I want all analytics components arranged in a clean, responsive dashboard layout with proper spacing and visual hierarchy.",
      "acceptanceCriteria": [
        "Wire all components into the admin injuries page.tsx",
        "Layout order: date range filter → summary cards row → charts row (trends + body part side by side) → charts row (severity + context side by side) → team comparison → recent injuries table → export button",
        "Responsive: charts stack vertically on mobile (grid-cols-1), side by side on desktop (md:grid-cols-2)",
        "Consistent card spacing using gap-4 or gap-6",
        "Date range filter controls affect all components (pass startDate/endDate to queries)",
        "Loading state: show Skeleton placeholders for all components while queries load",
        "Empty state: show meaningful message if organization has no injury data",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 15,
      "passes": false,
      "notes": "This is the final assembly story. All individual components should be built by this point. Focus on layout, data flow, and polish."
    },
    {
      "id": "US-ANA-016",
      "title": "Add period comparison indicators to summary cards",
      "description": "As an admin, I want summary cards to show comparisons with the previous period so I can see if injury rates are improving or worsening.",
      "acceptanceCriteria": [
        "Fetch data using useQuery with getInjuryTrends",
        "Update each summary card to show comparison: '+3 vs last period' or '-2 vs last period'",
        "Color coding: green for improvements (fewer injuries, lower recovery time, lower recurrence), red for worsening",
        "Show percentage change where meaningful: '↓ 15%' or '↑ 25%'",
        "Gray '—' indicator when no previous period data exists",
        "Typecheck passes: npm run check-types",
        "Lint passes: npx ultracite fix"
      ],
      "priority": 16,
      "passes": false,
      "notes": "Improvement direction varies by metric: fewer total injuries = good (green), lower avg recovery = good (green), lower recurrence = good (green)."
    }
  ],
  "qualityChecks": {
    "beforeCommitting": [
      "npm run check-types - MUST pass",
      "npx ultracite fix - MUST pass",
      "npx -w packages/backend convex codegen - MUST pass",
      "No N+1 query patterns in analytics queries - use batch fetch with Map lookup",
      "All charts wrapped in ResponsiveContainer for mobile",
      "CSV export escapes commas in all string data",
      "Date range filter wired to all dashboard components",
      "Loading skeletons shown while queries load",
      "Empty states for all components when no data"
    ]
  }
}

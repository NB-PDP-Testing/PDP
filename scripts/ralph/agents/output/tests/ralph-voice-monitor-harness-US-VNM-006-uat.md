# UAT Test: US-VNM-006 - Build Retry Operations Backend

> Auto-generated: 2026-02-16 21:14
> Status: ‚è≥ Pending Execution

## Story
Create voicePipelineRetry.ts with manual retry mutations for failed pipeline stages. READ FULL DETAILS in phases/PHASE_M3.json.

## Acceptance Criteria Checklist

- [ ] Create packages/backend/convex/models/voicePipelineRetry.ts
- [ ] Implement retryTranscription mutation (platform staff only)
- [ ] - Verify platform staff authorization
- [ ] - Fetch artifact by ID, verify transcription failure
- [ ] - Log retry_initiated event with metadata.retryAttempt (count previous retries + 1)
- [ ] - Reset artifact status to 'transcribing'
- [ ] - Fetch artifact.voiceNoteId for action (transcribeAudio takes noteId, not artifactId)
- [ ] - Schedule transcribeAudio action: ctx.scheduler.runAfter(0, internal.actions.voiceNotes.transcribeAudio, { noteId: artifact.voiceNoteId })
- [ ] - Return { success: true, message: 'Transcription retry initiated' }
- [ ] Implement retryClaimsExtraction mutation
- [ ] - Similar to retryTranscription but for claims extraction failure
- [ ] - Reset status to 'transcribed' (ready for claims)
- [ ] - Schedule extractClaims action
- [ ] Implement retryEntityResolution mutation
- [ ] - For entity resolution failure or needs manual review
- [ ] - Delete existing voiceNoteEntityResolutions for this artifact (clean slate)
- [ ] - Schedule resolveEntities action
- [ ] Implement retryFullPipeline mutation
- [ ] - DESTRUCTIVE: deletes ALL derived data
- [ ] - Log retry_initiated with metadata: { retryType: 'full_pipeline' }
- [ ] - Delete in order (try/catch, abort if any fail): transcripts, claims, resolutions, drafts
- [ ] - Reset artifact status to 'received'
- [ ] - Schedule transcribeAudio action with noteId (NOT artifactId)
- [ ] - Return success
- [ ] Implement getRetryHistory query
- [ ] - Platform staff only
- [ ] - Query voicePipelineEvents by_artifactId index
- [ ] - Filter eventType in ['retry_initiated', 'retry_succeeded', 'retry_failed']
- [ ] - Order by timestamp ascending
- [ ] - Return simplified retry history format
- [ ] CRITICAL: transcribeAudio action takes v.id('voiceNotes') noteId, NOT artifactId
- [ ] CRITICAL: Use ctx.scheduler.runAfter(0, ...) NOT ctx.runAction (fire-and-forget)
- [ ] CRITICAL: Log retry_initiated BEFORE scheduling action
- [ ] CRITICAL: Full pipeline retry must wrap deletes in try/catch (abort if any fail)
- [ ] Run: npx -w packages/backend convex codegen && npm run check-types

## Playwright E2E Tests
- Run: `npx -w apps/web playwright test --config=uat/playwright.config.ts -g "US-VNM-006"`
- Report: `npx -w apps/web playwright show-report uat/playwright-report`

## Notes
_Add testing observations here_

---
*Generated by Test Runner Agent*

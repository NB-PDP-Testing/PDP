{
  "project": "P7 Phase 2 - Supervised Auto-Apply for Insight Automation",
  "branchName": "ralph/coach-insights-auto-apply-p7-phase2",
  "description": "Implement actual auto-apply for skill insights with 1-hour undo window and audit trail. Level 2+ coaches can have AI automatically apply high-confidence skill insights while maintaining full oversight and rollback capability.",
  "readinessLevel": "100%",
  "prerequisitesCompleted": {
    "status": "✅ ALL COMPLETE",
    "completedWork": [
      "Phase 7.1: Preview mode COMPLETE (5 stories)",
      "  - US-001: insightPreviewModeStats schema fields COMPLETE",
      "  - US-002: wouldAutoApply calculation COMPLETE",
      "  - US-003: Confidence visualization COMPLETE",
      "  - US-004: Preview mode badge COMPLETE",
      "  - US-005: Preview tracking COMPLETE",
      "Phase 7 Prerequisites:",
      "  - US-006: autoAppliedInsights table COMPLETE",
      "  - voiceNoteInsights table with 40 migrated insights COMPLETE",
      "  - AI confidence scoring implemented (0.0-1.0 scale)",
      "  - Trust level system operational (currentLevel, preferredLevel)"
    ]
  },
  "contextAndDependencies": {
    "completedPhases": [
      "P1-P4: Voice notes and parent summaries infrastructure",
      "P5 Phase 1: Trust slider, preview mode for parent summaries",
      "P6: Monitoring, cost controls, graceful degradation",
      "P7 Phase 1: Preview mode for insight auto-apply (US-001 to US-005)"
    ],
    "requiredTables": [
      "voiceNoteInsights - Has category, confidenceScore, status, appliedAt fields",
      "autoAppliedInsights - Audit trail for undo and compliance (US-006 COMPLETE)",
      "coachTrustLevels - With insightPreviewModeStats tracking complete",
      "orgPlayerEnrollments - Player profiles that insights will update"
    ],
    "existingQueries": [
      "getPendingInsights - Returns insights with wouldAutoApply flag (US-002)",
      "getCoachTrustLevel - Returns coach's current trust level",
      "getCoachTrustLevelWithInsightFields - Returns trust level with insight-specific fields (US-004)"
    ],
    "keyFiles": [
      "Schema: packages/backend/convex/schema.ts",
      "Backend insights: packages/backend/convex/models/voiceNoteInsights.ts",
      "Backend trust: packages/backend/convex/models/coachTrustLevels.ts",
      "Frontend insights tab: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx"
    ],
    "parallelToP5": "This mirrors P5 Phase 2 (supervised auto-approve for parent summaries). Same 1-hour undo window, same audit trail pattern, same safety-first approach."
  },
  "philosophyAndGoals": {
    "corePhilosophy": "AI takes action but coach maintains full control. Start with safest category (skills = numeric ratings). Never auto-apply injury/medical. Always provide undo window.",
    "industryPatterns": [
      "Gmail Undo Send: 1-hour window to reverse AI actions",
      "Google Docs Version History: Track what changed when and by whom",
      "Stripe Audit Logs: Complete trail for compliance",
      "GitHub Copilot: Track acceptance rate to improve suggestions"
    ],
    "successMetrics": {
      "adoption": "30%+ of eligible insights are auto-applied",
      "accuracy": "<5% undo rate (coach agrees with AI 95%+ of time)",
      "safety": "Zero injury/medical insights auto-applied (100% manual review)",
      "transparency": "100% of auto-applied insights show audit trail"
    },
    "safetyFirst": [
      "Start with skills only (numeric ratings, easily reverted)",
      "Never auto-apply injury or medical insights",
      "1-hour undo window for all auto-applied insights",
      "Track previousValue before applying newValue (rollback capability)",
      "Require Level 2+ trust (coach has proven track record)",
      "Require confidence >= threshold (default 0.7, 70%)"
    ]
  },
  "userStories": [
    {
      "id": "US-006",
      "title": "✅ PREREQUISITE COMPLETE: autoAppliedInsights table in schema",
      "description": "Audit trail table for tracking all auto-applied insights with undo capability.",
      "phase": "7.2: Supervised Auto-Apply",
      "priority": 6,
      "passes": true,
      "completed": true,
      "completionNotes": "Table added to schema during Phase 7 prerequisites. Contains insightId, playerId, coachId, confidenceScore, appliedAt, undoneAt, undoReason, changeType, fieldChanged, previousValue, newValue, autoAppliedByAI fields with appropriate indexes."
    },
    {
      "id": "US-007",
      "title": "Implement auto-apply logic for skill insights",
      "description": "As a coach at Level 2+, skill insights auto-apply to player profiles when confidence is high.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/models/voiceNoteInsights.ts",
        "Create new mutation: autoApplyInsight",
        "Args: { insightId: v.id('voiceNoteInsights') }",
        "Returns: v.object({ success: v.boolean(), appliedInsightId: v.optional(v.id('autoAppliedInsights')), message: v.string() })",
        "",
        "Mutation logic:",
        "1. Get authenticated coach userId",
        "2. Fetch insight from voiceNoteInsights table",
        "3. Validate insight exists and belongs to this coach",
        "",
        "4. Fetch coach trust level from coachTrustLevels",
        "5. Calculate effectiveLevel = Math.min(currentLevel, preferredLevel ?? currentLevel)",
        "6. Validate trust requirements:",
        "   - effectiveLevel >= 2 (Level 2+ required)",
        "   - confidenceScore >= (insightConfidenceThreshold ?? 0.7)",
        "   - category === 'skill' (only skills in Phase 7.2)",
        "   - status === 'pending' (not already applied)",
        "",
        "7. Get player from orgPlayerEnrollments using insight.playerId",
        "8. Validate player exists",
        "",
        "9. Extract skill name and new rating from insight.recommendedUpdate",
        "   - Parse format: 'Skill: Rating' (e.g., 'Passing: 4')",
        "   - Get current skill rating from player.skillRatings (previousValue)",
        "",
        "10. Update player.skillRatings with new rating",
        "    - Use ctx.db.patch to update player record",
        "",
        "11. Create autoAppliedInsights audit record:",
        "    - insightId: insight._id",
        "    - playerId: insight.playerId",
        "    - coachId: userId",
        "    - organizationId: insight.organizationId",
        "    - category: insight.category",
        "    - confidenceScore: insight.confidenceScore",
        "    - appliedAt: Date.now()",
        "    - changeType: 'skill_rating'",
        "    - fieldChanged: skillName (e.g., 'Passing')",
        "    - previousValue: currentRating.toString() (e.g., '3')",
        "    - newValue: newRating.toString() (e.g., '4')",
        "    - autoAppliedByAI: true",
        "",
        "12. Update insight status:",
        "    - status: 'applied'",
        "    - appliedAt: Date.now()",
        "    - appliedBy: userId",
        "    - autoAppliedByAI: true",
        "",
        "13. Return success with audit record ID",
        "",
        "Error handling:",
        "- Return { success: false, message: 'Reason' } for validation failures",
        "- Throw ConvexError for unexpected errors",
        "",
        "Type check passes",
        "npx -w packages/backend convex codegen succeeds"
      ],
      "priority": 7,
      "passes": true,
      "notes": "Start with skills only (safest category). Numeric ratings, easily reverted. Never auto-apply injury/medical/behavioral. Requires audit trail for every change."
    },
    {
      "id": "US-008",
      "title": "Add 1-hour undo window for auto-applied insights",
      "description": "As a coach, I can undo auto-applied insights within 1 hour if AI made a mistake.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/models/voiceNoteInsights.ts",
        "Create mutation: undoAutoAppliedInsight",
        "Args: { autoAppliedInsightId: v.id('autoAppliedInsights'), undoReason: v.string() }",
        "Returns: v.object({ success: v.boolean(), message: v.string() })",
        "",
        "Mutation logic:",
        "1. Get authenticated coach userId",
        "2. Fetch autoAppliedInsights record",
        "3. Validate record exists",
        "",
        "4. Validate coach owns this insight:",
        "   - autoAppliedInsight.coachId === userId",
        "",
        "5. Validate undo window:",
        "   - Calculate elapsed: Date.now() - appliedAt",
        "   - Require: elapsed < 3600000 (1 hour = 3600 seconds * 1000 ms)",
        "   - If expired: return { success: false, message: 'Undo window expired (must undo within 1 hour)' }",
        "",
        "6. Validate not already undone:",
        "   - undoneAt === undefined",
        "   - If already undone: return { success: false, message: 'Already undone' }",
        "",
        "7. Get player from orgPlayerEnrollments",
        "8. Revert player profile to previousValue:",
        "   - Update player.skillRatings[fieldChanged] = parseInt(previousValue)",
        "",
        "9. Update autoAppliedInsights record:",
        "   - undoneAt: Date.now()",
        "   - undoReason: args.undoReason",
        "",
        "10. Update original insight in voiceNoteInsights:",
        "    - status: 'pending' (revert to pending)",
        "    - appliedAt: undefined",
        "    - appliedBy: undefined",
        "    - autoAppliedByAI: undefined",
        "",
        "11. Return success message with details",
        "",
        "Type check passes",
        "npx -w packages/backend convex codegen succeeds"
      ],
      "priority": 8,
      "passes": true,
      "notes": "Safety net. 1-hour window matches P5 parent summary revoke. After 1 hour, grayed out 'Cannot undo (expired)'. Captures why coach undid (feedback for learning)."
    },
    {
      "id": "US-009",
      "title": "Add auto-applied insights UI to insights tab",
      "description": "As a coach, I see which insights were auto-applied and can review/undo them.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx",
        "",
        "1. Add second tab to insights section:",
        "   - Existing: 'Pending Review' (current insights with status='pending')",
        "   - NEW: 'Auto-Applied' (insights where autoAppliedByAI === true)",
        "",
        "2. Add query to fetch auto-applied insights:",
        "   - Create new query: getAutoAppliedInsights in voiceNoteInsights.ts",
        "   - Args: { organizationId: v.string(), coachId: v.optional(v.string()) }",
        "   - Returns insights with status='applied' and autoAppliedByAI=true",
        "   - Include audit details from autoAppliedInsights table (join on insightId)",
        "   - Sort by appliedAt descending (most recent first)",
        "",
        "3. Display auto-applied insights in new tab:",
        "   - Show all auto-applied insights for current coach",
        "   - Use similar card layout as pending insights",
        "",
        "4. Each auto-applied insight card shows:",
        "   - Green badge: '✓ Auto-Applied'",
        "   - Time applied: 'Applied 23 minutes ago' (use relative time)",
        "   - What changed: 'Passing: 3 → 4' (show previousValue → newValue)",
        "   - Player name and insight description",
        "   - Confidence score with progress bar (existing US-003 component)",
        "",
        "5. Add action buttons to each card:",
        "   - [Undo] button:",
        "     - Enabled if within 1 hour: (Date.now() - appliedAt) < 3600000",
        "     - Disabled if expired with tooltip: 'Undo window expired'",
        "     - Disabled if already undone with text: 'Undone'",
        "   - [View Profile] button:",
        "     - Links to player profile to see change in context",
        "",
        "6. Undo button click opens confirmation dialog:",
        "   - Dialog title: 'Undo Auto-Applied Insight'",
        "   - Message: 'This will revert the player's rating back to {previousValue}. Why are you undoing this?'",
        "   - Radio button options:",
        "     - 'Wrong player - AI applied to incorrect player'",
        "     - 'Wrong rating - The suggested rating was incorrect'",
        "     - 'Insight incorrect - The insight itself was wrong'",
        "     - 'Other (please explain)'",
        "   - If 'Other' selected, show text area for explanation",
        "   - [Cancel] and [Undo] buttons",
        "",
        "7. On undo confirmation:",
        "   - Call undoAutoAppliedInsight mutation with reason",
        "   - Show loading state on button",
        "   - On success: Toast notification 'Auto-apply undone. Skill rating reverted to {previousValue}.'",
        "   - Refresh auto-applied insights list",
        "   - On error: Toast notification with error message",
        "",
        "8. Add empty state for auto-applied tab:",
        "   - When no auto-applied insights exist:",
        "   - Show icon and message: 'No auto-applied insights yet'",
        "   - Subtitle: 'When you reach Level 2, high-confidence skill insights will auto-apply here'",
        "",
        "Type check passes: npm run check-types",
        "Visual verification in browser:",
        "  - Tabs display correctly",
        "  - Auto-applied insights show with green badge",
        "  - Time displays update (e.g., '5 minutes ago')",
        "  - Undo button enables/disables based on time",
        "  - Undo dialog opens and submits correctly",
        "  - Toast notifications appear on undo"
      ],
      "priority": 9,
      "passes": true,
      "notes": "Transparency. Coach sees everything AI did. Undo is one click. Collecting why helps AI learn (Phase 7.3). After 1 hour, button disabled with tooltip 'Undo window expired'."
    }
  ],
  "testingStrategy": {
    "manualTests": [
      "1. Verify auto-apply only works for Level 2+ coaches",
      "2. Verify auto-apply only works for skill category",
      "3. Verify auto-apply respects confidence threshold",
      "4. Test undo within 1 hour window",
      "5. Test undo fails after 1 hour",
      "6. Verify audit trail tracks all changes",
      "7. Verify player profile updates correctly",
      "8. Verify player profile reverts correctly on undo",
      "9. Test empty state for auto-applied tab",
      "10. Visual verification of UI components"
    ],
    "integrationTests": [
      "End-to-end: Create insight → Auto-apply → View in tab → Undo → Verify reverted",
      "Trust level validation: Try auto-apply at Level 0, 1 (should fail), Level 2+ (should succeed)",
      "Category validation: Try auto-apply injury insight (should fail), skill insight (should succeed)",
      "Confidence validation: Try low confidence (should fail), high confidence (should succeed)"
    ],
    "successCriteria": [
      "All mutations type check and pass codegen",
      "Auto-apply only works for authorized coaches (Level 2+)",
      "Undo window enforcement works correctly",
      "Audit trail captures all required fields",
      "UI displays auto-applied insights correctly",
      "Undo button enables/disables based on time",
      "Player profiles update and revert correctly",
      "No console errors in browser",
      "No Convex errors in logs"
    ]
  },
  "knownLimitations": [
    "Phase 7.2 only auto-applies skill insights (safest category)",
    "Attendance, goals, performance require Phase 7.3 (category preferences)",
    "Injury and medical insights NEVER auto-apply (always manual)",
    "1-hour undo window is not configurable (intentional constraint)",
    "Undo reason is captured but not yet used for learning (Phase 7.3 feature)"
  ],
  "nextPhase": {
    "phase": "7.3: Learning Loop",
    "stories": ["US-010", "US-011", "US-012", "US-013"],
    "description": "Add per-category preferences, adaptive confidence thresholds based on undo patterns, and UI for coach control over which categories auto-apply."
  }
}

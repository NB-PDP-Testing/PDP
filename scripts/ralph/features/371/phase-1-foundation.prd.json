{
  "project": "Onboarding Phase 1 - Foundation & Critical Bug Fixes",
  "branchName": "ralph/onboarding-phase-1",
  "description": "Fix data loss bugs (#297, #327) and establish the OnboardingOrchestrator skeleton that replaces fragmented onboarding systems. This phase creates the foundation for all subsequent onboarding improvements.",
  "relatedIssues": ["#371", "#297", "#327"],
  "contextAndDependencies": {
    "existingFiles": [
      "packages/backend/convex/models/members.ts - syncFunctionalRolesFromInvitation function",
      "apps/web/src/components/bulk-claim-provider.tsx - Current guardian claiming trigger",
      "apps/web/src/components/bulk-guardian-claim-dialog.tsx - Current guardian claim UI",
      "apps/web/src/app/orgs/accept-invitation/[invitationId]/page.tsx - Invitation acceptance"
    ],
    "problemStatement": "Platform has 4+ separate onboarding mechanisms that trigger independently, causing double dialogs (#327) and lost data (#297). Need centralized orchestrator."
  },
  "userStories": [
    {
      "id": "US-001",
      "title": "Debug and fix syncFunctionalRolesFromInvitation to persist child links",
      "description": "As a parent accepting an invitation with pre-linked children, I expect those children to be visible on my dashboard after acceptance.",
      "priority": 1,
      "passes": false,
      "acceptanceCriteria": [
        "Edit packages/backend/convex/models/members.ts",
        "Find syncFunctionalRolesFromInvitation function",
        "Add console.log to trace invitation.metadata.suggestedPlayerLinks",
        "Verify suggestedPlayerLinks array is being read from invitation metadata",
        "For each suggested link, create guardianPlayerLink with:",
        "  - guardianIdentityId: from the matched/created guardian identity",
        "  - playerIdentityId: from suggestedPlayerLinks[].playerIdentityId",
        "  - relationship: from suggestedPlayerLinks[].relationship",
        "  - acknowledgedByParentAt: undefined (pending state)",
        "  - status: 'pending'",
        "Ensure guardianIdentity is created/matched BEFORE creating links",
        "Run: npm run check-types",
        "Test: Create invitation with 2 children → Accept → Query guardianPlayerLinks → Verify 2 links exist"
      ],
      "notes": "Bug #297. The issue is likely that suggestedPlayerLinks in invitation metadata is not being processed, or guardianIdentity isn't being matched correctly before links are created."
    },
    {
      "id": "US-002",
      "title": "Create getOnboardingTasks query to evaluate pending tasks",
      "description": "As the system, I need to evaluate all pending onboarding tasks for a user and return them in priority order.",
      "priority": 2,
      "passes": false,
      "acceptanceCriteria": [
        "Create new file: packages/backend/convex/models/onboarding.ts",
        "Create query: getOnboardingTasks",
        "Args: none (uses authenticated user from ctx)",
        "Returns: v.array(v.object({ type: v.string(), priority: v.number(), data: v.any() }))",
        "",
        "Query logic - check in this order:",
        "1. Check pending invitations: query invitation table where email = user.email AND status = 'pending'",
        "2. Check pending child links: query guardianPlayerLinks where guardianIdentity.userId = user.id AND acknowledgedByParentAt = undefined",
        "3. (Future: GDPR check will be added in Phase 2)",
        "",
        "Build task array with priority:",
        "  - accept_invitation: priority 1",
        "  - child_linking: priority 2",
        "  - welcome: priority 3 (if first login to org)",
        "",
        "Return tasks sorted by priority ascending",
        "Run: npm run check-types",
        "Run: npx -w packages/backend convex codegen"
      ],
      "notes": "This query is the brain of the orchestrator. It evaluates user context and determines what steps are needed."
    },
    {
      "id": "US-003",
      "title": "Create OnboardingOrchestrator component skeleton",
      "description": "As a user, I see onboarding steps presented one at a time in a coordinated flow, not multiple overlapping dialogs.",
      "priority": 3,
      "passes": false,
      "acceptanceCriteria": [
        "Create new file: apps/web/src/components/onboarding/onboarding-orchestrator.tsx",
        "Create OnboardingOrchestrator component that:",
        "  - Uses useQuery to call getOnboardingTasks",
        "  - Maintains state for currentStepIndex (starts at 0)",
        "  - Renders children (rest of app) always",
        "  - If tasks.length > 0, renders modal for current task",
        "",
        "Component structure:",
        "export function OnboardingOrchestrator({ children }: { children: React.ReactNode }) {",
        "  const tasks = useQuery(api.models.onboarding.getOnboardingTasks);",
        "  const [currentStepIndex, setCurrentStepIndex] = useState(0);",
        "  ",
        "  const currentTask = tasks?.[currentStepIndex];",
        "  ",
        "  const handleStepComplete = () => {",
        "    setCurrentStepIndex(prev => prev + 1);",
        "  };",
        "  ",
        "  return (",
        "    <>",
        "      {children}",
        "      {currentTask && (",
        "        <OnboardingStepRenderer task={currentTask} onComplete={handleStepComplete} />",
        "      )}",
        "    </>",
        "  );",
        "}",
        "",
        "Create placeholder OnboardingStepRenderer that just shows task.type in a modal",
        "Run: npm run check-types"
      ],
      "notes": "This is the skeleton. Actual step components (GDPR, child linking, etc.) will be added in later phases."
    },
    {
      "id": "US-004",
      "title": "Integrate OnboardingOrchestrator into app layout",
      "description": "As the system, I wrap the org layout with OnboardingOrchestrator so it can intercept and present onboarding steps.",
      "priority": 4,
      "passes": false,
      "acceptanceCriteria": [
        "Edit: apps/web/src/app/orgs/[orgId]/layout.tsx",
        "Import OnboardingOrchestrator from '@/components/onboarding/onboarding-orchestrator'",
        "Wrap the layout children with OnboardingOrchestrator:",
        "",
        "return (",
        "  <OrgThemeProvider>",
        "    <OnboardingOrchestrator>",
        "      {children}",
        "    </OnboardingOrchestrator>",
        "  </OrgThemeProvider>",
        ");",
        "",
        "Ensure OnboardingOrchestrator is INSIDE any auth/theme providers",
        "Run: npm run check-types",
        "Visual test: Load any org page, verify no errors in console"
      ],
      "notes": "The orchestrator needs to be inside auth context so it can access the authenticated user."
    },
    {
      "id": "US-005",
      "title": "Migrate BulkClaimProvider logic into orchestrator",
      "description": "As a parent with pending guardian claims, I see the claim prompt through the orchestrator instead of the old BulkClaimProvider.",
      "priority": 5,
      "passes": false,
      "acceptanceCriteria": [
        "Read: apps/web/src/components/bulk-claim-provider.tsx to understand current logic",
        "The key logic to migrate:",
        "  - Query for claimable guardian identities (email match, no userId)",
        "  - Query for pending child acknowledgements",
        "  - Show BulkGuardianClaimDialog when claims exist",
        "",
        "Update getOnboardingTasks query to include guardian_claim task type:",
        "  - Check guardianIdentities where email = user.email AND userId = undefined",
        "  - If found, add task: { type: 'guardian_claim', priority: 1, data: { identities: [...] } }",
        "",
        "Update OnboardingOrchestrator to handle guardian_claim type:",
        "  - When currentTask.type === 'guardian_claim', render BulkGuardianClaimDialog",
        "  - Pass onComplete callback to dialog's onClaimComplete prop",
        "",
        "Import BulkGuardianClaimDialog in orchestrator",
        "Run: npm run check-types",
        "Test: User with pending guardian claim → Sees dialog through orchestrator"
      ],
      "notes": "We're reusing the existing BulkGuardianClaimDialog component, just changing how it's triggered."
    },
    {
      "id": "US-006",
      "title": "Remove BulkClaimProvider from codebase",
      "description": "As a developer, I no longer have the old BulkClaimProvider creating duplicate dialogs.",
      "priority": 6,
      "passes": false,
      "acceptanceCriteria": [
        "Search codebase for BulkClaimProvider usage:",
        "  grep -r 'BulkClaimProvider' apps/web/src/",
        "",
        "Remove BulkClaimProvider from wherever it's used (likely in a layout or provider)",
        "Delete file: apps/web/src/components/bulk-claim-provider.tsx",
        "Keep: apps/web/src/components/bulk-guardian-claim-dialog.tsx (still used by orchestrator)",
        "",
        "Update any imports that referenced BulkClaimProvider",
        "Run: npm run check-types",
        "Run: npm run build (ensure no broken imports)",
        "Test: Invite parent → Sign up → Accept → Verify SINGLE dialog appears (not two)"
      ],
      "notes": "This fixes bug #327 - the dual dialog issue. With BulkClaimProvider removed, only the orchestrator controls when dialogs appear."
    },
    {
      "id": "US-007",
      "title": "End-to-end testing of Phase 1 fixes",
      "description": "As QA, I verify that bugs #297 and #327 are fixed and all existing functionality works.",
      "priority": 7,
      "passes": false,
      "acceptanceCriteria": [
        "Test Bug #297 - Parent child links:",
        "  1. Admin invites parent@test.com with children John and Jane",
        "  2. Parent signs up and accepts invitation",
        "  3. Parent dashboard shows John and Jane linked",
        "  4. Query guardianPlayerLinks in Convex dashboard to verify records exist",
        "",
        "Test Bug #327 - Double dialog:",
        "  1. Admin invites new parent with children",
        "  2. Parent clicks invite link, signs up",
        "  3. Parent accepts invitation",
        "  4. Verify ONLY ONE dialog appears (not two overlapping)",
        "  5. After accepting, lands on dashboard",
        "",
        "Regression tests:",
        "  - Existing user invited to new org → Can accept",
        "  - Coach invitation → Works correctly",
        "  - Admin invitation → Works correctly",
        "  - Join request flow → Still works",
        "",
        "All tests pass",
        "Document any issues found"
      ],
      "notes": "This story is for manual testing. Consider creating automated E2E tests in Phase 6."
    }
  ],
  "verificationSteps": [
    "npm run check-types",
    "npm run build",
    "npx -w packages/backend convex codegen",
    "Manual test: Parent invitation with children flow"
  ],
  "successCriteria": [
    "Children linked during invitation persist after acceptance (Bug #297 fixed)",
    "No more dual-dialog issue (Bug #327 fixed)",
    "OnboardingOrchestrator controls all onboarding steps",
    "BulkClaimProvider removed from codebase",
    "All existing invitation flows still work"
  ]
}

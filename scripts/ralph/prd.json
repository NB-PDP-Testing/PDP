{
  "project": "Voice Gateways v2 - Phase 2: Coach Quick Review Microsite",
  "branchName": "feat/voice-gateways-v2",
  "description": "Build no-auth mobile microsite for coach voice note review. Coaches tap a WhatsApp deep link to see an aggregated priority-sorted queue of ALL pending insights across all voice notes. One rolling link per coach, 48h expiry, batch operations, WhatsApp 'OK' quick-reply. Phase 2 of 6 for the complete Voice Notes Pipeline v2.",
  "contextFiles": [
    "scripts/ralph/prds/voice-gateways-v2/context/MAIN_CONTEXT.md",
    "scripts/ralph/prds/voice-gateways-v2/context/PHASE2_MOBILE_REVIEW.md",
    "scripts/ralph/prds/voice-gateways-v2/RALPH_EXECUTION_GUIDE.md",
    "scripts/ralph/agents/output/feedback.md",
    "docs/architecture/decisions/ADR-VN2-001-capability-url-auth.md",
    "docs/architecture/decisions/ADR-VN2-002-coach-scoped-rolling-links.md",
    "docs/architecture/decisions/ADR-VN2-003-public-queries-code-validation.md",
    "docs/architecture/decisions/ADR-VN2-004-aggregated-pending-items-query.md",
    "docs/architecture/decisions/ADR-VN2-005-whatsapp-command-interceptors.md",
    "docs/architecture/decisions/ADR-VN2-006-inline-edit-and-mutation-design.md"
  ],
  "relatedIssue": "https://github.com/NB-PDP-Testing/PDP/issues/423",
  "previousPhases": [
    "Phase 1 - Quality Gates & Fuzzy Matching (COMPLETE: US-VN-001 to US-VN-006, 349 tests, integration gaps fixed)"
  ],
  "currentPhase": "Phase 2 - Coach Quick Review Microsite (6 stories, 7-9 days)",
  "completedStories": [
    "US-VN-001",
    "US-VN-002",
    "US-VN-003",
    "US-VN-004",
    "US-VN-005",
    "US-VN-006"
  ],
  "executionStrategy": {
    "parallelStreams": false,
    "sequential": {
      "name": "Coach Quick Review Microsite",
      "order": [
        "US-VN-007",
        "US-VN-008",
        "US-VN-009",
        "US-VN-010",
        "US-VN-011",
        "US-VN-012"
      ],
      "notes": "Sequential: backend links → microsite shell → queue sections → unmatched cards. US-VN-011 can parallel after 007. US-VN-012 can parallel after 008."
    }
  },
  "designPrinciples": [
    "Zero friction: no login required — 8-char code IS the authentication",
    "Aggregated queue: one rolling link per coach, ALL pending items across all voice notes",
    "Priority ordering: injuries → unmatched → pending → todos → team notes → auto-applied",
    "Batch operations: 'Apply All', 'Save All Team Notes', 'Add All to Tasks'",
    "Progressive disclosure: urgent items visible, informational items collapsed",
    "WhatsApp-native: 'OK' to apply all matched, 'R' to resend link",
    "Completion feedback: progress counter + 'All caught up' state"
  ],
  "criticalReminders": [
    "NO AUTH on /r/[code] — this is a public route, code = token",
    "NO REDIRECT — /r/[code] renders the review UI directly",
    "ONE LINK PER COACH — reuse active link, don't generate per voice note",
    "DON'T rebuild: findSimilarPlayers (Phase 1 US-VN-006) — create a PUBLIC wrapper",
    "DON'T rebuild: validateTranscriptQuality or quality gates (Phase 1)",
    "DON'T rebuild: WhatsApp Integration Foundation (actions/whatsapp.ts) — EXTEND it",
    "findSimilarPlayers is internalQuery — needs public wrapper for microsite queries",
    "All microsite queries validate code + expiry on EVERY call",
    "Link expiry: 48 hours from creation, validate on EVERY access",
    "Mobile-first: touch targets >= 44px, max-w-lg, safe area padding, min 16px font",
    "NEVER use .filter() — always use .withIndex()",
    "Better Auth IDs as v.string() not v.id()",
    "Batch fetch + Map lookup (avoid N+1 queries)",
    "WhatsApp handler order: OK → R → CONFIRM/RETRY/CANCEL → awaiting_confirmation → normal",
    "Use shadcn/ui components + Tailwind CSS + Lucide Icons",
    "SITE_URL: use process.env.SITE_URL for deep link generation — already set in Convex env, used across whatsapp.ts, auth.ts, members.ts",
    "SECURITY: Single-device binding — store deviceFingerprint cookie on first access, soft-warn on different device",
    "SECURITY: Access audit log — log IP, user-agent, timestamp on every access",
    "SECURITY: Access count monitoring — flag links with > 20 accesses for admin review",
    "Coach can EDIT insights inline (pencil icon) before applying — edit title, description, category"
  ],
  "mandatoryPatterns": [
    "Code-based auth: validate review code on every query (not session auth)",
    "Coach-scoped links: reuse active link if exists, extend voiceNoteIds array",
    "Priority ordering: injuries first, auto-applied last (collapsed)",
    "Batch fetch + Map lookup for aggregation queries (NEVER N+1)",
    "Mobile-first responsive design (test on 375px width)",
    "Touch targets >= 44px for all interactive elements",
    "Loading skeletons for all async sections",
    "Real-time updates via useQuery (Convex subscriptions)",
    "Use composite indexes (never .filter() after .withIndex())",
    "Better Auth IDs as v.string() not v.id()",
    "Use shadcn/ui components + Tailwind CSS",
    "Use Lucide Icons for iconography"
  ],
  "phase1IntegrationNotes": [
    "validateTranscriptQuality is wired into transcribeAudio — branches on reject/ask_user/process",
    "getAwaitingConfirmation internal query exists for CONFIRM/RETRY/CANCEL flow",
    "WhatsApp processMessage checks for pending confirmations before text processing",
    "findSimilarPlayers is called as fuzzy fallback in buildInsights (threshold >= 0.85)",
    "updateTranscription mutation accepts transcriptQuality and transcriptValidation fields"
  ],
  "userStories": [
    {
      "id": "US-VN-007",
      "phase": 2,
      "title": "Review Links Backend (Coach-Scoped)",
      "description": "Create backend infrastructure for coach-scoped review links. ONE active link per coach, reused across multiple voice notes. 48h expiry. Aggregated pending items query.",
      "acceptanceCriteria": [
        "Backend: Add whatsappReviewLinks table to schema.ts",
        "Schema: code, organizationId, coachUserId, createdAt, expiresAt, accessedAt, status, voiceNoteIds (array), lastNoteAddedAt, deviceFingerprint, accessLog, accessCount",
        "Indexes: by_code, by_coachUserId_and_status, by_expiresAt_and_status",
        "Function: generateReviewLink (internalMutation) — reuses active link if exists, otherwise creates new 8-char code",
        "Function: getReviewLinkByCode (PUBLIC query) — validates code, returns link data with isExpired flag",
        "Function: getCoachPendingItems (PUBLIC query) — aggregates ALL pending items across all voiceNoteIds, grouped by priority",
        "Function: markLinkAccessed (PUBLIC mutation) — sets accessedAt, increments accessCount, appends to accessLog, stores/checks deviceFingerprint",
        "Integration: call generateReviewLink in checkAndAutoApply",
        "Update formatResultsMessage to include review link URL using process.env.SITE_URL: `${siteUrl}/r/${code}`",
        "SITE_URL pattern: const siteUrl = (process.env.SITE_URL ?? 'http://localhost:3000').replace(/\\/+$/, '') — already used in whatsapp.ts line 1152, auth.ts, members.ts",
        "Unit tests with test cases for reuse, expiry, aggregation",
        "Type check passes: npm run check-types"
      ],
      "priority": 7,
      "effort": "1.5 days",
      "dependencies": ["US-VN-006"],
      "passes": true
    },
    {
      "id": "US-VN-008",
      "phase": 2,
      "title": "Quick Review Microsite",
      "description": "Create no-auth microsite at /r/[code]. Renders review UI directly — no redirect, no login. Code = token. Error states inline.",
      "acceptanceCriteria": [
        "Frontend: Create apps/web/src/app/r/[code]/page.tsx (client component)",
        "NO AUTH REQUIRED — public route",
        "NO REDIRECT — renders review UI directly",
        "Components: QuickReviewLayout, QuickReviewHeader, InvalidLinkView, ExpiredLinkView, LoadingSkeleton",
        "Mobile: max-w-lg mx-auto, p-4, touch targets >= 44px, min 16px font, safe area padding",
        "Type check passes: npm run check-types"
      ],
      "priority": 8,
      "effort": "1 day",
      "dependencies": ["US-VN-007"],
      "passes": true
    },
    {
      "id": "US-VN-009",
      "phase": 2,
      "title": "Review Queue Sections & Batch Actions",
      "description": "Priority-sorted sections with batch ops, progress counter, 'All caught up' state. Grouped by type across ALL voice notes.",
      "acceptanceCriteria": [
        "Sections in priority order: InjuryAlertSection, UnmatchedSection (placeholder), NeedsReviewSection, TodosSection, TeamNotesSection, AutoAppliedSection",
        "Batch actions: 'Apply All', 'Save All Team Notes', 'Add All to Tasks'",
        "Progress counter: '{reviewed} of {total} reviewed' with visual progress bar",
        "'All caught up' completion state with summary counts",
        "Inline edit on ALL card types: pencil icon → editable title/description, save/cancel buttons",
        "New mutations: editInsight, logInjuryFromInsight, addTodoFromInsight, saveTeamNote, batchApplyInsights",
        "Type check passes: npm run check-types"
      ],
      "priority": 9,
      "effort": "2.5 days",
      "dependencies": ["US-VN-008"],
      "passes": true
    },
    {
      "id": "US-VN-010",
      "phase": 2,
      "title": "Unmatched Player Cards + Text Reply",
      "description": "Fuzzy-matched suggestions from Phase 1 with text reply input for coach to type correct name. PUBLIC wrapper for findSimilarPlayers.",
      "acceptanceCriteria": [
        "Backend: findSimilarPlayersForReview (PUBLIC query wrapper) — validates code, delegates to findSimilarPlayers",
        "Layout: Inline Radio (mockup Option A) — amber border, suggestions with similarity %, 'Someone else...' option",
        "Text reply input when 'Someone else...' selected or no suggestions — re-searches on submit",
        "Mutation: assignPlayerFromReview (PUBLIC) — validates code, assigns player to insight",
        "Aggregation: shows unmatched from ALL voice notes in the link",
        "Type check passes: npm run check-types"
      ],
      "priority": 10,
      "effort": "1.5 days",
      "dependencies": ["US-VN-009", "US-VN-006"],
      "passes": true
    },
    {
      "id": "US-VN-011",
      "phase": 2,
      "title": "Trust-Adaptive Messages + WhatsApp Quick Actions",
      "description": "Trust-level formatting (TL0-3), running totals across notes, 'OK' quick-reply to batch-apply, 'R' to resend link.",
      "acceptanceCriteria": [
        "Update formatResultsMessage with trust-adaptive formatting",
        "Running totals: 'You now have {totalPending} pending items'",
        "WhatsApp 'OK' handler: batch-apply all matched insights, reply with count + remaining",
        "WhatsApp 'R' handler: resend current review link + pending summary",
        "Handler priority: OK → R → CONFIRM/RETRY/CANCEL → awaiting_confirmation → normal",
        "Unit tests for all trust levels + quick actions",
        "Type check passes: npm run check-types"
      ],
      "priority": 11,
      "effort": "1 day",
      "dependencies": ["US-VN-007"],
      "passes": true
    },
    {
      "id": "US-VN-012",
      "phase": 2,
      "title": "Link Expiry & Cleanup",
      "description": "Cron job for expired link cleanup, link lifecycle management, expired link UI in microsite.",
      "acceptanceCriteria": [
        "Cron: cleanupExpiredLinks daily at 3am UTC (delete links > 7 days past expiry)",
        "Cron: expireActiveLinks (update active → expired where expiresAt < now)",
        "Link lifecycle: create → reuse → expire → cleanup",
        "New note after expiry creates fresh link",
        "ExpiredLinkView with 'Open Voice Notes' + 'Back to WhatsApp' buttons",
        "Unit tests for expiry + cleanup",
        "Type check passes: npm run check-types"
      ],
      "priority": 12,
      "effort": "0.5 day",
      "dependencies": ["US-VN-008"]
    }
  ],
  "successCriteria": [
    "No-auth microsite at /r/[code] — zero login friction",
    "Coach-scoped aggregated link (one link, all pending items)",
    "Priority-sorted queue (injuries → unmatched → pending → todos → team → auto-applied)",
    "Batch operations (Apply All, Save All Team Notes, Add All to Tasks)",
    "Progress counter + 'All caught up' completion state",
    "WhatsApp running totals + 'OK' quick-reply to batch-apply",
    "Fuzzy match suggestions + text reply for unmatched players",
    "Trust-adaptive message formatting (TL0-3)",
    "48h link expiry with graceful expired state",
    "Mobile-first: touch targets >= 44px, max-w-lg, safe area",
    "All unit tests passing",
    "Type check passes (0 errors)"
  ]
}

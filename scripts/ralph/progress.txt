# Phase 5.3 (Cost Optimization) - Progress Tracker

## Phase Context

**Previous Phase:** Phase 2 (Auto-Approval System) - COMPLETE
- US-007 to US-011: Auto-approval decision logic, AutoApprovedTab, revoke summaries
- Bug fixes: Authentication pattern, slider UX, trust level downgrade
- All features working and tested

**This Phase:** Phase 3 (Cost Optimization)
- US-012: Add prompt caching to generateParentSummary
- US-013: Add aiUsageLog table to schema
- US-014: Log AI usage in generateParentSummary action
- US-015: Create AI usage analytics dashboard query

**Goal:** 90% AI cost reduction through Anthropic prompt caching + comprehensive usage tracking

---

## Critical Convex Patterns

### Authentication Pattern (FROM PHASE 2 BUG FIX)
**CRITICAL:** Better Auth userId field is optional and unset for all users!

```typescript
// ❌ WRONG - Will fail for all users
const user = await authComponent.safeGetAuthUser(ctx);
if (!user?.userId) {
  throw new Error("Not authenticated");
}
const coachId = user.userId; // userId is undefined!

// ✅ CORRECT - Use fallback pattern
const user = await authComponent.safeGetAuthUser(ctx);
if (!user) {
  throw new Error("Not authenticated");
}
const coachId = user.userId || user._id;
if (!coachId) {
  throw new Error("User ID not found");
}
```

**Why:** Better Auth user table has userId field but it's optional/unset. The _id field is the primary identifier.

**Impact:** Used in 7 functions across Phase 1-2:
- packages/backend/convex/models/coachTrustLevels.ts (6 functions)
- packages/backend/convex/models/coachParentSummaries.ts (1 function: revokeSummary)

**Action:** Always use `user.userId || user._id` pattern in any new functions that need user identification.

### Query Pattern
```typescript
export const myQuery = query({
  args: { orgId: v.id("organization") },
  returns: v.union(v.object({ /* ... */ }), v.null()),
  handler: async (ctx, args) => {
    // Always use indexes, NEVER .filter()
    const data = await ctx.db
      .query("tableName")
      .withIndex("by_orgId", q => q.eq("organizationId", args.orgId))
      .first();

    return data;
  },
});
```

### Mutation Pattern
```typescript
export const myMutation = mutation({
  args: { id: v.id("tableName"), field: v.string() },
  returns: v.object({ success: v.boolean() }),
  handler: async (ctx, args) => {
    await ctx.db.patch(args.id, { field: args.field });
    return { success: true };
  },
});
```

### Action Pattern (Important for Phase 3!)
```typescript
import { internal } from "../_generated/api";

export const myAction = action({
  args: { data: v.string() },
  returns: v.object({ result: v.string() }),
  handler: async (ctx, args) => {
    // ❌ Actions CANNOT access ctx.db
    // ✅ Use ctx.runQuery or ctx.runMutation instead

    const data = await ctx.runQuery(internal.models.myModel.getData, {});

    // External API call
    const apiResponse = await fetch("https://api.example.com", {
      method: "POST",
      body: JSON.stringify(args.data),
    });

    const result = await apiResponse.json();

    // Save via mutation
    await ctx.runMutation(internal.models.myModel.saveData, {
      result: result.value,
    });

    return { result: result.value };
  },
});
```

---

## Anthropic Prompt Caching Patterns (NEW FOR PHASE 3)

### API Configuration
```typescript
import Anthropic from "@anthropic-ai/sdk";

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

const response = await anthropic.messages.create({
  model: "claude-3-haiku-20240307",
  max_tokens: 1024,
  // REQUIRED HEADER for caching:
  headers: {
    "anthropic-beta": "prompt-caching-2024-07-31",
  },
  messages: [
    {
      role: "user",
      content: [
        {
          type: "text",
          text: "System prompt here (this will be cached)",
          cache_control: { type: "ephemeral" }, // Mark for caching
        },
        {
          type: "text",
          text: "Player context here (this will be cached)",
          cache_control: { type: "ephemeral" }, // Mark for caching
        },
        {
          type: "text",
          text: "Insight content here (NOT cached - varies per call)",
          // No cache_control = not cached
        },
      ],
    },
  ],
});
```

### Cache Strategy
**Cache (static content):**
- System prompts (parent summary generation instructions)
- Player profile data (name, age, team, sport)
- Sport context (rules, skills, terminology)

**Don't Cache (varies per call):**
- Insight content from voice notes
- Specific questions or instructions

**Cache TTL:** 5 minutes
- If same content requested within 5 min = cache hit (90% cost savings)
- After 5 min = cache miss (full cost, new cache created)

### Extracting Cache Stats from Response
```typescript
const response = await anthropic.messages.create({ /* ... */ });

// Token counts in response.usage:
const inputTokens = response.usage.input_tokens; // Total input tokens
const cachedTokens = response.usage.cache_read_input_tokens || 0; // Tokens read from cache
const cacheCreationTokens = response.usage.cache_creation_input_tokens || 0; // Tokens written to cache
const outputTokens = response.usage.output_tokens; // Output tokens generated

// Note: On first call (cache miss):
//   - cache_read_input_tokens = 0
//   - cache_creation_input_tokens = tokens cached for future use
// On cache hit:
//   - cache_read_input_tokens = tokens read from cache
//   - cache_creation_input_tokens = 0
```

### Cost Calculation (Claude Haiku)
```typescript
// Pricing (as of 2024):
const PRICE_INPUT_REGULAR = 0.000005; // $5 per 1M tokens
const PRICE_INPUT_CACHED = 0.0000005; // $0.50 per 1M tokens (90% discount)
const PRICE_OUTPUT = 0.000015; // $15 per 1M tokens

// Calculate cost:
const regularTokens = inputTokens - cachedTokens;
const cost =
  (regularTokens * PRICE_INPUT_REGULAR) +
  (cachedTokens * PRICE_INPUT_CACHED) +
  (outputTokens * PRICE_OUTPUT);

// Example:
// First call (no cache): 5000 input + 500 output
//   = (5000 * 0.000005) + (500 * 0.000015)
//   = 0.025 + 0.0075 = $0.0325

// Second call (cache hit): 5000 input (4000 cached) + 500 output
//   = (1000 * 0.000005) + (4000 * 0.0000005) + (500 * 0.000015)
//   = 0.005 + 0.002 + 0.0075 = $0.0145
//   = 55% cost reduction in this example

// Cache hit rate:
const cacheHitRate = cachedTokens / inputTokens; // 0.0 to 1.0
// Example: 4000/5000 = 0.8 = 80% cache hit rate
```

---

## Phase 2 Learnings (IMPORTANT!)

### Bug Fix 1: Authentication Pattern
**Issue:** All trust level queries failed because code used `user?.userId` which is unset
**Root Cause:** Better Auth userId field is optional, _id is the primary identifier
**Fix:** Changed to `user.userId || user._id` pattern in 7 functions
**Files:**
- packages/backend/convex/models/coachTrustLevels.ts (6 functions)
- packages/backend/convex/models/coachParentSummaries.ts (1 function)

**Lesson:** Always check schema before assuming field exists. Use fallback pattern for optional fields.

### Bug Fix 2: Slider UX Confusion
**Issue:** Slider at Level 2 showed handle at far right, looking like Level 3
**Root Cause:** Slider had `max={earnedLevel}`, so at Level 2 handle went to end of 0-2 range
**Fix:** Changed to `max={3}` with validation in onValueChange to prevent dragging above earned level
**File:** apps/web/src/components/coach/trust-level-slider.tsx

**Lesson:** Visual alignment matters. Even if logic is correct, UI should match user mental model.

### Bug Fix 3: Trust Level Permanent Downgrade
**Issue:** When user slid level down from 2 to 1, couldn't slide back up to 2
**Root Cause:** setCoachPreferredLevel mutation downgraded currentLevel when preferredLevel set lower
**Fix:** Removed downgrade logic - currentLevel = earned level only, preferredLevel = automation cap
**File:** packages/backend/convex/models/coachTrustLevels.ts (lines 280-293 removed)

**Lesson:** Distinguish between earned progress (currentLevel) and user preferences (preferredLevel). Never downgrade earned progress.

---

## Phase 3 User Stories Status

### ⏳ US-012: Add prompt caching to generateParentSummary action
**Status:** Not started
**Files to modify:**
- packages/backend/convex/actions/generateParentSummary.ts

**Key tasks:**
1. Add anthropic-beta header to API call
2. Structure messages array with cache_control markers
3. Extract cache stats from response.usage
4. Update cost calculation to account for cached tokens
5. Return cache stats for logging (US-014 depends on this)

**Testing:**
- Generate summary, verify no errors
- Check response.usage for cache stats
- Generate another summary within 5 min, verify cache hit
- Verify cost calculation is correct

---

### ⏳ US-013: Add aiUsageLog table to schema
**Status:** Not started
**Files to modify:**
- packages/backend/convex/schema.ts

**Key tasks:**
1. Add aiUsageLog table with all required fields
2. Add indexes: by_organizationId, by_coachId, by_timestamp, by_operation
3. Run codegen to verify schema
4. Verify indexes created in Convex dashboard

**Testing:**
- Run `npx -w packages/backend convex codegen`
- Check for compilation errors
- Verify table appears in Convex dashboard
- Insert test record manually to verify structure

---

### ⏳ US-014: Log AI usage in generateParentSummary action
**Status:** Not started
**Files to create:**
- packages/backend/convex/models/aiUsageLog.ts (new file)

**Files to modify:**
- packages/backend/convex/actions/generateParentSummary.ts

**Key tasks:**
1. Create aiUsageLog.ts with logUsage mutation
2. In generateParentSummary, extract token counts from API response
3. Calculate cost using formula
4. Calculate cache hit rate
5. Call logUsage mutation via ctx.runMutation
6. Add error handling (logging failure shouldn't break summary creation)

**Testing:**
- Generate summary, verify log entry created
- Check all fields populated correctly
- Verify cost matches manual calculation
- Test with cache hit and cache miss
- Test error handling (simulate logging failure)

---

### ⏳ US-015: Create AI usage analytics dashboard query
**Status:** Not started
**Files to create:**
- packages/backend/convex/models/aiUsageLog.ts (add queries to existing file from US-014)

**Key tasks:**
1. Add getOrgUsage query with date range filtering
2. Calculate aggregates (total cost, tokens, cache hit rate)
3. Group by operation type
4. Get top 5 coaches by usage
5. Get top 5 players by usage
6. Add returns validator for analytics structure

**Testing:**
- Generate test data (multiple summaries)
- Query with various date ranges
- Verify aggregates match manual calculation
- Test with empty org (no usage data)
- Check performance with 100+ log entries

---

## Known Issues & Gotchas

1. **Better Auth userId field** - Always use `user.userId || user._id`, never just `user.userId`
2. **Prompt caching TTL** - Cache expires after 5 minutes, test within that window
3. **Cost calculation precision** - Use full precision (don't round until display)
4. **Anthropic beta header** - Required: `anthropic-beta: prompt-caching-2024-07-31`
5. **Actions can't access ctx.db** - Must use ctx.runQuery or ctx.runMutation
6. **Index usage** - Always use indexes, NEVER use .filter() on queries
7. **Returns validator required** - All queries/mutations need returns validator

---

## Testing Checklist

### US-012 Testing (Prompt Caching)
- [ ] Generate parent summary without errors
- [ ] Verify response includes cache stats
- [ ] Generate same summary within 5 min
- [ ] Verify cache hit (higher cachedTokens)
- [ ] Calculate cost savings (should be ~90% on cache hit)
- [ ] Verify cost calculation formula is correct

### US-013 Testing (Schema)
- [ ] Run codegen without errors
- [ ] Verify aiUsageLog table exists in Convex dashboard
- [ ] Check all indexes present
- [ ] Insert test record manually
- [ ] Query test record to verify structure

### US-014 Testing (Logging)
- [ ] Generate summary, verify log entry created
- [ ] Check timestamp is correct
- [ ] Verify organizationId, coachId, playerId populated
- [ ] Check operation = "parent_summary"
- [ ] Check model = "claude-3-haiku-20240307"
- [ ] Verify token counts match API response
- [ ] Verify cost calculation matches expected
- [ ] Generate multiple summaries, all logged
- [ ] Test error handling (logging failure)

### US-015 Testing (Analytics)
- [ ] Generate test data (multiple summaries)
- [ ] Query getOrgUsage for test org
- [ ] Verify totalCost aggregate
- [ ] Verify totalInputTokens aggregate
- [ ] Verify totalCachedTokens aggregate
- [ ] Verify totalOutputTokens aggregate
- [ ] Verify averageCacheHitRate calculation
- [ ] Check operation type breakdown
- [ ] Check top 5 coaches list
- [ ] Check top 5 players list
- [ ] Test date range filtering
- [ ] Test with empty org (no data)
- [ ] Check performance with 100+ entries

---

## Success Criteria

Phase 3 is complete when:
- ✅ All 4 user stories implemented
- ✅ All tests passing
- ✅ Prompt caching working (90% cost reduction verified)
- ✅ All AI calls logged to aiUsageLog
- ✅ Analytics query returns accurate data
- ✅ No regressions in Phase 1 or Phase 2 features
- ✅ All passes: true in prd.json

---

## Next Steps After Phase 3

**Phase 4:** Parent experience improvements
- Parent dashboard enhancements
- WhatsApp notifications for summaries
- Parent feedback collection
- Trust level visibility for parents

**Phase 5:** Multi-sport insights
- Sport-specific analysis
- Cross-sport player comparisons
- Position-specific recommendations

---

## Notes for Ralph

- Read P5_PHASE3_HANDOFF.md for comprehensive context
- Review prd.json for user story details
- Follow Anthropic prompt caching patterns above
- Use authentication pattern from Phase 2 learnings
- Test thoroughly - cost optimization is critical
- Update this file with progress as you complete stories
- Mark stories as passing in prd.json when done

Ready for Phase 3 execution!

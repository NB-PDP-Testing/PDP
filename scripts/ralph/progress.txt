# Ralph Progress Log
Started: Sun 15 Feb 2026 23:15:16 GMT
---

## Codebase Patterns
**Last Updated**: 2026-02-15 23:30 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field
- Turborepo monorepo: `apps/web/` (Next.js 14), `packages/backend/` (Convex)

### Convex Backend Patterns
- NEVER use `.filter()` - always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names include all fields: `by_orgId_and_status`
- Actions cannot access `ctx.db` - use `ctx.runQuery`/`ctx.runMutation`
- Internal functions use `internalMutation` or `internalQuery`

### Cron Jobs (Convex)
- Use `crons.daily()`, `crons.hourly()`, `crons.interval()`, `crons.weekly()`
- Cron syntax: `{ hourUTC: 2, minuteUTC: 0 }` for daily jobs
- All cron jobs call internal functions via `internal.models.<file>.<function>`
- Existing crons run at: 12 AM (budget reset), 1 AM (usage aggregation), 2 AM (review status, trust thresholds), 3 AM (consent expiry, invitations), etc.

### Federation Connector System
- Connector credentials encrypted and stored in Convex file storage (`_storage`)
- Each connector has `connectedOrganizations[]` array with `lastSyncAt` timestamps
- Connector status: active, inactive, error (auto-disabled after 5 consecutive failures)
- Use `updateLastSyncTime` mutation to update lastSyncAt after sync
- Never return decrypted credentials in queries (only in actions)

### Quality Checks
- Run in order: `npm run check-types` → `npx ultracite fix` → `npm run check`
- Ultracite must run before linting or you'll get false failures
- Run `npx -w packages/backend convex codegen` after schema changes

### File Locations
- Cron jobs: `packages/backend/convex/crons.ts`
- Federation models: `packages/backend/convex/models/federationConnectors.ts`
- Federation actions: `packages/backend/convex/actions/gaaFoireann.ts`
- Schema: `packages/backend/convex/schema.ts`
- Import sessions: `packages/backend/convex/models/importSessions.ts`

---


## 2026-02-15 23:45 - US-P4.4-001 - Create cron scheduler for automated syncs
**Iteration**: 1
**Commit**: cb4b30f2e69d216a90edd7d3f79c5aa770fb19eb
**Session**: 28d554da-c69f-4334-9606-0515ca527995
**Status**: Complete

### What was implemented
- Created `packages/backend/convex/actions/federationScheduler.ts` with scheduledFederationSync internal action
- Added cron job to `packages/backend/convex/crons.ts` to run nightly at 2:15 AM UTC
- Implemented sync orchestration logic:
  - Queries all active connectors with `syncConfig.enabled = true`
  - For each connector, syncs all connected organizations
  - Rate limiting: 60-second delay between each organization sync to avoid overwhelming APIs
  - Tracks comprehensive stats: connectors processed, orgs synced, success/failure counts
- Integrated with existing GAA sync action (`api.actions.gaaFoireann.syncGAAMembers`)
- Updates connector health tracking (lastSyncAt timestamps, success/error recording)
- Comprehensive logging for monitoring and debugging

### Files changed
- packages/backend/convex/actions/federationScheduler.ts (+215 new file)
- packages/backend/convex/crons.ts (+8, -1)

### Quality checks
- ✅ Type check: passed (no new errors)
- ✅ Convex codegen: passed
- ✅ Linting: passed (fixed increment operators to use += instead of ++)
- ✅ Browser verification: N/A (backend-only change)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Convex cron jobs use `crons.daily()`, `crons.hourly()`, `crons.interval()`, `crons.weekly()`
- Cron syntax: `{ hourUTC: 2, minuteUTC: 15 }` for daily jobs at specific times
- All cron jobs must call internal functions via `internal.<path>.<function>`
- Existing crons run at various times: 12 AM (budget), 1 AM (usage), 2 AM (reviews), 3 AM (cleanup), etc.
- Chose 2:15 AM to spread load from other 2 AM jobs

**Gotchas encountered:**
- Biome linter rejects `++` and `--` operators - must use `+= 1` instead
- Pre-commit hook runs lint-staged which enforces this
- Import paths for internal functions: `internal.actions.federationScheduler` (note: "actions" not "models")

**Dependencies found:**
- scheduledFederationSync depends on:
  - `api.models.federationConnectors.listConnectors` (get active connectors)
  - `api.actions.gaaFoireann.syncGAAMembers` (perform sync for each org)
  - `api.models.federationConnectors.updateLastSyncTime` (update timestamps)
  - `api.models.federationConnectors.recordConnectorSuccess` (health tracking)
  - `api.models.federationConnectors.recordConnectorError` (error tracking)

**What to do next**:
- ✅ Story complete - all acceptance criteria met
- Next story: US-P4.4-002 (Implement change detection for federation data)

**Mistakes made** (learn from these!):
- Initially used `++` increment operators, caught by pre-commit hook
- Fixed by using `+= 1` syntax instead

---

## 2026-02-16 00:15 - US-P4.4-002/003 - Implement change detection and conflict resolution
**Iteration**: 1
**Commit**: 3992fae73f34b98c1872b5093f56da2a94dd6f4b
**Session**: 28d554da-c69f-4334-9606-0515ca527995
**Status**: Complete

### What was implemented
- Created `packages/backend/convex/lib/federation/changeDetector.ts` with comprehensive change detection logic
- Implemented `detectChanges()` function:
  - Compares federation data vs local data field-by-field
  - Uses lastSyncedData to differentiate changes from conflicts
  - Changed field = federation modified but local unchanged since last sync
  - Conflict = both federation AND local modified since last sync
  - Normalizes values to prevent false positives (whitespace, email case, phone formatting)
  - Compares: firstName, lastName, dateOfBirth, email, phone, address
- Implemented `resolveConflicts()` function:
  - Supports three strategies: federation_wins, local_wins, merge
  - federation_wins: always use federation value (default, safest)
  - local_wins: always keep local value (for testing/bad federation data)
  - merge: prefer local value (keeps user edits)
  - Returns ResolvedData with merged values and resolution notes
- Added TypeScript types and Convex validators for all data structures

### Files changed
- packages/backend/convex/lib/federation/changeDetector.ts (+295 new file)

### Quality checks
- ✅ Type check: passed (no new errors)
- ✅ Convex codegen: passed
- ✅ Linting: passed (biome converted interface to type)
- ✅ Browser verification: N/A (library code, no UI)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Biome prefers `type` over `interface` for TypeScript types
- Convex `v.record()` does NOT support optional values - must use `v.any()` instead
- For library code, export both types AND validators for use in mutations/actions
- Normalization is critical: emails (lowercase), phones (remove formatting), strings (trim)

**Gotchas encountered:**
- Initial error: `v.record(v.string(), v.optional(v.string()))` is invalid
- Fix: Use `v.any()` with TypeScript type hint for Records with optional values
- Biome unsafe fixes can auto-convert interface to type declarations

**Dependencies found:**
- None - this is pure library code with no external dependencies
- Will be used by sync engine orchestrator (US-P4.4-004)

**What to do next**:
- ✅ Both stories complete (US-P4.4-002 and US-P4.4-003)
- Next story: US-P4.4-004 (Create sync engine orchestrator)

**Mistakes made** (learn from these!):
- Used `interface` instead of `type` - biome prefers type declarations
- Tried to use `v.record()` with optional values - not supported by Convex

---

## 2026-02-16 00:45 - US-P4.4-004 - Create sync engine orchestrator with conflict resolution
**Iteration**: 1
**Commit**: 34649892dc8a929a625f2e44b7b1427f65979e29
**Session**: unknown
**Status**: Complete

### What was implemented
- Created `packages/backend/convex/actions/federationSyncEngine.ts` with complete sync orchestration
- Implemented `syncWithConflictResolution` action:
  - Fetches federation data using existing `fetchMembershipList` action
  - Finds local players by `externalIds.foireann` membership ID
  - Creates new players using batch import if no match found
  - Detects changes and conflicts using `changeDetector.ts` library
  - Resolves conflicts using configurable strategy (federation_wins, local_wins, merge)
  - Applies updates atomically using `updatePlayerIdentity` mutation
  - Tracks comprehensive stats: playersProcessed, playersCreated, playersUpdated, conflictsDetected, conflictsResolved
  - Records all conflict details for audit trail
  - Uses import sessions for tracking sync operations
- Extended `playerIdentities` schema with sync tracking fields:
  - `lastSyncedAt`: timestamp of last federation sync
  - `lastSyncedData`: data snapshot for conflict detection
- Updated `updatePlayerIdentity` mutation to support new sync fields
- Created helper queries: `getPlayerIdentity`, `listEnrollmentsByOrganization`

### Files changed
- packages/backend/convex/actions/federationSyncEngine.ts (+559 new file)
- packages/backend/convex/schema.ts (+3, -0) - added sync tracking fields
- packages/backend/convex/models/playerIdentities.ts (+20, -2) - added sync field support
- packages/backend/convex/models/orgPlayerEnrollments.ts (+27, -0) - added list query alias

### Quality checks
- ✅ Convex codegen: passed
- ✅ Type check: passed (no new errors)
- ✅ Linting: passed (fixed block statement and parameter count issues)
- ✅ Browser verification: N/A (backend-only change)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Schema changes: use `v.any()` for fields with complex/variable structure (lastSyncedData)
- ActionCtx type import: `import { type ActionCtx, action } from "../_generated/server"`
- Never manually type ActionCtx with object literals - always use the imported type
- Helper functions should use ActionCtx type, not `Parameters<typeof fn.handler>[0]`

**Gotchas encountered:**
- Pre-commit hook enforces Biome rules strictly:
  - `if (...) continue;` must be `if (...) { continue; }`
  - Functions with >4 parameters trigger lint error - group related params into options object
- `updatePlayerIdentity` uses individual field args, not an `updates` object
- Must assert `sessionId` is defined before using (after creation mutation)

**Dependencies found:**
- syncWithConflictResolution depends on:
  - `api.actions.gaaFoireann.fetchMembershipList` (fetch federation data)
  - `api.models.orgPlayerEnrollments.listEnrollmentsByOrganization` (find enrollments)
  - `api.models.playerIdentities.getPlayerIdentity` (get player by ID)
  - `api.models.playerIdentities.updatePlayerIdentity` (apply changes)
  - `api.models.playerImport.batchImportPlayersWithIdentity` (create new players)
  - `api.models.importSessions.createImportSession` (track sync)
  - `changeDetector.ts` library (change detection, conflict resolution)

**What to do next**:
- ✅ Story complete - all acceptance criteria met
- Next story: US-P4.4-005 (Add sync queue to prevent concurrent syncs)

**Mistakes made** (learn from these!):
- Initially used `Parameters<typeof fn.handler>[0]` for ctx type - doesn't work with registered actions
- Forgot to add block braces around single-line `continue` statement
- Had too many function parameters (6) - needed to group into options object

---
## 2026-02-16 01:15 - US-P4.4-005 - Add sync queue to prevent concurrent syncs
**Iteration**: 1
**Commit**: 60aaa579e70c17a596cc50f2cc92af2c65a663e1
**Session**: 25579882-6297-4f83-80df-f737572ac46f
**Status**: Complete

### What was implemented
- Created `packages/backend/convex/models/syncQueue.ts` with comprehensive queue management
- Added `syncQueue` table to schema with all required fields and indexes
- Implemented queue mutations:
  - `enqueueSyncJob`: Creates pending sync job, returns null if already running
  - `claimSyncJob`: Atomically marks pending job as running (prevents race conditions)
  - `completeSyncJob`: Marks job complete with stats and duration
  - `failSyncJob`: Marks job failed with exponential backoff retry (2, 4, 8 minutes)
  - `cleanupOldSyncJobs`: Removes jobs older than N days
  - `failStuckJobs`: Marks jobs running >30 minutes as failed (timeout protection)
- Implemented query:
  - `getSyncQueueStatus`: Returns queue status for organization (with optional connector filter)
- Added cron jobs:
  - `cleanup-old-sync-jobs`: Daily at 3 AM (removes jobs >30 days old)
  - `fail-stuck-sync-jobs`: Every 10 minutes (timeout protection)
- Integrated with sync engine:
  - Created `syncWithQueue` action in federationSyncEngine.ts
  - Updated federationScheduler to use queue system
  - Atomic job claiming ensures only one sync runs per org+connector
  - Automatic retry with exponential backoff for transient failures

### Files changed
- packages/backend/convex/schema.ts (+46, -1) - added syncQueue table
- packages/backend/convex/models/syncQueue.ts (+370 new file)
- packages/backend/convex/actions/federationSyncEngine.ts (+132, -1) - added syncWithQueue
- packages/backend/convex/actions/federationScheduler.ts (+56, -42) - integrated queue
- packages/backend/convex/crons.ts (+16, -1) - added cleanup crons

### Quality checks
- ✅ Convex codegen: passed
- ✅ Type check: passed (1 new TS2719 matches pre-existing pattern in gaaFoireann.ts/gaaSync.ts)
- ✅ Linting: passed (fixed variable shadowing: query → syncQueueQuery, unused param: args → _args)
- ✅ Browser verification: N/A (backend-only change)

### **Learnings for future iterations** ⚠️ CRITICAL

**Patterns discovered:**
- Sync queue prevents concurrent syncs using atomic claim operation
- Exponential backoff formula: `2^retryCount` minutes (2, 4, 8 for retries 1-3)
- Timeout protection: mark jobs running >30 minutes as failed (prevent zombie jobs)
- Cleanup strategy: remove completed/failed jobs >30 days old daily
- Queue job includes both pending creation time (queuedAt) and running start time (startedAt)

**Gotchas encountered:**
- Cannot name variable `query` when `query` is imported from _generated/server (shadow warning)
- Must prefix unused mutation args with underscore: `_args`
- TS2719 error when actions call other actions via ctx.runAction is a known Convex limitation
- This error already exists in gaaFoireann.ts and gaaSync.ts - safe to ignore

**Dependencies found:**
- syncWithQueue depends on:
  - `api.models.syncQueue.claimSyncJob` (atomic job claiming)
  - `api.actions.federationSyncEngine.syncWithConflictResolution` (run sync)
  - `api.models.syncQueue.completeSyncJob` (mark success)
  - `api.models.syncQueue.failSyncJob` (mark failure with retry)
- federationScheduler depends on:
  - `api.models.syncQueue.enqueueSyncJob` (queue job before running)
  - `api.actions.federationSyncEngine.syncWithQueue` (run with queue protection)

**What to do next**:
- ✅ Story complete - all acceptance criteria met
- Next story: US-P4.4-006 (Implement webhook receiver for federation push updates)

**Mistakes made** (learn from these!):
- Initially used `query` variable name, conflicted with imported `query` function
- Forgot to prefix unused `args` parameter with underscore

---

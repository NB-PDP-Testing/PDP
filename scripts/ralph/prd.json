{
  "project": "Coach AI Insights - Phase 7 (Auto-Apply with Trust System)",
  "branchName": "ralph/coach-insights-auto-apply-p7",
  "description": "Progressive automation for auto-applying AI insights to player profiles. Mirrors P5 parent summary trust system but for player data updates. Preview mode â†’ Supervised auto-apply â†’ Learning loop.",
  "readinessLevel": "100%",
  "prerequisitesCompleted": {
    "status": "âœ… ALL COMPLETE",
    "branch": "phase7/prerequisites-insight-auto-apply",
    "completedWork": [
      "voiceNoteInsights table created (extracted from embedded array)",
      "autoAppliedInsights audit trail table created",
      "coachTrustLevels extended with insight preview mode fields (US-001 COMPLETE)",
      "AI confidence scoring implemented in voiceNotes.ts action",
      "Migration executed: 40 insights migrated with default 0.7 confidence",
      "Knowledge graph alignment verified - targetRecordId enables [:LED_TO] relationships"
    ],
    "documentationReferences": [
      "scripts/ralph/P7_PREREQUISITES_COMPLETED.md - What's been done",
      "scripts/ralph/P7_RALPH_CONTEXT.md - Complete P5/P6 learnings for Ralph",
      "scripts/ralph/P7_KNOWLEDGE_GRAPH_ALIGNMENT.md - Future-proofing analysis",
      "scripts/ralph/P7_PHASE1_PREREQUISITES_NOTE.md - What Ralph needs to know",
      "scripts/ralph/P7_PHASE1_EXECUTION_PLAN.md - Execution guide"
    ]
  },
  "contextAndDependencies": {
    "completedPhases": [
      "P1-P4: Voice notes and parent summaries infrastructure complete",
      "P5 Phases 1-4: Trust system for parent summaries (preview mode, supervised auto-send, learning loop, override tracking)",
      "P6 Phases 1-4: Monitoring, cost controls, graceful degradation, admin dashboard",
      "P7 Prerequisites: Schema extensions, migration, AI confidence scoring (January 2026)"
    ],
    "requiredTables": [
      "âœ… voiceNoteInsights - Dedicated table with category, confidenceScore, wouldAutoApply, status",
      "âœ… autoAppliedInsights - Audit trail with targetRecordId for knowledge graph integration",
      "âœ… coachTrustLevels - Extended with insightPreviewModeStats, insightConfidenceThreshold, insightAutoApplyPreferences",
      "orgPlayerEnrollments - Player profiles that insights update (Phase 7.2)",
      "skillAssessments - Target table for skill insights (Phase 7.2)",
      "passportGoals - Target table for goal insights (Phase 7.2)"
    ],
    "existingQueries": [
      "TO CREATE: getPendingInsights - Returns insights from voiceNoteInsights table",
      "TO CREATE: applyInsight - Applies insight to player profile",
      "TO CREATE: dismissInsight - Dismisses insight",
      "REFERENCE: getCoachTrustLevel in coachTrustLevels.ts - Returns coach's trust level"
    ],
    "keyFiles": [
      "Schema: packages/backend/convex/schema.ts (lines 1439-1560 voiceNoteInsights, lines 1492-1560 autoAppliedInsights, lines 2089-2108 coachTrustLevels)",
      "Migration: packages/backend/convex/migrations/extractInsightsToTable.ts",
      "AI confidence: packages/backend/convex/actions/voiceNotes.ts (Zod schema includes confidence field)",
      "Backend insights: packages/backend/convex/models/voiceNoteInsights.ts (TO CREATE)",
      "Frontend insights tab: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx",
      "Insight cards: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/*-insight-card.tsx"
    ],
    "parallelToP5": "This phase mirrors P5's parent summary automation but for player profile updates. Same trust levels, same preview pattern, same progressive automation. Reference P5 implementations for code patterns.",
    "knowledgeGraphIntegration": {
      "critical": "autoAppliedInsights.targetRecordId enables future (:Insight)-[:LED_TO]->(:Assessment|:Goal) relationships",
      "documentation": "See scripts/ralph/P7_KNOWLEDGE_GRAPH_ALIGNMENT.md",
      "implementationNote": "When auto-applying creates a record, ALWAYS store targetRecordId for graph sync"
    }
  },
  "philosophyAndGoals": {
    "corePhilosophy": "Coaches must trust AI won't mess up player data. Show what AI would do BEFORE doing it. Progressive automation with safety nets.",
    "industryPatterns": [
      "Google Smart Reply: Preview suggestions before auto-send",
      "GitHub Copilot: Show what AI would suggest, track acceptance",
      "Stripe: Circuit breakers detect model degradation",
      "Zendesk: 60-70% confidence threshold for auto-actions"
    ],
    "successMetrics": {
      "previewMode": "40%+ agreement rate (coaches apply what AI predicted)",
      "supervised": "30%+ auto-apply rate, <5% undo rate",
      "learning": "Adaptive thresholds reduce manual review by 50%"
    },
    "safetyFirst": [
      "Never auto-apply injury or medical insights (always manual)",
      "1-hour undo window for all auto-applied insights",
      "Version control: Track previous values before auto-apply (previousValue field)",
      "Coach notification: Never silent auto-apply",
      "Kill switch: Platform staff can disable globally",
      "Auto-pause: If undo rate >15% in last 10 auto-applies, pause auto-apply for that coach"
    ],
    "confidenceThresholds": {
      "skills": "0.6 minimum (60%) - Less critical, safe to be aggressive",
      "attendance": "0.7 minimum (70%) - Factual data, medium confidence",
      "goals": "0.8 minimum (80%) - Subjective, high confidence required",
      "performance": "0.8 minimum (80%) - Coach notes, high confidence required",
      "injury": "NEVER auto-apply - Always manual review",
      "medical": "NEVER auto-apply - Always manual review"
    }
  },
  "implementationOrder": [
    "PHASE 7.1: Preview Mode for Insights (Weeks 1-2) - Stories US-001 to US-005",
    "PHASE 7.2: Supervised Auto-Apply (Weeks 3-4) - Stories US-006 to US-009",
    "PHASE 7.3: Learning Loop & Adaptive Thresholds (Weeks 5-6) - Stories US-010 to US-013"
  ],
  "userStories": [
    {
      "id": "US-001",
      "title": "âœ… PREREQUISITE COMPLETE: Insight preview mode fields in coachTrustLevels",
      "description": "As a coach, the system tracks my insight preview mode progress to measure AI agreement.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "âœ… ALREADY DONE: packages/backend/convex/schema.ts updated",
        "âœ… ALREADY DONE: Find coachTrustLevels table (lines 2089-2108)",
        "âœ… ALREADY DONE: insightPreviewModeStats field added",
        "âœ… ALREADY DONE: insightConfidenceThreshold field added (default 0.7)",
        "âœ… ALREADY DONE: insightAutoApplyPreferences field added",
        "âœ… ALREADY DONE: Codegen run successfully",
        "RALPH ACTION: Verify these fields exist in schema, mark story as complete immediately"
      ],
      "priority": 1,
      "passes": true,
      "completed": true,
      "notes": "âœ… COMPLETED IN PREREQUISITES (commit e9205f5). Ralph should verify and skip to US-002. Fields at schema.ts lines 2089-2108. Separate from parent summary stats to allow different trust levels per feature."
    },
    {
      "id": "US-002",
      "title": "Add wouldAutoApply calculation to getPendingInsights query",
      "description": "As a coach, I see which insights would auto-apply at my current trust level.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Create packages/backend/convex/models/voiceNoteInsights.ts if not exists",
        "Create getPendingInsights query:",
        "  Args: { organizationId: v.string(), coachId: v.string(), status: v.optional(v.string()) }",
        "  Returns: v.array(v.object({ ...insight fields, wouldAutoApply: v.boolean() }))",
        "Query voiceNoteInsights table (NOT embedded array - table exists!):",
        "  const insights = await ctx.db.query('voiceNoteInsights')",
        "    .withIndex('by_coach_org_status', q => q.eq('coachId', args.coachId).eq('organizationId', args.organizationId).eq('status', args.status ?? 'pending'))",
        "    .collect()",
        "Get coach trust level:",
        "  const trustLevel = await ctx.db.query('coachTrustLevels').withIndex('by_coach', q => q.eq('coachId', args.coachId)).first()",
        "Calculate wouldAutoApply for EACH insight:",
        "  const effectiveLevel = Math.min(trustLevel?.currentLevel ?? 0, trustLevel?.preferredLevel ?? trustLevel?.currentLevel ?? 0)",
        "  const threshold = trustLevel?.insightConfidenceThreshold ?? 0.7",
        "  const wouldAutoApply = insight.category !== 'injury' && insight.category !== 'medical' && effectiveLevel >= 2 && insight.confidenceScore >= threshold",
        "Return insights with wouldAutoApply field added",
        "Type check passes: npm run check-types"
      ],
      "priority": 2,
      "passes": false,
      "notes": "IMPORTANT: voiceNoteInsights is a TABLE (not embedded array). Use .withIndex('by_coach_org_status'). Confidence scores already exist (0.7 default for historical, AI-generated for new). Prediction ONLY - nothing auto-applies yet. Level 0/1 always false. Level 2 checks threshold. Level 3 always true (except injury/medical)."
    },
    {
      "id": "US-003",
      "title": "Add confidence visualization to insight cards",
      "description": "As a coach, I see AI confidence scores on insight cards.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Find insight card components in apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/",
        "PATTERN FROM P5 US-003 (parent summary cards): apps/web/src/app/orgs/[orgId]/coach/parent-summaries/components/summary-card.tsx",
        "For each insight card component, add confidence section:",
        "Import Progress from '@/components/ui/progress'",
        "Import cn from '@/lib/utils'",
        "Add after insight description, before action buttons:",
        "  <div className='mt-4 space-y-2'>",
        "    <div className='flex items-center justify-between text-sm'>",
        "      <span className={cn('font-medium',",
        "        insight.confidenceScore < 0.6 ? 'text-red-600' :",
        "        insight.confidenceScore < 0.8 ? 'text-amber-600' : 'text-green-600')",
        "      }>",
        "        AI Confidence: {Math.round(insight.confidenceScore * 100)}%",
        "      </span>",
        "    </div>",
        "    <Progress value={insight.confidenceScore * 100} className='h-2' />",
        "  </div>",
        "Type check passes",
        "Visual verification in browser: http://localhost:3000/orgs/{orgId}/coach/voice-notes"
      ],
      "priority": 3,
      "passes": false,
      "notes": "Confidence scores already exist in voiceNoteInsights.confidenceScore (migrated). Making visible = transparency. Color coding: Red <60% (risky), Amber 60-79% (moderate), Green 80%+ (safe). Matches P5 US-003 pattern exactly."
    },
    {
      "id": "US-004",
      "title": "Add preview mode prediction badge to insight cards",
      "description": "As a coach in preview mode, I see what AI would do with each insight.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "Edit insight card components",
        "Add wouldAutoApply: boolean to props interface",
        "PATTERN FROM P5 US-004 (parent summary preview badge)",
        "After confidence visualization, add prediction badge:",
        "  {insight.wouldAutoApply ? (",
        "    <Badge variant='secondary' className='bg-blue-100 text-blue-700'>",
        "      <Sparkles className='mr-1 h-3 w-3' />",
        "      AI would auto-apply this at Level 2+",
        "    </Badge>",
        "  ) : (",
        "    <p className='text-sm text-muted-foreground'>Requires manual review</p>",
        "  )}",
        "Import Badge from '@/components/ui/badge'",
        "Import Sparkles from 'lucide-react'",
        "Parent component (InsightsTab) must fetch insights using getPendingInsights query and pass wouldAutoApply prop",
        "Type check passes",
        "Visual verification: Badge appears for high-confidence skills, 'manual review' for injury/medical/low-confidence"
      ],
      "priority": 4,
      "passes": false,
      "notes": "Google Smart Reply pattern. Coaches see: 'High confidence skill insights would auto-apply. Injury insights always manual.' Builds mental model before automation. Blue badge = prediction (not action yet). Matches P5 exactly."
    },
    {
      "id": "US-005",
      "title": "Track insight preview mode statistics when coaches apply/dismiss",
      "description": "As a coach, the system learns my agreement rate with AI insight predictions.",
      "phase": "7.1: Preview Mode",
      "acceptanceCriteria": [
        "In packages/backend/convex/models/voiceNoteInsights.ts",
        "Create applyInsight mutation:",
        "  Args: { insightId: v.id('voiceNoteInsights') }",
        "  Returns: v.id('voiceNoteInsights')",
        "PATTERN FROM P5 US-005 (applyParentSummary mutation with tracking)",
        "Before applying, add preview mode tracking:",
        "  const userId = await getAuthUserId(ctx)",
        "  const insight = await ctx.db.get(args.insightId)",
        "  const trustLevel = await ctx.db.query('coachTrustLevels').withIndex('by_coach', q => q.eq('coachId', userId)).first()",
        "  if (trustLevel?.insightPreviewModeStats && !trustLevel.insightPreviewModeStats.completedAt) {",
        "    const effectiveLevel = Math.min(trustLevel.currentLevel, trustLevel.preferredLevel ?? trustLevel.currentLevel)",
        "    const threshold = trustLevel.insightConfidenceThreshold ?? 0.7",
        "    const wouldAutoApply = insight.category !== 'injury' && insight.category !== 'medical' && effectiveLevel >= 2 && insight.confidenceScore >= threshold",
        "    const stats = trustLevel.insightPreviewModeStats",
        "    const newInsights = stats.wouldAutoApplyInsights + (wouldAutoApply ? 1 : 0)",
        "    const newApplied = stats.coachAppliedThose + (wouldAutoApply ? 1 : 0)",
        "    const agreementRate = newInsights > 0 ? newApplied / newInsights : 0",
        "    await ctx.db.patch(trustLevel._id, {",
        "      insightPreviewModeStats: { ...stats, wouldAutoApplyInsights: newInsights, coachAppliedThose: newApplied, agreementRate, completedAt: newInsights >= 20 ? Date.now() : undefined }",
        "    })",
        "  }",
        "Apply insight: await ctx.db.patch(args.insightId, { status: 'applied', appliedAt: Date.now(), appliedBy: userId })",
        "Create dismissInsight mutation with similar tracking (increment wouldAutoApplyInsights and coachDismissedThose, but NOT coachAppliedThose)",
        "Type check passes"
      ],
      "priority": 5,
      "passes": false,
      "notes": "20-insight preview period. GitHub Copilot pattern. Agreement rate >70% suggests coach trusts AI (ready for Phase 7.2). Track both apply AND dismiss to get full picture. After 20 insights, completedAt set automatically."
    },
    {
      "id": "US-006",
      "title": "âœ… PREREQUISITE COMPLETE: autoAppliedInsights audit trail table",
      "description": "As the system, I track all auto-applied insights for audit trail and undo capability.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "âœ… ALREADY DONE: autoAppliedInsights table created in schema.ts (lines 1492-1560)",
        "âœ… ALREADY DONE: Table includes all required fields:",
        "  - insightId, voiceNoteId (source tracking)",
        "  - playerIdentityId, coachId, organizationId (context)",
        "  - category, confidenceScore, insightTitle, insightDescription (snapshot)",
        "  - appliedAt, autoAppliedByAI (application tracking)",
        "  - undoneAt, undoReason, undoReasonDetail (1-hour undo window)",
        "  - changeType, targetTable, targetRecordId (ðŸ”— CRITICAL for knowledge graph)",
        "  - fieldChanged, previousValue, newValue (rollback capability)",
        "âœ… ALREADY DONE: Indexes created: by_coach_org, by_insight, by_player_identity, by_applied_at, by_undo_status",
        "RALPH ACTION: Verify table exists in schema, mark story as complete immediately"
      ],
      "priority": 6,
      "passes": true,
      "completed": true,
      "notes": "âœ… COMPLETED IN PREREQUISITES (commit e9205f5). Schema at lines 1492-1560. CRITICAL: targetRecordId enables knowledge graph (:Insight)-[:LED_TO]->(:Assessment|:Goal) relationships. See P7_KNOWLEDGE_GRAPH_ALIGNMENT.md."
    },
    {
      "id": "US-007",
      "title": "Implement auto-apply logic for skill insights",
      "description": "As a coach at Level 2+, skill insights auto-apply to player profiles when confidence is high.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit packages/backend/convex/models/voiceNoteInsights.ts",
        "Create mutation: autoApplySkillInsight",
        "Args: { insightId: v.id('voiceNoteInsights') }",
        "Returns: v.object({ success: v.boolean(), auditId: v.optional(v.id('autoAppliedInsights')) })",
        "CRITICAL SAFETY CHECKS:",
        "  - Coach trust level effectiveLevel >= 2",
        "  - Confidence score >= threshold (0.6 for skills)",
        "  - insight.category === 'skill' (start with safest category)",
        "  - insight.status === 'pending' (not already applied)",
        "  - category !== 'injury' && category !== 'medical' (never auto-apply)",
        "Parse skill data from insight.recommendedUpdate or insight.description",
        "Get current player skill rating (previousValue) from skillAssessments or passport",
        "Create new skillAssessments record with assessorRole: 'system', assessmentType: 'training'",
        "Store assessmentId as targetRecordId (ðŸ”— CRITICAL for knowledge graph)",
        "Create autoAppliedInsights audit record with:",
        "  - targetRecordId: assessmentId",
        "  - targetTable: 'skillAssessments'",
        "  - changeType: 'skill_rating'",
        "  - previousValue: JSON.stringify(oldRating)",
        "  - newValue: JSON.stringify(newRating)",
        "Update insight: status = 'auto_applied', appliedAt = Date.now(), appliedBy = 'system'",
        "Type check passes"
      ],
      "priority": 7,
      "passes": false,
      "notes": "Start with skills only (safest: numeric ratings, easily reverted). KNOWLEDGE GRAPH INTEGRATION: Always store targetRecordId. Creates (:Assessment) nodes. See docs/architecture/knowledge-graph.md lines 399-400. Never auto-apply injury/medical."
    },
    {
      "id": "US-008",
      "title": "Add 1-hour undo window for auto-applied insights",
      "description": "As a coach, I can undo auto-applied insights within 1 hour if AI made a mistake.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Create mutation: undoAutoAppliedInsight",
        "Args: { auditId: v.id('autoAppliedInsights'), undoReason: v.union(v.literal('wrong_player'), v.literal('wrong_rating'), v.literal('insight_incorrect'), v.literal('changed_mind'), v.literal('duplicate'), v.literal('other')), undoReasonDetail: v.optional(v.string()) }",
        "Returns: v.object({ success: v.boolean(), message: v.string() })",
        "VALIDATION:",
        "  - const audit = await ctx.db.get(args.auditId)",
        "  - if (!audit) throw new ConvexError('Audit record not found')",
        "  - if (audit.undoneAt) throw new ConvexError('Already undone')",
        "  - const hourAgo = Date.now() - 3600000",
        "  - if (audit.appliedAt < hourAgo) throw new ConvexError('Undo window expired (1 hour limit)')",
        "  - Verify coachId matches authenticated user",
        "Revert player profile:",
        "  - Get targetRecordId from audit",
        "  - Delete or revert record based on changeType",
        "  - For skill_rating: Revert skillAssessment to previousValue or delete if new",
        "Update autoAppliedInsights: undoneAt = Date.now(), undoReason, undoReasonDetail",
        "Update original insight: status = 'pending', appliedAt = undefined, appliedBy = undefined",
        "Return: { success: true, message: 'Auto-apply undone. Skill rating reverted.' }",
        "Type check passes"
      ],
      "priority": 8,
      "passes": false,
      "notes": "Safety net. 1-hour window matches P5 parent summary revoke pattern. After 1 hour, button disabled with tooltip 'Undo window expired'. Captures WHY coach undid (feedback for Phase 7.3 learning). Undo reasons enum from schema."
    },
    {
      "id": "US-009",
      "title": "Add auto-applied insights UI to insights tab",
      "description": "As a coach, I see which insights were auto-applied and can review/undo them.",
      "phase": "7.2: Supervised Auto-Apply",
      "acceptanceCriteria": [
        "Edit apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/insights-tab.tsx",
        "PATTERN FROM P5: Auto-sent parent summaries tab",
        "Add filter tabs using Tabs component: 'Pending Review' | 'Auto-Applied'",
        "Auto-Applied tab query: getPendingInsights({ status: 'auto_applied' })",
        "Each auto-applied insight card shows:",
        "  - âœ“ Badge variant='default' className='bg-green-100 text-green-700': 'Auto-Applied'",
        "  - Time applied: 'Applied 23 minutes ago' (use formatDistanceToNow from date-fns)",
        "  - What changed: 'Passing: 3 â†’ 4' (parse from audit.previousValue and audit.newValue)",
        "  - Button: 'Undo' (enabled if appliedAt within 1 hour, disabled with tooltip 'Undo window expired' otherwise)",
        "  - Button: 'View Profile' (links to player passport)",
        "Undo button click:",
        "  - Open AlertDialog with title: 'Undo Auto-Applied Insight?'",
        "  - RadioGroup with options:",
        "    - 'Wrong player - Insight was about a different player'",
        "    - 'Wrong rating - The skill rating is incorrect'",
        "    - 'Insight incorrect - The AI misunderstood the voice note'",
        "    - 'Changed mind - I want to handle this manually'",
        "    - 'Duplicate - This insight was already applied'",
        "    - 'Other - (please explain below)'",
        "  - Textarea for undoReasonDetail (shown when 'Other' selected)",
        "  - Call undoAutoAppliedInsight mutation with reason",
        "Toast notification on undo: 'Auto-apply undone. Skill rating reverted to {previousValue}.'",
        "Type check passes",
        "Visual verification: Tab shows auto-applied insights, undo button works, time expires after 1 hour"
      ],
      "priority": 9,
      "passes": false,
      "notes": "Transparency = trust. Coach sees everything AI did. Undo is one click. Collecting WHY helps AI learn (Phase 7.3 adaptive thresholds). After 1 hour, button disabled. Matches P5 revoke pattern."
    },
    {
      "id": "US-010",
      "title": "âœ… PREREQUISITE COMPLETE: Insight category preferences in coachTrustLevels",
      "description": "As a coach, I control which insight categories auto-apply (skills yes, goals no, etc.).",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "âœ… ALREADY DONE: insightAutoApplyPreferences field in coachTrustLevels (lines 2100-2108)",
        "âœ… ALREADY DONE: Schema includes: skills, attendance, goals, performance booleans",
        "âœ… ALREADY DONE: injury and medical excluded (comment in schema)",
        "Create mutation: setInsightAutoApplyPreferences",
        "Args: { preferences: v.object({ skills: v.boolean(), attendance: v.boolean(), goals: v.boolean(), performance: v.boolean() }) }",
        "Returns: v.null()",
        "Get coach trust level, update insightAutoApplyPreferences field",
        "Type check passes"
      ],
      "priority": 10,
      "passes": false,
      "notes": "âœ… SCHEMA COMPLETE IN PREREQUISITES. Ralph needs to create the mutation only. Granular control. Coach may trust AI for skills (numeric) but not goals (subjective). Per-category trust. Injury/medical always excluded."
    },
    {
      "id": "US-011",
      "title": "Add category preference controls to settings tab",
      "description": "As a coach, I see checkboxes to enable/disable auto-apply per insight category.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Find or create: apps/web/src/app/orgs/[orgId]/coach/voice-notes/components/settings-tab.tsx",
        "PATTERN FROM P5: Trust level settings in coach settings dialog",
        "Add section after trust level slider: 'Auto-Apply Preferences'",
        "Description: 'Choose which types of insights can be automatically applied to player profiles'",
        "Checkbox group with Label components:",
        "  â˜‘ Skills - 'Auto-apply skill rating updates'",
        "  â˜ Attendance - 'Auto-apply attendance records'",
        "  â˜ Goals - 'Auto-apply development goal updates'",
        "  â˜ Performance - 'Auto-apply performance notes'",
        "Disabled text below: 'Injury and medical insights always require manual review for safety'",
        "On checkbox change:",
        "  - Call setInsightAutoApplyPreferences mutation",
        "  - toast.success('Skill auto-apply enabled') or toast.success('Goals auto-apply disabled')",
        "Type check passes",
        "Visual verification: Checkboxes toggle, changes persist on refresh"
      ],
      "priority": 11,
      "passes": false,
      "notes": "Empowers coaches. Some want full automation, others only skills. Respects different coaching styles. Injury/medical disclaimer prevents confusion. Default all to false (opt-in)."
    },
    {
      "id": "US-012",
      "title": "Implement adaptive confidence threshold based on undo patterns",
      "description": "As a coach, my confidence threshold auto-adjusts based on my undo behavior.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Create scheduled function in packages/backend/convex/crons.ts:",
        "Export const adjustInsightThresholds = internalMutation({",
        "  handler: async (ctx) => {",
        "    const coaches = await ctx.db.query('coachTrustLevels').collect()",
        "    for (const coach of coaches) {",
        "      if (!coach.insightAutoApplyPreferences) continue",
        "      const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000)",
        "      const recentAudits = await ctx.db.query('autoAppliedInsights')",
        "        .withIndex('by_coach_org_applied', q => q.eq('coachId', coach.coachId).eq('organizationId', coach.organizationId))",
        "        .filter(q => q.gte(q.field('appliedAt'), thirtyDaysAgo))",
        "        .collect()",
        "      if (recentAudits.length < 10) continue",
        "      const undoCount = recentAudits.filter(a => a.undoneAt !== undefined).length",
        "      const undoRate = undoCount / recentAudits.length",
        "      const currentThreshold = coach.insightConfidenceThreshold ?? 0.7",
        "      let newThreshold = currentThreshold",
        "      if (undoRate < 0.03) { newThreshold = Math.max(0.6, currentThreshold - 0.05) }",
        "      else if (undoRate > 0.1) { newThreshold = Math.min(0.9, currentThreshold + 0.05) }",
        "      if (newThreshold !== currentThreshold) {",
        "        await ctx.db.patch(coach._id, { insightConfidenceThreshold: newThreshold })",
        "        console.log(`Coach ${coach.coachId} threshold adjusted: ${currentThreshold} â†’ ${newThreshold} (undo rate: ${Math.round(undoRate * 100)}%)`)",
        "      }",
        "    }",
        "  }",
        "})",
        "Add to crons schedule: daily at 2am UTC",
        "Type check passes"
      ],
      "priority": 12,
      "passes": false,
      "notes": "Personalized per coach. If coach never undos (high trust), AI can be more aggressive (lower threshold = more auto-apply). If coach frequently undos (low trust), AI becomes more conservative (higher threshold = fewer auto-apply). Adaptive learning. 30-day window = recent behavior."
    },
    {
      "id": "US-013",
      "title": "Track and display undo reasons for AI improvement feedback",
      "description": "As the platform, I collect undo reasons to improve AI confidence scoring.",
      "phase": "7.3: Learning Loop",
      "acceptanceCriteria": [
        "Create query: getUndoReasonStats",
        "Args: { organizationId: v.optional(v.string()), timeframeDays: v.optional(v.number()) }",
        "Returns: v.object({ total: v.number(), byReason: v.array(v.object({ reason: v.string(), count: v.number(), percentage: v.number() })), examples: v.array(...) })",
        "Query autoAppliedInsights where undoneAt is not null",
        "Group by undoReason, count occurrences, calculate percentages",
        "Include sample insights for each reason (for context)",
        "Create admin page: apps/web/src/app/admin/ai-insights/undo-analysis/page.tsx",
        "Show Card with title: 'Undo Reason Analysis'",
        "Pie chart (use Recharts PieChart):",
        "  - Wrong player: X%",
        "  - Wrong rating: X%",
        "  - Insight incorrect: X%",
        "  - Changed mind: X%",
        "  - Duplicate: X%",
        "  - Other: X%",
        "Table showing examples:",
        "  - Columns: Reason | Insight Title | Coach | Date | Detail",
        "  - Row click opens insight details modal",
        "Button: 'Export to CSV' (for AI model training)",
        "Type check passes",
        "Visual verification: Charts render, data accurate, export works"
      ],
      "priority": 13,
      "passes": false,
      "notes": "Feedback loop to AI team. If 'wrong player' is common, improve player matching in AI prompt. If 'wrong rating' is common, improve confidence scoring. Data-driven AI improvements. PostHog integration for tracking."
    }
  ],
  "testingRequirements": {
    "previewMode": [
      "Login as coach: neil.B@blablablak.com / lien1979",
      "Navigate to Voice Notes â†’ AI Insights tab",
      "Verify confidence scores visible on insight cards (progress bar + percentage)",
      "Verify color coding: Red <60%, Amber 60-79%, Green 80%+",
      "Verify 'AI would auto-apply' badge on high-confidence skills",
      "Verify 'Requires manual review' on injury insights and low-confidence",
      "Apply 5 insights that have 'would auto-apply' badge",
      "Dismiss 2 insights that have 'would auto-apply' badge",
      "Check Convex dashboard: coachTrustLevels.insightPreviewModeStats updated (7 insights, 5 applied, 2 dismissed, ~71% agreement)",
      "Apply 13 more insights (total 20) to trigger completedAt"
    ],
    "supervisedAutoApply": [
      "Set trust level to 2 (via coach settings or DB)",
      "Enable skills auto-apply in settings tab",
      "Create voice note with skill insight (high confidence >0.7)",
      "Wait for AI processing (check voiceNoteInsights table)",
      "Verify insight auto-applied without manual action",
      "Verify autoAppliedInsights record created with targetRecordId",
      "Verify player skillAssessments updated with assessorRole: 'system'",
      "Verify 'Auto-Applied' badge on insight card (green)",
      "Verify [Undo] button enabled",
      "Click [Undo], select reason 'Wrong rating', add detail, confirm",
      "Verify skillAssessment reverted or deleted",
      "Verify insight status back to 'pending'",
      "Verify toast: 'Auto-apply undone. Skill rating reverted to X.'",
      "Wait 61 minutes, verify [Undo] button disabled with tooltip"
    ],
    "learningLoop": [
      "Enable category preferences: Skills âœ“, Attendance âœ“, Goals âœ—, Performance âœ—",
      "Create voice notes with different categories",
      "Verify skill insights auto-apply, goal insights don't",
      "Auto-apply 20 skill insights",
      "Undo 0 of 20 (0% undo rate = high trust)",
      "Trigger adjustInsightThresholds cron (or wait 24 hours)",
      "Verify insightConfidenceThreshold lowered from 0.70 to 0.65",
      "Create 10 more insights, verify more auto-apply due to lower threshold",
      "Undo 3 of 10 (30% undo rate = low trust)",
      "Trigger cron again",
      "Verify insightConfidenceThreshold raised from 0.65 to 0.75",
      "Navigate to /admin/ai-insights/undo-analysis",
      "Verify pie chart shows undo reason distribution",
      "Export CSV, verify file downloads"
    ]
  },
  "rolloutStrategy": {
    "week1": "Phase 7.1 Preview mode only - No auto-apply, collect agreement rates",
    "week2": "Monitor agreement rates - If >40%, merge to main and proceed to Phase 7.2",
    "week3": "Phase 7.2 Supervised auto-apply for skills only, Level 2+ coaches",
    "week4": "Monitor undo rates - If <5%, merge to main and proceed to Phase 7.3",
    "week5": "Phase 7.3 Enable learning loop - Adaptive thresholds based on coach behavior",
    "week6": "Expand categories - Enable goals/performance for coaches with <2% undo rate"
  },
  "successCriteria": {
    "phase7_1": {
      "agreementRate": ">40% (coaches apply what AI predicted)",
      "understanding": ">80% coaches understand confidence scores",
      "noRegressions": "No impact on existing insight workflow",
      "completionRate": ">50% coaches complete 20-insight preview period within 2 weeks"
    },
    "phase7_2": {
      "autoApplyRate": ">30% of insights auto-applied",
      "undoRate": "<5% of auto-applied insights undone",
      "timeSaved": "5-10 minutes per coach per week",
      "auditIntegrity": "100% of auto-applies have audit trail with targetRecordId"
    },
    "phase7_3": {
      "thresholdAdaptation": "Thresholds personalized for >50% of coaches with 10+ auto-applies",
      "categoryAdoption": ">60% coaches enable at least 2 categories",
      "feedbackLoop": "Undo reasons tracked and analyzed monthly",
      "knowledgeGraphReady": "All auto-applied insights have targetRecordId for graph sync"
    }
  }
}

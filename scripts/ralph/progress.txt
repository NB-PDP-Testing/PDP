# Ralph Progress Log
Started: Sun 15 Feb 2026 23:15:16 GMT
---

## Codebase Patterns
**Last Updated**: 2026-02-15 23:30 - Iteration 1

### Architecture
- All routes scoped under `/orgs/[orgId]/`
- Use Better Auth for authentication, Convex for backend
- Organization data isolated via organizationId field
- Turborepo monorepo: `apps/web/` (Next.js 14), `packages/backend/` (Convex)

### Convex Backend Patterns
- NEVER use `.filter()` - always use `.withIndex()`
- All functions need `args` and `returns` validators
- Use `Id<"tableName">` types, not `string`
- Index names include all fields: `by_orgId_and_status`
- Actions cannot access `ctx.db` - use `ctx.runQuery`/`ctx.runMutation`
- Internal functions use `internalMutation` or `internalQuery`

### Cron Jobs (Convex)
- Use `crons.daily()`, `crons.hourly()`, `crons.interval()`, `crons.weekly()`
- Cron syntax: `{ hourUTC: 2, minuteUTC: 0 }` for daily jobs
- All cron jobs call internal functions via `internal.models.<file>.<function>`
- Existing crons run at: 12 AM (budget reset), 1 AM (usage aggregation), 2 AM (review status, trust thresholds), 3 AM (consent expiry, invitations), etc.

### Federation Connector System
- Connector credentials encrypted and stored in Convex file storage (`_storage`)
- Each connector has `connectedOrganizations[]` array with `lastSyncAt` timestamps
- Connector status: active, inactive, error (auto-disabled after 5 consecutive failures)
- Use `updateLastSyncTime` mutation to update lastSyncAt after sync
- Never return decrypted credentials in queries (only in actions)

### Quality Checks
- Run in order: `npm run check-types` → `npx ultracite fix` → `npm run check`
- Ultracite must run before linting or you'll get false failures
- Run `npx -w packages/backend convex codegen` after schema changes

### File Locations
- Cron jobs: `packages/backend/convex/crons.ts`
- Federation models: `packages/backend/convex/models/federationConnectors.ts`
- Federation actions: `packages/backend/convex/actions/gaaFoireann.ts`
- Schema: `packages/backend/convex/schema.ts`
- Import sessions: `packages/backend/convex/models/importSessions.ts`

---

